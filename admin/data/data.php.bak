<?php
function notificaciones_log_email_automaticas_lista_notificaciones_data($id_empresa, $id_instancia, $tipo_instancia){
	global $c_host, $c_user, $c_pass, $c_db;
	$database = new database($c_host, $c_user, $c_pass);
	$database->setDb($c_db);
	$sql=" select h.*, (select nombre_completo from tbl_reportes_online_usuario where rut=h.rut) as nombre_completo, 
	(select nombre from tbl_lms_curso WHERE id=h.id_curso) as nombre_curso

	from tbl_log_emails_automaticos h ";
	$database->setquery($sql);
	$database->query();
	$cod = $database->listObjects();
	return $cod;		
	
	
}


function ReportesCompletos_options_years_data(){
	global $c_host, $c_user, $c_pass, $c_db;
	$database = new database($c_host, $c_user, $c_pass);
	$database->setDb($c_db);
	$sql=" select  YEAR(h.fecha_inscripcion) as dato  from tbl_lms_reportes h where h.id>0 and YEAR(h.fecha_inscripcion)>0 group by YEAR(h.fecha_inscripcion) order by YEAR(h.fecha_inscripcion) ";
	$database->setquery($sql);
	$database->query();
	$cod = $database->listObjects();
	return $cod;	
}
function ReportesCompletos_options_gerencia_data(){
	global $c_host, $c_user, $c_pass, $c_db;
	$database = new database($c_host, $c_user, $c_pass);
	$database->setDb($c_db);
	$sql="select c1 as dato from tbl_reportes_online_usuario where c1<>'' group by c1 order by c1";
	$database->setquery($sql);
	$database->query();
	$cod = $database->listObjects();
	return $cod;	
}
function ReportesCompletos_options_programa_data(){
	global $c_host, $c_user, $c_pass, $c_db;
	$database = new database($c_host, $c_user, $c_pass);
	$database->setDb($c_db);
	$sql="select h.id_programa as dato, (select nombre_programa from tbl_lms_programas_bbdd where id_programa=h.id_programa) as nombre from tbl_lms_reportes h where h.id_programa<>'0' and  h.id_programa<>'' group by h.id_programa  
	
	order by (select nombre_programa from tbl_lms_programas_bbdd where id_programa=h.id_programa)";
	$database->setquery($sql);
	$database->query();
	$cod = $database->listObjects();
	return $cod;	
}
function ReportesCompletos_options_colaboradores_data(){
	global $c_host, $c_user, $c_pass, $c_db;
	$database = new database($c_host, $c_user, $c_pass);
	$database->setDb($c_db);
	$sql="select rut as dato, nombre_completo as nombre from tbl_reportes_online_usuario where rut<>'' group by rut order by nombre_completo ";
	$database->setquery($sql);
	$database->query();
	$cod = $database->listObjects();
	return $cod;	
}
function ActualizaReportesLms_2022($id_curso,$foco,$programa_bbdd,$numero_horas){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "update tbl_lms_reportes set id_foco='$foco', id_programa='$programa_bbdd', numero_horas='$numero_horas' where id_curso='$id_curso' ";
//echo $sql;		exit();
$database->setquery($sql);
$database->query();		
}
function BorraUsuariosParaVolveraCrearlos($id_imparticion){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "delete from rel_lms_rut_id_curso_id_inscripcion where id_inscripcion='$id_imparticion'";
$database->setquery($sql);
$database->query();	

}


function CheckUsuariosInscritosQueNoEstenPreInscritos($id_imparticion, $id_curso){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);	

$sql="select h.*,(select id from rel_lms_rut_id_curso_id_inscripcion where id_inscripcion=h.id_inscripcion and rut=h.rut) as preinscritos 
from tbl_inscripcion_usuarios h where h.id_inscripcion='".$id_imparticion."' and (select id from rel_lms_rut_id_curso_id_inscripcion where id_inscripcion=h.id_inscripcion and rut=h.rut) is null";
$database->setquery($sql);
$database->query();
$cod 			= $database->listObjects();   
foreach ($cod as $unico){

$sql = "delete from tbl_inscripcion_usuarios where id_inscripcion='$id_imparticion' and rut='".$unico->rut."'";
$database->setquery($sql);
$database->query();	

$sql = "delete from tbl_lms_reportes where id_inscripcion='$id_imparticion' and rut='".$unico->rut."'";
$database->setquery($sql);
$database->query();				  	

}


}



function Update_rel_lms_id_curso_id_inscripcion_IdMalla_Programa_foco_2022($id_inscripcion, $id_curso){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);		
$sql			=	"select count(id) as cuenta from rel_lms_malla_curso where id_curso='$id_curso'";
$database->setquery($sql);
$database->query();
$cod 			= $database->listObjects();    		

if($cod[0]->cuenta=="1"){

$sql1			=	"select * from rel_lms_malla_curso where id_curso='$id_curso'";
$database->setquery($sql1);
$database->query();
$cod1 			= $database->listObjects();    		    	


$sql2 = 	"UPDATE rel_lms_id_curso_id_inscripcion 

set id_malla='".$cod1[0]->id_malla."',
id_programa='".$cod1[0]->id_programa."',
id_foco='".$cod1[0]->id_foco."'


where id_curso='$id_curso'
and id_inscripcion='$id_inscripcion'
";
$database->setquery($sql2);
$database->query();   	    	


}



}
function SumaparticipantesPotenciales_idInscripcion_2022($id_curso, $id_inscripcion){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);		


$sql2=		"select count(id) as cuenta from rel_lms_rut_id_curso_id_inscripcion where 
id_curso='".$id_curso."' and id_inscripcion='".$id_inscripcion."'";
//echo "<br>sql2 $sql2</br>";
$database->setquery($sql2);
$database->query();
$cod = $database->listObjects();    	

return 	$cod[0]->cuenta;

}
function Inserta_rel_lms_rut_id_curso_id_inscripcion_2022($rut, $id_curso, $id_inscripcion, $nombre_inscripcion,$fecha_inicio_inscripcion,$fecha_termino_inscripcion,$id_empresa,$opcional,$activa,$rut_ejecutivo) {

$nombre_inscripcion=utf8_decode($nombre_inscripcion);

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);		



$sql2=		"select id from rel_lms_rut_id_curso_id_inscripcion where 
id_curso='".$id_curso."' and id_inscripcion='".$id_inscripcion."' and rut='".$rut."'";
//echo "<br>sql2 $sql2</br>";
$database->setquery($sql2);
$database->query();
$cod = $database->listObjects();    	
//print_r($cod);exit();

if($cod[0]->id>0){
$sql3 = 	"UPDATE rel_lms_rut_id_curso_id_inscripcion 

set 

rut='$rut',
id_curso='$id_curso', 
id_inscripcion='$id_inscripcion',
nombre_inscripcion='$nombre_inscripcion',
fecha_inicio_inscripcion='$fecha_inicio_inscripcion',
fecha_termino_inscripcion='$fecha_termino_inscripcion',
id_empresa='$id_empresa',
opcional='$opcional',
activa='$activa',
rut_ejecutivo='$rut_ejecutivo'

where id='".$cod[0]->id."'

";
$database->setquery($sql3);
$database->query();    

} else {
$sql3 = 	"INSERT INTO rel_lms_rut_id_curso_id_inscripcion (rut, id_curso, id_inscripcion, nombre_inscripcion,fecha_inicio_inscripcion,fecha_termino_inscripcion,id_empresa,opcional,activa,rut_ejecutivo) " .
"VALUES ('$rut', '$id_curso', '$id_inscripcion', '$nombre_inscripcion','$fecha_inicio_inscripcion','$fecha_termino_inscripcion','$id_empresa','$opcional','$activa','$rut_ejecutivo');";
$database->setquery($sql3);
$database->query();    

}	




}
function TraigoRegistrosPorSesionDeCheckinElearning_Rel_Rut_idInscripcion_PorImparticion_2022($codigo_inscripcion, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$datos_empresa = DatosEmpresa($id_empresa);
$campo1 = $datos_empresa[0]->campo1;
$campo2 = $datos_empresa[0]->campo2;
$campo3 = $datos_empresa[0]->campo3;

if ($campo1) {
$filtro1 = " tbl_usuario." . $campo1 . " as campo1, ";
}

if ($campo2) {
$filtro2 = " tbl_usuario." . $campo2 . " as campo2, ";
}

if ($campo3) {
$filtro3 = " tbl_usuario." . $campo3 . " as campo3, ";
}

$sql = "
SELECT
h.*,
(select porcentaje_asistencia from tbl_inscripcion_cierre where id_inscripcion=h.id_inscripcion and rut=h.rut) as asistencia,
(select estado_descripcion from tbl_inscripcion_cierre where id_inscripcion=h.id_inscripcion and rut=h.rut) as estado_descripcion,
(select nota from tbl_inscripcion_cierre where id_inscripcion=h.id_inscripcion and rut=h.rut) as nota

FROM
tbl_inscripcion_usuarios h 

WHERE

h.id_inscripcion = '$codigo_inscripcion'
AND h.id_empresa = '$id_empresa'
and h.rut<>''
and h.rut<>'12121212'
and h.rut<>'12345'
and h.rut<>'13131313'
and h.rut<>'14141414'

";

//echo $sql;exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}
function TraigoRegistrosPorSesionDeCheckinElearning_Rel_Rut_idInscripcion_PreInscritos_PorImparticion_2022($codigo_inscripcion, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$datos_empresa = DatosEmpresa($id_empresa);
$campo1 = $datos_empresa[0]->campo1;
$campo2 = $datos_empresa[0]->campo2;
$campo3 = $datos_empresa[0]->campo3;

if ($campo1) {
$filtro1 = " tbl_usuario." . $campo1 . " as campo1, ";
}

if ($campo2) {
$filtro2 = " tbl_usuario." . $campo2 . " as campo2, ";
}

if ($campo3) {
$filtro3 = " tbl_usuario." . $campo3 . " as campo3, ";
}

$sql = "
SELECT
h.*,
(select porcentaje_asistencia from tbl_inscripcion_cierre where id_inscripcion=h.id_inscripcion and rut=h.rut) as asistencia,
(select estado_descripcion from tbl_inscripcion_cierre where id_inscripcion=h.id_inscripcion and rut=h.rut) as estado_descripcion,
(select nota from tbl_inscripcion_cierre where id_inscripcion=h.id_inscripcion and rut=h.rut) as nota

FROM
rel_lms_rut_id_curso_id_inscripcion h 

WHERE

h.id_inscripcion = '$codigo_inscripcion'
AND h.id_empresa = '$id_empresa'
and h.rut<>''
and h.rut<>'12121212'
and h.rut<>'12345'
and h.rut<>'13131313'
and h.rut<>'14141414'

";

//echo $sql;exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}
function InsertUpdatetbl_rel_lms_id_curso_id_inscripcion($id_curso,$id_inscripcion,$nombre_inscripcion,$fecha_inicio_inscripcion,$fecha_termino_inscripcion,$id_empresa,$opcional,$rut_ejecutivo){
//echo "<br>InsertUpdatetbl_rel_lms_id_curso_id_inscripcion $id_curso,$id_inscripcion,$nombre_inscripcion,$fecha_inicio_inscripcion,$fecha_termino_inscripcion,$id_empresa,$opcional,$rut_ejecutivo<br>";

$nombre_inscripcion=utf8_decode($nombre_inscripcion);

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);		

$sql1 = 	"INSERT INTO tbl_inscripcion_curso (codigo_inscripcion, id_curso, fecha_inicio, fecha_termino, id_empresa, nombre, ejecutivo) " .
"VALUES ('$id_inscripcion', '$id_curso', '$fecha_inicio_inscripcion', '$fecha_termino_inscripcion', '$id_empresa', '$nombre_inscripcion', '$rut_ejecutivo');";
$database->setquery($sql1);
$database->query();
//echo $sql1;

$sql2=		"select id from rel_lms_id_curso_id_inscripcion where id_curso='".$id_curso."' and id_inscripcion='".$id_inscripcion."'";
//echo "<br>sql2 $sql2</br>";
$database->setquery($sql2);
$database->query();
$cod = $database->listObjects();    	
//print_r($cod);exit();

if($cod[0]->id>0){
$sql3 = 	"UPDATE rel_lms_id_curso_id_inscripcion 

set 

fecha_inicio_inscripcion='$fecha_inicio_inscripcion',
fecha_termino_inscripcion='$fecha_termino_inscripcion',
opcional='$opcional' ,
rut_ejecutivo='$rut_ejecutivo',
nombre_inscripcion='$nombre_inscripcion'

where id_curso='$id_curso'
and id_inscripcion='$id_inscripcion'
";
$database->setquery($sql3);
$database->query();    

} else {
$sql3 = 	"INSERT INTO rel_lms_id_curso_id_inscripcion (id_curso, id_inscripcion, nombre_inscripcion, fecha_inicio_inscripcion, fecha_termino_inscripcion, id_empresa, opcional, rut_ejecutivo) " .
"VALUES ('$id_curso', '$id_inscripcion', '$nombre_inscripcion', '$fecha_inicio_inscripcion', '$fecha_termino_inscripcion', '$id_empresa', '$opcional', '$rut_ejecutivo');";
$database->setquery($sql3);
$database->query();    

}

//echo $sql3;
//exit();


//	exit();
}

function reportes_online_cron_full_2021_diagnostico_data($rut_col){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);		
$rut_col=16920173;


// DIAGNOSTICO
echo "<br><h1>CURSOS CON DIAGNOSTICO</H1></br>";
$sql="SELECT * FROM `tbl_objeto` WHERE `cm` = 'DIAGNOSTICO' ";	
//echo $sql;
$database->setquery($sql);$database->query();
$cod = $database->listObjects();
foreach ($cod as $unico){

echo "<br><h3>->IdCurso ".$unico->id_curso."</h3>";
$sql_1=" 


select h.*, (select cm from tbl_objeto where id=h.id_objeto) as diagnostico,
avg(h.nota) as promedio_nota,
(select id from tbl_lms_reportes where id_curso=h.id_curso and rut=h.rut) as idLmsReportes,

(select resultado from tbl_lms_reportes where id_curso=h.id_curso and rut=h.rut) as resultadoLmsReportes,
(select nota_aprobacion from tbl_objeto where id=h.id_objeto) as nota_aprobacion,
(select estado from tbl_lms_reportes where id_curso=h.id_curso and rut=h.rut) as estadoLmsReportes,
(select avance from tbl_lms_reportes where id_curso=h.id_curso and rut=h.rut) as avanceLmsReportes,
(select rut from tbl_usuario where rut=h.rut) as Vigente,
(select tipo_objeto from tbl_objeto where id=h.id_objeto) as tipo_objeto

from tbl_objetos_finalizados h where h.id_curso='".$unico->id_curso."'
and (select tipo_objeto from tbl_objeto where id=h.id_objeto)='5'
and 
(
(select cm from tbl_objeto where id=h.id_objeto) is null or (select cm from tbl_objeto where id=h.id_objeto)=''
)
and (select rut from tbl_usuario where rut=h.rut)>0
and h.rut<>'12345'
group by h.rut

order by avg(h.nota)  ASC ";

$database->setquery($sql_1);$database->query();
$cod_1 = $database->listObjects();

foreach ($cod_1 as $unico_1){




if($unico_1->avanceLmsReportes=="100"){
echo "<br>-> 
id ".$unico_1->id.",
rut ".$unico_1->rut.",
diagn ".$unico_1->diagnostico." ,
promedio nota ".$unico_1->promedio_nota." ,
resultado reportes ".$unico_1->resultadoLmsReportes." ,
nota aprobacion ".$unico_1->nota_aprobacion." ,
estado reportes ".$unico_1->estadoLmsReportes." ,
avance reportes".$unico_1->avanceLmsReportes."";

if(round($unico_1->promedio_nota)<>$unico_1->resultadoLmsReportes){
$sql_2="update tbl_lms_reportes set resultado='".round($unico_1->promedio_nota)."' where id='".$unico_1->idLmsReportes."'";
echo "<br>$sql_2";
$database->setquery($sql_2);$database->query();

}
if($unico_1->promedio_nota>=$unico_1->nota_aprobacion and $unico_1->estadoLmsReportes<>'APROBADO'){
$sql_3="update tbl_lms_reportes set estado='APROBADO'  where id='".$unico_1->idLmsReportes."'";
echo "<br>$sql_3";
$database->setquery($sql_3);$database->query();
}
if($unico_1->promedio_nota<$unico_1->nota_aprobacion and $unico_1->estadoLmsReportes<>'REPROBADO'){
$sql_4="update tbl_lms_reportes set estado='REPROBADO' where id='".$unico_1->idLmsReportes."'";
echo "<br>$sql_4";
$database->setquery($sql_4);$database->query();

}



}
}

}


// CURSOS SIN DIAGNOSTICO (CON O SIN EVALUACIONES
$sqlCSINDIAG="
select h.*, 
(select modalidad from tbl_lms_curso where id=h.id_curso) as modalidad,
(select count(id) from tbl_objeto where id_curso=h.id_curso and cm='DIAGNOSTICO') as cuenta_diagnostico

from tbl_reportes_online_cursos_usuarios_detalle h 

where 

(select modalidad from tbl_lms_curso where id=h.id_curso)='1'
and (select count(id) from tbl_objeto where id_curso=h.id_curso and cm='DIAGNOSTICO')='0'

group by h.id_curso

";	
echo "<br><h1>CURSOS SIN DIAGNOSTICO</H1></br>";

$database->setquery($sqlCSINDIAG);$database->query();
$codDIAG = $database->listObjects();
foreach ($codDIAG as $unico){

echo "<br><h3>->IdCurso ".$unico->id_curso."</h3>";
$sql_5=" 


select h.*, 
(select count(id) from tbl_objeto where id=h.id_objeto and tipo_objeto='5') as numEvaluaciones,
(select count(id) from tbl_objeto where id=h.id_objeto) as numObjetosTotales,
avg(h.nota) as promedio_nota,
(select id from tbl_lms_reportes where id_curso=h.id_curso and rut=h.rut) as idLmsReportes,
(select avance from tbl_inscripcion_cierre where rut=h.rut and id_curso=h.id_curso order by nota DESC, avance DESC ) as AvanceCierre,
(select resultado from tbl_lms_reportes where id_curso=h.id_curso and rut=h.rut) as resultadoLmsReportes,
(select nota_aprobacion from tbl_objeto where id=h.id_objeto) as nota_aprobacion,
(select estado from tbl_lms_reportes where id_curso=h.id_curso and rut=h.rut) as estadoLmsReportes,
(select avance from tbl_lms_reportes where id_curso=h.id_curso and rut=h.rut) as avanceLmsReportes,
(select rut from tbl_usuario where rut=h.rut) as Vigente,
(select tipo_objeto from tbl_objeto where id=h.id_objeto) as tipo_objeto

from tbl_objetos_finalizados h where h.id_curso='".$unico->id_curso."'

and (select rut from tbl_usuario where rut=h.rut)>0
and h.rut<>'12345'
group by h.rut

order by avg(h.nota)  ASC ";

$database->setquery($sql_5);$database->query();
$cod_5 = $database->listObjects();

foreach ($cod_5 as $unico_5){

if($unico_5->AvanceCierre>0){
echo "<br>-> 
id ".$unico_5->idLmsReportes.",
rut ".$unico_5->rut.",
numEvaluaciones ".$unico_5->numEvaluaciones." ,
numObjetosTotales ".$unico_5->numObjetosTotales." ,
promedio nota ".$unico_5->promedio_nota." ,
resultado reportes ".$unico_5->resultadoLmsReportes." ,
nota aprobacion ".$unico_5->nota_aprobacion." ,
estado reportes ".$unico_5->estadoLmsReportes." ,
AvanceCierre".$unico_5->AvanceCierre." ,
avance reportes".$unico_5->avanceLmsReportes."";

if($unico_5->AvanceCierre>0){
// Se analiza
if($unico_5->avanceLmsReportes>0 and $unico_5->AvanceCierre>$unico_5->avanceLmsReportes ){
echo "<h5>--> OJO AVANCE CIERRE MAYOR ".$unico_5->rut." id curso ".$unico_5->id_curso." -> Avance cierre ".$unico_5->AvanceCierre." > ".$unico_5->avanceLmsReportes."</h5>";
} 
elseif($unico_5->avanceLmsReportes>0 and $unico_5->AvanceCierre=$unico_5->avanceLmsReportes ){
//echo "<h5>--> IGUALDAD ".$unico_5->rut." id curso ".$unico_5->id_curso." -> Avance cierre ".$unico_5->AvanceCierre." > ".$unico_5->avanceLmsReportes."</h5>";
} 
else {
echo "<h4>--> OJO AVANCE REPORTES MAYOR".$unico_5->rut." id curso ".$unico_5->id_curso." -> Avance cierre ".$unico_5->AvanceCierre." > ".$unico_5->avanceLmsReportes."</h4>";
}
}
}
}

}

//exit();

}
function Dashboard_check_Lms_InscripcionCierre_data($id_imparticion, $id_curso, $rut){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);		
$sql="select h.* from tbl_inscripcion_cierre h where h.rut='$rut' and h.id_inscripcion='$id_imparticion' and h.id_curso='$id_curso'";	
//echo $sql;

$database->setquery($sql);$database->query();
$cod = $database->listObjects();
return $cod;		
}
function EncuestaSatisfaccion_BuscaPreguntas($id_encuesta){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);		
$sql="select * from tbl_enc_elearning_preg where id_encuesta='$id_encuesta'";
//echo $sql;
$database->setquery($sql);
$database->query();	
$cod = $database->listObjects();
return $cod;			
}

function EncuestaSatisfaccion_BuscaRespuestas($id_encuesta, $id_pregunta, $id_imparticion, $id_curso){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);		
if($id_imparticion<>""){
$sql="select * from tbl_enc_elearning_respuestas where id_encuesta='$id_encuesta' and id_curso='$id_curso' and id_tipo='$id_imparticion' and id_pregunta='$id_pregunta'";	
} else {
$sql="select * from tbl_enc_elearning_respuestas where id_encuesta='$id_encuesta' and id_curso='$id_curso' and id_pregunta='$id_pregunta'";	
}


if($id_curso<>""){
$DatosCurso=DatosCurso_2($id_curso);
}
if($DatosCurso[0]->modalidad=="1"){
$sql="select * from tbl_enc_elearning_respuestas where id_encuesta='$id_encuesta' and id_curso='$id_curso' and id_pregunta='$id_pregunta'";	
}		

//echo $sql;exit();
$database->setquery($sql);
$database->query();	
$cod = $database->listObjects();
return $cod;			
}

function EncuestaSatisfaccion_BuscaComentarios($id_encuesta, $id_imparticion, $id_curso){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);		
$sql="select * from tbl_enc_elearning_respuestas where id_encuesta='$id_encuesta' and id_curso='$id_curso' and id_tipo='$id_imparticion' 
and comentario<>'' group by comentario;";

if($id_curso<>""){
$DatosCurso=DatosCurso_2($id_curso);
}
if($DatosCurso[0]->modalidad=="1"){
$sql="select * from tbl_enc_elearning_respuestas where id_encuesta='$id_encuesta' and id_curso='$id_curso' 
and comentario<>'' group by comentario;";
}				

$database->setquery($sql);
$database->query();	
$cod = $database->listObjects();
return $cod;			
}

function EncuestaSatisfaccion_IdImparticionIdCurso_data($id_imparticion, $id_curso){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);	
if($id_imparticion<>""){
$sql="select  count(id) as cuenta_encuestas, id_encuesta from tbl_enc_elearning_respuestas where id_curso='$id_curso' and id_tipo='$id_imparticion' group by rut;"	;
} else {
$sql="select  count(id) as cuenta_encuestas, id_encuesta from tbl_enc_elearning_respuestas where id_curso='$id_curso' group by rut;"	;	
}

if($id_curso<>""){
$DatosCurso=DatosCurso_2($id_curso);
}
if($DatosCurso[0]->modalidad=="1"){
$sql="select  count(id) as cuenta_encuestas, id_encuesta from tbl_enc_elearning_respuestas where id_curso='$id_curso' group by rut;"	;	
}
//print_r($DatosCurso);echo $sql;exit();
$database->setquery($sql);
$database->query();	
$cod = $database->listObjects();
return $cod;			
}



function IMPARTICIONES_traeImparticionesCreadasUltima_2021($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$sql = "SELECT max(round(codigo_inscripcion)) as cuenta_max
FROM tbl_inscripcion_curso where  codigo_inscripcion REGEXP '^-?[0-9]+$';

";

//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod[0]->cuenta_max;
}

function UpdateMinimo_asistenciaMinimo_nota_aprobacion_2021($id_imparticion){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = 			"	update tbl_inscripcion_curso 
set minimo_asistencia=null where minimo_asistencia='0'
and codigo_inscripcion='$id_imparticion'";
$database->setquery($sql);
$database->query();	

$sql = 			"	update tbl_inscripcion_curso 
set minimo_nota_aprobacion=null where minimo_nota_aprobacion='0'
and codigo_inscripcion='$id_imparticion'";
$database->setquery($sql);
$database->query();	


}
function actualizaArchivoImparticionRut_Id_2021($id) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = 			"	update tbl_inscripcion_cierre 
set observaciones='' 
where id='$id'";
$database->setquery($sql);
$database->query();
}
function actualizaArchivoImparticionRut_2021($rut, $id_imparticion, $archivo) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = 			"update tbl_inscripcion_cierre 
set observaciones='$archivo' 
where rut='$rut' and id_inscripcion='$id_imparticion'";
$database->setquery($sql);
$database->query();
}
function UpdateLmsReportes_Insert_update_2021($rut, $id_foco, $id_clasificacion, $id_curso, $id_empresa, $modalidadcurso, $id_programa, $id_malla, $id_imparticion){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql="select id from tbl_lms_reportes where id_curso='$id_curso' and rut='$rut'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//print_r($cod);

if($cod[0]->id>0){

} else {
$sql1 = 	"INSERT INTO tbl_lms_reportes (rut, id_foco, id_clasificacion, id_curso, id_empresa, modalidadcurso, id_programa, id_malla, id_inscripcion) " .
"VALUES ('$rut', '$id_foco', '$id_clasificacion', '$id_curso', '$id_empresa', '$modalidadcurso', '$id_programa', '$id_malla', '$id_imparticion');";
$database->setquery($sql1);
$database->query();
}  
/*echo $sql;	echo "<br>";	echo $sql1;	echo "<br>";	exit();*/
}
function DatosCursoImparticion2021($id_curso, $id_imparticion){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

//echo "<br>-> DatosCursoImparticion2021 $id_curso, $id_imparticion";
$sql="select h.id_clasificacion, h.id_programa, h.id_foco, h.id_malla, (select modalidad from tbl_lms_curso where id=h.id_curso) as modalidadcurso  
from rel_lms_malla_curso h where h.id_curso='$id_curso' order by h.id DESC limit 1";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;			
}

function InsertaTablaCierreRutCursoImparticionAsistenciaEmpresa_2021($rut, $id_curso, $id_imparticion, $asistencia, $id_empresa, $nota, $nota_diagnostico, $estado, $estado_descripcion) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = 				"INSERT INTO tbl_inscripcion_cierre (rut, porcentaje_asistencia, avance,  estado, id_curso, id_empresa, id_inscripcion, nota, caso_especial, estado_descripcion) " .
"VALUES ('$rut', '$asistencia', '$asistencia', '$estado', '$id_curso', '$id_empresa', '$id_imparticion', '$nota', '$nota_diagnostico', '$estado_descripcion');";
//echo "<br>Insert <br>$sql";
$database->setquery($sql);
$database->query();

}

function actualizaTablaCierreRut_2021($rut, $id_curso, $id_imparticion, $asistencia, $id_empresa, $nota, $nota_diagnostico, $estado, $estado_descripcion) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = 			"update tbl_inscripcion_cierre set porcentaje_asistencia='$asistencia' , avance='$asistencia' , nota='$nota', caso_especial='$nota_diagnostico',
estado='$estado', estado_descripcion='$estado_descripcion'
where rut='$rut' and id_curso='$id_curso' and id_empresa='$id_empresa' and id_inscripcion='$id_imparticion'";
//echo "<br>Upda<br><h3>$sql</h3>";
$database->setquery($sql);
$database->query();
}
function NumSesionesDadaImparticion2021($id_imparticion){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
//echo "<br>-> DatosCursoImparticion2021 $id_curso, $id_imparticion";
$sql="select count(id) as cuenta 
from tbl_inscripcion_curso_sesiones_horarios where id_inscripcion='$id_imparticion'limit 1";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod[0]->cuenta;		
}

function ActualizaAvanceRut_2021($rut, $id_imparticion, $asistencia) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = 			"update tbl_inscripcion_cierre set porcentaje_asistencia='$asistencia' , avance='$asistencia' 
where rut='$rut' and id_inscripcion='$id_imparticion'";
//echo "<br>Upda<br><h3>$sql</h3>";
$database->setquery($sql);
$database->query();
}


function ImparticionSesionesAsistenciaPorSesion_2021($id_imparticion, $rut, $ses_1,$ses_2,$ses_3,$ses_4,$ses_5,$ses_6,$ses_7,$ses_8,$ses_9,$ses_10,$ses_11,$ses_12)
{
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$num_sesiones_total=NumSesionesDadaImparticion2021($id_imparticion);
//echo "<br>num_sesiones_total $num_sesiones_total<br>";  	//exit();
$hoy=date("Y-m-d");

$sql = "INSERT INTO tbl_inscripcion_curso_sesiones_horarios_rut (id_inscripcion, rut) " .
"VALUES ('$id_imparticion', '$rut');";
$database->setquery($sql);
$database->query();	
if($ses_1=="on"){$sesion1=1;$suma_sesiones++;}
if($ses_2=="on"){$sesion2=1;$suma_sesiones++;}
if($ses_3=="on"){$sesion3=1;$suma_sesiones++;}
if($ses_4=="on"){$sesion4=1;$suma_sesiones++;}
if($ses_5=="on"){$sesion5=1;$suma_sesiones++;}
if($ses_6=="on"){$sesion6=1;$suma_sesiones++;}

if($ses_7=="on"){$sesion7=1;$suma_sesiones++;}
if($ses_8=="on"){$sesion8=1;$suma_sesiones++;}
if($ses_9=="on"){$sesion9=1;$suma_sesiones++;}
if($ses_10=="on"){$sesion10=1;$suma_sesiones++;}
if($ses_11=="on"){$sesion11=1;$suma_sesiones++;}
if($ses_12=="on"){$sesion12=1;$suma_sesiones++;}

$sql = "update tbl_inscripcion_curso_sesiones_horarios_rut 
set sesion1='$sesion1' , sesion2='$sesion2', 
sesion3='$sesion3' , sesion4='$sesion4', 
sesion5='$sesion5' , sesion6='$sesion6', 
sesion7='$sesion7' , sesion8='$sesion8', 
sesion9='$sesion9' , sesion10='$sesion10', 
sesion11='$sesion11' , sesion12='$sesion12',
fecha='$hoy'
where rut='$rut' and id_inscripcion='$id_imparticion'";
//echo $sql;
$database->setquery($sql);
$database->query();

$porcentaje_asistencia_sesiones	= round(100*$suma_sesiones/$num_sesiones_total);	
ActualizaAvanceRut_2021($rut, $id_imparticion, $porcentaje_asistencia_sesiones);


}


function Asistencia2021_Avance_Sesiones($rut,$id_imparticion,$sesion){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);	
$sesion_check="sesion".$sesion;
$sql = "select $sesion_check as cuenta from tbl_inscripcion_curso_sesiones_horarios_rut where id_inscripcion='$id_imparticion' and rut='$rut' ";
//echo "ve sesiones <br>".$sql; 
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
if($cod[0]->cuenta>0){
$checked="checked";
} else {
$checked="";
}
//print_r($cod);    exit();
return $checked;		
}
function Fecha2021_fecha_sesion($id_imparticion,$sesion){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);	

$sql = "select * from tbl_inscripcion_curso_sesiones_horarios where id_inscripcion='$id_imparticion' and sesion='$sesion'  ";
// echo $sql; 
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;		
}
function BuscaImparticiones_AgrupadasporMes($lista_id_cursos){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$andIdCursoOr="";
$id_cursos=explode(";",$lista_id_cursos);
// print_r($id_cursos);
//echo "<br>************<br>";
foreach ($id_cursos as $UniIdCurso){
//echo "<br>a ---> ".$UniIdCurso;

if($UniIdCurso<>""){
$UniIdCursoFinal=$UniIdCurso;
$andIdCursoOr.=" h.id_curso='".$UniIdCurso."' or ";
}
//$sql1="select id from tbl_lms_curso where id='".."'";
}
$andIdCursoOr.="h.id_curso='".$UniIdCursoFinal."'";

//echo "<br>************<br>";
// echo "$andIdCursoOr";
//echo "<br>************<br>";
$sql = "select h.*, (select nombre from tbl_lms_curso where id=h.id_curso limit 1) as nombre_curso from tbl_inscripcion_curso h where h.id>0 and (".$andIdCursoOr.")";
//echo $sql; 

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

//print_r($cod);    exit();
return $cod;		


}
function TraeDirecciones2021($id_empresa){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.*
from tbl_direcciones h 
order by h.nombre ASC";
// echo $sql; 
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

//print_r($cod);    exit();
return $cod;	
}
function TraeRelatores2021($id_empresa){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.*
from tbl_relatores h 
order by h.nombre ASC";
// echo $sql; 
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

//print_r($cod);    exit();
return $cod;	
}
function TraeRelatores2021porId($rut){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.*
from tbl_relatores h 
where h.rut='$rut' order by h.nombre";
//echo $sql; 
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	
}
function TraeEjecutivos2021($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.*
from tbl_ejecutivos h where h.id_empresa='$id_empresa'
order by h.nombre ASC";
// echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}
function TraeOtec2021($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.*
from tbl_otec h where h.id_empresa='$id_empresa'
order by h.nombre ASC";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}
function lista_proveedores_ejecutivos_delete_data($id, $tipo) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if($tipo=="ejecutivos"){
$sql = "delete from tbl_ejecutivos where id='$id'";
$database->setquery($sql);
$database->query();
} elseif($tipo=="otec"){
$sql = "delete from tbl_otec where id='$id'";
$database->setquery($sql);
$database->query();			
}
elseif($tipo=="direcciones"){
$sql = "delete from tbl_direcciones where id='$id'";
$database->setquery($sql);
$database->query();			
}		
elseif($tipo=="relatores"){
$sql = "delete from tbl_relatores where id='$id'";
$database->setquery($sql);
$database->query();			
}		
elseif($tipo=="usuarios_manuales"){
$sql = "delete from tbl_usuario where id='$id'";
//echo $sql;		    exit();
$database->setquery($sql);
$database->query();			
}		
elseif($tipo=="administradores"){
$sql = "delete from tbl_admin where id='$id'";
//echo $sql;		    exit();
$database->setquery($sql);
$database->query();			
}		

}
function BuscaIdImparticionFull_2021($id_imparticion) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.*
from tbl_inscripcion_curso h
where h.codigo_inscripcion='$id_imparticion'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Lista_curso_Crea_IMPARTICION_CreaImparticion($id_empresa, $codigo_imparticion, $id_curso, $fecha_inicio, $fecha_termino, $direccion, $ciudad, $cupos, $id_malla, $tipo_audiencia, $arreglo_post, $sesiones, $ejecutivo, $comentarios, $observacion, $hora_inicio, $hora_termino, $nombre, $relator, $streaming, $minimo_asistencia, $minimo_nota_aprobacion) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql="select id from tbl_inscripcion_curso where codigo_inscripcion='$codigo_imparticion'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//echo "<h3>Lista_curso_Crea_IMPARTICION_CreaImparticion</h3>";
//print_r($cod);

if($streaming<>""){
$direccion	=	$streaming;
$comuna			=	"STREAMING";
} else {
$direccion	=	$direccion;
$comuna			=	"";

}

$id=$cod[0]->id;
if($id>0){
$sql = "
update tbl_inscripcion_curso
set 
codigo_inscripcion='".$codigo_imparticion."',
fecha_inicio='$fecha_inicio', 
fecha_termino='$fecha_termino', 
direccion='$direccion', 
comuna='$comuna', 
ciudad='$ciudad', 
id_curso='$id_curso', 
id_empresa='$id_empresa', 
cupos='$cupos', 
id_malla='$id_malla', 
tipo_audiencia='$tipo_audiencia', 
ejecutivo='$ejecutivo', 
comentarios='$comentarios',
observacion='$observacion', 
hora_inicio='$hora_inicio', 
hora_termino='$hora_termino', 
nombre='".$nombre."',
id_audiencia='$relator',
minimo_asistencia='$minimo_asistencia',
minimo_nota_aprobacion='$minimo_nota_aprobacion'

where id='".$id."'";

} else {
$sql = "
INSERT INTO tbl_inscripcion_curso
(codigo_inscripcion, fecha_inicio, fecha_termino, direccion, comuna, ciudad, id_curso, id_empresa, cupos, id_malla, tipo_audiencia, ejecutivo, comentarios,observacion, hora_inicio, hora_termino, nombre,id_audiencia,minimo_asistencia,minimo_nota_aprobacion) " .
"VALUES ('$codigo_imparticion', '$fecha_inicio', '$fecha_termino', '$direccion', '$ciudadu', '$ciudad', '$id_curso', '$id_empresa', '$cupos', '$id_malla', '$tipo_audiencia','$ejecutivo','$comentarios','$observacion', '$hora_inicio', '$hora_termino', '$nombre', '$relator', '$minimo_asistencia', '$minimo_nota_aprobacion');";
}

// echo "<br>$sql<br>";
//exit();
$database->setquery($sql);
$database->query();
}

function DeleteSesionImparticion2021($id) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "delete from tbl_inscripcion_curso_sesiones_horarios where id='$id'";
//echo $sql;
//exit();
$database->setquery($sql);
$database->query();

}

function BuscaIdCursoDadoIdImparticion_2021($id_inscripcion){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);		
$sql="select h.* from tbl_inscripcion_curso h where h.codigo_inscripcion='$id_inscripcion'";	
//echo "$sql";
$database->setquery($sql);$database->query();
$cod = $database->listObjects();
return $cod[0]->id_curso;		
}

function AgregaSesionesImparticion($sesion,$id_inscripcion,$fecha,$hora_desde,$hora_hasta,$observacion,$id_linea, $relator, $sesion_new){
//echo "<br>AgregaSesionesImparticion($sesion,$id_inscripcion,$fecha,$hora_desde,$hora_hasta,$observacion, linea $id_linea, $relator, $sesion_new)<br>";
//exit();
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);		
//print_r($_SESSION);
$rut_creador=$_SESSION["user_"];
$fecha_creacion=date("Y-m-d");

$sqlMax= "select max(sesion)  as maxsesion from tbl_inscripcion_curso_sesiones_horarios where id_inscripcion='$id_inscripcion'";
$database->setquery($sqlMax);$database->query();
$codMax = $database->listObjects();		
//print_r($codMax);
$nueva_ses=$codMax[0]->maxsesion;
if($sesion_new=="1"){
$sesion_ins=$nueva_ses+1;
} else {
$sesion_ins=$sesion;
}


$observacion=utf8_decode($observacion);
//echo "<br>fecha_creacion $fecha_creacion<br>";
//$id_linea=Decodear3($id_linea);
$sql="select h.* from tbl_inscripcion_curso_sesiones_horarios h where h.id='$id_linea'";	
//echo "$sql";
$database->setquery($sql);$database->query();
$cod = $database->listObjects();
//print_r($cod);


if($cod[0]->id>0){
if($relator<>"")
{		$updateRelator=" ,	relator='$relator' ";
} else {
$updateRelator=" ";
}
$sql = "update tbl_inscripcion_curso_sesiones_horarios 
set 
id_inscripcion='$id_inscripcion',
fecha='$fecha',
hora_desde='$hora_desde',
hora_hasta='$hora_hasta',
observaciones='$observacion',
rut_creador='$rut_creador',
fecha_creacion='$fecha_creacion',
sesion='$sesion'
".$updateRelator."
where   id='".$id_linea."'";
if($fecha<>"" and $id_inscripcion<>""){
$database->setquery($sql);
$database->query();				
}			
} else {
$sql = " INSERT INTO tbl_inscripcion_curso_sesiones_horarios (id_inscripcion,fecha,hora_desde,hora_hasta,observaciones,rut_creador,fecha_creacion,sesion, relator)
VALUES ('$id_inscripcion','$fecha','$hora_desde','$hora_hasta','$observacion','$rut_creador','$fecha_creacion','$sesion_ins', '$relator')";

if($fecha<>"" and $id_inscripcion<>""){
$database->setquery($sql);
$database->query();				
}
}


//echo "<br><h3>AgregaSesionesImparticion <br>".$sql."</h3><br>";exit();
return $cod;		


}

function DatosImparticiones_Sesiones_data_2021($id_inscripcion){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);		
$sql="select h.* from tbl_inscripcion_curso_sesiones_horarios h where h.id_inscripcion='$id_inscripcion'";	
//echo "<br>$sql<br>";
$database->setquery($sql);$database->query();
$cod = $database->listObjects();
return $cod;			
}

function Dashboard_check_Lms_Reportes_data($id_curso, $rut){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);		
$sql="select h.* from tbl_lms_reportes h where h.rut='$rut' and h.id_curso='$id_curso'";	
//echo "$sql";
$database->setquery($sql);$database->query();
$cod = $database->listObjects();
return $cod;		
}

function Dashboard_Training_IdImparticion_idCurso_MiRut_data($id_inscripcion, $id_curso, $rut){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);	

if($id_curso<>""){
$whereIdCursoIdImparticion = " and h.id_curso='$id_curso' ";
}  
if($id_inscripcion<>""){
$whereIdCursoIdImparticion = " and h.id_inscripcion='$id_inscripcion' ";
}

$sql ="	select h.*	from tbl_inscripcion_usuarios h 	where h.id>0 $whereIdCursoIdImparticion";
//echo "<br>Dashboard_Training_IdImparticion_idCurso_MiRut_data ".$sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;	
}

function AdminPerfil2021($user){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);	

$sql ="
select h.perfil
from tbl_admin h 
where h.user='$user'

"	;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod[0]->perfil;


}

function AdminPerfilVistaImparticion($user, $id_inscripcion){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);	

$sql ="
select h.id
from tbl_admin_rel_id_inscripcion h 
where h.admin='$user' and h.id_inscripcion='$id_inscripcion'

"	;
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod[0]->id;

}

// CREACION DE CURSOS PRESENCIALES
function DatosCompletosImparticion_2021($id_imparticion){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);	

$sql ="
select h.*,
(select modalidad from tbl_lms_curso where id=h.id_curso) as id_modalidad,
(SELECT id_clasificacion FROM rel_lms_malla_curso WHERE id_malla = h.id_malla AND id_curso = h.id_curso) as id_clasificacion,
(SELECT id_programa FROM rel_lms_malla_curso WHERE id_malla = h.id_malla AND id_curso = h.id_curso) as id_programa,
(SELECT id_foco FROM rel_lms_malla_curso WHERE id_malla = h.id_malla AND id_curso = h.id_curso) as id_foco
from tbl_inscripcion_curso h where h.codigo_inscripcion='$id_imparticion'

"	;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;	

}

function ListasPresenciales_CodigoIdCurso(){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select max(id_correlativo) as idMax from tbl_lms_curso";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
$idMax=$cod[0]->idMax+1;
return $idMax;		
}

function ListasPresenciales_Obtienefocos($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select 
tbl_lms_foco.* 

from tbl_lms_foco 

where id_empresa='$id_empresa' 
order by descripcion ASC 
";
//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ListaProgramasDadoFocoDeTabla($id_empresa, $foco) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_lms_programas_bbdd 
where codigo_foco='$foco' and id_empresa='$id_empresa' 
order by nombre_programa ASC";

$sql = "select * from tbl_lms_programas_bbdd 
where id_empresa='$id_empresa' 
order by nombre_programa ASC";   
//echo "<h1>".$sql."</h1>";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function ListasPresenciales_ProgramasDadoFocoDeTablaPrograma($id_empresa, $foco) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_lms_programas_bbdd where codigo_foco='$foco' and id_empresa='$id_empresa' order by nombre_programa ASC";
//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function ListaCursos_ListaModalidadCursos() {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select 
* from tbl_modalidad_curso
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function Listado_TotalCursos($id_empresa, $id_curso, $llamada) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$filtro = "";

if ($id_curso) {
$sql_id_curso = " and tbl_lms_curso.id='$id_curso'";
}

if ($llamada == "imparticion_solo_preenciales") {
$sql_presenciales = " and tbl_lms_curso.modalidad='2'";
}

$sql = "SELECT

tbl_lms_curso.*, tbl_modalidad_curso.modalidad AS nombre_modalidad,
tbl_lms_foco.descripcion AS nombre_foco,
tbl_lms_programas_bbdd.nombre_programa,
tbl_otec.nombre AS nombre_otec,


(select count(*)as total from tbl_inscripcion_curso where tbl_inscripcion_curso.id_curso=tbl_lms_curso.id ) as total_inscripciones_curso,
(SELECT COUNT(DISTINCT(rel_lms_malla_curso.id_programa))as total from rel_lms_malla_curso where rel_lms_malla_curso.id_curso=tbl_lms_curso.id and rel_lms_malla_curso.id_programa is not null) as total_programas,

(select count(DISTINCT(rut)) from tbl_inscripcion_postulantes where id_curso=tbl_lms_curso.id)  as postulantes,
(select count(DISTINCT(rut)) from tbl_inscripcion_postulantes where id_curso=tbl_lms_curso.id and preinscrito='PREINSCRITO')  as preinscritos,
(select count(DISTINCT(rut)) from tbl_inscripcion_usuarios where id_curso=tbl_lms_curso.id)  as inscritos,
(SELECT    ejecutivo    FROM    tbl_inscripcion_curso    WHERE        tbl_inscripcion_curso.id_curso = tbl_lms_curso.id limit 1) AS rut_ejecutivo,
(select nombre_completo from tbl_usuario where rut=(SELECT    ejecutivo    FROM    tbl_inscripcion_curso    WHERE        tbl_inscripcion_curso.id_curso = tbl_lms_curso.id limit 1)) as ejecutivo


FROM
tbl_lms_curso
LEFT JOIN tbl_modalidad_curso ON tbl_lms_curso.modalidad = tbl_modalidad_curso.id
LEFT JOIN tbl_otec ON tbl_otec.rut = tbl_lms_curso.rut_otec
LEFT JOIN tbl_lms_foco ON tbl_lms_foco.codigo_foco = tbl_lms_curso.id_foco
AND tbl_lms_foco.id_empresa = '$id_empresa'
LEFT JOIN tbl_lms_programas_bbdd ON tbl_lms_programas_bbdd.id_programa = tbl_lms_curso.id_empresa_programa
AND tbl_lms_programas_bbdd.id_empresa = '$id_empresa'
WHERE
tbl_lms_curso.activo = 0
and tbl_modalidad_curso.modalidad='Presencial'
AND tbl_lms_curso.id_empresa = '$id_empresa' $sql_id_curso $sql_presenciales

ORDER BY

tbl_lms_curso.id_correlativo DESC";


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function Listado_TotalCursos1($id_empresa, $id_curso, $llamada) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$filtro = "";

if ($id_curso) {
$sql_id_curso = " and tbl_lms_curso.id='$id_curso'";
}

$sql_presenciales = " and tbl_lms_curso.modalidad='2'";

$sql = "SELECT

tbl_lms_curso.*, 
tbl_lms_foco.descripcion AS nombre_foco,
tbl_lms_programas_bbdd.nombre_programa,
tbl_otec.nombre AS nombre_otec,
(select count(*)as total from tbl_inscripcion_curso where tbl_inscripcion_curso.id_curso=tbl_lms_curso.id ) as total_inscripciones_curso,
(SELECT COUNT(DISTINCT(rel_lms_malla_curso.id_programa))as total from rel_lms_malla_curso where rel_lms_malla_curso.id_curso=tbl_lms_curso.id and rel_lms_malla_curso.id_programa is not null) as total_programas,
(select count(DISTINCT(rut)) from tbl_inscripcion_usuarios where id_curso=tbl_lms_curso.id)  as inscritos,
(SELECT    ejecutivo    FROM    tbl_inscripcion_curso    WHERE        tbl_inscripcion_curso.id_curso = tbl_lms_curso.id limit 1) AS rut_ejecutivo,
(select nombre_completo from tbl_usuario where rut=(SELECT    ejecutivo    FROM    tbl_inscripcion_curso    WHERE        tbl_inscripcion_curso.id_curso = tbl_lms_curso.id limit 1)) as ejecutivo

FROM tbl_lms_curso

LEFT JOIN tbl_otec ON tbl_otec.rut = tbl_lms_curso.rut_otec
LEFT JOIN tbl_lms_foco ON tbl_lms_foco.codigo_foco = tbl_lms_curso.id_foco
AND tbl_lms_foco.id_empresa = '$id_empresa'
LEFT JOIN tbl_lms_programas_bbdd ON tbl_lms_programas_bbdd.id_programa = tbl_lms_curso.id_empresa_programa
AND tbl_lms_programas_bbdd.id_empresa = '$id_empresa'
WHERE
tbl_lms_curso.activo = 0
and tbl_lms_curso.inactivo = 0
AND tbl_lms_curso.id_empresa = '$id_empresa' $sql_id_curso 
and tbl_lms_curso.modalidad='1'

ORDER BY
tbl_lms_curso.id_correlativo DESC";

//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function Listado_TotalCursos2($id_empresa, $id_curso, $llamada) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$filtro = "";

if ($id_curso) {
$sql_id_curso = " and tbl_lms_curso.id='$id_curso'";
}

$sql_presenciales = " and tbl_lms_curso.modalidad='2'";

$sql = "SELECT

tbl_lms_curso.*, 
tbl_lms_foco.descripcion AS nombre_foco,
tbl_lms_programas_bbdd.nombre_programa,
tbl_otec.nombre AS nombre_otec,
(select count(*)as total from tbl_inscripcion_curso where tbl_inscripcion_curso.id_curso=tbl_lms_curso.id ) as total_inscripciones_curso,
(SELECT COUNT(DISTINCT(rel_lms_malla_curso.id_programa))as total from rel_lms_malla_curso where rel_lms_malla_curso.id_curso=tbl_lms_curso.id and rel_lms_malla_curso.id_programa is not null) as total_programas,
(select count(DISTINCT(rut)) from tbl_inscripcion_usuarios where id_curso=tbl_lms_curso.id)  as inscritos,
(SELECT    ejecutivo    FROM    tbl_inscripcion_curso    WHERE        tbl_inscripcion_curso.id_curso = tbl_lms_curso.id limit 1) AS rut_ejecutivo,
(select nombre_completo from tbl_usuario where rut=(SELECT    ejecutivo    FROM    tbl_inscripcion_curso    WHERE        tbl_inscripcion_curso.id_curso = tbl_lms_curso.id limit 1)) as ejecutivo

FROM tbl_lms_curso

LEFT JOIN tbl_otec ON tbl_otec.rut = tbl_lms_curso.rut_otec
LEFT JOIN tbl_lms_foco ON tbl_lms_foco.codigo_foco = tbl_lms_curso.id_foco
AND tbl_lms_foco.id_empresa = '$id_empresa'
LEFT JOIN tbl_lms_programas_bbdd ON tbl_lms_programas_bbdd.id_programa = tbl_lms_curso.id_empresa_programa
AND tbl_lms_programas_bbdd.id_empresa = '$id_empresa'
WHERE
tbl_lms_curso.activo = 0
and tbl_lms_curso.inactivo = 0
AND tbl_lms_curso.id_empresa = '$id_empresa' $sql_id_curso 
and tbl_lms_curso.modalidad='2'

ORDER BY
tbl_lms_curso.id_correlativo DESC";

//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function Listado_TotalCursos3($id_empresa, $id_curso, $llamada) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$filtro = "";

if ($id_curso) {
$sql_id_curso = " and tbl_lms_curso.id='$id_curso'";
}

$sql_presenciales = " and tbl_lms_curso.modalidad='3'";


$sql = "SELECT

tbl_lms_curso.*, 
tbl_lms_foco.descripcion AS nombre_foco,
tbl_lms_programas_bbdd.nombre_programa,
tbl_otec.nombre AS nombre_otec,
(select count(*)as total from tbl_inscripcion_curso where tbl_inscripcion_curso.id_curso=tbl_lms_curso.id ) as total_inscripciones_curso,
(SELECT COUNT(DISTINCT(rel_lms_malla_curso.id_programa))as total from rel_lms_malla_curso where rel_lms_malla_curso.id_curso=tbl_lms_curso.id and rel_lms_malla_curso.id_programa is not null) as total_programas,
(select count(DISTINCT(rut)) from tbl_inscripcion_postulantes where id_curso=tbl_lms_curso.id)  as postulantes,
(select count(DISTINCT(rut)) from tbl_inscripcion_postulantes where id_curso=tbl_lms_curso.id and preinscrito='PREINSCRITO')  as preinscritos,
(select count(DISTINCT(rut)) from tbl_inscripcion_usuarios where id_curso=tbl_lms_curso.id)  as inscritos,
(SELECT    ejecutivo    FROM    tbl_inscripcion_curso    WHERE        tbl_inscripcion_curso.id_curso = tbl_lms_curso.id limit 1) AS rut_ejecutivo,
(select nombre_completo from tbl_usuario where rut=(SELECT    ejecutivo    FROM    tbl_inscripcion_curso    WHERE        tbl_inscripcion_curso.id_curso = tbl_lms_curso.id limit 1)) as ejecutivo

FROM	tbl_lms_curso

LEFT JOIN tbl_modalidad_curso ON tbl_lms_curso.modalidad = tbl_modalidad_curso.id
LEFT JOIN tbl_otec ON tbl_otec.rut = tbl_lms_curso.rut_otec
LEFT JOIN tbl_lms_foco ON tbl_lms_foco.codigo_foco = tbl_lms_curso.id_foco
AND tbl_lms_foco.id_empresa = '$id_empresa'
LEFT JOIN tbl_lms_programas_bbdd ON tbl_lms_programas_bbdd.id_programa = tbl_lms_curso.id_empresa_programa
AND tbl_lms_programas_bbdd.id_empresa = '$id_empresa'
WHERE
tbl_lms_curso.activo = 0
and tbl_lms_curso.inactivo = 0
AND tbl_lms_curso.id_empresa = '$id_empresa' $sql_id_curso
and tbl_lms_curso.modalidad='3'

ORDER BY	tbl_lms_curso.id_correlativo DESC";

//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function Sesiones_2021_MaxMinFecha($id_imparticion){
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql1 = "select max(fecha) as MaxFecha 	from tbl_inscripcion_curso_sesiones_horarios where id_inscripcion='$id_imparticion'";
$database->setquery($sql1);
$database->query();
$cod1 = $database->listObjects();

$sql2 = "select min(fecha) as MiniFecha 	from tbl_inscripcion_curso_sesiones_horarios where id_inscripcion='$id_imparticion'";
$database->setquery($sql2);
$database->query();
$cod2 = $database->listObjects();

$arreglo[0]=$cod1[0]->MaxFecha;
$arreglo[1]=$cod2[0]->MiniFecha;


return $arreglo;	


}

function VerificoCursoPorEmpresa($id_curso, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_lms_curso where id='$id_curso' and id_empresa='$id_empresa'";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function IMPARTICIONES_traeImparticionesCreadasUltima($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select tbl_empresa.prefijo, tbl_inscripcion_curso.* from tbl_inscripcion_curso
inner join tbl_empresa
on tbl_empresa.id=tbl_inscripcion_curso.id_empresa
where tbl_inscripcion_curso.id_empresa='$id_empresa' and codigo_inscripcion like '%bci_impart_%' order by codigo_inscripcion desc limit 1
";

$sql = "select tbl_empresa.prefijo, tbl_inscripcion_curso.* from tbl_inscripcion_curso
inner join tbl_empresa
on tbl_empresa.id=tbl_inscripcion_curso.id_empresa
where tbl_inscripcion_curso.id_empresa='$id_empresa' and codigo_inscripcion not like '%bci%' and codigo_inscripcion not like '%A.H%' and codigo_inscripcion not like '%OP%' and direccion is not null and ciudad is not null order by id desc limit 1
";

$sql = "SELECT


tbl_empresa.prefijo,
max(codigo_inscripcion) as codigo_inscripcion
FROM
tbl_inscripcion_curso
INNER JOIN tbl_empresa ON tbl_empresa.id = tbl_inscripcion_curso.id_empresa
WHERE
tbl_inscripcion_curso.id_empresa = '$id_empresa'
AND codigo_inscripcion NOT LIKE '%bci%'
AND codigo_inscripcion NOT LIKE '%A.H%'
AND codigo_inscripcion NOT LIKE '%OP%'
AND codigo_inscripcion NOT LIKE '%S%'
AND codigo_inscripcion NOT LIKE '%o%'
AND direccion IS NOT NULL
AND ciudad IS NOT NULL
and LENGTH(codigo_inscripcion)=5
ORDER BY
codigo_inscripcion DESC
";

$sql = "SELECT


tbl_empresa.prefijo,
max(codigo_inscripcion) as codigo_inscripcion
FROM
tbl_inscripcion_curso
INNER JOIN tbl_empresa ON tbl_empresa.id = tbl_inscripcion_curso.id_empresa
WHERE
tbl_inscripcion_curso.id_empresa = '$id_empresa'
AND codigo_inscripcion NOT LIKE '%bci%'
AND codigo_inscripcion NOT LIKE '%A.H%'
AND codigo_inscripcion NOT LIKE '%OP%'
AND codigo_inscripcion NOT LIKE '%S%'
AND codigo_inscripcion NOT LIKE '%o%'
AND direccion IS NOT NULL
AND ciudad IS NOT NULL
and LENGTH(codigo_inscripcion)=5
ORDER BY
codigo_inscripcion DESC
";

$sql = "SELECT max(id) as cuenta_max
FROM tbl_inscripcion_curso

";

//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod[0]->cuenta_max;
}

function TraeImparticionEmpresa($id_curso, $id_empresa, $id_modalidad) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($id_curso != '') {
$sql_curso = " and tbl_inscripcion_curso.id_curso='$id_curso' ";
}
if($id_modalidad <>""){
$sql_modalidad = " and tbl_lms_curso.modalidad='$id_modalidad' ";
}

//echo "<h1>Perfil</h1>";
//print_r($_SESSION);
//echo "<br><h3>sql $sql</h3><br>";

if($_SESSION["perfil"]=="Proveedor"){
//echo "<h1>Query por Perfil </h1>";
$sql_proveedor= " and tbl_inscripcion_curso.ciudad like '".$_SESSION["user_"]."%' ";
} else {
$sql_proveedor= " ";
}


$sql =
"SELECT
tbl_inscripcion_curso.id_curso,
tbl_inscripcion_curso.codigo_inscripcion,
tbl_lms_curso.nombre,
tbl_lms_curso.modalidad,
tbl_lms_curso.numero_horas,

tbl_inscripcion_curso.fecha_inicio,
tbl_inscripcion_curso.fecha_termino,
tbl_inscripcion_curso.direccion,
tbl_inscripcion_curso.ciudad,
tbl_inscripcion_curso.comuna,
tbl_inscripcion_curso.cupos,
tbl_inscripcion_curso.sesiones,
tbl_inscripcion_curso.observacion,
tbl_inscripcion_curso.hora_inicio,
tbl_inscripcion_curso.hora_termino,
tbl_inscripcion_curso.ejecutivo as rut_ejecutivo,
tbl_inscripcion_curso.tipo_audiencia,
tbl_inscripcion_curso.id_audiencia,
(select nombre from tbl_otec where rut=tbl_inscripcion_curso.ciudad) as nombre_proveedor,
(select nombre from tbl_ejecutivos where rut=tbl_inscripcion_curso.ejecutivo) as nombre_ejecutivo,    	
(select count(DISTINCT(rut)) from tbl_inscripcion_usuarios where id_curso=tbl_lms_curso.id and id_inscripcion=tbl_inscripcion_curso.codigo_inscripcion)  as inscritos,
(select count(DISTINCT(rut)) from tbl_inscripcion_cierre where id_curso=tbl_lms_curso.id and id_inscripcion=tbl_inscripcion_curso.codigo_inscripcion and porcentaje_asistencia<>'')  as asistentes
FROM tbl_inscripcion_curso

LEFT JOIN tbl_lms_curso on tbl_lms_curso.id=tbl_inscripcion_curso.id_curso

WHERE tbl_inscripcion_curso.id_empresa='$id_empresa'
$sql_curso
$sql_modalidad
$sql_proveedor

ORDER BY tbl_inscripcion_curso.id DESC ";



//	echo "<br><h3>sql $sql</h3><br>";


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function DatosInscripcionImparticionesV2($id_inscripcion, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
SELECT
tbl_inscripcion_curso.*, tbl_lms_curso.nombre AS nombre_curso,
(select modalidad from tbl_modalidad_curso where id=tbl_lms_curso.modalidad) as modalidad,
tbl_lms_curso.modalidad as id_modalidad,
tbl_lms_curso.cantidad_maxima_participantes
FROM
tbl_inscripcion_curso
INNER JOIN tbl_lms_curso ON tbl_lms_curso.id = tbl_inscripcion_curso.id_curso
WHERE
tbl_inscripcion_curso.codigo_inscripcion = '$id_inscripcion'
AND tbl_inscripcion_curso.id_empresa = '$id_empresa'
ORDER BY
tbl_inscripcion_curso.id DESC

";
//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function Cuenta_PreInscritos_2021($id_imparticion, $id_modalidad, $id_empresa){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);	

if($id_modalidad=="1"){
$sql = "	select count(id) as cuenta from rel_lms_rut_id_curso_id_inscripcion where id_inscripcion='$id_imparticion' and id_empresa='$id_empresa'";

}

if($id_modalidad=="3"){
$sql = "	select count(id) as cuenta from tbl_inscripcion_postulantes where id_inscripcion='$id_imparticion'  and id_empresa='$id_empresa'";
}

//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod[0]->cuenta;		

}

function IMPARTICION_ActualizaImparticion($id_empresa, $codigo_imparticion, $id_curso, $fecha_inicio, $fecha_termino, $direccion, $ciudad, $cupos, $id_audiencia, $tipo_audiencia, $arreglo_post, $sesiones, $ejecutivo, $comentarios, $codigo_inscripcion, $hora_inicio, $hora_termino,$observacion) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

//echo "$id_empresa, $codigo_imparticion, $id_curso, $fecha_inicio, $fecha_termino, $direccion, $ciudad, $cupos, $id_audiencia, $tipo_audiencia, $arreglo_post, $sesiones, $ejecutivo, $comentarios, $codigo_inscripcion";
//exit();

$observacion=utf8_decode($observacion);
//$observacion=utf8_decode($observacion);
//$observacion=utf8_decode($observacion);


$sql = "UPDATE tbl_inscripcion_curso

set
fecha_inicio='$fecha_inicio',
fecha_termino='$fecha_termino',
direccion='$direccion',
comuna='$ciudadu',
ciudad='$ciudad',
comentarios='$comentarios',
id_curso='$id_curso',
cupos='$cupos',
id_audiencia='$id_audiencia',
tipo_audiencia='$tipo_audiencia',
lunes_d_am='" . $arreglo_post["lunes_d_am"] . "',
lunes_h_am='" . $arreglo_post["lunes_h_am"] . "',
lunes_d_pm='" . $arreglo_post["lunes_d_pm"] . "',
lunes_h_pm='" . $arreglo_post["lunes_h_pm"] . "',
martes_d_am='" . $arreglo_post["martes_d_am"] . "',
martes_h_am='" . $arreglo_post["martes_h_am"] . "',
martes_d_pm='" . $arreglo_post["martes_d_pm"] . "',
martes_h_pm='" . $arreglo_post["martes_h_pm"] . "',
miercoles_d_am='" . $arreglo_post["miercoles_d_am"] . "',
miercoles_h_am='" . $arreglo_post["miercoles_h_am"] . "',
miercoles_d_pm='" . $arreglo_post["miercoles_d_pm"] . "',
miercoles_h_pm='" . $arreglo_post["miercoles_h_pm"] . "',
jueves_d_am='" . $arreglo_post["jueves_d_am"] . "',
jueves_h_am='" . $arreglo_post["jueves_h_am"] . "',
jueves_d_pm='" . $arreglo_post["jueves_d_pm"] . "',
jueves_h_pm='" . $arreglo_post["jueves_h_pm"] . "',
viernes_d_am='" . $arreglo_post["viernes_d_am"] . "',
viernes_h_am='" . $arreglo_post["viernes_h_am"] . "',
viernes_d_pm='" . $arreglo_post["viernes_d_pm"] . "',
viernes_h_pm='" . $arreglo_post["viernes_h_pm"] . "',
sesiones='$sesiones',
ejecutivo='$ejecutivo',
observacion='".$observacion."',
hora_inicio='".$hora_inicio."', 
hora_termino='".$hora_termino."'

where 

codigo_inscripcion='$codigo_imparticion' and id_empresa='$id_empresa'";
//echo $sql;exit();
$database->setquery($sql);
$database->query();

if ($codigo_imparticion != $codigo_inscripcion) {
$sql = "UPDATE tbl_inscripcion_curso
set codigo_inscripcion='$codigo_imparticion' where codigo_inscripcion='$codigo_inscripcion'";

$database->setquery($sql);
$database->query();

$sql = "UPDATE tbl_inscripcion_usuarios
set id_inscripcion='$codigo_imparticion' where id_inscripcion='$codigo_inscripcion'";

$database->setquery($sql);
$database->query();

$sql = "UPDATE tbl_inscripcion_postulantes
set id_inscripcion='$codigo_imparticion' where id_inscripcion='$codigo_inscripcion'";

$database->setquery($sql);
$database->query();

$sql = "UPDATE tbl_objeto
set id_curso='$codigo_imparticion' where id_curso='$codigo_inscripcion'";

$database->setquery($sql);
$database->query();
}
}

function lista_proveedores_ejecutivos_data($id_empresa, $tipo) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if($tipo=="ejecutivos")								{ $tabla="tbl_ejecutivos"; }
elseif($tipo=="otec")									{ $tabla="tbl_otec"; }
elseif($tipo=="relatores")						{ $tabla="tbl_relatores"; }
elseif($tipo=="usuarios_manuales")		{ $tabla="tbl_usuario"; }
elseif($tipo=="direcciones")					{ $tabla="tbl_direcciones"; }
elseif($tipo=="administradores")			{ $tabla="tbl_admin"; }
//echo "<br>------------------------------->tipo $tipo<br>";
if($tipo=="usuarios_manuales"){
$sql = "select h.*
from $tabla h
where id_empresa='$id_empresa' and empresa_holding='USUARIO_MANUAL'
order by h.nombre ASC";			
} else {
$sql = "select h.*
from $tabla h
where id_empresa='$id_empresa'
order by h.nombre ASC";			
}
//echo "<br>----------------------------->".$sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}
function lista_otec_vista_data($id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "	
select h.*
from tbl_otec h
where 
h.id_empresa='$id_empresa'
order by h.nombre ASC
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();   
return $cod;  

}
function BuscaNombrePerfilAdmin($id){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "	
select h.nombre_perfil
from tbl_admin_perfiles h
where 
h.id='$id' limit 1
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();   
return $cod[0]->nombre_perfil;  

}
function proveedores_ejecutivos_save_insert_update($id_empresa, $tipo, $id, $rut, $nombre, $descripcion, $direccion, $telefono, $email, $contacto) {

//echo "proveedores_ejecutivos_save_insert_update($id_empresa, $tipo, $id, $rut, nombre $nombre, descripcioon $descripcion, direccion $direccion, telefono $telefono, email $email, contacto $contacto)";

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$id						= Decodear3($id);
$rut 					= utf8_decode($rut);
$nombre 			= utf8_decode($nombre);
$descripcion 	= utf8_decode($descripcion);
$direccion 		= utf8_decode($direccion);
$telefono  		= utf8_decode($telefono);
$email  			= utf8_decode($email); 
$contacto  		= utf8_decode($contacto);

if($tipo=="ejecutivos")								{ $tabla="tbl_ejecutivos"; }
elseif($tipo=="otec")									{ $tabla="tbl_otec"; }
elseif($tipo=="relatores")						{ $tabla="tbl_relatores"; }
elseif($tipo=="usuarios_manuales")		{ $tabla="tbl_usuario"; }
elseif($tipo=="direcciones")					{ $tabla="tbl_direcciones"; }
elseif($tipo=="administradores")			{ $tabla="tbl_admin"; }

if($tipo=="otec")	{

$rutcuatroprimeros = substr($rut, 0, 4);
$clave=Encriptar($rutcuatroprimeros);
//echo "<br>-->rut $rut, rutcuatroprimeros $rutcuatroprimeros, clave $clave<br>";
//103 es acceso perfil, 103, sera de proveedores

$rut_otec = LimpiaRut($rut);
$sql_insert_tbl_admin="
INSERT INTO tbl_admin		
(user, clave_encodeada, nombre, acceso, id_empresa, email,nombre_completo, perfil, activo, filtro_division_personas)
VALUES 
('$rut_otec', '$clave', '$nombre', '103', '".$_SESSION["id_empresa"]."', '$email', '$nombre', 'Proveedor', '0', '0');

";
//echo "<br>".$sql_insert_tbl_admin."<br>";
$database->setquery($sql_insert_tbl_admin);
$database->query();				
//exit();
$sql_insert = "INSERT INTO $tabla
(rut, nombre, direccion, telefono, email, contacto, id_empresa) 
VALUES ('$rut', '$nombre', '$direccion', '$telefono', '$email','$contacto','$id_empresa');";
}		


if($id>0){
$sql1 = "select h.*
from $tabla h
where h.id_empresa='$id_empresa'
and h.id='$id'
";
// echo $sql1;
$database->setquery($sql1);
$database->query();
$cod1 = $database->listObjects();
}	
//print_r($cod1);


if($cod1[0]->id>0){

if($tipo=="administradores")	{
$perfil							=	BuscaNombrePerfilAdmin($direccion);
$sql_update="update  $tabla set user='$rut', nombre='$nombre', nombre_completo='$nombre', acceso='$direccion', perfil='$perfil' where id='$id'";
}
if($tipo=="ejecutivos")	{
$sql_update="update  $tabla set rut='$rut', nombre='$nombre', descripcion='$descripcion' where id='$id'";
}
elseif($tipo=="otec")	{
$sql_update="update  $tabla set rut='$rut', nombre='$nombre', direccion='$direccion', telefono='$telefono', email='$email', contacto='$contacto' where id='$id'";
}
elseif($tipo=="direcciones")	{
$sql_update="update  $tabla set nombre='$nombre', direccion='$direccion', ciudad='$telefono' where id='$id'";
}
elseif($tipo=="relatores")	{
$sql_update = "update  $tabla	set rut='$rut', nombre='$nombre', cargo='$direccion', tipo='$telefono', email='$email', empresa='$contacto' where id='$id'";

}				
elseif($tipo=="usuarios_manuales")	{
$nombre_completo=$nombre." ".$descripcion;

$sql_update = "update $tabla

set rut='$rut', 
nombre='$nombre',
apaterno='$descripcion', 
nombre_completo='$nombre_completo', 
email='$direccion', 
nombre_empresa_holding='$telefono'
empresa_holding='USUARIO_MANUAL'

where id='$id'";

}													
//echo $sql_update; exit();
$database->setquery($sql_update);
$database->query();		
} else {

if($tipo=="administradores")	{



$user=$rut;
$clave = substr($rut, 0, 4);
$nombre							=	$nombre;
$acceso							=	$direccion;
$id_empresa					=	$id_empresa;
$email							=	$email;
$clave_encodeada		=	Encriptar($clave);
$nombre_completo		=	$nombre;
$perfil							=	BuscaNombrePerfilAdmin($direccion);
//echo "<br>user $user, clave $clave, clave_encodeada $clave_encodeada<br>";

$sql_insert = "	INSERT INTO $tabla
(user,nombre,acceso, id_empresa,email, clave_encodeada,nombre_completo,perfil) 
VALUES 
('$rut', '$nombre', '$acceso', '$id_empresa', '$email', '$clave_encodeada', '$nombre_completo', '$perfil');";
//echo $sql_insert;
//exit();
}			

if($tipo=="ejecutivos")	{
$sql_insert = "INSERT INTO $tabla
(rut, nombre, descripcion, id_empresa) 
VALUES ('$rut', '$nombre', '$descripcion', '$id_empresa');";
}
elseif($tipo=="otec")	{
$sql_insert = "INSERT INTO $tabla
(rut, nombre, direccion, telefono, email, contacto, id_empresa) 
VALUES ('$rut', '$nombre', '$direccion', '$telefono', '$email','$contacto','$id_empresa');";
}		
elseif($tipo=="direcciones")	{
$sql_insert = "INSERT INTO $tabla
(nombre, direccion, ciudad, id_empresa) 
VALUES ('$nombre', '$direccion', '$telefono', '$id_empresa');";
}								
elseif($tipo=="relatores")	{
$sql_insert = "INSERT INTO $tabla
(rut, nombre, cargo, tipo, email, empresa, id_empresa) 
VALUES ('$rut', '$nombre', '$direccion', '$telefono', '$email','$contacto','$id_empresa');";
}			
elseif($tipo=="usuarios_manuales")	{
$nombre_completo=$nombre." ".$descripcion;
$sql_insert = "INSERT INTO $tabla
(rut, rut_completo, nombre, apaterno, nombre_completo, email, nombre_empresa_holding, empresa_holding, id_empresa,vigencia_descripcion) 
VALUES ('$rut','$email', '$nombre', '$descripcion', '$nombre_completo', '$direccion','$telefono','USUARIO_MANUAL','$id_empresa','USUARIO_MANUAL');";
}								
//echo $sql_insert; exit();	
$database->setquery($sql_insert);
$database->query();		

}

}

function IMPARTICION_EliminaUsuariosInscripcionUsuarioT($codigo_imparticion, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "delete from tbl_inscripcion_usuarios where id_empresa='$id_empresa' and id_inscripcion='$codigo_imparticion'";
//echo $sql;
//exit();
$database->setquery($sql);
$database->query();


$sql = "delete from rel_lms_malla_persona where id_empresa='$id_empresa' and id_malla='e_p_f'";
//echo $sql;
//exit();
$database->setquery($sql);
$database->query();
}

function IMPARTICION_InsertaInscripcionUsuariosT($id_inscripcion, $rut, $id_curso, $id_empresa, $estado_inscripcion, $inscrito) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select count(id) as cuenta, id_malla from rel_lms_malla_curso where
id_curso='$id_curso' and id_empresa='$id_empresa' and id_malla<>'e_p_f'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
// print_r($cod);
if($cod[0]->cuenta >0){$id_malla_inscripcion=$cod[0]->id_malla;} else {$id_malla_inscripcion="e_p_f";}




$sql = "INSERT INTO tbl_inscripcion_usuarios
(id_inscripcion, rut, id_curso, id_empresa, estadoinscripcion, inscrito, fecha, hora, relator, id_malla
) " .
"VALUES ('$id_inscripcion', '$rut', '$id_curso', '$id_empresa', '$estado_inscripcion',
'$inscrito', '" . date("Y-m-d") . "', '" . date("H:i:s") . "', '0','$id_malla_inscripcion');";

$database->setquery($sql);
$database->query();

$sql = "DELETE from  rel_lms_malla_persona   where rut='$rut' and id_empresa='$id_empresa' and id_malla='$id_malla_inscripcion'";

$database->setquery($sql);
$database->query();

$sql = "INSERT INTO rel_lms_malla_persona
(id_malla, rut, id_empresa, id_imparticion) " .
"VALUES ('$id_malla_inscripcion', '$rut', '$id_empresa', '$id_inscripcion');";
if($id_malla<>'presencial'){
$database->setquery($sql);
$database->query();
}
}

function DatosCurso_2($id_curso){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "	select * from tbl_lms_curso where id='$id_curso'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	

}

function TraigoRegistrosPorSesionDeCheckinPorImparticion_2021($codigo_inscripcion, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$datos_empresa = DatosEmpresa($id_empresa);
$campo1 = $datos_empresa[0]->campo1;
$campo2 = $datos_empresa[0]->campo2;
$campo3 = $datos_empresa[0]->campo3;

if ($campo1) {
$filtro1 = " tbl_usuario." . $campo1 . " as campo1, ";
}

if ($campo2) {
$filtro2 = " tbl_usuario." . $campo2 . " as campo2, ";
}

if ($campo3) {
$filtro3 = " tbl_usuario." . $campo3 . " as campo3, ";
}

$sql = "
SELECT
h.*,
(select porcentaje_asistencia from tbl_inscripcion_cierre where id_inscripcion=h.id_inscripcion and rut=h.rut) as asistencia,
(select estado_descripcion from tbl_inscripcion_cierre where id_inscripcion=h.id_inscripcion and rut=h.rut) as estado_descripcion,
(select nota from tbl_inscripcion_cierre where id_inscripcion=h.id_inscripcion and rut=h.rut) as nota

FROM
tbl_inscripcion_usuarios h 

WHERE

h.id_inscripcion = '$codigo_inscripcion'
AND h.id_empresa = '$id_empresa'
and h.rut<>''
and h.rut<>'12121212'
and h.rut<>'12345'
and h.rut<>'13131313'
and h.rut<>'14141414'

";

//echo $sql;exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function InsertaRelacionInscripcionUsuarioPresencial2021($rut, $id_programa,$id_malla, $id_inscripcion, $id_curso, $id_empresa, $hoy, $fecha_inscripcion) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);



$sql1 = "SELECT id from tbl_inscripcion_usuarios
where id_curso='$id_curso' and rut='$rut' and id_malla='$id_malla' and id_empresa='$id_empresa'";
$database->setquery($sql1);
$database->query();
$cod1 = $database->listObjects();
$estaigual = count($cod1);

if ($estaigual > 0) {
//no hace nada
} else {

$modalidad_idCurso = ModalidadCurso($id_curso, $id_empresa);

$sqlOp = "SELECT opcional from rel_lms_malla_curso
where id_curso='$id_curso' and id_malla='$id_malla' and id_programa='$id_programa' and id_empresa='$id_empresa' limit 1";
$database->setquery($sqlOp);
$database->query();
$codOp = $database->listObjects();

$sqlIYU = "INSERT INTO tbl_inscripcion_usuarios
(id_malla, id_curso, id_inscripcion,  rut, id_empresa, fecha)
VALUES ('$id_malla', '$id_curso', '$id_inscripcion', '$rut', '$id_empresa', '$fecha_inscripcion');";

$database->setquery($sqlIYU);
$database->query();


}

//echo "<br>InsertaRelacionInscripcionUsuarioMallaPersonaempresa<br><br>";echo "$sqlIYU"; 
}

function BuscaRutDadoRutEmailIdSap_2021($rut){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT rut from tbl_usuario  where (rut='$rut' or email='$rut' or codigo_sap='$rut') and vigencia='0'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();	

return $cod[0]->rut;

}

function InsertaRelacionInscripcionUsuarioFull2021($rut, $id_programa, $id_inscripcion, $id_curso, $Imp, $id_empresa) {



$rut=BuscaRutDadoRutEmailIdSap_2021($rut);

//echo "<br>InsertaRelacionInscripcionUsuarioFull2021 -> rut $rut"; exit();

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$Imp=DatosCompletosImparticion_2021($id_inscripcion);
//print_r($Imp);exit();
$hoy=date("Y-m-d");

if($Imp[0]->id_modalidad=="1"){

$sqlIYU = "INSERT INTO rel_lms_id_curso_id_inscripcion
(id_curso,
id_inscripcion,

nombre_inscripcion,

fecha_inicio_inscripcion,
fecha_termino_inscripcion,

id_empresa,

opcional,
activa,

rut_ejecutivo,

id_malla,
id_programa,
id_foco
)
VALUES ('".$Imp[0]->id_curso."', '".$Imp[0]->codigo_inscripcion."', 

'".$Imp[0]->nombre."',

'".$Imp[0]->fecha_inicio."', '".$Imp[0]->fecha_termino."', 

'".$id_empresa."',

'', '', 

'".$Imp[0]->sabado_d_am."',

'".$Imp[0]->id_malla."', '".$Imp[0]->id_programa."', 	'".$Imp[0]->id_foco."');";

$database->setquery($sqlIYU);
$database->query();					

$sqlIYU = "INSERT INTO rel_lms_rut_id_curso_id_inscripcion
(	rut,
id_curso,	id_inscripcion,
nombre_inscripcion,
fecha_inicio_inscripcion,
fecha_termino_inscripcion,

id_empresa,
opcional,

avance_historico,
nota_historico,
estado_historico,

activa,

rut_ejecutivo

)
VALUES ('$rut', 
'".$Imp[0]->id_curso."', '".$Imp[0]->codigo_inscripcion."', 
'".$Imp[0]->nombre."',
'".$Imp[0]->fecha_inicio."', '".$Imp[0]->fecha_termino."',

'".$id_empresa."', '',

'','','',
'',	'".$Imp[0]->ejecutivo."');";

$database->setquery($sqlIYU);
$database->query();	

}

elseif($Imp[0]->id_modalidad=="2"){

$sql1 = "SELECT id from tbl_inscripcion_usuarios
where id_curso='$id_curso' and rut='$rut' and id_malla='$id_malla' and id_empresa='$id_empresa'";
$database->setquery($sql1);
$database->query();
$cod1 = $database->listObjects();
$estaigual = count($cod1);

if ($estaigual > 0) {

} else {

$modalidad_idCurso = ModalidadCurso($id_curso, $id_empresa);

$sqlOp = "SELECT opcional from rel_lms_malla_curso
where id_curso='$id_curso' and id_malla='$id_malla' and id_programa='$id_programa' and id_empresa='$id_empresa' limit 1";
$database->setquery($sqlOp);
$database->query();
$codOp = $database->listObjects();

$sqlIYU = "INSERT INTO tbl_inscripcion_usuarios
(id_malla, id_curso, id_inscripcion,  rut, id_empresa, fecha)
VALUES ('presencial', '$id_curso', '$id_inscripcion', '$rut', '$id_empresa', '".$Imp[0]->fecha_inicio."');";

$database->setquery($sqlIYU);
$database->query();


}	

}

elseif($Imp[0]->id_modalidad=="3"){

$sql1 = "SELECT id from tbl_inscripcion_postulantes
where id_curso='$id_curso' and rut='$rut' id_empresa='$id_empresa'";
$database->setquery($sql1);
$database->query();
$cod1 = $database->listObjects();
$estaigual = count($cod1);

if ($estaigual > 0) {

} else {

$modalidad_idCurso = ModalidadCurso($id_curso, $id_empresa);

$sqlOp = "SELECT opcional from rel_lms_malla_curso
where id_curso='$id_curso' and id_malla='$id_malla' and id_programa='$id_programa' and id_empresa='$id_empresa' limit 1";
$database->setquery($sqlOp);
$database->query();
$codOp = $database->listObjects();

$sqlIYU = "INSERT INTO tbl_inscripcion_postulantes
(rut, id_inscripcion, id_curso, fecha, id_empresa)
VALUES ('$rut', '$id_inscripcion', '$id_curso', '$hoy', '$id_empresa');";

$database->setquery($sqlIYU);
$database->query();


}


}



//echo "<br>InsertaRelacionInscripcionUsuarioMallaPersonaempresa<br><br>";echo "$sqlIYU"; 
//exit();
}

function DAtosCursoDadoIdInscripcion($id_inscripcion, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select
tbl_inscripcion_curso.*,

tbl_lms_curso.nombre as nombre_curso,
tbl_lms_curso.id_programa_global as id_programa,

tbl_lms_curso.cantidad_maxima_participantes,
(select nombre_completo from tbl_usuario where rut=tbl_inscripcion_curso.ejecutivo) as nombre_ejecutivo


from tbl_inscripcion_curso

inner join tbl_lms_curso
on tbl_lms_curso.id=tbl_inscripcion_curso.id_curso


where tbl_inscripcion_curso.codigo_inscripcion='$id_inscripcion' and tbl_inscripcion_curso.id_empresa='$id_empresa'

order by tbl_inscripcion_curso.id DESC

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function VerificaEnTablaCierreCursoEmpresRutInscripcion($id_curso, $rut, $id_empresa, $id_inscripcion) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_inscripcion_cierre where  id_curso='$id_curso' and rut='$rut' and id_empresa='$id_empresa' and id_inscripcion='$id_inscripcion'";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}function VerificaEnTablaCierreCursoEmpresRutInscripcion2021($rut, $id_empresa, $id_inscripcion) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_inscripcion_cierre where  rut='$rut' and id_empresa='$id_empresa' and id_inscripcion='$id_inscripcion'";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function BuscaProgramasDadoIdCurso($id_curso, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.*, (select nombre_programa from tbl_lms_programas_bbdd where id_programa=h.id_programa) as programa
from rel_lms_malla_curso h where h.id_curso='$id_curso' and h.id_empresa='$id_empresa'  group by h.id_programa ";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function BuscaIdImparticiondadoCurso($id_curso, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.codigo_inscripcion
from tbl_inscripcion_curso h
where h.id_curso='$id_curso' and h.id_empresa='$id_empresa'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

// CREACION DE CURSOS PRESENCIALES

//***




function data_rel_progra_malla_por_curso_lista($id_curso, $id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$sql="

SELECT
h.*, (
SELECT
nombre
FROM
tbl_lms_malla
WHERE
id = h.id_malla
AND id_empresa = '$id_empresa'
) AS malla,
(
SELECT
nombre_programa
FROM
tbl_lms_programas_bbdd
WHERE
id_programa = h.id_programa
AND id_empresa = '$id_empresa'
AND inactivo IS NULL
) AS programa,
concat(
(
SELECT
nombre_programa
FROM
tbl_lms_programas_bbdd
WHERE
id_programa = h.id_programa
AND id_empresa = '$id_empresa'
AND inactivo IS NULL
),
' - ',
(
SELECT
nombre
FROM
tbl_lms_malla
WHERE
id = h.id_malla
AND id_empresa = '$id_empresa'
)

) AS GroupBy,

concat(
(
SELECT
id_programa
FROM
tbl_lms_programas_bbdd
WHERE
id_programa = h.id_programa
AND id_empresa = '78'
AND inactivo IS NULL
),
';',
(
SELECT
id
FROM
tbl_lms_malla
WHERE
id = h.id_malla
AND id_empresa = '78'
)

) AS IdGroupBy

FROM
rel_lms_malla_curso h
WHERE
h.id_curso = '$id_curso'
AND id_empresa = '$id_empresa'
AND inactivo = '0'

and (
SELECT
nombre_programa
FROM
tbl_lms_programas_bbdd
WHERE
id_programa = h.id_programa
AND id_empresa = '$id_empresa'
AND inactivo IS NULL
)<>''

and (
SELECT
nombre
FROM
tbl_lms_malla
WHERE
id = h.id_malla
AND id_empresa = '$id_empresa'
)<>''

GROUP BY
concat(
(
SELECT
nombre_programa
FROM
tbl_lms_programas_bbdd
WHERE
id_programa = h.id_programa
AND id_empresa = '$id_empresa'
AND inactivo IS NULL
),
';',
(
SELECT
nombre
FROM
tbl_lms_malla
WHERE
id = h.id_malla
AND id_empresa = '$id_empresa'
)

)
ORDER BY
concat(
(
SELECT
nombre_programa
FROM
tbl_lms_programas_bbdd
WHERE
id_programa = h.id_programa
AND id_empresa = '$id_empresa'
AND inactivo IS NULL
),
';',
(
SELECT
nombre
FROM
tbl_lms_malla
WHERE
id = h.id_malla
AND id_empresa = '$id_empresa'
)

)

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	
}
function data_rel_id_inscripcion_rut_curso_lista_data($id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

//if($tipo_groupby=="Curso"){
$sql = "select h.* from rel_lms_rut_id_curso_id_inscripcion h  order by id DESC limit 100000";
//} 

//	echo "<br>sql $sql";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	

}

function data_rel_id_inscripcion_rut_curso_lista_por_idcurso_idinscripcion_data($id_curso, $id_inscripcion, $rut_colaborador, $id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

//echo "<br>---> id_curso $id_curso, id_inscripcion $id_inscripcion, rut_colaborador $rut_colaborador, id_empresa $id_empresa <br>";

if($id_curso<>""){
$sql = "select h.* from rel_lms_rut_id_curso_id_inscripcion h where h.id_curso='$id_curso' order by id DESC ";
}
elseif($id_inscripcion<>""){
$sql = "select h.* from rel_lms_rut_id_curso_id_inscripcion h where h.id_inscripcion='$id_inscripcion'  order by id DESC";
}
elseif($rut_colaborador<>""){
$sql = "select h.* from rel_lms_rut_id_curso_id_inscripcion h where h.rut='$rut_colaborador'  order by id DESC";
} else {
//$sql = "select h.* from rel_lms_rut_id_curso_id_inscripcion h  order by id DESC limit 100000";
//$sql = "select h.* from rel_lms_rut_id_curso_id_inscripcion h  order by id DESC limit 1";
}

//echo "<br>sql $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	

}

function data_rel_id_inscripcion_curso_rut_unico_limit_ultima_data($rut, $id_curso){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$sql = "	select id_inscripcion from rel_lms_rut_id_curso_id_inscripcion where rut='$rut' and id_curso='$id_curso' order by  fecha_inicio_inscripcion DESC limit 1	";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod[0]->id_inscripcion;	

}

function data_rel_id_inscripcion_curso_groupby_data($id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$sql = "	SELECT
h.id_curso,
(
SELECT
nombre
FROM
tbl_lms_curso
WHERE
id = h.id_curso
) AS curso,
h.id_programa,
(
SELECT
nombre_programa
FROM
tbl_lms_programas_bbdd
WHERE
id_programa = h.id_programa
) AS programa,
h.id_malla,
(
SELECT
nombre
FROM
tbl_lms_malla
WHERE
id = h.id_malla
) AS malla
FROM
rel_lms_id_curso_id_inscripcion h
GROUP BY
h.id_curso";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	

}

function data_rel_id_inscripcion_curso_groupby_id_curso_data($id_curso,$id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "	select h.*
from rel_lms_rut_id_curso_id_inscripcion h 
where h.id_curso='".$id_curso."'
group by h.id_inscripcion";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	

}

function data_rel_id_inscripcion_curso_groupby_id_imparticion_data($id_inscripcion,$id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "	select h.*,
(select descripcion from tbl_lms_foco where codigo_foco=h.id_foco) as foco,
(select nombre_programa from tbl_lms_programas_bbdd where id_programa=h.id_programa) as programa

from rel_lms_id_curso_id_inscripcion h 
where h.id_inscripcion='".$id_inscripcion."'
group by h.id_inscripcion";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	

}

function data_rel_id_inscripcion_rut_curso_Insert($row) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
INSERT INTO rel_lms_rut_id_curso_id_inscripcion (
rut,
id_curso,
id_inscripcion,
fecha_inicio_inscripcion,
fecha_termino_inscripcion,
rut_ejecutivo
)
VALUES ($row)";
//echo $sql; exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();


}

function     data_rel_id_inscripcion_curso_Insert($id_inscripcion, 
$nombre_inscripcion,
$fecha_inicio,
$fecha_termino,
$id_empresa,
$rut_ejecutivo,
$id_curso,
$opcional,
$malla,
$programa
){

if($opcional=="1" or $opcional=="Si" or $opcional=="SI"){
$opcional=1;
} else {
$opcional=0;
}

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
INSERT INTO rel_lms_id_curso_id_inscripcion (

id_curso,
id_inscripcion,
nombre_inscripcion,
fecha_inicio_inscripcion,
fecha_termino_inscripcion,
id_empresa,
rut_ejecutivo,
opcional,
id_malla,
id_programa


)
VALUES (

'$id_curso',
'$id_inscripcion', 
'$nombre_inscripcion',
'$fecha_inicio',
'$fecha_termino',
'$id_empresa',
'$rut_ejecutivo',

'$opcional',
'$malla',
'$programa'    

)";
//echo $sql; exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();   	

}

function data_rel_id_inscripcion_full_inscripcion($id_inscripcion){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "	select h.*
from rel_lms_rut_id_curso_id_inscripcion h 
where h.id_inscripcion='".$id_inscripcion."'
and h.fecha_inicio_inscripcion<>''
and h.fecha_termino_inscripcion<>''
order by h.rut_ejecutivo DESC, h.fecha_inicio_inscripcion
";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;		


}

function data_rel_id_inscripcion_rut_curso_Delete($id_inscripcion, $rut) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
DELETE from rel_lms_rut_id_curso_id_inscripcion 
where 
id_inscripcion='$id_inscripcion'
and
rut='$rut'
";
//echo "DELETE<br>".$sql; exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
}

function data_rel_id_inscripcion_rut_curso_Delete_Full($id_inscripcion) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
DELETE from rel_lms_rut_id_curso_id_inscripcion 
where 
id_inscripcion='$id_inscripcion'

";
//echo "DELETE<br>".$sql; exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
}

function data_rel_id_inscripcion_rut_curso_Update($id_inscripcion, $fecha_inicio, $fecha_termino, $rut_ejecutivo) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if($rut_ejecutivo<>""){
$update_rut_ejecutivo=" , rut_ejecutivo='".$rut_ejecutivo."' ";
}

$sql = "

UPDATE rel_lms_rut_id_curso_id_inscripcion 

set fecha_inicio_inscripcion='".$fecha_inicio."', fecha_termino_inscripcion='".$fecha_termino."'
$update_rut_ejecutivo

where id_inscripcion='$id_inscripcion'
";

//echo $sql; exit();
if($id_inscripcion<>""){
$database->setquery($sql);
$database->query();
}

$cod = $database->listObjects();


}


//**reportes_online**
function reportes_online_trae_c1c2c3c4($id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_reportes_online_c1_c2_c3_c4 where id_empresa='".$id_empresa."' ";
//echo "<br>sql $sql";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	
}
function reportes_online_Insert_agrupacion_data($id_agrupacion,$nombre_agrupacion,$id_curso){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$hoy = date("Y-m-d");
$nombre_agrupacion=utf8_decode($nombre_agrupacion);
$sql = "
INSERT INTO tbl_reportes_online_agrupaciones (nombre,id_curso,id_agrupacion)
VALUES ('$nombre_agrupacion','$id_curso','$id_agrupacion')";

$database->setquery($sql);
$database->query();

$cod = $database->listObjects();
return $cod;	


}
function reportes_online_groupby_c1c2c3c4($c){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select $c as dato from tbl_reportes_online_usuario where $c<>'' group by $c order by $c ";
//echo "<br>sql $sql";exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	
}
function reportes_online_cron_data($id_empresa){
$id_empresa="78";
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);	


// solo COPEC

// modalidad 2

$sql_modalidad2_insert_update="

SELECT
h.*,
( SELECT numero_horas FROM tbl_lms_curso WHERE id = h.id_curso ) AS numero_horas ,
( SELECT id_programa_global FROM tbl_lms_curso WHERE id = h.id_curso ) AS id_programa ,
(select count(id) from tbl_lms_reportes where rut=h.rut and id_curso=h.id_curso) as id_reportes_solo_curso,
(select avance from tbl_lms_reportes where rut=h.rut and id_curso=h.id_curso) as avance_reportes,
(select estado from tbl_lms_reportes where rut=h.rut and id_curso=h.id_curso) as estado_reportes,
(select count(id) from tbl_lms_reportes where rut=h.rut and id_curso=h.id_curso and id_inscripcion=h.id_inscripcion) as id_reportes,
(select count(id) from tbl_lms_reportes where rut=h.rut and id_curso=h.id_curso ) as id_reportessOLOcurso,
(select fecha_inicio from tbl_inscripcion_curso where codigo_inscripcion=h.id_inscripcion) as fecha_inicio_ins,
(select fecha_termino from tbl_inscripcion_curso where codigo_inscripcion=h.id_inscripcion) as fecha_termino_ins


FROM
tbl_inscripcion_cierre h
where ( SELECT modalidad FROM tbl_lms_curso WHERE id = h.id_curso )='2'
and h.id_curso not like 'cop_%'
and h.estado_descripcion is not null
and h.estado_descripcion <>''
and h.avance is not NULL
order by 
(select count(id) from tbl_lms_reportes where rut=h.rut and id_curso=h.id_curso ) DESC,
(select count(id) from tbl_lms_reportes where rut=h.rut and id_curso=h.id_curso and id_inscripcion=h.id_inscripcion) DESC

";


$database->setquery($sql_modalidad2_insert_update);
$database->query();		
$sql_modalidad2_insert_update = $database->listObjects();	

foreach ($sql_modalidad2_insert_update as $unicoMod2)	{

//echo "<br>rut, id_curso, avance, id_empresa, modalidadcurso (2), id_programa, numero_horas,fecha_inicio, fecha_termino, curso_opcional (0),estado, fecha_inscripcion,	id_inscripcion<br>";


$rut=$unicoMod2->rut;
$id_curso=$unicoMod2->id_curso;
$avance=$unicoMod2->avance;
$id_empresa=$unicoMod2->id_empresa;
$modalidadcurso="2";
$id_programa=$unicoMod2->id_programa;
$numero_horas=$unicoMod2->numero_horas;
$fecha_inicio=$unicoMod2->fecha_inicio_ins;
$fecha_termino=$unicoMod2->fecha_termino_ins;
$curso_opcional="0";
$estado=$unicoMod2->estado_descripcion;
$fecha_inscripcion=$unicoMod2->fecha_inicio_ins;
$id_inscripcion=$unicoMod2->id_inscripcion;

//echo "<br>$rut,crso $id_curso,avance $avance,id empresa $id_empresa,	$modalidadcurso,	$id_programa,$numero_horass							$fecha_inicio,$fecha_termino,$curso_opcional,estado $estado,$fecha_inscripcion,$id_inscripcion";	

if($unicoMod2->id_reportessOLOcurso>0){
//echo "-> update";
$sql_update_mod2=" update tbl_lms_reportes set

rut='$rut', id_curso='$id_curso', avance='$avance', id_empresa='$id_empresa', modalidadcurso='2', 
id_programa='$id_programa', numero_horas='$numero_horas',
fecha_inicio='$fecha_inicio', fecha_termino='$fecha_termino', curso_opcional='0',
estado='$estado', fecha_inscripcion='$fecha_inscripcion',
id_inscripcion='$id_inscripcion'

where rut='$rut' and id_curso='$id_curso'

";
//echo " - $sql_update_mod2";
$database->setquery($sql_update_mod2);
$database->query();    			 			
} else {
//echo "-> insert ";

$sql_insert_mod2 = 	"INSERT INTO tbl_lms_reportes (rut, id_curso, avance, id_empresa, 
modalidadcurso, id_programa, numero_horas,
fecha_inicio, fecha_termino, curso_opcional,
estado, fecha_inscripcion,
id_inscripcion) " .
"VALUES ('$rut', '$id_curso', '$avance', '$id_empresa', 
'2', '$id_programa', '$numero_horas',
'$fecha_inicio', '$fecha_termino', '0',
'$estado', '$fecha_inscripcion',
'$id_inscripcion');";
//echo "-> $sql_insert_mod2 ";
$database->setquery($sql_insert_mod2);
$database->query();    

}
}

//exit();


$sql_update_reprobado_inasistencia="update tbl_lms_reportes set estado='NO_INICIADO' where estado='REPROBADO_POR_INASISTENCIA'";
$database->setquery($sql_update_reprobado_inasistencia);
$database->query();	

//si fecha inscripcion es null o 0000-00-00 pone la fecha de inicio
$sql_fecha_inscripcion_null=" 	select h.* from tbl_lms_reportes h where h.fecha_inscripcion is null and h.avance>0 order by h.modalidadcurso;";
$database->setquery($sql_fecha_inscripcion_null);
$database->query();	
$cod_fecha_inscripcion_null = $database->listObjects();		
foreach($cod_fecha_inscripcion_null as $unico){
//print_r($unico);
if($unico->fecha_inicio<>'0000-00-00'){
$sql_UpdateFechaInscripcionNull="update tbl_lms_reportes 
set fecha_inscripcion='".$unico->fecha_inicio."' 
where id='".$unico->id."'";
echo "<br>sql_UpdateFechaInscripcionNull $sql_UpdateFechaInscripcionNull";					
$database->setquery($sql_UpdateFechaInscripcionNull);$database->query();	
}

}
$sql_fecha_inscripcion_cero=" 	select h.* from tbl_lms_reportes h where h.fecha_inscripcion='0000-00-00' and h.avance>0 order by h.modalidadcurso;	   ";
$database->setquery($sql_fecha_inscripcion_cero);
$database->query();	
$cod_fecha_inscripcion_cero = $database->listObjects();		
foreach($cod_fecha_inscripcion_cero as $unico){
//print_r($unico);
if($unico->fecha_inicio<>'0000-00-00'){
$sql_UpdateFechaInscripcionCero="update tbl_lms_reportes set fecha_inscripcion='".$unico->fecha_inicio."' where id='".$unico->id."'";
//echo "<br>sql_UpdateFechaInscripcionCero $sql_UpdateFechaInscripcionCero";
$database->setquery($sql_UpdateFechaInscripcionCero);$database->query();	
}


}



//exit();

//pone numero de horas a lms reportes cuando es null
$sql_cursosInHoras=" 		select h.* from tbl_lms_reportes h where h.numero_horas is null group by id_curso";
$database->setquery($sql_cursosInHoras);
$database->query();	
$cod_cursosInHoras = $database->listObjects();		
foreach($cod_cursosInHoras as $CursosinHora){
//echo "<br>.id curso ".$CursosinHora->id_curso;
$sql_buscaHoras="select numero_horas from tbl_lms_curso where id='".$CursosinHora->id_curso."'";
$database->setquery($sql_buscaHoras);
$database->query();	
$cod_buscaHoras = $database->listObjects();		

//echo "<br> --> ".$cod_buscaHoras[0]->numero_horas;
//echo "update tbl_lms_reportes set numero_horas='".$cod_buscaHoras[0]->numero_horas."' where id_curso='".$CursosinHora->id_curso."'";
$sql_UpdateNHoras="update tbl_lms_reportes set numero_horas='".$cod_buscaHoras[0]->numero_horas."' where id_curso='".$CursosinHora->id_curso."'";
$database->setquery($sql_UpdateNHoras);
$database->query();	

}

//exit();


// Pone el Id Encuesta
$Usuarios_online=reportes_online_lista_usuarios_data();
foreach ($Usuarios_online as $unico){
$Arreglo_avance	=Cron_Data_Individual_Cursos_Busca_SinAvance($unico->rut);

if(count($Arreglo_avance)>0){
//echo "<div>Avance</div>";
//print_r($Arreglo_avance);	
$sqlUpdate_1_1 = "	update tbl_lms_reportes set avance='".$Arreglo_avance[0]->avanceCierre."' 
where id='".$Arreglo_avance[0]->id."'";
//echo "<br>-->$sqlUpdate_1_1";
$database->setquery($sqlUpdate_1_1);	$database->query();    							
}

$arreglo_nota		=Cron_Data_Individual_Cursos_Busca_SinResutlados($unico->rut);

if(count($arreglo_nota)>0){
//echo "<div>Nota</div>";
//print_r($arreglo_nota);	
//echo "<br>->".$arreglo_nota[0]->avance;
if($arreglo_nota[0]->avance=="100"){
$sqlUpdate_1_1 = "	update tbl_lms_reportes set resultado='".$arreglo_nota[0]->notaCierre."' 
where id='".$arreglo_nota[0]->id."'";
//echo "<br>-->$sqlUpdate_1_1";
$database->setquery($sqlUpdate_1_1);	$database->query();   				
}
}

}


$arreglo_estado	=Cron_Data_Individual_Cursos_Busca_ReprobadosSobreOChenta();
if(count($arreglo_estado)>0){
//echo "<div>Estado</div>";
//print_r($arreglo_estado);	
//echo "<br>->APROBADO";
$sqlUpdate_1_1 = "	update tbl_lms_reportes set estado='APROBADO' 
where id='".$arreglo_estado[0]->id."'";
//echo "<br>-->$sqlUpdate_1_1";
$database->setquery($sqlUpdate_1_1);	$database->query();   				
}

$sql_usuarioPrueba=" 		delete h.* from 
tbl_lms_reportes h where h.rut='12345';";
$database->setquery($sql_usuarioPrueba);
$database->query();

$sql_usuarioPrueba=" 		delete h.* from 
tbl_lms_reportes h where h.rut='12121212';";
$database->setquery($sql_usuarioPrueba);
$database->query();

$sql_usuarioPrueba=" 		delete h.* from 
tbl_lms_reportes h where h.rut='13131313';";
$database->setquery($sql_usuarioPrueba);
$database->query();

$sql_usuarioPrueba=" 		delete h.* from 
tbl_lms_reportes h where h.rut='14141414';";
$database->setquery($sql_usuarioPrueba);
$database->query();	  	  

$sql_usuarioPrueba=" 		delete h.* from 
tbl_lms_reportes h where h.rut='id';";
$database->setquery($sql_usuarioPrueba);
$database->query();
$sql_2="select h.* from tbl_lms_reportes h where h.modalidadcurso is null or h.modalidadcurso ='';";
$database->setquery($sql_2);    $database->query();    $cod_2 = $database->listObjects();	

// echo "<br>Count 2 Modalidad Nula o Vacia: ".count($cod_2);
foreach ($cod_2 as $unico){

$sql_2_1="select h.modalidad from tbl_lms_curso h where h.id='".$unico->id_curso."'";
$database->setquery($sql_2_1);    $database->query();    $cod_2_1 = $database->listObjects();	 	
$sqlUpdate_1_1 = "	update tbl_lms_reportes set modalidadcurso='".$cod_2_1[0]->modalidad."' where id='".$unico->id."'";
$database->setquery($sqlUpdate_1_1);	$database->query();    			

}



$sql_2="SELECT h.* FROM tbl_lms_reportes h WHERE (h.estado IS NULL OR h.estado='') AND h.modalidadcurso = '1'		order by h.fecha_inicio DESC;";
$database->setquery($sql_2);    $database->query();    $cod_2 = $database->listObjects();	
//echo "<br>Count 3 Estado Nulo o Vacio: ".count($cod_2);        
foreach ($cod_2 as $unico){
$sql_2_1="SELECT h.* FROM tbl_inscripcion_cierre h WHERE h.rut='".$unico->rut."' and h.id_curso='".$unico->id_curso."' and id_empresa='".$unico->id_empresa."'";
$database->setquery($sql_2_1);    $database->query();    $cod_2_1 = $database->listObjects();	 	
//echo "<br>$sql_2_1<br>";print_r($cod_2_1);
if($cod_2_1[0]->avance>0 and $cod_2_1[0]->avance<100){
$avance=$cod_2_1[0]->avance;
$estado="EN_PROCESO";
} else {
$avance="0";
$estado="NO_INICIADO";
}
$sqlUpdate_1_1 = "	update tbl_lms_reportes set avance='".$avance."', estado='".$estado."'
where id='".$unico->id."'";
//echo "<h1>$sqlUpdate_1_1</h1><br>";
$database->setquery($sqlUpdate_1_1);	$database->query();    			
}

$sql_2="SELECT h.* FROM tbl_lms_reportes h WHERE (h.estado='EN_PROCESO') AND (h.avance='100'  or h.avance='0') AND h.modalidadcurso = '1';";
$database->setquery($sql_2);    $database->query();    $cod_2 = $database->listObjects();	
// echo "<br>Count 4 avance 100 y Proceso: ".count($cod_2);    
foreach ($cod_2 as $unico){
$sql_2_1="SELECT h.* FROM tbl_inscripcion_cierre h WHERE h.rut='".$unico->rut."' and h.id_curso='".$unico->id_curso."' and id_empresa='".$unico->id_empresa."'";
$database->setquery($sql_2_1);    $database->query();    $cod_2_1 = $database->listObjects();	 	
//echo "<br>$sql_2_1<br>";print_r($cod_2_1);
if($cod_2_1[0]->avance>0){

$estado=$cod_2_1[0]->estado_descripcion;
} else {
$avance="0";
$estado="NO_INICIADO";
}
$sqlUpdate_1_1 = "	update tbl_lms_reportes set estado='".$estado."' where id='".$unico->id."'";
//echo "<h1>$sqlUpdate_1_1</h1><br>";
$database->setquery($sqlUpdate_1_1);	$database->query();    			
}

$sql_2="SELECT h.* FROM tbl_lms_reportes h WHERE h.avance <> '100' AND (h.estado = 'APROBADO' or h.estado = 'REPROBADO') AND h.modalidadcurso = '1' ;";
$database->setquery($sql_2);    $database->query();    $cod_2 = $database->listObjects();	
// echo "<br>Count 5 Avance <>100 y Aprobado Reprobado: ".count($cod_2);
foreach ($cod_2 as $unico){
$sql_2_1="SELECT h.* FROM tbl_inscripcion_cierre h WHERE h.rut='".$unico->rut."' and h.id_curso='".$unico->id_curso."' and id_empresa='".$unico->id_empresa."'";
$database->setquery($sql_2_1);    $database->query();    $cod_2_1 = $database->listObjects();	 	
//echo "<br>$sql_2_1<br>";print_r($cod_2_1);
if($cod_2_1[0]->avance>0){

$estado="EN_PROCESO";
} else {
$avance="0";
$estado="NO_INICIADO";
}
$sqlUpdate_1_1 = "	update tbl_lms_reportes set estado='".$estado."'
where id='".$unico->id."'";
// echo "<h1>$sqlUpdate_1_1</h1><br>";
$database->setquery($sqlUpdate_1_1);	$database->query();    			
}

$hoy=date("Y-m-d");

$sql_2="SELECT h.*, 
(select id from tbl_lms_reportes where rut=h.rut and id_curso=h.id_curso) as IdReportes,
(select avance from tbl_lms_reportes where rut=h.rut and id_curso=h.id_curso) as Avance,
(select estado from tbl_lms_reportes where rut=h.rut and id_curso=h.id_curso) as Estado,
(select avance from tbl_inscripcion_cierre where rut=h.rut and id_curso=h.id_curso and id_empresa='$id_empresa' order by avance limit 1) as AvanceCierre,
(select estado_descripcion from tbl_inscripcion_cierre where rut=h.rut and id_curso=h.id_curso and id_empresa='$id_empresa' order by avance limit 1) as EstadoCierre,
(select nota from tbl_inscripcion_cierre where rut=h.rut and id_curso=h.id_curso and id_empresa='$id_empresa' order by avance limit 1) as notaCierre


FROM tbl_objetos_finalizados h WHERE h.fecha='$hoy'
and h.id_curso<>'' and h.rut<>''

";
$database->setquery($sql_2);    $database->query();    $cod_2 = $database->listObjects();	
//echo "<br><br>id_empresa $id_empresa -> Num Objetos Finalizados Hoy: ".count($cod_2)."<br>";

foreach ($cod_2 as $unico){

if($unico->Avance=="100" and ($unico->Estado=="APROBADO" OR $unico->Estado=="REPROBADO")){
continue;
}
else {
//echo "<br> ".$unico->rut." id curso ".$unico->id_curso. " Avance: ".$unico->Avance. " Estado: ".$unico->Estado." avance Cierre ".$unico->AvanceCierre." Estado Cierre ".$unico->EstadoCierre;

if($unico->AvanceCierre=="100" and $unico->EstadoCierre=="APROBADO"){
//echo "<h3>update tbl_lms_reportes set avance='".$unico->AvanceCierre."', estado='".$unico->EstadoCierre."', resultado='".$unico->notaCierre."' where id='".$unico->IdReportes."'</h3>";
$sql_update="update tbl_lms_reportes set avance='".$unico->AvanceCierre."', estado='".$unico->EstadoCierre."', resultado='".$unico->notaCierre."' where id='".$unico->IdReportes."'";
$database->setquery($sql_update);    $database->query();
}

if($unico->AvanceCierre==$unico->Avance){
//echo " - Not Updated";
}

if($unico->AvanceCierre>$unico->Avance and $unico->AvanceCierre<>"100"){
//echo "<h3>update tbl_lms_reportes set avance='".$unico->AvanceCierre."', estado='EN_PROCESO' where id='".$unico->IdReportes."'</h3>";
$sql_update="update tbl_lms_reportes set avance='".$unico->AvanceCierre."', estado='EN_PROCESO' where id='".$unico->IdReportes."'";
$database->setquery($sql_update);    $database->query();			
}

}
$cuenta_casos_cron++;
}


// CHECK 35
//FechaInicio
$tipo_check="CHECK 35";
$texto1="$tipo_check select h.* from tbl_lms_reportes h where h.modalidadcurso='1' and round(h.avance)>0	and (h.fecha_inicio='0000-00-00' or h.fecha_inicio is null);";
//echo "<h1>".$texto1."</h1>";
$sql_1="select h.* from tbl_lms_reportes h where h.modalidadcurso='1' and round(h.avance)>0 and (h.fecha_inicio='0000-00-00' or h.fecha_inicio is null);";	
$database->setquery($sql_1);$database->query();
$cod_1 = $database->listObjects();
$texto1="$tipo_check - Count To Fix ".count($cod_1);	
$sql_2="select h.* from tbl_lms_reportes h where h.modalidadcurso='1' and round(h.avance)>0 and (h.fecha_inicio='0000-00-00' or h.fecha_inicio is null)";
$database->setquery($sql_2);    $database->query();    $cod_2 = $database->listObjects();	
foreach ($cod_2 as $unico){
$sql_2_1="select min(fecha) as min from tbl_objetos_finalizados where rut='".$unico->rut."' and id_curso='".$unico->id_curso."'";
$database->setquery($sql_2_1);    $database->query();    $cod_2_1 = $database->listObjects();	 	

$sqlUpdate_1_1 = "	update tbl_lms_reportes set fecha_inicio='". $cod_2_1[0]->min."'
where  rut='".$unico->rut."' and id_curso='".$unico->id_curso."' ";
//echo "<h1>$sqlUpdate_1_1</h1><br>";
$database->setquery($sqlUpdate_1_1);	$database->query();    			

}
$sql_1="select h.* from tbl_lms_reportes h where h.modalidadcurso='1' and round(h.avance)>0 and (h.fecha_inicio='0000-00-00' or h.fecha_inicio is null);";
$database->setquery($sql_1);    $database->query();    $cod_1 = $database->listObjects();  $sql_1=str_replace("'",'"',$sql_1);
$texto1="$tipo_check - Count Not Fixed  ".count($cod_1)." ".$sql_1;



// CHECK 36
//FechaTermino
$tipo_check="CHECK 36";
$texto1="$tipo_check select h.* from tbl_lms_reportes h where h.modalidadcurso='1' and round(h.avance)='100' and (h.fecha_termino='0000-00-00' or h.fecha_termino is null);";
//echo "<h1>".$texto1."</h1>";	
$sql_1=" select h.* from tbl_lms_reportes h where h.modalidadcurso='1' and round(h.avance)='100' and (h.fecha_termino='0000-00-00' or h.fecha_termino is null);";	
$database->setquery($sql_1);$database->query();
$cod_1 = $database->listObjects();
$texto1="$tipo_check - Count To Fix ".count($cod_1);		 
$sql_2=" select h.* from tbl_lms_reportes h where h.modalidadcurso='1' and round(h.avance)='100' and (h.fecha_termino='0000-00-00' or h.fecha_termino is null);";
$database->setquery($sql_2);    $database->query();    $cod_2 = $database->listObjects();	
foreach ($cod_2 as $unico){
$sql_2_1="select max(fecha) as max from tbl_objetos_finalizados where rut='".$unico->rut."' and id_curso='".$unico->id_curso."'";
$database->setquery($sql_2_1);    $database->query();    $cod_2_1 = $database->listObjects();	 	

$sqlUpdate_1_1 = "	update tbl_lms_reportes set fecha_termino='". $cod_2_1[0]->max."'
where  rut='".$unico->rut."' and id_curso='".$unico->id_curso."' ";
//echo "<h1>$sqlUpdate_1_1</h1><br>";
$database->setquery($sqlUpdate_1_1);	$database->query();    			

}
$sql_1=" select h.* from tbl_lms_reportes h where h.modalidadcurso='1' and round(h.avance)='100' and (h.fecha_termino='0000-00-00' or h.fecha_termino is null);";
$database->setquery($sql_1);    $database->query();    $cod_1 = $database->listObjects();  $sql_1=str_replace("'",'"',$sql_1);
$texto1="$tipo_check - Count Not Fixed  ".count($cod_1)." ".$sql_1;



//$sql_2="select h.*,(select count(id) from tbl_objeto where id_curso=h.id_curso and tipo_objeto='5' and (cm='' or cm is null) ) as numEvaluaciones from tbl_lms_reportes h  where (select count(id) from tbl_objeto where id_curso=h.id_curso and tipo_objeto='5' and (cm='' or cm is null) )='0' group by h.id_curso";
$database->setquery($sql_2);    $database->query();    $cod_2 = $database->listObjects();	
foreach ($cod_2 as $unico){

$sqlUpdate_1_1 = "	update tbl_lms_reportes set resultado='-'
where  id_curso='".$unico->id_curso."' ";
// echo "<div>$sqlUpdate_1_1</div><br>";
$database->setquery($sqlUpdate_1_1);	$database->query();    			

}

//$sql_2="select h.* from tbl_lms_reportes h where h.avance='100' and h.resultado='-' and h.estado='REPROBADO'";
$database->setquery($sql_2);    $database->query();    $cod_2 = $database->listObjects();	
foreach ($cod_2 as $unico){

$sqlUpdate_1_1 = "	update tbl_lms_reportes set estado='APROBADO'
where  id_curso='".$unico->id_curso."' and rut='".$unico->rut."'";
//echo "<div>$sqlUpdate_1_1</div><br>";
$database->setquery($sqlUpdate_1_1);	$database->query();    			

}

//exit();
//echo "<br>Cuenta Casos Cron $cuenta_casos_cron";


}
function reportes_online_lms_reporte($id_curso, $rut){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select fecha_inicio, fecha_termino, avance, resultado, estado from tbl_lms_reportes where id_curso='".$id_curso."' and rut='".$rut."' ";
//echo "<br>sql $sql";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	


}
function reportes_onlines_usuarios_detalle_agrupaciones($row_query_curso){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_reportes_online_cursos_usuarios_detalle where id>0 and ($row_query_curso) group by rut";


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;		


}
function reportes_onlines_usuarios_detalle_agrupaciones_groupbyC1($row_query_curso){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.*, (select c1 from tbl_reportes_online_usuario where rut=h.rut) as c1 
from tbl_reportes_online_cursos_usuarios_detalle h where h.id>0 and ($row_query_curso) 
and (select c1 from tbl_reportes_online_usuario where rut=h.rut)<>''

group by (select c1 from tbl_reportes_online_usuario where rut=h.rut)

";
//echo $sql;exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;		


}
function reportes_online_usuariosInscritosOnline($id_curso, $c1){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT
h.*, (
SELECT
c1
FROM
tbl_reportes_online_usuario
WHERE
rut = h.rut
) AS c1,
(select avance from tbl_lms_reportes where rut=h.rut and id_curso=h.id_curso) as avance
FROM
tbl_reportes_online_cursos_usuarios_detalle h
WHERE
h.id > 0
AND (
h.id_curso = '$id_curso'
)
AND (
SELECT
c1
FROM
tbl_reportes_online_usuario
WHERE
rut = h.rut
) = '$c1'
GROUP BY
h.rut 

";

$sql="

SELECT
h.*,r.avance,r.estado
FROM
tbl_reportes_online_cursos_usuarios_detalle h
left join tbl_lms_reportes r on r.rut=h.rut  
WHERE	h.id > 0 AND 	h.id_curso = '$id_curso'
and r.id_curso=h.id_curso
AND (
SELECT
c1
FROM
tbl_reportes_online_usuario
WHERE
rut = h.rut
) = '$c1'
GROUP BY
h.rut;   	
";

//echo "<br>".$sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;		


}
function reportes_online_busca_programas_dado_idCurso($id_curso){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_reportes_online_curso where id_curso='".$id_curso."' and inactivo='0'  ";
//echo "<br>sql<br>$sql<br>";
//exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	


}
function reportes_online_lista_usuarios_data(){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select rut from tbl_reportes_online_usuario ";
//echo "<br>sql $sql";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	
}
function reportes_online_lista_cursos_programa_data($id_empresa, $tipo_groupby){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if($tipo_groupby=="Curso"){
$sql = "select id_curso as id, curso as nombre from tbl_reportes_online_curso where curso<>'' and inactivo='0' group by id_curso  order by curso ";
} 
if($tipo_groupby=="CursoFull"){
$sql = "
select h.id, h.nombre, 
(select nombre_programa from tbl_lms_programas_bbdd where id_programa=h.id_programa_global) as programa 
from tbl_lms_curso h 
where  h.nombre<>'' and h.inactivo='0' 
order by (select nombre_programa from tbl_lms_programas_bbdd where id_programa=h.id_programa_global) ASC, h.nombre ASC   		
";
}    
if($tipo_groupby=="Programa"){
$sql = "select h.id_programa as id, h.programa as nombre, 
(select id_empresa from tbl_lms_programas_bbdd where id_programa=h.id_programa)
from tbl_reportes_online_curso h where h.programa<>'' and inactivo='0'
and (select id_empresa from tbl_lms_programas_bbdd where id_programa=h.id_programa)='".$_SESSION["id_empresa"]."' group by h.id_programa order by h.programa ";
} 
if($tipo_groupby=="ProgramaDetalle"){
$sql = "select h.id_programa as id, h.programa as nombre, 
(select id_empresa from tbl_lms_programas_bbdd where id_programa=h.id_programa)
from tbl_reportes_online_curso h where h.programa<>'' and inactivo='0'
and (select id_empresa from tbl_lms_programas_bbdd where id_programa=h.id_programa)='".$_SESSION["id_empresa"]."' group by h.id_programa order by h.programa ";
}   
if($tipo_groupby=="Agrupaciones"){
$sql = "select h.* from tbl_reportes_online_agrupaciones h group by h.id_agrupacion";
}     
//	echo "<br>sql $sql";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	

}


function reportes_online_ListaCursoDadoIdAgrupacion($id_agrupacion){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql="
select h.*,
(select nombre from tbl_lms_curso where id=h.id_curso limit 1) as nombre_curso
from tbl_reportes_online_agrupaciones h where h.id_agrupacion='$id_agrupacion'

";
//echo "<br>Data<br>reportes_online_ListaCursoDadoIdAgrupacion<br>".$sql."<br>";		 exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;		
}
function reportes_online_maxAgrupacion(){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select max(id_agrupacion) as idMax from tbl_reportes_online_agrupaciones";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
$idMax=$cod[0]->idMax+1;
return $idMax;	

}
function reportes_online_c1_c2_c3_c4($id_empresa){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);	

$sql_2="	select h.campo1,h.campo2,h.campo3,h.campo4  from tbl_empresa h where h.id='".$id_empresa."'	";
$database->setquery($sql_2);
$database->query();
$cod_2 = $database->listObjects();  	

$campos[1]=$cod_2[0]->campo1;
$campos[2]=$cod_2[0]->campo2;
$campos[3]=$cod_2[0]->campo3;
$campos[4]=$cod_2[0]->campo4;

return $campos;

}
function reportes_online_curso_dado_idcurso($id_curso){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
//$sql = "select h.*, (select numero_horas from tbl_lms_curso where id=h.id_curso) as numero_horas from tbl_reportes_online_curso h where h.id_curso='".$id_curso."' ";
$sql = "select h.* from tbl_reportes_online_curso h where h.id_curso='".$id_curso."' ";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}
function reportes_online_curso_dado_idcurso_lms_curso($id_curso){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
//$sql = "select h.*, (select numero_horas from tbl_lms_curso where id=h.id_curso) as numero_horas from tbl_reportes_online_curso h where h.id_curso='".$id_curso."' ";
$sql = "select h.*, (select nombre_programa from tbl_lms_programas_bbdd where id_programa=h.id_programa_global) as programa from tbl_lms_curso h where h.id='".$id_curso."' ";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}
function reportes_online_curso_dado_idcursorut($id_curso,$rut){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_reportes_online_cursos_usuarios_detalle where id_curso='".$id_curso."' and rut='".$rut."' ";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}
function reportes_online_curso_rel_lms_malla_curso($id_curso){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);	
$sql=" select h.id as id_curso, h.nombre as curso, h.id_programa_global as id_programa, 
(select nombre_programa from tbl_lms_programas_bbdd where id_programa=h.id_programa_global) as programa 
from tbl_lms_curso h where h.id='$id_curso';";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;

}

function reportes_online_curso_dado_idcurso_lmsCurso($id_curso, $id_programa){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.nombre as curso, (select nombre_programa from tbl_lms_programas_bbdd where id_programa='$id_programa') as programa from tbl_lms_curso h where h.id='$id_curso' ";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function reportes_online_inscripcion_dado_idcurso_rut($rut,$id_curso){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from rel_lms_rut_id_curso_id_inscripcion
where id_curso='".$id_curso."' and rut='".$rut."' 
order by fecha_inicio_inscripcion DESC 
limit 1";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}
function reportes_online_curso_dado_programa($id_programa){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_reportes_online_curso where id_programa='".$id_programa."' ";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}
function reportes_online_usuario_rut($rut){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_reportes_online_usuario where rut='".$rut."' ";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;		
}
function reportes_online_usuario_rut_idCurso_lmsReportes($rut, $id_curso){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_lms_reportes where rut='".$rut."' and id_curso='".$id_curso."' ";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;		
}
function reportes_online_lms_reportes_dado_id_agrupacion($id_agrupacion){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.* from tbl_reportes_online_agrupaciones h where h.id_agrupacion='".$id_agrupacion."' limit 1";
//echo $sql;   	exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;		
}
function reportes_online_lms_reportes_dado_id_curso($id_curso){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.* from tbl_lms_reportes h where h.id_curso='".$id_curso."' 
".$_SESSION["c1h"]." 
".$_SESSION["c2h"]." 
".$_SESSION["c3h"]." 
".$_SESSION["c4h"]." 
";



$sql = "select h.* from tbl_lms_reportes h where h.id_curso='".$id_curso."' 
".utf8_decode($_SESSION["c1h"])." 
".utf8_decode($_SESSION["c2h"])." 
".utf8_decode($_SESSION["c3h"])." 
".utf8_decode($_SESSION["c4h"])." 

and h.rut<>'12121212'
and h.rut<>'13131313'
and h.rut<>'14141414'
and h.rut<>'12345'

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();



return $cod;		
}
function reportes_online_lms_reportes_dado_rut($rut){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.*

from tbl_lms_reportes h 

where h.rut='".$rut."' ";

//echo $sql;   	exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;		
}
function reportes_online_lms_reportes_dado_completo(){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$query_op_rc_anos="";
$query_op_rc_programa="";
$query_op_rc_gerencia="";

if($_SESSION["op_rc_anos"]<>"")			{	$query_op_rc_anos			=" and YEAR(h.fecha_inscripcion)='".$_SESSION["op_rc_anos"]."' ";}
if($_SESSION["op_rc_programa"]<>"")	{	$query_op_rc_programa	=" and h.id_programa='".$_SESSION["op_rc_programa"]."' ";}
if($_SESSION["op_rc_gerencia"]<>"")	{	$query_op_rc_gerencia	=" and (select c1 from tbl_reportes_online_usuario where rut=h.rut)='".utf8_decode($_SESSION["op_rc_gerencia"])."' ";}


$sql = "select h.*, YEAR(h.fecha_inscripcion) as year  from tbl_lms_reportes h where h.id>0
".$_SESSION["c1h"]." 
".$_SESSION["c2h"]." 
".$_SESSION["c3h"]." 
".$_SESSION["c4h"]." 
and h.rut<>''

".$query_op_rc_anos." 
".$query_op_rc_programa." 
".$query_op_rc_gerencia." 

";
//echo $sql;   	exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	



$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;		
}
function reportes_online_lms_reportes_dado_completo_or_id_course($id_courses){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$sql = "select h.* from tbl_lms_reportes h where h.id>0
and $id_courses
".$_SESSION["c1h"]." 
".$_SESSION["c2h"]." 
".$_SESSION["c3h"]." 
".$_SESSION["c4h"]." 
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	

}
function reportes_online_Malla_dado_id_curso_rut_programa($rut, $id_curso, $id_programa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "

select h.id_malla from tbl_inscripcion_usuarios h where h.id_curso='$id_curso' and h.rut='$rut'
and id_empresa='".$_SESSION["id_empresa"]."'

limit 1

";

//echo "<br>reportes_online_Malla_dado_id_curso_rut_programa<br>".$sql."<br>";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod[0]->id_malla;	


}
function reportes_online_nombremalla($id_malla){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "

select h.nombre from tbl_lms_malla h where h.id='$id_malla'
limit 1

";

//echo "<br>reportes_online_nombremalla<br>".$sql."<br>";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod[0]->nombre;		
}
function reportes_online_lms_reportes_dado_id_programa($id_programa){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "

select h.rut, h.id_curso, round(avg(h.avance)) as avance,
if(h.resultado='-','',round(avg(h.resultado))) as resultado,
h.estado,
(select inactivo from tbl_reportes_online_curso where id_curso=h.id_curso and id_programa=h.id_programa) as inactivo

from tbl_lms_reportes h where h.id_programa='".$id_programa."'
and (select inactivo from tbl_reportes_online_curso where id_curso=h.id_curso and id_programa=h.id_programa)='0'

".$_SESSION["c1h"]." 
".$_SESSION["c2h"]." 
".$_SESSION["c3h"]." 
".$_SESSION["c4h"]." 

group by h.rut, h.id_curso

order by h.rut


";
// limit 10
// and h.curso_opcional='0'	
//echo "<br><br>SQL ".$sql."<br><br>";exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;		
}
function reportes_online_lms_reportes_consolidado_dado_id_programa($id_programa){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "

select h.*

from tbl_reportes_online_cursos_usuarios_detalle h where h.id_programa='$id_programa'
and curso_opcional='0'
".$_SESSION["c1h"]." 
".$_SESSION["c2h"]." 
".$_SESSION["c3h"]." 
".$_SESSION["c4h"]." 

order by h.rut;

";
// limit 10
// and h.curso_opcional='0'	
// echo "<br><br>SQL ".$sql."<br><br>";
//and (rut='10000562' or rut='10008138' or rut='10009974')

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;		
}
function reportes_online_lms_reportes_consolidado_cuenta_cursos_dado_id_programa($id_programa, $rut){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "

select count(h.id) as cuenta_cursos_max

from tbl_reportes_online_cursos_usuarios_detalle h 
where h.id_programa='$id_programa'
and curso_opcional='0'
and rut='$rut'

";
// limit 10
// and h.curso_opcional='0'	
// echo "<br><br>SQL ".$sql."<br><br>";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod[0]->cuenta_cursos_max;		
}
function reportes_online_lms_reportes_consolidado_fechas_dado_id_programa($tipo_fecha, $tipoMinMax, $id_programa, $rut, $tipoProgCurso){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "

select $tipoMinMax($tipo_fecha) as fecha

from tbl_lms_reportes where 
rut='".$rut."' and $tipoProgCurso='".$id_programa."' and $tipo_fecha<>'0000-00-00'

";
// limit 10
// and h.curso_opcional='0'	
//echo "<br><br>SQL ".$sql."<br><br>";  

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod[0]->fecha;		
}
function reportes_online_lms_reportes_busca_avance_resultado_dado_rut_id_curso($rut, $id_curso){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "

select h.rut, h.id_curso, round(avg(h.avance)) as avance,
if(h.resultado='-','-',round(avg(h.resultado))) as resultado,
h.fecha_inicio,
h.fecha_termino,
(select inactivo from tbl_reportes_online_curso where id_curso=h.id_curso and id_programa=h.id_programa) as inactivo

from tbl_lms_reportes h where 
h.rut='".$rut."' and h.id_curso='".$id_curso."'


and (select inactivo from tbl_reportes_online_curso where id_curso=h.id_curso and id_programa=h.id_programa)='0'

";
// limit 10
// and h.curso_opcional='0'	
//echo "<br><br>SQL ".$sql."<br><br>";
//EXIT();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;		
}

//**reportes_online**


function Beneficios_DeleteIdEmpresa99($id_novigente){


global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "update tbl_beneficios_formularios_respuestas set id_empresa='99' where id='".$id_novigente."'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;		


}

function Beneficios_Estadisticas_data(){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_beneficios where id_empresa<>'99'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	


}

function ActualizaUpdateControlDotacionRut($rut,$regimen_nuevo,$motivo_nuevo,$fecha_inicio,$fecha_termino){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
update tbl_contingencia_2021 
set regimen='$regimen_nuevo', motivo='$motivo_nuevo',
fecha_inicio='$fecha_inicio', fecha_termino='$fecha_termino'
where num_rut='$rut' ";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	



}

function ControlDotacion2021_data(){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select count(id) as cuenta from tbl_contingencia_2021 where fecha_inicio<>'0000-00-00' ";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod[0]->cuenta;	


}

function ControlDotacion2021_Options_Select_Regimen_Motivo_data(){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.regimen_actual, h.motivo_actual from tbl_contingencia_2021_option h group by h.regimen_actual, h.motivo_actual ";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	


}

function ControlDotacion2021_cero_data(){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select count(id) as cuenta from tbl_contingencia_2021 where fecha_inicio='0000-00-00' ";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod[0]->cuenta;	


}
function ControlDotacionUpdateDia_data($rut, $fecha, $regimen, $motivo){


global $c_host, $c_user, $c_pass, $c_db;
// echo "$c_host, $c_user, $c_pass, $c_db;";
$database = new database($c_host, $c_user, $c_pass);

$regimen=utf8_decode($regimen);
$motivo=utf8_decode($motivo);
$database->setDb($c_db);
$sql="update tbl_contingencia_2021_dia 
set regimen='$regimen', motivo='$motivo'   
where rut='$rut'
and fecha='$fecha'";
$database->setquery($sql);
$database->query();	

//echo $sql;


}

function ControlDotacionUpdateDia_RangoFecha_data($rut, $fecha, $fecha_hasta, $regimen, $motivo){

$regimen=utf8_decode($regimen);
$motivo=utf8_decode($motivo);

global $c_host, $c_user, $c_pass, $c_db;
// echo "$c_host, $c_user, $c_pass, $c_db;";
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

//echo "<br>Fecha $fecha Fecha Hasta $fecha_hasta<br>";

$begin = new DateTime($fecha);
$end = new DateTime($fecha_hasta);

$interval = DateInterval::createFromDateString('1 day');
$period = new DatePeriod($begin, $interval, $end);

foreach ($period as $dt) {
$fecha_update=$dt->format("Y-m-d");
//echo "<br>--->fecha_update  ".$fecha_update;
$sql="update tbl_contingencia_2021_dia set regimen='$regimen', motivo='$motivo'   
where rut='$rut'and fecha='$fecha_update'";
$database->setquery($sql);    $database->query();	


}

//echo "<br>--->fecha_update  ".;


$sql="update tbl_contingencia_2021_dia set regimen='$regimen', motivo='$motivo'   
where rut='$rut'and fecha='$fecha_hasta'";
$database->setquery($sql);    $database->query();	
//		echo $sql;					exit();








}

function usuarios_update_tbl_contingencia_dia_dia_2021_data($rut, $fecha, $regimen, $motivo){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql="
update tbl_contingencia_2021_dia 
set regimen='$regimen', motivo='$motivo'   
where rut='$rut'
and fecha='$fecha'
";



$database->setquery($sql);
$database->query();
echo $sql;
}

function Beneficios_Estadisticas_idItemsEnc_($id_ben_enc){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select count(id) as cuenta
from tbl_log_sistema_historicos
where ambiente='home_beneficios_vista_tabla' and `variables_get` LIKE '%".$id_ben_enc."%'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod[0]->cuenta;	


}

function fill_contingencia_tbl_cron_sillas_data(){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$hoy = date("Y-m-d");

$sql="
select h.rut, (select num_rut from tbl_contingencia_2021 where num_rut=h.rut) as contigencia_2021
from tbl_usuario h 
where h.nombre_empresa_holding<>''
and (select num_rut from tbl_contingencia_2021 where num_rut=h.rut) is NULL";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
foreach ($cod as $unico){

//echo "<br>Unico Rut ".$unico->rut;

$sql2 = "
INSERT INTO tbl_contingencia_2021 (num_rut)
VALUES ('".$unico->rut."')";

$database->setquery($sql2);
$database->query();

}


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	


}

function cron_tbl_cron_sillas_data(){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$hoy = date("Y-m-d");
$sql = "
INSERT INTO tbl_cron_sillas (fecha,subida_usuarios)
VALUES ('$hoy','1')";

$database->setquery($sql);
$database->query();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	


}

function  SILLAS_TraigoTrasladosRealizados() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_sillas_solicitudes where tipo_solicitud='Traslado' and estado='aprobado'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}


function SILLA_TraeDatoDeSillaDadoNumero($numero) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select tbl_sillas.rut, numero, nombre_completo  
from tbl_sillas 
inner join tbl_usuario on tbl_usuario.rut=tbl_sillas.rut 
where numero='$numero'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}


function  SILLA_DataTemporalDadoSillaTraigoRegistros($numero) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select tbl_sillas_temporal_data.* from tbl_sillas_temporal_data where numero = '$numero' and tipo='Insertado Correctamente'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
} 

function  SILLA_DataTemporalDadoID($id) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select tbl_sillas_temporal_data.* from tbl_sillas_temporal_data where id = '$id'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
} 


function  Silla_TrasladoActualizaCuiCargoDeSillaConRut($silla, $cui, $cargo, $rut) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$datos_organizacionales=SillasTraeDetalleDadoCui($cui);
$descripcion_cargo=SillasTraeDetalleDeCargoDeTablaSilla($cargo);

//$sql = "update tbl_sillas set cui='$cui', cargo='$cargo' where   numero='$silla' ";
$sql = "
update 
tbl_sillas 
set cui='$cui', 
cargo='$cargo', 
rut='$rut', 
descripcion_cui='".$datos_organizacionales[0]->descripcion_cui."', 
division='".$datos_organizacionales[0]->division."', 
descripcion_division='".$datos_organizacionales[0]->descripcion_division."', 
area='".$datos_organizacionales[0]->area."', 
descripcion_area='".$datos_organizacionales[0]->descripcion_area."', 
departamento='".$datos_organizacionales[0]->departamento."', 
descripcion_departamento='".$datos_organizacionales[0]->descripcion_departamento."', 
zona='".$datos_organizacionales[0]->zona."', 
descripcion_zona='".$datos_organizacionales[0]->descripcion_zona."', 
seccion='".$datos_organizacionales[0]->seccion."', 

descripcion_seccion='".$datos_organizacionales[0]->descripcion_seccion."', 
oficina='".$datos_organizacionales[0]->oficina."', 
descripcion_oficina='".$datos_organizacionales[0]->descripcion_oficina."', 
descripcion_cargo='".$descripcion_cargo[0]->descripcion_cargo."'





where   numero='$silla' ";


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}


function InsertaNuevoNumeroSilla($numero) {


global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$sql = "
INSERT INTO tbl_sillas_numero_sobredotacion (numero)
VALUES ('$numero')";

$database->setquery($sql);
$database->query();

}

function  Silla_TrasladoActualizaCuiCargoDeSilla($silla, $cui, $cargo) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$datos_organizacionales=SillasTraeDetalleDadoCui($cui);
$descripcion_cargo=SillasTraeDetalleDeCargoDeTablaSilla($cargo);

//$sql = "update tbl_sillas set cui='$cui', cargo='$cargo' where   numero='$silla' ";
$sql = "
update 
tbl_sillas 
set cui='$cui', 
cargo='$cargo', 
rut=null, 
descripcion_cui='".$datos_organizacionales[0]->descripcion_cui."', 
division='".$datos_organizacionales[0]->division."', 
descripcion_division='".$datos_organizacionales[0]->descripcion_division."', 
area='".$datos_organizacionales[0]->area."', 
descripcion_area='".$datos_organizacionales[0]->descripcion_area."', 
departamento='".$datos_organizacionales[0]->departamento."', 
descripcion_departamento='".$datos_organizacionales[0]->descripcion_departamento."', 
zona='".$datos_organizacionales[0]->zona."', 
descripcion_zona='".$datos_organizacionales[0]->descripcion_zona."', 
seccion='".$datos_organizacionales[0]->seccion."', 

descripcion_seccion='".$datos_organizacionales[0]->descripcion_seccion."', 
oficina='".$datos_organizacionales[0]->oficina."', 
descripcion_oficina='".$datos_organizacionales[0]->descripcion_oficina."', 
descripcion_cargo='".$descripcion_cargo[0]->descripcion_cargo."'





where   numero='$silla' ";


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}


function  SILLA_CambiaEstadoSillaOKTemporal($id_registro) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "update tbl_sillas_temporal_data set estado='OK' where   id='$id_registro' ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

}

function Sillas_ConsultaDataTemporalSobrecupo($rut){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$sql="select * from  tbl_sillas_temporal_data where rut='$rut' and tipo like '%Registro No Insertado%' and estado is null";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;


}
function Sillas_ConsultaDataTemporal($rut, $silla){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$sql="select * from  tbl_sillas_temporal_data where rut='$rut' and numero='$silla' and estado is null";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;


}


function Beneficios_CheckDatosPersonas_Admin($rut){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$sql="select email_particular from  tbl_usuario_cel_email where rut='$rut'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod[0]->email_particular;	


}


function UpdateVestuarioEstadosMasivos($rut_col, $estado_masivo){



global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$hoy=date("Y-m-d");
if($estado_masivo=="Despachado"){ $set=" set estado='Despachado', despachado='1', fecha_despachado='$hoy'";}
if($estado_masivo=="En Confeccion"){ $set=" set estado='En Confeccion',  enconfeccion='1', fechaenconfeccion='$hoy'";}

$sql="update tbl_vestuario_usuario_talla $set  where rut='$rut_col' and (estado is null or estado='En Confeccion' or estado='' or estado='Despachado') ";
$database->setquery($sql);
$database->query();	



}


function lista_uniformes_v2_validacion_data($FechaDesde, $FechaHasta, $segmento, $id_empresa) {

//echo "<br>lista_beneficios_validacion_data id cat $idcategoria, $id_empresa, id form $id_form, fi $fecha_inicio, ft $fecha_termino, estado $estado<br>";

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if($segmento<>""){
$QueryFI =" and (
SELECT
segmento
FROM
tbl_vestuario_prenda
WHERE
id = h.id_prenda
) like '%$segmento%' ";
} else {
$QueryFI =" ";
}

if($FechaDesde<>""){
$QFD="  and fecha>='$FechaDesde' ";
}
if($FechaHasta<>""){
$QFH="  and fecha>='$FechaHasta' ";
}	

$sql = "

select h.*,
(
SELECT
prenda
FROM
tbl_vestuario_prenda
WHERE
id = h.id_prenda
) AS prenda,

(
SELECT
segmento
FROM
tbl_vestuario_prenda
WHERE
id = h.id_prenda
) AS segmento_prenda,
(
SELECT
temporada
FROM
tbl_vestuario_prenda
WHERE
id = h.id_prenda
) AS temporada_prenda,
(
SELECT
maternal

FROM
tbl_vestuario_prenda
WHERE
id = h.id_prenda
) AS maternal_prenda


from tbl_vestuario_usuario_talla h 		
WHERE h.id>0

$QFD 
$QFH

$QueryFI";





//echo $sql; exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function lista_uniformes_v3_validacion_GroupbyRutdata($FechaDesde, $FechaHasta, $segmento, $id_empresa) {

//echo "<br>lista_beneficios_validacion_data id cat $idcategoria, $id_empresa, id form $id_form, fi $fecha_inicio, ft $fecha_termino, estado $estado<br>";

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if($segmento<>""){
$QueryFI =" and (
SELECT
segmento
FROM
tbl_vestuario_prenda
WHERE
id = h.id_prenda
) like '%$segmento%' ";
} else {
$QueryFI =" ";
}

if($FechaDesde<>""){
$QFD="  and fecha>='$FechaDesde' ";
}
if($FechaHasta<>""){
$QFH="  and fecha>='$FechaHasta' ";
}	

$sql = "

select h.*,
(
SELECT
prenda
FROM
tbl_vestuario_prenda
WHERE
id = h.id_prenda
) AS prenda,

(
SELECT
segmento
FROM
tbl_vestuario_prenda
WHERE
id = h.id_prenda
) AS segmento_prenda,
(
SELECT
temporada
FROM
tbl_vestuario_prenda
WHERE
id = h.id_prenda
) AS temporada_prenda,
(
SELECT
maternal

FROM
tbl_vestuario_prenda
WHERE
id = h.id_prenda
) AS maternal_prenda


from tbl_vestuario_usuario_talla h 		
WHERE h.id>0
and  h.validacion='1'

$QFD 
$QFH

$QueryFI

group by h.rut
";





//echo $sql; exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function lista_uniformes_v4_PorRutvalidacion_data($FechaDesde, $FechaHasta, $segmento, $id_empresa, $rut) {

//echo "<br>lista_beneficios_validacion_data id cat $idcategoria, $id_empresa, id form $id_form, fi $fecha_inicio, ft $fecha_termino, estado $estado<br>";

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if($segmento<>""){
$QueryFI =" and (
SELECT
segmento
FROM
tbl_vestuario_prenda
WHERE
id = h.id_prenda
) like '%$segmento%' ";
} else {
$QueryFI =" ";
}

if($FechaDesde<>""){
$QFD="  and fecha>='$FechaDesde' ";
}
if($FechaHasta<>""){
$QFH="  and fecha>='$FechaHasta' ";
}	

$sql = "

select h.*,
(
SELECT
prenda
FROM
tbl_vestuario_prenda
WHERE
id = h.id_prenda
) AS prenda,

(
SELECT
segmento
FROM
tbl_vestuario_prenda
WHERE
id = h.id_prenda
) AS segmento_prenda,
(
SELECT
temporada
FROM
tbl_vestuario_prenda
WHERE
id = h.id_prenda
) AS temporada_prenda,
(
SELECT
maternal

FROM
tbl_vestuario_prenda
WHERE
id = h.id_prenda
) AS maternal_prenda


from tbl_vestuario_usuario_talla h 		
WHERE h.id>0
and h.rut='".$rut."'

$QFD 
$QFH

$QueryFI";





//echo $sql; exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function lista_uniformes_v4_PorRutvalidacion_porlinea_data($FechaDesde, $FechaHasta, $segmento, $id_empresa, $rut, $like, $limit) {

//echo "<br>lista_beneficios_validacion_data id cat $idcategoria, $id_empresa, id form $id_form, fi $fecha_inicio, ft $fecha_termino, estado $estado<br>";

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if($segmento<>""){
$QueryFI =" and (
SELECT
segmento
FROM
tbl_vestuario_prenda
WHERE
id = h.id_prenda
) like '%$segmento%' ";
} else {
$QueryFI =" ";
}

if($FechaDesde<>""){
$QFD="  and fecha>='$FechaDesde' ";
}
if($FechaHasta<>""){
$QFH="  and fecha>='$FechaHasta' ";
}	

$sql = "

select h.*,
(
SELECT
prenda
FROM
tbl_vestuario_prenda
WHERE
id = h.id_prenda
) AS prenda,

(
SELECT
segmento
FROM
tbl_vestuario_prenda
WHERE
id = h.id_prenda
) AS segmento_prenda,
(
SELECT
temporada
FROM
tbl_vestuario_prenda
WHERE
id = h.id_prenda
) AS temporada_prenda,
(
SELECT
maternal

FROM
tbl_vestuario_prenda
WHERE
id = h.id_prenda
) AS maternal_prenda


from tbl_vestuario_usuario_talla h 		
WHERE h.id>0
and h.rut='".$rut."'

$QFD 
$QFH

$QueryFI
and ( SELECT prenda FROM tbl_vestuario_prenda WHERE id = h.id_prenda ) like '".$like."%'


";





//echo $sql."<br>"; 

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Uniformes_BarridoSolicitudes($rut, $id_empresa){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select h.* 
from tbl_vestuario_usuario_talla h 		
where rut='$rut' 
";

//echo "<br>$sql";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function Check2020_Reportes_IdProgramaNull_data($id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);



$sql="

select h.* ,
(select vigencia_descripcion from tbl_usuario where rut=h.rut  order by id DESC limit 1) as Vigencia,
(select vigencia from tbl_usuario where rut=h.rut  order by id DESC limit 1) as VigenciaRut,
(select estado from tbl_lms_reportes where rut=h.rut and id_curso=h.id_curso  order by id DESC limit 1) as EstadoReportes

from tbl_inscripcion_usuarios h 

where h.id_curso<>''
and h.id_malla<>'bch_histor'
and h.id_empresa='$id_empresa'

and (
(select vigencia_descripcion from tbl_usuario where rut=h.rut  order by id DESC limit 1)='' or

(select vigencia_descripcion from tbl_usuario where rut=h.rut  order by id DESC limit 1 ) is NULL
)

and (select estado from tbl_lms_reportes where rut=h.rut and id_curso=h.id_curso  order by id DESC limit 1) is NULL

order by (select vigencia from tbl_usuario where rut=h.rut) 
;

";

//$database->setquery($sql);
$database->query();
$cod = $database->listObjects();


/*ini_set('output_buffering', 0);
ini_set('zlib.output_compression', 0);
if( !ob_get_level() ){ ob_start(); }
else { ob_end_clean(); ob_start(); }*/


foreach ($cod as $unico)
{
//echo "<br>id_programa Id ".$unico->id.",".$unico->rut.",".$unico->id_curso.",".$unico->IdMalla.",".$unico->IdPrograma.",".$unico->IdClasificacion.",".$unico->IdFoco."<br>";

/*$cuenta_loop++;
// echo "<center><span style='position: absolute;z-index:$current;background:#36C6D3; padding:10px; color:#FFF'>Procesando $cuenta_loop</span></center>";
flush();
ob_flush();*/


$sql11 = "insert into tbl_lms_reportes (rut, id_curso, id_malla, id_empresa)
VALUES ('".$unico->rut."', '".$unico->id_curso."', '".$unico->id_malla."', '".$unico->id_empresa."')";
//echo "<br>$sql1"; 
$database->setquery($sql11);
$database->query();
}






$sql = "
select h.*, 
(select id_malla from tbl_inscripcion_usuarios where rut=h.rut and id_curso=h.id_curso order by id DESC limit 1) as IdMalla,

(select id_programa from rel_lms_malla_curso where id_curso=h.id_curso and id_malla=(select id_malla from tbl_inscripcion_usuarios where rut=h.rut and id_curso=h.id_curso order by id DESC limit 1) order by id DESC limit 1) as IdPrograma,
(select id_clasificacion from rel_lms_malla_curso where id_curso=h.id_curso and id_malla=(select id_malla from tbl_inscripcion_usuarios where rut=h.rut and id_curso=h.id_curso order by id DESC limit 1) order by id DESC limit 1) as IdClasificacion,
(select id_foco from rel_lms_malla_curso where id_curso=h.id_curso and id_malla=(select id_malla from tbl_inscripcion_usuarios where rut=h.rut and id_curso=h.id_curso order by id DESC limit 1) order by id DESC limit 1) as IdFoco

from tbl_lms_reportes h where (id_programa is null or id_programa='')
and (select id from rel_lms_malla_curso where id_curso=h.id_curso and id_malla=h.id_malla) is not null

;

";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

/*ini_set('output_buffering', 0);
ini_set('zlib.output_compression', 0);
if( !ob_get_level() ){ ob_start(); }
else { ob_end_clean(); ob_start(); }  */
$cuenta_loop=0; 
foreach ($cod as $unico)
{
//echo "<br>id_programa Id ".$unico->id.",".$unico->rut.",".$unico->id_curso.",".$unico->IdMalla.",".$unico->IdPrograma.",".$unico->IdClasificacion.",".$unico->IdFoco."<br>";

$cuenta_loop++;
// echo "<center><span style='position: absolute;z-index:$current;background:#36C6D3; padding:10px; color:#FFF'>Procesando $cuenta_loop</span></center>";
/*  flush();
ob_flush(); */

$sql1 = "update tbl_lms_reportes 
set 
id_malla='".$unico->IdMalla."', 
id_foco='".$unico->IdFoco."', 
id_clasificacion='".$unico->IdClasificacion."', 
id_programa='".$unico->IdPrograma."'

where   id='".$unico->id."'";
//echo "<br>$sql1"; 
$database->setquery($sql1);
$database->query();
}

//estados nulos


$sql3 = "
select h.*


from tbl_lms_reportes h where (estado is null or estado='');

";
$database->setquery($sql3);
$database->query();
$cod3 = $database->listObjects();   

/*ini_set('output_buffering', 0);
ini_set('zlib.output_compression', 0);
if( !ob_get_level() ){ ob_start(); }
else { ob_end_clean(); ob_start(); }  */

$cuenta_loop=0;     

foreach ($cod3 as $unico)
{
//echo "<br>Estado Id ".$unico->id.",".$unico->rut.",".$unico->id_curso.",".$unico->avance.",".$unico->estado."<br>";
//$cuenta_loop++;
// echo "<center><span style='position: absolute;z-index:$current;background:#36C6D3; padding:10px; color:#FFF'>Procesando $cuenta_loop</span></center>";
/* 	flush();
ob_flush();*/

if($unico->avance=="0"){
$estado="NO_INICIADO";
}

if($unico->avance<100 and $unico->avance>0){
$estado="EN_PROCESO";
}


$sql4 = "update tbl_lms_reportes 
set 
estado='".$estado."'

where   id='".$unico->id."'";
//echo "<br>$sql4"; 
$database->setquery($sql4);
$database->query();
}    

//id_modalidad


$sql7 = "
select h.*,
(select modalidad from tbl_lms_curso where id=h.id_curso) as modalidad


from tbl_lms_reportes h where (modalidadcurso is null or modalidadcurso='')



";
$database->setquery($sql7);
$database->query();
$cod7 = $database->listObjects();   

/*ini_set('output_buffering', 0);
ini_set('zlib.output_compression', 0);
if( !ob_get_level() ){ ob_start(); }
else { ob_end_clean(); ob_start(); }  */
$cuenta_loop=0;     

foreach ($cod7 as $unico)
{

$cuenta_loop++;
// echo "<center><span style='position: absolute;z-index:$current;background:#36C6D3; padding:10px; color:#FFF'>Procesando $cuenta_loop</span></center>";
/* flush();
ob_flush(); */
// echo "<br>modalidadcurso Id ".$unico->id.",".$unico->rut.",".$unico->id_curso.",".$unico->modalidadcurso.",".$unico->modalidad."<br>";

$sql8 = "update tbl_lms_reportes 
set 
modalidadcurso='".$unico->modalidad."'

where   id='".$unico->id."'";
//echo "<br>$sql8"; 

$database->setquery($sql8);
$database->query();
}  



$sql11 = "select h.*

from tbl_lms_reportes h 

where h.avance>0 and h.avance<100 and h.estado<>'EN_PROCESO'";

$database->setquery($sql11);
$database->query();
$cod11 = $database->listObjects();   
/*ini_set('output_buffering', 0);
ini_set('zlib.output_compression', 0);
if( !ob_get_level() ){ ob_start(); }
else { ob_end_clean(); ob_start(); }  */
$cuenta_loop=0;      
foreach ($cod11 as $unico)
{
$cuenta_loop++;
// echo "<center><span style='position: absolute;z-index:$current;background:#36C6D3; padding:10px; color:#FFF'>Procesando $cuenta_loop</span></center>";
/* flush();
ob_flush();  	*/
$sql12 = "update tbl_lms_reportes 
set 
estado='EN_PROCESO'

where   id='".$unico->id."'";
//echo "<br>$sql8"; 

$database->setquery($sql12);
$database->query(); 	

}


$sql13 = "


select h.*,
(select nota_aprobacion from tbl_objeto  where id_curso=h.id_curso and nota_aprobacion>0 limit 1) as NotaAprob,
ROUND((select avg(nota) from tbl_objetos_finalizados where rut=h.rut and id_curso=h.id_curso and nota>0)) as NotaProm

from tbl_lms_reportes h 

where h.avance='100' and h.estado='APROBADO' 

AND h.resultado<(select nota_aprobacion from tbl_objeto  where id_curso=h.id_curso and nota_aprobacion>0 limit 1) 

and (select nota_aprobacion from tbl_objeto  where id_curso=h.id_curso and nota_aprobacion>0 limit 1)>0
order by h.resultado

";

$database->setquery($sql13);
$database->query();
$cod13 = $database->listObjects();   
/*ini_set('output_buffering', 0);
ini_set('zlib.output_compression', 0);
if( !ob_get_level() ){ ob_start(); }
else { ob_end_clean(); ob_start(); }  */
$cuenta_loop=0;         
foreach ($cod13 as $unico)
{

$cuenta_loop++;
//echo "<center><span style='position: absolute;z-index:$current;background:#36C6D3; padding:10px; color:#FFF'>Procesando $cuenta_loop</span></center>";
/*   flush();
ob_flush();  */
if($unico->NotaProm>=$unico->NotaAprob){
$estado="APROBADO";
} else {
$estado="REPROBADO";
}

if($unico->NotaProm>$unico->resultado){
$resultado=$unico->NotaProm;
} else {
$resultado=$unico->resultado;
}

$sql14 = "update tbl_lms_reportes 
set 
resultado='".$resultado."',
estado='".$estado."'


where   id='".$unico->id."'";
//echo "<br>$sql8"; 

$database->setquery($sql14);
$database->query(); 	

} 


$sql9 = "select h.*

from tbl_lms_reportes h 

where h.avance='100' and h.estado='REPROBADO' AND h.resultado>=80 ";

$database->setquery($sql9);
$database->query();
$cod9 = $database->listObjects();   
/*ini_set('output_buffering', 0);
ini_set('zlib.output_compression', 0);
if( !ob_get_level() ){ ob_start(); }
else { ob_end_clean(); ob_start(); }  */
$cuenta_loop=0;          
foreach ($cod9 as $unico)
{
$cuenta_loop++;

//echo "<center><span style='position: absolute;z-index:$current;background:#36C6D3; padding:10px; color:#FFF'>Procesando $cuenta_loop</span></center>";
/*flush();
ob_flush();  */

$sql10 = "update tbl_lms_reportes 
set 
estado='APROBADO'

where   id='".$unico->id."'";
//echo "<br>$sql8"; 

$database->setquery($sql10);
$database->query(); 	

}




$sql15 = "


select h.*,
(select nota_aprobacion from tbl_objeto  where id_curso=h.id_curso and nota_aprobacion>0 limit 1) as NotaAprob,
ROUND((select avg(nota) from tbl_objetos_finalizados where rut=h.rut and id_curso=h.id_curso and nota>0)) as NotaProm

from tbl_lms_reportes h 

where h.avance='100' and h.estado='EN_PROCESO' 

";

$database->setquery($sql15);
$database->query();
$cod15 = $database->listObjects();   
/*ini_set('output_buffering', 0);
ini_set('zlib.output_compression', 0);
if( !ob_get_level() ){ ob_start(); }
else { ob_end_clean(); ob_start(); }  */
$cuenta_loop=0;          
foreach ($cod15 as $unico)
{
$cuenta_loop++;

//echo "<center><span style='position: absolute;z-index:$current;background:#36C6D3; padding:10px; color:#FFF'>Procesando $cuenta_loop</span></center>";
/*flush();
ob_flush();  */

if($unico->NotaAprob==""){

$sql16 = "update tbl_lms_reportes 
set 
estado='APROBADO'

where   id='".$unico->id."'";
//echo "<br>$sql8"; 

$database->setquery($sql16);
$database->query(); 	

}

if($unico->NotaAprob>0 and $unico->NotaProm>=$unico->NotaAprob){

$sql16 = "update tbl_lms_reportes 
set 
estado='APROBADO'

where   id='".$unico->id."'";
//echo "<br>$sql8"; 

$database->setquery($sql16);
$database->query(); 	

}

}

// sql 17

$sql_17=
"select h.*, 

ROUND((select nota from tbl_inscripcion_cierre where rut=h.rut and id_curso=h.id_curso and id_empresa='$id_empresa' order by nota DESC limit 1)) as nota,
ROUND((select avg(nota) from tbl_objetos_finalizados where rut=h.rut and id_curso=h.id_curso and nota<>'')) as avg_obj_finalizados,
ROUND((select nota_aprobacion from tbl_objeto  where id_curso=h.id_curso and nota_aprobacion>0 limit 1)) as NotaAprob

from tbl_lms_reportes h where h.estado='REPROBADO'

and 

ROUND((select nota from tbl_inscripcion_cierre where rut=h.rut and id_curso=h.id_curso and id_empresa='78' order by nota DESC limit 1))>=ROUND((select nota_aprobacion from tbl_objeto  where id_curso=h.id_curso and nota_aprobacion>0 limit 1)) 

";

$database->setquery($sql_17);
$database->query();
$cod17 = $database->listObjects();   

foreach ($cod17 as $unico)
{

$sql18 = "update tbl_lms_reportes 
set 
estado='APROBADO',
resultado='".$unico->nota."' 
where   id='".$unico->id."'";
//echo "<br>$sql8"; 

$database->setquery($sql18);
$database->query(); 	    	


}


$sql_18=
"SELECT h.*, (select id from rel_lms_malla_curso where id_curso=h.id_curso and id_malla=h.id_malla) as RelMallaCurso FROM tbl_lms_reportes h 
WHERE  (select id from rel_lms_malla_curso where id_curso=h.id_curso and id_malla=h.id_malla) is NULL
and h.curso_opcional='0'
";

//echo $sql_18;

$database->setquery($sql_18);
$database->query();
$cod18 = $database->listObjects();   

foreach ($cod18 as $unico)
{

$sql19 = "update tbl_lms_reportes 
set 
id_malla='".$unico->id_malla."_bk_hist'

where   id='".$unico->id."'";
//echo "<br>$sql19"; 

$database->setquery($sql19);
$database->query(); 	    	


}
// exit();
return $cod;

}


function lista_chileactivo_inscripcion_validacion_data($idcategoria, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select h.*, 'Inscripcin' as tipo from tbl_chileactivo_inscripcion h 
where h.fecha is not null 
and h.id_empresa='78'
union 
select j.*, 'Desinscripcin' as tipo from 

tbl_chileactivo_deinscripcion j 
where j.fecha is not null 
and j.id_empresa='78'


";

// echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Chileactivo_dd_BuscaId($id_beneficio){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select h.* ,
(select nombre from tbl_chileactivo where id_beneficios=h.id_beneficio) as beneficio

from tbl_beneficios_formularios_respuestas h 

where  h.id='$id_beneficio'
";

//echo "<br>$sql";
//exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function Beneficios_BuscaId($id_beneficio){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select h.* ,
(select nombre from tbl_beneficios where id_beneficios=h.id_beneficio) as beneficio

from tbl_beneficios_formularios_respuestas h 

where  h.id='$id_beneficio'
";

//echo "<br>$sql";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function UsuarioAdminRutEmpresa2020($rut){


global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.* from tbl_admin h where h.user='$rut'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	

}
function lista_chileactivo_desinscripcion_data($idcategoria, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.*, 
(select nombre from tbl_chileactivo where id_beneficios='$idcategoria') as beneficio,
(select tipo_workflow from tbl_chileactivo where id_beneficios='$idcategoria') as tipo_workflow,
(select id_form1 from tbl_chileactivo where id_beneficios='$idcategoria') as id_form1,
(select id_form2 from tbl_chileactivo where id_beneficios='$idcategoria') as id_form2

from tbl_beneficios_formularios_respuestas h

where validacion1='Desinscripcion' and h.id_beneficio='$idcategoria' order by id DESC";

//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function lista_chileactivo_validacion_data($idcategoria, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.*, 
(select nombre from tbl_chileactivo where id_beneficios='$idcategoria') as beneficio,
(select tipo_workflow from tbl_chileactivo where id_beneficios='$idcategoria') as tipo_workflow,
(select id_form1 from tbl_chileactivo where id_beneficios='$idcategoria') as id_form1,
(select id_form2 from tbl_chileactivo where id_beneficios='$idcategoria') as id_form2

from tbl_beneficios_formularios_respuestas h

where h.id_empresa='$id_empresa' and h.id_beneficio='$idcategoria' order by id DESC";

//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function ActualizaEstadoPrendaRut($id,$estado){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$hoy=date("Y-m-d");

if($estado=="En Confeccion"){
$jquer1= ", enconfeccion='1', fechaenconfeccion='".$hoy."'";
}

if($estado=="Despachado"){
$jquer2= ", despachado='1', fecha_despachado='".$hoy."'";
}


$sql="update tbl_vestuario_usuario_talla set estado='$estado' $jquer1 $jquer2

where id='$id'";
$database->setquery($sql);
$database->query();

}
function lista_uniformes_validacion_data($rut, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

SELECT
h.*,
(
SELECT
prenda
FROM
tbl_vestuario_prenda
WHERE
id = h.id_prenda
) AS prenda,

(
SELECT
segmento
FROM
tbl_vestuario_prenda
WHERE
id = h.id_prenda
) AS segmento_prenda,
(
SELECT
temporada
FROM
tbl_vestuario_prenda
WHERE
id = h.id_prenda
) AS temporada_prenda
FROM
tbl_vestuario_usuario_talla h
WHERE
h.validacion = '1'
and h.rut='$rut'


";

//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Beneficios_Agenda_2020_VistaEvento($idr){

global $c_host, $c_user, $c_pass, $c_db;
$database  = new database($c_host, $c_user, $c_pass);
//h.rut_col='$rut' and
$sql="	select h.*, 
(select nombre from tbl_beneficios_agenda where id=h.id_agenda) as agenda,
(select nombre from tbl_beneficios_especialistas where rut=h.id_especialista) as especialista,
(select email from tbl_beneficios_especialistas where rut=h.id_especialista) as email_especialista

from tbl_beneficios_eventos h where h.id='$idr'";
// echo "<br>sql<br>$sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;


}
function lista_beneficios_agendamiento_data($idcategoria, $id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.* from tbl_beneficios_eventos h where h.ocupada<>'' order by h.fecha_inicio DESC, h.hora_inicio DESC";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	
}

function lista_beneficios_agendamiento_SinShowdata($idcategoria, $id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.* from tbl_beneficios_eventos h where h.ocupada<>'' and h.id_agenda<>'2000' order by h.fecha_inicio DESC, h.hora_inicio DESC";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	
}

function lista_tbl_usuario_cel_email($id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.* from tbl_usuario_cel_email h";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	
}

function lista_beneficios_agendamiento_ConShowdata($idcategoria, $id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.* from tbl_beneficios_eventos h where h.ocupada<>'' and h.id_agenda='2000' order by h.fecha_inicio DESC, h.hora_inicio DESC";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	
}


function lista_beneficios_agendamiento_v2_data($idcategoria, $id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.* from tbl_beneficios_eventos h where h.ocupada<>'' 
order by h.fecha_inicio DESC, h.hora_inicio DESC";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	
}

function BuscaCamposSegunForm($id_form, $campo){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select $campo  as id_campo from tbl_beneficios_formularios where id='$id_form'";
// echo "<br>Sql $sql";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

$id_campo=$cod[0]->id_campo;

$sql = "select nombre as campo from tbl_beneficios_formularios_campos where id='$id_campo'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

//print_r($cod);
//exit();

return utf8_encode($cod[0]->campo);

}
function Beneficios_Busca_Estado($id, $tipo_workflow){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);	

$sql="select * from tbl_beneficios_formularios_respuestas where id='".$id."'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

//print_r($cod);
$estado="<span class='badge badge-gray'>Pendiente</span>";
//echo "<br>tipo_workflow $tipo_workflow";

if($tipo_workflow=="1003"){

if($cod[0]->validacion1=="Validado" ){
$estado="<span class='badge badge-success'>Validado</span>";	
}

elseif($cod[0]->validacion1=="Rechazado_edicion" ){
$estado="<span class='badge badge-warning'>Rechazado_edicion</span>";	
}

elseif($cod[0]->validacion1=="Rechazado" ){
$estado="<span class='badge badge-danger'>Rechazado</span>";	
} 

else {
$estado="<span class='badge badge-gray'>Pendiente</span>";	
}

}




$estado="<br>".$estado;

return $estado;
}

function Becas_Update_2022_eliminar($id){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql="update tbl_becas set id_empresa='99'  where id='$id'";
$database->setquery($sql);
$database->query();


}



function RFBeneficiosBecasVisto($id){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql="update tbl_beneficios_formularios_respuestas set visto='1'  where id='$id'";
$database->setquery($sql);
$database->query();


}
function dataFullForm_nombre($id_form){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select nombre from tbl_beneficios_formularios h where h.id='$id_form'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod[0]->nombre;	
}
function Beneficios_BarridoSolicitudes($id_beneficio, $id_empresa){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select h.* 

from tbl_beneficios_formularios_respuestas h 

where id_empresa='$id_empresa' and id_beneficio='$id_beneficio'
";

//echo "<br>$sql";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lista_solicitudes_uniformes_data($id_empresa, $segmento) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select h.*,

(select segmento from tbl_vestuario_prenda where id=h.id_prenda) as segmento_prenda,
(select temporada from tbl_vestuario_prenda where id=h.id_prenda) as temporada_prenda

from tbl_vestuario_usuario_talla h where h.validacion='1'
and (select segmento from tbl_vestuario_prenda where id=h.id_prenda) like '%".$segmento."%'
group by h.rut

";


//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lista_solicitudes_chileactivo_data($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select h.*,

(select count(id) from tbl_beneficios_formularios_respuestas where id_empresa=h.id_empresa and id_beneficio=h.id_beneficios) as solicitudes,
(select count(id) from tbl_beneficios_formularios_respuestas where id_empresa=h.id_empresa and id_beneficio=h.id_beneficios and validacion1<>'') as validacion1,
(select count(id) from tbl_beneficios_formularios_respuestas where id_empresa=h.id_empresa and id_beneficio=h.id_beneficios and validacion2<>'') as validacion2,
(select count(id) from tbl_beneficios_formularios_respuestas where id_empresa=h.id_empresa and id_beneficio=h.id_beneficios and validacion3<>'') as validacion3,
(select count(id) from tbl_beneficios_formularios_respuestas where id_empresa=h.id_empresa and id_beneficio=h.id_beneficios and validacion4<>'') as validacion4,
(select count(id) from tbl_beneficios_formularios_respuestas where id_empresa=h.id_empresa and id_beneficio=h.id_beneficios and validacion5<>'') as validacion5,
(select count(id) from tbl_beneficios_formularios_respuestas where id_empresa=h.id_empresa and id_beneficio=h.id_beneficios and visto=1) as visto,
(select nombre from tbl_beneficios_workflow where id=h.tipo_workflow) as nombre_tipo_workflow

from tbl_chileactivo h where h.id_empresa='$id_empresa'  
and h.tipo_workflow<>''
and h.id_categoria<>'bch_ton'
order by h.nombre

";



$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lista_solicitudes_chileactivo_data_v2($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select h.*,

(select count(id) from tbl_beneficios_formularios_respuestas where id_empresa=h.id_empresa and id_beneficio=h.id_beneficios) as solicitudes,
(select count(id) from tbl_beneficios_formularios_respuestas where id_empresa=h.id_empresa and id_beneficio=h.id_beneficios and validacion1<>'') as validacion1,
(select count(id) from tbl_beneficios_formularios_respuestas where id_empresa=h.id_empresa and id_beneficio=h.id_beneficios and validacion2<>'') as validacion2,
(select count(id) from tbl_beneficios_formularios_respuestas where id_empresa=h.id_empresa and id_beneficio=h.id_beneficios and validacion3<>'') as validacion3,
(select count(id) from tbl_beneficios_formularios_respuestas where id_empresa=h.id_empresa and id_beneficio=h.id_beneficios and validacion4<>'') as validacion4,
(select count(id) from tbl_beneficios_formularios_respuestas where id_empresa=h.id_empresa and id_beneficio=h.id_beneficios and validacion5<>'') as validacion5,
(select count(id) from tbl_beneficios_formularios_respuestas where id_empresa=h.id_empresa and id_beneficio=h.id_beneficios and visto=1) as visto,
(select nombre from tbl_beneficios_workflow where id=h.tipo_workflow) as nombre_tipo_workflow

from tbl_chileactivo h where h.id_empresa='$id_empresa'  
and h.tipo_workflow<>''
and h.id_categoria='bch_ton'
order by h.nombre

";

echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lista_solicitudes_chileactivo_data_v3($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select h.*,

(select count(id) from tbl_beneficios_formularios_respuestas where id_beneficio=h.id_beneficios and validacion1='Desinscripcion') as desinscripciones

from tbl_chileactivo h where h.id_empresa='$id_empresa'  
and h.tipo_workflow<>''
AND h.id_categoria = 'bch_ton' or h.id_categoria <>'bch_ton' 
order by h.nombre

";

//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function Beneficios_Busca_Estado_Solo_Data($id, $tipo_workflow){

//echo "<br>$id, $tipo_workflow";
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);	

$sql="select * from tbl_beneficios_formularios_respuestas where id='".$id."'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

//print_r($cod);
$estado="Pendiente";
//echo "<br>tipo_workflow $tipo_workflow";

if($tipo_workflow=="1003"){

if($cod[0]->validacion1=="Rechazado_edicion" or  $cod[0]->validacion1=="Rechazado" ){
$estado="En Proceso";	
}

if($cod[0]->validacion1=="Validado"){
$estado="Cerrado";	
}

}


if($tipo_workflow=="1008"){

if($cod[0]->validacion1=="Rechazado_edicion" or  $cod[0]->validacion1=="Rechazado"  or $cod[0]->validacion1=="NoGanador"){
$estado="En Proceso";	
}

if( $cod[0]->validacion1=="Ganador"){
$estado="Cerrado";	
}

}



return $estado;
}

function Beneficios_SaveValidacion($id, $validacion, $comentarios, $val){

//echo "Beneficios_SaveValidacion($id, $validacion, $comentarios, $val";
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);		
$hoy = date("Y-m-d");
$comentarios=utf8_decode($comentarios);
if($val=="validacion1"){
$sql="update tbl_beneficios_formularios_respuestas set validacion1='$validacion', fechavalidacion1='$hoy', comentarios_validacion='$comentarios' where id='$id'";
$database->setquery($sql);    $database->query();		
}

if($val=="validacion2"){
$sql="update tbl_beneficios_formularios_respuestas set validacion2='$validacion', fechavalidacion2='$hoy', comentarios_validacion='$comentarios' where id='$id'";
$database->setquery($sql);    $database->query();		
}

if($val=="validacion3"){
$sql="update tbl_beneficios_formularios_respuestas set validacion3='$validacion', fechavalidacion3='$hoy' , comentarios_validacion='$comentarios' where id='$id'";
$database->setquery($sql);    $database->query();		
}

if($val=="validacion4"){
$sql="update tbl_beneficios_formularios_respuestas set validacion4='$validacion', fechavalidacion4='$hoy', comentarios_validacion='$comentarios' where id='$id'";
$database->setquery($sql);    $database->query();		
}


}
function BeneficiosBuscaNombreCampoIdCampo($campo, $id_form1){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);	
//echo "<br>$campo, $id_form1";

$sql	= "select $campo as id_campo from tbl_beneficios_formularios where id='$id_form1'";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//print_r($cod);

$sql2="select nombre from tbl_beneficios_formularios_campos where id='".$cod[0]->id_campo."'";
//echo "$sql2";
$database->setquery($sql2);
$database->query();
$cod2 = $database->listObjects();
//print_r($cod2);


return $cod2[0]->nombre;


}


function lista_beneficios_data_form($id_empresa, $id_form) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select h.*,

(select count(id) from tbl_beneficios_formularios_respuestas where id_empresa=h.id_empresa and id_beneficio=h.id_beneficios and id_form=h.$id_form) as solicitudes,
(select count(id) from tbl_beneficios_formularios_respuestas where id_empresa=h.id_empresa and id_beneficio=h.id_beneficios and validacion1<>'' and id_form=h.$id_form) as validacion1,
(select count(id) from tbl_beneficios_formularios_respuestas where id_empresa=h.id_empresa and id_beneficio=h.id_beneficios and validacion2<>'' and id_form=h.$id_form) as validacion2,
(select count(id) from tbl_beneficios_formularios_respuestas where id_empresa=h.id_empresa and id_beneficio=h.id_beneficios and validacion3<>'' and id_form=h.$id_form) as validacion3,
(select count(id) from tbl_beneficios_formularios_respuestas where id_empresa=h.id_empresa and id_beneficio=h.id_beneficios and validacion4<>'' and id_form=h.$id_form) as validacion4,
(select count(id) from tbl_beneficios_formularios_respuestas where id_empresa=h.id_empresa and id_beneficio=h.id_beneficios and validacion5<>'' and id_form=h.$id_form) as validacion5,
(select count(id) from tbl_beneficios_formularios_respuestas where id_empresa=h.id_empresa and id_beneficio=h.id_beneficios and visto=1 and id_form=h.$id_form) as visto,		
(select nombre from tbl_beneficios_workflow where id=h.tipo_workflow) as nombre_tipo_workflow,
(select nombre from tbl_beneficios_formularios where id=h.$id_form) as nombre_formulario,
(select id from tbl_beneficios_formularios where id=h.$id_form) as id_formulario
from tbl_beneficios h where h.id_empresa='$id_empresa'  
and h.tipo_workflow<>''
and h.$id_form<>''
order by h.nombre
";

//echo "<br><br>$sql<br><br>";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lista_beneficios_historicos_data_form($id_empresa, $id_form) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select h.*,

(select count(id) from tbl_beneficios_formularios_respuestas_historicos where id_empresa=h.id_empresa and id_beneficio=h.id_beneficios and id_form=h.$id_form) as solicitudes,
(select count(id) from tbl_beneficios_formularios_respuestas_historicos where id_empresa=h.id_empresa and id_beneficio=h.id_beneficios and validacion1<>'' and id_form=h.$id_form) as validacion1,
(select count(id) from tbl_beneficios_formularios_respuestas_historicos where id_empresa=h.id_empresa and id_beneficio=h.id_beneficios and validacion2<>'' and id_form=h.$id_form) as validacion2,
(select count(id) from tbl_beneficios_formularios_respuestas_historicos where id_empresa=h.id_empresa and id_beneficio=h.id_beneficios and validacion3<>'' and id_form=h.$id_form) as validacion3,
(select count(id) from tbl_beneficios_formularios_respuestas_historicos where id_empresa=h.id_empresa and id_beneficio=h.id_beneficios and validacion4<>'' and id_form=h.$id_form) as validacion4,
(select count(id) from tbl_beneficios_formularios_respuestas_historicos where id_empresa=h.id_empresa and id_beneficio=h.id_beneficios and validacion5<>'' and id_form=h.$id_form) as validacion5,
(select count(id) from tbl_beneficios_formularios_respuestas_historicos where id_empresa=h.id_empresa and id_beneficio=h.id_beneficios and visto=1 and id_form=h.$id_form) as visto,		
(select nombre from tbl_beneficios_workflow where id=h.tipo_workflow) as nombre_tipo_workflow,
(select nombre from tbl_beneficios_formularios where id=h.$id_form) as nombre_formulario,
(select id from tbl_beneficios_formularios where id=h.$id_form) as id_formulario
from tbl_beneficios h where h.id_empresa='$id_empresa'  
and h.tipo_workflow<>''
and h.$id_form<>''
order by h.nombre
";

//echo "<br><br>$sql<br><br>";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lista_beneficios_data_fichas_sociales_form($id_empresa, $id_form) {


global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

SELECT
h.*, (
SELECT
count(id)
FROM
tbl_beneficios_formularios_respuestas_ficha
WHERE
id_empresa = h.id_empresa
AND id_form = h.id

) AS solicitudes,
(
SELECT
count(id)
FROM
tbl_beneficios_formularios_respuestas_ficha
WHERE
id_empresa = h.id_empresa
AND id_form = h.id
AND validacion1 <> ''

) AS validacion1,
(
SELECT
count(id)
FROM
tbl_beneficios_formularios_respuestas_ficha
WHERE
id_empresa = h.id_empresa
AND id_form = h.id
AND validacion2 <> ''

) AS validacion2,
(
SELECT
count(id)
FROM
tbl_beneficios_formularios_respuestas_ficha
WHERE
id_empresa = h.id_empresa
AND id_form = h.id
AND validacion3 <> ''

) AS validacion3,
(
SELECT
count(id)
FROM
tbl_beneficios_formularios_respuestas_ficha
WHERE
id_empresa = h.id_empresa
AND id_form = h.id
AND validacion4 <> ''

) AS validacion4,
(
SELECT
count(id)
FROM
tbl_beneficios_formularios_respuestas_ficha
WHERE
id_empresa = h.id_empresa
AND id_form = h.id
AND validacion5 <> ''

) AS validacion5,
(
SELECT
count(id)
FROM
tbl_beneficios_formularios_respuestas_ficha
WHERE
id_empresa = h.id_empresa
AND id_form = h.id
AND visto = 1

) AS visto
FROM
tbl_beneficios_formularios h
WHERE
h.id_empresa = '78'
AND h.descripcion = 'Ficha_Beneficios'
ORDER BY
h.nombre
";

//echo "<br><br>$sql<br><br>";
//exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DeleteNotificacionesPendientesCargosNoPermitidos(){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "
select h.*

from tbl_notificaciones_pendientes h

";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();


ini_set('output_buffering', 0);
ini_set('zlib.output_compression', 0);
if( !ob_get_level() ){ ob_start(); }
else { ob_end_clean(); ob_start(); }

$fila=count($cod);

foreach ($cod as $unico)
{	

$Usu						= TraeDatosUsuario($unico->rut);		

$l++;
echo "<center><span style='position: absolute;z-index:$current;background:#36C6D3; padding:10px; color:#FFF'>Registro Colaborador $l de $fila</span></center>";
flush();	ob_flush();			 	

$sql_update="";
if($unico->rut=="9851837"){

$sql_update="update tbl_notificaciones_pendientes set id_empresa='99' where rut=".$unico->rut."";
$database->setquery($sql_update);
$database->query();
// echo "-a-";

}

if($Usu[0]->id_cargo=="9997" 
or $Usu[0]->id_cargo=="6097" 
or $Usu[0]->id_cargo=="8208" 
or $Usu[0]->id_cargo=="6462" 
or $Usu[0]->id_cargo=="7060" 
or $Usu[0]->id_cargo=="7287"
or $Usu[0]->id_cargo=="6098" 
or $Usu[0]->id_cargo=="7381" 
or $Usu[0]->id_cargo=="6212" 
or $Usu[0]->id_cargo=="6281"
or $Usu[0]->id_cargo=="6100" 
or $Usu[0]->id_cargo=="6102" 
or $Usu[0]->id_cargo=="8209" 
or $Usu[0]->id_cargo=="7598" 
or $Usu[0]->id_cargo=="7287" 
or $Usu[0]->id_cargo=="7287")
{
$sql_update="update tbl_notificaciones_pendientes set id_empresa='99' where rut=".$unico->rut."";
$database->setquery($sql_update);
$database->query();
//echo "-b-";
}    	

if(	
$Usu[0]->cargo=="Gerente Division Ciberseguridad" or 
$Usu[0]->cargo=="Gerente Division Comercial"  or 
$Usu[0]->cargo=="Gerente Division Contraloria"  or 
$Usu[0]->cargo=="Gerente Division Corporativa"  or 
$Usu[0]->cargo=="Gerente Division Glob. de Cump"  or 
$Usu[0]->cargo=="Gerente Division Marketing y Bca.Digital"  or 
$Usu[0]->cargo=="Gerente Division Neg. Especiales"  or 
$Usu[0]->cargo=="Gerente Division Op y Tecnolog"  or 
$Usu[0]->cargo=="Gerente Division Personas y Organizacion"  or 
$Usu[0]->cargo=="Gerente Division Tesoreria" or  
$Usu[0]->cargo=="Gerente General"  or 
$Usu[0]->cargo=="Fiscal"  or 
$Usu[0]->cargo=="Presidente")
{
$sql_update="update tbl_notificaciones_pendientes set id_empresa='99' where rut=".$unico->rut."";
$database->setquery($sql_update);
$database->query();
//echo "-c-";
}  	

//echo "<br>".$unico->rut." ".$Usu[0]->id_cargo."  ".$Usu[0]->cargo." ".$sql_update;										

}











}


function  CambioEstadoSillaDesdeEgreso($rut) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "update tbl_sillas_temporal_data set numero='0', tipo='Registro No Insertado / No quedan Sillas' where   rut='$rut' and tipo='Insertado Correctamente' ";
//echo $sql;exit;
//echo $sql;echo "<br><br>";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod; 
}




function SillasTraeDetalleDadoCui($codigo_cui) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "SELECT DISTINCT
( cui ),
descripcion_cui,
division,
descripcion_division,
area,
descripcion_area,
departamento,
descripcion_departamento

zona,
descripcion_zona,

seccion,
descripcion_seccion,

oficina,
descripcion_oficina

FROM
tbl_sillas 
WHERE
cui = '$codigo_cui'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}


function SillasTraeDetalleDeCargoDeTablaSilla($codigo_cargo) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select distinct(cargo), descripcion_cargo from tbl_sillas where cargo='$codigo_cargo'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function UpdateLmsReportes2020(){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql= "
SELECT h.* from tbl_lms_reportes h where h.rut_completo is null 
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

$cuenta_lineas=count($cod);


foreach ($cod as $unico){
$Usu						= TraeDatosUsuario($unico->rut);
//echo "<br>Rut ".$unico->rut;

$sql1 = "update tbl_lms_reportes set rut_completo='".$Usu[0]->rut_completo."' where     id='".$unico->id."' ";
$database->setquery($sql1);   $database->query();
//echo "<br>sql1 $sql1";

$relLmsMallaCurso=Updatelms0202_busca_rel_malla_curso($unico->id_curso, $unico->id_malla);

$sql2 = "update tbl_lms_reportes 
set 
id_foco='".$relLmsMallaCurso[0]->id_foco."',
id_clasificacion='".$relLmsMallaCurso[0]->id_clasificacion."',

where     id='".$unico->id."' ";
$database->setquery($sql2);   $database->query();
//echo "<br>sql2 $sql2";


$Array_Fechas=Updatelms2020_sinFecha($unico->rut, $unico->id_curso);
$sql3 = "update tbl_lms_reportes 
set fecha_inicio='".$Array_Fechas[0]->FI."', fecha_termino='".$Array_Fechas[0]->FT."'


where     id='".$unico->id."' ";
$database->setquery($sql3);   $database->query();
//echo "<br>sql3 $sql3";				

$Array_InsUsu=Updatelms0202_busca_Fecha_inscriocion_curso($unico->rut, $unico->id_curso);
$sql4 = "update tbl_lms_reportes 
set fecha_inscripcion='".$Array_InsUsu[0]->fecha."'


where     id='".$unico->id."' ";
$database->setquery($sql4);   $database->query();
//echo "<br>sql4 $sql4";				

}

$sql5="update tbl_lms_reportes h set h.fecha_inicio='0000-00-00' where h.fecha_inicio is null";
$database->setquery($sql5);   $database->query();
$sql6="update tbl_lms_reportes h set h.fecha_termino='0000-00-00' where h.fecha_termino is null";
$database->setquery($sql6);   $database->query();


$sql= "
SELECT h.*   FROM tbl_inscripcion_cierre h WHERE h.nota = '100' AND h.estado_descripcion <> 'Aprobado' AND h.estado = '1' and (select modalidad from tbl_lms_curso where id=h.id_curso)='1'
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

$cuenta_lineas=count($cod);


foreach ($cod as $unico){


$sql7="update tbl_inscripcion_cierre h set h.estado_descripcion='APROBADO' where h.rut='".$unico->rut."' and h.id_curso='".$unico->id_curso."'";
$database->setquery($sql7);   $database->query();

$sql8="update tbl_lms_reportes h set h.estado='APROBADO' where h.rut='".$unico->rut."' and h.id_curso='".$unico->id_curso."'";
$database->setquery($sql8);   $database->query();

$sql9="update tbl_lms_reportes_full h set h.estado='APROBADO' where h.rut='".$unico->rut."' and h.id_curso='".$unico->id_curso."'";
$database->setquery($sql9);   $database->query();





}	

return $cod;
}

function  Updatelms0202_busca_rel_malla_curso($id_curso, $id_malla)
{
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql= "
SELECT h.* from rel_lms_malla_curso h where h.id_curso='$id_curso' and h.id_malla='$id_malla'
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function  Updatelms0202_busca_Fecha_inscriocion_curso($rut, $id_curso)
{
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql= "
SELECT h.fecha from tbl_inscripcion_usuarios h where h.rut='$rut' and h.id_curso='$id_curso' limit 1
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Updatelms2020_sinFecha($rut, $id_curso){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);   
$sql      = " select h.*, 
(select fecha from tbl_objetos_finalizados where rut=h.rut and id_curso=h.id_curso order by fecha ASC limit 1) as FI,  
(select fecha from tbl_objetos_finalizados where rut=h.rut and id_curso=h.id_curso order by fecha DESC limit 1) as FT
from tbl_lms_reportes h 

where h.rut='".$rut."' 

and h.id_curso='".$id_curso."'

";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;    
}

function  lms_integracion_lista_programas_ADMIN($rut, $id_empresa)
{

// echo "<br>lms_integracion_lista_programas_URLTEMA<br>$rut, $id_empresa, $id_programa_bbdd, $opcional, $estado";
global $c_host, $c_user, $c_pass, $c_db;
//echo "$c_host, $c_user, $c_pass, $c_db";
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$sql="select 
h.rut, h.rut_completo, h.nombre as nombre_completo, h.cargo as cargo, h.email as email, h.c1 as division,
h.id_curso, (select nombre from tbl_lms_curso where id=h.id_curso) as curso,
h.id_programa, (select nombre_programa from tbl_lms_programas_bbdd where id_programa=h.id_programa) as programa,
h.avance, h.resultado as nota, 
(select modalidad from tbl_lms_curso where id=h.id_curso) as modalidad,
h.estado as estado,
h.curso_opcional as curso_opcional

from

tbl_lms_reportes h 

WHERE

h.rut = '$rut'
and h.id_programa<>'bch_histor'
and (select modalidad from tbl_lms_curso where id=h.id_curso)='1'

order by h.curso_opcional, (select modalidad from tbl_lms_curso where id=h.id_curso), (SELECT			nombre		FROM			tbl_lms_curso		WHERE			id = h.id_curso	)


";
//echo $sql; exit;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();



//print_r($cod);
return $cod;
}

function  lms_integracion_lista_programas_ADMIN_NoExiste($rut, $id_empresa)
{

// echo "<br>lms_integracion_lista_programas_URLTEMA<br>$rut, $id_empresa, $id_programa_bbdd, $opcional, $estado";
global $c_host, $c_user, $c_pass, $c_db;
//echo "$c_host, $c_user, $c_pass, $c_db";
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$sql="

SELECT
h.rut,
(select rut_completo from tbl_usuario_historicos where rut=h.rut) as rut_completo,
(select nombre_completo from tbl_usuario_historicos where rut=h.rut) AS nombre_completo,
(select cargo from tbl_usuario_historicos where rut=h.rut) AS cargo,
(select email from tbl_usuario_historicos where rut=h.rut) AS email,
(select division from tbl_usuario_historicos where rut=h.rut) AS division,


h.id_curso,
(SELECT	nombre	FROM tbl_lms_curso WHERE id = h.id_curso) AS curso,
h.avance,
h.nota AS nota,
(select modalidad from tbl_lms_curso where id=h.id_curso) as modalidad,
h.estado_descripcion AS estado
FROM
tbl_inscripcion_cierre h
WHERE
h.rut = '$rut' and (select modalidad from tbl_lms_curso where id=h.id_curso)='1'
ORDER BY

(select modalidad from tbl_lms_curso where id=h.id_curso),
(
SELECT
nombre
FROM
tbl_lms_curso
WHERE
id = h.id_curso
)

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

//echo $sql;

//print_r($cod);
return $cod;
}

function Reportes_Express_Programa($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = " select h.id_programa, (select nombre_programa from tbl_lms_programas_bbdd where id_programa=h.id_programa) as programa from tbl_lms_reportes h where h.id_programa<>'' and h.id_programa<>'bch_histor' and (select inactivo from tbl_lms_programas_bbdd where id_programa=h.id_programa) is null and id_empresa='$id_empresa' group by h.id_programa order by (select nombre_programa from tbl_lms_programas_bbdd where id_programa=h.id_programa)  ";

//echo "data Reportes_Express_Programa ".$sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Reportes_Express_Resultado($id_programa, $fecha_inicio, $fecha_termino, $rut_col) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if($fecha_inicio<>""){
$QFI=" and h.fecha_inicio>='$fecha_inicio' ";
} else {
$QFI="  ";
}

if($fecha_termino<>""){
$QFT=" and h.fecha_termino>='$fecha_termino' ";
} else {
$QFT="  ";
} 

if($id_programa<>""){
$QPro=" and h.id_programa='$id_programa'";
} else {
$QPro="";
}

if($rut_col<>""){
$QRUT=" and h.rut='$rut_col'";
} else {
$QRUT="";
}    



$sql = "

select
h.rut,h.rut_completo,h.nombre,h.cargo,h.email,h.c1,h.c2,h.c3,h.c4,h.id_programa,
(select nombre_empresa_holding from tbl_usuario where rut=h.rut) as nombre_empresa_holding,

(SELECT nombre_programa from tbl_lms_programas_bbdd where id_programa=h.id_programa)as programa,
h.id_malla,
(SELECT nombre from tbl_lms_malla where id=h.id_malla) as malla,
h.id_curso,
(SELECT nombre from tbl_lms_curso where id=h.id_curso) as curso,
h.avance as avance_asistencia, h.resultado as resultado_evaluacion, h.fecha_inicio, h.fecha_termino,
IF(h.curso_opcional='0','OBLIGATORIO','OPCIONAL') as curso_opcional,
h.estado,h.fecha_inscripcion,h.jefe,
(select nombre_empresa_holding from tbl_usuario where rut=h.rut) as nombre_empresa_holding,
(select vigencia_descripcion from tbl_usuario where rut=h.rut) as vigencia_descripcion,
(SELECT respuesta from tbl_enc_elearning_respuestas where rut=h.rut and id_curso=h.id_curso and id_pregunta='bch4' limit 1) as Evaluacion_Satistaccion,
(SELECT comentario from tbl_enc_elearning_respuestas where rut=h.rut and id_curso=h.id_curso and id_pregunta='bch4' limit 1) as Comentario_Satisfaccion,
(select fecha_desde from tbl_usuario_ausentismo where rut=h.rut) as fecha_desde,
(select fecha_hasta from tbl_usuario_ausentismo where rut=h.rut) as fecha_hasta,
(select tipo_ausentismo from tbl_usuario_ausentismo where rut=h.rut) as tipo_ausentismo

from tbl_lms_reportes h

WHERE

h.id>0
and 
(
(select vigencia_descripcion from tbl_usuario where rut=h.rut) is null or 
(select vigencia_descripcion from tbl_usuario where rut=h.rut)=''
)
and h.rut<>''
and h.id_programa<>'bch_histor'
$QPro
$QRUT
$QFI
$QFT


";

//echo "data Reportes_Express_Programa ".$sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Reportes_Express_Resultado_v2($id_programa, $fecha_inicio, $fecha_termino, $rut_col) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if($fecha_inicio<>""){
$QFI=" and h.fecha_inicio>='$fecha_inicio' ";
} else {
$QFI="  ";
}

if($fecha_termino<>""){
$QFT=" and h.fecha_termino>='$fecha_termino' ";
} else {
$QFT="  ";
} 

if($id_programa<>""){
$QPro=" and h.id_programa='$id_programa'";
} else {
$QPro="";
}

if($rut_col<>""){
$QRUT=" and h.rut='$rut_col'";
} else {
$QRUT="";
}    



$sql = "

select
h.rut,h.rut_completo,h.nombre,h.cargo,h.email,h.c1,h.c2,h.c3,h.c4,h.id_programa,
(select nombre_empresa_holding from tbl_usuario where rut=h.rut) as nombre_empresa_holding,

(SELECT nombre_programa from tbl_lms_programas_bbdd where id_programa=h.id_programa)as programa,
h.id_malla,
(SELECT nombre from tbl_lms_malla where id=h.id_malla) as malla,
h.id_curso,
(SELECT nombre from tbl_lms_curso where id=h.id_curso) as curso,
h.avance as avance_asistencia, h.resultado as resultado_evaluacion, h.fecha_inicio, h.fecha_termino,
IF(h.curso_opcional='0','OBLIGATORIO','OPCIONAL') as curso_opcional,
h.estado,h.fecha_inscripcion,h.jefe,
(select nombre_empresa_holding from tbl_usuario where rut=h.rut) as nombre_empresa_holding,
(select vigencia_descripcion from tbl_usuario where rut=h.rut) as vigencia_descripcion,
(SELECT respuesta from tbl_enc_elearning_respuestas where rut=h.rut and id_curso=h.id_curso and id_pregunta='bch4' limit 1) as Evaluacion_Satistaccion,
(SELECT comentario from tbl_enc_elearning_respuestas where rut=h.rut and id_curso=h.id_curso and id_pregunta='bch4' limit 1) as Comentario_Satisfaccion,
(select fecha_desde from tbl_usuario_ausentismo where rut=h.rut) as fecha_desde,
(select fecha_hasta from tbl_usuario_ausentismo where rut=h.rut) as fecha_hasta,
(select tipo_ausentismo from tbl_usuario_ausentismo where rut=h.rut) as tipo_ausentismo

from tbl_lms_reportes h

WHERE

h.id>0

and 
(
(select vigencia_descripcion from tbl_usuario where rut=h.rut)='' 
or 
(select vigencia_descripcion from tbl_usuario where rut=h.rut) is null
)

and h.rut<>''
and h.id_programa<>'bch_histor'

$QPro
$QRUT
$QFI
$QFT


";

//echo "data Reportes_Express_Programa ".$sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}


function BecasUpdateDocumentacionTipoRut($rut, $tipo, $archivo) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

//echo "<br>$rut, $tipo, $archivo";


$sql = "update tbl_becas set $tipo='$archivo' where     rut='$rut' ";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

//exit();

return $cod;
}

function Ausentismo_rut($rut){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql      = "select id  from tbl_usuario_ausentismo where rut='$rut' and nro_dias>='30'";
//echo "<br>sql $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod[0]->id;	

}


function Insert_tbl_enc_elearning_medicion($id, $nombre, $descripcion, $id_empresa, $tipo_medicion, $id_encuesta, $footerfinal) {


global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$sql = "
INSERT INTO tbl_enc_elearning_medicion (id, nombre, descripcion, id_empresa, tipo_medicion, id_encuesta, footerfinal)
VALUES ('$id', '$nombre', '$descripcion', '$id_empresa', '$tipo_medicion', '$id_encuesta', '$footerfinal')";

$database->setquery($sql);
$database->query();

}

function Insert_tbl_enc_elearning($id, $nombre, $descripcion,$id_empresa){



global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$sql = "
INSERT INTO tbl_enc_elearning (id, nombre, descripcion,id_empresa)
VALUES ('$id', '$nombre', '$descripcion','$id_empresa')";

$database->setquery($sql);
$database->query();


}

function Insert_tbl_enc_elearning_preg($id_encuesta,$id_pregunta,$pregunta,$id_empresa,$tipo,$dimension,$alt1,$alt2,$alt3,$alt4,$alt5,$alt6,$alt7,$alt8,$alt9,$alt10,$dimension_descripcion,$descripcion_pregunta,$linkpregunta,$linkopcion,$alt11,$alt12,$alt13,$alt14,$alt15,$alt16,$alt17,$alt18,$alt19,$alt20){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$sql = "
INSERT INTO tbl_enc_elearning_preg (id_encuesta,id_pregunta,pregunta,id_empresa,tipo,dimension,alt1,alt2,alt3,alt4,alt5,alt6,alt7,alt8,alt9,alt10,dimension_descripcion,descripcion_pregunta,linkpregunta,linkopcion,alt11,alt12,alt13,alt14,alt15,alt16,alt17,alt18,alt19,alt20)
VALUES ('$id_encuesta','$id_pregunta','$pregunta','$id_empresa','$tipo','$dimension','$alt1','$alt2','$alt3','$alt4','$alt5','$alt6','$alt7','$alt8','$alt9','$alt10','$dimension_descripcion','$descripcion_pregunta','$linkpregunta','$linkopcion','$alt11','$alt12','$alt13','$alt14','$alt15','$alt16','$alt17','$alt18','$alt19','$alt20')";

$database->setquery($sql);
$database->query();

}

function Encuestas_Busca_IdUltimoMasunoDos(){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql      = "select max(id) as maximo from tbl_enc_elearning";
//echo "<br>sql $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
// print_r($cod);
//echo "<h1>a</h1>";
//exit();
//echo "<br>aca";
return $cod;
}
function Amonestacion_Update_Id($accion, $id_amon_full, $tipo_amonestacion, $mensaje){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$database->setquery($sql);
$database->query();

if($accion=="Actualizar"){

$tipo_amonestacion=utf8_decode($tipo_amonestacion);
$mensaje=utf8_decode($mensaje);
//print_r($_SESSION["user_"]);


$sql = "update tbl_reconoce_gracias_full 

set categorita='$tipo_amonestacion', id_categoria='$tipo_amonestacion', mensaje='$mensaje', rut_update='".$_SESSION["user_"]."' where id='$id_amon_full' ";	

}
elseif($accion=="Eliminar"){
$sql = "update tbl_reconoce_gracias_full 

set id_empresa='99', rut_update='".$_SESSION["user_"]."' where id='$id_amon_full' ";

}

$database->setquery($sql);
$database->query();	
//echo "accion $accion, sql $sql"; exit();

}
function Bch_2020_Check_Contigencia_Vulnerable_Admin($rut){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);

$sql      = "select h.status from tbl_contingencia_2020 h where h.rut='$rut' order by h.id DESC limit 1 ";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();


if(utf8_encode($cod[0]->status)=="No Trabajando / Permiso extraordinario , mayores 65 aos, enfermedad riesgo o caso social" or $cod[0]->status=="'No Trabajando / otro motivo'"){
$vulnerable="1";
} else {
$vulnerable	="";
}
if($rut=="7647930"){
// print_r($cod[0]->status);

// echo "Vulnerable $vulnerable";
}



return $vulnerable;

}
function Bch_2020_Check_Area_DeptoAdmin($rut){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$sql      = "select area, departamento from tbl_usuario  where rut='$rut'  ";
//echo "<br>Bch_2020_Check_Area_DeptoCron $sql";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

//echo "<br>aca";
return $cod;

}

function rutesjefe_2020_v2Admin($rut)
{
global $c_host, $c_user, $c_pass, $c_db;

// echo "data basse datos $c_host, $c_user, $c_pass, $c_db";
$database = new database($c_host, $c_user, $c_pass);
//$sql      = "select area, departamento from tbl_usuario  where rut='$rut' ";
$sql      = "select count(id) as cuenta from tbl_usuario where jefe='$rut' ";
// echo "<br>rutesjefe_2020_v2Cron $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
// print_r($cod);
return $cod;
}

function Bch_2020_Perfil_Usuario_ADMIN($rut){

//$id_empresa       = $_SESSION["id_empresa"];
//echo "a";
$esjefe=rutesjefe_2020_v2Admin($rut);
//echo "b";
//print_r($esjefe);


if($esjefe[0]->cuenta >0){
$Jefe="Jefe";
} else {
$Jefe="No Jefe";
}
//echo "<br>Jefe $Jefe";
//Riesgo o vulnerable
//	No Trabajando / otro motivo	No Trabajando / Permiso extraordinario , mayores 65 aos, enfermedad riesgo o caso social
//si el registro de la columna "rut" est en la columna "rut_jefe", es Jefe. En caso contrario es No Jefe.


$EsVulnerable		=	Bch_2020_Check_Contigencia_Vulnerable_Admin($rut);
//print_r($EsVulnerable);


if($EsVulnerable>0){
$subperfil="Vulnerable";
} else {
$arreglo_usu=Bch_2020_Check_Area_DeptoAdmin($rut);

//print_r($arreglo_usu);

if(
$arreglo_usu[0]->area=="Gerencia Sucursales Metropolitana" or 
$arreglo_usu[0]->area=="Gerencia Sucursales Regionales" or 
$arreglo_usu[0]->area=="Gerencia Red Edwards y Bca.Privada" or 

$arreglo_usu[0]->area=="Gerencia Banca Privada" or 
$arreglo_usu[0]->area=="Gerencia Sucursales BCH" or 
$arreglo_usu[0]->area=="Red Sucursales Consumo"
)	
{
$subperfil = "Red";
}

elseif(
$arreglo_usu[0]->departamento=="Subgcia. Banca Telefonica Pers."

)	{
$subperfil = "Contact Center";
}	

else {
$subperfil = "Resto Banco";
}
}

if($rut=="12345"){
$subperfil	="Red";
$Jefe				="Jefe";
}

if($rut=="12888860"){
$subperfil	="Red";
$Jefe				="Jefe";	
}

if($rut=="13403288"){
$subperfil	="Red";
$Jefe				="No Jefe";	
}

$perfil="$subperfil $Jefe";//echo "<br>$perfil";

//echo "<br>rut $rut ";
if($rut=="10008"){
$perfil="Full";
}


if($rut=="10009"){
$perfil="Semi_Full";
}

//Red - Jefe
//Red - No Jefe

//CONTACT CENTER
//cod_depto: hoja contact_center
//6699	Subgcia. Banca Telefonica Pers.	4524	Fonobank Empresas

//Contact Center - Jefe
//Contact Center - No Jefe

// ELSE 
//Resto Banco - Jefe
//Resto Banco - No Jefe

return $perfil;

}

function ReporteFullRespuestas_Cron($fecha_inicial_check){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "	select h.*	from tbl_enc_elearning_respuestas h where h.fecha>='$fecha_inicial_check' and h.nombre is null";

//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();	

foreach ($cod as $unico){

reset($Enc_Res_Fecha);			$Enc_Res_Fecha = array();
reset($Enc_Res_Respuesta);	$Enc_Res_Respuesta = array();
reset($Enc_Res_Comentario);	$Enc_Res_Comentario = array();
reset($Rating);							$Rating = array();
reset($Full);								$Full = array();
reset($RelCurso);						$RelCurso = array();
reset($Ins);								$Ins = array();
reset($Perfil_Usu);					$Perfil_Usu = array();
reset($UsuJ);								$UsuJ = array();
reset($Usu);								$Usu = array();

$Perfil_Usu="";

$Usu						= TraeDatosUsuario($unico->rut);
$UsuJ						= TraeDatosUsuario($Usu[0]->jefe);
$Perfil_Usu			=	Bch_2020_Perfil_Usuario_ADMIN($unico->rut);

//datos_usuario	
$rut						=	$Usu[0]->rut;
$nombre					=	$Usu[0]->nombre_completo;
$perfil					= $Perfil_Usu;
$glosa_cargo		= $Usu[0]->cargo;
$fecha_ingreso	= $Usu[0]->familia_cargo; //fecha indenmizacion
$division				=	$Usu[0]->division;
$area						=	$Usu[0]->area;
$departamento		=	$Usu[0]->departamento;
$zona						=	$Usu[0]->zona;
$seccion				=	$Usu[0]->centro_costo;
$cod_unidad			=	$Usu[0]->local;
$unidad					=	$Usu[0]->unidad_negocio;
$oficina				=	$Usu[0]->servicio;
$region					=	$Usu[0]->regional;
$empresa				=	$Usu[0]->nombre_empresa_holding;
$rut_jefe				= $UsuJ[0]->rut_completo;
$nombre_jefe		= $UsuJ[0]->nombre_completo;


Update_Enc_Elearning_Respuestas_ADMIN($unico->id, $nombre,
$perfil,$glosa_cargo,$fecha_ingreso,$division,$area,
$departamento,$zona,$seccion,	$cod_unidad,$unidad,$oficina,$region,
$empresa,$rut_jefe,$nombre_jefe);		

}	



}

function Update_Enc_Elearning_Respuestas_ADMIN($id, $nombre,
$perfil,$glosa_cargo,$fecha_ingreso,$division,$area,
$departamento,$zona,$seccion,	$cod_unidad,$unidad,$oficina,$region,
$empresa,$rut_jefe,$nombre_jefe){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "update tbl_enc_elearning_respuestas 

set 

nombre='$nombre',
perfil='$perfil',
glosa_cargo='$glosa_cargo',
fecha_ingreso='$fecha_ingreso',
division='$division',
area='$area',
departamento='$departamento',
zona='$zona',
seccion='$seccion',	
cod_unidad='$cod_unidad',
unidad='$unidad',
oficina='$oficina',
region='$region',
empresa='$empresa',
rut_jefe='$rut_jefe',
nombre_jefe='$nombre_jefe'    

where id='$id'; ";
//  echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

//print_r($cod);
return $cod;	

}

function BuscaPreguntasIdPregunta($id_pregunta, $id_encuesta) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_enc_elearning_preg where id_pregunta='$id_pregunta' and id_encuesta='$id_encuesta'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function Lista_Postulable_por_id_full($id_postulable) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select h.*

from tbl_postulables h

where h.id_postulable='$id_postulable' 

";
// echo $sql; 

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}
function DeleteFullTbltbl_usuario_ausentismo() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "DELETE FROM tbl_usuario_ausentismo";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function DeleteFullTbltbl_notificaciones_pendientes() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "DELETE FROM tbl_notificaciones_pendientes";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function DeleteFullTbltbl_escritorio_horas_extras() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "DELETE FROM tbl_escritorio_horas_extras";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function DeleteFullTbltbl_cargas() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "DELETE FROM tbl_beneficios_cargas";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}


function DeleteFulltbl_usuario_licencias_medicas() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "DELETE FROM tbl_usuario_licencias_medicas";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function DeleteFulltbl_mc_metas_pivote() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "DELETE FROM tbl_mc_metas_pivote";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function DeleteFulltbl_mc_carrera_interna() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "DELETE FROM tbl_mc_carrera_interna";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}
function DeleteFulltbl_mc_potencial_relacionados() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "DELETE FROM tbl_mc_potencial_relacionados";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}
function DeleteFulltbl_mc_tramo_desempeno() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "DELETE FROM tbl_mc_tramo_desempeno";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function DeleteFulltbl_mc_bac() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "DELETE FROM tbl_mc_bac";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}
function DeleteFulltbl_mc_poliza() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "DELETE FROM tbl_codigo_poliza";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}



function DeleteFulltbl_contingencia_2021() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "DELETE FROM tbl_contingencia_2021";

$database->setquery($sql);
$database->query();

$sql = "DELETE FROM tbl_contingencia_2021_original";

$database->setquery($sql);
$database->query();    
$cod = $database->listObjects();
return $cod;
}

function DeleteFull_tbl_permiso_temporal() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "DELETE FROM tbl_permiso_temporal";

$database->setquery($sql);
$database->query();


$cod = $database->listObjects();
return $cod;
}

function DeleteFull_tbl_contingencia_ubicacion_colaboradores() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "DELETE FROM tbl_contingencia_ubicacion_colaboradores";

$database->setquery($sql);
$database->query();


$cod = $database->listObjects();
return $cod;
}

function DeleteFull_tbl_contingencia_2021_option() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "DELETE FROM tbl_contingencia_2021_option";

$database->setquery($sql);
$database->query();


$cod = $database->listObjects();
return $cod;
}

function DeleteFull_tbl_contingencia_2021_dia() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "DELETE FROM tbl_contingencia_2021_dia";

$database->setquery($sql);
$database->query();


$cod = $database->listObjects();
return $cod;
}




function DeleteFullTbltbl_usuario_vacaciones() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "DELETE FROM tbl_usuario_vacaciones";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}


function DeleteFullTbltbl_usuario_permisos() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "DELETE FROM tbl_usuario_permisos";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Insert_Lista_ausentismo_data($row) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$sql = "
INSERT INTO tbl_usuario_ausentismo (rut,dv,tipo_ausentismo,nro_dias,fecha_desde,fecha_hasta,description
)
VALUES ($row)";


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();


}


function Insert_Lista_hhee_data($row) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$sql = "
INSERT INTO tbl_escritorio_horas_extras (rut,fecha,minutos_extras,minutos_retro,minutos_informada)
VALUES ($row)";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();


}

function Lista_hhee_data($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_escritorio_horas_extras";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Lista_ausentismo_data($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_usuario_ausentismo";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Lista_cargas_data($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_beneficios_cargas";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Lista_usuario_vacaciones_data($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_usuario_vacaciones";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Lista_usuario_permisos_data($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_usuario_permisos";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Lista_usuario_licencias_medicas_data($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_usuario_licencias_medicas";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}


function Lista_usuario_metaspivote_data($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_mc_metas_pivote";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Lista_tbl_mc_potencial_relacionados_data($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_mc_potencial_relacionados";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}
function Lista_tbl_mc_carrera_interna_data($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_mc_carrera_interna";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}
function Lista_tbl_mc_tramo_desempeno_data($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_mc_tramo_desempeno";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Lista_tbl_mc_bac_data($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_mc_bac";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Lista_tbl_codigo_poliza_data($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_codigo_poliza";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Lista_usuario_cd_data($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_contingencia_2021";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Lista_usuario_cd_Fecha_Limite_data($fecha, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_contingencia_2021 where fecha_termino<'$fecha'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Lista_usuario_cd_Fecha_Limite_Vigentes_data($fecha, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_contingencia_2021 where fecha_termino>='$fecha'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Lista_usuario_cd_Fecha_OrderDesc_limit_1_Limite_data($rut){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "SELECT * FROM tbl_contingencia_2021_dia WHERE rut = '$rut' and regimen<>'' and regimen<>'Ausente' order by id DESC limit 1;";
//echo "<br>".$sql."<br>";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	



}

function Lista_usuario_permiso_unico_data($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_permiso_temporal";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Lista_usuario_ubicacion_colaboradores_data($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_contingencia_ubicacion_colaboradores";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Lista_usuario_tbl_contingencia_2021_dia_data($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_contingencia_2021_dia";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Lista_usuario_tbl_contingencia_2021_option_data($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_contingencia_2021_option";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}



function Lista_usuario_cd_futuro_data($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_contingencia_2021 where regimen_futuro<>''";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Lista_usuario_cd_reporte_por_dia_data($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_contingencia_2021_dia";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}


function Insert_Lista_licencias_medicas_data($row) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$sql = "
INSERT INTO tbl_usuario_licencias_medicas (

num_rut,
nro_lic,
fec_inicio,
fec_termino,
nro_dias,
cod_grupo,
cod_diag,
cod_tipo_lic,
cod_recup,
tipo_reposo,
horario_reposo_parcial,
cod_lugar_recup,
direcc_reposo,
rut_med,
fec_emision,
fec_digit,
rut_digit,
isapr_codig,
unida_cuipr,
region,
cod_sucursal,
fec_rec_rrhh,
FTE_LLMM,
Licencia_Maternal_parental

)
VALUES ($row)";


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();


}

function Insert_Lista_metas_pivote_data($row) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$sql = "

INSERT INTO tbl_mc_metas_pivote (

rut_completo,
rut,
dv,
nombres,
tipo_metas,
descripcion_objetivo,
criterio_medida,
ponderacion,
ponderacion_ajustada,
grado_cumplimiento,
bloqueada,
clasificacion,
ponderacion_matriz_individual,
creacion_metas_100,
lineamiento_estrategico,
cumplimiento_90,
cumplimiento_130

)
VALUES ($row)";



$database->setquery($sql);
$database->query();
$cod = $database->listObjects();


}

function Insert_Lista_metas_pivote_2_data($row) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$sql = "

INSERT INTO tbl_mc_metas_pivote (

rut,
nombres,
tipo_desafio,
objetivo_banco,
desafio,
tipo_dato,
dato,
de_que,
ponderacion,
grado_cumplimiento,
clasificacion,
ponderacion_matriz_individual,
fecha_cierre,
periodo_seguimiento,
estatus


)
VALUES ($row)";


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();


}

function Insert_Lista_tbl_mc_carrera_interna_data($row) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$sql = "

INSERT INTO tbl_mc_carrera_interna (

rut,
cod_empresa,
cargo_codigo,
fec_ini,
fec_ter,
cargo_glosa


)
VALUES ($row)";

//echo $sql; exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();


}
function Insert_Lista_tbl_mc_potencial_relacionados($row) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$sql = "

INSERT INTO tbl_mc_potencial_relacionados (
rut,
rut_dve,
apell_paterno,
apell_materno,
nombres,
estado,
fecha_declaracion,
cod_empresa
)
VALUES ($row)";

//echo $sql; exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();


}
function Insert_Lista_tbl_mc_tramo_desempeno_data($row) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$sql = "

INSERT INTO tbl_mc_tramo_desempeno
(

num_rut,zona_salarial,tramo_gestion_desempeno


)
VALUES ($row)";


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();


}

function Insert_Lista_tbl_codigo_poliza_data($row) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$sql = "



INSERT INTO tbl_codigo_poliza
(

rut,codigo_poliza


)
VALUES ($row)";


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();


}

function Insert_Lista_tbl_bac_data($row) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$sql = "

INSERT INTO tbl_mc_bac
(

rut

)
VALUES ($row)";


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();


}

function Insert_Lista_cd_data($row) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$sql = "

INSERT INTO tbl_contingencia_2021 (

num_rut,
regimen,
motivo,
fecha_inicio,
fecha_termino,
rut_actualizador,
fecha_actualizacion,
hora_actualizacion

)
VALUES ($row)";

//echo "<br>".$sql;	exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();


}


function Update_Lista_cd_data($row) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

//echo "ROW <BR>".$row."<BR>";
$porciones = explode(",", $row);
//print_r($porciones);

$sql = "
update tbl_contingencia_2021 

set 

regimen='".$porciones[1]."',
motivo='".$porciones[2]."',
fecha_inicio='".$porciones[3]."',
fecha_termino='".$porciones[4]."'

where num_rut='".$porciones[0]."'

";



if($porciones[0]<>""){
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();	
}
echo "<br>".$sql;	
//exit();





}

function Insert_Lista_permiso_unico_data($row) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$sql = "

INSERT INTO tbl_permiso_temporal (

rut,
fec_ingreso_indem,
Fecha_semana

)

VALUES 
($row)";

//echo "<br>".$sql;	exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();


}
function Insert_Lista_ubicacion_colaboradores_data($row) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$sql = "

INSERT INTO tbl_contingencia_ubicacion_colaboradores (

rut,
direccion,
piso,
referencia,
temporalidad,
fecha,
hora,
rut_actualizador,
id_empresa,
comuna,
ciudad

)

VALUES 
($row)";

//echo "<br>".$sql;	exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();


}


function Insert_Lista_tbl_contingencia_2021_dia_data($row) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$sql = "

INSERT INTO tbl_contingencia_2021_dia (
rut,
regimen,
motivo,
fecha,
rut_actualizador,
fecha_actualizacion,
hora_actualizacion,
nombre,
cargo,
division,
rut_jefe,
nombre_jefe,
edit
)

VALUES 
($row)";

//echo "<br>".$sql;	exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();


}


function Insert_Lista_tbl_contingencia_2021_option($row) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$sql = "

INSERT INTO tbl_contingencia_2021_option (
regimen_actual,
motivo_actual,
regimen_nuevo,
motivo_nuevo,
fecha_inicio,
fecha_fin,
muestra_modificar_regimen

)

VALUES 
($row)";

$database->setquery($sql);
$database->query();

//		echo "<br>".$sql;	exit();


$cod = $database->listObjects();


}

function Insert_Lista_cd_original_data($row) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$sql = "

INSERT INTO tbl_contingencia_2021_original (

num_rut,
regimen,
motivo,
fecha_inicio,
fecha_termino,
rut_actualizador,
fecha_actualizacion,
hora_actualizacion

)
VALUES ($row)";

//echo "<br>".$sql;	exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();


}

function Insert_Lista_cargas_data($row) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$sql = "
INSERT INTO tbl_beneficios_cargas (
rut,
dv,
nombre_completo,
tipo_contrato,
cod_beneficio,
nivel_fun,
cod_cargo,
glosa_cargo,
sexo,
fecha_nacimiento,
edad_anos,
edad_meses,
estado_civil,
fecha_ingreso,
antiguedad_anos,
antiguedad_meses,
cod_unidad,
glosa_unidad,
oficina,
glosa_oficina,
region,
empresa,
origen,
cod_division,
glosa_division,
carga_rut,
carga_dig,
carga_nombre,
carga_sexo,
carga_fecha_nacimiento,
edad_carga_anos,
edad_carga_meses,
carga_fecha_der,
carga_fecha_venc,
carga_fecha_mod,
carga_parentesco,
carga_reconocimiento,
carga_tipo,
codigo_sindi

)
VALUES ($row)";



$database->setquery($sql);
$database->query();
$cod = $database->listObjects();


}

function Insert_Lista_permisos_data($row) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$sql = "
INSERT INTO tbl_usuario_permisos (
num_rut,
fec_desde,
fec_hasta,
unida_cuipr,
nro_dias,
tipo_permiso,
rut_digitador,
fec_digit,
permi_estad,
permi_numpe,
permi_descr


)
VALUES ($row)";



$database->setquery($sql);
$database->query();
$cod = $database->listObjects();


}


function Insert_Lista_vacaciones_data($row) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$sql = "
INSERT INTO tbl_usuario_vacaciones (

num_rut,
fec_ini,
fec_term,
unida_cuipr,
rut_dig,
fec_mvto,
nro_dias,
tipo_mov,
vac_folio,
vac_rec_rrhh,
rut_rrhh


)
VALUES ($row)";



$database->setquery($sql);
$database->query();
$cod = $database->listObjects();


}


function Capsulas_likes_data(){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);	

$sql = "

select h.*, (select titulo from tbl_objeto where id=h.id_modulo)  as modulo,
(select id_curso from tbl_objeto where id=h.id_modulo) as id_curso,
(select nombre from tbl_lms_curso where id=(select id_curso from tbl_objeto where id=h.id_modulo)) as Curso

from tbl_capsulas_rating h

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;

}
function Prosci_EditNuevoProyecto_data($id_proyecto, $nombre_proyecto) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "update tbl_prosci_proyecto set nombre='$nombre_proyecto' where id_proyecto='$id_proyecto'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function Prosci_DelNuevoProyecto_data($id_proyecto) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "update tbl_prosci_proyecto set id_empresa='99' where id_proyecto='$id_proyecto'";
//echo $sql;    exit();
$database->setquery($sql);
$database->query();


}
function ProsciDelAdmin_Tbl($usuario_user) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "delete from tbl_admin where user='$usuario_user'";
$database->setquery($sql);
$database->query();

$sql = "delete from tbl_prosci_admin where rut='$usuario_user'";
$database->setquery($sql);
$database->query();

$sql = "delete from tbl_prosci_admin_super where rut='$usuario_user'";
$database->setquery($sql);
$database->query();

}
function TraeDatosDesdeTablaSillas($distinct, $where, $valor) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select DISTINCT($distinct) as valor from tbl_sillas where $where='$valor'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}


function DatosDistinctCampoTblUsuarioDobleCampoParaCui($id_empresa, $campo, $descripcion) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select distinct($campo) as valor, $descripcion as descripcion from tbl_usuario where id_empresa='$id_empresa' and $campo<>'' order by $campo asc";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function DatosDistinctCampoTblUsuarioDobleCampo($id_empresa, $campo, $descripcion) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select distinct($campo) as valor, $descripcion as descripcion from tbl_usuario where id_empresa='$id_empresa' and $campo<>'' order by $campo asc";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function SillasTraeDatosDadoCampo($campo, $valor){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select DISTINCT($campo) from tbl_sillas where cui='$valor'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Prosci_Inscripcion_Rut_IdEncuesta($rut_masivo,$id_proyecto,$id_encuesta, $id_empresa){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$usu=TraeDatosUsuario($rut_masivo);

if($id_encuesta=="36"){$orden="1";}
if($id_encuesta=="37"){$orden="2";}
if($id_encuesta=="38"){$orden="3";}
if($id_encuesta=="39"){$orden="4";}
if($id_encuesta=="41"){$orden="5";}

if($id_encuesta=="57"){$orden="6";}
if($id_encuesta=="55"){$orden="7";}
if($id_encuesta=="56"){$orden="8";}
if($id_encuesta=="58"){$orden="9";}

$nombre_completo=$usu[0]->nombre_completo;
$cargo=$usu[0]->cargo;
$division=$usu[0]->division;
$fecha = date("Y-m-d");	

if($rut_masivo<>"")	{
$sql = "
INSERT INTO tbl_prosci_encuestas_usuarios (id_proyecto,id_encuesta,rut,id_empresa,nombre_completo,cargo,division,fecha,orden)
VALUES ('$id_proyecto','$id_encuesta','$rut_masivo','$id_empresa','$nombre_completo','$cargo','$division','$fecha','$orden')";	
//echo $sql;
}

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
}
function Prosci_Inscripcion_Rut_IdVisualizacion($rut_masivo,$id_proyecto, $id_empresa){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$usu=TraeDatosUsuario($rut_masivo);

$nombre_completo=$usu[0]->nombre_completo;
$cargo=$usu[0]->cargo;
$division=$usu[0]->division;
$fecha = date("Y-m-d");	
if($rut_masivo<>""){
$sql = "
INSERT INTO rel_prosci_usuarios_visualizadores (id_proyecto,rut,id_empresa,fecha)
VALUES ('$id_proyecto','$rut_masivo','$id_empresa','$fecha')";	
}
//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
}
function Prosci_Delete_Rut_IdVisualizacion($rut_masivo,$id_proyecto, $id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);



$fecha = date("Y-m-d");	

$sql = "
DELETE from rel_prosci_usuarios_visualizadores where id_proyecto='$id_proyecto'  and rut='$rut_masivo' and id_empresa='$id_empresa'

";




$database->setquery($sql);
$database->query();
$cod = $database->listObjects();



}

function Prosci_Delete_Rut_IdEncuesta($rut_masivo,$id_proyecto,$id_encuesta, $id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$usu=TraeDatosUsuario($rut_masivo);

if($id_encuesta=="36"){$orden="1";}
if($id_encuesta=="37"){$orden="2";}
if($id_encuesta=="38"){$orden="3";}
if($id_encuesta=="39"){$orden="4";}
if($id_encuesta=="41"){$orden="5";}

if($id_encuesta=="57"){$orden="6";}
if($id_encuesta=="55"){$orden="7";}
if($id_encuesta=="56"){$orden="8";}
if($id_encuesta=="58"){$orden="9";}

$nombre_completo=$usu[0]->nombre_completo;
$cargo=$usu[0]->cargo;
$division=$usu[0]->division;

$fecha = date("Y-m-d");	

$sql = "
DELETE from tbl_prosci_encuestas_usuarios where id_proyecto='$id_proyecto' and id_encuesta='$id_encuesta' and rut='$rut_masivo' and id_empresa='$id_empresa'

";

//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();



}

function Metas_Cuenta_Audiencia_Sql($sqlquery, $id_audiencia, $id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select count(id) as cuenta from tbl_metas_audiencia_id_audiencia_rut where id_audiencia='$id_audiencia'";

//echo "Audiencia_Sql sql $sql";
//echo "<br><br>";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();


return ($cod[0]->cuenta);	

}

function Metas_lista_audiencia_data($id_empresa, $filtro_creador, $filtro_mes_ano) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);



if($filtro_creador<>""){$queryAutor=" and h.autor='$filtro_creador' ";} else {$queryAutor="";}
if($filtro_mes_ano<>""){$queryMesAno=" and EXTRACT( YEAR_MONTH FROM h.fecha ) ='$filtro_mes_ano'  ";} else {$queryMesAno="";}


$sql = "
select h.*

from tbl_metas_audiencia h

where h.id_empresa='$id_empresa' 
$queryAutor
$queryMesAno
order by h.id DESC

";

//echo "<br>".$sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function MetasAudiencia_Save_NuevaAudiencia($nombre_audiencia,$descripcion_audiencia, 
$id_empresa, $sqlquery, $excluir, $incluir, $campos_filtros, $id_audiencia) {

global $c_host, $c_user, $c_pass, $c_db;
$rut=$_SESSION["user_"];
$fecha = date("Y-m-d");	

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$campos_filtros_enc=Encodear3($campos_filtros);

$nombre_audiencia=utf8_decode($nombre_audiencia);
$descripcion_audiencia=utf8_decode($descripcion_audiencia);

$sql="select id from tbl_metas_audiencia order by id DESC limit 1";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
$id_next=$cod[0]->id+1;

if($id_audiencia>0){
$sql = "
update tbl_metas_audiencia 

set nombre='$nombre_audiencia', descripcion='$descripcion_audiencia',
sqlquery='$sqlquery',excluir='$excluir',incluir='$incluir',fecha='$fecha',campos_filtros='$campos_filtros',
campos_filtros_enc='$campos_filtros_enc', editor='$rut', fecha_edicion='$fecha'

where id='$id_audiencia'

";		

TruncateRutIdAudiencia($id_audiencia);
Audiencia_Sql($sqlquery, $id_audiencia, $id_empresa);			
//exit();

} else {

$sql = "
insert into tbl_metas_audiencia 

(id, nombre,descripcion,id_empresa,sqlquery,excluir,incluir,fecha,campos_filtros,campos_filtros_enc, autor, fecha_creacion) 

values('$id_next', '$nombre_audiencia','$descripcion_audiencia','$id_empresa','$sqlquery','$excluir','$incluir','$fecha','$campos_filtros','$campos_filtros_enc','$rut', '$fecha')
";
// AHORA NO GRABA AL MOMENTO; SINO QUE ESPERA CRON 
//TruncateRutIdAudiencia($id_next);
//Audiencia_Sql($sqlquery, $id_next,$excluir,$incluir, $id_empresa);	
//exit();		
}

$database->setquery($sql);
$database->query();
}

function MetasMatrizIncentivos_Lista_campo_data($campo1, $campo2, $campo3, $campo4, $campo5, $campo6, $filtro1, $filtro2, $filtro3, $filtro4, $filtro5, $filtro6, $excluir, $incluir, $id_empresa){


/*echo "<br> MatrizIncentivos_Lista_campo_data $campo1, $campo2, $campo3, $campo4, $campo5, $campo6, $filtro1, $filtro2, $filtro3, $filtro4, $filtro5, $filtro6, exclrui $excluir, incluir $incluir, $id_empresa";*/
//exit();
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$query_inicio_1="";	$query_filtro_or_1="";$contador1=0;$contador_total1=0;
$query_filtro_1=explode(";", $filtro1);
foreach ($query_filtro_1 as $unico1){		if($unico1<>""){$contador_total1++;	}}
foreach ($query_filtro_1 as $unico1){		if($unico1<>""){
$query_filtro_or1.="  $campo1 = '$unico1'  ";
$contador_total1=$contador_total1;
if($contador1<($contador_total1-1)){					
$query_filtro_or1.=" or ";					}			$contador1++;
}}


//echo "<br>contador1 $contador1 contador_total1 $contador_total1";

if($query_filtro_or1<>""){ $query_inicio1=" and ($query_filtro_or1) ";}

$sql1 = "
SELECT 	$campo1 as dato FROM 	tbl_usuario
where $campo1<>'' AND id_empresa='$id_empresa'
$query_inicio1
GROUP by $campo1 ORDER BY $campo1 ASC
";
$database->setquery($sql1);
$database->query();
$cod1 = $database->listObjects();
$query_inicio_2="";	$query_filtro_or_2="";$contador2=0;$contador_total2=0;
$query_filtro_2=explode(";", $filtro2);
foreach ($query_filtro_2 as $unico2){		if($unico2<>""){$contador_total2++;	}}
foreach ($query_filtro_2 as $unico2){		if($unico2<>""){
$query_filtro_or2.="  $campo2 = '$unico2'  ";
$contador_total2=$contador_total2;
if($contador2<$contador_total2-1){					
$query_filtro_or2.=" or ";					}			$contador2++;
}}
if($query_filtro_or2<>""){ $query_inicio2=" and ($query_filtro_or2) ";}

$sql2 = "
SELECT 	$campo2 as dato FROM 	tbl_usuario
where $campo2<>'' AND id_empresa='$id_empresa'
$query_inicio1 $query_inicio2
GROUP by $campo2 ORDER BY $campo2 ASC
";
$database->setquery($sql2);
$database->query();
$cod2 = $database->listObjects();
$query_inicio_3="";	$query_filtro_or_3="";$contador3=0;$contador_total3=0;
$query_filtro_3=explode(";", $filtro3);
foreach ($query_filtro_3 as $unico3){		if($unico3<>""){$contador_total3++;	}}
foreach ($query_filtro_3 as $unico3){		if($unico3<>""){
$query_filtro_or3.="  $campo3 = '$unico3'  ";
$contador_total3=$contador_total3;
if($contador3<$contador_total3-1){					
$query_filtro_or3.=" or ";					}			$contador3++;
}}
if($query_filtro_or3<>""){ $query_inicio3=" and ($query_filtro_or3) ";}	

$sql3 = "
SELECT 	$campo3 as dato FROM 	tbl_usuario
where $campo3<>'' AND id_empresa='$id_empresa'
$query_inicio1 $query_inicio2 $query_inicio3
GROUP by $campo3 ORDER BY $campo3 ASC
";
$database->setquery($sql3);
$database->query();
$cod3 = $database->listObjects();
$query_inicio_4="";	$query_filtro_or_4="";$contador4=0;$contador_total4=0;
$query_filtro_4=explode(";", $filtro4);
foreach ($query_filtro_4 as $unico4){		if($unico4<>""){$contador_total4++;	}}
foreach ($query_filtro_4 as $unico4){		if($unico4<>""){
$query_filtro_or4.="  $campo4 = '$unico4'  ";
$contador_total4=$contador_total4;
if($contador4<$contador_total4-1){					
$query_filtro_or4.=" or ";					}			$contador4++;
}}
if($query_filtro_or4<>""){ $query_inicio4=" and ($query_filtro_or4) ";}	

$sql4 = "
SELECT 	$campo4 as dato FROM 	tbl_usuario
where $campo4<>'' AND id_empresa='$id_empresa'
$query_inicio1 $query_inicio2 $query_inicio3 $query_inicio4
GROUP by $campo4 ORDER BY $campo4 ASC
";
$database->setquery($sql4);
$database->query();
$cod4 = $database->listObjects();
$query_inicio_5="";	$query_filtro_or_5="";$contador5=0;$contador_total5=0;
$query_filtro_5=explode(";", $filtro5);
foreach ($query_filtro_5 as $unico5){		if($unico5<>""){$contador_total5++;	}}
foreach ($query_filtro_5 as $unico5){		if($unico5<>""){
$query_filtro_or5.="  $campo5 = '$unico5'  ";
$contador_total5=$contador_total5;
if($contador5<$contador_total5-1){					
$query_filtro_or5.=" or ";					}			$contador5++;
}}
if($query_filtro_or5<>""){ $query_inicio5=" and ($query_filtro_or5) ";}		

$sql5 = "
SELECT 	$campo5 as dato FROM 	tbl_usuario
where $campo5<>'' AND id_empresa='$id_empresa'
$query_inicio1 $query_inicio2 $query_inicio3 $query_inicio4 $query_inicio5
GROUP by $campo5 ORDER BY $campo5 ASC
";
$database->setquery($sql5);
$database->query();
$cod5= $database->listObjects();

$query_inicio_6="";	$query_filtro_or_6="";$contador6=0;$contador_total6=0;
$query_filtro_6=explode(";", $filtro6);
foreach ($query_filtro_6 as $unico6){		if($unico6<>""){$contador_total6++;	}}
foreach ($query_filtro_6 as $unico6){		if($unico6<>""){
$query_filtro_or6.="  $campo6 = '$unico6'  ";
$contador_total6=$contador_total6;
if($contador6<$contador_total6-1){					
$query_filtro_or6.=" or ";					}			$contador6++;
}}
if($query_filtro_or6<>""){ $query_inicio6=" and ($query_filtro_or6) ";}			

$sql6 = "
SELECT 	$campo6 as dato FROM 	tbl_usuario
where $campo6<>'' AND id_empresa='$id_empresa'
$query_inicio1 $query_inicio2 $query_inicio3 $query_inicio4 $query_inicio5 $query_inicio6
GROUP by $campo6 ORDER BY $campo6 ASC
";
$database->setquery($sql6);
$database->query();
$cod6 = $database->listObjects();
$query_inicio_7="";	$query_filtro_or_7="";$contador7=0;$contador_total7=0;
$query_filtro_7=explode(";", $filtro7);
foreach ($query_filtro_7 as $unico7){		if($unico7<>""){$contador_total7++;	}}
foreach ($query_filtro_7 as $unico7){		if($unico7<>""){
$query_filtro_or7.="  $campo7 = '$unico7'  ";
$contador_total7=$contador_total7-1;
if($contador7<$contador_total7){					
$query_filtro_or7.=" or ";					}			$contador7++;
}}
if($query_filtro_or7<>""){ $query_inicio7=" and ($query_filtro_or7) ";}		


/*
echo "<br>SQL 1<br>$sql1<br>";	
echo "<br>SQL 2<br>$sql2<br>";	
echo "<br>SQL 3<br>$sql3<br>";	
echo "<br>SQL 4<br>$sql4<br>";	
echo "<br>SQL 5<br>$sql5<br>";	
echo "<br>SQL 6<br>$sql6<br>";	
*/

$arreglo[1]=$cod1;
$arreglo[2]=$cod2;
$arreglo[3]=$cod3;
$arreglo[4]=$cod4;
$arreglo[5]=$cod5;
$arreglo[6]=$cod6;

$query_excluir="";
$post_excluir = explode(";", $excluir);
foreach($post_excluir as $unico){
$query_excluir.="  and rut<>'$unico' ";
}

//echo "inlcuir $incluir";
//exit();
$query_incluir="";
$post_incluir = explode(";", $incluir);
foreach($post_incluir as $unico){
$query_incluir.="  or rut='$unico' ";
}

//print_r($incluir);
//echo "query_incluir $query_incluir";
//exit();



//print_r($arreglo[5]);
//echo "<pre>";	print_r($arreglo);
//vista general de numero
$sql10 = "
SELECT 	count(id) as cuenta FROM 	tbl_usuario
where $campo6<>'' AND id_empresa='$id_empresa'
$query_inicio1 $query_inicio2 $query_inicio3 $query_inicio4 $query_inicio5 $query_inicio6

$query_excluir $query_incluir

ORDER BY $campo4 ASC";
$database->setquery($sql10);
$database->query();
$cod10 = $database->listObjects();
//echo "<br><br>sql10 $sql10";


//vista usuarios
$sql11 = "
SELECT 	* FROM 	tbl_usuario
where $campo6<>'' AND id_empresa='$id_empresa'
$query_inicio1 $query_inicio2 $query_inicio3 $query_inicio4 $query_inicio5 $query_inicio6


$query_excluir $query_incluir

ORDER BY nombre_completo ASC";
$database->setquery($sql11);
$database->query();
$cod11 = $database->listObjects();
//echo "<br><br>sql11 $sql11";

$arreglo[7]=$cod10[0]->cuenta;
$arreglo[8]=$cod10;
$arreglo[9]=$sql11;


//exit();
return $arreglo;

}


function MetasBuscaDatosAudiencia($id_audiencia_edit){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$fecha = date("Y-m-d");
$sql = "select * from tbl_metas_audiencia where id='$id_audiencia_edit'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	
}
function ListaBchNuevasClavesRutTemp(){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.* from rut_temp h where h.clave is null";
//echo "sql $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;

}

function ListaBchNuevasClavesRutTemp_Insert($rut, $clave_decod, $clave){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql   = "update rut_temp set clave_decod='$clave_decod', clave='$clave' where rut='$rut'";

$database->setquery($sql);
$database->query();
}


function Metas_2020_Delete_bloque($id){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "delete from rel_metas_tipo_meta_niveles_cargo_bloques where id='$id'";

//echo $sql; exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Metas_2020_Delete_Meta($id){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "delete from tbl_metas_definicion where id='$id'";

//echo $sql; exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Metas_2020_Delete_Periodo($id){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "delete from tbl_metas_periodo where id='$id'";

//echo $sql; exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Metas_2020_Delete_Tipo_Meta($id){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "delete from tbl_metas_tipo_meta where id='$id'";

//echo $sql; exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Metas_2020_Crear_editar_bloque($id_bloque_enc, $bloque_nombre, $bloque_creador_meta, $bloque_evaluador_meta, $tipo_meta, $bloque_ponderacion, $id_m, $id_p, $id_bloque_sned){

$id_empresa 			= $_SESSION["id_empresa"];
$rut 							= $_SESSION["user_"];


//echo "<br>$bloque_nombre, $bloque_creador_meta, $bloque_evaluador_meta, $tipo_meta, $bloque_ponderacion, $id_m, $id_p, $id_bloque_sned<br>";

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$id_bloque=Decodear3($id_bloque_enc);
$tipo_meta=Decodear3($tipo_meta);
$sql = "SELECT id FROM rel_metas_tipo_meta_niveles_cargo_bloques WHERE id = '$id_bloque' order by id DESC Limit 1";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
$id = $cod[0]->id;
$bloque_nombre = utf8_decode($bloque_nombre);

$hora = date("H:i:s");
$fecha = date("Y-m-d");

if ($id_bloque_sned > 0) {
$sql = "UPDATE rel_metas_tipo_meta_niveles_cargo_bloques 
SET nombre='$bloque_nombre',id_creador='$bloque_creador_meta',id_evaluador='$bloque_evaluador_meta',ponderacion='$bloque_ponderacion' 
WHERE id='$id_bloque_sned' and id_empresa='$id_empresa'";
} else {
$sql = "INSERT INTO rel_metas_tipo_meta_niveles_cargo_bloques 
(nivel, tipo_meta, ponderacion, id_empresa, 												periodo, id_creador, id_evaluador, 												nombre, fecha, hora, rut) 
VALUES	('$id_m','$tipo_meta','$bloque_ponderacion','$id_empresa','$id_p', '$bloque_creador_meta','$bloque_evaluador_meta','$bloque_nombre','$fecha','$hora','$rut')";
}

// echo "<br>id_bloque $id_bloque <br>function Metas_2020_Crear_editar_bloque <br> ".$sql;
// exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Metas_2020_Crear_editar_Meta_por_Bloque($id_meta_enc, $meta, $criterio_medicion, $cumplimiento_90, $cumplimiento_100, $cumplimiento_130, $estado_creacion, $meta_ponderacion, $id_creacion, $tipo_meta, $bloque, $periodo, $nivel){

$id_empresa 			= $_SESSION["id_empresa"];
$rut 							= $_SESSION["user_"];

$id_meta_enc=Decodear3($id_meta_enc);

$id_creacion=Decodear3($id_creacion);
$tipo_meta=Decodear3($tipo_meta);
$bloque=Decodear3($bloque);
$periodo=Decodear3($periodo);


global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$meta = utf8_decode($meta);
$criterio_medicion = utf8_decode($criterio_medicion);
$cumplimiento_90 = utf8_decode($cumplimiento_90);
$cumplimiento_100 = utf8_decode($cumplimiento_100);
$cumplimiento_130 = utf8_decode($cumplimiento_130);

$sql = "SELECT id FROM tbl_metas_definicion WHERE id = '$id_bloque' order by id DESC Limit 1";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
$id = $cod[0]->id;
$bloque_nombre = utf8_decode($bloque_nombre);

$hora = date("H:i:s");
$fecha = date("Y-m-d");

if ($id > 0) {
$sql = "UPDATE tbl_metas_definicion SET meta='$meta',estado_creacion='$estado_creacion',
criterio_medicion='$criterio_medicion',cumplimiento_90='$cumplimiento_90', 
cumplimiento_100='$cumplimiento_100',cumplimiento_130='$cumplimiento_130', ponderacion	='$meta_ponderacion'
id_creador='$id_creacion'

WHERE id='$id_meta_enc' and id_empresa='$id_empresa'";
} else {
$sql = "INSERT INTO tbl_metas_definicion 
(meta, estado_creacion, descripcion, criterio_medicion, cumplimiento_90, cumplimiento_100, cumplimiento_130, 	ponderacion,			id_creador, fecha, hora, nivel, tipo_meta, 						bloque, id_empresa, periodo, rut) 
VALUES	
('$meta','$estado_creacion','$meta_descripcion','$criterio_medicion','$cumplimiento_90', '$cumplimiento_100','$cumplimiento_130',	'$meta_ponderacion',	'$id_creacion','$fecha','$hora','$nivel','$tipo_meta','$bloque', '$id_empresa', '$periodo', '$rut')";
}

//echo "sql <br>$sql";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	



}

function Metas_2020_Crear_editar_meta($id_bloque_enc, $bloque_nombre, $bloque_creador_meta, $bloque_evaluador_meta, $tipo_meta, $bloque_ponderacion, $id_m, $id_p){

$id_empresa 			= $_SESSION["id_empresa"];
$rut 							= $_SESSION["user_"];

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$id_bloque=Decodear3($id_bloque_enc);
$tipo_meta=Decodear3($tipo_meta);
$sql = "SELECT id FROM rel_metas_tipo_meta_niveles_cargo_bloques WHERE id = '$id_bloque' order by id DESC Limit 1";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
$id = $cod[0]->id;
$bloque_nombre = utf8_decode($bloque_nombre);

$hora = date("H:i:s");
$fecha = date("Y-m-d");

if ($id > 0) {
$sql = "UPDATE rel_metas_tipo_meta_niveles_cargo_bloques SET nombre='$nombre',id_creador='$bloque_creador_meta',id_evaluador='$bloque_evaluador_meta',ponderacion='$bloque_ponderacion' 
WHERE id='$id_bloque' and id_empresa='$id_empresa'";
} else {
$sql = "INSERT INTO rel_metas_tipo_meta_niveles_cargo_bloques 
(nivel, tipo_meta, ponderacion, id_empresa, 												periodo, id_creador, id_evaluador, 												nombre, fecha, hora, rut) 
VALUES	('$id_m','$tipo_meta','$bloque_ponderacion','$id_empresa','$id_p', '$bloque_creador_meta','$bloque_evaluador_meta','$bloque_nombre','$fecha','$hora','$rut')";
}

//echo "Metas_2020_Crear_editar_meta ".$sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}


function SILLAS_TraeTotalEstadoNull($campo, $valor) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
if($campo=="JEFE"){
$sql = "SELECT
h.* 
FROM
tbl_sillas_temporal_data h 
inner join tbl_usuario on tbl_usuario.rut=h.rut and tbl_usuario.jefe='$valor'
WHERE
(
estado IS NULL 
OR estado = '')";

}else{
$sql = "select h.* from tbl_sillas_temporal_data h where h.$campo='$valor' and (estado is null or estado ='')";
}

// echo "sql $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Metas_Lista_tipo_creadores_data($periodo, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.* from tbl_metas_creador h where h.id_empresa='$id_empresa' and h.periodo='$periodo'   order by h.periodo DESC, h.nombre ASC";
//echo "sql $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Metas_Lista_tipo_evaluadores_data($periodo, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.* from tbl_metas_evaluador h where h.id_empresa='$id_empresa' and h.periodo='$periodo'   order by h.periodo DESC, h.nombre ASC";
//echo "sql $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Metas_SaveNuevo_Rel_Tipo_Meta_Nivel_Cargo_data($periodo, $nivel_cargo, $tipo_metas, $ponderacion, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$nivel_cargo							= utf8_decode($nivel_cargo);
$nivel_cargo_nombre				= utf8_decode($nivel_cargo_nombre);
$nivel_cargo_descripcion	= utf8_decode($nivel_cargo_descripcion);



$sql_1="select id from rel_metas_tipo_meta_niveles_cargo where nivel='$nivel_cargo' and tipo_meta='$tipo_metas' and periodo='$periodo' and id_empresa='$id_empresa'";

//echo $sql_1;
$database->setquery($sql_1);
$database->query();
$cod = $database->listObjects();

if($cod[0]->id>0){
$sql = "
UPDATE rel_metas_tipo_meta_niveles_cargo SET nivel='$nivel_cargo', tipo_meta='$tipo_metas', ponderacion='$ponderacion', periodo='$periodo', id_empresa='$id_empresa'
where id='".$cod[0]->id."'";

} else {

if($nivel_cargo>0 and $tipo_metas>0){
$sql = "
INSERT INTO rel_metas_tipo_meta_niveles_cargo (nivel, tipo_meta, ponderacion, periodo, id_empresa)
VALUES ('$nivel_cargo','$tipo_metas','$ponderacion','$periodo','$id_empresa')";   	
}
}

//echo $sql;
$database->setquery($sql);
$database->query();
}

function Metas_SaveNuevo_Niveles_Cargo_data($nivel_cargo, $nivel_cargo_nombre, $nivel_cargo_descripcion, $periodo_nivel_cargo, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$nivel_cargo							= utf8_decode($nivel_cargo);
$nivel_cargo_nombre							= utf8_decode($nivel_cargo_nombre);
$nivel_cargo_descripcion	= utf8_decode($nivel_cargo_descripcion);

$sql = "
INSERT INTO tbl_metas_niveles_cargo (nivel, cargo, descripcion, periodo,id_empresa)

VALUES ('$nivel_cargo','$nivel_cargo_nombre','$nivel_cargo_descripcion','$periodo_nivel_cargo','$id_empresa')";


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
}

function Metas_Lista_Niveles_Cargo_data($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.* from tbl_metas_niveles_cargo h where h.id_empresa='$id_empresa' order by h.periodo DESC, h.nivel ASC";
//echo "sql $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}


function Metas_Lista_Audiencias_Tipo_Metas_data($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "

select h.* from tbl_metas_audiencia h

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Metas_Ponderacion_NivelCargo_Tipo_Empresa($id_nivel, $id_tipo, $id_empresa){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);	

$sql = "select ponderacion from rel_metas_tipo_meta_niveles_cargo where nivel='$id_nivel' and tipo_meta='$id_tipo' and id_empresa='$id_empresa'";

//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod[0]->ponderacion;	
}
function Metas_Lista_Tipo_Metas_Definicion_Periodo_NivelCargo_Bloques_data($periodo, $id_nivel, $id_tipo_meta, $id_bloque, $id_empresa){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "	select h.* 
from tbl_metas_definicion h 
where h.nivel='$id_nivel' and tipo_meta='$id_tipo_meta' and bloque='$id_bloque'  and h.id_empresa='$id_empresa' order by h.periodo DESC";
//echo "<br>Metas_Lista_Tipo_Metas_Definicion_Periodo_NivelCargo_Bloques_data<br>sql $sql<br>";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	
}
function Metas_Lista_Tipo_Metas_Periodo_NivelCargo_Bloques_data($periodo, $nivel, $tipo_meta, $id_empresa){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "	select h.* , (select tipo_meta from tbl_metas_tipo_meta where id=h.tipo_meta) as nombre_tipo_meta ,
(select nombre from tbl_metas_creador where id_creador=h.id_creador) as creador,
(select nombre from tbl_metas_evaluador where id_evaluador=h.id_evaluador) as evaluador

from rel_metas_tipo_meta_niveles_cargo_bloques h 
where h.nivel='$nivel' and tipo_meta='$tipo_meta' and h.id_empresa='$id_empresa' order by h.periodo DESC";


//	echo "<br>Metas_Lista_Tipo_Metas_Periodo_NivelCargo_Bloques_data<br>sql<br> $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	
}
function Metas_Lista_Tipo_Metas_Periodo_NivelCargo_data($periodo, $nivel_cargo, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "	select h.* , (select tipo_meta from tbl_metas_tipo_meta where id=h.tipo_meta) as nombre_tipo_meta
from rel_metas_tipo_meta_niveles_cargo h 
where h.nivel='$nivel_cargo'  and h.id_empresa='$id_empresa' order by h.periodo DESC";
//echo "<br>Metas_Lista_Tipo_Metas_Periodo_NivelCargo_data<br>sql $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Metas_Lista_Tipo_Metas_data($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.* from tbl_metas_tipo_meta h where h.id_empresa='$id_empresa'   order by h.periodo DESC";
//echo "sql $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}


function Metas_Lista_Periodos_data($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.* from tbl_metas_periodo h where h.id_empresa='$id_empresa' order by h.periodo DESC";
//echo "sql $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Metas_Lista_NivelCargo_Nombre_data($id_nivel, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.* from tbl_metas_audiencia h where h.id_empresa='$id_empresa' and id='$id_nivel' order by h.periodo DESC";
//echo "sql $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Metas_Lista_NivelCargo_data($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.* from tbl_metas_niveles_cargo h where h.id_empresa='$id_empresa' order by h.periodo DESC";
//echo "sql $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}



function Metas_SaveNuevo_Tipo_Metas_data($tipo_meta, $tipo_meta_descripcion, $categoria_meta, $periodo_meta, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$tipo_meta							= utf8_decode($tipo_meta);
$tipo_meta_descripcion	= utf8_decode($tipo_meta_descripcion);

$sql = "
INSERT INTO tbl_metas_tipo_meta (tipo_meta, descripcion, categoria_meta, periodo,  id_empresa)

VALUES ('$tipo_meta','$tipo_meta_descripcion','$categoria_meta','$periodo_meta','$id_empresa')";


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
}

function Metas_SaveNuevoPeriodo_data($periodo, $periodo_nombre, $periodo_descripcion, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$periodo_nombre				= utf8_decode($periodo_nombre);
$periodo_descripcion	= utf8_decode($periodo_descripcion);
$sql = "
INSERT INTO tbl_metas_periodo (periodo, nombre_periodo, descripcion, id_empresa)

VALUES ('$periodo','$periodo_nombre','$periodo_descripcion','$id_empresa')";


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
}

function SILLAS_traigoDatosDeAdmin($user) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_admin where user='$user'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}



function  SILLAS_TraigoGestores() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_admin where acceso='120'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
} 


function  TraeTransformacionesIDdadoSilla($silla) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select tbl_sillas_temporal_data.* from tbl_sillas_temporal_data where tbl_sillas_temporal_data.numero = '$silla'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
} 


function  TraeTransformacionesIDdadoIdAsociacion($id_asociacion) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select tbl_sillas_temporal_data.* from tbl_sillas_temporal_data where tbl_sillas_temporal_data.id_asociacion = '$id_asociacion' order by tbl_sillas_temporal_data.tipo desc";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
} 




function  TraeTransformacionesID() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select distinct(tbl_sillas_temporal_data.id_asociacion) from tbl_sillas_temporal_data where tbl_sillas_temporal_data.id_asociacion >0 and tipo_accion='Transformacion'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
} 

function RecoFullActualiza2020(){


global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select h.*	from tbl_reconoce_gracias_full  h where h.zona is NULL order by fecha DESC, hora DESC		

";
//echo "$sql";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

foreach ($cod as $unico){


$rut_remitente			=$unico->rut_remitente;
$Rem=TraeDatosUsuario($rut_remitente);


$rut_destinatario		=$unico->rut_destinatario;
$Dest=TraeDatosUsuario($rut_destinatario);

$rut_jefatura		=$Dest[0]->jefe;
$Jefe=TraeDatosUsuario($rut_jefatura);

$sql_2 = "update tbl_reconoce_gracias_full  


set zona='".$Dest[0]->zona."', seccion='', glosa_cui='".$Dest[0]->unidad_negocio."', 
nombre_destinatario='".$Dest[0]->nombre_completo."',  
zona_remitente='".$Rem[0]->zona."',  seccion_remitente='', glosa_cui_remitente='".$Rem[0]->unidad_negocio."', nombre_jefatura='".$Jefe[0]->nombre_completo."'   
where   id='".$unico->id."'";


$database->setquery($sql_2);
$database->query();


}

return $cod;	



}
function Amonestaciones_Buscar_Rut($rut_col, $id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);



$jTIPO=" and (tipo='AMONESTACION' or tipo='GRACIAS' or tipo='COLABORACION' or tipo='RECONOCIMIENTO') ";

$Adm=DatosUsuarioAdmin($_SESSION["user_"]);
if($Adm[0]->filtro_division_personas=="1"){
$jDivision=" and division<>'Division Personas y Organizacion'";
} else {
$jDivision=" ";
}


$sql = "

select *

from tbl_reconoce_gracias_full
where id>0
$jTIPO $jDivision
and rut_destinatario='$rut_col' and id_empresa='$id_empresa'
order by fecha DESC, hora DESC		


";
//echo "$sql";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}
function reco_reconocer_full_2020_data($tipo){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

//print_r($_SESSION["user_"]);

if($tipo=="AMONESTACION"){
$jTIPO=" and tipo='AMONESTACION' ";
} elseif($tipo=="RECONOCIMIENTO"){
$jTIPO=" and tipo<>'AMONESTACION' ";
} else {
$jTIPO=" ";
}


$Adm=DatosUsuarioAdmin($_SESSION["user_"]);
if($Adm[0]->filtro_division_personas=="1"){
$jDivision=" and division<>'Division Personas y Organizacion'";
} else {
$jDivision=" ";
}


$sql = "

select *

from tbl_reconoce_gracias_full
where id>0
$jTIPO $jDivision
order by fecha DESC, hora DESC		


";




$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;


}

function reco_reconocer_full_2020_data_SL($tipo){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

//print_r($_SESSION["user_"]);

if($tipo=="AMONESTACION"){
$jTIPO=" and tipo='AMONESTACION' ";
} elseif($tipo=="RECONOCIMIENTO"){
$jTIPO=" and tipo<>'AMONESTACION' ";
} else {
$jTIPO=" ";
}


$Adm=DatosUsuarioAdmin($_SESSION["user_"]);
if($Adm[0]->filtro_division_personas=="1"){
$jDivision=" and division<>'Division Personas y Organizacion'";
} else {
$jDivision=" ";
}


$sql = "

select *

from tbl_reconoce_gracias_full
where id>0
and seguridad_laboral='SI'
$jDivision
order by fecha DESC, hora DESC		


";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;


}

function  TodasLAsSolicitodesTEmpralesDAta($gestor) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


if($gestor){
$filtro.=" and tbl_sillas_temporal_data.autor_gestor='$gestor'";
}


$sql = "select *  from tbl_sillas_temporal_data where tbl_sillas_temporal_data.id>1  $filtro";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
} 



function  SILLAS_CantidadDestino($id_asociacion) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select count(id) as total from tbl_sillas_temporal_data where id_asociacion='$id_asociacion' and tipo='Insertado Correctamente'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
} 
function  SILLAS_CantidadOrigen($id_asociacion) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select count(id) as total from tbl_sillas_temporal_data where id_asociacion='$id_asociacion' and tipo='Registro No Insertado / No quedan Sillas'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function  DistinctIdAsociacionSobrecuposTraeCargoDestino($id_asociacion) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select distinct(cargo) from tbl_sillas_temporal_data where id_asociacion='$id_asociacion' and tipo='Insertado Correctamente'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
} 


function  DistinctIdAsociacionSobrecuposTraeCargoOrigen($id_asociacion) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

//$sql = "select distinct(cargo) from tbl_sillas_temporal_data where id_asociacion='$id_asociacion' and tipo='Registro No Insertado / No quedan Sillas'";
$sql = "select distinct(cargo) from tbl_sillas_temporal_data where id_asociacion='$id_asociacion' ";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function  DistinctIdAsociacionSobrecuposTraeCuiOrigen($id_asociacion) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

//$sql = "select distinct(cui) from tbl_sillas_temporal_data where id_asociacion='$id_asociacion' and tipo='Registro No Insertado / No quedan Sillas'";
$sql = "select distinct(cui) from tbl_sillas_temporal_data where id_asociacion='$id_asociacion' ";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function  DistinctIdAsociacionSobrecuposTraeCuiDestino($id_asociacion) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select distinct(cui) from tbl_sillas_temporal_data where id_asociacion='$id_asociacion' and tipo='Insertado Correctamente'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
} 


function  DistinctIdAsociacionSobrecupos() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select distinct(id_asociacion), tipo_accion from tbl_sillas_temporal_data where id_asociacion>0 and tipo_accion<>'Transformacion'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}



function  UpdateSillaIDAsociacion($id_asociacion) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "update tbl_sillas_temporal_data  set id_asociacion='$id_asociacion'   where   id='$id_asociacion'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}



function ListaTodosUsuario($id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select rut, nombre_completo, cargo, division from tbl_usuario where id_empresa='$id_empresa' ";		
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	

}
function  CAmbioEstadotbl_sillas_temporal_dataDadoSilla($silla, $estado) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "update tbl_sillas_temporal_data set estado='OK' where   numero='$silla' ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod; 
}




function InsertaSillaenTablaSillaConRut($numero, $cargo, $cui, $rut) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$data_rut=TraeDatosUsuario($rut);

$sql = "INSERT INTO tbl_sillas (numero, cargo, 
cui, 
rut)    
VALUES ('$numero', '$cargo', 
'$cui', 
'$rut')";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
}

function TraeSillasDadoCui($cui){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select DISTINCT(cargo), id_cargo from tbl_usuario where id_gerencia='$cui'; ";		
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	


}




function  SillasActualizaDatosDadoNumeroSinRut($numero, $cargo, $cui, $rut) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "update tbl_sillas  set  rut=null  where   numero='$numero'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}


function  SillasActualizaDatosDadoNumero($numero, $cargo, $cui, $rut) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "update tbl_sillas  set cargo='$cargo', cui='$cui', rut='$rut'  where   numero='$numero'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}





function TraeListadoUsuariosParaSillasSoloSillas($arreglo_post, $id_empresa){



global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
if($arreglo_post["division"]<>''){
$filtro_division.=" and descripcion_division='".$arreglo_post["division"]."'";
}	

if($arreglo_post["area"]<>''){
$filtro_area.=" and descripcion_area='".$arreglo_post["area"]."'";
}

if($arreglo_post["departamento"]<>''){
$filtro_departamento.=" and descripcion_departamento='".$arreglo_post["departamento"]."'";
}		

if($arreglo_post["zona"]<>''){
$filtro_zona.=" and descripcion_zona='".$arreglo_post["zona"]."'";
}	

if($arreglo_post["cui"]<>''){
$filtro_cui.=" and cui='".$arreglo_post["cui"]."'";
}	


if($arreglo_post["rut_jefatura"]<>''){
$filtro_jefatura.=" inner join tbl_usuario as base_usuario on base_usuario.rut=tbl_sillas.rut and base_usuario.jefe='".$arreglo_post["rut_jefatura"]."' ";
}	



if($arreglo_post["rut_colaborador"]<>''){
$filtro_rut_colaborador.=" and tbl_sillas.rut='".$arreglo_post["rut_colaborador"]."'";
}


$sql = "SELECT
tbl_usuario.rut,
tbl_usuario.rut_completo,
tbl_usuario.nombre_completo,
tbl_sillas.cargo,
descripcion_cargo,
tbl_usuario.vigencia_descripcion,
tbl_usuario.id_cargo,
cui,
tbl_usuario.id_gerencia,
tbl_sillas.numero, 
tbl_sillas.division,
tbl_sillas.descripcion_division,
tbl_sillas.area,
tbl_sillas.descripcion_area,
tbl_sillas.departamento,
tbl_sillas.descripcion_departamento,
tbl_sillas.zona,
tbl_sillas.descripcion_zona,
tbl_sillas.seccion,
tbl_sillas.descripcion_seccion,
tbl_sillas.oficina,
tbl_sillas.descripcion_oficina,
tbl_sillas.cui,
tbl_sillas.descripcion_cui , tbl_sillas.descripcion_cargo

FROM
tbl_sillas
left join tbl_usuario on tbl_usuario.rut=tbl_sillas.rut	

$filtro_jefatura


WHERE
tbl_sillas.id >1 
$filtro_division $filtro_area $filtro_departamento $filtro_zona $filtro_cui $filtro_rut_colaborador  order by tbl_sillas.rut asc";

//echo $sql;exit;

$database->setquery($sql); 
$database->query();
$cod = $database->listObjects();
return $cod;








}



function Filtros03($campo_filtrado1, $valor1, $campo_filtrado2, $valor2, $campo_filtrado3, $valor3, $campo_a_buscar) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
//$sql = "select distinct($campo_a_buscar) as valor  from tbl_usuario where $campo_filtrado1='$valor1' and $campo_filtrado2='$valor2' and $campo_a_buscar<>'' ";
$sql = "select distinct($campo_a_buscar) as valor  
from tbl_sillas 
where $campo_filtrado1='$valor1' 
and  $campo_filtrado2='$valor2' 
and  $campo_filtrado3='$valor3' 

and  $campo_a_buscar<>'' ";
//echo $sql;exit;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function SillasDisponiblesDadoDepartamento($departamento, $zona, $seccion, $oficina, $cargo) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_sillas where departamento='$departamento' and cargo='$cargo' and  (zona<>'$zona' and seccion<>'$seccion' and oficina<>'$oficina') and rut is null";
//echo $sql;echo "<br>";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function SillasDisponiblesDadaDivision($division, $area, $departamento, $zona, $seccion, $oficina, $cargo) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_sillas where division='$division' and cargo='$cargo' and (area<>'$area' and departamento<>'$departamento' and zona<>'$zona' and seccion<>'$seccion' and oficina<>'$oficina') and rut is null";
//echo $sql;Exit;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function SillasDisponiblesDadaArea($area, $departamento, $zona, $seccion, $oficina, $cargo) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_sillas where area='$area' and cargo='$cargo' and (departamento<>'$departamento' and zona<>'$zona' and seccion<>'$seccion' and oficina<>'$oficina') and rut is null";
//echo $sql;echo "<br>";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}


function SillasDisponiblesDadaZona($zona, $seccion, $oficina, $cargo) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_sillas where zona='$zona' and cargo='$cargo' and (seccion<>'$seccion' and oficina<>'$oficina') and  rut is null";
//echo $sql;echo "<br>";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}



function SillasDisponiblesDadaSeccion($seccion, $oficina, $cargo) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_sillas where seccion='$seccion' and cargo='$cargo' and (oficina<>'$oficina') and rut is null";

//echo $sql;echo "<br>";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}



function SillasDisponiblesDadoOficina($oficina, $cargo) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_sillas where oficina='$oficina' and cargo='$cargo' and rut is null";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}



function SILLAS_UpdateTblUsuarioCamposSillas($rut, $silla_id_cargo, $silla_cargo, $silla_id_division, 
$silla_division, $silla_id_area, $silla_area, $silla_id_departamento, $silla_departamento, 
$silla_id_zona, $silla_zona, $silla_id_seccion, $silla_seccion, $silla_id_oficina, $silla_oficina, 
$silla_id_unidad, $silla_unidad, $silla_codigo_rrhh) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "

update tbl_usuario set 

silla_id_cargo='$silla_id_cargo', 
silla_cargo='$silla_cargo', 
silla_id_division='$silla_id_division', 
silla_division='$silla_division', 
silla_id_area='$silla_id_area', 
silla_area='$silla_area', 
silla_id_departamento='$silla_id_departamento', 
silla_departamento='$silla_departamento', 
silla_id_zona='$silla_id_zona', 
silla_zona='$silla_zona', 
silla_id_seccion='$silla_id_seccion', 
silla_seccion='$silla_seccion', 
silla_id_oficina='$silla_id_oficina', 
silla_oficina='$silla_oficina', 
silla_id_unidad='$silla_id_unidad', 
silla_unidad='$silla_unidad', 
silla_codigo_rrhh='$silla_codigo_rrhh'

where rut='$rut' 

";

//echo $sql;exit;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}




function Sillas_EstaEntbl_usuarios_campos_organizacionales($rut) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_usuarios_campos_organizacionales where rut='$rut' ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}


function TotalUsuariosParaSillas() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select tbl_usuario.* from tbl_usuario inner join tbl_usuarios_campos_organizacionales on tbl_usuarios_campos_organizacionales.rut=tbl_usuario.rut";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function  ActualizoDataTemportal($rut, $id_area, $area, $descripcion_departamento, $descripcion_zona, $descripcion_oficina, $oficina) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "update tbl_sillas_temporal_data set area='$id_area', descripcion_area='$area', descripcion_departamento='$descripcion_departamento', 
descripcion_zona='$descripcion_zona', descripcion_oficina='$descripcion_oficina', oficina='$oficina' where rut='$rut'  ";

//echo $sql;exit;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod; 
}



function SillasTotalRegistrosDataTemporalDadoIDTODOTBLUSUARIO($rut) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_usuario where rut='$rut' ";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}


function SillasTotalRegistrosDataTemporalDadoIDTODO() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_sillas_temporal_data ";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}



function TraigoDatoDesdePlanSilla($campo, $arreglo_post) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
//print_r($arreglo_post);
//echo "<br><br>";
$filtros=ColocaFiltrosParaAdminSillasParaFiltrosDeBusqueda($_SESSION["admin_"]);

if($arreglo_post["division"]){
$filtro_division="  and descripcion_division='".$arreglo_post["division"]."'";
}

if($arreglo_post["area"]){
$filtro_area="  and descripcion_area='".$arreglo_post["area"]."'";
}

if($arreglo_post["departamento"]){
$filtro_departamento="  and descripcion_departamento='".$arreglo_post["departamento"]."'";
}
if($arreglo_post["zona"]){
$filtro_zona="  and descripcion_zona='".$arreglo_post["zona"]."'";
}

if($arreglo_post["seccion"]){
$filtro_seccion="  and descripcion_seccion='".$arreglo_post["seccion"]."'";
}

if($arreglo_post["oficina"]){
$filtro_oficina="  and descripcion_oficina='".$arreglo_post["oficina"]."'";
}


if($campo=="descripcion_division"){
$sql = "select distinct($campo) as valor from tbl_sillas where tbl_sillas.id>1 $filtros order by $campo asc";
}else{
$sql = "select distinct($campo) as valor from tbl_sillas where tbl_sillas.id>1  $filtros 
$filtro_division
$filtro_area 
$filtro_departamento 
$filtro_zona 
$filtro_seccion 
$filtro_oficina  
order by $campo asc";
}




$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}


function SillasDisponiblesDadoCargo($cargo) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_sillas where cargo='$cargo' and rut is null";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}




function SillasDisponiblesDadoCui($cui) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_sillas where cui='$cui' and rut is null";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}



function  CAmbioEstadotbl_sillas_temporal_data($id, $estado) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "update tbl_sillas_temporal_data set estado='$estado' where   id='$id' ";
//echo $sql;echo "<br><br>";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod; 
}



function SillasTotalVacantes() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$filtros=ColocaFiltrosParaAdminSillasDesdeTablaSillas($_SESSION["admin_"]);

$sql = "select * from tbl_sillas where rut is null  $filtros ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}



function SGD2018DeAcuerdo($evaluado) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_sgd_feedback_evaluado_2018 where evaluado='$evaluado'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}



function SillasTotalRegistrosDataTemporalDadoID($id) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_sillas_temporal_data where id='$id'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}


function concurso_lista_Vista_concurso_fn_data($id_empresa, $id){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_concurso_concurso_respuestas where id_concurso='$id' and id_empresa='$id_empresa'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	

}
function SillasTotalRegistrosDataTemporalNoHaySilla() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_sillas_temporal_data where tipo='Registro No Insertado / No existen Sillas para la combinacion Cui / Cargo' and estado is null";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}


function SillasTotalRegistrosDataTemporalPendiente() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$filtros=ColocaFiltrosParaAdminSillas($_SESSION["admin_"]);


$sql = "select * from tbl_sillas_temporal_data where (tipo='Registro No Insertado / No quedan Sillas' or tipo='Registro No Insertado / No existen Sillas para la combinacion Cui / Cargo') and estado is null $filtros";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function SillasVerificoFiltros($user) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_admin_sillas where user='$user'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}



function SillasTotalRegistrosDataTemporalOK() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$filtros=ColocaFiltrosParaAdminSillas($_SESSION["admin_"]);

$sql = "select * from tbl_sillas_temporal_data where tipo='Insertado Correctamente' and estado is null $filtros order by tbl_sillas_temporal_data.id desc";


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}


function SillasTotalRegistrosDataTemporal() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$filtros=ColocaFiltrosParaAdminSillas($_SESSION["admin_"]);

//traigo filtro.

$sql = "select * from tbl_sillas_temporal_data where tbl_sillas_temporal_data.id>1 $filtros ";

//echo $sql;exit;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}


function SillasInsertaDataTemporal($numero, 
$comentario, $rut, $cargo, $cui, $original_rut, 
$original_cargo, $original_cui, $tipo, 
$nombre, $cargo_descripcion, $division, $email, 
$descripcion_cui,
$codigo_division, 
$codigo_area, 
$descripcion_area, 
$codigo_departamento, 
$descripcion_departamento, 
$codigo_zona, 
$descripcion_zona, 
$codigo_seccion, 
$descripcion_seccion, 
$codigo_oficina, 
$descripcion_oficina, $tipo_solicitud , $id_asociacion){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db); 
$fecha = date("Y-m-d");
$hora  = date("H:i:s");
$sql   = "insert into tbl_sillas_temporal_data (numero, comentario, rut, cargo, cui, 
original_rut, original_cargo, original_cui, tipo, fecha, hora, nombre, 
cargo_descripcion, division, email, 
descripcion_cui,
codigo_division, 
area, 
descripcion_area, 
departamento, 
descripcion_departamento, 
zona, 
descripcion_zona, 
seccion, 
descripcion_seccion, 
oficina, 
descripcion_oficina, tipo_accion, id_asociacion, autor_gestor)
VALUES ('$numero', '$comentario', '$rut', '$cargo', '$cui', '$original_rut', 
'$original_cargo', '$original_cui', '$tipo', '$fecha', 
'$hora', '$nombre', '$cargo_descripcion', '$division', '$email', 
'$descripcion_cui',
'$codigo_division', 
'$codigo_area', 
'$descripcion_area', 
'$codigo_departamento', 
'$descripcion_departamento', 
'$codigo_zona', 
'$descripcion_zona', 
'$codigo_seccion', 
'$descripcion_seccion', 
'$codigo_oficina', 
'$descripcion_oficina', '$tipo_solicitud', '$id_asociacion', '".$_SESSION["admin_"]."');";

//echo $sql;Exit;			
$database->setquery($sql);
$database->query();



$sql2="SELECT MAX(id) AS id FROM tbl_sillas_temporal_data";

$database->setquery($sql2);
$database->query();

$cod = $database->listObjects();
return($cod);


}



function  SillasActualizaDatosTemporares($cui_temporal, $cargo_temporal, $rut_temporal, $cui, $cargo, $id) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
//$sql = "update tbl_sillas  set cargo_temporal='$cargo_temporal', cui_temporal='$cui_temporal', rut_temporal='$rut_temporal'  where   cui='$cui' and cargo='$cargo' limit 1 ";
//$sql = "update tbl_sillas  set cargo_temporal='$cargo_temporal', cui_temporal='$cui_temporal', rut_temporal='$rut_temporal'  where   id='$id'";
$sql = "update tbl_sillas  set cargo='$cargo_temporal', cui='$cui_temporal', rut='$rut_temporal'  where   id='$id'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}


function SillasExisteCuiCargoLimit1Disponible($cui, $cargo) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
//$sql = "select * from tbl_sillas where cargo='$cargo' and cui='$cui' and cui_temporal is null and cargo_temporal is null";
$sql = "select * from tbl_sillas where cargo='$cargo' and cui='$cui' and rut is null";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function SillasExisteCuiCargoLimit1($cui, $cargo) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_sillas where cargo='$cargo' and cui='$cui' ";
//echo $sql;exit;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}



function SillasExisteDataEnTablaTemporal(){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_sillas_temporal";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;		

}

function concurso_trae_concursos_por_grupo_data($id_empresa, $id_grupo) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if($id_grupo==""){$QGrupo="";} else {$QGrupo=" and h.id_grupo='$id_grupo' ";}

$sql = "
select h.*,
(select nombre from tbl_concurso_grupo_concurso where id=h.id_grupo) as grupo,
(select count(id) from tbl_concurso_merchandiser where id_concurso=h.id) as usuarios,
(select count(id) from tbl_concurso_merchandiser_vista where id_concurso=h.id) as visualizadores

from tbl_concurso_concurso h

where h.id_empresa='$id_empresa'
order by h.id DESC";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function concurso_trae_concurso_data($id_empresa, $id) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if($id_grupo==""){$QGrupo="";} else {$QGrupo=" and h.id_grupo='$id_grupo' ";}

$sql = "
select h.*,
(select nombre from tbl_concurso_grupo_concurso where id=h.id_grupo) as grupo,
(select count(id) from tbl_concurso_merchandiser where id_concurso=h.id) as usuarios,
(select count(id) from tbl_concurso_merchandiser_vista where id_concurso=h.id) as visualizadores

from tbl_concurso_concurso h

where h.id_empresa='$id_empresa' and id='$id'";

//echo "<br>sql $sql<br>";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}
function concurso_busca_invitacion($id, $id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_notificaciones_email where id_concurso='$id'  and id_empresa='$id_empresa'";
//echo "sql $sql";exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;		

}
function Concurso_Usuarios_Tipo_Usuario($id_empresa, $id, $tipo_usuario){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_concurso_merchandiser where id_concurso='$id'  and id_empresa='$id_empresa'";
//echo "sql $sql";exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;		
}

function Concurso_Visualizadores_Tipo_Usuario($id_empresa, $id, $tipo_usuario){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_concurso_merchandiser_vista where id_concurso='$id' and id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;		
}

function Concurso_Truncate_Usuario_Visualizador($id, $perfil){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "delete from tbl_concurso_merchandiser_vista where id_concurso='$id' and perfil='$perfil'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	

}

function Concurso_Truncate_Usuario($id){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "delete from tbl_concurso_merchandiser where id_concurso='$id'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;

}

function Concurso_Inserta_Nueva_Usuario_Tipo_Visualizador($rut, $id, $tipo_usuario, $id_empresa){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$fecha = date("Y-m-d");
$hora  = date("H:i:s");
$sql   = "insert into tbl_concurso_merchandiser_vista (rut, id_concurso, id_empresa, perfil)
VALUES ('$rut', '$id', '$id_empresa','$tipo_usuario');";
//echo "<br>$sql"; exit();
$database->setquery($sql);
$database->query();
}


function Concurso_Inserta_Nueva_Usuario_Tipo($rut, $id,  $id_empresa)
{
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$fecha = date("Y-m-d");
$hora  = date("H:i:s");
$sql   = "insert into tbl_concurso_merchandiser (rut, id_concurso, id_empresa)
VALUES ('$rut', '$id', '$id_empresa');";
//echo "<br>$sql";exit();
$database->setquery($sql);
$database->query();
}


function TraigoGlosaUnidadDadoIdGerencia($id_gerencia) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select unidad_negocio from tbl_usuario where id_gerencia='$id_gerencia'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}



function TraigoCuiDadoDivision($division) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select distinct(id_gerencia) from tbl_usuario where division='$division'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}


function TraigoCargoDadoDivision($division) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select distinct(cargo), id_cargo from tbl_usuario where division='$division'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}




function InsertaSillaenTablaSilla($numero, $cargo, $cui, $descripcion_cui, $division, $descripcion_division, $area, $descripcion_area, $departamento, $descripcion_departamento, $zona, $descripcion_zona, $seccion, $descripcion_seccion, $oficina, $descripcion_oficina, $descripcion_cargo) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$data_rut=TraeDatosUsuario($rut);

$sql = "INSERT INTO tbl_sillas (numero, cargo, 
cui, 
descripcion_cui, 
division, 
descripcion_division, 
area, 
descripcion_area, 
departamento, 
descripcion_departamento, 
zona, 
descripcion_zona, 
seccion, 
descripcion_seccion, 
oficina, 
descripcion_oficina, descripcion_cargo)    
VALUES ('$numero', '$cargo', 
'$cui', 
'$descripcion_cui', 
'$division', 
'$descripcion_division', 
'$area', 
'$descripcion_area', 
'$departamento', 
'$descripcion_departamento', 
'$zona', 
'$descripcion_zona', 
'$seccion', 
'$descripcion_seccion', 
'$oficina', 
'$descripcion_oficina', 
'$descripcion_cargo')";
//echo $sql;exit;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
}

function TraucateTablaSillas() {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "truncate tbl_sillas";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
}

function TRaeTodasLAsAudienciasPorUser($user_admin) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select tbl_sillas_admin_audiencia.*, tbl_audiencia_sillas.nombre as nombre_audiencia

from tbl_sillas_admin_audiencia  
inner join tbl_audiencia_sillas on tbl_audiencia_sillas.id=tbl_sillas_admin_audiencia.id_audiencia_silla

where tbl_sillas_admin_audiencia.admin='$user_admin' ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}


function QuitarDependenciaAdminAudiencia($user_admin, $id_audiencia){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "delete from tbl_sillas_admin_audiencia where admin='$user_admin' and  id_audiencia_silla='$id_audiencia'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;

}

function VerificaUSerAudienciaSillas($user_admin, $id_audiencia) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_sillas_admin_audiencia  where admin='$user_admin' and id_audiencia_silla='$id_audiencia'";
// echo "sql $sql";
//echo "<br><br>";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}


function AgregaDependenciaAdminAudiencia($user_admin, $id_audiencia) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$data_rut=TraeDatosUsuario($rut);

$sql = "INSERT INTO tbl_sillas_admin_audiencia (admin, id_audiencia_silla)

VALUES ('$user_admin', '$id_audiencia')";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
}


function DatosAdminDadoId($id) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_admin  where id='$id'";
//echo "sql $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}


function Prosci_Lista_Admin_dataGestores($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.* from tbl_admin h where h.id_empresa='$id_empresa' and h.acceso='119'";
//echo "sql $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}


function SillaCreaNuevoGestorData($rut, $nombre, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$data_rut=TraeDatosUsuario($rut);

$sql = "INSERT INTO tbl_admin (user, nombre, acceso, id_empresa, clave_encodeada, clave_encodeadaCryp)

VALUES ('$rut', '$nombre', '119', '78', '7efa5836f96e504af004be30fbfea2eb87c7f3913bc9700c28bd59e83533f08e', 'f5802a72271f8b203e7fa2062834d2e4659bbfa808b2097d44537f27336dbc3d')";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
}


function QueryDinamica($sql) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}


function Audiencia_Save_NuevaAudienciaSillas($nombre_audiencia,$descripcion_audiencia, 
$id_empresa, $sqlquery, $excluir, $incluir, $campos_filtros, $id_audiencia) {

global $c_host, $c_user, $c_pass, $c_db;
$rut=$_SESSION["user_"];
$fecha = date("Y-m-d");	

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$campos_filtros_enc=Encodear3($campos_filtros);

$nombre_audiencia=utf8_decode($nombre_audiencia);
$descripcion_audiencia=utf8_decode($descripcion_audiencia);

$sql="select id from tbl_audiencia_sillas order by id DESC limit 1";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
$id_next=$cod[0]->id+1;

if($id_audiencia>0){
$sql = "
update tbl_audiencia_sillas 

set nombre='$nombre_audiencia', descripcion='$descripcion_audiencia',
sqlquery='$sqlquery',excluir='$excluir',incluir='$incluir',fecha='$fecha',campos_filtros='$campos_filtros',
campos_filtros_enc='$campos_filtros_enc', editor='$rut', fecha_edicion='$fecha'

where id='$id_audiencia'

";		

TruncateRutIdAudiencia($id_audiencia);
Audiencia_Sql($sqlquery, $id_audiencia, $id_empresa);			
//exit();

} else {




$sql = "
insert into tbl_audiencia_sillas 

(id, nombre,descripcion,id_empresa,sqlquery,excluir,incluir,fecha,campos_filtros,campos_filtros_enc, autor, fecha_creacion) 

values('$id_next', '$nombre_audiencia','$descripcion_audiencia','$id_empresa','$sqlquery','$excluir','$incluir','$fecha','$campos_filtros','$campos_filtros_enc','$rut', '$fecha')
";
// AHORA NO GRABA AL MOMENTO; SINO QUE ESPERA CRON 
//TruncateRutIdAudiencia($id_next);
//Audiencia_Sql($sqlquery, $id_next,$excluir,$incluir, $id_empresa);	
//exit();		
}



$database->setquery($sql);
$database->query();
}


function lista_audiencia_dataSillas($id_empresa, $filtro_creador, $filtro_mes_ano) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);



if($filtro_creador<>""){$queryAutor=" and h.autor='$filtro_creador' ";} else {$queryAutor="";}
if($filtro_mes_ano<>""){$queryMesAno=" and EXTRACT( YEAR_MONTH FROM h.fecha ) ='$filtro_mes_ano'  ";} else {$queryMesAno="";}


$sql = "
select h.*
from tbl_audiencia_sillas h

where h.id_empresa='$id_empresa' 
$queryAutor
$queryMesAno
order by h.id DESC

";

//echo "<br>".$sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function notificaciones_email_lista_notificaciones_data($id_empresa, $id_instancia, $tipo_instancia) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

//echo "<br>notificaciones_email_lista_notificaciones_data($id_empresa, $id_instancia, $tipo_instancia<br>";exit();
if($id_instancia<>"" and $tipo_instancia<>""){
if($tipo_instancia=="Concurso"){
$sql = " select h.* from tbl_notificaciones_email h where h.id_empresa='$id_empresa' and id_concurso='$id_instancia' order by h.id DESC";    	
}
} else {
$sql = " select h.* from tbl_notificaciones_email h where h.id_empresa='$id_empresa' order by h.id DESC";	
}

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function notificaciones_email_notificaciones_data($id_notificacion, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = " select h.* from tbl_notificaciones_email h where h.id_empresa='$id_empresa' and h.id='$id_notificacion'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function notificaciones_email_notificaciones_Save_data($id, $nombre, $subject, $titulo, $texto, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "SELECT id FROM tbl_notificaciones_email WHERE id_empresa = '$id_empresa' and id='$id' order by id DESC Limit 1";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
$id = $cod[0]->id;
$nombre = utf8_decode($nombre);
$subject = utf8_decode($subject);
$titulo = utf8_decode($titulo);
$texto = utf8_decode($texto);
if ($id > 0) {
$sql = "UPDATE tbl_notificaciones_email SET nombre='$nombre',subject='$subject',titulo='$titulo',texto='$texto' WHERE id='$id' and id_empresa='$id_empresa'";
} else {
$sql = "INSERT INTO tbl_notificaciones_email (nombre,subject,titulo,texto, id_empresa) VALUES	('$nombre','$subject','$titulo','$texto','$id_empresa')";
}
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function notificaciones_email_notificaciones_usuarios_envios($id, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.*,

(select count(id) from tbl_notificaciones_email_nomina 			where id_notificacion=h.id) as usuarios,
(select count(id) from tbl_notificaciones_email_rut_envios 	where id_notificacion=h.id) as emails_enviados

from tbl_notificaciones_email h

where h.id_empresa='$id_empresa' and id='$id'";

//echo "<br>notificaciones_email_notificaciones_usuarios_envios<br>sql $sql";

$database->setquery($sql);
$database->query();

$cod = $database->listObjects();

return $cod;
}

function notificaciones_email_nombre_dado_rut_data($rut, $id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql 			= "select email, nombre_completo from tbl_usuario where rut='$rut' and id_empresa='$id_empresa'";
//echo "<br>notificaciones_email_nombre_dado_rut_data<br>$sql";exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;		
}

function notificaciones_email_descargar_usuarios_data($id_empresa, $id_notificacion){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_notificaciones_email_nomina where id_notificacion='$id_notificacion' and id_empresa='$id_empresa'";
//echo "<br>$sql";exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;		
}


function notificaciones_email_truncate_Notificaciones_Usuario($id_notificacion){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "delete from tbl_notificaciones_email_nomina where id_notificacion='$id_notificacion'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;

}

function notificaciones_email_Inserta_Nueva_Encuesta_Usuario_Tipo_Editor_Visualizador($rut, $nombre, $email, $id_notificacion, $id_empresa){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$fecha = date("Y-m-d");
$hora  = date("H:i:s");
$sql   = "insert into tbl_notificaciones_email_nomina (rut, email, nombre, id_notificacion, id_empresa)
VALUES ('$rut', '$email', '$nombre','$id_notificacion','$id_empresa');";
$database->setquery($sql);
$database->query();
}

function notificaciones_email_envios_usuarios($id_notificacion, $tipo, $id_empresa){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$fecha = date("Y-m-d");
$hora  = date("H:i:s");

if($tipo=="envio_nuevos"){
$jq=" and (select count(id) from tbl_notificaciones_email_rut_envios where rut=h.rut and id_notificacion=h.id_notificacion)='0'";
} else {
$jq="";
}

$sql   = "
select h.*, 
(select count(id) from tbl_notificaciones_email_rut_envios where rut=h.rut and id_notificacion=h.id_notificacion) as envio

from tbl_notificaciones_email_nomina h where h.id_notificacion='$id_notificacion'

$jq
";
//echo "<br>sql $sql";
$database->setquery($sql);
$database->query();

$cod = $database->listObjects();
return $cod;
}

function notificaciones_email_ActualizoEstadoEnvioCorreoPorProceso($rut, $id_notificacion, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$fecha = date("Y-m-d");
$hora  = date("H:i:s");
$sql   = "insert into tbl_notificaciones_email_rut_envios (id_notificacion, rut, id_empresa, fecha_envio)
VALUES ('$id_notificacion', '$rut', '$id_empresa','$fecha');";
//echo "<br>$sql";
$database->setquery($sql);
$database->query();
}


function  ActualizaSillaEnTablaDeSolicitudesDividir($id, $silla) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "update tbl_sillas_solicitudes_dividir set silla='$silla'  where   id='$id' ";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}


function TraigoTotalDeSillasOrigen($id) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_sillas_solicitudes where asociacion_unir='$id'"; 
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}



function TraigoTotalDeSillasDestino($id) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select tbl_sillas_solicitudes_dividir.*, 
(select cargo from tbl_usuario where id_cargo=tbl_sillas_solicitudes_dividir.cargo limit 1) as descripcion_cargo
from tbl_sillas_solicitudes_dividir where id_solicitud_silla='$id'"; 
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TraigoUltimoIdSillaDivision() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$sql = "select max(id_solicitud_silla) as valor from  tbl_sillas_solicitudes_dividir  "; 


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}



function VerificaNumeroSillaEstaOcupadaParaDividir($numero_silla) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$sql = "select * from tbl_sillas_solicitudes_dividir where silla='$numero_silla' ";


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}


function DatosDistinctCampoTblUsuarioDoble($id_empresa, $campo_descripcion, $campo_id) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select distinct($campo_id), $campo_descripcion from tbl_usuario where id_empresa='$id_empresa' and $campo_id<>'' order by $campo_id asc";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}


function Inserta_Nueva_Encuesta_Usuario_Tipo_Editor_Visualizador($rut, $id_encuesta, $tipo_usuario, $id_empresa){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$fecha = date("Y-m-d");
$hora  = date("H:i:s");
$sql   = "insert into tbl_nomina_encuesta_editor (rut, id_encuesta, id_empresa, perfil)
VALUES ('$rut', '$id_encuesta', '$id_empresa','$tipo_usuario');";
//echo "<br>$sql";
$database->setquery($sql);
$database->query();
}


function Inserta_Nueva_Encuesta_Usuario_Tipo($rut, $id_encuesta,  $id_empresa)
{
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$fecha = date("Y-m-d");
$hora  = date("H:i:s");
$sql   = "insert into tbl_nomina_encuesta (rut, id_encuesta, id_empresa)
VALUES ('$rut', '$id_encuesta', '$id_empresa');";
//echo "<br>$sql";
$database->setquery($sql);
$database->query();
}

function Inserta_Nueva_Cluster_Usuario_Tipo($rut, $id_cluster,  $id_empresa)
{
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$fecha = date("Y-m-d");
$hora  = date("H:i:s");
$sql   = "insert into rel_encuestas_cluster_usuarios (rut, id_cluster, id_empresa)
VALUES ('$rut', '$id_cluster', '$id_empresa');";
//echo "<br>$sql";
$database->setquery($sql);
$database->query();
}


function Truncate_Encuesta_Usuario_Editor_Visualizador($id_encuesta, $perfil){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "delete from tbl_nomina_encuesta_editor where id_encuesta='$id_encuesta' and perfil='$perfil'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	

}

function Truncate_Encuesta_Usuario($id_encuesta){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "delete from tbl_nomina_encuesta where id_encuesta='$id_encuesta'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;

}

function Truncate_Cluster_Usuario($id_cluster){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "delete from rel_encuestas_cluster_usuarios where id_cluster='$id_cluster'";

//echo "<br>$sql<br>";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;

}
function Lista_Encuestas_Tipo_Usuario($id_empresa, $id_encuesta, $tipo_usuario){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_nomina_encuesta where id_encuesta='$id_encuesta'  and id_empresa='$id_empresa'";
//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;		
}


function Lista_Cluster_Tipo_Usuario($id_empresa, $id_cluster, $tipo_usuario){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from rel_encuestas_cluster_usuarios where id_cluster='$id_cluster'  and id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;		
}

function Lista_Encuestas_Tipo_EditorVisualizador($id_empresa, $id_encuesta, $tipo_usuario){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_nomina_encuesta_editor where id_encuesta='$id_encuesta' and id_empresa='$id_empresa' and perfil='$tipo_usuario'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;		
}

function InsertaNuevaSillaDeDivision($silla, $cargo, $cui, $rut, $id_union)
{
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$fecha = date("Y-m-d");
$hora  = date("H:i:s");
$sql   = "insert into tbl_sillas_solicitudes_dividir (silla, cui, cargo, rut, id_solicitud_silla)
VALUES
('$silla', '$cui', '$cargo', '$rut', '$id_union');";


$database->setquery($sql);
$database->query();
}



function SillasTotalSillasDisponibles() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$sql = "select * from tbl_sillas where rut='' or rut is null ";


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function SillasTotalSillasDisponiblesLimit1() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$sql = "select * from tbl_sillas where rut='' or rut is null limit 1 ";


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function  ActualizaCuiCargoDeSilla($silla, $cui, $cargo) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$datos_organizacionales=SillasTraeDetalleDadoCui($cui);
$descripcion_cargo=SillasTraeDetalleDeCargoDeTablaSilla($cargo);

//$sql = "update tbl_sillas set cui='$cui', cargo='$cargo' where   numero='$silla' ";
$sql = "
update 
tbl_sillas 
set cui='$cui', 
cargo='$cargo', 
descripcion_cui='".$datos_organizacionales[0]->descripcion_cui."', 
division='".$datos_organizacionales[0]->division."', 
descripcion_division='".$datos_organizacionales[0]->descripcion_division."', 
area='".$datos_organizacionales[0]->area."', 
descripcion_area='".$datos_organizacionales[0]->descripcion_area."', 
departamento='".$datos_organizacionales[0]->departamento."', 
descripcion_departamento='".$datos_organizacionales[0]->descripcion_departamento."', 
zona='".$datos_organizacionales[0]->zona."', 
descripcion_zona='".$datos_organizacionales[0]->descripcion_zona."', 
seccion='".$datos_organizacionales[0]->seccion."', 

descripcion_seccion='".$datos_organizacionales[0]->descripcion_seccion."', 
oficina='".$datos_organizacionales[0]->oficina."', 
descripcion_oficina='".$datos_organizacionales[0]->descripcion_oficina."', 
descripcion_cargo='".$descripcion_cargo[0]->descripcion_cargo."'





where   numero='$silla' ";


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}


function  ActualizaCuiCargoDeSilla2($silla, $cui, $cargo, $rut) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "update tbl_sillas set cui='$cui', cargo='$cargo', rut='$rut'  where   numero='$silla' ";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeSolicitudesTodosTodos() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$sql = "select * from tbl_sillas_solicitudes ";


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}



function InsertaNuevaSilla($silla, $cargo, $cui)
{
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$fecha = date("Y-m-d");
$hora  = date("H:i:s");
$sql   = "insert into tbl_sillas (numero, cargo, cui, comentario)
VALUES
('$silla', '$cargo', '$cui', 'creado por subrecupo');";

$database->setquery($sql);
$database->query();
}




function SillasTotalSillas(){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "SELECT
tbl_sillas.*,

rut_completo,
nombre_completo,
tbl_usuario.division,
tbl_usuario.cargo AS cargo_descripcion 
FROM
tbl_sillas
LEFT JOIN tbl_usuario ON tbl_usuario.rut = tbl_sillas.rut";		
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	


}

function SillasTotalSillasUtilizadas(){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "SELECT
tbl_sillas.*,

rut_completo,
nombre_completo,
tbl_usuario.division,
tbl_usuario.cargo AS cargo_descripcion 
FROM
tbl_sillas
LEFT JOIN tbl_usuario ON tbl_usuario.rut = tbl_sillas.rut
where tbl_sillas.rut is not null";		
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	


}


function DescripcionCargoUnion($id_cargo){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select  cargo from tbl_usuario where id_cargo='$id_cargo' limit 1";		
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	


}



function DetalleAsociacionUnir($id_asociacion_unir) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$sql = "select * from tbl_sillas_solicitudes where asociacion_unir='$id_asociacion_unir'";


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function  LimpiaSilla($silla) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "update tbl_sillas set rut='', cargo='', cui='' where numero='$silla' ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}



function  AplicaRenunciaASilla($silla, $cui, $cargo) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
//$sql = "update tbl_sillas set rut='' where numero='$silla' and cargo='$cargo' and cui='$cui'";
$sql = "update tbl_sillas set rut='', cui='874' where numero='$silla' and cargo='$cargo' and cui='$cui'";


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}



function  ActualizaEstadoSolicitud($id_solicitud, $estado, $comentario_rechazo) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "update tbl_sillas_solicitudes set estado='$estado',  comentario_rechazo='$comentario_rechazo' where id='$id_solicitud'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}




function TraeSolicitudesTodosPorID($id) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$sql = "select * from tbl_sillas_solicitudes where id='$id'";


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TraeCargosDadoCui($cui){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select DISTINCT(cargo), id_cargo from tbl_usuario where id_gerencia='$cui'; ";		
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	


}


function TraeDatosDadoCui($cui){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
//$sql = "select distinct(division), area, departamento, zona, seccion, unidad_negocio from tbl_usuario where id_gerencia='$cui' ";	
$sql = "
select 
distinct(descripcion_division) as division, 
descripcion_area as area, 
descripcion_departamento as departamento, 
descripcion_zona as zona, 
descripcion_seccion as seccion, 
descripcion_cui as unidad_negocio 
from tbl_sillas where cui='$cui'

";	

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	


}
function Encuestas_BuscaRespuestasPorCadaPregunta($id_pregunta, $id_encuesta, $id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.respuesta, COUNT(h.respuesta) as cuenta_respuesta,
(select tipo from tbl_enc_elearning_preg where id_encuesta=h.id_encuesta and id_pregunta=h.id_pregunta) as tipo
from tbl_enc_elearning_respuestas h 
where h.id_encuesta='$id_encuesta' and h.id_pregunta='$id_pregunta' and h.id_empresa='$id_empresa' group by h.respuesta ";
//echo "<br>$sql<br>";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	


}

function Encuestas_BuscaRespuestasPorCadaPregunta_NoVacias($id_pregunta, $id_encuesta, $id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select count(h.id) as cuenta from tbl_enc_elearning_respuestas h where h.id_encuesta='$id_encuesta' and h.id_pregunta='$id_pregunta' and h.id_empresa='$id_empresa' and h.respuesta<>''";
//echo "<br>$sql<br>";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod[0]->cuenta;	


}


function Filtros02($campo_filtrado1, $valor1, $campo_filtrado2, $valor2, $campo_a_buscar) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
//$sql = "select distinct($campo_a_buscar) as valor  from tbl_usuario where $campo_filtrado1='$valor1' and $campo_filtrado2='$valor2' and $campo_a_buscar<>'' ";
$sql = "select distinct($campo_a_buscar) as valor  from tbl_sillas where $campo_filtrado1='$valor1' and  $campo_filtrado2='$valor2' and  $campo_a_buscar<>'' ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Trae_Preguntas_Grafico($id_encuesta, $id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = " select h.* from tbl_enc_elearning_preg h where h.id_encuesta='$id_encuesta' and id_empresa='$id_empresa' ";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	


}

function TraeRespuestas_Preguntas_Grafico($id_encuesta, $id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

echo "<br>TraeRespuestas_Preguntas_Grafic $id_encuesta";

$sql = "select distinct($campo_a_buscar) as valor  from tbl_usuario where $campo_filtrado1='$valor1' and $campo_filtrado2='$valor2' and $campo_a_buscar<>'' ";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;


}


function Filtros01($campo_filtrado, $campo_a_buscar, $valor) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
//$sql = "select distinct($campo_a_buscar) as valor  from tbl_usuario where $campo_filtrado='$valor' and $campo_a_buscar<>'' ";
$sql = "select distinct($campo_a_buscar) as valor  from tbl_sillas where $campo_filtrado='$valor' and $campo_a_buscar<>'' ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}


function UltimocodigoSilla() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
//$sql = "select max(numero) as numero_maximo from tbl_sillas ";
$sql = "select max(numero) as numero_maximo from tbl_sillas_numero_sobredotacion ";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects(); 
return $cod;  
} 

function TraeSolicitudesTodosSoloUnir() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$sql = "select distinct(asociacion_unir) from tbl_sillas_solicitudes where tipo_solicitud='Unir' ";


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}



function TraeSolicitudesTodos() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$sql = "select * from tbl_sillas_solicitudes where tipo_solicitud<>'Unir' and tipo_solicitud<>'Division' order by tbl_sillas_solicitudes.id desc"; 


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}


function TraeSolicitudesPorEstado($tipo) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
if($tipo=="Division" or $tipo=="Division_todos"){
$sql="select id, tbl_sillas_solicitudes.asociacion_unir, tipo_solicitud, arreglo_post, autor, silla_de_traslado, estado, cui_unir, fecha, hora, cargo_unir, descripcion_cui from tbl_sillas_solicitudes where asociacion_unir<>'' and tipo_solicitud='Division' GROUP BY asociacion_unir order by tbl_sillas_solicitudes.id desc";

}else if($tipo=="Unir" or $tipo=="Unir_todos"){ 
$sql="select id, tbl_sillas_solicitudes.asociacion_unir, tipo_solicitud, arreglo_post, autor, silla_de_traslado, estado, cui_unir, fecha, hora, cargo_unir, descripcion_cui from tbl_sillas_solicitudes where asociacion_unir<>'' and tipo_solicitud='Unir' GROUP BY asociacion_unir order by tbl_sillas_solicitudes.id desc";
}else{

$sql = "select * from tbl_sillas_solicitudes where tipo_solicitud='$tipo' order by tbl_sillas_solicitudes.id desc";

}

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}



function InsertarSoliocitudSillas($codigo_compuesto, $id_cargo, $cui, $silla, $rut, $rut_completo, $nombre, $cargo, $division, $tipo_solicitud, $autor, $estado, $asociacion_silla_union, $cui_union, $id_cargo_union, $arreglo_post, $fecha_accion, $comentario_accion, $rut_reemplazo, $nombre_reemplazo, $fecha_reemplazo, $etiqueta_tag, $silla_de_traslado, $desde_home, $id_solicitud_desde_home, $rut_usuario_removido, $nombre_usuario_removido)
{
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$fecha = date("Y-m-d");
$hora  = date("H:i:s");
$datos_cui=SillasTraeDatosDadoCampo("descripcion_cui", $cui);
$sql   = "insert into tbl_sillas_solicitudes 
(codigo_compuesto,id_cui,id_cargo, silla, rut, rut_completo, nombre, cargo, division, fecha, tipo_solicitud, autor, hora, estado, asociacion_unir, cui_unir, cargo_unir, arreglo_post, fecha_accion, comentario_accion, rut_reemplazo, nombre_reemplazo, fecha_reemplazo, etiqueta_tag, silla_de_traslado, cui_descripcion, desde_home, id_desde_home, rut_usuario_removido, nombre_usuario_removido)
VALUES
('$codigo_compuesto', '$cui', '$id_cargo', '$silla', '$rut', '$rut_completo', '$nombre', '$cargo', '$division', '$fecha', '$tipo_solicitud', '$autor', '$hora', '$estado', '$asociacion_silla_union', '$cui_union', '$id_cargo_union', '$arreglo_post', '$fecha_accion', '$comentario_accion', '$rut_reemplazo', '$nombre_reemplazo', '$fecha_reemplazo', '$etiqueta_tag', '$silla_de_traslado', '".$datos_cui[0]->descripcion_cui."', '$desde_home', '$id_solicitud_desde_home', '$rut_usuario_removido', '$nombre_usuario_removido');";


$database->setquery($sql);
$database->query();
}



function TraeListadoUsuariosParaSillas($arreglo_post, $id_empresa){

if($_GET["sw"]=="adminSillasGestionAccionSave"){
//print_r($arreglo_post);exit;
}
//
//exit;


global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if($arreglo_post["silla_busca"]<>''){
//$filtro_division.=" and division='".$arreglo_post["division"]."'";
//$filtro_division.=" and silla_division='".$arreglo_post["division"]."'";
$filtro_silla_busca.=" and tbl_sillas.numero='".$arreglo_post["silla_busca"]."'";
}

if($arreglo_post["division"]<>''){
//$filtro_division.=" and division='".$arreglo_post["division"]."'";
//$filtro_division.=" and silla_division='".$arreglo_post["division"]."'";
$filtro_division.=" and tbl_sillas.descripcion_division='".$arreglo_post["division"]."'";
}	

if($arreglo_post["area"]<>''){
//$filtro_area.=" and area='".$arreglo_post["area"]."'";
//$filtro_area.=" and silla_area='".$arreglo_post["area"]."'";
$filtro_area.=" and tbl_sillas.descripcion_area='".$arreglo_post["area"]."'";
}

if($arreglo_post["departamento"]<>''){
//$filtro_departamento.=" and departamento='".$arreglo_post["departamento"]."'";
//$filtro_departamento.=" and silla_departamento='".$arreglo_post["departamento"]."'";
$filtro_departamento.=" and tbl_sillas.descripcion_departamento='".$arreglo_post["departamento"]."'";
}		

if($arreglo_post["zona"]<>''){
//$filtro_zona.=" and zona='".$arreglo_post["zona"]."'";
//$filtro_zona.=" and silla_zona='".$arreglo_post["zona"]."'";
$filtro_zona.=" and tbl_sillas.descripcion_zona='".$arreglo_post["zona"]."'";
}		

if($arreglo_post["rut_jefatura"]<>''){
//$filtro_rut_jefatura.=" and jefe='".$arreglo_post["rut_jefatura"]."'";
$filtro_rut_jefatura.=" and tbl_usuario.jefe='".$arreglo_post["rut_jefatura"]."'";
}

if($arreglo_post["unidad_negocio"]<>''){		
//$filtro_cui.=" and id_gerencia='".$arreglo_post["unidad_negocio"]."'";
//$filtro_cui.=" and silla_unidad='".$arreglo_post["unidad_negocio"]."'";
$filtro_cui.=" and tbl_sillas.descripcion_cui='".$arreglo_post["unidad_negocio"]."'";
}

if($arreglo_post["rut_colaborador"]<>''){
$filtro_rut_colaborador.=" and tbl_sillas.rut='".$arreglo_post["rut_colaborador"]."'";
}
if($arreglo_post["cui"]<>''){
$filtro_cui_solo.=" and tbl_sillas.cui='".$arreglo_post["cui"]."'";
}

/*if($filtro_rut_jefatura){
$sql = "select rut, rut_completo, vigencia_descripcion, nombre_completo, cargo, id_cargo,id_gerencia, silla_unidad, silla_cargo, (select numero from tbl_sillas where tbl_sillas.rut=tbl_usuario.rut) as numero  
from tbl_usuario where id_empresa='$id_empresa' and (vigencia_descripcion is null or vigencia_descripcion=''  or vigencia_descripcion='usuario_para_silla') $filtro_division $filtro_area $filtro_departamento $filtro_zona $filtro_rut_jefatura $filtro_cui $filtro_rut_colaborador";			


}else if($filtro_cui){

$sql = "select rut, rut_completo, nombre_completo,  vigencia_descripcion,cargo, id_cargo,id_gerencia, silla_unidad, silla_cargo,(select numero from tbl_sillas where tbl_sillas.rut=tbl_usuario.rut) as numero  
from tbl_usuario where id_empresa='$id_empresa' and (vigencia_descripcion is null or vigencia_descripcion='' or vigencia_descripcion='usuario_para_silla') $filtro_division $filtro_area $filtro_departamento $filtro_zona $filtro_rut_jefatura $filtro_cui $filtro_rut_colaborador";

}else if($filtro_rut_colaborador){
$sql = "select rut, rut_completo, nombre_completo,  vigencia_descripcion,cargo, id_cargo,id_gerencia, silla_unidad, silla_cargo,(select numero from tbl_sillas where tbl_sillas.rut=tbl_usuario.rut) as numero  
from tbl_usuario where id_empresa='$id_empresa' and (vigencia_descripcion is null or vigencia_descripcion='' or vigencia_descripcion='usuario_para_silla') $filtro_division $filtro_area $filtro_departamento $filtro_zona $filtro_rut_jefatura $filtro_cui $filtro_rut_colaborador";

}else if($filtro_division){
$sql = "select rut, rut_completo, nombre_completo, cargo,  vigencia_descripcion,id_cargo,id_gerencia, silla_unidad, silla_cargo, (select numero from tbl_sillas where tbl_sillas.rut=tbl_usuario.rut) as numero  
from tbl_usuario where id_empresa='$id_empresa' and (vigencia_descripcion is null or vigencia_descripcion='' or vigencia_descripcion='usuario_para_silla') $filtro_division $filtro_area $filtro_departamento $filtro_zona $filtro_rut_jefatura $filtro_cui $filtro_rut_colaborador";


}else if($filtro_area){
$sql = "select rut, rut_completo, nombre_completo, cargo,  vigencia_descripcion,id_cargo,id_gerencia,s illa_unidad, silla_cargo, (select numero from tbl_sillas where tbl_sillas.rut=tbl_usuario.rut) as numero  
from tbl_usuario where id_empresa='$id_empresa' and (vigencia_descripcion is null or vigencia_descripcion='' or vigencia_descripcion='usuario_para_silla') $filtro_division $filtro_area $filtro_departamento $filtro_zona $filtro_rut_jefatura $filtro_cui $filtro_rut_colaborador";

}else if($filtro_zona){
$sql = "select 
rut, 
rut_completo, 
nombre_completo, 
cargo,  
vigencia_descripcion,
id_cargo,
id_gerencia, 
silla_unidad,
(select numero from tbl_sillas where tbl_sillas.rut=tbl_usuario.rut) as numero, 

from tbl_usuario where id_empresa='$id_empresa' and (vigencia_descripcion is null or vigencia_descripcion='' ) $filtro_division $filtro_area $filtro_departamento $filtro_zona $filtro_rut_jefatura $filtro_cui $filtro_rut_colaborador";



}*/


if($arreglo_post["division"]){
$sql="SELECT
tbl_sillas.rut, rut_completo, nombre_completo,
descripcion_cargo AS cargo , tbl_sillas.cargo as id_cargo, cui as id_gerencia, descripcion_cui as silla_unidad, descripcion_cargo AS silla_cargo, numero
FROM
tbl_sillas 
left join tbl_usuario on tbl_usuario.rut=tbl_sillas.rut
WHERE
tbl_sillas.id > 1
$filtro_division
$filtro_area
$filtro_departamento  
$filtro_zona
$filtro_cui
$filtro_cui_solo
$filtro_rut_colaborador
$filtro_rut_jefatura
$filtro_silla_busca order by rut asc
;";


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}else if($arreglo_post["area"]){
$sql="SELECT
tbl_sillas.rut, rut_completo, nombre_completo,
descripcion_cargo AS cargo , tbl_sillas.cargo as id_cargo, cui as id_gerencia, descripcion_cui as silla_unidad, descripcion_cargo AS silla_cargo, numero
FROM
tbl_sillas 
left join tbl_usuario on tbl_usuario.rut=tbl_sillas.rut
WHERE
tbl_sillas.id > 1
$filtro_division
$filtro_area
$filtro_departamento  
$filtro_zona
$filtro_cui
$filtro_cui_solo
$filtro_rut_colaborador
$filtro_rut_jefatura
$filtro_silla_busca order by rut asc
;"; 


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}else if($arreglo_post["departamento"]){
$sql="SELECT
tbl_sillas.rut, rut_completo, nombre_completo,
descripcion_cargo AS cargo , tbl_sillas.cargo as id_cargo, cui as id_gerencia, descripcion_cui as silla_unidad, descripcion_cargo AS silla_cargo, numero
FROM
tbl_sillas 
left join tbl_usuario on tbl_usuario.rut=tbl_sillas.rut
WHERE
tbl_sillas.id > 1
$filtro_division
$filtro_area
$filtro_departamento  
$filtro_zona
$filtro_cui
$filtro_cui_solo
$filtro_rut_colaborador
$filtro_rut_jefatura
$filtro_silla_busca order by rut asc
;";


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}else if($arreglo_post["zona"]){
$sql="SELECT
tbl_sillas.rut, rut_completo, nombre_completo,
descripcion_cargo AS cargo , tbl_sillas.cargo as id_cargo, cui as id_gerencia, descripcion_cui as silla_unidad, descripcion_cargo AS silla_cargo, numero
FROM
tbl_sillas 
left join tbl_usuario on tbl_usuario.rut=tbl_sillas.rut
WHERE
tbl_sillas.id > 1
$filtro_division
$filtro_area
$filtro_departamento  
$filtro_zona
$filtro_cui
$filtro_cui_solo
$filtro_rut_colaborador
$filtro_rut_jefatura
$filtro_silla_busca order by rut asc
;";


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}/*else if($arreglo_post["seccion"]){
$sql="SELECT
tbl_sillas.rut, rut_completo, nombre_completo,
descripcion_cargo AS cargo , tbl_sillas.cargo as id_cargo, cui as id_gerencia, descripcion_cui as silla_unidad, descripcion_cargo AS silla_cargo, numero
FROM
tbl_sillas 
inner join tbl_usuario on tbl_usuario.rut=tbl_sillas.rut
WHERE
tbl_sillas.id > 1
$filtro_division
$filtro_area
$filtro_departamento  
$filtro_zona
$filtro_cui
$filtro_cui_solo
$filtro_rut_colaborador
$filtro_rut_jefatura
;";


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}
*/
/*else if($arreglo_post["oficina"]){
$sql="SELECT
tbl_sillas.rut, rut_completo, nombre_completo,
descripcion_cargo AS cargo , tbl_sillas.cargo as id_cargo, cui as id_gerencia, descripcion_cui as silla_unidad, descripcion_cargo AS silla_cargo, numero
FROM
tbl_sillas 
inner join tbl_usuario on tbl_usuario.rut=tbl_sillas.rut
WHERE
tbl_sillas.id > 1
$filtro_division
$filtro_area
$filtro_departamento  
$filtro_zona
$filtro_cui
$filtro_cui_solo
;";


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}*/else if($arreglo_post["unidad_negocio"]){
$sql="SELECT
tbl_sillas.rut, rut_completo, nombre_completo,
descripcion_cargo AS cargo , tbl_sillas.cargo as id_cargo, cui as id_gerencia, descripcion_cui as silla_unidad, descripcion_cargo AS silla_cargo, numero
FROM
tbl_sillas 
left join tbl_usuario on tbl_usuario.rut=tbl_sillas.rut
WHERE
tbl_sillas.id > 1
$filtro_division
$filtro_area
$filtro_departamento  
$filtro_zona
$filtro_cui
$filtro_cui_solo
$filtro_rut_colaborador
$filtro_rut_jefatura
$filtro_silla_busca order by rut asc
;";


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}else if($arreglo_post["cui"]){
$sql="SELECT
tbl_sillas.rut, rut_completo, nombre_completo,
descripcion_cargo AS cargo , tbl_sillas.cargo as id_cargo, cui as id_gerencia, descripcion_cui as silla_unidad, descripcion_cargo AS silla_cargo, numero
FROM
tbl_sillas 
left join tbl_usuario on tbl_usuario.rut=tbl_sillas.rut
WHERE
tbl_sillas.id > 1
$filtro_division
$filtro_area
$filtro_departamento  
$filtro_zona
$filtro_cui
$filtro_cui_solo
$filtro_rut_colaborador
$filtro_rut_jefatura
$filtro_silla_busca order by rut asc
;";


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}else if($arreglo_post["rut_jefatura"]){
$sql="SELECT
tbl_sillas.rut, rut_completo, nombre_completo,
descripcion_cargo AS cargo , tbl_sillas.cargo as id_cargo, cui as id_gerencia, descripcion_cui as silla_unidad, descripcion_cargo AS silla_cargo, numero
FROM
tbl_sillas 
left join tbl_usuario on tbl_usuario.rut=tbl_sillas.rut
WHERE
tbl_sillas.id > 1
$filtro_division
$filtro_area
$filtro_departamento  
$filtro_zona
$filtro_cui
$filtro_cui_solo
$filtro_rut_colaborador
$filtro_rut_jefatura
$filtro_silla_busca order by rut asc
;";


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}else if($arreglo_post["rut_colaborador"]){
$sql="SELECT
tbl_sillas.rut, rut_completo, nombre_completo,
descripcion_cargo AS cargo , tbl_sillas.cargo as id_cargo, cui as id_gerencia, descripcion_cui as silla_unidad, descripcion_cargo AS silla_cargo, numero
FROM
tbl_sillas 
left join tbl_usuario on tbl_usuario.rut=tbl_sillas.rut
WHERE
tbl_sillas.id > 1
$filtro_division
$filtro_area
$filtro_departamento  
$filtro_zona
$filtro_cui
$filtro_cui_solo
$filtro_rut_colaborador
$filtro_rut_jefatura
$filtro_silla_busca order by rut asc
;";


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}else if($arreglo_post["silla_busca"]){
$sql="SELECT
tbl_sillas.rut, rut_completo, nombre_completo,
descripcion_cargo AS cargo , tbl_sillas.cargo as id_cargo, cui as id_gerencia, descripcion_cui as silla_unidad, descripcion_cargo AS silla_cargo, numero
FROM
tbl_sillas 
left join tbl_usuario on tbl_usuario.rut=tbl_sillas.rut
WHERE
tbl_sillas.id > 1
$filtro_division
$filtro_area
$filtro_departamento  
$filtro_zona
$filtro_cui
$filtro_cui_solo
$filtro_rut_colaborador
$filtro_rut_jefatura
$filtro_silla_busca order by rut asc
;";


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}











} 

function TraeCargosDadoDivision($division){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select DISTINCT(cargo), id_cargo from tbl_usuario where division='$division' order by cargo asc; ";		

$database->setquery($sql); 
$database->query();
$cod = $database->listObjects();
return $cod;	


}

function DatosDistinctCampoTblUsuario($id_empresa, $campo) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select distinct($campo) as valor from tbl_usuario where id_empresa='$id_empresa' and $campo<>'' order by $campo asc";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function ResumenSillas($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$filtros=ColocaFiltrosParaAdminSillasDesdeTablaSillasDesdeTblUsuario($_SESSION["admin_"]);
$filtros_tabla_silla=ColocaFiltrosParaAdminSillasDesdeTablaSillas($_SESSION["admin_"]);


$sql = "select count(id) as total, 
(select count(id) as total from tbl_sillas_solicitudes  )  as total_solicitudes, 
(select count(id) as total from tbl_sillas_solicitudes where tipo_solicitud='Eliminar' ) as total_solicitudes_eliminadas, 
(select count(id) as total from tbl_sillas where numero is not null and (rut='' or rut is null) $filtros_tabla_silla) as total_sillas_disponibles, 
(select count(id) as total from tbl_sillas where numero is not null and (rut is not null and rut <>'') $filtros_tabla_silla) as total_sillas_ocupadas, 
(select count(id) as total from tbl_sillas where numero is not null $filtros_tabla_silla) as total_sillas_total
from tbl_usuario where id_empresa='$id_empresa' ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}


function Prosci_truncateEncuestasIdProyecto_data($rut, $id_encuesta, $id_proyecto, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT count(id) as cuenta from tbl_prosci_encuestas_usuarios where rut='$rut' and nombre_completo='' and id_encuesta='$id_encuesta' and id_proyecto='$id_proyecto'";
//echo "sql $sql";exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

if($cod[0]->cuenta>0){
$sql2="delete from tbl_prosci_encuestas_usuarios where id_proyecto='$id_proyecto' and id_encuesta='$id_encuesta' and rut='$rut'";
////exit();
$database->setquery($sql2);
$database->query();
}
}

function Prosci_truncateEncuestasIdProyectoFull_data($id_encuesta, $id_proyecto, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql2="delete from tbl_prosci_encuestas_usuarios where id_proyecto='$id_proyecto' and id_encuesta='$id_encuesta' ";
////exit();
$database->setquery($sql2);
$database->query();

}


function Prosci_truncateEncuestasIdProyecto_VISUALIZADORESdata($rut, $id_encuesta, $id_proyecto, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT count(id) as cuenta from rel_prosci_usuarios_visualizadores where rut='$rut' and id_proyecto='$id_proyecto'";
//echo "sql $sql";exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

if($cod[0]->cuenta>0){
$sql2="delete from rel_prosci_usuarios_visualizadores where id_proyecto='$id_proyecto'  and rut='$rut'";
////exit();
$database->setquery($sql2);
$database->query();
}
}


function Prosci_truncateEncuestasIdProyecto_Full_VISUALIZADORESdata($id_encuesta, $id_proyecto, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);



$sql2="delete from rel_prosci_usuarios_visualizadores where id_proyecto='$id_proyecto' ";

$database->setquery($sql2);
$database->query();

}


function Prosci_SaveUsuariosEncuestasIdProyectoVISUALIZADORES_data($rut, $id_encuesta, $id_proyecto, $id_empresa, $nombre, $cargo, $division, $fecha_inscripcion) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT count(id) as cuenta from rel_prosci_usuarios_visualizadores where rut='$rut' and id_proyecto='$id_proyecto'";
//echo "sql $sql";exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
if($cod[0]->cuenta=="0"){
$sql = "
INSERT INTO rel_prosci_usuarios_visualizadores (id_proyecto, rut, id_empresa,  fecha)

VALUES ('$id_proyecto',  '$rut', '$id_empresa', '$fecha_inscripcion')";


//echo "<br>. sql $sql";exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
}
}


function Prosci_SaveUsuariosEncuestasIdProyecto_data($rut, $id_encuesta, $id_proyecto, $id_empresa, $nombre, $cargo, $division, $fecha_inscripcion) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT count(id) as cuenta from tbl_prosci_encuestas_usuarios where rut='$rut' and id_encuesta='$id_encuesta' and id_proyecto='$id_proyecto'";
//echo "sql $sql";exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
if($cod[0]->cuenta=="0"){
$sql = "
INSERT INTO tbl_prosci_encuestas_usuarios (id_proyecto, id_encuesta, rut, id_empresa,  fecha)

VALUES ('$id_proyecto', '$id_encuesta', '$rut', '$id_empresa', '$fecha_inscripcion')";


//echo "<br>. sql $sql";exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
}
}
function Prosci_SaveNuevoAdmin_data($rut, $clave, $acceso, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$data_rut=TraeDatosUsuario($rut);

$clave_enc=Encriptar($clave);
//echo "<br> Prosci_SaveNuevoAdmin_data <br> $rut, $clave, $acceso, $id_empresa, clave enc $clave_enc<br>";

$sql = "delete  from tbl_admin where user='$rut'";
//echo "<br>sql $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//print_r($cod);

$sql2 = "delete  from tbl_prosci_admin_super where rut='$rut'";
//echo "<br>sql2 $sql2";
$database->setquery($sql2);
$database->query();
$cod2 = $database->listObjects();
//print_r($cod2);

$sql3 = "delete  from tbl_prosci_admin where rut='$rut'";
//echo "<br>sql3 $sql3";
$database->setquery($sql3);
$database->query();
$cod3 = $database->listObjects();
//print_r($cod3);

if($acceso=="SuperAdministrador"){

$sql = " INSERT INTO tbl_prosci_admin (rut, id_empresa, nombre_completo, cargo, division, acceso) VALUES ('$rut','$id_empresa',     '" . ($data_rut[0]->nombre_completo) . "',    '" . ($data_rut[0]->cargo) . "',    '" . ($data_rut[0]->division) . "',    '$acceso')";
$database->setquery($sql);
$database->query();

$sql = " INSERT INTO tbl_admin (user, nombre, acceso, id_empresa, clave_encodeada)    
VALUES ('$rut','$rut','125', '$id_empresa',     '" . ($clave_enc) . "')";
$database->setquery($sql);
//echo $sql;
$database->query();

}

if($acceso=="Administrador"){

$sql = " INSERT INTO tbl_prosci_admin (rut, id_empresa, nombre_completo, cargo, division, acceso)    VALUES ('$rut','$id_empresa',     '" . ($data_rut[0]->nombre_completo) . "',    '" . ($data_rut[0]->cargo) . "',    '" . ($data_rut[0]->division) . "',    '$acceso')";
$database->setquery($sql);
$database->query();
$sql = " INSERT INTO tbl_admin (user, nombre, acceso, id_empresa, clave_encodeada)    
VALUES ('$rut','$rut','118', '$id_empresa',     '" . ($clave_enc) . "')";
$database->setquery($sql);
$database->query();

}





$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
}

function Prosci_Lista_Inscripciones_Proyecto_data($id_empresa, $id_proyecto, $otro) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "SELECT h.*, 
(select nombre from tbl_enc_elearning where id=h.id_encuesta) as nombre,
(select unusuario from tbl_enc_elearning where id=h.id_encuesta) as unusuario,
(select orden from tbl_enc_elearning where id=h.id_encuesta) as orden,
(select COUNT(DISTINCT rut) from tbl_prosci_encuestas_usuarios where id_encuesta=h.id_encuesta and id_proyecto='$id_proyecto') as usuarios

FROM tbl_prosci_rel_encuestas_proyecto h 

WHERE h.id_proyecto='$id_proyecto'

order by (select orden from tbl_enc_elearning where id=h.id_encuesta) ASC
";

//echo "<br>sql $sql<br>";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}


function Prosci_Lista_Inscripciones_Proyecto_Visualizadores_data($id_empresa, $id_proyecto, $otro) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "SELECT h.*, 
(select COUNT(DISTINCT rut) from rel_prosci_usuarios_visualizadores where id_proyecto='$id_proyecto') as visualizadores

FROM tbl_prosci_proyecto h 

WHERE h.id_proyecto='$id_proyecto'";

//echo "<br>sql $sql<br>";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Prosci_Lista_Proyectos_data($id_empresa,$perfil,$rut) {

//echo "<br>DATA <br> function Prosci_Lista_Proyectos_data(id empresa $id_empresa, perfil $perfil, rut $rut)";
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


if($perfil=="Administrador") 				{ $JQ_A=" and h.admin='$rut'";}
if($perfil=="SuperAdministrador") 	{ $JQ_A=" ";}

$sql = "select h.*, (select nombre_completo from tbl_prosci_admin where rut=h.admin) as nombre_completo,
(select COUNT(DISTINCT rut) from tbl_prosci_encuestas_usuarios where id_proyecto=h.id_proyecto) as usuarios,
(select COUNT(DISTINCT rut) from rel_prosci_usuarios_visualizadores where id_proyecto=h.id_proyecto ) as visualizadores

from tbl_prosci_proyecto h where h.id_empresa='$id_empresa'
$JQ_A

order by id DESC";
//echo "sql $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Prosci_DescargarRespuestasPorIdProyecto_data($id_proyecto, $id_empresa){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "

select h.rut,
(select nombre_completo from tbl_prosci_encuestas_usuarios where rut=h.rut and id_proyecto=h.id_foco and id_encuesta=h.id_encuesta) as nombre,
(select cargo from tbl_prosci_encuestas_usuarios where rut=h.rut and id_proyecto=h.id_foco and id_encuesta=h.id_encuesta) as cargo,
(select division from tbl_prosci_encuestas_usuarios where rut=h.rut and id_proyecto=h.id_foco and id_encuesta=h.id_encuesta) as division,
(select fecha from tbl_prosci_encuestas_usuarios where rut=h.rut and id_proyecto=h.id_foco and id_encuesta=h.id_encuesta) as fecha_inscripcion,
h.fecha as fecha_respuesta,
h.id_foco as IdProyecto,
(select nombre from tbl_prosci_proyecto where id_proyecto=h.id_foco) as Proyecto,
h.id_encuesta as IdEncuesta,
(select nombre from tbl_enc_elearning_medicion where id=h.id_encuesta) as Encuesta,
h.id_pregunta as IdPregunta,
(select pregunta from tbl_enc_elearning_preg where id_pregunta=h.id_pregunta and id_encuesta=h.id_encuesta) as Pregunta,
h.respuesta,
h.comentario

from tbl_enc_elearning_respuestas h

where h.id_foco='$id_proyecto' and h.id_empresa='$id_empresa'
order by h.id_encuesta, h.rut

";
//echo "sql $sql"; exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	
}

function Prosci_DescargarInscritosPorCuestionarioIdProyecto_data($id_proyecto, $id_encuesta, $id_empresa){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.*, (select nombre from tbl_enc_elearning where id=h.id_encuesta) as encuesta

from tbl_prosci_encuestas_usuarios h 
where h.id_empresa='$id_empresa' 
and h.id_proyecto='$id_proyecto' and id_encuesta='$id_encuesta'";
// echo "sql $sql"; exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	
}


function Prosci_DescargarInscritosPorCuestionarioSoloIdProyecto_data($id_proyecto,  $id_empresa){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.*,(select nombre from tbl_enc_elearning where id=h.id_encuesta) as encuesta
from tbl_prosci_encuestas_usuarios h 
where h.id_empresa='$id_empresa' 
and h.id_proyecto='$id_proyecto' ";
//echo "sql $sql"; exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	
}
function Prosci_DescargarInscritosPorCuestionarioIdProyecto_Visualizadoresdata($id_proyecto,  $id_empresa){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.*
from rel_prosci_usuarios_visualizadores h 
where h.id_empresa='$id_empresa' 
and h.id_proyecto='$id_proyecto'";
//echo "sql $sql"; exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	
}


function Prosci_Lista_Proyectos_DadoId_data($id_proyecto, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.*, (select nombre_completo from tbl_prosci_admin where rut=h.admin) as nombre_completo 
from tbl_prosci_proyecto h 
where h.id_empresa='$id_empresa' and h.id_proyecto='$id_proyecto'";
//echo "sql $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}


function Prosci_Lista_Admin_Perfil_data($rut, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.* from tbl_prosci_admin h where h.rut='$rut' and h.id_empresa='$id_empresa' order by h.nombre_completo ASC";
//echo "sql $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}
function Prosci_Lista_Admin_data($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.* from tbl_prosci_admin h where h.id_empresa='$id_empresa' order by h.nombre_completo ASC";
//echo "sql $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}


function Prosci_Lista_Admin_SuperAdmin_data($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.* from tbl_prosci_admin h where h.id_empresa='$id_empresa' order by h.nombre_completo ASC";
//echo "sql $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Prosci_SaveNuevoProyecto_data($nombre_proyecto, $administrador, $rut, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql 					= "select id from tbl_prosci_proyecto order by id DESC limit 1";
$database->setquery($sql);
$database->query();
$cod2 				= $database->listObjects();

$id_nuevo 		= $cod2[0]->id + 1;
$id_proyecto	=	"prosci_".$id_nuevo;

$fecha 				= date("Y-m-d");
$tiempo 			= date("H:m:s");

$sql = "
INSERT INTO tbl_prosci_proyecto (id, nombre, descripcion, rut, fecha, hora, id_empresa, id_proyecto, admin)
VALUES ('$id_nuevo', '".utf8_decode($nombre_proyecto)."','', '".($rut)."',
'$fecha', '$tiempo', '$id_empresa', '$id_proyecto', '".$administrador."')";
//echo "sql $sql";exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

$sql_3			= " select * from tbl_prosci_proyecto order by id DESC limit 1";
$database->setquery($sql_3);
$database->query();
$cod3 				= $database->listObjects();    
//print_r($cod3);

$sql = "INSERT INTO tbl_prosci_rel_encuestas_proyecto (id_proyecto, id_encuesta, id_empresa, grafico)   VALUES ('".$cod3[0]->id_proyecto."', '36','".$id_empresa."', 'triangulo1')";
$database->setquery($sql); $database->query();   
//echo "<br>"
$sql = "INSERT INTO tbl_prosci_rel_encuestas_proyecto (id_proyecto, id_encuesta, id_empresa, grafico)   VALUES ('".$cod3[0]->id_proyecto."', '37','".$id_empresa."', 'triangulo2')";
$database->setquery($sql); $database->query();   
$sql = "INSERT INTO tbl_prosci_rel_encuestas_proyecto (id_proyecto, id_encuesta, id_empresa, grafico)   VALUES ('".$cod3[0]->id_proyecto."', '38','".$id_empresa."', 'triangulo3')";
$database->setquery($sql); $database->query();   
$sql = "INSERT INTO tbl_prosci_rel_encuestas_proyecto (id_proyecto, id_encuesta, id_empresa, grafico)   VALUES ('".$cod3[0]->id_proyecto."', '39','".$id_empresa."', 'cuadrante1')";
$database->setquery($sql); $database->query();   

$sql = "INSERT INTO tbl_prosci_rel_encuestas_proyecto (id_proyecto, id_encuesta, id_empresa, grafico)   VALUES ('".$cod3[0]->id_proyecto."', '41','".$id_empresa."', 'cuadrante2')";
$database->setquery($sql); $database->query();   

$sql = "INSERT INTO tbl_prosci_rel_encuestas_proyecto (id_proyecto, id_encuesta, id_empresa, grafico)   VALUES ('".$cod3[0]->id_proyecto."', '55','".$id_empresa."', 'principal_responsable')";
$database->setquery($sql); $database->query();   

$sql = "INSERT INTO tbl_prosci_rel_encuestas_proyecto (id_proyecto, id_encuesta, id_empresa, grafico)   VALUES ('".$cod3[0]->id_proyecto."', '56','".$id_empresa."', '')";
$database->setquery($sql); $database->query();   

$sql = "INSERT INTO tbl_prosci_rel_encuestas_proyecto (id_proyecto, id_encuesta, id_empresa, grafico)   VALUES ('".$cod3[0]->id_proyecto."', '57','".$id_empresa."', '')";
$database->setquery($sql); $database->query();   

$sql = "INSERT INTO tbl_prosci_rel_encuestas_proyecto (id_proyecto, id_encuesta,id_empresa, grafico)   VALUES ('".$cod3[0]->id_proyecto."', '58','".$id_empresa."', '')";
$database->setquery($sql); $database->query();   

}

function TotalUsuariosCompraCartera($id_objeto, $id_malla){


global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql=" SELECT
rel_lms_malla_persona.rut, 
rel_lms_malla_persona.opcional, 
nombre_completo, 
cargo, 
email, 
division, 
area as gerencia, 
zona, 
sucursal, 
local as cui, 
unidad_negocio, 
(select json_completo from tbl_json_ext where tbl_json_ext.rut=rel_lms_malla_persona.rut and tbl_json_ext.id_objeto='$id_objeto' order by id desc limit 1) as json,
(select fecha from tbl_json_ext where tbl_json_ext.rut=rel_lms_malla_persona.rut and tbl_json_ext.id_objeto='$id_objeto' order by id desc limit 1) as fecha

FROM
rel_lms_malla_persona 

inner join tbl_usuario on tbl_usuario.rut=rel_lms_malla_persona.rut
WHERE
rel_lms_malla_persona.id_malla = '$id_malla' ; ";


//echo $sql;exit;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;	


}



function DatosResultados2018($rut){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql=" select * from tbl_sgd_reporte_full_2018 where evaluado='$rut' and subperfil='DESCENDENTE'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	
}



function DatosEncuestafinalSGDDadoRut($rut){


global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql="SELECT
evaluado,
nombre_completo, 
cargo, 
division, 
email, 
preg6,
preg7,
comentarios_finales, 
(select preg6 from tbl_sgd_enc_satis where tbl_sgd_enc_satis.evaluado=tbl_sgd_feedback_evaluado.evaluado limit 1) as preg1_enc, 
(select preg7 from tbl_sgd_enc_satis where tbl_sgd_enc_satis.evaluado=tbl_sgd_feedback_evaluado.evaluado limit 1) as preg2_enc, 
(select telefono_fijo from tbl_sgd_enc_satis where tbl_sgd_enc_satis.evaluado=tbl_sgd_feedback_evaluado.evaluado limit 1) as telefono_fijo_enc, 
(select celular from tbl_sgd_enc_satis where tbl_sgd_enc_satis.evaluado=tbl_sgd_feedback_evaluado.evaluado limit 1) as celular_enc, 
(select preg8 from tbl_sgd_enc_satis where tbl_sgd_enc_satis.evaluado=tbl_sgd_feedback_evaluado.evaluado limit 1) as preg3_enc



FROM
tbl_sgd_feedback_evaluado
inner join tbl_usuario on tbl_usuario.rut=tbl_sgd_feedback_evaluado.evaluado

where tbl_sgd_feedback_evaluado.evaluado='$rut'
";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;	


}



function ReportesAutomaticosBuscaUltimasFechas($id_empresa){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);	

$sql	=	"select h.fecha  from tbl_lms_reportes_full_files h where h.id_empresa='$id_empresa' group by h.fecha order by h.fecha DESC LIMIT 12";
//echo "<br>sql $sql<br>";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;	
}

function ReportesAutomaticosBuscaLineas($fecha, $id_empresa){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);	

$sql	=	"select h.*  from tbl_lms_reportes_full_files h where h.fecha='$fecha' and h.id_empresa='$id_empresa' order by nombre";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;		
}
function DatosEncuestafinalSGD(){


global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql="SELECT
evaluado,
nombre_completo, 
cargo, 
division, 
email, 
preg6,
preg7,
comentarios_finales, 
(select preg6 from tbl_sgd_enc_satis where tbl_sgd_enc_satis.evaluado=tbl_sgd_feedback_evaluado.evaluado limit 1) as preg1_enc, 
(select preg7 from tbl_sgd_enc_satis where tbl_sgd_enc_satis.evaluado=tbl_sgd_feedback_evaluado.evaluado limit 1) as preg2_enc, 
(select telefono_fijo from tbl_sgd_enc_satis where tbl_sgd_enc_satis.evaluado=tbl_sgd_feedback_evaluado.evaluado limit 1) as telefono_fijo_enc, 
(select celular from tbl_sgd_enc_satis where tbl_sgd_enc_satis.evaluado=tbl_sgd_feedback_evaluado.evaluado limit 1) as celular_enc, 
(select preg8 from tbl_sgd_enc_satis where tbl_sgd_enc_satis.evaluado=tbl_sgd_feedback_evaluado.evaluado limit 1) as preg3_enc



FROM
tbl_sgd_feedback_evaluado
inner join tbl_usuario on tbl_usuario.rut=tbl_sgd_feedback_evaluado.evaluado";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;	


}


function SimuladoresAvanceCierre($rut, $id_curso){


global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql="select avance from tbl_inscripcion_cierre where rut='$rut' and id_curso='$id_curso';";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;	


}

function AvanceSimuladoresObjetoFinalizadoRut($rut, $id_objeto){


global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql="select id from tbl_objetos_finalizados where id_objeto='$id_objeto' and rut='$rut'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;	


}

function TotalUsuariosInscritosMallaSimuladores(){


global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql="select rel_lms_malla_persona.rut, tbl_usuario.nombre_completo, tbl_usuario.cargo, tbl_usuario.division, tbl_usuario.email,tbl_usuario.zona,tbl_usuario.area

from rel_lms_malla_persona 

inner join tbl_usuario on tbl_usuario.rut=rel_lms_malla_persona.rut

where id_malla='bch_simban'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;	


}

function ListadoCursosSimuladores22(){


global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql="SELECT
tbl_lms_programas_bbdd.id_programa, rel_lms_malla_curso.id_curso, tbl_lms_curso.nombre as nombre_curso
FROM
tbl_lms_programas_bbdd
inner join rel_lms_malla_curso on rel_lms_malla_curso.id_programa=tbl_lms_programas_bbdd.id_programa
inner join tbl_lms_curso on tbl_lms_curso.id=rel_lms_malla_curso.id_curso
WHERE
tbl_lms_programas_bbdd.id_programa = 'bch_simban';

select rel_lms_malla_persona.rut, tbl_usuario.nombre_completo, tbl_usuario.cargo, tbl_usuario.division, tbl_usuario.email, 


from rel_lms_malla_persona 

inner join tbl_usuario on tbl_usuario.rut=rel_lms_malla_persona.rut

where id_malla='bch_simban'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;	


}


function ListadoObjetosSimuladores(){


global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql="SELECT
tbl_lms_programas_bbdd.id_programa, rel_lms_malla_curso.id_curso, tbl_objeto.id as id_objeto, tbl_objeto.titulo
FROM
tbl_lms_programas_bbdd
inner join rel_lms_malla_curso on rel_lms_malla_curso.id_programa=tbl_lms_programas_bbdd.id_programa
inner join tbl_objeto on tbl_objeto.id_curso=rel_lms_malla_curso.id_curso
WHERE
tbl_lms_programas_bbdd.id_programa = 'bch_simban';";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;	


}



function SGD_Reporte2019MT(){


global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql="SELECT DISTINCT
(tbl_sgd_relaciones.evaluado),
tbl_usuario.nombre_completo, 
tbl_usuario.cargo, 
tbl_usuario.email, 
tbl_usuario.division, 
tbl_usuario.area as gerencia, 
tbl_usuario.zona, 
tbl_usuario.departamento, 
tbl_usuario.sucursal as oficina, 
tbl_usuario.regional as region, 
tbl_usuario.unidad_negocio as unidad_negocio, 
(select a.evaluador from tbl_sgd_relaciones as a where a.evaluado=tbl_sgd_relaciones.evaluado and subperfil='23') as rut_evaluador, 
b.nombre_completo as nombre_evaluador, 
b.cargo as cargo_evaluador, 
b.email as email_evaluador, 
b.division as division_evaluador, 
b.area as area_evaluador, 
-- (select tbl_sgd_finalizados_evaluado_evaluador_ae.id from tbl_sgd_finalizados_evaluado_evaluador_ae where tbl_sgd_relaciones.evaluado=tbl_sgd_finalizados_evaluado_evaluador_ae.evaluado ) as id_ae
tbl_sgd_finalizados_evaluado_evaluador_ae.id as id_ae, 
(select count(id) as total from tbl_sgd_relaciones as c where c.evaluado=tbl_sgd_relaciones.evaluado and c.subperfil='24') as total_lo_evaluan_ascendente, 
(SELECT
count(d.id) as total_eval_me_han_realizado
FROM
tbl_sgd_relaciones as d

inner join tbl_sgd_finalizados_evaluado_evaluador  as e on e .evaluado=d.evaluado and e .evaluador=d.evaluador
WHERE
d.evaluado = tbl_sgd_relaciones.evaluado
AND d.subperfil = '24') as total_eval_asc_me_han_hecho, 

(SELECT
count(f.id) as total_eval_me_han_realizado
FROM
tbl_sgd_relaciones as f

inner join tbl_sgd_finalizados_evaluado_evaluador as g on g.evaluado=f.evaluado and g.evaluador=f.evaluador
WHERE
f.evaluado = tbl_sgd_relaciones.evaluado
AND f.subperfil = '23') as me_hicieron_eval_desc, 
(select validado from tbl_sgd_validacion_evaluacion as h where h.evaluado=tbl_sgd_relaciones.evaluado and validado='si') as registro_validacion_evaluacion, 
(select plan_finalizado from tbl_sgd_plan_accion_finalizado as i where i.evaluado=tbl_sgd_relaciones.evaluado ) as plan_accion_finalizado, 
(select validado from tbl_sgd_retroalimentacion as j where j.evaluado=tbl_sgd_relaciones.evaluado and validado='si' limit 1) as retro_realizada, 
(select id from tbl_sgd_enc_satis where tbl_sgd_enc_satis.evaluado=tbl_sgd_relaciones.evaluado limit 1) as vio_informe

FROM
tbl_sgd_relaciones
INNER JOIN tbl_usuario ON tbl_usuario.rut = tbl_sgd_relaciones.evaluado
inner join tbl_usuario as b on b.rut=(select a.evaluador from tbl_sgd_relaciones as a where a.evaluado=tbl_sgd_relaciones.evaluado and subperfil='23')
left join tbl_sgd_finalizados_evaluado_evaluador_ae on tbl_sgd_finalizados_evaluado_evaluador_ae.evaluado=tbl_sgd_relaciones.evaluado
";

//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;	


}

function BuscaAscRel2019Finalizado($evaluado, $evaluador){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql="

select id as id_asc from tbl_sgd_finalizados_evaluado_evaluador where evaluador='$evaluado' and evaluado='$evaluador'

";
//echo "sql $sql";exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod[0]->id_asc;	

}

function VerificaEvalFinalizadaAdmin($evaluado, $evaluador){


global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql="select * from tbl_sgd_finalizados_evaluado_evaluador where evaluado='$evaluado' and evaluador='$evaluador'";

//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;	


}




function Innova_Save_Juez($rut,$proceso,$id_empresa)
{
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$fecha = date("Y-m-d");
$hora  = date("H:i:s");
$sql   = "insert into tbl_innova_jueces (rut,proceso,id_empresa)
VALUES
('$rut','$proceso','$id_empresa');";
//echo "sql $sql"; exit();
$database->setquery($sql);
$database->query();
}



function Innova_Del_Juez($rut_juez,$proceso,$id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$fecha = date("Y-m-d");
$sql = "delete from tbl_innova_jueces where rut='$rut_juez' and proceso='$proceso' and id_empresa='$id_empresa'";	
//echo $sql;exit;
$database->setquery($sql);
$database->query();	

}

function Innova_Save_JuezGerente($rut,$proceso,$id_empresa)
{
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$fecha = date("Y-m-d");
$hora  = date("H:i:s");
$sql   = "insert into tbl_innova_jueces_gerentes (rut,proceso,id_empresa)
VALUES
('$rut','$proceso','$id_empresa');";
//echo "sql $sql"; exit();
$database->setquery($sql);
$database->query();
}



function Innova_Del_JuezGerente($rut_juez,$proceso,$id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$fecha = date("Y-m-d");
$sql = "delete from tbl_innova_jueces_gerentes where rut='$rut_juez' and proceso='$proceso' and id_empresa='$id_empresa'";	
//echo $sql;exit;
$database->setquery($sql);
$database->query();	

}

function lista_jueces_data($id_empresa, $proceso){


global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql="
select h.*, (select nombre_completo from tbl_usuario where rut=h.rut) as nombre_completo,

(select count(id) from tbl_innova_evaluacion where rut=h.rut) as evaluadas,
(select count(id) from tbl_innova_ideas where estado='Preseleecionada') as totalideas

from tbl_innova_jueces h where h.proceso='$proceso' and id_empresa='$id_empresa'
";

//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;	


}

function lista_jueces_gerentes_data($id_empresa, $proceso){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql="
select h.*, (select nombre_completo from tbl_usuario where rut=h.rut) as nombre_completo,

(select count(id) from tbl_innova_evaluacion_gerentes where rut=h.rut) as evaluadas,
(select count(id) from tbl_innova_ideas where estado='Seleccionada') as totalideas

from tbl_innova_jueces_gerentes h where h.proceso='$proceso' and id_empresa='$id_empresa'
";

//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;	



}

function BuscaAnosAudiencia($id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql="

SELECT 

EXTRACT( YEAR_MONTH FROM fecha ) as mes_ano 

FROM tbl_audiencia 

group by EXTRACT( YEAR_MONTH FROM fecha ) ASC;

";

//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;	

}

function BuscaAnosDocumentos($id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql="

SELECT 

EXTRACT( YEAR_MONTH FROM fecha ) as mes_ano 

FROM tbl_audiencia_documentos

group by EXTRACT( YEAR_MONTH FROM fecha ) ASC;

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;	

}



function BuscaAnosPublicaciones($id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql="

SELECT 

EXTRACT( YEAR_MONTH FROM fecha_inicio ) as mes_ano 

FROM tbl_audiencia_publicaciones 

group by EXTRACT( YEAR_MONTH FROM fecha_inicio ) ASC;

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;

}

function BuscaCreadoresPublicaciones($id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);	


$sql="SELECT h.*, 
(select nombre_completo from tbl_usuario where rut=h.autor) as nombre_completo

FROM tbl_audiencia_publicaciones h
where h.autor<>''

group by h.autor 


order by (select nombre_completo from tbl_usuario where rut=h.autor) ASC";	


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;	
}


function BuscaCreadoresAudiencias($id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);	


$sql="SELECT h.*, 
(select nombre_completo from tbl_usuario where rut=h.autor) as nombre_completo

FROM tbl_audiencia h
where h.autor<>''

group by h.autor 


order by (select nombre_completo from tbl_usuario where rut=h.autor) ASC";	


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;	
}

function BuscaCreadoresDocumentos($id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);	


$sql="SELECT h.*, 
(select nombre_completo from tbl_usuario where rut=h.autor) as nombre_completo

FROM tbl_audiencia_documentos h
where h.autor<>''

group by h.autor 


order by (select nombre_completo from tbl_usuario where rut=h.autor) ASC";	


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;	
}


function BorraRegistroValidacionCalibracion($evaluado, $evaluador, $id_proceso){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$fecha = date("Y-m-d");
$sql = "delete from tbl_sgd_validacion_evaluacion where evaluado='$evaluado' and evaluador='$evaluador' and id_proceso='$id_proceso'";	
//echo $sql;exit;
$database->setquery($sql);
$database->query();	

}

function ActualizaPerfilEvaluacionNoEvaluable($evaluado, $evaluador, $id_proceso) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "update tbl_sgd_relaciones set perfil_evaluacion_competencias='no_evaluable', evaluador='', comentario='dejado como no evaluable desde el administrador antiguo evaluador $evaluador' where evaluado='$evaluado' and evaluador='$evaluador' and id_proceso='$id_proceso'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DatosUsuarioAdmin($rut){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$fecha = date("Y-m-d");	

$sql="

select * from tbl_admin where user='$rut'

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;



}


function BuscaPerfilDeRutAdmin($rut){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$fecha = date("Y-m-d");	

$sql="

select acceso from tbl_admin where user='$rut'

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod[0]->acceso;



}

function BuscaNombrePerfilDeRutAdmin($rut){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$fecha = date("Y-m-d");	

$sql="

select nombre from tbl_admin where user='$rut'

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod[0]->nombre;



}
function BuscaRutDuplicadosPorAudiencias($id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$fecha = date("Y-m-d");
$sql = "

SELECT h.rut, count(id) as cuenta, 
(select nombre from tbl_audiencia where id=h.id_audiencia) as audiencia  

FROM tbl_audiencia_id_audiencia_rut h 

GROUP BY h.rut HAVING cuenta > 1

order by h.rut

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;		


}

function DeleteAudienciaFull($id_audiencia_del, $id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$fecha = date("Y-m-d");
$sql = "
delete from tbl_audiencia where id='$id_audiencia_del' and id_empresa='$id_empresa'
";

$database->setquery($sql);
$database->query();	

//echo "$sql";

$sql = "
delete from tbl_audiencia_id_audiencia_rut where id_audiencia='$id_audiencia_del' and id_empresa='$id_empresa'
";	

$database->setquery($sql);
$database->query();

//echo "$sql"; 	  

}


function DeleteMetasAudienciaFull($id_audiencia_del, $id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$fecha = date("Y-m-d");
$sql = "
delete from tbl_metas_audiencia where id='$id_audiencia_del' and id_empresa='$id_empresa'
";

$database->setquery($sql);
$database->query();	

//echo "$sql";

$sql = "
delete from tbl_metas_audiencia_id_audiencia_rut where id_audiencia='$id_audiencia_del' and id_empresa='$id_empresa'
";	

$database->setquery($sql);
$database->query();

//echo "$sql"; 	  

}

function BuscaPublicacionesdadaAudiencia($id_audiencia, $id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$fecha = date("Y-m-d");
$sql = "

SELECT h.id_audiencia,  h.nombre,
(select nombre from tbl_audiencia where id=h.id_audiencia) as audiencia  

from tbl_audiencia_publicaciones h

where h.id_audiencia='$id_audiencia'

order by h.id_audiencia;

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;		


}

function BuscaPublicacionesDuplicadasAudiencia($id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$fecha = date("Y-m-d");
$sql = "

SELECT h.id_audiencia, count(id) as cuenta, h.nombre,
(select nombre from tbl_audiencia where id=h.id_audiencia) as audiencia  

from tbl_audiencia_publicaciones h

GROUP BY h.id_audiencia HAVING cuenta > 1

order by h.id_audiencia;

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;		


}

function BuscaNuevosPorAudiencias($id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$fecha = date("Y-m-d");
$sql = "

select h.*, 
(select count(id) as cuenta from tbl_audiencia_id_audiencia_rut where rut=h.rut) as num_audiencias 

from tbl_usuario h where YEAR(h.fecha_ingreso)='2019' 

and (select count(id) as cuenta from tbl_audiencia_id_audiencia_rut where rut=h.rut)>0

order by h.fecha_ingreso DESC	

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;	


}
function BuscaAudienciasDado_Rut($rut, $id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$fecha = date("Y-m-d");	

$sql="

select h.id_audiencia, (select nombre from tbl_audiencia where id=h.id_audiencia) as audiencia  from tbl_audiencia_id_audiencia_rut h where h.rut='$rut' and h.id_empresa='$id_empresa'

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;


}
function BuscaFullUsuario($rut, $id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$fecha = date("Y-m-d");
$sql = "select * from tbl_lms_reportes_full where rut='$rut'";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;		

}

function BuscaListaEstadistica($id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$fecha = date("Y-m-d");
$sql = "select h.* from tbl_audiencia_estadistica h where h.id_empresa='$id_empresa'";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;		

}

function BuscaEstadisticaEntradaMatriz($rut, $id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$fecha = date("Y-m-d");
$sql = "select count(h.id) as cuenta 

from tbl_log_sistema h 

where h.rut='$rut' and h.variables_get  like '%entrada_matriz%' and h.id_empresa='$id_empresa'";

echo "<br>sql BuscaEstadisticaEntradaMatriz $sql";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod[0]->cuenta;	

}

function ActualizaEstadisticaEntradaMatriz($rut, $cuenta, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "update tbl_audiencia_estadistica set cuenta='$cuenta' where rut='$rut'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}



function VerificaTipoDePerfilAdminAcceso($user){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select tbl_admin.*, tbl_admin_perfiles.template from tbl_admin inner join tbl_admin_perfiles on tbl_admin_perfiles.id=tbl_admin.acceso where tbl_admin.user='$user'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;	


}



function UpdateClavedata(){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select id, clave_encodeada from tbl_clave";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

foreach ($cod as $unico){
//echo "<br>clave_decod $clave_decod";
$clave_decod= Decodear3($unico->clave_encodeada);

echo "<br>clave_decod $clave_decod";
$clave_encrypt=Encriptar($clave_decod);

$sql1 = "update tbl_clave set sinenc='".$clave_decod."', clave_encodeadaCryp='".$clave_encrypt."'  where id='".$unico->id."'";
$database->setquery($sql1);
$database->query();



}


$sql = "select id, clave_encodeada from tbl_admin";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

foreach ($cod as $unico){
//echo "<br>clave_decod $clave_decod";
$clave_decod= Decodear3($unico->clave_encodeada);

//echo "<br>clave_decod $clave_decod";
$clave_encrypt=Encriptar($clave_decod);

$sql1 = "update tbl_admin set sinenc='".$clave_decod."', clave_encodeadaCryp='".$clave_encrypt."'  where id='".$unico->id."'";
$database->setquery($sql1);
$database->query();



}

}


function BuscaDatosAudiencia($id_audiencia_edit){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$fecha = date("Y-m-d");
$sql = "select * from tbl_audiencia where id='$id_audiencia_edit'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	
}

function PlanesCapacitacionTotal(){ 
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$fecha = date("Y-m-d");
$sql = "SELECT
tbl_usuario.rut,
rut_completo, 
nombre_completo, 
cargo, 
zona, 
area,
id_competencia,
tbl_sgd_componente.nombre as nombre_competencia,
tbl_sgd_plan_capacitacion.id_curso, 
tbl_sgd_curso.curso as nombre_curso
FROM
tbl_sgd_plan_capacitacion
inner join tbl_usuario on tbl_usuario.rut=tbl_sgd_plan_capacitacion.rut
inner join tbl_sgd_componente on tbl_sgd_componente.id=tbl_sgd_plan_capacitacion.id_competencia
inner join tbl_sgd_curso on tbl_sgd_curso.id_curso=tbl_sgd_plan_capacitacion.id_curso";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}




function CambiarClaveDesdeAdmin($rut, $clave)
{
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$fecha       = date("Y-m-d");
$existe_base = UsuarioEnBasePersonas($rut, $rutcontodo);
$sql_busca   = "select id  from tbl_clave where rut='" . $rut . "'";
$database->setquery($sql_busca);
$database->query();
$cod = $database->listObjects();


$clave_clave=Encriptar($clave);
$rut_enc=Encriptar($rut);
$clave_nueva_enc=hash('sha256',$clave_clave.$rut_enc.$rut_enc);



if ($cod[0]->id > 0) {
//$sql = "UPDATE tbl_clave SET clave= '" . $clave . "', clave_encodeada='".Encodear3($clave)."', cambiado='0', fecha_cambio='" . $fecha . "' WHERE rut = '" . $rut . "'";
$sql = "UPDATE tbl_clave SET clave_encodeada='".($clave_nueva_enc)."', cambiado='0', fecha_cambio='" . $fecha . "' WHERE rut = '" . $rut . "'";
} else {
//$sql = "UPDATE tbl_clave SET clave= '" . $clave . "', clave_encodeada='".Encodear3($clave)."', cambiado='1', fecha_cambio='" . $fecha . "' WHERE rut = '" . $rut . "'";
//$sql = "INSERT INTO tbl_clave     (rut, clave, cambiado, fecha_cambio, id_empresa, clave_encodeada) " . "     VALUES ('$rut', '$clave', '0', '" . date("Y-m-d") . "', '" . $existe_base[0]->id_empresa . "', '".Encodear3($clave)."');";
$sql = "INSERT INTO tbl_clave     (rut,  cambiado, fecha_cambio, id_empresa, clave_encodeada) " . "     VALUES ('$rut',  '0', '" . date("Y-m-d") . "', '" . $existe_base[0]->id_empresa . "', '".($clave_nueva_enc)."');";
}
//echo $sql;
//exit();
$database->setquery($sql);
$database->query();
}
function EliminarIntentosFallidosDelDia($rut, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$fecha = date("Y-m-d");
$sql = "DELETE FROM tbl_login_intento_acceso  where rut='$rut'  and fecha='$fecha' ";

//echo $sql;
$database->setquery($sql);
$database->query();
}


function AdminActualizaEstadoUserAdmin($user) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "update tbl_admin set activo='1' where user='$user'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}


function TraeTotalAccesosFallidosPorDia($user){ 
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$fecha = date("Y-m-d");
$sql = "select * from tbl_login_intento_acceso_admin where rut='$user' and fecha='$fecha'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}


function InsertaAccesoIntentoAdmin($rut)
{
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$fecha = date("Y-m-d");
$hora  = date("H:i:s");
$sql   = "insert into tbl_login_intento_acceso_admin (rut,fecha,hora, ip_compartido, ip_proxy, ip_acceso)
VALUES
('$rut','$fecha','$hora', '".$_SERVER['HTTP_CLIENT_IP']."', '".$_SERVER['HTTP_X_FORWARDED_FOR']."', '".$_SERVER['REMOTE_ADDR']."');";
//echo $sql; exit();
$database->setquery($sql);
$database->query();
}


function AdminActualizaClaveEncodeada($id, $clave_encodeada) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "

update tbl_admin set clave_encodeada='$clave_encodeada' where id='$id'";

//echo "<br>$sql";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}


function TraeClavesTotalAdmin(){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_admin";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}


function PlanesAccionSabana() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "SELECT
tbl_sgd_plan_accion.evaluado,
tbl_usuario.rut_completo, 
tbl_usuario.nombre_completo, 
tbl_usuario.cargo, 
tbl_usuario.email, 
tbl_usuario.zona, 
tbl_usuario.area, 
tbl_usuario.departamento, 
tbl_sgd_plan_accion.id_competencia,
tbl_sgd_componente.nombre as nombre_componente, 
tbl_sgd_plan_accion.conducta,
tbl_sgd_componente_conducta.conducta as nombre_conducta,
tbl_sgd_plan_accion.compromiso_evaluado,
tbl_sgd_plan_accion.apoyo_jefatura, 
(select fecha1 from tbl_sgd_plan_fecha_seguimiento where tbl_sgd_plan_fecha_seguimiento.evaluado=tbl_sgd_plan_accion.evaluado limit 1) as fecha_1, 
(select fecha2 from tbl_sgd_plan_fecha_seguimiento where tbl_sgd_plan_fecha_seguimiento.evaluado=tbl_sgd_plan_accion.evaluado limit 1) as fecha_2, 
(select fecha3 from tbl_sgd_plan_fecha_seguimiento where tbl_sgd_plan_fecha_seguimiento.evaluado=tbl_sgd_plan_accion.evaluado limit 1) as fecha_3
FROM
tbl_sgd_plan_accion

left join tbl_usuario on tbl_usuario.rut=tbl_sgd_plan_accion.evaluado

left join tbl_sgd_componente on tbl_sgd_componente.id=tbl_sgd_plan_accion.id_competencia
left join tbl_sgd_componente_conducta on tbl_sgd_componente_conducta.id=tbl_sgd_plan_accion.conducta";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}



function Bch_InsertClaveEncodeada($rut, $clave, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

//$sql = "INSERT INTO tbl_clave (rut,clave_encodeada,cambiado,id_empresa)            VALUES ('$rut', '$clave', '1', '$id_empresa')";

$database->setquery($sql);
$database->query();

//echo "<br>".$sql;
}
function ListaBchSinClavesEncodeada($id_empresa){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql="select h.*, (select clave_encodeada from tbl_clave where rut=h.rut) as clave from tbl_usuario h where h.id_empresa='$id_empresa'
and (select clave_encodeada from tbl_clave where rut=h.rut) is null";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}
function HistoricoData($rut, $proceso){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_sgd_notas_finales_historicos where rut='$rut' and proceso='$proceso'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function Dashboard_admin_data($id_empresa){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql1   ="select COUNT(id) as video01 from tbl_log_sistema h where h.id_empresa='$id_empresa' and h.ambiente = 'home_gotalks_video' and h.variables_get like '%1%';";
$sql2   ="select COUNT(id) as video02 from tbl_log_sistema h where h.id_empresa='$id_empresa' and h.ambiente = 'home_gotalks_video' and h.variables_get like '%2%';";
$sql3   ="select COUNT(id) as video03 from tbl_log_sistema h where h.id_empresa='$id_empresa' and h.ambiente = 'home_gotalks_video' and h.variables_get like '%3%';";
$sql4   ="select COUNT(id) as video04 from tbl_log_sistema h where h.id_empresa='$id_empresa' and h.ambiente = 'home_gotalks_video' and h.variables_get like '%4%';";
$sql5   ="select COUNT(id) as cuenta_usuario from tbl_usuario h where h.id_empresa='$id_empresa';";
$sql6   ="select COUNT(DISTINCT h.rut) as cuenta_usuarios_ingreso from tbl_log_sistema h INNER JOIN tbl_usuario on tbl_usuario.rut=h.rut and tbl_usuario.vigencia='0' where h.id_empresa='$id_empresa';";
$sql7   ="select COUNT(id) as cuenta_entrada from tbl_log_sistema h where h.id_empresa='$id_empresa' and h.ambiente like 'entrada%';";
$sql8   ="select COUNT(id) as cuenta_visitas from tbl_log_sistema h where h.id_empresa='$id_empresa' and h.ambiente like 'visitas'; ";
$sql9   ="select COUNT(id) as agradecimiento from tbl_reconoce_gracias h where h.id_empresa='$id_empresa' and h.estado='OK' and h.tipo='GRACIAS';";
$sql10  ="select COUNT(id) as reco_seleccion from tbl_reconoce_gracias h where h.id_empresa='$id_empresa' and h.estado='OK' and h.tipo='RECONOCIMIENTO' and h.categorita='SELECCION DEL CHILE'  and h.mensaje<>'2017';";
$sql11  ="select COUNT(id) as reco_colaboracion from tbl_reconoce_gracias h where h.id_empresa='$id_empresa' and h.estado='OK' and h.tipo='RECONOCIMIENTO' and h.categorita='COLABORACION' and h.mensaje<>'2017';  ";
$sql12  ="select sum(puntos) from tbl_premios_puntos_usuarios where id_reconoce_gracias is not null and h.id_empresa='$id_empresa' ";
$sql13   ="select COUNT(id) as video05 from tbl_log_sistema h where h.id_empresa='$id_empresa' and h.ambiente = 'home_gotalks_video' and h.variables_get like '%5%';";
$sql14   ="select COUNT(id) as video06 from tbl_log_sistema h where h.id_empresa='$id_empresa' and h.ambiente = 'home_gotalks_video' and h.variables_get like '%6%';";
$sql20   ="select count(h.id) as cuenta from tbl_postulables h where h.id_empresa='$id_empresa' and h.id_tipo='formacioncontinua'";
$sql21   ="select count(h.id) as cuenta from tbl_postulables h where h.id_empresa='$id_empresa' and h.id_tipo='inscripcionautomatica' ";
$sql22   ="select count(h.id) as cuenta from tbl_postulaciones h where h.id_empresa='$id_empresa' and h.jefeok='SI' ";
$sql24   ="select count(DISTINCT h.id_curso) as cuenta from tbl_lms_reportes_full h where h.status='Elearning'   ";
$sql25   ="select count(h.id) as cuenta from tbl_lms_reportes_full h where h.status='Elearning' and h.curso_opcional=''  ";
$sql26   ="select count(h.id) as cuenta from tbl_lms_reportes_full h where h.status='Elearning' and h.curso_opcional='' and h.asistencia='100%'";
$sql27   ="select count(h.id) as cuenta from tbl_lms_reportes_full h where h.status='Elearning' and h.curso_opcional='' and h.asistencia<>'100%' and h.asistencia<>'0%'";
$sql28   ="select count(h.id) as cuenta from tbl_lms_reportes_full h where h.status='Elearning' and h.curso_opcional='' and h.asistencia='0%' ";
$sql29   ="SELECT count(DISTINCT h.rut) as cuenta FROM tbl_enc_elearning_respuestas h WHERE h.id_encuesta = '12'  ";
$sql30   ="SELECT	count(h.id) as cuenta from 	tbl_enc_elearning_respuestas h WHERE h.id_encuesta = '12' AND h.id_pregunta = '1' ";
$sql31   ="SELECT	count(h.id) as cuenta FROM	tbl_enc_elearning_respuestas h WHERE h.id_encuesta = '12' AND h.id_pregunta = '1' and h.respuesta>=6 ";
$sql32   ="SELECT	count(h.id) as cuenta FROM	tbl_enc_elearning_respuestas h WHERE h.id_encuesta = '12' AND h.id_pregunta = '1' and h.respuesta<=4 ";
$sql33   ="SELECT	avg(h.respuesta) as cuenta from 	tbl_enc_elearning_respuestas h WHERE h.id_encuesta = '12' AND h.id_pregunta = '1' ";
/*
$database->setquery($sql1);  $database->query();    $cod1 = $database->listObjects();
$database->setquery($sql2);  $database->query();    $cod2 = $database->listObjects();
$database->setquery($sql3);  $database->query();    $cod3 = $database->listObjects();
$database->setquery($sql4);  $database->query();    $cod4 = $database->listObjects();
$database->setquery($sql5);  $database->query();    $cod5 = $database->listObjects();
$database->setquery($sql6);  $database->query();    $cod6 = $database->listObjects();
$database->setquery($sql7);  $database->query();    $cod7 = $database->listObjects();
$database->setquery($sql8);  $database->query();    $cod8 = $database->listObjects();
$database->setquery($sql9);  $database->query();     $cod9 = $database->listObjects();
$database->setquery($sql10);  $database->query();    $cod10 = $database->listObjects();
$database->setquery($sql11);  $database->query();    $cod11 = $database->listObjects();
$database->setquery($sql12);  $database->query();    $cod12 = $database->listObjects();
$database->setquery($sql13);  $database->query();    $cod13 = $database->listObjects();
$database->setquery($sql14);  $database->query();    $cod14 = $database->listObjects();

$database->setquery($sql20);  $database->query();    $cod20 = $database->listObjects();
$database->setquery($sql21);  $database->query();    $cod21 = $database->listObjects();
$database->setquery($sql22);  $database->query();    $cod22 = $database->listObjects();
$database->setquery($sql23);  $database->query();    $cod23 = $database->listObjects();
$database->setquery($sql24);  $database->query();    $cod24 = $database->listObjects();
$database->setquery($sql25);  $database->query();    $cod25 = $database->listObjects();
$database->setquery($sql26);  $database->query();    $cod26 = $database->listObjects();
$database->setquery($sql27);  $database->query();    $cod27 = $database->listObjects();
$database->setquery($sql28);  $database->query();    $cod28 = $database->listObjects();
$database->setquery($sql29);  $database->query();    $cod29 = $database->listObjects();
$database->setquery($sql30);  $database->query();    $cod30 = $database->listObjects();
$database->setquery($sql31);  $database->query();    $cod31 = $database->listObjects();
$database->setquery($sql32);  $database->query();    $cod32 = $database->listObjects();
$database->setquery($sql33);  $database->query();    $cod33 = $database->listObjects();

*/
$array = array($cod5[0]->cuenta_usuario, $cod6[0]->cuenta_usuarios_ingreso,$cod7[0]->cuenta_entrada,$cod8[0]->cuenta_visitas,
$cod9[0]->agradecimiento,$cod10[0]->reco_seleccion,$cod11[0]->reco_colaboracion,$cod12[0]->puntos_entregados,
$cod1[0]->video01,$cod2[0]->video02,$cod3[0]->video03,$cod4[0]->video04,
$cod13[0]->video05,$cod14[0]->video06,
"","","","","","","",
$cod20[0]->cuenta,$cod21[0]->cuenta,$cod22[0]->cuenta,$cod23[0]->cuenta,$cod24[0]->cuenta,$cod25[0]->cuenta,$cod26[0]->cuenta,
$cod27[0]->cuenta,$cod28[0]->cuenta,$cod29[0]->cuenta,$cod30[0]->cuenta,$cod31[0]->cuenta,$cod32[0]->cuenta,$cod33[0]->cuenta,
);


return $array;


}
function BuscaResponsableTblUsuario($rut){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select responsable from tbl_usuario where rut='$rut'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod[0]->responsable;
}
function BuscaLiderTblUsuario($rut){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select lider from tbl_usuario where rut='$rut'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod[0]->responsable;
}
function BuscaAvatarTblUsuario($rut){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select avatar from tbl_usuario where rut='$rut'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod[0]->responsable;
}

function UpdateInactivoWA(){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);





$sql="
UPDATE tbl_lms_reportes h SET h.curso_opcional=1 WHERE
(select inactivo from rel_lms_malla_curso where id_curso=h.id_curso and id_malla=h.id_malla ) ='1';";


$sql2= "UPDATE tbl_lms_reportes h SET h.id_clasificacion=''  WHERE
h.curso_opcional='1';";


// echo $sql;
//echo $sql2;
$database->setquery($sql);
$database->query();
$database->setquery($sql2);
$database->query();

}
function Borrar_id_curso91_admin(){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql="

DELETE h.* from tbl_inscripcion_usuarios h where h.id_curso='wa_desafio_91'
and (select count(id) from tbl_mantener_id_curso_wom where rut=h.rut and id_curso=h.id_curso limit 1)='0';";


$sql2= "DELETE h.* from  tbl_lms_reportes h where h.id_curso='wa_desafio_91'
and (select count(id) from tbl_mantener_id_curso_wom where rut=h.rut and id_curso=h.id_curso  limit 1)='0';";



$sql3="DELETE h.* from  tbl_lms_reportes_full h where h.id_curso='wa_desafio_91'
and (select count(id) from tbl_mantener_id_curso_wom where rut=h.rut and id_curso=h.id_curso  limit 1)='0';";
// echo $sql;
//echo $sql2;
$database->setquery($sql);
$database->query();
$database->setquery($sql2);
$database->query();
$database->setquery($sql3);
$database->query();
}



function DelSesImpEn($id_sesion, $id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "DELETE FROM rel_lms_inscripcion_sesion  where id='$id_sesion'  and id_empresa='$id_empresa'

";

//echo $sql;exit();
$database->setquery($sql);
$database->query();
}


function TraeDatosEncuestaFinalSGD() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "SELECT
tbl_sgd_feedback_evaluado.evaluado,
baseevaluado.nombre_completo as nombre_evaluado,
baseevaluado.cargo as cargo_evaluado,
baseevaluado.zona as zona_Evaluado,
baseevaluado.area as area_evaluado,
baseevaluado.departamento as departamento_evaluado,

tbl_sgd_feedback_evaluado.evaluador,
baseevaluador.nombre_completo as nombre_evaluador,
baseevaluador.cargo as cargo_evaluador,
baseevaluador.zona as zona_Evaluador,
baseevaluador.area as area_evaluador,
baseevaluador.departamento as departamento_evaluador,




fecha, hora, preg1, preg2, preg3, preg4, preg5, preg6, preg7, preg8, preg9, preg10, preg11, preg12, comentarios_finales, 
(select respuesta from tbl_sgd_enc_satis where tbl_sgd_enc_satis.evaluado=tbl_sgd_feedback_evaluado.evaluado limit 1) as encfinal
FROM
tbl_sgd_feedback_evaluado
INNER JOIN tbl_usuario AS baseevaluado ON baseevaluado.rut = tbl_sgd_feedback_evaluado.evaluado
inner join tbl_usuario as baseevaluador on baseevaluador.rut=tbl_sgd_feedback_evaluado.evaluador";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}


function TraeImparticionesReportesFull($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_inscripcion_curso where id_empresa='$id_empresa' order by id ASC";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeCursosReportesFullAsc($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select id from tbl_lms_curso where id_empresa='$id_empresa' order by id ASC";
//echo "<br>";
// echo $sql; //exit();
//echo "<br>";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//print_r($cod);
//print_r($cod);
return $cod;
}

function TraeCursosReportesFull($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_lms_curso where id_empresa='$id_empresa' order by nombre";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}



function TraeMallasReportesFull($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_lms_malla where id_empresa='$id_empresa' order by nombre";


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}


function TraeProgramasElearning($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_lms_programas_bbdd where id_empresa='$id_empresa' and (tipo<>'GLOBAL' or tipo is null or tipo='') order by nombre_programa ASC";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//echo $sql;exit();
return $cod;
}


function TraeProgramasGlobales($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_lms_programas_bbdd where id_empresa='$id_empresa' and tipo='GLOBAL' order by nombre_programa ASC";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function mp_galeria_delete($del_idfoto, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "DELETE FROM tbl_mp_fotomensaje  where id_empresa='$id_empresa'  and id='$del_idfoto'

";

//echo $sql;
$database->setquery($sql);
$database->query();
}
function BuscaUsuariosRespondieronEncLBSinUsuario($idMed) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
SELECT h.*
FROM tbl_enc_elearning_respuestas h
WHERE h.id_medicion= '$idMed' group by h.rut";

//echo "<br>BuscaUsuariosRespondieronEncLBSinUsuario ".$sql; exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}
function BuscaUsuariosRespondieronEncLBSinUsuario_CadaLineaRespuesta($idMed) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
SELECT h.*
FROM tbl_enc_elearning_respuestas h
WHERE h.id_medicion= '$idMed' ";


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function BuscaRespuestasUsuarioMedEncLB($rut, $id_pregunta, $idMed) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = " select h.* from tbl_enc_elearning_respuestas h where h.rut='$rut' and h.id_pregunta='$id_pregunta'
and h.id_medicion='$idMed'";
//echo "<BR><BR>-........RUT $rut, IDPREG $id_pregunta, IDMED $idMed<BR>".$sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//print_r($cod);
return $cod;
}

function TraeEncuestasLBEmpresa($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.*,
(select nombre from tbl_enc_elearning where id=h.id_encuesta) as bancopreguntas,
(select count(id) from tbl_nomina_encuesta where id_encuesta=h.id_encuesta) as usuarios

from tbl_enc_elearning_medicion h

where h.id_empresa='$id_empresa'
order by h.id DESC";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}



function TraeClusterEncuestasLBEmpresa($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "
select h.*,
(select count(id) from rel_encuesta_cluster where id_encuesta_cluster=h.id) as cuenta_encuestas,
(select count(id) from rel_encuestas_cluster_usuarios where id_cluster=h.id) as cuenta_visualizadores
from tbl_encuestas_cluster h

where h.id_empresa='$id_empresa'
order by h.nombre ASC";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TraeClusterEncuestasLBProsciEmpresa($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "
select h.*,
(select count(id) from tbl_prosci_rel_encuestas_proyecto where id_proyecto=h.id_proyecto) as cuenta_encuestas,
(select count(id) from tbl_prosci_encuestas_usuarios where id_proyecto=h.id_proyecto) as cuenta_usuarios,
(select count(id) from rel_prosci_usuarios_visualizadores where id_proyecto=h.id_proyecto) as cuenta_visualizadores

from tbl_prosci_proyecto h

where h.id_empresa='$id_empresa'
order by h.id DESC";

//   echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}


function TraeAdminEncuestasLBEmpresa($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.*

from tbl_admin h

where h.id_empresa='$id_empresa'
order by h.id DESC";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}
function ReporteFull_Duplicados_data($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

SELECT
rut, id_inscripcion, id_curso, asistencia, evaluacion, COUNT(*) AS c

FROM
tbl_lms_reportes_full


where status<>'Presencial'

GROUP BY
rut,id_curso

HAVING c > 1


";
//echo "hola $sql";
$database->setquery($sql);
$database->query();

$cod = $database->listObjects();

return $cod;
}
function BorraDuplicacionesReporteFull($rut, $id_inscripcion, $id_curso, $asistencia, $evaluacion){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

DELETE

FROM
tbl_lms_reportes_full

where rut='$rut' and id_inscripcion='$id_inscripcion' and id_curso='$id_curso'

ORDER BY evaluacion ASC, asistencia ASC  LIMIT 1

";
// echo "<br>BorraDuplicacionesReporteFull<br> $sql";
$database->setquery($sql);
$database->query();

//$cod = $database->listObjects();

//return $cod;

}
function EncuestasLBListaBancoPreguntas_data($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_enc_elearning where id_empresa = '$id_empresa' order by id DESC";
//echo "hola $sql";
$database->setquery($sql);
$database->query();

$cod = $database->listObjects();

return $cod;
}
function ActualizaDatosLmsReportesUsuariosNull()
{
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select tbl_lms_reportes.rut, tbl_lms_reportes.id_empresa,
(select campo1 from tbl_empresa where id=tbl_lms_reportes.id_empresa) as c1,
(select campo2 from tbl_empresa where id=tbl_lms_reportes.id_empresa) as c2,
(select campo3 from tbl_empresa where id=tbl_lms_reportes.id_empresa) as c3,
(select campo4 from tbl_empresa where id=tbl_lms_reportes.id_empresa) as c4


from tbl_lms_reportes where tbl_lms_reportes.nombre is null";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
foreach($cod as $unico) {
$sql_us = "update tbl_lms_reportes set
nombre=(select nombre_completo from tbl_usuario where rut='" . $unico->rut . "'),
cargo=(select cargo from tbl_usuario where rut='" . $unico->rut . "'),
email=(select email from tbl_usuario where rut='" . $unico->rut . "'),
c1=(select " . $unico->c1 . " from tbl_usuario where rut='" . $unico->rut . "'),
c2=(select " . $unico->c2 . " from tbl_usuario where rut='" . $unico->rut . "'),
c3=(select " . $unico->c3 . " from tbl_usuario where rut='" . $unico->rut . "'),
c4=(select " . $unico->c4 . " from tbl_usuario where rut='" . $unico->rut . "')
where rut='" . $unico->rut . "'";
$database->setquery($sql_us);
$database->query();
}

$sql = "update  tbl_lms_reportes h
set id_foco=(select codigo_foco from tbl_lms_programas_bbdd where id_programa=h.id_programa)
where h.id_foco is null";
$database->setquery($sql_us);
$database->query();
// $sql_usuarios_novigentes = "delete from tbl_lms_reportes where nombre is null";
// $database->setquery($sql_usuarios_novigentes);
// $database->query();
}


function VistaCursosHistoricosDataAdminPorCurso($rut, $id_inscripcion, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.id_inscripcion, h.id_curso,

(select fecha_inicio from tbl_inscripcion_curso where codigo_inscripcion= h.id_inscripcion limit 1) as fecha_inicio,
(select fecha_termino from tbl_inscripcion_curso where codigo_inscripcion= h.id_inscripcion limit 1) as fecha_termino,
(select ejecutivo from tbl_inscripcion_curso where codigo_inscripcion= h.id_inscripcion limit 1) as ejecutivo,
(select modalidad from tbl_lms_curso where id= h.id_curso limit 1) as modalidad,
(select estado_descripcion from tbl_inscripcion_cierre where id_inscripcion= h.id_inscripcion and rut=h.rut limit 1) as estado,
(select nota from tbl_inscripcion_cierre where id_inscripcion= h.id_inscripcion and rut=h.rut limit 1) as nota,
(select avance from tbl_inscripcion_cierre where id_inscripcion= h.id_inscripcion and rut=h.rut limit 1) as avance,

(select estado_descripcion from tbl_inscripcion_cierre where id_curso= h.id_curso and rut=h.rut limit 1) as estado2,
(select nota from tbl_inscripcion_cierre where id_curso= h.id_curso and rut=h.rut limit 1) as nota2,
(select avance from tbl_inscripcion_cierre where id_curso= h.id_curso and rut=h.rut limit 1) as avance2,



(select nombre from tbl_lms_curso where id= h.id_curso limit 1) as curso,
(
SELECT
numero_horas
FROM
tbl_lms_curso
WHERE
id = h.id_curso
LIMIT 1
) AS hora

from tbl_inscripcion_usuarios h where h.rut='$rut' and h.id_empresa='$id_empresa'

and h.id_inscripcion='$id_inscripcion'

order by (select fecha_termino from tbl_inscripcion_curso where codigo_inscripcion= h.id_inscripcion) DESC";
//echo "<br>".$sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return ($cod);
}

function slider_delete($del_idfoto, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "DELETE FROM tbl_lms_slider  where id_empresa='$id_empresa'  and id='$del_idfoto'

";

//echo $sql;
$database->setquery($sql);
$database->query();
}

function BuscaDatosMPFotoGPTW($id_post) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
//echo "<br>id post $id_post";
$porciones = explode("_", $id_post);
//echo $porciones[2]; // porcin1

$sql = "select h.*, h.rut as RutAutor ,
(select nombre_completo from tbl_usuario where rut=h.rut) as NombreAutor,
(select cargo from tbl_usuario where rut=h.rut) as AutorCargo,
(select email from tbl_usuario where rut=h.rut) as AutorEmail,
(select gerencia from tbl_usuario where rut=h.rut) as AutorGerencia,
(select gerenciaR2 from tbl_usuario where rut=h.rut) as AutorGerenciaR2,
(select gerenciaR3 from tbl_usuario where rut=h.rut) as AutorGerenciaR3

from tbl_mp_fotomensaje h
where  h.id= " . $porciones[2] . "
limit 1";

//echo "<br>".$sql;  exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//echo $sql;exit();
//print_r($cod); sleep(5);
return $cod;
}

function TraeImagenesMPGaleria($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.*, (select nombre_completo from tbl_usuario where rut=h.rut) as nombre_completo from tbl_mp_fotomensaje h
where  h.id_empresa='$id_empresa'
order by h.fecha DESC, h.id DESC";

// echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//echo $sql;exit();
//print_r($cod); sleep(5);
return $cod;
}

function TraeLmsSliders($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.* from tbl_lms_slider h
where  h.id_empresa='$id_empresa'
order by h.fecha DESC, h.id DESC";

//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//echo $sql;exit();
//print_r($cod); sleep(5);
return $cod;
}

function TraeProgramasGlobalesDadoFocoDeTablaProgramaElearning($id_empresa, $foco) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_lms_programas_bbdd where codigo_foco='$foco' and tipo='GLOBAL' and id_empresa='$id_empresa'        order by nombre_programa ASC";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

//echo $sql;exit();

return $cod;
}

function TraeProgramasElearningDadoProgramaGlobalDeTablaProgramaElearning($id_empresa, $programa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_lms_programas_bbdd where id_programa_global='$programa' and tipo<>'GLOBAL' and id_empresa='$id_empresa'        order by nombre_programa ASC";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();



return $cod;
}

function clave_update_empresa_uno_a_uno_data($rut, $clave, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$rut = LimpiaRut($rut);
$hoy = date("Y-m-d");
$clave = utf8_decode($clave);

//        echo "$rut, $clave, $id_empresa"; sleep(3);
if ($rut != "" and $clave != "" and $id_empresa != "") {
echo "Actualizando clave para rut $rut";
//sleep(1); 
$sql = " update tbl_clave set clave='$clave', clave_encodeada='".Encodear3($clave)."', cambiado='0', fecha_cambio='$hoy' where rut='$rut' and id_empresa='$id_empresa'";
//echo $sql;
$database->setquery($sql);
$database->query();
}

//  echo $sql; sleep(3);
}

function Cl_Resultados_Clima($unico_dim, $txt_agrp1, $txt_agrp2, $txt_agrp3, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$QAgrp1 = "";
$QAgrp2 = "";
$QAgrp3 = "";

if ($txt_agrp1 != '') {$QAgrp1 = " and h.id_tipo      ='" . $txt_agrp1 . "'";}
if ($txt_agrp2 != '') {$QAgrp2 = " and h.id_malla     ='" . $txt_agrp2 . "'";}
if ($txt_agrp3 != '') {$QAgrp3 = " and h.id_programa  ='" . $txt_agrp3 . "'";}

if ($txt_agrp1 != '') {$QAgrpJ1 = " and j.id_tipo      ='" . $txt_agrp1 . "'";}
if ($txt_agrp2 != '') {$QAgrpJ2 = " and j.id_malla     ='" . $txt_agrp2 . "'";}
if ($txt_agrp3 != '') {$QAgrpJ3 = " and j.id_programa  ='" . $txt_agrp3 . "'";}
if ($unico_dim != '') {$QDim = " and (select id_dimension from tbl_enc_elearning_preg where id_pregunta=j.id_pregunta)='" . $unico_dim . "' ";}

$sql = " select h.*,
(select count(j.id) from tbl_enc_elearning_respuestas j where j.id_encuesta='1' and j.id_medicion='1' and j.respuesta>=0 $QDim $QAgrpJ1 $QAgrpJ2 $QAgrpJ3 ) as CuentaTodos,
(select count(j.id) from tbl_enc_elearning_respuestas j where j.id_encuesta='1' and j.id_medicion='1' and j.respuesta>=3 $QDim $QAgrpJ1 $QAgrpJ2 $QAgrpJ3 ) as CuentaPositivos

from tbl_enc_elearning_respuestas h

where

h.id_encuesta='1' and h.id_medicion='1'
and h.id_empresa='$id_empresa' $QAgrp1 $QAgrp2 $QAgrp3

limit 1";

//    echo "<br>".$sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function CL_buscaGroupByAgr($tipo, $filt1, $filt2, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$qf1 = " ";
$qf2 = " ";
if ($filt1 != "") {$qf1 = " and id_tipo='" . $filt1 . "' ";}
if ($filt2 != "") {$qf2 = " and id_malla='" . $filt2 . "' ";}

$sql = " select $tipo as tipo from tbl_enc_elearning_respuestas  where id_encuesta='1' and id_medicion='1' and id_empresa='$id_empresa' $qf1 $qf2 group by $tipo";
//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function insert_update_cursos_Externos_Data($rut, $estado, $avance, $nota, $fecha, $id_curso, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

// objetos finalizados

$sql = " select count(id) as cuenta from tbl_objetos_finalizados where rut='$rut' and id_curso='$id_curso'";
// echo "<br>ObjFin $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

if ($cod[0]->cuenta == 0) {
$sql = "    INSERT INTO tbl_objetos_finalizados (rut, id_objeto, id_curso, fecha, nota)
VALUES ('$rut', 'SINOBJ', '$id_curso', '$fecha', '$nota')";
$database->setquery($sql);
$database->query();
// echo ".insert $sql";
} else {
$sql = " update tbl_objetos_finalizados set fecha='$fecha, nota='$nota' where rut='$rut' and id_curso='$id_curso'";
$database->setquery($sql);
//$database->query();
// echo ".update $sql";
}

// inscripcion cierre

$sql = " select count(id) as cuenta from tbl_inscripcion_cierre where rut='$rut' and id_curso='$id_curso'  and id_empresa='$id_empresa'";
//echo "<br>InscripcionCierre $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

if ($cod[0]->cuenta == 0) {
$sql = "    INSERT INTO tbl_inscripcion_cierre (rut, nota, estado, estado_descripcion, id_curso,id_empresa,
avance,fecha_inicio, fecha_termino)
VALUES ('$rut', '$nota', '1', '$estado', '$id_curso','$id_empresa',
'$avance', '$fecha','$fecha')";
$database->setquery($sql);
$database->query();
//echo ".insert $sql";
} else {
$sql = " update tbl_inscripcion_cierre set estado='1', estado_descripcion='$estado',
fecha_inicio='$fecha, fecha_termino='$fecha, avance='$avance', nota='$nota' where rut='$rut' and id_curso='$id_curso'  and id_empresa='$id_empresa'";
$database->setquery($sql);
//$database->query();
//echo ".update $sql";
}

//busca malla, programa, foco

$sql = " select * from rel_lms_malla_curso where id_empresa='$id_empresa' and id_curso='$id_curso'  and id_empresa='$id_empresa' limit 1 ";
//echo "<br>rel_lms_malla_curso $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

$id_malla = $cod[0]->id_malla;
$id_foco = $cod[0]->id_foco;
$id_programa = $cod[0]->id_programa;

// INSCRIPCION_USUARIOS
$sql = " select count(id) as cuenta from tbl_inscripcion_usuarios where rut='$rut' and id_curso='$id_curso'  and id_empresa='$id_empresa'";
// echo "<br>tbl_inscripcion_usuarios $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

if ($cod[0]->cuenta == 0) {
$sql = "    INSERT INTO tbl_inscripcion_usuarios (id_inscripcion, rut, id_curso, id_empresa, fecha, id_malla)
VALUES ('$id_curso', '$rut',  '$id_curso','$id_empresa',  '$fecha','$id_malla')";
$database->setquery($sql);
$database->query();
//  echo ".insert $sql";
} else {
$sql = " update tbl_inscripcion_usuarios set id_malla='$id_malla' where rut='$rut' and id_curso='$id_curso'  and id_empresa='$id_empresa'";
$database->setquery($sql);
//$database->query();
//  echo ".update $sql";
}

// REL LMS MALLA PERSONA
// INSCRIPCION_USUARIOS
$sql = " select count(id) as cuenta from rel_lms_malla_persona where rut='$rut' and id_malla='$id_curso' and id_empresa='$id_empresa'";
// echo "<br>rel_lms_malla_persona $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

if ($cod[0]->cuenta == 0) {
$sql = "    INSERT INTO rel_lms_malla_persona (rut, id_malla, id_empresa)
VALUES ('$rut','$id_malla','$id_empresa')";
$database->setquery($sql);
$database->query();
// echo ".insert $sql";
} else {
$sql = "";
// echo ".update $sql";
}

// LMS REPORTES
$sql = " select count(id) as cuenta from tbl_lms_reportes where rut='$rut' and id_curso='$id_curso'  and id_empresa='$id_empresa'";
//echo "<br>tbl_lms_reportes $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

if ($cod[0]->cuenta == 0) {
$sql = "    INSERT INTO tbl_lms_reportes (rut,id_foco,id_curso,avance,resultado,id_empresa,
id_programa,id_malla,fecha_inicio,fecha_termino,fecha_inscripcion,estado)



VALUES ('$rut, '$id_foco, '$id_curso', '$avance', '$nota', '$id_empresa',
'$id_programa',  '$id_malla','$fecha',  '$fecha','$fecha',''$estado')";
$database->setquery($sql);
$database->query();
// echo ".insert $sql";
} else {
$sql = " update tbl_lms_reportes set
id_foco='$id_foco', avance='$avance', resultado='$nota', id_programa='$id_programa', id_malla='$id_malla',
fecha_inicio='$fecha', fecha_termino='$fecha', fecha_inscripcion='$fecha', estado='$estado'
where rut='$rut' and id_curso='$id_curso'  and id_empresa='$id_empresa'";
$database->setquery($sql);
//$database->query();
//echo ".update $sql";
}
sleep(1);
}

function lista_jefaturas_usuario($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select h.*, (select count(id) from tbl_usuario where jefe=h.rut) as numequipos
from tbl_usuario h
where h.id_empresa='$id_empresa' and (select count(id) from tbl_usuario where jefe=h.rut)>0
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lista_asignacion_usuarios_data($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select h.*,

sum(puntos)as recibidos,
(select sum(puntos) from tbl_premios_canje where rut=h.rut) as entregados,
(sum(puntos) - (select sum(puntos) from tbl_premios_canje where rut=h.rut)) as saldo

from tbl_premios_puntos_usuarios h

where h.id_empresa='$id_empresa' group by h.rut  ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lista_asignacion_jefaturas_data($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.*,

sum(puntos)as recibidos,
(select sum(puntos) from tbl_premios_puntos_usuarios_jefe_entregados where rut=h.rut) as entregados,
(sum(puntos) - (select sum(puntos) from tbl_premios_puntos_usuarios_jefe_entregados where rut=h.rut)) as saldo

from tbl_premios_puntos_usuarios_jefe h

where h.id_empresa='$id_empresa' group by h.rut  ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function CLA_buscaRespuestaRutClimaIdPreg($id_empresa, $rut) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select respuesta from tbl_enc_elearning_respuestas  where id_empresa='$id_empresa' and id_encuesta='1' and rut='$rut'   order by id ASC  ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function Cla_BuscaPreguntasClima($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_enc_elearning_preg where id_empresa='$id_empresa' and id_encuesta='1'";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function listarSecciones_Encuestas_LB($idEval) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_enc_elearning_seccion where id_encuesta='$idEval' ";
//echo "<br>listarPreguntas_Encuestas_LB ".$sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}
function listarPreguntas_Encuestas_LB($id_seccion, $idEval) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_enc_elearning_preg where id_encuesta='$idEval' and id_seccion='$id_seccion'";
//echo "<br>listarPreguntas_Encuestas_LB ".$sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DeleteTbltbl_Dash_estadistica($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "DELETE FROM tbl_estadisticas_globales  where id_empresa='$id_empresa'

";

//echo $sql;
$database->setquery($sql);
$database->query();
}

function Com_Insert_Dash_estadistica($id_empresa, $id_dimension, $tipo, $data, $fecha, $nombre, $id_grupo) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "    INSERT INTO tbl_estadisticas_globales (id_dimension,tipo,data,fecha,id_empresa,nombre, id_grupo)
VALUES ('$id_dimension', '$tipo', '$data', '$fecha', '$id_empresa', '$nombre', '$id_grupo')";
$database->setquery($sql);
$database->query();

//echo "<br>".$sql;
}

function Com_Busca_Calendario($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_fechas_estadisticas where id_empresa='$id_empresa'";
//  and fechaI='2017-12-01'
//    echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function Lid_BuscaEvento($rut, $tipo1, $tipo2, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select h.*,
(select descripcion from tbl_eventos where codigo=h.codigo) as descripcion,
(select fecha_inicio from tbl_eventos where codigo=h.codigo) as fecha_inicio

from tbl_eventos_inscritos h

where h.id_empresa='$id_empresa'

and (h.id_categoria='$tipo1' or h.id_categoria='$tipo2')
and h.rut='$rut' order by h.id ASC limit 1


";

//if($rut=="14254390"){
//echo "<br>".$sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

//print_r($cod);

return $cod[0]->descripcion;
}
function Lid_BuscaEventodIMlIMIT1($rut, $id_dimension, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select h.*,
(select descripcion from tbl_eventos where codigo=h.codigo) as descripcion,
(select fecha_inicio from tbl_eventos where codigo=h.codigo) as fecha_inicio

from tbl_eventos_inscritos h

where h.id_empresa='$id_empresa'

and h.id_dimension='$id_dimension'
and h.rut='$rut' order by h.id DESC limit 1


";

//if($rut=="14254390"){
//echo "<br>".$sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

//print_r($cod);

return $cod[0]->descripcion;
}
function Com_BuscaVisitas_Total($id_empresa, $id_ola, $fecha_inicio, $fecha_termino) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$qola = "";
$qola2 = "";

$qinicio = "";
$qtermino = "";
$qinicio = " AND fecha >= '" . $fecha_inicio . "' ";
$qtermino = " AND fecha <= '" . $fecha_termino . "' ";

if ($id_ola != '') {$encodola = BuscaDatosOla($id_ola, $id_empresa);
$qola = " and variables_get LIKE '%" . $encodola[0]->sesion . "%'  ";
$qola2 = " and (select id_grupointeres from tbl_mp_rel_rut_grupo where rut=h.rut and id_grupointeres='" . $encodola[0]->codigo . "' limit 1)='" . $encodola[0]->codigo . "'  ";
}

$sql = "

select count(h.id) as CuentaBci,
(SELECT count(DISTINCT rut) FROM `tbl_log_sistema` WHERE

`id_empresa` = '$id_empresa' AND `ambiente` = 'com_mp_personal' $qola $qinicio $qtermino) as CuentaComparte

from tbl_usuario h

where h.id_empresa='$id_empresa'  and h.vigencia='0' $qola2

";

//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Com_BuscaPublicaciones_Total($id_empresa, $id_ola, $fecha_inicio, $fecha_termino) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$qola = "";
$qola2 = "";
if ($id_ola != '') {$encodola = BuscaDatosOla($id_ola, $id_empresa);
$qola = " and h.id_subcategoria='" . $encodola[0]->codigo . "'  ";
$qola2 = " and id_subcategoria='" . $encodola[0]->codigo . "'   ";
}

$qinicio = "";
$qtermino = "";
$qinicio = " AND fecha >= '" . $fecha_inicio . "' ";
$qtermino = " AND fecha <= '" . $fecha_termino . "' ";

$sql = "

select count(h.id) as CuentaPost,
(SELECT count(DISTINCT rut) FROM tbl_mp WHERE id_empresa = '$id_empresa' $qola2 $qinicio $qtermino and id_estado>=5) as Autores

from tbl_mp h
where h.id_empresa='$id_empresa' and h.id_estado>=5 $qola $qinicio $qtermino";

//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Com_BuscaTagueados_Total($id_empresa, $id_ola, $fecha_inicio, $fecha_termino) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$qola = "";
$qola2 = "";

if ($id_ola != '') {$encodola = BuscaDatosOla($id_ola, $id_empresa);
$qola = "
and (select id_subcategoria from tbl_mp where id_mp=h.id_mp   and id_subcategoria='" . $encodola[0]->codigo . "' limit 1)='" . $encodola[0]->codigo . "'";

$qola2 = " and g.id_mp<>'' and (select id_subcategoria from tbl_mp where id_mp=g.id_mp   and id_subcategoria='" . $encodola[0]->codigo . "' limit 1)='" . $encodola[0]->codigo . "'  ";
}

$qinicio = "";
$qtermino = "";
$qinicio = " AND fecha >= '" . $fecha_inicio . "' ";
$qtermino = " AND fecha <= '" . $fecha_termino . "' ";

$sql = "
select count(h.id) as CuentaTagueos,
(SELECT count(DISTINCT g.rut_remitente) FROM tbl_mp_interacciones g WHERE g.id_empresa = '$id_empresa' and g.tipo='TAGUEADO' and g.id_mp<>'' $qola2

$qinicio $qtermino
)
as Autores

from tbl_mp_interacciones h
where h.id_empresa='$id_empresa' and h.tipo='TAGUEADO' and h.id_mp<>'' $qola

$qinicio $qtermino

";

//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Com_BuscaComentarios_Total($id_empresa, $id_ola, $fecha_inicio, $fecha_termino) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$qola = "";
$qola2 = "";
if ($id_ola != '') {$encodola = BuscaDatosOla($id_ola, $id_empresa);
$qola = "
and (select id_subcategoria from tbl_mp where id_mp=h.id_mp   and id_subcategoria='" . $encodola[0]->codigo . "' limit 1)='" . $encodola[0]->codigo . "'";

$qola2 = " and g.id_mp<>'' and (select id_subcategoria from tbl_mp where id_mp=g.id_mp   and id_subcategoria='" . $encodola[0]->codigo . "' limit 1)='" . $encodola[0]->codigo . "'  ";
}

$qinicio = "";
$qtermino = "";
$qinicio = " AND fecha >= '" . $fecha_inicio . "' ";
$qtermino = " AND fecha <= '" . $fecha_termino . "' ";

$sql = "
select count(h.id) as CuentaComentarios,
(SELECT count(DISTINCT g.rut_remitente) FROM tbl_mp_interacciones g WHERE g.id_empresa = '$id_empresa' and
(g.tipo='COMENTARIO_REPLY' or g.tipo='COMENTARIO')  $qola2 $qinicio $qtermino) as Autores

from tbl_mp_interacciones h
where h.id_empresa='$id_empresa' and (h.tipo='COMENTARIO_REPLY' or h.tipo='COMENTARIO') and h.id_mp<>'' $qola $qinicio $qtermino";

//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Com_Busca_Estadisticas_Visitas($fecha_inicio, $fecha_termino, $id_ola, $id_empresa) {

//echo      "fi $fecha_inicio, ft $fecha_termino";
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.* from tbl_estadisticas_globales h where h.fecha>='$fecha_inicio' and h.fecha<='$fecha_termino'

and (h.tipo='UU' or h.tipo='UV' or h.tipo='UA' or h.tipo='UN'  or h.tipo='LU')";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Com_Busca_Estadisticas_Interacciones($fecha_inicio, $fecha_termino, $id_ola, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.* from tbl_estadisticas_globales h where h.fecha>='$fecha_inicio' and h.fecha<='$fecha_termino' and h.id_empresa='$id_empresa'

and (h.tipo='PO' or h.tipo='CO' or h.tipo='TA' or h.tipo='MG'  or h.tipo='TI')";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}
function Com_Busca_olas($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_emb_olas where id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function BuscaDatosOla($id_ola, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_emb_olas where codigo='$id_ola' and id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Com_Busca_Grafico_visitas_12meses($id_empresa, $id_ola) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($id_ola != '') {$encodola = BuscaDatosOla($id_ola, $id_empresa);
$qola = " and variables_get LIKE '%" . $encodola[0]->sesion . "%'  ";}

//echo $qola; sleep(4); exit;

$sql = "

SELECT count(DISTINCT rut) ,

(SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and fecha>='2017-05-01' and fecha<='2017-05-31' $qola) as may17_uu,
(SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and fecha>='2017-06-01' and fecha<='2017-06-31' $qola) as jun17_uu,
(SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and fecha>='2017-07-01' and fecha<='2017-07-31' $qola) as jul17_uu,
(SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and fecha>='2017-08-01' and fecha<='2017-08-31' $qola) as ago17_uu,
(SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and fecha>='2017-09-01' and fecha<='2017-09-31' $qola) as sep17_uu,
(SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and fecha>='2017-10-01' and fecha<='2017-10-31' $qola) as oct17_uu,
(SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and fecha>='2017-11-01' and fecha<='2017-11-31' $qola) as nov17_uu,
(SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and fecha>='2017-12-01' and fecha<='2017-12-31' $qola) as dic17_uu,
(SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and fecha>='2018-01-01' and fecha<='2018-01-31' $qola) as ene18_uu,
(SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and fecha>='2018-02-01' and fecha<='2018-02-31' $qola) as feb18_uu,
(SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and fecha>='2018-03-01' and fecha<='2018-03-31' $qola) as mar18_uu,
(SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and fecha>='2018-04-01' and fecha<='2018-04-31' $qola) as abr18_uu,

(SELECT count(DISTINCT rut,fecha) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and fecha>='2017-05-01' and fecha<='2017-05-31' $qola) as may17_v,
(SELECT count(DISTINCT rut,fecha) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and fecha>='2017-06-01' and fecha<='2017-06-31' $qola) as jun17_v,
(SELECT count(DISTINCT rut,fecha) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and fecha>='2017-07-01' and fecha<='2017-07-31' $qola) as jul17_v,
(SELECT count(DISTINCT rut,fecha) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and fecha>='2017-08-01' and fecha<='2017-08-31' $qola) as ago17_v,
(SELECT count(DISTINCT rut,fecha) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and fecha>='2017-09-01' and fecha<='2017-09-31' $qola) as sep17_v,
(SELECT count(DISTINCT rut,fecha) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and fecha>='2017-10-01' and fecha<='2017-10-31' $qola) as oct17_v,
(SELECT count(DISTINCT rut,fecha) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and fecha>='2017-11-01' and fecha<='2017-11-31' $qola) as nov17_v,
(SELECT count(DISTINCT rut,fecha) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and fecha>='2017-12-01' and fecha<='2017-12-31' $qola) as dic17_v,
(SELECT count(DISTINCT rut,fecha) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and fecha>='2018-01-01' and fecha<='2018-01-31' $qola) as ene18_v,
(SELECT count(DISTINCT rut,fecha) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and fecha>='2018-02-01' and fecha<='2018-02-31' $qola) as feb18_v,
(SELECT count(DISTINCT rut,fecha) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and fecha>='2018-03-01' and fecha<='2018-03-31' $qola) as mar18_v,
(SELECT count(DISTINCT rut,fecha) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and fecha>='2018-04-01' and fecha<='2018-04-31' $qola) as abr18_v,

(SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and  fecha<='2017-05-31' $qola) as may17_ua,
(SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and  fecha<='2017-06-31' $qola) as jun17_ua,
(SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and  fecha<='2017-07-31' $qola) as jul17_ua,
(SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and  fecha<='2017-08-31' $qola) as ago17_ua,
(SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and  fecha<='2017-09-31' $qola) as sep17_ua,
(SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and  fecha<='2017-10-31' $qola) as oct17_ua,
(SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and  fecha<='2017-11-31' $qola) as nov17_ua,
(SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and  fecha<='2017-12-31' $qola) as dic17_ua,
(SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and  fecha<='2018-01-31' $qola) as ene18_ua,
(SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and  fecha<='2018-02-31' $qola) as feb18_ua,
(SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and  fecha<='2018-03-31' $qola) as mar18_ua,
(SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and  fecha<='2018-04-31' $qola) as abr18_ua,

((SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and  fecha<='2017-05-31' $qola) - (SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and  fecha<='2017-04-31' $qola)) as may17_un,
((SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and  fecha<='2017-06-31' $qola) - (SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and  fecha<='2017-05-31' $qola)) as jun17_un,
((SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and  fecha<='2017-07-31' $qola) - (SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and  fecha<='2017-06-31' $qola)) as jul17_un,
((SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and  fecha<='2017-08-31' $qola) - (SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and  fecha<='2017-07-31' $qola)) as ago17_un,
((SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and  fecha<='2017-09-31' $qola) - (SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and  fecha<='2017-08-31' $qola)) as sep17_un,
((SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and  fecha<='2017-10-31' $qola) - (SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and  fecha<='2017-09-31' $qola)) as oct17_un,
((SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and  fecha<='2017-11-31' $qola) - (SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and  fecha<='2017-10-31' $qola)) as nov17_un,
((SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and  fecha<='2017-12-31' $qola) - (SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and  fecha<='2017-11-31' $qola)) as dic17_un,
((SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and  fecha<='2018-01-31' $qola) - (SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and  fecha<='2017-12-31' $qola)) as ene18_un,
((SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and  fecha<='2018-02-31' $qola) - (SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and  fecha<='2018-01-31' $qola)) as feb18_un,
((SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and  fecha<='2018-03-31' $qola) - (SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and  fecha<='2018-02-31' $qola)) as mar18_un,
((SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and  fecha<='2018-01-31' $qola) - (SELECT count(DISTINCT rut) FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' and  fecha<='2018-03-31' $qola)) as abr18_un

FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal' $qola
";

//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Com_Busca_Grafico_publicaciones_12meses($id_empresa, $id_ola) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($id_ola != '') {$encodola = BuscaDatosOla($id_ola, $id_empresa);
$qola = " and id_subcategoria='" . $encodola[0]->sesion . "'  ";
$qola2 = "
and (select id_subcategoria from tbl_mp where id_mp=h.id_mp   and id_subcategoria='" . $encodola[0]->codigo . "' limit 1)='" . $encodola[0]->codigo . "'";
}

$sql = "SELECT count(DISTINCT rut) ,

(SELECT count(DISTINCT id_mp) FROM tbl_mp WHERE id_empresa = '$id_empresa' AND id_estado>=5  and fecha>='2017-05-01' and fecha<='2017-05-31' $qola ) as may17_uu,
(SELECT count(DISTINCT id_mp) FROM tbl_mp WHERE id_empresa = '$id_empresa' AND id_estado>=5  and fecha>='2017-06-01' and fecha<='2017-06-31' $qola ) as jun17_uu,
(SELECT count(DISTINCT id_mp) FROM tbl_mp WHERE id_empresa = '$id_empresa' AND id_estado>=5  and fecha>='2017-07-01' and fecha<='2017-07-31' $qola ) as jul17_uu,
(SELECT count(DISTINCT id_mp) FROM tbl_mp WHERE id_empresa = '$id_empresa' AND id_estado>=5  and fecha>='2017-08-01' and fecha<='2017-08-31' $qola ) as ago17_uu,
(SELECT count(DISTINCT id_mp) FROM tbl_mp WHERE id_empresa = '$id_empresa' AND id_estado>=5  and fecha>='2017-09-01' and fecha<='2017-09-31' $qola ) as sep17_uu,
(SELECT count(DISTINCT id_mp) FROM tbl_mp WHERE id_empresa = '$id_empresa' AND id_estado>=5  and fecha>='2017-10-01' and fecha<='2017-10-31' $qola ) as oct17_uu,
(SELECT count(DISTINCT id_mp) FROM tbl_mp WHERE id_empresa = '$id_empresa' AND id_estado>=5  and fecha>='2017-11-01' and fecha<='2017-11-31' $qola ) as nov17_uu,
(SELECT count(DISTINCT id_mp) FROM tbl_mp WHERE id_empresa = '$id_empresa' AND id_estado>=5  and fecha>='2017-12-01' and fecha<='2017-12-31' $qola ) as dic17_uu,
(SELECT count(DISTINCT id_mp) FROM tbl_mp WHERE id_empresa = '$id_empresa' AND id_estado>=5  and fecha>='2018-01-01' and fecha<='2018-01-31' $qola ) as ene18_uu,
(SELECT count(DISTINCT id_mp) FROM tbl_mp WHERE id_empresa = '$id_empresa' AND id_estado>=5  and fecha>='2018-02-01' and fecha<='2018-02-31' $qola ) as feb18_uu,
(SELECT count(DISTINCT id_mp) FROM tbl_mp WHERE id_empresa = '$id_empresa' AND id_estado>=5  and fecha>='2018-03-01' and fecha<='2018-03-31' $qola ) as mar18_uu,
(SELECT count(DISTINCT id_mp) FROM tbl_mp WHERE id_empresa = '$id_empresa' AND id_estado>=5  and fecha>='2018-04-01' and fecha<='2018-04-31' $qola ) as abr18_uu,

(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='COMENTARIO' or tipo='COMENTARIO_REPLY')  and fecha>='2017-05-01' and fecha<='2017-05-31' and id_mp<>'') as may17_v,
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='COMENTARIO' or tipo='COMENTARIO_REPLY')  and fecha>='2017-06-01' and fecha<='2017-06-31' and id_mp<>'') as jun17_v,
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='COMENTARIO' or tipo='COMENTARIO_REPLY')  and fecha>='2017-07-01' and fecha<='2017-07-31' and id_mp<>'') as jul17_v,
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='COMENTARIO' or tipo='COMENTARIO_REPLY')  and fecha>='2017-08-01' and fecha<='2017-08-31' and id_mp<>'') as ago17_v,
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='COMENTARIO' or tipo='COMENTARIO_REPLY')  and fecha>='2017-09-01' and fecha<='2017-09-31' and id_mp<>'') as sep17_v,
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='COMENTARIO' or tipo='COMENTARIO_REPLY')  and fecha>='2017-10-01' and fecha<='2017-10-31' and id_mp<>'') as oct17_v,
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='COMENTARIO' or tipo='COMENTARIO_REPLY')  and fecha>='2017-11-01' and fecha<='2017-11-31' and id_mp<>'') as nov17_v,
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='COMENTARIO' or tipo='COMENTARIO_REPLY')  and fecha>='2017-12-01' and fecha<='2017-12-31' and id_mp<>'') as dic17_v,
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='COMENTARIO' or tipo='COMENTARIO_REPLY')  and fecha>='2018-01-01' and fecha<='2018-01-31' and id_mp<>'') as ene18_v,
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='COMENTARIO' or tipo='COMENTARIO_REPLY')  and fecha>='2018-02-01' and fecha<='2018-02-31' and id_mp<>'') as feb18_v,
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='COMENTARIO' or tipo='COMENTARIO_REPLY')  and fecha>='2018-03-01' and fecha<='2018-03-31' and id_mp<>'') as mar18_v,
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='COMENTARIO' or tipo='COMENTARIO_REPLY')  and fecha>='2018-04-01' and fecha<='2018-04-31' and id_mp<>'') as abr18_v,

(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='TAGUEADO') and fecha>='2017-05-01' and fecha<='2017-05-31' and id_mp<>'') as may17_ua,
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='TAGUEADO') and fecha>='2017-06-01' and fecha<='2017-06-31' and id_mp<>'') as jun17_ua,
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='TAGUEADO') and fecha>='2017-07-01' and fecha<='2017-07-31' and id_mp<>'') as jul17_ua,
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='TAGUEADO') and fecha>='2017-08-01' and fecha<='2017-08-31' and id_mp<>'') as ago17_ua,
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='TAGUEADO') and fecha>='2017-09-01' and fecha<='2017-09-31' and id_mp<>'') as sep17_ua,
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='TAGUEADO') and fecha>='2017-10-01' and fecha<='2017-10-31' and id_mp<>'') as oct17_ua,
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='TAGUEADO') and fecha>='2017-11-01' and fecha<='2017-11-31' and id_mp<>'') as nov17_ua,
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='TAGUEADO') and fecha>='2017-12-01' and fecha<='2017-12-31' and id_mp<>'') as dic17_ua,
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='TAGUEADO') and fecha>='2018-01-01' and fecha<='2018-01-31' and id_mp<>'') as ene18_ua,
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='TAGUEADO') and fecha>='2018-02-01' and fecha<='2018-02-31' and id_mp<>'') as feb18_ua,
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='TAGUEADO') and fecha>='2018-03-01' and fecha<='2018-03-31' and id_mp<>'') as mar18_ua,
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='TAGUEADO') and fecha>='2018-04-01' and fecha<='2018-04-31' and id_mp<>'') as abr18_ua,

(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='MEGUSTA_POST' or tipo='MEGUSTA_POST_REPLY' or tipo='MEGUSTA') and fecha>='2017-05-01' and fecha<='2017-05-31' and id_mp<>'' ) as may17_mg,
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='MEGUSTA_POST' or tipo='MEGUSTA_POST_REPLY' or tipo='MEGUSTA') and fecha>='2017-06-01' and fecha<='2017-06-31'and id_mp<>'') as jun17_mg,
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='MEGUSTA_POST' or tipo='MEGUSTA_POST_REPLY' or tipo='MEGUSTA') and fecha>='2017-07-01' and fecha<='2017-07-31' and id_mp<>'') as jul17_mg,
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='MEGUSTA_POST' or tipo='MEGUSTA_POST_REPLY' or tipo='MEGUSTA') and fecha>='2017-08-01' and fecha<='2017-08-31' and id_mp<>'') as ago17_mg,
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='MEGUSTA_POST' or tipo='MEGUSTA_POST_REPLY' or tipo='MEGUSTA') and fecha>='2017-09-01' and fecha<='2017-09-31' and id_mp<>'') as sep17_mg,
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='MEGUSTA_POST' or tipo='MEGUSTA_POST_REPLY' or tipo='MEGUSTA') and fecha>='2017-10-01' and fecha<='2017-10-31' and id_mp<>'') as oct17_mg,
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='MEGUSTA_POST' or tipo='MEGUSTA_POST_REPLY' or tipo='MEGUSTA') and fecha>='2017-11-01' and fecha<='2017-11-31' and id_mp<>'') as nov17_mg,
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='MEGUSTA_POST' or tipo='MEGUSTA_POST_REPLY' or tipo='MEGUSTA') and fecha>='2017-12-01' and fecha<='2017-12-31' and id_mp<>'') as dic17_mg,
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='MEGUSTA_POST' or tipo='MEGUSTA_POST_REPLY' or tipo='MEGUSTA') and fecha>='2018-01-01' and fecha<='2018-01-31' and id_mp<>'') as ene18_mg,
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='MEGUSTA_POST' or tipo='MEGUSTA_POST_REPLY' or tipo='MEGUSTA') and fecha>='2018-02-01' and fecha<='2018-02-31' and id_mp<>'') as feb18_mg,
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='MEGUSTA_POST' or tipo='MEGUSTA_POST_REPLY' or tipo='MEGUSTA') and fecha>='2018-03-01' and fecha<='2018-03-31' and id_mp<>'') as mar18_mg,
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='MEGUSTA_POST' or tipo='MEGUSTA_POST_REPLY' or tipo='MEGUSTA') and fecha>='2018-04-01' and fecha<='2018-04-31' and id_mp<>'') as abr18_mg,

(     (SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='COMENTARIO' or tipo='COMENTARIO_REPLY')  and fecha>='2017-05-01' and fecha<='2017-05-31' and id_mp<>'')
+
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='TAGUEADO') and fecha>='2017-05-01' and fecha<='2017-05-31' and id_mp<>'')
+
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='MEGUSTA_POST' or tipo='MEGUSTA_POST_REPLY' or tipo='MEGUSTA') and fecha>='2017-05-01' and fecha<='2017-05-31' and id_mp<>'' )
) as may17_ti,

(     (SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='COMENTARIO' or tipo='COMENTARIO_REPLY')  and fecha>='2017-06-01' and fecha<='2017-06-31' and id_mp<>'')
+
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='TAGUEADO') and fecha>='2017-06-01' and fecha<='2017-06-31' and id_mp<>'')
+
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='MEGUSTA_POST' or tipo='MEGUSTA_POST_REPLY' or tipo='MEGUSTA') and fecha>='2017-06-01' and fecha<='2017-06-31' and id_mp<>'' )
) as jun17_ti,

(     (SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='COMENTARIO' or tipo='COMENTARIO_REPLY')  and fecha>='2017-07-01' and fecha<='2017-07-31' and id_mp<>'')
+
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='TAGUEADO') and fecha>='2017-07-01' and fecha<='2017-07-31' and id_mp<>'')
+
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='MEGUSTA_POST' or tipo='MEGUSTA_POST_REPLY' or tipo='MEGUSTA') and fecha>='2017-07-01' and fecha<='2017-07-31' and id_mp<>'' )
) as jul17_ti,

(     (SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='COMENTARIO' or tipo='COMENTARIO_REPLY')  and fecha>='2017-08-01' and fecha<='2017-08-31' and id_mp<>'')
+
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='TAGUEADO') and fecha>='2017-08-01' and fecha<='2017-08-31' and id_mp<>'')
+
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='MEGUSTA_POST' or tipo='MEGUSTA_POST_REPLY' or tipo='MEGUSTA') and fecha>='2017-08-01' and fecha<='2017-08-31' and id_mp<>'' )
) as ago17_ti,

(     (SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='COMENTARIO' or tipo='COMENTARIO_REPLY')  and fecha>='2017-09-01' and fecha<='2017-90-31' and id_mp<>'')
+
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='TAGUEADO') and fecha>='2017-09-01' and fecha<='2017-09-31' and id_mp<>'')
+
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='MEGUSTA_POST' or tipo='MEGUSTA_POST_REPLY' or tipo='MEGUSTA') and fecha>='2017-09-01' and fecha<='2017-09-31' and id_mp<>'' )
) as sep17_ti,

(     (SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='COMENTARIO' or tipo='COMENTARIO_REPLY')  and fecha>='2017-10-01' and fecha<='2017-10-31' and id_mp<>'')
+
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='TAGUEADO') and fecha>='2017-10-01' and fecha<='2017-10-31' and id_mp<>'')
+
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='MEGUSTA_POST' or tipo='MEGUSTA_POST_REPLY' or tipo='MEGUSTA') and fecha>='2017-10-01' and fecha<='2017-10-31' and id_mp<>'' )
) as oct17_ti,

(     (SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='COMENTARIO' or tipo='COMENTARIO_REPLY')  and fecha>='2017-11-01' and fecha<='2017-11-31' and id_mp<>'')
+
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='TAGUEADO') and fecha>='2017-11-01' and fecha<='2017-11-31' and id_mp<>'')
+
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='MEGUSTA_POST' or tipo='MEGUSTA_POST_REPLY' or tipo='MEGUSTA') and fecha>='2017-11-01' and fecha<='2017-11-31' and id_mp<>'' )
) as nov17_ti,

(     (SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='COMENTARIO' or tipo='COMENTARIO_REPLY')  and fecha>='2017-12-01' and fecha<='2017-12-31' and id_mp<>'')
+
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='TAGUEADO') and fecha>='2017-12-01' and fecha<='2017-12-31' and id_mp<>'')
+
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='MEGUSTA_POST' or tipo='MEGUSTA_POST_REPLY' or tipo='MEGUSTA') and fecha>='2017-12-01' and fecha<='2017-12-31' and id_mp<>'' )
) as dic17_ti,

(     (SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='COMENTARIO' or tipo='COMENTARIO_REPLY')  and fecha>='2018-01-01' and fecha<='2018-01-31' and id_mp<>'')
+
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='TAGUEADO') and fecha>='2018-01-01' and fecha<='2018-01-31' and id_mp<>'')
+
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='MEGUSTA_POST' or tipo='MEGUSTA_POST_REPLY' or tipo='MEGUSTA') and fecha>='2018-01-01' and fecha<='2018-01-31' and id_mp<>'' )
) as ene18_ti,

(     (SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='COMENTARIO' or tipo='COMENTARIO_REPLY')  and fecha>='2018-02-01' and fecha<='2018-02-31' and id_mp<>'')
+
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='TAGUEADO') and fecha>='2018-02-01' and fecha<='2018-02-31' and id_mp<>'')
+
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='MEGUSTA_POST' or tipo='MEGUSTA_POST_REPLY' or tipo='MEGUSTA') and fecha>='2018-02-01' and fecha<='2018-02-31' and id_mp<>'' )
) as feb18_ti,

(     (SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='COMENTARIO' or tipo='COMENTARIO_REPLY')  and fecha>='2018-03-01' and fecha<='2018-03-31' and id_mp<>'')
+
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='TAGUEADO') and fecha>='2018-03-01' and fecha<='2018-03-31' and id_mp<>'')
+
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='MEGUSTA_POST' or tipo='MEGUSTA_POST_REPLY' or tipo='MEGUSTA') and fecha>='2018-03-01' and fecha<='2018-03-31' and id_mp<>'' )
) as mar18_ti,

(     (SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='COMENTARIO' or tipo='COMENTARIO_REPLY')  and fecha>='2018-04-01' and fecha<='2018-04-31' and id_mp<>'')
+
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='TAGUEADO') and fecha>='2018-04-01' and fecha<='2018-04-31' and id_mp<>'')
+
(SELECT count(DISTINCT id) FROM tbl_mp_interacciones WHERE id_empresa = '$id_empresa' AND (tipo='MEGUSTA_POST' or tipo='MEGUSTA_POST_REPLY' or tipo='MEGUSTA') and fecha>='2018-04-01' and fecha<='2018-04-31' and id_mp<>'' )
) as abr18_ti


FROM tbl_log_sistema WHERE id_empresa = '$id_empresa' AND ambiente = 'com_mp_personal'";

// echo "sql $sql";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function BuscaIdCategoriaEvento($codigo, $id_dimension, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select id_categoria from tbl_eventos where codigo='$codigo' and id_dimension='$id_dimension' and id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod[0]->id_categoria;
}

function ActualizaEventosInscritos($codigo, $id_categoria, $id_dimension, $rut, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$id_empresa = $_SESSION["id_empresa"];

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select count(id) as cuenta from tbl_eventos_inscritos where id_empresa='$id_empresa'
and codigo='$codigo' and id_categoria='$id_categoria' and id_dimension='$id_dimension' and rut='$rut'";

//echo "<br>sql $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

//print_r($cod);
$fecha = date("Y-m-d");
$tiempo = date("H:m:s");

if ($cod[0]->cuenta == '0') {
$sql = "    INSERT INTO tbl_eventos_inscritos (rut, codigo, id_categoria, id_dimension, id_empresa, fecha, hora, estado)
VALUES ('$rut', '$codigo', '$id_categoria', '$id_dimension', '$id_empresa', '$fecha', '$hora', 'OK')";
$database->setquery($sql);
$database->query();

//echo "<br><br>...$sql";
}

return $cod;
}

function ActualizaAcademiaData($rut, $induccion, $faseuno, $fasedos, $induccion_forouno, $induccion_forodos, $faseuno_forouno, $faseuno_forodos, $fasedos_forouno, $fasedos_forodos, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

//echo "<br>$rut, $induccion, $faseuno, $fasedos, $faseuno_forouno, $faseuno_forodos, $fasedos_forouno, $fasedos_forodos, $id_empresa";

$rut = trim($rut);
$id_empresa = $_SESSION["id_empresa"];

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select count(id) as cuenta from tbl_academia_lider where id_empresa='$id_empresa' and rut='$rut'";

//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

//print_r($cod);
$hoy = date("Y-m-d");

if ($cod[0]->cuenta == '0') {
$sql = "    INSERT INTO tbl_academia_lider (rut, id_empresa, fecha_ingreso)    VALUES ('$rut', '$id_empresa', '$hoy')";
$database->setquery($sql);
$database->query();
}

//echo "<br>sql $sql";

if ($induccion != '') {
$sql = " update tbl_academia_lider set induccion_a='$induccion' where rut='$rut' and id_empresa='$id_empresa'";
$database->setquery($sql);
$database->query();
} //echo "<br>sql $sql";

if ($faseuno != '') {
$sql = " update tbl_academia_lider set fase_uno_a='$faseuno' where rut='$rut' and id_empresa='$id_empresa'";
$database->setquery($sql);
$database->query();
} //echo "<br>sql $sql";

if ($fasedos != '') {
$sql = " update tbl_academia_lider set fase_dos_a='$fasedos' where rut='$rut' and id_empresa='$id_empresa'";
$database->setquery($sql);
$database->query();
} //echo "<br>sql $sql";

if ($induccion_forouno != '') {
$sql = " update tbl_academia_lider set induccion_foro_uno='$induccion_forouno' where rut='$rut' and id_empresa='$id_empresa'";
$database->setquery($sql);
$database->query();
} //echo "<br>sql $sql";

if ($induccion_forodos != '') {
$sql = " update tbl_academia_lider set induccion_foro_dos='$induccion_forodos' where rut='$rut' and id_empresa='$id_empresa'";
$database->setquery($sql);
$database->query();
}

if ($faseuno_forouno != '') {
$sql = " update tbl_academia_lider set fase_uno_foro_uno='$faseuno_forouno' where rut='$rut' and id_empresa='$id_empresa'";
$database->setquery($sql);
$database->query();
} //echo "<br>sql $sql";

if ($faseuno_forodos != '') {
$sql = " update tbl_academia_lider set fase_uno_foro_dos='$faseuno_forodos' where rut='$rut' and id_empresa='$id_empresa'";
$database->setquery($sql);
$database->query();
}

if ($fasedos_forouno != '') {
$sql = " update tbl_academia_lider set fase_dos_foro_uno='$fasedos_forouno' where rut='$rut' and id_empresa='$id_empresa'";
$database->setquery($sql);
$database->query();
} //echo "<br>sql $sql";

if ($fasedos_forodos != '') {
$sql = " update tbl_academia_lider set fase_dos_foro_dos='$fasedos_forodos' where rut='$rut' and id_empresa='$id_empresa'";
$database->setquery($sql);
$database->query();
} //echo "<br>sql $sql";

//exit();

return $cod;
}

function ImparticionMod4ActualizaIdMalla($id_inscripcion, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "update tbl_inscripcion_usuarios  h

set h.id_malla=(select id_malla from rel_lms_malla_curso where id_curso=h.id_curso and id_malla<>'e_p_f')

where h.id_empresa='$id_empresa' and h.id_inscripcion='$id_inscripcion'

and h.id_malla is null";

//echo $sql; sleep(1);

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

$sql2 = "UPDATE tbl_inscripcion_usuarios h set
h.fecha_inicio=(select fecha_inicio from rel_objeto_imparticiones where id_inscripcion=h.id_inscripcion and id_empresa=h.id_empresa limit 1),
h.fecha_termino=(select fecha_termino from rel_objeto_imparticiones where id_inscripcion=h.id_inscripcion and id_empresa=h.id_empresa limit 1),
h.hora_inicio=(select hora_inicio from rel_objeto_imparticiones where id_inscripcion=h.id_inscripcion and id_empresa=h.id_empresa limit 1),
h.hora_termino=(select hora_termino from rel_objeto_imparticiones where id_inscripcion=h.id_inscripcion and id_empresa=h.id_empresa limit 1)

where h.id_empresa='$id_empresa' and h.id_inscripcion='$id_inscripcion'";

//echo "<br><br>".$sql2;

$database->setquery($sql2);
$database->query();

$sql3 = "SELECT id_inscripcion, count( * )  as cuenta
FROM rel_objeto_imparticiones where id_inscripcion='$id_inscripcion' GROUP BY id_inscripcion
HAVING count( * ) >1";

$database->setquery($sql3);
$database->query();
$cod3 = $database->listObjects();

if ($cod3[0]->cuenta > 1) {
$sql4 = "delete from rel_objeto_imparticiones where id_inscripcion='$id_inscripcion'  limit 1";
$database->setquery($sql4);
$database->query();
}
}

function CalculoTalentAjuste($id_cargo, $nivel_esperado, $rut) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select h.*,
(select count(id)  from tbl_skills_resultados where rut='$rut' and id_nivel_esperado='$nivel_esperado' and id_cargo='$id_cargo' ) as todo,
(select count(id)  from tbl_skills_resultados where rut='$rut' and id_nivel_esperado='$nivel_esperado' and id_cargo='$id_cargo' and ajuste<0) as negativos,
(select count(id)  from tbl_skills_resultados where rut='$rut' and id_nivel_esperado='$nivel_esperado' and id_cargo='$id_cargo' and ajuste=0) as ceros,
(select count(id)  from tbl_skills_resultados where rut='$rut' and id_nivel_esperado='$nivel_esperado' and id_cargo='$id_cargo' and ajuste>0) as positivos,
round( 100*(select count(id)  from tbl_skills_resultados where rut='$rut' and id_nivel_esperado='$nivel_esperado' and id_cargo='$id_cargo' and ajuste=0) /(select count(id)  from tbl_skills_resultados where rut='$rut' and id_nivel_esperado='$nivel_esperado' and id_cargo='$id_cargo' )) as PorcentajeAjuste


from tbl_skills_resultados h where h.rut='$rut' and h.id_nivel_esperado='$nivel_esperado' and h.id_cargo='$id_cargo'
group by h.rut

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}
function Puntos_Canje_saldos($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.*, sum(puntos) as puntos,
(select sum(puntos) from tbl_premios_canje  where estadovalidacion='1' and rut=h.rut and id_empresa=h.id_empresa) as canjeados,
(sum(puntos) - (select sum(puntos) from tbl_premios_canje  where estadovalidacion='1' and rut=h.rut and id_empresa=h.id_empresa)) as saldo
from tbl_premios_puntos_usuarios h where h.id_empresa='$id_empresa' group by rut";

//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Puntos_Medallas_detalle_Descarga($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.* from tbl_gamificado_puntos h where h.id_empresa='$id_empresa' and (h.puntos>0 or h.medallas>0)    ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Puntos_Medallas_consolidado_Descarga($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.*, sum(h.puntos) as sumapuntos, sum(h.medallas) as sumamedallas from tbl_gamificado_puntos h where h.id_empresa='$id_empresa' and (h.puntos>0 or h.medallas>0) group by rut    ";

//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function emb_tareas_Edit_data($rut, $id_tarea, $link, $comentarios, $trabajaste, $estado, $id_ola, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

// existe tarea

$sql = "select count(h.id) as cuenta from tbl_emb_respuestas_embajadores_tareas h where h.rut='$rut' and h.id_empresa='$id_empresa' and h.id_tarea='$id_tarea'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

//echo $sql;    echo "<br>";    echo $cod[0]->cuenta;

$hoy = date("Y-m-d");

if ($cod[0]->cuenta == 0) {
$sql = "insert into tbl_emb_respuestas_embajadores_tareas

(rut, id_tarea, id_empresa, fecha_inicio, fecha_registro, estado, id_grupo_interes)

VALUES ('$rut','$id_tarea','$id_empresa','$hoy','$hoy','$estado', '$ola')";
$database->setquery($sql);
$database->query();
}
//echo $sql; sleep(5);
$sql = "

update tbl_emb_respuestas_embajadores_tareas h

set link='$link', comentarios='$comentarios', estado='$estado', conquientrabajaste='$trabajaste', id_grupo_interes='$id_ola'

where h.rut='$rut' and h.id_empresa='$id_empresa' and h.id_tarea='$id_tarea'

";

//echo $sql; sleep(5);
//it();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function UpdateInscripcionUsuarioFechasfromRel($id_inscripcion, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

update tbl_inscripcion_usuarios h

set

h.fecha_inicio=(select fecha_inicio from rel_objeto_imparticiones  where id_inscripcion='$id_inscripcion'  and id_empresa='$id_empresa'),
h.fecha_termino=(select fecha_termino from rel_objeto_imparticiones  where id_inscripcion='$id_inscripcion' and id_empresa='$id_empresa'),
h.hora_inicio=(select hora_inicio from rel_objeto_imparticiones  where id_inscripcion='$id_inscripcion' and id_empresa='$id_empresa'),
h.hora_termino=(select hora_termino from rel_objeto_imparticiones  where id_inscripcion='$id_inscripcion' and id_empresa='$id_empresa')

where h.id_inscripcion='$id_inscripcion' and h.id_empresa='$id_empresa'

";

//echo $sql; sleep(5);
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function InsertNotificacionesPendientes($tipoenvio, $nombre, $rut, $fecha_envio, $id_empresa,
$to, $nombreto, $from, $nombrefrom, $tipo, $subject, $titulo1, $subtitulo1, $texto1, $url, $texto_url,
$texto2, $texto3, $texto4, $logo, $tipomensaje, $key, $template) {

$nombre = utf8_decode($nombre);
$nombreto = utf8_decode($nombreto);
$nombrefrom = utf8_decode($nombrefrom);

$subject = utf8_decode($subject);
$titulo1 = utf8_decode($titulo1);
$subtitulo1 = utf8_decode($subtitulo1);
$texto1 = utf8_decode($texto1);

$texto_url = ($texto_url);
$texto2 = ($texto2);
$texto3 = ($texto3);

$texto4 = ($texto4);

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select id from tbl_notificaciones_pendientes where rut='$rut' and fecha_envio='$fecha_envio' and tipoenvio='$tipoenvio' and id_empresa='$id_empresa'";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

//print_r($cod);

if ($cod[0]->id > 0) {
} else {

$sql = "
INSERT INTO tbl_notificaciones_pendientes

(`tipoenvio`,`nombre`,`rut`,`fecha_envio`,`id_empresa`, `hacia`,`nombreto`,`desde`,`nombrefrom`,`tipo`,`asunto`,`titulo1`,
`subtitulo1`,`texto1`,`url`,`texto_url`, `texto2`,`texto3`,`texto4`,`logo`,`tipomensaje`,`clave`,`template`)

VALUES ('$tipoenvio','$nombre','$rut','$fecha_envio','$id_empresa',
'$to','$nombreto','$from','$nombrefrom','$tipo','$subject','$titulo1','$subtitulo1','$texto1','$url','$texto_url',
'$texto2','$texto3','$texto4','$logo','$tipomensaje','$key','$template')
";

if ($to != '' ) {
if($to<>"."){
$database->setquery($sql);
$database->query();
}
}
}
//echo "<br> <br> $sql";

//    echo mysql_errno($database) . ": " . mysql_error($database). "\n";
}

function Not_Actualiza_estado($id, $estado) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "

update tbl_notificaciones_automaticas set estado='$estado' where id='$id'";

//echo "<br>$sql";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}
function Enc_ActualizaEstado($ie, $estado) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "

update tbl_enc_elearning_medicion set imagenlogo='$estado' where id='$ie'";

//echo "<br>$sql"; exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function Not_buscaNotificacionesEnvioHoyEstadoNull($fecha, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = ("

select h.* from tbl_notificaciones_automaticas h where h.fecha_envio='$fecha' and h.estado is NULL

");
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Not_buscaMedicionResponsable($fecha, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = ("

select h.*

from tbl_enc_elearning_medicion h

where h.id_empresa='$id_empresa'

and (h.fecha1='$fecha' or h.fecha2='$fecha' or h.fecha3='$fecha')

");
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Not_buscamediciones_Pendientes_usuarios_Jefe_usuario($fecha, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.*,
(select nombre from tbl_enc_elearning_medicion where id=h.id_medicion) as nombremedicion,
(select fecha1 from tbl_enc_elearning_medicion where id=h.id_medicion) as fecha1,
(select fecha2 from tbl_enc_elearning_medicion where id=h.id_medicion) as fecha2,
(select fecha3 from tbl_enc_elearning_medicion where id=h.id_medicion) as fecha3,
(select count(id) from tbl_enc_elearning_preg where id_encuesta=h.id_encuesta) as cuentaPreg,
(select count(id) from tbl_enc_elearning_respuestas where id_encuesta=h.id_encuesta and rut_colaborador=h.rut and id_tipo='$fecha')
as cuentaResp

from tbl_enc_elearning_usuarios h

where

h.id_empresa='$id_empresa'

and
(
(select fecha1 from tbl_enc_elearning_medicion where id=h.id_medicion)='$fecha' or
(select fecha2 from tbl_enc_elearning_medicion where id=h.id_medicion)='$fecha' or
(select fecha3 from tbl_enc_elearning_medicion where id=h.id_medicion)='$fecha'
)

and h.rut<>h.jefe and h.jefe is not null

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Not_buscamediciones_Pendientes_Evaluaciones_individuales($fecha, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.*,
(select nombre from tbl_enc_elearning_medicion where id=h.id_medicion) as nombremedicion,
(select count(id) from tbl_enc_elearning_preg where id_encuesta=h.id_encuesta) as cuentaPreg,
(select count(id) from tbl_enc_elearning_respuestas where id_encuesta=h.id_encuesta and rut_colaborador=h.rut)
as cuentaResp

from tbl_enc_elearning_usuarios h

where

h.id_empresa='$id_empresa'

and  h.jefe is null

and (select count(id) from tbl_enc_elearning_preg where id_encuesta=h.id_encuesta) > 0
and (select count(id) from tbl_enc_elearning_respuestas where id_encuesta=h.id_encuesta and rut_colaborador=h.rut)  < (select count(id) from tbl_enc_elearning_preg where id_encuesta=h.id_encuesta)
";
//echo $sql;



$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Not_cursosElearningObligatoriosPendientes($id_programa,$id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if($id_programa<>''){$queryprograma=" and h.id_programa='$id_programa' ";} else {$queryprograma="";}

$sql = "

select h.rut, h.id_curso, h.avance,
(select fecha from tbl_inscripcion_usuarios where rut=h.rut and id_curso=h.id_curso order by fecha DESC limit 1 ) as FechaInscripcion,
(select jefe from tbl_usuario where rut=h.rut) as Jefe
from tbl_lms_reportes h
where h.avance<>100

AND ( SELECT modalidad FROM tbl_lms_curso WHERE id = h.id_curso) <> 2
AND ( ( ( SELECT opcional FROM tbl_lms_programas_bbdd WHERE id_programa = h.id_programa order by id DESC LIMIT 1 )  IS NULL )
OR (( SELECT opcional FROM tbl_lms_programas_bbdd WHERE id_programa = h.id_programa order by id DESC LIMIT 1  ) = 0 ))
AND ( (SELECT inactivo FROM tbl_lms_programas_bbdd WHERE id_programa = h.id_programa order by id DESC LIMIT 1  ) IS NULL )
AND ((SELECT opcional from rel_lms_malla_persona where rut=h.rut and id_malla=h.id_malla order by id DESC limit 1 )='' OR
(SELECT opcional from rel_lms_malla_persona where rut=h.rut and id_malla=h.id_malla order by id DESC limit 1 ) is NULL
)

$queryprograma
and h.curso_opcional=0
and h.id_empresa='$id_empresa'
and (select email from tbl_usuario where rut=h.rut)<>''


";
//echo "<br><br><br><h1>Not_cursosElearningObligatoriosPendientes</h1><br>$sql";
//and h.rut='16886519'

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}
function Not_cursosElearningObligatoriosPendientesFecha($id_empresa, $fecha) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select h.rut, h.id_curso, h.avance,
(select fecha from tbl_inscripcion_usuarios where rut=h.rut and id_curso=h.id_curso order by fecha DESC limit 1 ) as FechaInscripcion,
(select jefe from tbl_usuario where rut=h.rut) as Jefe
from tbl_lms_reportes h
where h.avance<>100

and (select modalidad from tbl_lms_curso where id=h.id_curso) <>2

and (
((select opcional from tbl_lms_programas_bbdd where id_programa=h.id_programa ) is NULL) or ((select opcional from tbl_lms_programas_bbdd where id_programa=h.id_programa ) =0)
)

and (select fecha from tbl_inscripcion_usuarios where rut=h.rut and id_curso=h.id_curso order by fecha DESC limit 1 )<'$fecha'


and h.curso_opcional=0
and h.id_empresa='$id_empresa'




";
//echo "<br>4<br>$sql";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Not_cursosElearningObligatoriosPendientesFechaJefe($id_empresa, $id_programa, $fecha, $division) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
if($id_programa<>''){$queryprograma=" and h.id_programa='$id_programa' ";} else {$queryprograma="";}

if($division<>''){$query_division=" and (select division from tbl_usuario where rut=h.rut)='".$division."' ";} else {$query_division="  ";}

$sql = "

select h.rut, h.id_curso, h.avance,
(select fecha from tbl_inscripcion_usuarios where rut=h.rut and id_curso=h.id_curso order by fecha DESC limit 1 ) as FechaInscripcion,
(select jefe from tbl_usuario where rut=h.rut limit 1) as Jefe
from tbl_lms_reportes h
where h.avance<>100


AND ( SELECT modalidad FROM tbl_lms_curso WHERE id = h.id_curso limit 1) <> 2
AND ( ( ( SELECT opcional FROM tbl_lms_programas_bbdd WHERE id_programa = h.id_programa LIMIT 1 ) IS NULL )
OR (( SELECT opcional FROM tbl_lms_programas_bbdd WHERE id_programa = h.id_programa LIMIT 1 ) = 0 ))
AND ( (SELECT inactivo FROM tbl_lms_programas_bbdd WHERE id_programa = h.id_programa LIMIT 1 ) IS NULL )
AND ((SELECT opcional from rel_lms_malla_persona where rut=h.rut and id_malla=h.id_malla limit 1)='' OR
(SELECT opcional from rel_lms_malla_persona where rut=h.rut and id_malla=h.id_malla limit 1) is NULL
)

$queryprograma

and h.id_empresa='$id_empresa'
and (select count(id) from tbl_rut_no_correo where rut=h.rut)='0'
and (select jefe from tbl_usuario where rut=h.rut)<>''
and (select email from tbl_usuario where rut=h.rut)<>''

$query_division							


group by (select jefe from tbl_usuario where rut=h.rut)


";
//and (select jefe from tbl_usuario where rut=h.rut)='10033383'
//echo "<br><br><br><h1>Not_cursosElearningObligatoriosPendientesFechaJefe</h1> <br>$sql";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Not_listacursosElearningObligatoriosPendientes($rut, $id_programa, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
if($id_programa<>''){$queryprograma=" and h.id_programa='$id_programa' ";} else {$queryprograma="";}
$sql = "
select h.rut,
(select nombre from tbl_lms_curso where id=h.id_curso) as nombre_curso,
(select nombre_programa from tbl_lms_programas_bbdd where id_programa=h.id_programa) as nombre_programa

from tbl_lms_reportes h
where h.avance<>100

AND ( SELECT modalidad FROM tbl_lms_curso WHERE id = h.id_curso) <> 2
AND ( ( ( SELECT opcional FROM tbl_lms_programas_bbdd WHERE id_programa = h.id_programa order by id DESC LIMIT 1 ) IS NULL )
OR (( SELECT opcional FROM tbl_lms_programas_bbdd WHERE id_programa = h.id_programa order by id DESC LIMIT 1 ) = 0 ))
AND ( (SELECT inactivo FROM tbl_lms_programas_bbdd WHERE id_programa = h.id_programa order by id DESC LIMIT 1 ) IS NULL )
AND ((SELECT opcional from rel_lms_malla_persona where rut=h.rut and id_malla=h.id_malla order by id DESC LIMIT 1 )='' OR
(SELECT opcional from rel_lms_malla_persona where rut=h.rut and id_malla=h.id_malla order by id DESC LIMIT 1 ) is NULL
)

and h.id_empresa='$id_empresa'
$queryprograma
and h.rut='$rut'


";
//echo "<br>5<br>$sql";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Not_listacursosElearningObligatoriosPendientesFechaJefe($rut_jefe, $fecha, $id_programa,  $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
if($id_programa<>''){$queryprograma=" and h.id_programa='$id_programa' ";} else {$queryprograma="";}
$sql = "
select h.rut, h.nombre, h.id_curso, h.avance,
(select nombre from tbl_lms_curso where id=h.id_curso limit 1) as nombre_curso,
(select nombre_programa from tbl_lms_programas_bbdd where id_programa=h.id_programa limit 1) as nombre_programa,
(select fecha from tbl_inscripcion_usuarios where rut=h.rut and id_curso=h.id_curso order by fecha DESC limit 1 ) as FechaInscripcion,
(select jefe from tbl_usuario where rut=h.rut limit 1) as Jefe
from tbl_lms_reportes h
where h.avance<>100

AND ( SELECT modalidad FROM tbl_lms_curso WHERE id = h.id_curso) <> 2
AND ( ( ( SELECT opcional FROM tbl_lms_programas_bbdd WHERE id_programa = h.id_programa order by id DESC LIMIT 1 ) IS NULL )
OR (( SELECT opcional FROM tbl_lms_programas_bbdd WHERE id_programa = h.id_programa  order by id DESC  LIMIT 1 ) = 0 ))
AND ( (SELECT inactivo FROM tbl_lms_programas_bbdd WHERE id_programa = h.id_programa  order by id DESC  LIMIT 1 ) IS NULL )
AND ((SELECT opcional from rel_lms_malla_persona where rut=h.rut and id_malla=h.id_malla order by id DESC  LIMIT 1)='' OR
(SELECT opcional from rel_lms_malla_persona where rut=h.rut and id_malla=h.id_malla order by id DESC  LIMIT 1) is NULL
)

and (select fecha from tbl_inscripcion_usuarios where rut=h.rut and id_curso=h.id_curso order by fecha DESC limit 1 )<'$fecha'

$queryprograma
and h.id_empresa='$id_empresa'
and (select jefe from tbl_usuario where rut=h.rut)='$rut_jefe'
and (select count(id) from tbl_rut_no_correo where rut=h.rut)='0'

order by h.nombre
";
//echo "<br>5<br>$sql";

//echo "<br><br><br><h1>Not_listacursosElearningObligatoriosPendientesFechaJefe</h1> <br>$sql";
//exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Not_cursosElearningInscripcion($fecha, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select h.rut from tbl_inscripcion_usuarios h where h.fecha='$fecha' and h.id_empresa='$id_empresa' group by h.rut


";
//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Not_lista_cursosElearningInscripcion($fecha, $rut, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select h.*,

(select nombre from tbl_lms_curso where id=h.id_curso) as nombre_curso,
(select nombre_programa from tbl_lms_programas_bbdd where id_programa=(select id_programa from rel_lms_malla_curso where id_curso=h.id_curso and id_malla=h.id_malla limit 1)) as nombre_programa

from tbl_inscripcion_usuarios h where h.fecha='$fecha' and h.id_empresa='$id_empresa' and h.rut='$rut'

";
//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function BuscaIdProgramadadoIdCurso($id_curso_sent, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = ("

select * from rel_lms_malla_curso where id_curso='$id_curso_sent' and id_empresa='$id_empresa'

");
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function BuscaMediciones_hoy($id_empresa, $fecha) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = ("select h.* from tbl_enc_elearning_medicion h

where (h.fecha1='$fecha' or h.fecha2='$fecha' or h.fecha3='$fecha') and id_empresa='$id_empresa'");
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function MedCuentaEmailsEnviados($idmed, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = ("select count(id) as cuenta from tbl_log_emails where tipo='Email_Masivo_Med' and dato='$idmed' and id_empresa='$id_empresa'");
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod[0]->cuenta;
}

function BuscaMediciones_UnicaData($id_empresa, $idmed) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = ("select h.* from tbl_enc_elearning_medicion h

where  id='$idmed' and id_empresa='$id_empresa'");
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//print_r($cod);
return $cod;
}

function BuscaMedicionesPendientes_hoy($idm, $id_encuesta, $hoy, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = ("
select h.*,

(select nombre_completo from tbl_usuario where rut=h.jefe) as nombre_completo,
(select email from tbl_usuario where rut=h.jefe) as email,
(select nombre_completo from tbl_usuario where rut=h.rut) as nombre_completo_col,


(select count(id) from tbl_enc_elearning_preg where id_encuesta='$id_encuesta' and id_empresa='$id_empresa') as NumPreguntas,
(select count(id) from tbl_enc_elearning_respuestas where id_encuesta='$id_encuesta' and id_medicion='$idm'

and rut_colaborador=h.rut and id_empresa='$id_empresa'
and id_tipo='$hoy') as NumRespuestas

from tbl_enc_elearning_usuarios h where h.id_encuesta='$id_encuesta' and h.id_medicion='$idm' and h.id_empresa='$id_empresa';
");
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function RESULTADOS_PlanFijadosCompass($rut) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = sprintf("    select * from tbl_sgd_fijacion where evaluado='$rut' and tipo='plan'");

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function RESULTADOS_ObjetivosFijadosCompass($rut) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = sprintf("    select * from tbl_sgd_fijacion where evaluado='$rut' and tipo='objetivo'");
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function RESULTADOS_PonderacionesPorDimensionID($id_dimension) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = sprintf("    select * from tbl_objetivos_dimensiones_ponderaciones where id_dimension='$id_dimension'");

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function RESULTADOS_RespuestasPorDimensionRespuestasObjetivos($evaluado, $evaluador, $id_proceso, $id_empresa, $dimension) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "SELECT *
FROM
tbl_sgd_respuestas
INNER JOIN tbl_objetivos_individuales ON tbl_objetivos_individuales.id = tbl_sgd_respuestas.id_objetivo
WHERE
tbl_sgd_respuestas.evaluado = '$evaluado'
AND tbl_sgd_respuestas.evaluador = '$evaluador'
AND tbl_sgd_respuestas.id_proceso = '$id_proceso'
AND tbl_objetivos_individuales.dimension = '$dimension'
AND tbl_sgd_respuestas.id_empresa = '$id_empresa'";
//echo $sql;echo "<br>";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function DimensionesPorEmpresaResultados($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$datos_empresa = DatosEmpresa($id_empresa);
$sql = "select * from tbl_objetivos_dimension where id_empresa='$id_empresa'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function SGD_borra_EvalObjetivos($evaluado, $evaluador, $id_proceso) {
global $c_host, $c_user, $c_pass, $c_db;

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "delete from tbl_sgd_finalizados_evaluado_evaluador_objetivos      where evaluado='$evaluado' and evaluador='$evaluador' and id_proceso='$id_proceso'    ";
$database->setquery($sql);
$database->query();
}

function EscalasPorIdObjetivo($id_objetivo) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$datos_empresa = DatosEmpresa($id_empresa);
$sql = "select * from tbl_objetivos_individuales_escala where id_objetivo='$id_objetivo'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function InteresesDeCarreraCompass($evaluado, $evaluador) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$datos_empresa = DatosEmpresa($id_empresa);
$sql = "SELECT
tbl_sgd_desarrollo_carrera.interes
FROM
tbl_sgd_respuestas_desarrollo_carrera

inner join tbl_sgd_desarrollo_carrera
on tbl_sgd_desarrollo_carrera.id=tbl_sgd_respuestas_desarrollo_carrera.id_desarrollo_carrera

WHERE
evaluado = '$evaluado'
AND evaluador = '$evaluador'
GROUP BY
evaluado,
evaluador,
id_desarrollo_carrera";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ComentarioFinalCompass($evaluado, $evaluador) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$datos_empresa = DatosEmpresa($id_empresa);
$sql = "select * from tbl_sgd_comentarios_finales where evaluado='$evaluado' and evaluador='$evaluador'    ";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ObjetivosConRespuestaParaCompass($evaluado, $evaluador) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$datos_empresa = DatosEmpresa($id_empresa);
$sql = "select tbl_objetivos_individuales.rut, tbl_objetivos_individuales.metrica, tbl_objetivos_individuales.descripcion_objetivo, tbl_objetivos_individuales.ponderacion,
tbl_sgd_respuestas.puntaje, tbl_sgd_respuestas.comentario
from tbl_objetivos_individuales

left join tbl_sgd_respuestas
on tbl_sgd_respuestas.evaluado=tbl_objetivos_individuales.rut and tbl_sgd_respuestas.id_objetivo=tbl_objetivos_individuales.id and tbl_sgd_respuestas.evaluador='$evaluador'

where tbl_objetivos_individuales.rut='$evaluado'


";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function CompetenciasPorDimension($id_dimension) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$datos_empresa = DatosEmpresa($id_empresa);
$sql = "select *  from tbl_sgd_componente where id_dimension='$id_dimension'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeDimensionesParaProcesoPorPErfilesDeEvaluacion($id_proceso, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "SELECT distinct(tbl_sgd_componente.id_dimension), tbl_sgd_dimensiones.nombre

FROM
tbl_sgd_relaciones
INNER JOIN rel_sgd_perfil_competencias ON rel_sgd_perfil_competencias.perfil_evaluacion= tbl_sgd_relaciones.perfil_evaluacion_competencias
inner join tbl_sgd_componente on tbl_sgd_componente.id=rel_sgd_perfil_competencias.id_componente

inner join tbl_sgd_dimensiones
on tbl_sgd_dimensiones.id=tbl_sgd_componente.id_dimension


WHERE
tbl_sgd_relaciones.id_proceso = '$id_proceso';






";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeRespuestasMiniEncuestas($ide, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "

select h.*,
(select rut_completo from tbl_usuario where rut=h.rut) as rut_completo,
(select nombre_completo from tbl_usuario where rut=h.rut) as nombre_completo,
(select cargo from tbl_usuario where rut=h.rut) as cargo,

(select opcion1 from tbl_miniencuestas where id=h.id_encuesta) as opcion1,
(select opcion2 from tbl_miniencuestas where id=h.id_encuesta) as opcion2,
(select opcion3 from tbl_miniencuestas where id=h.id_encuesta) as opcion3,
(select opcion4 from tbl_miniencuestas where id=h.id_encuesta) as opcion4




from tbl_miniencuestas_respuestas h where h.id_encuesta='$ide' and h.id_empresa='$id_empresa'     group by h.rut



";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function SGD_borra_FijacionFinalizado($evaluado, $evaluador, $id_proceso) {
global $c_host, $c_user, $c_pass, $c_db;

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "delete from tbl_objetivos_indviduales_finalizado      where evaluado='$evaluado' and evaluador='$evaluador' and id_proceso='$id_proceso'    ";
$database->setquery($sql);
$database->query();

$sql = "delete from tbl_objetivos_validaciones      where evaluado='$evaluado' and evaluador='$evaluador' and id_proceso='$id_proceso'    ";
$database->setquery($sql);
$database->query();
}

function SGD_MATRIZ_InsertDataFull($id_proceso, $evaluado, $evaluador, $validador, $calibrador, $id_empresa, $perfil_evaluacion, $sub_perfil) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$evaluado = LimpiaRut($evaluado);
$evaluador = LimpiaRut($evaluador);
$validador = LimpiaRut($validador);
$calibrador = LimpiaRut($calibrador);

$sql = "
INSERT INTO tbl_sgd_relaciones (evaluado, evaluador, calibrador, validador, id_proceso, id_empresa, perfil_evaluacion_competencias, subperfil)
VALUES ('$evaluado', '$evaluador', '$calibrador', '$validador', '$id_proceso', '$id_empresa', '$perfil_evaluacion', '$sub_perfil')
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TraeSubperfilesPorEmpresa($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_sgd_subperfiles where id_empresa='$id_empresa' order by orden asc";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeProcesoEvaluacionDadoIdProcesoAnual($id_proceso_anual) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_sgd_proceso_evaluacion where id_proceso_anual='$id_proceso_anual'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function Actualiza_ObjFinalizado_cierre($rut, $Prom, $id_objeto, $id_curso, $id_eval, $id_empresa) {
// echo "<br>$rut,$Prom, $id_objeto, $id_curso, $id_eval, $id_empresa";

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "

update tbl_objetos_finalizados set nota='$Prom' where rut='$rut' and id_objeto='$id_objeto'
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function busca_asociacion_preguntas_usuario($id_objeto, $id_eval, $rut) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "

select count(h.id) as CuentaPreg,
(select count(id) from tbl_evaluaciones_respuestas WHERE id_objeto = '$id_objeto' AND rut = '$rut' and correcta='1') as CuentaResp,
round(100*(select (select count(id) from tbl_evaluaciones_respuestas WHERE id_objeto = '$id_objeto' AND rut = '$rut' and correcta='1') / count(h.id))) as Prom

from tbl_evaluaciones_asociacion_preguntas_usuario h where rut='$rut' and id_objeto='bci_922m2' and id_evaluacion='$id_eval'

";

//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ListaUsuariosIdObjetoEvaluacion($id_objeto, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "

SELECT
h.*
FROM
tbl_inscripcion_usuarios h
WHERE
h.id_curso = (
SELECT
id_curso
FROM
tbl_objeto
WHERE
id = '$id_objeto'
)
and h.id_empresa='$id_empresa'

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ACT_BuscaRUTCursoMallaPrograma_Reportes_Inscripcion($rut, $id_curso, $id_malla, $id_programa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "

select count(h.id) as estaenReportes,

(select count(id) from tbl_inscripcion_usuarios where rut='$rut' and id_malla='$id_malla' and id_curso='$id_curso') as estaenInscripcion,
(select count(id) from rel_lms_malla_persona where rut='$rut' and id_malla='$id_malla') as estaenRelMallaPersona

from tbl_lms_reportes h where
h.rut='$rut'
and h.id_curso='$id_curso'
and h.id_malla='$id_malla'
and h.id_programa='$id_programa'

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ACT_BuscaRUTCursoMallaPrograma_Reportes_NoEn_Inscripcion($id_programa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sufijo = "_99";
$sql = "


update tbl_lms_reportes h set h.rut=CONCAT(h.rut,'$sufijo')

where h.id_programa='$id_programa'

and
((select count(id) from tbl_inscripcion_usuarios where rut=h.rut and id_malla=h.id_malla and id_curso=h.id_curso) ='0'
OR
(select count(id) from rel_lms_malla_persona where rut=h.rut and id_malla=h.id_malla)='0')


";

//echo "<br>$sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function MP_UpdateComenN1($id, $palabra) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$palabra = utf8_decode($palabra);
$sql = "update tbl_mp_comentarios set comentario='$palabra'  where  id='$id' ";
// echo $sql;sleep(5);

$database->setquery($sql);
$database->query();
}

function MP_DelComenN1($id) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "delete from tbl_mp_comentarios where   id='$id'";
// echo $sql;sleep(5);

$database->setquery($sql);
$database->query();
}

function MP_UpdateComenN2($id, $palabra) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$palabra = utf8_decode($palabra);

$sql = "update tbl_mp_comentarios_reply set comentario='$palabra'  where  id='$id' ";
// $sql;sleep(5);

$database->setquery($sql);
$database->query();
}

function MP_DelComenN2($id) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "delete from tbl_mp_comentarios_reply where   id='$id'";
//echo $sql;sleep(5);

$database->setquery($sql);
$database->query();
}

function MP_Comentarios_nivel2($id_mp, $id_post) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.*, (SELECT nombre_completo from tbl_usuario where rut=h.rut) as nombre
from tbl_mp_comentarios_reply h
where h.id_mp='$id_mp' and h.id_post='$id_post'
order by fecha Desc, id Desc;";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function MP_Comentarios_nivel1($id_mp) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.*, (SELECT nombre_completo from tbl_usuario where rut=h.rut) as nombre
from tbl_mp_comentarios h
where h.id_mp='$id_mp' order by fecha Desc, id Desc;";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function EditaObjetoEvaluacionContenido($id_objeto, $nombre_objeto, $objeto_descripcion, $tipo_objeto, $extension_objeto,
$objeto_url, $objeto_duracion, $objeto_orden, $objeto_numpreguntas, $objeto_aprobacion, $id_curso, $id_evaluacion, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$objeto_valido = 0;
if (strpos($objeto_url, '.mp4') !== false) {
$objeto_valido = 1;} elseif (strpos($objeto_url, '.pdf') !== false) {
$objeto_valido = 1;} elseif (strpos($objeto_url, '.MP4') !== false) {
$objeto_valido = 1;} elseif (strpos($objeto_url, '.zip') !== false) {
$objeto_valido = 1;} elseif (strpos($objeto_url, '.ZIP') !== false) {
$objeto_valido = 1;} elseif (strpos($objeto_url, '.PDF') !== false) {
$objeto_valido = 1;} elseif (strpos($objeto_url, '.html') !== false) {
$objeto_valido = 1;}

$nombre_objeto = utf8_decode($nombre_objeto);
$objeto_descripcion = utf8_decode($objeto_descripcion);
$titulo_cierre = utf8_decode($titulo_cierre);
$texto_cierre = utf8_decode($texto_cierre);

if ($objeto_valido == 1) {
$modificacion_url_objeto = "archivo='$objeto_url',
url_objeto='$objeto_url',
url='$objeto_url',";
} else {
$modificacion_url_objeto = "";
}

$sql = "update tbl_objeto set
titulo='$nombre_objeto',
descripcion='$objeto_descripcion',
tipo_objeto='$tipo_objeto',
extension_objeto='$extension_objeto',
$modificacion_url_objeto
preguntas_aleatorias='$objeto_numpreguntas',
duracion_video='$objeto_duracion',
nota_aprobacion='$objeto_aprobacion'




where id='$id_objeto' and id_empresa='$id_empresa'";

echo "<br><br>";
//echo $sql;exit;
$database->setquery($sql);
$database->query();
}

function EditaObjetoEvaluacion($id_objeto, $nombre_objeto, $objeto_descripcion, $tipo_objeto, $extension_objeto, $objeto_url, $objeto_duracion,
$objeto_orden, $objeto_numpreguntas, $objeto_aprobacion, $id_curso, $objeto_permitir_ver_nota, $objeto_recalcular_notas,
$objeto_distribucion_opciones, $objeto_duracion_evaluacion_total, $objeto_permitir_ver_nota, $id_empresa, $titulo_cierre, $texto_cierre,
$objeto_intentos, $fecha_inicio, $hora_inicio, $fecha_termino, $hora_termino) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$nombre_objeto = utf8_decode($nombre_objeto);
$objeto_descripcion = utf8_decode($objeto_descripcion);
$titulo_cierre = utf8_decode($titulo_cierre);
$texto_cierre = utf8_decode($texto_cierre);

if ($fecha_inicio == "") {$fecha_inicio = 'NULL';} else { $fecha_inicio = "'" . $fecha_inicio . "'";}
if ($hora_inicio == "") {$hora_inicio = 'NULL';} else { $hora_inicio = "'" . $hora_inicio . "'";}
if ($fecha_termino == "") {$fecha_termino = 'NULL';} else { $fecha_termino = "'" . $fecha_termino . "'";}
if ($hora_termino == "") {$hora_termino = 'NULL';} else { $hora_termino = "'" . $hora_termino . "'";}

$sql = "update tbl_objeto set
titulo='$nombre_objeto',
descripcion='$objeto_descripcion',
tipo_objeto='$tipo_objeto',
extension_objeto='$extension_objeto',
archivo='$objeto_url',
url_objeto='$objeto_url',
url='$objeto_url',
preguntas_aleatorias='$objeto_numpreguntas',
duracion_video='$objeto_duracion',
nota_aprobacion='$objeto_aprobacion',
currentorg='$objeto_duracion_evaluacion_total',
idmoodle='$objeto_recalcular_notas',
urlmoodle='$objeto_distribucion_opciones',
linkabrir='$objeto_permitir_ver_nota',
gamificado='1',
puntos='1',
medallas='1',
titulo_principal='$titulo_cierre',
bajada_principal='$texto_cierre',
intentos_trivia='$objeto_intentos',
fecha_inicio=$fecha_inicio,
hora_inicio=$hora_inicio,
fecha_termino=$fecha_termino,
hora_termino=$hora_termino


where id='$id_objeto' and id_empresa='$id_empresa'";

//echo "sql EditaObjetoEvaluacion $sql";sleep(5);
$database->setquery($sql);
$database->query();
}

function lista_notificaciones_data($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = " select h.* from tbl_notificaciones h where h.id_empresa='$id_empresa' order by h.id DESC";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lista_notificaciones_a_buscar_data($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select tipoenvio, count(id) as cuenta from tbl_notificaciones_pendientes where id_empresa='$id_empresa' group by tipoenvio";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lista_notificaciones_a_buscar_data_detalle($id_empresa, $tipoenvio) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_notificaciones_pendientes where id_empresa='$id_empresa' and tipoenvio='$tipoenvio'";
//        echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lista_eventos_data($id_empresa, $id_dimension) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = " select h.*,
(select nombre from tbl_eventos_categoria where id_categoria=h.id_categoria) as NombreCategoria

from tbl_eventos h where h.id_empresa='$id_empresa'  and id_dimension='$id_dimension' order by h.id DESC";
// echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lista_empresas_ext_data($id_empresa, $id_dimension) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = " select h.* from tbl_empresas_ext h where h.id_empresa='$id_empresa'  order by h.nombre ASC";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lista_empresas_ext_divisiones_data($rut, $id_empresa, $id_dimension) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = " select h.* from tbl_empresas_ext_division h where h.id_empresa='$id_empresa' and rut='$rut'  order by h.nombredivision ASC";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lista_emb_tareas_data($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = " select h.* from tbl_emb_tareas h where h.id_empresa='$id_empresa' order by h.id DESC";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lista_puntos_stock_data($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select h.*,
(select count(id) from tbl_premios_canje where id_premio=h.id_premio and id_empresa=h.id_empresa) as canjeados

from tbl_premios h

where h.id_empresa='$id_empresa' order by h.id_dimension, h.premio

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function Lista_fc_eventos_data($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select h.*

from tbl_postulables h

where h.id_empresa='$id_empresa' order by h.id_dimension, h.nombre

";
//echo $sql; exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lista_puntos_canjes_data($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select h.*,
(select premio from tbl_premios where id_premio=h.id_premio) as premio,
(select dimension from tbl_premios where id_premio=h.id_premio) as dimension

from tbl_premios_canje h

where h.id_empresa='$id_empresa' order by h.id DESC

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lista_reconocimiento_data($id_empresa, $year, $s, $tipo) {
//echo "<br>data<br>lista_reconocimiento_data $id_empresa, $year, $s, $tipo)";


$query_s="";

if($year=="2019"){
if($tipo=="sel"){
$fecha_inicio_sem1="2019-01-01";
$fecha_termino_sem1="2019-08-19";
$fecha_inicio_sem2="2019-08-20";
$fecha_termino_sem2="2020-02-28";
}
if($tipo=="col"){
$fecha_inicio_sem1="2019-03-01";
$fecha_termino_sem1="2019-06-31";
$fecha_inicio_sem2="2019-12-01";
$fecha_termino_sem2="2020-02-28";
}
}

if($year=="2020"){
if($tipo=="sel"){
$fecha_inicio_sem1=$year."-03-01";
$fecha_termino_sem1=$year."-06-31";
$fecha_inicio_sem2=$year."-07-01";
$fecha_termino_sem2=$year."-12-31";
}
if($tipo=="col"){
$fecha_inicio_sem1=$year."-03-01";
$fecha_termino_sem1=$year."-06-31";
$fecha_inicio_sem2=$year."-07-01";
$fecha_termino_sem2=$year."-12-31";
}
}

if($s==1){ $query_s=" and h.fecha >='$fecha_inicio_sem1' and  h.fecha <='$fecha_termino_sem1' ";}
if($s==2){ $query_s=" and h.fecha >='$fecha_inicio_sem2' and  h.fecha <='$fecha_termino_sem2' ";}

$query_tipo="";
if($tipo=="sel"){
$query_tipo=" and h.id_categoria='Reconocimiento Seleccion del Chile 2019'";
}

if($tipo=="col"){
$query_tipo=" and h.id_categoria='COLABORACION'";
}


global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select h.*

from tbl_reconoce_gracias h where h.id_empresa='$id_empresa' 


$query_s $query_tipo

order by h.fecha DESC, h.id DESC

";

//echo "<br>SQL<br>$sql<br> "; exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lista_agradecimiento_data($id_empresa, $year) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select h.*

from tbl_reconoce_gracias h where h.id_empresa='$id_empresa' and h.tipo='GRACIAS'
and 
YEAR(h.fecha)='$year' 

order by h.fecha DESC, h.id DESC

";
//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lista_puntos_canjes_despachos_data($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select h.*,
(select premio from tbl_premios where id_premio=h.id_premio) as premio,
(select dimension from tbl_premios where id_premio=h.id_premio) as dimension

from tbl_premios_canje h

where h.id_empresa='$id_empresa' and h.estadovalidacion='1' order by h.id DESC

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lista_puntos_canjes_entregas_data($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select h.*,
(select premio from tbl_premios where id_premio=h.id_premio) as premio,
(select dimension from tbl_premios where id_premio=h.id_premio) as dimension

from tbl_premios_canje h

where h.id_empresa='$id_empresa' and h.estadovalidacion='1'  order by h.id DESC

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}
function lista_puntos_canjes_entregas_data_cdr($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select h.*,
(select premio from tbl_premios where id_premio=h.id_premio) as premio,
(select dimension from tbl_premios where id_premio=h.id_premio) as dimension,
(select id_dimension from tbl_premios where id_premio=h.id_premio) as id_dimension
from tbl_premios_canje h

where h.id_empresa='$id_empresa' and h.estadovalidacion='1'
and  (select id_dimension from tbl_premios where id_premio=h.id_premio)='bch_vj'
order by h.id DESC
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lista_puntos_canjes_jefe_data($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select h.*

from tbl_premios_puntos_usuarios_jefe_entregados h

where h.id_empresa='$id_empresa' order by h.id DESC


";
//  echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function BuscaNombreCatEventoDadoId($id_categoria, $id_dimension, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select h.nombre as nombre_categoria
from tbl_eventos_categoria h

where h.id_empresa='$id_empresa' and id_dimension='$id_dimension' and id_categoria='$id_categoria'

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod[0]->nombre_categoria;
}

function Empresas_Ext_Save_data($rut, $nombre, $descripcion, $dominio, $malla, $ejecutivo, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT id FROM tbl_empresas_ext WHERE id_empresa = '$id_empresa' and rut='$rut' order by id DESC Limit 1";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//echo $sql; sleep(5);

$id = $cod[0]->id;
//echo "<br>id $id";
$nombre = utf8_decode($nombre);

if ($id > 0) {
$sql = "
UPDATE tbl_empresas_ext SET  nombre='$nombre',dominio='$dominio',malla='$malla',    ejecutivo='$ejecutivo'
WHERE rut='$rut' and id_empresa='$id_empresa'
";
} else {

$sql = "
INSERT INTO tbl_empresas_ext (rut,nombre,dominio,malla,  ejecutivo, id_empresa)
VALUES ('$rut','$nombre','$dominio','$malla','$ejecutivo','$id_empresa')
";
}

//echo $sql; sleep(5);

$database->setquery($sql);
$database->query();

$sql = "
INSERT INTO tbl_admin (user, pass, nombre, acceso, id_empresa)
VALUES ('$rut','yomeeduco','$nombre','108','$id_empresa')
";
$database->setquery($sql);
$database->query();

$cod = $database->listObjects();
return $cod;
}

function EmpresasExtDivision_Save_data($rut, $codigo, $division, $sindicato, $ejecutivo, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT id FROM tbl_empresas_ext_division WHERE id_empresa = '$id_empresa' and codigo='$codigo' order by id DESC Limit 1";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//ho $sql; sleep(5);

$id = $cod[0]->id;
//echo "<br>id $id";
$nombre = utf8_decode($nombre);

if ($id > 0) {
$sql = "
UPDATE tbl_empresas_ext_division SET  rut='$rut',nombredivision='$division',nombresindicato='$sindicato',    ejecutivo='$ejecutivo'
WHERE codigo='$codigo' and id_empresa='$id_empresa'
";
} else {

$sql = "
INSERT INTO tbl_empresas_ext_division (codigo, rut, nombredivision, nombresindicato, ejecutivo, id_empresa)
VALUES ('$codigo','$rut','$division','$sindicato','$ejecutivo','$id_empresa')
";
}
$database->setquery($sql);
$database->query();

$sql = "
INSERT INTO tbl_admin (user, pass, nombre, acceso, id_empresa)
VALUES ('$codigo','yomeeduco','$division $sindicato','108','$id_empresa')
";
$database->setquery($sql);
$database->query();

//echo $sql; sleep(5);

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Eventos_Save_data($codigo, $id_dimension, $nombre, $descripcion, $instruccion, $id_categoria, $postulable,
$fecha_inicio, $hora_inicio, $fecha_termino, $hora_termino, $direccion, $region, $link, $visible, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$nombre_categoria = BuscaNombreCatEventoDadoId($id_categoria, $id_dimension, $id_empresa);

$sql = "SELECT id FROM tbl_eventos WHERE id_empresa = '$id_empresa' and codigo='$codigo' and id_dimension='$id_dimension' order by id DESC Limit 1";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//ho $sql; sleep(5);

$id = $cod[0]->id;
//echo "<br>id $id";
$nombre = utf8_decode($nombre);
$descripcion = utf8_decode($descripcion);
$descripcion_accion = utf8_decode($descripcion_accion);
$instruccion_tutor = utf8_decode($instruccion_tutor);

$direccion = utf8_decode($direccion);
$instruccion = utf8_decode($instruccion);

if ($id > 0) {
$sql = "
UPDATE tbl_eventos SET
nombre='$nombre',descripcion='$descripcion', instruccion='$instruccion',id_categoria='$id_categoria',postulable='$postulable',
fecha_inicio='$fecha_inicio',hora_inicio='$hora_inicio',fecha_termino='$fecha_termino',hora_termino='$hora_termino',
direccion='$direccion',region='$region', link_acceso='$link', categoria='$nombre_categoria', invisible='$visible'
WHERE id='$id' and id_empresa='$id_empresa'

";
} else {

$sql = "
INSERT INTO tbl_eventos (codigo,id_dimension,nombre,descripcion,instruccion,id_categoria,postulable,
fecha_inicio,hora_inicio,fecha_termino,hora_termino,direccion,region, link_acceso, id_empresa, categoria, invisible)
VALUES ('$codigo','$id_dimension','$nombre','$descripcion','$instruccion','$id_categoria','$postulable',
'$fecha_inicio','$hora_inicio','$fecha_termino','$hora_termino','$direccion','$region', '$link', '$id_empresa','$nombre_categoria','$visible')
";
}

//echo $sql; sleep(5);

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function emb_tareas_Save_data($codigo, $id_grupo_interes, $nombre, $descripcion, $duracion, $link_material, $link_material2, $link_material3,
$accion, $descripcion_accion, $link_archivo_trabajo, $instruccion_tutor, $link_tutor, $pregunta1, $pregunta2, $pregunta3, $fecha_termino, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT id FROM tbl_emb_tareas WHERE id_empresa = '$id_empresa' and codigo='$codigo' order by id DESC Limit 1";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//echo $sql;

$id = $cod[0]->id;
//echo "<br>id $id";
$nombre = utf8_decode($nombre);
$descripcion = utf8_decode($descripcion);
$descripcion_accion = utf8_decode($descripcion_accion);
$instruccion_tutor = utf8_decode($instruccion_tutor);
if ($id > 0) {
$sql = "
UPDATE tbl_emb_tareas SET id_grupo_interes='$id_grupo_interes',nombre='$nombre',descripcion='$descripcion',duracion='$duracion',link_material='$link_material',link_material2='$link_material2',link_material3='$link_material3',
accion='$accion',descripcion_accion='$descripcion_accion',link_archivo_trabajo='$link_archivo_trabajo',instruccion_tutor='$instruccion_tutor',link_tutor='$link_tutor',
pregunta1='$pregunta1',pregunta2='$pregunta2',pregunta3='$pregunta3',fecha_termino='$fecha_termino'

WHERE id='$id' and id_empresa='$id_empresa'

";
} else {

$sql = "
INSERT INTO tbl_emb_tareas (codigo,id_grupo_interes,nombre,descripcion,duracion,link_material,link_material2,link_material3,
accion,descripcion_accion,link_archivo_trabajo,instruccion_tutor,link_tutor,
pregunta1, pregunta2, pregunta3, fecha_termino,
id_empresa)
VALUES ('$codigo','$id_grupo_interes','$nombre','$descripcion','$duracion','$link_material','$link_material2','$link_material3',
'$accion','$descripcion_accion','$link_archivo_trabajo','$instruccion_tutor','$link_tutor',
'$pregunta1', '$pregunta2', '$pregunta3',  '$fecha_termino',
'$id_empresa')
";
}

// echo $sql; sleep(5);
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function notificaciones_Save_data($codigo, $nombre, $descripcion, $tipomensaje,
$subject, $titulo1, $subtitulo1, $texto1, $texto2, $texto3, $texto4, $logo, $url, $texto_url, $logo, $tipo, $id_empresa) {

/*
echo "$codigo,$nombre,$descripcion,$tipomensaje,
$subject,$titulo1,$subtitulo1,$texto1,$texto2,$texto3,$texto4,$logo, $url, $texto_url, $logo,$tipo, $id_empresa"; sleep(2); */
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT id FROM tbl_notificaciones WHERE id_empresa = '$id_empresa' and codigo='$codigo' order by id DESC Limit 1";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//echo $sql;

$id = $cod[0]->id;
//echo "<br>id $id";

$nombre = utf8_decode($nombre);
$descripcion = utf8_decode($descripcion);
$tipomensaje = utf8_decode($tipomensaje);
$subject = utf8_decode($subject);
$titulo1 = utf8_decode($titulo1);
$subtitulo1 = utf8_decode($subtitulo1);
$texto1 = utf8_decode($texto1);
$texto2 = utf8_decode($texto2);
$texto3 = utf8_decode($texto3);
$texto4 = utf8_decode($texto4);

if ($id > 0) {
$sql = "
UPDATE tbl_notificaciones SET nombre='$nombre',descripcion='$descripcion',tipomensaje='$tipomensaje',subject='$subject',titulo1='$titulo1',subtitulo1='$subtitulo1',
texto1='$texto1',texto2='$texto2',texto3='$texto3',texto4='$texto4',logo='$logo',
url='$url',texto_url='$texto_url',tipo='$tipo'

WHERE id='$id' and id_empresa='$id_empresa'

";
} else {

$sql = "
INSERT INTO tbl_notificaciones (codigo,nombre,descripcion,tipomensaje,
subject,titulo1,subtitulo1,texto1,texto2,texto3,texto4,
logo, url, texto_url,  tipo, id_empresa)

VALUES

('$codigo','$nombre','$descripcion','$tipomensaje',
'$subject','$titulo1','$subtitulo1','$texto1','$texto2','$texto3','$texto4',
'$logo', '$url', '$texto_url', '$tipo', '$id_empresa')
";
}

/* echo $sql;    sleep(5); */
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function lista_emb_olas_data_solo($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select h.*

from tbl_emb_olas h

where

h.id_empresa='$id_empresa'

";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lista_eventos_categorias_data_solo($id_empresa, $id_dimension) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select h.*

from tbl_eventos_categoria h

where

h.id_empresa='$id_empresa' and h.id_dimension='$id_dimension'

";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lista_emb_olas_data($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select h.*,
(select count(id) from tbl_mp_rel_rut_grupo where id_grupointeres=h.codigo) as Inscritos,
(select count(DISTINCT rut) from tbl_log_sistema where variables_get LIKE CONCAT('%', h.sesion ,'%')) as Ingresos
from tbl_emb_olas h

where

h.id_empresa='$id_empresa'

";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lista_stories_360_data($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = " select h.*, (select nombre_completo from tbl_usuario where rut=h.rut) as nombre_completo from tbl_mp_stories h where h.id_empresa='$id_empresa' and id_categoria='stories_360' order by id DESC ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lista_stories_twit_data($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = " select h.*, (select nombre_completo from tbl_usuario where rut=h.rut) as nombre_completo from tbl_mp_stories h where h.id_empresa='$id_empresa' and id_categoria='stories_twit' order by id DESC ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}
function BuscaTotalUsuariosTemporales($id_empresa, $tipo){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if($tipo=="TODOS"){
$sql= "SELECT
h.*
FROM
tbl_usuario_temporal h
WHERE
h.id_empresa = '$id_empresa'
";
}

if($tipo=="NUEVOS"){
$sql= "SELECT
h.*, (select rut from tbl_usuario where rut=h.rut) as Rut
FROM
tbl_usuario_temporal h
WHERE
h.id_empresa = '$id_empresa'
and (select rut from tbl_usuario where rut=h.rut) is null
";
}

if($tipo=="NOENCONTRADOS"){
$sql="
SELECT
h.*, (select rut from tbl_usuario_temporal where rut=h.rut) as Rut
FROM
tbl_usuario h
WHERE
h.id_empresa = '$id_empresa'  and h.vigencia_descripcion==''
and (select rut from tbl_usuario_temporal where rut=h.rut) is null
";
}




$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;

}
function lista_becas_becas_data($id_empresa, $tipo_becas) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT
h.*, (
SELECT
count(id)
FROM
tbl_becas
WHERE
id_empresa = h.id_empresa
AND tipo_beca = h.tipo_beca
) AS postulantes,
(
SELECT
count(id)
FROM
tbl_becas
WHERE
id_empresa = h.id_empresa
AND tipo_beca = h.tipo_beca
AND documentacionok = 'SI'
) AS documentacionok,
(
SELECT
count(id)
FROM
tbl_becas
WHERE
id_empresa = h.id_empresa
AND tipo_beca = h.tipo_beca
AND documentacionok = 'NO'
) AS documentacionno,
(
SELECT
count(id)
FROM
tbl_becas
WHERE
id_empresa = h.id_empresa
AND tipo_beca = h.tipo_beca
AND validacionok = 'SI'
) AS validados,
(
SELECT
count(id)
FROM
tbl_becas
WHERE
id_empresa = h.id_empresa
AND tipo_beca = h.tipo_beca
AND validacionok = 'NO'
) AS rechazados
FROM
tbl_becas h
WHERE
h.id_empresa = '$id_empresa'
AND h.tipo_beca = '$tipo_becas' group BY h.tipo_beca ";
// echo "<br>sql $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lista_beneficios_data($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.*,

(select count(id) from tbl_becas where id_empresa=h.id_empresa and tipo_beca=h.id_beneficios) as postulantes,
(select count(id) from tbl_becas where id_empresa=h.id_empresa and tipo_beca=h.id_beneficios and validacionok='1') as validacionokjefe,
(select count(id) from tbl_becas where id_empresa=h.id_empresa and tipo_beca=h.id_beneficios and documentacionok='SI') as validacionadmin

from tbl_beneficios h where h.id_empresa='$id_empresa'   ";

//echo "<br>$sql";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}
function lista_beneficios_validacion_data($idcategoria, $id_empresa, $id_form, $fecha_inicio, $fecha_termino, $estado) {

//echo "<br>lista_beneficios_validacion_data id cat $idcategoria, $id_empresa, id form $id_form, fi $fecha_inicio, ft $fecha_termino, estado $estado<br>";

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if($idcategoria=="{ID_BENEFICIO}"){
$QueryCat =" ";
} else {
$QueryCat =" and h.id_beneficio='$idcategoria' ";
}

if($idcategoria==""){
$QueryCat =" ";
}

if($id_form<>""){
$QueryIdForm =" and h.id_form='$id_form' ";
} else {
$QueryIdForm =" ";
}

if($fecha_inicio<>""){
$QueryFI =" and h.fecha>='$fecha_inicio' ";
} else {
$QueryFI =" ";
}

if($fecha_termino<>""){
$QueryFT =" and h.fecha<='$fecha_termino' ";
} else {
$QueryFT =" ";
}

if($estado <>""){



$QueryEST =" and h.validacion1='$estado' ";
} else {
$QueryEST =" ";
}	  



if($estado=="Todos"){
$QueryEST =" ";	
$sql = "select h.*, 
(select nombre from tbl_beneficios_formularios where id=h.id_form) as nombre_formulario,
(select nombre from tbl_beneficios where id_beneficios=h.id_beneficio) as beneficio,
(select tipo_workflow from tbl_beneficios where id_beneficios=h.id_beneficio) as tipo_workflow,
(select nombre from tbl_beneficios_workflow where id=(select tipo_workflow from tbl_beneficios where id_beneficios=h.id_beneficio)) as nombre_tipo_workflow,
(select id_form1 from tbl_beneficios where id_beneficios=h.id_beneficio) as id_form1,
(select id_form2 from tbl_beneficios where id_beneficios=h.id_beneficio) as id_form2

from tbl_beneficios_formularios_respuestas h

where 
h.id > 0

$QueryCat 
$QueryIdForm

$QueryFI
$QueryFT

$QueryEST

order by id DESC";



} else {

$sql = "select h.*, 
(select nombre from tbl_beneficios_formularios where id=h.id_form) as nombre_formulario,
(select nombre from tbl_beneficios where id_beneficios=h.id_beneficio) as beneficio,
(select tipo_workflow from tbl_beneficios where id_beneficios=h.id_beneficio) as tipo_workflow,
(select nombre from tbl_beneficios_workflow where id=(select tipo_workflow from tbl_beneficios where id_beneficios=h.id_beneficio)) as nombre_tipo_workflow,
(select id_form1 from tbl_beneficios where id_beneficios=h.id_beneficio) as id_form1,
(select id_form2 from tbl_beneficios where id_beneficios=h.id_beneficio) as id_form2

from tbl_beneficios_formularios_respuestas h

where h.id_empresa='$id_empresa' 

$QueryCat 
$QueryIdForm

$QueryFI
$QueryFT

$QueryEST

order by id DESC";

}

// echo $sql; exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}
function lista_beneficios_validacion_historicos_data($idcategoria, $id_empresa, $id_form, $fecha_inicio, $fecha_termino, $estado) {

//echo "<br>lista_beneficios_validacion_data id cat $idcategoria, $id_empresa, id form $id_form, fi $fecha_inicio, ft $fecha_termino, estado $estado<br>";

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if($idcategoria=="{ID_BENEFICIO}"){
$QueryCat =" ";
} else {
$QueryCat =" and h.id_beneficio='$idcategoria' ";
}

if($idcategoria==""){
$QueryCat =" ";
}

if($id_form<>""){
$QueryIdForm =" and h.id_form='$id_form' ";
} else {
$QueryIdForm =" ";
}

if($fecha_inicio<>""){
$QueryFI =" and h.fecha>='$fecha_inicio' ";
} else {
$QueryFI =" ";
}

if($fecha_termino<>""){
$QueryFT =" and h.fecha<='$fecha_termino' ";
} else {
$QueryFT =" ";
}

if($estado <>""){



$QueryEST =" and h.validacion1='$estado' ";
} else {
$QueryEST =" ";
}	  



if($estado=="Todos"){
$QueryEST =" ";	
$sql = "select h.*, 
(select nombre from tbl_beneficios_formularios where id=h.id_form) as nombre_formulario,
(select nombre from tbl_beneficios where id_beneficios=h.id_beneficio) as beneficio,
(select tipo_workflow from tbl_beneficios where id_beneficios=h.id_beneficio) as tipo_workflow,
(select nombre from tbl_beneficios_workflow where id=(select tipo_workflow from tbl_beneficios where id_beneficios=h.id_beneficio)) as nombre_tipo_workflow,
(select id_form1 from tbl_beneficios where id_beneficios=h.id_beneficio) as id_form1,
(select id_form2 from tbl_beneficios where id_beneficios=h.id_beneficio) as id_form2

from tbl_beneficios_formularios_respuestas_historicos h

where 
h.id > 0

$QueryCat 
$QueryIdForm

$QueryFI
$QueryFT

$QueryEST

order by id DESC";



} else {

$sql = "select h.*, 
(select nombre from tbl_beneficios_formularios where id=h.id_form) as nombre_formulario,
(select nombre from tbl_beneficios where id_beneficios=h.id_beneficio) as beneficio,
(select tipo_workflow from tbl_beneficios where id_beneficios=h.id_beneficio) as tipo_workflow,
(select nombre from tbl_beneficios_workflow where id=(select tipo_workflow from tbl_beneficios where id_beneficios=h.id_beneficio)) as nombre_tipo_workflow,
(select id_form1 from tbl_beneficios where id_beneficios=h.id_beneficio) as id_form1,
(select id_form2 from tbl_beneficios where id_beneficios=h.id_beneficio) as id_form2

from tbl_beneficios_formularios_respuestas_historicos h

where h.id_empresa='$id_empresa' 

$QueryCat 
$QueryIdForm

$QueryFI
$QueryFT

$QueryEST

order by id DESC";

}

//	echo $sql; 

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}
function lista_beneficios_validacion_ficha_social_data($idcategoria, $id_empresa, $id_form, $fecha_inicio, $fecha_termino, $estado) {

//echo "<br>lista_beneficios_validacion_data id cat $idcategoria, $id_empresa, id form $id_form, fi $fecha_inicio, ft $fecha_termino, estado $estado<br>";

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if($idcategoria=="{ID_BENEFICIO}"){
$QueryCat =" ";
} else {
$QueryCat =" and h.id_beneficio='$idcategoria' ";
}

if($idcategoria==""){
$QueryCat =" ";
}

if($id_form<>""){
$QueryIdForm =" and h.id_form='$id_form' ";
} else {
$QueryIdForm =" ";
}

if($fecha_inicio<>""){
$QueryFI =" and h.fecha>='$fecha_inicio' ";
} else {
$QueryFI =" ";
}

if($fecha_termino<>""){
$QueryFT =" and h.fecha<='$fecha_termino' ";
} else {
$QueryFT =" ";
}

if($estado <>""){



$QueryEST =" and h.validacion1='$estado' ";
} else {
$QueryEST =" ";
}	  



if($estado=="Todos"){
$QueryEST =" ";	
$sql = "select h.*, 
(select nombre from tbl_beneficios_formularios where id=h.id_form) as nombre_formulario,
(select nombre from tbl_beneficios where id_beneficios=h.id_beneficio) as beneficio,
(select tipo_workflow from tbl_beneficios where id_beneficios=h.id_beneficio) as tipo_workflow,
(select nombre from tbl_beneficios_workflow where id=(select tipo_workflow from tbl_beneficios where id_beneficios=h.id_beneficio)) as nombre_tipo_workflow,
(select id_form1 from tbl_beneficios where id_beneficios=h.id_beneficio) as id_form1,
(select id_form2 from tbl_beneficios where id_beneficios=h.id_beneficio) as id_form2

from tbl_beneficios_formularios_respuestas_ficha h

where 
h.id > 0

$QueryCat 
$QueryIdForm

$QueryFI
$QueryFT

$QueryEST

order by id DESC";



} else {

$sql = "select h.*, 
(select nombre from tbl_beneficios_formularios where id=h.id_form) as nombre_formulario,
(select nombre from tbl_beneficios where id_beneficios=h.id_beneficio) as beneficio,
(select tipo_workflow from tbl_beneficios where id_beneficios=h.id_beneficio) as tipo_workflow,
(select nombre from tbl_beneficios_workflow where id=(select tipo_workflow from tbl_beneficios where id_beneficios=h.id_beneficio)) as nombre_tipo_workflow,
(select id_form1 from tbl_beneficios where id_beneficios=h.id_beneficio) as id_form1,
(select id_form2 from tbl_beneficios where id_beneficios=h.id_beneficio) as id_form2

from tbl_beneficios_formularios_respuestas_ficha h

where h.id_empresa='$id_empresa' 

$QueryCat 
$QueryIdForm

$QueryFI
$QueryFT

$QueryEST

order by id DESC";

}

//echo $sql; exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}
function lista_chileactivo_v2_validacion_data($idcategoria, $id_empresa, $id_form, $fecha_inicio, $fecha_termino, $estado) {

//echo "<br>lista_beneficios_validacion_data id cat $idcategoria, $id_empresa, id form $id_form, fi $fecha_inicio, ft $fecha_termino, estado $estado<br>";

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if($idcategoria=="{ID_BENEFICIO}"){
$QueryCat =" ";
} else {
$QueryCat =" and h.id_beneficio='$idcategoria' ";
}

if($idcategoria==""){
$QueryCat =" ";
}

if($id_form<>""){
$QueryIdForm =" and h.id_form='$id_form' ";
} else {
$QueryIdForm =" ";
}

if($fecha_inicio<>""){
$QueryFI =" and h.fecha>='$fecha_inicio' ";
} else {
$QueryFI =" ";
}

if($fecha_termino<>""){
$QueryFT =" and h.fecha<='$fecha_termino' ";
} else {
$QueryFT =" ";
}

if($estado <>""){



$QueryEST =" and h.validacion1='$estado' ";
} else {
$QueryEST =" ";
}	  



if($estado=="Todos"){
$QueryEST =" ";	
$sql = "select h.*, 
(select nombre from tbl_beneficios_formularios where id=h.id_form) as nombre_formulario,
(select nombre from tbl_chileactivo where id_beneficios=h.id_beneficio) as beneficio,
(select tipo_workflow from tbl_chileactivo where id_beneficios=h.id_beneficio) as tipo_workflow,
(select nombre from tbl_beneficios_workflow where id=(select tipo_workflow from tbl_beneficios where id_beneficios=h.id_beneficio)) as nombre_tipo_workflow,
(select id_form1 from tbl_chileactivo where id_beneficios=h.id_beneficio) as id_form1,
(select id_form2 from tbl_chileactivo where id_beneficios=h.id_beneficio) as id_form2

from tbl_beneficios_formularios_respuestas h

where 
h.id > 0

$QueryCat 
$QueryIdForm

$QueryFI
$QueryFT

$QueryEST

order by id DESC";



} else {

$sql = "select h.*, 
(select nombre from tbl_beneficios_formularios where id=h.id_form) as nombre_formulario,
(select nombre from tbl_beneficios where id_beneficios=h.id_beneficio) as beneficio,
(select tipo_workflow from tbl_beneficios where id_beneficios=h.id_beneficio) as tipo_workflow,
(select nombre from tbl_beneficios_workflow where id=(select tipo_workflow from tbl_beneficios where id_beneficios=h.id_beneficio)) as nombre_tipo_workflow,
(select id_form1 from tbl_beneficios where id_beneficios=h.id_beneficio) as id_form1,
(select id_form2 from tbl_beneficios where id_beneficios=h.id_beneficio) as id_form2

from tbl_beneficios_formularios_respuestas h

where h.id_empresa='$id_empresa' 

$QueryCat 
$QueryIdForm

$QueryFI
$QueryFT

$QueryEST

order by id DESC";

}

// echo $sql; exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function lista_fichas_sociales_v3_validacion_data($idcategoria, $id_empresa, $id_form, $fecha_inicio, $fecha_termino, $estado) {

//echo "<br>lista_beneficios_validacion_data id cat $idcategoria, $id_empresa, id form $id_form, fi $fecha_inicio, ft $fecha_termino, estado $estado<br>";

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if($idcategoria=="{ID_BENEFICIO}"){
$QueryCat =" ";
} else {
$QueryCat =" and h.id_beneficio='$idcategoria' ";
}

if($idcategoria==""){
$QueryCat =" ";
}

if($id_form<>""){
$QueryIdForm =" and h.id_form='$id_form' ";
} else {
$QueryIdForm =" ";
}

if($fecha_inicio<>""){
$QueryFI =" and h.fecha>='$fecha_inicio' ";
} else {
$QueryFI =" ";
}

if($fecha_termino<>""){
$QueryFT =" and h.fecha<='$fecha_termino' ";
} else {
$QueryFT =" ";
}

if($estado <>""){



$QueryEST =" and h.validacion1='$estado' ";
} else {
$QueryEST =" ";
}	  



if($estado=="Todos"){
$QueryEST =" ";	
$sql = "select h.*, 
(select nombre from tbl_beneficios_formularios where id=h.id_form) as nombre_formulario,
(select nombre from tbl_chileactivo where id_beneficios=h.id_beneficio) as beneficio,
(select tipo_workflow from tbl_chileactivo where id_beneficios=h.id_beneficio) as tipo_workflow,
(select nombre from tbl_beneficios_workflow where id=(select tipo_workflow from tbl_beneficios where id_beneficios=h.id_beneficio)) as nombre_tipo_workflow,
(select id_form1 from tbl_chileactivo where id_beneficios=h.id_beneficio) as id_form1,
(select id_form2 from tbl_chileactivo where id_beneficios=h.id_beneficio) as id_form2

from tbl_beneficios_formularios_respuestas_ficha  h

where 
h.id > 0

$QueryCat 
$QueryIdForm

$QueryFI
$QueryFT

$QueryEST

order by id DESC";



} else {

$sql = "select h.*, 
(select nombre from tbl_beneficios_formularios where id=h.id_form) as nombre_formulario,
(select nombre from tbl_beneficios where id_beneficios=h.id_beneficio) as beneficio,
(select tipo_workflow from tbl_beneficios where id_beneficios=h.id_beneficio) as tipo_workflow,
(select nombre from tbl_beneficios_workflow where id=(select tipo_workflow from tbl_beneficios where id_beneficios=h.id_beneficio)) as nombre_tipo_workflow,
(select id_form1 from tbl_beneficios where id_beneficios=h.id_beneficio) as id_form1,
(select id_form2 from tbl_beneficios where id_beneficios=h.id_beneficio) as id_form2

from tbl_beneficios_formularios_respuestas_ficha  h

where h.id_empresa='$id_empresa' 

$QueryCat 
$QueryIdForm

$QueryFI
$QueryFT

$QueryEST

order by id DESC";

}

//echo $sql; exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function lista_chileactivo_validacion_full_data($idcategoria, $id_empresa, $id_form, $fecha_inicio, $fecha_termino, $estado) {

//echo "<br>lista_beneficios_validacion_data id cat $idcategoria, $id_empresa, id form $id_form, fi $fecha_inicio, ft $fecha_termino, estado $estado<br>";

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if($idcategoria=="{ID_BENEFICIO}"){
$QueryCat =" ";
} else {
$QueryCat =" and h.id_beneficio='$idcategoria' ";
}

if($idcategoria==""){
$QueryCat =" ";
}

if($id_form<>""){
$QueryIdForm =" and h.id_form='$id_form' ";
} else {
$QueryIdForm =" ";
}

if($fecha_inicio<>""){
$QueryFI =" and h.fecha>='$fecha_inicio' ";
} else {
$QueryFI =" ";
}

if($fecha_termino<>""){
$QueryFT =" and h.fecha<='$fecha_termino' ";
} else {
$QueryFT =" ";
}

if($estado <>""){



$QueryEST =" and h.validacion1='$estado' ";
} else {
$QueryEST =" ";
}	  

$estado=="Todos";

$QueryEST =" ";	
$sql = "select h.*, 
(select nombre from tbl_beneficios_formularios where id=h.id_form) as nombre_formulario,
(select nombre from tbl_chileactivo where id_beneficios=h.id_beneficio) as beneficio,
(select tipo_workflow from tbl_beneficios where id_beneficios=h.id_beneficio) as tipo_workflow,
(select nombre from tbl_beneficios_workflow where id=(select tipo_workflow from tbl_beneficios where id_beneficios=h.id_beneficio)) as nombre_tipo_workflow,
(select id_form1 from tbl_beneficios where id_beneficios=h.id_beneficio) as id_form1,
(select id_form2 from tbl_beneficios where id_beneficios=h.id_beneficio) as id_form2

from tbl_beneficios_formularios_respuestas h

where 

h.id > 0
and  (select nombre from tbl_chileactivo where id_beneficios=h.id_beneficio) is not null                 

$QueryCat 
$QueryIdForm

$QueryFI
$QueryFT

$QueryEST

order by id DESC";
//echo $sql; exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function lista_chileactivo_inscripcion_full_data($idcategoria, $id_empresa, $id_form, $fecha_inicio, $fecha_termino, $estado) {

//echo "<br>lista_beneficios_validacion_data id cat $idcategoria, $id_empresa, id form $id_form, fi $fecha_inicio, ft $fecha_termino, estado $estado<br>";
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.*

from tbl_chileactivo_inscripcion h

where h.id_empresa='78'

";
//echo $sql; exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function lista_chileactivo_desinscripcion_full_data($idcategoria, $id_empresa, $id_form, $fecha_inicio, $fecha_termino, $estado) {

//echo "<br>lista_beneficios_validacion_data id cat $idcategoria, $id_empresa, id form $id_form, fi $fecha_inicio, ft $fecha_termino, estado $estado<br>";
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.*

from tbl_chileactivo_deinscripcion h 

where h.id_empresa='78'

";
//echo $sql; exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function lista_becas_data($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$tbl_becas=$_SESSION["tbl_becas"];

$sql = "

select h.*,

(select count(id) from $tbl_becas where id_empresa=h.id_empresa and tipo_beca=h.tipo_beca) as postulantes,
(select count(id) from $tbl_becas where id_empresa=h.id_empresa and tipo_beca=h.tipo_beca and documentacionok='1') as documentacion_ok,
(select count(id) from $tbl_becas where id_empresa=h.id_empresa and tipo_beca=h.tipo_beca and validacionjefe1='1') as validacionjefe_1,
(select count(id) from $tbl_becas where id_empresa=h.id_empresa and tipo_beca=h.tipo_beca and validacionjefe2='1') as validacionjefe_2

from $tbl_becas h where h.id_empresa='$id_empresa' group by h.tipo_beca

";
//echo "<br><h1>".$sql."<h1>";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function InnovaUpdateEstado($id_idea, $nuevo_estado){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$hoy=date("Y-m-d");

$sql = "update tbl_innova_ideas set estado='$nuevo_estado', fecha_estado='$hoy' 
where id='$id_idea'  ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;	 



}

function lista_innovacion_data($proceso, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

//echo "$proceso, $id_empresa";
$sql = "select h.*, (select count(rut) from tbl_innova_votacion where id_idea=h.id) as suma_votos
from tbl_innova_ideas h 
where h.id_empresa='$id_empresa'  and h.proceso='$proceso'
order by (select count(rut) from tbl_innova_votacion where id_idea=h.id) DESC, h.fecha DESC, h.hora DESC
";
//echo $sql;exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function tbl_innova_jueces($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.*
from tbl_innova_ideas h 
where h.id_empresa='$id_empresa'  ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lista_formacion_continua_data($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select h.*,
(select count(id) from tbl_postulaciones where id_empresa=h.id_empresa and id_postulable=h.id_postulable) as postulantes,
(select count(id) from tbl_postulaciones where id_empresa=h.id_empresa and id_postulable=h.id_postulable and jefeok='SI') as jefeok,
(select count(id) from tbl_postulaciones where id_empresa=h.id_empresa and id_postulable=h.id_postulable and (jefeok='NO' or jefeok='NO_POR_FECHA')) as jefeno,
(select count(id) from tbl_postulaciones where id_empresa=h.id_empresa and id_postulable=h.id_postulable and validacionok='SI') as validados,
(select count(id) from tbl_postulaciones where id_empresa=h.id_empresa and id_postulable=h.id_postulable and validacionok='NO') as rechazados

from tbl_postulables h

where h.id_empresa='$id_empresa' and h.id_tipo='formacioncontinua'

order by h.dimension, h.nombre, h.fecha DESC

";

//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function FC_NombrePostulable($id_postulable, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select nombre from tbl_postulables where id_postulable='$id_postulable' and id_empresa='$id_empresa'

";

//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod[0]->nombre;
}

function FC_DescripcionPostulable($id_postulable, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select descripcion from tbl_postulables where id_postulable='$id_postulable' and id_empresa='$id_empresa'

";

//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod[0]->descripcion;
}

function lista_Ext_Empresas_gestion_data($id_empresa, $rut_ext_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select h.*,
(select count(id) from tbl_empresas_ext_usuarios  where id_empresa=h.id_empresa  and rut_ext_empresa=h.rut ) as inscritos,
(select count(id) from tbl_empresas_ext_usuarios  where id_empresa=h.id_empresa  and rut_ext_empresa=h.rut
and (capsula1=1 and capsula2=1 and capsula3=1 and capsula4=1)) as Suma4Cap100,

(select count(id) from tbl_empresas_ext_usuarios  where id_empresa=h.id_empresa  and rut_ext_empresa=h.rut
and (capsula1 is null and capsula2 is null and capsula3 is null and capsula4 is null)) as Suma4CNoInic

from tbl_empresas_ext h

where h.id_empresa='$id_empresa'

order by h.nombre

";

//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lista_eventos_gestion_data($id_empresa, $id_dimension) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select h.*,
(select count(id) from tbl_eventos_inscritos where id_empresa=h.id_empresa  and codigo=h.codigo ) as postulantes,
(select count(id) from tbl_eventos_inscritos where id_empresa=h.id_empresa and codigo=h.codigo and estado='OK' ) as validados,
(select count(id) from tbl_log_emails where id_empresa=h.id_empresa and tipo='Email_invitacion_evento' and dato=h.codigo) as invitaciones

from tbl_eventos h

where h.id_empresa='$id_empresa' and h.id_dimension='$id_dimension'

order by h.id_dimension, h.fecha_inicio DESC, h.nombre

";

//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function BuscaEmailLogEventoRut($rut, $codigo, $tipo, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select count(id) as cuenta
from tbl_log_emails where
id_empresa='$id_empresa'
and tipo='Email_invitacion_evento'
and dato='$codigo'
and rut='$rut'

";

//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod[0]->cuenta;
}

function Talent_id_cargo_busca_usuarios($id_cargo, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select h.*
from tbl_skills_usuarios h

where h.id_empresa='$id_empresa' and id_cargo='$id_cargo'
";

//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function BuscaSkillEsperado($id_nivel_esperado, $id_skill, $id_cargo, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select h.id_nivel_skill

from tbl_skills_nivel_esperado h

where h.id_empresa='$id_empresa' and id_cargo='$id_cargo'  and id_skill='$id_skill' and id_nivel_esperado='$id_nivel_esperado'
";

//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod[0]->id_nivel_skill;
}

function Talent_busca_ajuste_por_nivel($rut, $id_cargo, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select h.*,
(select count(id) from  tbl_skills_resultados where id_empresa=h.id_empresa and rut=h.rut and id_cargo=h.id_cargo and ajuste_basico='0') as cuenta_basico,
(select count(id) from  tbl_skills_resultados where id_empresa=h.id_empresa and rut=h.rut and id_cargo=h.id_cargo and ajuste_medio='0') as cuenta_medio,
(select count(id) from  tbl_skills_resultados where id_empresa=h.id_empresa and rut=h.rut and id_cargo=h.id_cargo and ajuste_experto='0') as cuenta_experto,
(select count(id) from  tbl_skills_resultados where id_empresa=h.id_empresa and rut=h.rut and id_cargo=h.id_cargo ) as cuenta_todo from tbl_skills_resultados h

where h.id_empresa='$id_empresa' and id_cargo='$id_cargo' and rut='$rut'
";

//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}
function DeleteTbltbl_skills_resultados($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "DELETE FROM tbl_skills_resultados  where id_empresa='$id_empresa'

";

//echo $sql;
$database->setquery($sql);
$database->query();
}

function InsertTblSkill_resultados($id_skill, $skill, $id_cargo, $cargo, $id_nivel_esperado, $nivel_esperado, $id_empresa, $puntos, $id_nivel, $nivel, $ajuste, $rut, $skill_esperado_basico, $ajuste_basico, $skill_esperado_medio, $ajuste_medio, $skill_esperado_experto, $ajuste_experto) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$nivel_esperado = utf8_decode($nivel_esperado);
$nivel = utf8_decode($nivel);

$sql = "INSERT INTO  tbl_skills_resultados

(id_skill,skill,id_cargo,cargo,id_nivel_esperado,nivel_esperado,id_empresa,puntos,id_nivel,nivel,ajuste, rut,
skill_nivel_esperado_basico,ajuste_basico,skill_nivel_esperado_medio,ajuste_medio,skill_nivel_esperado_experto,ajuste_experto)

values

('$id_skill','$skill','$id_cargo','$cargo','$id_nivel_esperado','$nivel_esperado',
'$id_empresa','$puntos','$id_nivel','$nivel','$ajuste','$rut',
'$skill_esperado_basico','$ajuste_basico','$skill_esperado_medio','$ajuste_medio','$skill_esperado_experto','$ajuste_experto')

";

//echo $sql;
$database->setquery($sql);
$database->query();
}

function Talent_preguntas_respuestas_puntos($rut, $nivel_esperado, $id_cargo, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select h.*,
(select id_grupo_alternativas from  tbl_evaluaciones_preguntas  where id=h.id_pregunta) as GrupoAlternativas,
(select correcta FROM tbl_evaluaciones_respuestas WHERE rut = '$rut' AND id_pregunta = h.id_pregunta ) as correcta,
(select id FROM tbl_evaluaciones_respuestas WHERE rut = '$rut' AND id_pregunta = h.id_pregunta ) as idresp,
(sum((select correcta FROM tbl_evaluaciones_respuestas WHERE rut = '$rut' AND id_pregunta = h.id_pregunta )*h.puntos)) as SumaPuntos


from tbl_skills h

where h.id_empresa='$id_empresa' and h.nivel_esperado='$nivel_esperado' and h.id_cargo='$id_cargo'

group by h.id_skill

";

//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Talent_buscarespuestas($id_cargo, $nivel_esperado, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select count(h.id) as cuenta, h.rut, h.id_skill  from tbl_skills_resultados h
where h.id_empresa='$id_empresa' and h.id_cargo='$id_cargo'
and h.id_nivel_esperado='$nivel_esperado' and h.puntos<>''  group by h.rut

";

//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}
function Talent_buscarespuestasRUT($rut, $id_cargo, $nivel_esperado, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select count(h.id) as cuenta, h.rut, h.id_skill  from tbl_skills_resultados h
where h.id_empresa='$id_empresa' and h.id_cargo='$id_cargo'
and h.id_nivel_esperado='$nivel_esperado' and h.puntos<>'' and h.rut='$rut'  group by h.rut

";

//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function BuscaIdMalladadaIdTipo($id_empresa, $id_tipo) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select id_malla

from tbl_enc_elearning_respuestas

where id_empresa='$id_empresa' and id_encuesta='1' and id_medicion='1'
and id_tipo='$id_tipo'
group by id_malla order by id_malla
";

//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function BuscaJefeIdMalladadaIdTipo($id_empresa, $id_tipo, $id_malla) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select id_programa, id_foco

from tbl_enc_elearning_respuestas

where id_empresa='$id_empresa' and id_encuesta='1' and id_medicion='1'
and id_tipo='$id_tipo'  and id_malla='$id_malla'

group by id_programa order by id_programa
";
//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function lista_clima_reportes_data($id_empresa, $filtro1, $filtro2, $filtro3) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

//echo "<br> id_empresa $id_empresa, filtro $filtro";

$qr1 = "";
if ($r1 != "") {$qr1 = " and h.gerencia='$r1' ";}

if ($filtro1 != '') {$qfiltro1 = " and h.id_tipo='$filtro1' ";
$qfiltrosh1 = "    and id_tipo='$filtro1' ";
$qfiltrostu1 = "    and gerencia='$filtro1' ";}
if ($filtro2 != '') {$qfiltro2 = " and h.id_malla='$filtro2' ";
$qfiltrosh2 = "   and id_malla='$filtro2' ";
$qfiltrostu2 = "   and departamento='$filtro2' ";}
if ($filtro3 != '') {$qfiltro3 = " and h.id_foco='$filtro3' ";
$qfiltrosh3 = "     and id_foco='$filtro3' ";
$qfiltrostu3 = "     and jefe='$filtro3' ";}

$qfiltro = $qfiltro1 . $qfiltro2 . $qfiltro3;
$qfiltrosh = $qfiltrosh1 . $qfiltrosh2 . $qfiltrosh3;
$qfiltrostu = $qfiltrostu1 . $qfiltrostu2 . $qfiltrostu3;

$sql = "

select count(id) as total,
(select COUNT(DISTINCT(rut)) from tbl_enc_elearning_respuestas where id_medicion='1' and id_empresa='$id_empresa' $qfiltrosh ) as realizados,
(select COUNT(DISTINCT(rut)) from tbl_usuario where id_empresa='$id_empresa' $qfiltrostu1 ) as posibles,

(select count(id) from tbl_enc_elearning_respuestas where respuesta >=3 and id_encuesta='1' and id_empresa='$id_empresa' $qfiltrosh ) as positivo,
(select count(id) from tbl_enc_elearning_respuestas where respuesta =2 and id_encuesta='1' and id_empresa='$id_empresa' $qfiltrosh ) as neutro,
(select count(id) from tbl_enc_elearning_respuestas where respuesta <=1 and id_encuesta='1' and id_empresa='$id_empresa' $qfiltrosh ) as negativo,
((select count(id) from tbl_enc_elearning_respuestas where respuesta >=3 and id_encuesta='1' and id_empresa='$id_empresa' $qfiltrosh )
-(select count(id) from tbl_enc_elearning_respuestas where respuesta <=1 and id_encuesta='1' and id_empresa='$id_empresa' $qfiltrosh )) as Neto ,


(select count(id) from tbl_enc_elearning_respuestas where respuesta >=3 and id_encuesta='1' and id_empresa='$id_empresa' $qfiltrosh  and id_clasificacion='F' ) as positivoF,
(select count(id) from tbl_enc_elearning_respuestas where id_encuesta='1' and id_empresa='$id_empresa' $qfiltrosh  and id_clasificacion='F' ) as todosF,
(select COUNT(DISTINCT(rut)) from tbl_enc_elearning_respuestas where id_encuesta='1' and id_empresa='$id_empresa' $qfiltrosh  and id_clasificacion='F' ) as todosFR,

(select count(id) from tbl_enc_elearning_respuestas where respuesta >=3 and id_encuesta='1' and id_empresa='$id_empresa' $qfiltrosh and id_clasificacion='M') as positivoM,
(select count(id) from tbl_enc_elearning_respuestas where id_encuesta='1' and id_empresa='$id_empresa' $qfiltrosh and id_clasificacion='M' ) as todosM,
(select COUNT(DISTINCT(rut)) from tbl_enc_elearning_respuestas where id_encuesta='1' and id_empresa='$id_empresa' $qfiltrosh and id_clasificacion='M' ) as todosMR,

(select count(id) from tbl_enc_elearning_respuestas where respuesta >=3 and id_encuesta='1' and id_empresa='$id_empresa' $qfiltrosh and id_curso='25') as positivo25,
(select count(id) from tbl_enc_elearning_respuestas where id_encuesta='1' and id_empresa='$id_empresa' $qfiltrosh and id_curso='25' ) as todos25,
(select COUNT(DISTINCT(rut)) from tbl_enc_elearning_respuestas where id_encuesta='1' and id_empresa='$id_empresa' $qfiltrosh and id_curso='25' ) as todos25R,

(select count(id) from tbl_enc_elearning_respuestas where respuesta >=3 and id_encuesta='1' and id_empresa='$id_empresa' $qfiltrosh and id_curso='2535') as positivo2535,
(select count(id) from tbl_enc_elearning_respuestas where id_encuesta='1' and id_empresa='$id_empresa' $qfiltrosh and id_curso='2535' ) as todos2535,
(select COUNT(DISTINCT(rut)) from tbl_enc_elearning_respuestas where id_encuesta='1' and id_empresa='$id_empresa' $qfiltrosh and id_curso='2535' ) as todos2535R,

(select count(id) from tbl_enc_elearning_respuestas where respuesta >=3 and id_encuesta='1' and id_empresa='$id_empresa' $qfiltrosh and id_curso='3545') as positivo3545,
(select count(id) from tbl_enc_elearning_respuestas where id_encuesta='1' and id_empresa='$id_empresa' $qfiltrosh and id_curso='3545') as todos3545,
(select COUNT(DISTINCT(rut)) from tbl_enc_elearning_respuestas where id_encuesta='1' and id_empresa='$id_empresa' $qfiltrosh and id_curso='3545') as todos3545R,

(select count(id) from tbl_enc_elearning_respuestas where respuesta >=3 and id_encuesta='1' and id_empresa='$id_empresa' $qfiltrosh and id_curso='4555') as positivo4555,
(select count(id) from tbl_enc_elearning_respuestas where id_encuesta='1' and id_empresa='$id_empresa' $qfiltrosh and id_curso='4555') as todos4555,
(select COUNT(DISTINCT(rut)) from tbl_enc_elearning_respuestas where id_encuesta='1' and id_empresa='$id_empresa' $qfiltrosh and id_curso='4555') as todos4555R,

(select count(id) from tbl_enc_elearning_respuestas where respuesta >=3 and id_encuesta='1' and id_empresa='$id_empresa' $qfiltrosh and id_curso='55') as positivo55,
(select count(id) from tbl_enc_elearning_respuestas where id_encuesta='1' and id_empresa='$id_empresa' $qfiltrosh and id_curso='55') as todos55,
(select COUNT(DISTINCT(rut)) from tbl_enc_elearning_respuestas where id_encuesta='1' and id_empresa='$id_empresa' $qfiltrosh and id_curso='55') as todos55R



from tbl_enc_elearning_respuestas h

where h.id_medicion='1' and h.id_empresa='$id_empresa'

$qfiltro

limit 1

";
//echo "<br>".$sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Clima_Actualiza_id_tipo_gerencia($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

//echo "<br> id_empresa $id_empresa, filtro $filtro";

$sql = "
select h.* from tbl_enc_elearning_respuestas h where h.id_medicion='1' and h.id_encuesta='1' and  id_foco is null

";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

//echo "<br>$sql<br>";
//print_r($cod);
foreach ($cod as $unico) {
$sql = " update tbl_enc_elearning_respuestas set
id_tipo=(select gerencia from tbl_usuario where rut='" . $unico->rut . "'),
id_malla=(select departamento from tbl_usuario where rut='" . $unico->rut . "'),
id_foco=(select jefe from tbl_usuario where rut='" . $unico->rut . "'),
id_programa=(select nombre_completo from tbl_usuario where rut=(select jefe from tbl_usuario where rut='" . $unico->rut . "'))

where

id_medicion='1' and id_encuesta='1' and rut='" . $unico->rut . "'";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//echo "<br>$sql<br>";
}

return $cod;
}

function lista_clima_seguimiento_data($id_empresa, $filtro) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

//echo "<br> id_empresa $id_empresa, filtro $filtro";

$qr1 = "";
if ($r1 != "") {$qr1 = " and h.gerencia='$r1' ";}

$sql = "
select count(h.id) as CuentaTotal,
(select COUNT(DISTINCT(rut)) from tbl_enc_elearning_respuestas where id_medicion='1') as CuentaClima
from tbl_usuario h

where h.id_empresa='$id_empresa' and h.vigencia='0'

";

//

//echo "<br>".$sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function lista_clima_seguimiento_gerencia_data($id_empresa, $filtro) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$qr1 = ""; //if($r1<>""){    $qr1= " and h.gerencia='$r1' ";        }
$sql = " select h.gerencia,  (select count(id) from tbl_usuario where gerencia=h.gerencia)  as cuenta from tbl_usuario h where h.id_empresa='$id_empresa' group by h.gerencia  order by h.gerencia";
//echo "<br>".$sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lista_clima_reporte_dimension_data($id_empresa, $filtro1, $filtro2, $filtro3) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$qr1 = ""; //if($r1<>""){    $qr1= " and h.gerencia='$r1' ";        }
$sql = "
select h.* from tbl_enc_elearning_preg h where h.id_empresa='$id_empresa' group by h.dimension

";
//echo "<br>".$sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lista_clima_reporte_pregunta_data($id_dimension, $id_empresa, $filtro1, $filtro2, $filtro3) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$qr1 = ""; //if($r1<>""){    $qr1= " and h.gerencia='$r1' ";        }
$sql = "
select h.* from tbl_enc_elearning_preg h where h.id_empresa='$id_empresa' and h.id_dimension='$id_dimension'

";
//echo "<br>".$sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lista_divisiones_clima($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select id_tipo from tbl_enc_elearning_respuestas where id_encuesta='1' and id_empresa='$id_empresa' and id_tipo<>'' group by id_tipo order by id_tipo Asc ";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lista_clima_reporte_respuestas_pregunta_data($id_pregunta, $id_empresa, $filtro1, $filtro2, $filtro3) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$qr1 = ""; //if($r1<>""){    $qr1= " and h.gerencia='$r1' ";        }

if ($filtro1 != '') {$qfiltro1 = " and h.id_tipo='$filtro1' ";
$qfiltrosh1 = "    and id_tipo='$filtro1' ";}
if ($filtro2 != '') {$qfiltro2 = " and h.id_malla='$filtro2' ";
$qfiltrosh1 = "   and id_malla='$filtro2' ";}
if ($filtro3 != '') {$qfiltro3 = " and h.id_foco='$filtro3' ";
$qfiltrosh1 = "     and id_foco='$filtro3' ";}

$qfiltro = $qfiltro1 . $qfiltro2 . $qfiltro3;
$qfiltrosh = $qfiltrosh1 . $qfiltrosh2 . $qfiltrosh3;

$sql = "

select h.id,count(id) as total,    h.id_pregunta,
(select pregunta from tbl_enc_elearning_preg where id_pregunta= h.id_pregunta and id_encuesta='1' and id_empresa='$id_empresa'  ) as pregunta,
(select COUNT(DISTINCT(rut)) from tbl_enc_elearning_respuestas where id_medicion='1' and id_medicion='1' and id_empresa='$id_empresa' and id_pregunta='$id_pregunta' $qfiltrosh) as realizados,
(select count(id) from tbl_enc_elearning_respuestas where respuesta >=3 and id_medicion='1' and id_empresa='$id_empresa' and id_pregunta='$id_pregunta' $qfiltrosh) as positivo,
(select count(id) from tbl_enc_elearning_respuestas where respuesta =2 and id_medicion='1' and id_empresa='$id_empresa' and id_pregunta='$id_pregunta' $qfiltrosh) as neutro,
(select count(id) from tbl_enc_elearning_respuestas where respuesta <=1 and id_medicion='1' and id_empresa='$id_empresa' and id_pregunta='$id_pregunta' $qfiltrosh) as negativo,
((select count(id) from tbl_enc_elearning_respuestas where respuesta >=3 and id_medicion='1' and id_empresa='$id_empresa' and id_pregunta='$id_pregunta' $qfiltrosh)
-(select count(id) from tbl_enc_elearning_respuestas where respuesta <=1 and id_medicion='1' and id_empresa='$id_empresa' and id_pregunta='$id_pregunta' $qfiltrosh)) as Neto

from tbl_enc_elearning_respuestas h

where h.id_medicion='1' and h.id_empresa='$id_empresa' and h.id_pregunta='$id_pregunta'
$qfiltro
ORDER BY   (select count(id) from tbl_enc_elearning_respuestas where respuesta >=3 and id_medicion='1' and id_empresa='$id_empresa' and id_pregunta='$id_pregunta') DESC


";
//echo "<br>".$sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lista_clima_reporte_dimension_detalle_data($id_empresa, $filtro) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$qr1 = ""; //if($r1<>""){    $qr1= " and h.gerencia='$r1' ";        }
$sql = "
select h.* from tbl_enc_elearning_preg h where h.id_empresa='$id_empresa' group by h.dimension

";
//echo "<br>".$sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lista_clima_seguimiento_gerencia_Detalle_data($id_empresa, $gerencia) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select COUNT(DISTINCT(h.rut)) as cuenta from tbl_enc_elearning_respuestas h where h.id_medicion='1'



and    h.id_tipo='" . ($gerencia) . "' and h.id_empresa='$id_empresa'

";

//echo "<br>.. sql $sql";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//print_r($cod2);
return $cod;
}

function Lista_Gerencias($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT
h.gerencia
FROM
tbl_usuario h
WHERE
h.id_empresa = '$id_empresa'
AND h.gerencia <> ''  and h.gerencia<>'CENCOS NO ASOCIADOS A GERENCIAS'
GROUP BY
h.gerencia";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function lista_academia_lider_data($id_empresa, $r1, $r2, $r3) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$qr1 = "";
$qr2 = "";
$qr3 = "";
if ($r1 != "") {$qr1 = " and h.gerencia='$r1'  ";}
if ($r2 != "") {$qr2 = " and h.gerenciaR2='$r2' ";}
if ($r3 != "") {$qr3 = " and h.gerenciaR3='$r3' ";}

$sql = "
select h.*,
(select count(id) from tbl_academia_lider where rut=h.rut and id_empresa=h.id_empresa limit 1) as rutmaster,
(select count(id) from tbl_usuario where jefe=h.rut) as cuentaReportes,
(select count(id) from tbl_academia_facilitador where rut=h.rut and id_empresa=h.id_empresa limit 1) as rut_facilitador,

(select induccion_a from tbl_academia_lider  where rut=h.rut and id_empresa=h.id_empresa limit 1) as induccion_a,
(select fase_uno_a from tbl_academia_lider  where rut=h.rut and id_empresa=h.id_empresa limit 1) as fase1_a,
(select fase_dos_a from tbl_academia_lider  where rut=h.rut and id_empresa=h.id_empresa limit 1) as fase2_a



from tbl_usuario h

where h.id_empresa='$id_empresa'

$qr1
$qr2
$qr3

and h.cargo<>'EJECUTIVO SERVICIO CLIENTES'
AND h.cargo<>'CAJERO TESORERO'
AND h.cargo<>'EJECUTIVO SEGURIDAD'
AND h.cargo<>'SECRETARIA GERENCIA'
AND h.cargo<>'EJECUTIVO APOYO'
AND h.cargo<>'EJECUTIVO SERVICIO CLIENTES PREFERENCIAL'
AND h.cargo<>'EJECUTIVO SERVICIO CLIENTE'
AND h.cargo<>'SECRETARIA GERENCIA CONTRALORIA'
AND h.cargo<>'SECRETARIA PRESIDENCIA'
AND h.cargo<>'SECRETARIA GERENTE GENERAL'

AND h.cargo<>'JEFE ESTUDIOS ORGANIZACIONALES'
AND h.cargo<>'TESORERO SUCURSALES'
AND h.cargo<>'DIRECTORA CORP. CREDITO AL MENOR'
AND h.cargo<>'DIRECTOR'
AND h.cargo<>'EJECUTIVO DESARROLLO PERSONAS'
AND h.cargo<>'SUBGERENTE FI AMERICA Y CARIBE'


and h.rut<>''



and h.nombre_empresa_holding  NOT LIKE '%MIAMI%'
and h.nombre_empresa_holding  NOT LIKE '%REPRESENTACION%'

and h.rut<>'15716345'
and h.rut<>'15457218'
and h.rut<>'16440392'
and h.rut<>'10620231'
and h.rut<>'14238239'
and h.rut<>'7526518'
and h.rut<>'17089557'
and h.rut<>'10575832'
and h.rut<>'14703339'
and h.rut<>'anamaria'


and

( (select count(id) from tbl_usuario where jefe=h.rut)>0   or h.cargo LIKE'%GERENTE%')

order by h.nombre_completo

";
//echo "<br>".$sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function lista_Clima_Seguimiento_Detalle_Data($id_empresa, $filtro) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$qr1 = "";
if ($r1 != "") {$qr1 = " and h.gerencia='$r1' ";}

$sql = "
select h.*,
(select COUNT(DISTINCT(rut))  from tbl_enc_elearning_respuestas where rut=h.rut and id_empresa=h.id_empresa limit 1) as Realizado


from tbl_usuario h

where h.id_empresa='$id_empresa'

and h.vigencia='0'
$qr1

order by h.nombre_completo

";
//echo "<br>".$sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function lista_Clima_Respuesta_Data($id_empresa, $filtro) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$qr1 = "";
if ($r1 != "") {$qr1 = " and h.gerencia='$r1' ";}

$sql = "
select h.*,

(select COUNT(DISTINCT(rut))  from tbl_enc_elearning_respuestas where rut=h.rut and id_empresa=h.id_empresa limit 1) as Realizado,
(select id_clasificacion from tbl_enc_elearning_respuestas where rut=h.rut and id_empresa=h.id_empresa limit 1) as Genero,
(select id_curso from tbl_enc_elearning_respuestas where rut=h.rut and id_empresa=h.id_empresa limit 1) as id_curso,
(select fecha from tbl_enc_elearning_respuestas where rut=h.rut and id_empresa=h.id_empresa limit 1) as Fecha_Respuesta,
(select comentario from tbl_enc_elearning_respuestas where rut=h.rut and id_empresa=h.id_empresa limit 1) as Sugerencia




from tbl_usuario h

where h.id_empresa='$id_empresa'

and h.vigencia='0'
$qr1

order by h.gerencia

";
//echo "<br>".$sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function lista_Clima_Respuestas_Detalle_Data($rut, $id_pregunta, $id_empresa, $filtro) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$qr1 = "";
if ($r1 != "") {$qr1 = " and h.gerencia='$r1' ";}

$sql = "
select h.*,
(select COUNT(DISTINCT(rut))  from tbl_enc_elearning_respuestas where rut=h.rut and id_empresa=h.id_empresa limit 1) as Realizado


from tbl_usuario h

where h.id_empresa='$id_empresa'

and h.vigencia='0'
$qr1

order by h.nombre_completo

";
//echo "<br>".$sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Agrupado_certificacionT_data($id_inscripcion, $id_curso, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT

h.*,

(select count(id) as cuenta from tbl_lms_reportes where rut=h.rut and id_curso=h.id_curso and avance='100'  ) as cuenta_lms_reportes_100,
(select count(id) as cuenta from tbl_lms_reportes where rut=h.rut and id_curso=h.id_curso   ) as cuenta_lms_reportes,
(select resultado from tbl_lms_reportes where rut=h.rut and id_curso=h.id_curso   ) as nota_reporte,
(select estado from tbl_lms_reportes where rut=h.rut and id_curso=h.id_curso   ) as estado_reporte,

(select count(id)  from tbl_inscripcion_cierre where rut=h.rut and id_curso=h.id_curso and estado='1' and id_inscripcion='$id_inscripcion' and estado_reporte='REPROBADO'     LIMIT 1) as cuenta_inscripcion_cierre_REPROBADO,
(select count(id)  from tbl_inscripcion_cierre where rut=h.rut and id_curso=h.id_curso and estado='1' and id_inscripcion='$id_inscripcion' and estado_reporte='APROBADO'     LIMIT 1) as cuenta_inscripcion_cierre_APROBADO,

(select count(id)  from tbl_inscripcion_cierre where rut=h.rut and id_curso=h.id_curso and estado='1' and id_inscripcion='$id_inscripcion'     LIMIT 1) as cuenta_inscripcion_cierre_finalizado,
(select count(id)  from tbl_inscripcion_cierre where rut=h.rut and id_curso=h.id_curso and estado='1' and id_inscripcion='$id_inscripcion'     LIMIT 1) as cuenta_inscripcion_cierre_finalizado,

(select estado_descripcion  from tbl_inscripcion_cierre where rut=h.rut and id_curso=h.id_curso  and id_inscripcion='$id_inscripcion'     LIMIT 1) as ESTADO_inscripcion_cierre_finalizado,
(select nota  from tbl_inscripcion_cierre where rut=h.rut and id_curso=h.id_curso  and id_inscripcion='$id_inscripcion'     LIMIT 1) as NOTA_inscripcion_cierre_finalizado,



(select count(id)  from tbl_inscripcion_cierre where rut=h.rut and id_curso=h.id_curso and estado='3'  and id_inscripcion='$id_inscripcion') as cuenta_inscripcion_cierre_proceso,
(select count(id)  from tbl_objetos_finalizados where rut=h.rut and id_objeto=(select id from tbl_objeto where id_curso=h.id_curso limit 1)) as cuenta_objeto_finalizado,
(select count(id)  from tbl_evaluaciones_respuestas_intentos where rut=h.rut and id_objeto=(select id from tbl_objeto where id_curso=h.id_curso limit 1)) as cuenta_usuarios_respuestas_intentos,
(select count(id)  from tbl_evaluaciones_respuestas where rut=h.rut and id_objeto=(select id from tbl_objeto where id_curso=h.id_curso limit 1)) as cuenta_usuarios_respuestas


from tbl_inscripcion_usuarios h

where

h.id_curso='$id_curso' and
h.id_inscripcion='$id_inscripcion' and
h.id_empresa='$id_empresa'";

//echo $sql; exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Actualiza_Estado_Avance_nota($rut, $id_curso, $nota, $estado_descripcion, $avance, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "update tbl_lms_reportes set resultado='$nota', avance='$avance', estado='$estado_descripcion' where rut='$rut' and id_curso='$id_curso' and id_empresa='$id_empresa' ";

//    echo "<br>".$sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function Agrupado_certificacionT_dataRUT($rut, $id_inscripcion, $id_curso, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT

h.*,

(select count(id) as cuenta from tbl_lms_reportes where rut=h.rut and id_curso=h.id_curso and avance='100'  ) as cuenta_lms_reportes_100,
(select count(id) as cuenta from tbl_lms_reportes where rut=h.rut and id_curso=h.id_curso   ) as cuenta_lms_reportes,
(select resultado from tbl_lms_reportes where rut=h.rut and id_curso=h.id_curso   ) as nota_reporte,
(select estado from tbl_lms_reportes where rut=h.rut and id_curso=h.id_curso   ) as estado_reporte,
(select count(id)  from tbl_inscripcion_cierre where rut=h.rut and id_curso=h.id_curso and estado='1' and id_inscripcion='$id_inscripcion') as cuenta_inscripcion_cierre_finalizado,
(select count(id)  from tbl_inscripcion_cierre where rut=h.rut and id_curso=h.id_curso and estado='3' and id_inscripcion='$id_inscripcion') as cuenta_inscripcion_cierre_proceso,

(select nota  from tbl_inscripcion_cierre where rut=h.rut and id_curso=h.id_curso  and id_inscripcion='$id_inscripcion'  order by nota DESC limit 1) as inscripcion_cierre_nota,
(select estado_descripcion  from tbl_inscripcion_cierre where rut=h.rut and id_curso=h.id_curso  and id_inscripcion='$id_inscripcion'  order by estado_descripcion ASC limit 1) as inscripcion_cierre_estado_descripcion,


(select count(id)  from tbl_objetos_finalizados where rut=h.rut and id_objeto=(select id from tbl_objeto where id_curso=h.id_curso limit 1)) as cuenta_objeto_finalizado,
(select count(id)  from tbl_evaluaciones_respuestas_intentos where rut=h.rut and id_objeto=(select id from tbl_objeto where id_curso=h.id_curso limit 1)) as cuenta_usuarios_respuestas_intentos,
(select count(id)  from tbl_evaluaciones_respuestas where rut=h.rut and id_objeto=(select id from tbl_objeto where id_curso=h.id_curso limit 1)) as cuenta_usuarios_respuestas,



(        SELECT count(id)
FROM    tbl_evaluaciones_respuestas_intentos
WHERE    rut = h.rut
AND id_inscripcion='$id_inscripcion'
) AS cuenta_respuestas_intentos_total,

(        SELECT count(id)
FROM    tbl_evaluaciones_respuestas_intentos
WHERE    rut = h.rut
AND id_inscripcion='$id_inscripcion' and correcta='1'
) AS cuenta_respuestas_correctas_intentos_total,


(
(100*(        SELECT count(id)
FROM    tbl_evaluaciones_respuestas_intentos
WHERE    rut = h.rut
AND id_inscripcion='$id_inscripcion' and correcta='1'
) / (        SELECT count(id)
FROM    tbl_evaluaciones_respuestas_intentos
WHERE    rut = h.rut
AND id_inscripcion='$id_inscripcion'
)
))  as NotaPropuesta


from tbl_inscripcion_usuarios h

where

h.rut='$rut' and
h.id_curso='$id_curso' and
h.id_inscripcion='$id_inscripcion' and
h.id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function lista_certificacionT_data($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select h.*,
(select modalidad from tbl_lms_curso where id=h.id_curso),
(select nombre from tbl_lms_curso where id=h.id_curso) as nombre_curso,
(select count(id) from tbl_inscripcion_usuarios where id_inscripcion=h.codigo_inscripcion and id_curso=h.id_curso) as Inscritos

from tbl_inscripcion_curso h

where h.id_empresa='$id_empresa'

and (select modalidad from tbl_lms_curso where id=h.id_curso)='4'

order by (select nombre from tbl_lms_curso where id=h.id_curso), h.fecha_inicio DESC

";
//echo "<br>".$sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function ActualizaInscripcionCierreNotaImparticion($rut, $id_empresa, $id_curso, $id_inscripcion, $nota) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($nota > 0) {
$nota = ROUND($nota, 2);
$sql = "update tbl_inscripcion_cierre set nota='$nota', estado_descripcion='REPROBADO' where rut='$rut' and id_curso='$id_curso' and id_inscripcion='$id_inscripcion'  ";
}

echo "<br><small> set nota='$nota', estado_descripcion='REPROBADO' where rut='$rut' and id_curso='$id_curso' and id_inscripcion='$id_inscripcion'</small>";
$database->setquery($sql);
$database->query();
}

function lista_certificacionT_data_inscripcion_curso($id_empresa, $id_curso, $id_inscripcion) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select h.*,(select modalidad from tbl_lms_curso where id=h.id_curso),
(select nombre from tbl_lms_curso where id=h.id_curso) as nombre_curso,
(select vigencia from tbl_usuario where rut=h.rut) as Vigencia,
(select fecha_inicio from tbl_inscripcion_curso where codigo_inscripcion=h.id_inscripcion) as fecha_inicio,
(select fecha from tbl_evaluaciones_respuestas_intentos where id_inscripcion=h.id_inscripcion and rut=h.rut order by id DESC limit 1) as fecha_real

from tbl_inscripcion_usuarios h

where

h.id_inscripcion='$id_inscripcion'

and h.id_curso='$id_curso'

and h.id_empresa='$id_empresa'

order by (select nombre_completo from tbl_usuario where rut=h.rut) ASC

";
//echo "<br>".$sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function lista_talent_data($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select h.*,
(select count(id) from tbl_skills_usuarios where id_empresa=h.id_empresa and id_cargo=h.id_cargo) as postulantes,
(select count(id) from tbl_skills_resultados where id_empresa=h.id_empresa and id_cargo=h.id_cargo ) as contestados

from tbl_skills h

where h.id_empresa='$id_empresa' group by h.id_cargo, h.nivel_esperado

order by h.cargo

";
//echo "<br>".$sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function MatrizIncentivos_Lista_campo_data($campo1, $campo2, $campo3, $campo4, $campo5, $campo6, $filtro1, $filtro2, $filtro3, $filtro4, $filtro5, $filtro6, $excluir, $incluir, $id_empresa){


/*echo "<br> MatrizIncentivos_Lista_campo_data $campo1, $campo2, $campo3, $campo4, $campo5, $campo6, $filtro1, $filtro2, $filtro3, $filtro4, $filtro5, $filtro6, exclrui $excluir, incluir $incluir, $id_empresa";*/
//exit();
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$query_inicio_1="";	$query_filtro_or_1="";$contador1=0;$contador_total1=0;
$query_filtro_1=explode(";", $filtro1);
foreach ($query_filtro_1 as $unico1){		if($unico1<>""){$contador_total1++;	}}
foreach ($query_filtro_1 as $unico1){		if($unico1<>""){
$query_filtro_or1.="  $campo1 = '$unico1'  ";
$contador_total1=$contador_total1;
if($contador1<($contador_total1-1)){					
$query_filtro_or1.=" or ";					}			$contador1++;
}}


//echo "<br>contador1 $contador1 contador_total1 $contador_total1";

if($query_filtro_or1<>""){ $query_inicio1=" and ($query_filtro_or1) ";}

$sql1 = "
SELECT 	$campo1 as dato FROM 	tbl_usuario
where $campo1<>'' AND id_empresa='$id_empresa'
$query_inicio1
GROUP by $campo1 ORDER BY $campo1 ASC
";
$database->setquery($sql1);
$database->query();
$cod1 = $database->listObjects();
$query_inicio_2="";	$query_filtro_or_2="";$contador2=0;$contador_total2=0;
$query_filtro_2=explode(";", $filtro2);
foreach ($query_filtro_2 as $unico2){		if($unico2<>""){$contador_total2++;	}}
foreach ($query_filtro_2 as $unico2){		if($unico2<>""){
$query_filtro_or2.="  $campo2 = '$unico2'  ";
$contador_total2=$contador_total2;
if($contador2<$contador_total2-1){					
$query_filtro_or2.=" or ";					}			$contador2++;
}}
if($query_filtro_or2<>""){ $query_inicio2=" and ($query_filtro_or2) ";}

$sql2 = "
SELECT 	$campo2 as dato FROM 	tbl_usuario
where $campo2<>'' AND id_empresa='$id_empresa'
$query_inicio1 $query_inicio2
GROUP by $campo2 ORDER BY $campo2 ASC
";
$database->setquery($sql2);
$database->query();
$cod2 = $database->listObjects();
$query_inicio_3="";	$query_filtro_or_3="";$contador3=0;$contador_total3=0;
$query_filtro_3=explode(";", $filtro3);
foreach ($query_filtro_3 as $unico3){		if($unico3<>""){$contador_total3++;	}}
foreach ($query_filtro_3 as $unico3){		if($unico3<>""){
$query_filtro_or3.="  $campo3 = '$unico3'  ";
$contador_total3=$contador_total3;
if($contador3<$contador_total3-1){					
$query_filtro_or3.=" or ";					}			$contador3++;
}}
if($query_filtro_or3<>""){ $query_inicio3=" and ($query_filtro_or3) ";}	

$sql3 = "
SELECT 	$campo3 as dato FROM 	tbl_usuario
where $campo3<>'' AND id_empresa='$id_empresa'
$query_inicio1 $query_inicio2 $query_inicio3
GROUP by $campo3 ORDER BY $campo3 ASC
";
$database->setquery($sql3);
$database->query();
$cod3 = $database->listObjects();
$query_inicio_4="";	$query_filtro_or_4="";$contador4=0;$contador_total4=0;
$query_filtro_4=explode(";", $filtro4);
foreach ($query_filtro_4 as $unico4){		if($unico4<>""){$contador_total4++;	}}
foreach ($query_filtro_4 as $unico4){		if($unico4<>""){
$query_filtro_or4.="  $campo4 = '$unico4'  ";
$contador_total4=$contador_total4;
if($contador4<$contador_total4-1){					
$query_filtro_or4.=" or ";					}			$contador4++;
}}
if($query_filtro_or4<>""){ $query_inicio4=" and ($query_filtro_or4) ";}	

$sql4 = "
SELECT 	$campo4 as dato FROM 	tbl_usuario
where $campo4<>'' AND id_empresa='$id_empresa'
$query_inicio1 $query_inicio2 $query_inicio3 $query_inicio4
GROUP by $campo4 ORDER BY $campo4 ASC
";
$database->setquery($sql4);
$database->query();
$cod4 = $database->listObjects();
$query_inicio_5="";	$query_filtro_or_5="";$contador5=0;$contador_total5=0;
$query_filtro_5=explode(";", $filtro5);
foreach ($query_filtro_5 as $unico5){		if($unico5<>""){$contador_total5++;	}}
foreach ($query_filtro_5 as $unico5){		if($unico5<>""){
$query_filtro_or5.="  $campo5 = '$unico5'  ";
$contador_total5=$contador_total5;
if($contador5<$contador_total5-1){					
$query_filtro_or5.=" or ";					}			$contador5++;
}}
if($query_filtro_or5<>""){ $query_inicio5=" and ($query_filtro_or5) ";}		

$sql5 = "
SELECT 	$campo5 as dato FROM 	tbl_usuario
where $campo5<>'' AND id_empresa='$id_empresa'
$query_inicio1 $query_inicio2 $query_inicio3 $query_inicio4 $query_inicio5
GROUP by $campo5 ORDER BY $campo5 ASC
";
$database->setquery($sql5);
$database->query();
$cod5= $database->listObjects();

$query_inicio_6="";	$query_filtro_or_6="";$contador6=0;$contador_total6=0;
$query_filtro_6=explode(";", $filtro6);
foreach ($query_filtro_6 as $unico6){		if($unico6<>""){$contador_total6++;	}}
foreach ($query_filtro_6 as $unico6){		if($unico6<>""){
$query_filtro_or6.="  $campo6 = '$unico6'  ";
$contador_total6=$contador_total6;
if($contador6<$contador_total6-1){					
$query_filtro_or6.=" or ";					}			$contador6++;
}}
if($query_filtro_or6<>""){ $query_inicio6=" and ($query_filtro_or6) ";}			

$sql6 = "
SELECT 	$campo6 as dato FROM 	tbl_usuario
where $campo6<>'' AND id_empresa='$id_empresa'
$query_inicio1 $query_inicio2 $query_inicio3 $query_inicio4 $query_inicio5 $query_inicio6
GROUP by $campo6 ORDER BY $campo6 ASC
";
$database->setquery($sql6);
$database->query();
$cod6 = $database->listObjects();
$query_inicio_7="";	$query_filtro_or_7="";$contador7=0;$contador_total7=0;
$query_filtro_7=explode(";", $filtro7);
foreach ($query_filtro_7 as $unico7){		if($unico7<>""){$contador_total7++;	}}
foreach ($query_filtro_7 as $unico7){		if($unico7<>""){
$query_filtro_or7.="  $campo7 = '$unico7'  ";
$contador_total7=$contador_total7-1;
if($contador7<$contador_total7){					
$query_filtro_or7.=" or ";					}			$contador7++;
}}
if($query_filtro_or7<>""){ $query_inicio7=" and ($query_filtro_or7) ";}		


/*
echo "<br>SQL 1<br>$sql1<br>";	
echo "<br>SQL 2<br>$sql2<br>";	
echo "<br>SQL 3<br>$sql3<br>";	
echo "<br>SQL 4<br>$sql4<br>";	
echo "<br>SQL 5<br>$sql5<br>";	
echo "<br>SQL 6<br>$sql6<br>";	
*/

$arreglo[1]=$cod1;
$arreglo[2]=$cod2;
$arreglo[3]=$cod3;
$arreglo[4]=$cod4;
$arreglo[5]=$cod5;
$arreglo[6]=$cod6;

$query_excluir="";
$post_excluir = explode(";", $excluir);
foreach($post_excluir as $unico){
$query_excluir.="  and rut<>'$unico' ";
}

//echo "inlcuir $incluir";
//exit();
$query_incluir="";
$post_incluir = explode(";", $incluir);
foreach($post_incluir as $unico){
$query_incluir.="  or rut='$unico' ";
}

//print_r($incluir);
//echo "query_incluir $query_incluir";
//exit();



//print_r($arreglo[5]);
//echo "<pre>";	print_r($arreglo);
//vista general de numero
$sql10 = "
SELECT 	count(id) as cuenta FROM 	tbl_usuario
where $campo6<>'' AND id_empresa='$id_empresa'
$query_inicio1 $query_inicio2 $query_inicio3 $query_inicio4 $query_inicio5 $query_inicio6

$query_excluir $query_incluir

ORDER BY $campo4 ASC";
$database->setquery($sql10);
$database->query();
$cod10 = $database->listObjects();
//echo "<br><br>sql10 $sql10";


//vista usuarios
$sql11 = "
SELECT 	* FROM 	tbl_usuario
where $campo6<>'' AND id_empresa='$id_empresa'
$query_inicio1 $query_inicio2 $query_inicio3 $query_inicio4 $query_inicio5 $query_inicio6


$query_excluir $query_incluir

ORDER BY nombre_completo ASC";
$database->setquery($sql11);
$database->query();
$cod11 = $database->listObjects();
//echo "<br><br>sql11 $sql11";

$arreglo[7]=$cod10[0]->cuenta;
$arreglo[8]=$cod10;
$arreglo[9]=$sql11;


//exit();
return $arreglo;

}

function InsertUpdateAudienciaRUT($id_audiencia,$rut){




}

function TruncateRutIdAudiencia($id_audiencia){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);	

$sql="delete from tbl_audiencia_id_audiencia_rut where id_audiencia='$id_audiencia'";
//echo "<br>TruncateRutIdAudiencia $sql";
$database->setquery($sql);
$database->query();
}

function Audiencia_Sql($sqlquery, $id_audiencia, $id_empresa){


global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "$sqlquery";
$sql=($sql);	
//echo "<br>id_audiencia<br> $id_audiencia, Audiencia_Sql";
//echo "<br>".Decodear3($sql);
$database->setquery(Decodear3($sql));
$database->query();
$cod = $database->listObjects();



//print_r($cod);


foreach ($cod as $unico){


$id_empresa=$_SESSION["id_empresa"];

//echo "<br>id Audiencia $id_audiencia , rut ".$unico->rut;
$sql = "insert into tbl_audiencia_id_audiencia_rut 

(rut,id_audiencia,id_empresa) 

values('".$unico->rut."','$id_audiencia','$id_empresa')";

$database->setquery($sql);
$database->query();

//echo "<br>Audiencia_Sql<br>	 $sql";


}


return $cuenta;	

}


function Cuenta_Audiencia_Sql($sqlquery, $id_audiencia, $id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select count(id) as cuenta from tbl_audiencia_id_audiencia_rut where id_audiencia='$id_audiencia'";

//echo "Audiencia_Sql sql $sql";
//echo "<br><br>";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();


return ($cod[0]->cuenta);	

}
function AudienciaQuery($sql, $exclusion){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if($exclusion<>""){$sql_query=$sql.$exclusion;} else {$sql_query=$sql;}

$sql_query = str_replace('ORDER BY nombre_completo ASC', ' ', $sql_query);

//echo "$sql_query"; exit();

//echo "<br>".$sql;
$database->setquery($sql_query);
$database->query();
$cod = $database->listObjects();

//print_r($cod);
return $cod;
}	

function lista_rut_audiencia_fns_data($id_audiencia) {


global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select h.*
from tbl_audiencia_id_audiencia_rut h

where h.id_audiencia='$id_audiencia' 

";
//echo "<br>".$sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	
}

function lista_audiencia_data($id_empresa, $filtro_creador, $filtro_mes_ano) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);



if($filtro_creador<>""){$queryAutor=" and h.autor='$filtro_creador' ";} else {$queryAutor="";}
if($filtro_mes_ano<>""){$queryMesAno=" and EXTRACT( YEAR_MONTH FROM h.fecha ) ='$filtro_mes_ano'  ";} else {$queryMesAno="";}


$sql = "
select h.*
from tbl_audiencia h

where h.id_empresa='$id_empresa' 
$queryAutor
$queryMesAno
order by h.id DESC

";

//echo "<br>".$sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function lista_documentos_data($id_empresa,$filtro_creador, $filtro_mes_ano) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);



if($filtro_creador<>""){$queryAutor=" and h.autor='$filtro_creador' ";} else {$queryAutor="";}
if($filtro_mes_ano<>""){$queryMesAno=" and EXTRACT( YEAR_MONTH FROM h.fecha ) ='$filtro_mes_ano'  ";} else {$queryMesAno="";}


$sql = "
select h.*
from tbl_audiencia_documentos h

where h.id_empresa='$id_empresa'
$queryAutor
$queryMesAno
order by h.nombre ASC

";
//echo "<br>".$sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function lista_negocios_data($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);



$sql = "
select h.*
from tbl_audiencia_negocio h


order by h.negocio ASC

";
//echo "<br>".$sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}


function lista_documentos_data_tipoYear($id_empresa,$filtro_creador, $filtro_mes_ano, $year, $condicion) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);



if($filtro_creador<>""){$queryAutor=" and h.autor='$filtro_creador' ";} else {$queryAutor="";}
if($filtro_mes_ano<>""){$queryMesAno=" and EXTRACT( YEAR_MONTH FROM h.fecha ) ='$filtro_mes_ano'  ";} else {$queryMesAno="";}

if($condicion=="NOT_yearactual"){
$query_date=" and  YEAR(h.fecha) <> '".$year."'  ";
}

if($condicion=="yearactual"){
$query_date=" and YEAR(h.fecha) = '".$year."'  ";
}


$sql = "
select h.*
from tbl_audiencia_documentos h

where h.id_empresa='$id_empresa'
$queryAutor
$queryMesAno
$query_date
order by h.nombre ASC

";
//echo "<br>$year, $condicion<br>".$sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function lista_notificaciones_creacion_data($id_empresa,$filtro_creador, $filtro_mes_ano) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);



if($filtro_creador<>""){$queryAutor=" and h.autor='$filtro_creador' ";} else {$queryAutor="";}
if($filtro_mes_ano<>""){$queryMesAno=" and EXTRACT( YEAR_MONTH FROM h.fecha ) ='$filtro_mes_ano'  ";} else {$queryMesAno="";}


$sql = "
select h.*
from tbl_notificaciones_creacion h

where h.id_empresa='$id_empresa'
$queryAutor
$queryMesAno
order by h.titulo ASC

";
//echo "<br>".$sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Notificaciones_Creacion_DadoId($id_notificacion,$id_empresa){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);	

$sql	=	"	select h.*	from tbl_notificaciones_creacion h	where h.id='$id_notificacion' and h.id_empresa='$id_empresa'";

//echo "<br>sql $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	
}

function lista_notificaciones_creacion_options_data($id_empresa,$filtro_creador, $filtro_mes_ano) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);



if($filtro_creador<>""){$queryAutor=" and h.autor='$filtro_creador' ";} else {$queryAutor="";}
if($filtro_mes_ano<>""){$queryMesAno=" and EXTRACT( YEAR_MONTH FROM h.fecha ) ='$filtro_mes_ano'  ";} else {$queryMesAno="";}


$sql = "
select h.*
from tbl_notificaciones_creacion h

where h.id_empresa='$id_empresa'
$queryAutor
$queryMesAno
order by h.titulo ASC

";
//echo "<br>".$sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function lista_visualizacion_publicaciones_rut_fns_data($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select h.*, 
(select nombre from tbl_audiencia_publicaciones where id=h.ambiente) as publicacion,
(select fecha_inicio from tbl_audiencia_publicaciones where id=h.ambiente) as publicacion_fecha_inicio,
(select fecha_termino from tbl_audiencia_publicaciones where id=h.ambiente) as publicacion_fecha_termino

from tbl_audiencia_estadistica h where h.id_empresa='$id_empresa' group by h.rut, h.ambiente order by h.fecha DESC, h.hora DESC

";
//echo "<br>".$sql;exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function lista_publicaciones_fns_categoria_data($categoria, $perfil,  $id_empresa,$filtro_temporalidad,$filtro_creador,$filtro_mes_ano) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

//echo "perfil $perfil";
$perfil=($perfil);
if($categoria<>"")	{$query_agrupacion=" and h.agrupacion='$categoria'";} else {$query_agrupacion="";}



if($perfil=="")		{$query_perfil="";}

if($perfil=="Control de Gestion"){$query_perfil=" and (h.perfil=''  or h.perfil is null )";}
if($perfil=="Gestion e Incentivos"){$query_perfil=" and (h.perfil='Gestion e Incentivos' or h.perfil='' or h.perfil is null) ";}


$hoy=date("Y-m-d");

if($filtro_temporalidad=="Activo")		{$query_Temporalidad="  and h.fecha_termino>='$hoy' and h.fecha_inicio<='$hoy' " ;}
if($filtro_temporalidad=="Historico")	{$query_Temporalidad="  	and h.fecha_termino<'$hoy'" ;}
if($filtro_temporalidad=="Futuro")		{$query_Temporalidad="  	and h.fecha_inicio>'$hoy'  " ;}

if($filtro_creador<>"")					{$query_Creador =" and h.autor='$filtro_creador' ";} else {$query_Creador ="";}
if($filtro_mes_ano<>"")					{$query_MesAno =" 

and EXTRACT( YEAR_MONTH FROM h.fecha_inicio ) ='$filtro_mes_ano'
";} else {$query_MesAno ="";}



$sql = "
select h.*,
(select nombre from tbl_audiencia where id=h.id_audiencia) as audiencia,
(select sqlquery from tbl_audiencia where id=h.id_audiencia) as sqlquery,
(select nombre from tbl_audiencia_documentos where id=h.id_documento) as documento,
(select filename_enc from tbl_audiencia_documentos where id=h.id_documento) as filename_enc,
(select negocio from tbl_audiencia_negocio where id=h.negocio) as nombre_negocio

from tbl_audiencia_publicaciones h

where h.id_empresa='$id_empresa'

$query_agrupacion
$query_perfil
$query_Creador
$query_MesAno
$query_Temporalidad
order by h.fecha_inicio DESC

";

//echo "<br>".$sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function lista_publicaciones_fns_data($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select h.*,
(select nombre from tbl_audiencia where id=h.id_audiencia) as audiencia,
(select sqlquery from tbl_audiencia where id=h.id_audiencia) as sqlquery,
(select nombre from tbl_audiencia_documentos where id=h.id_documento) as documento,
(select filename_enc from tbl_audiencia_documentos where id=h.id_documento) as filename_enc,
(select negocio from tbl_audiencia_negocio where id=h.negocio) as nombre_negocio


from tbl_audiencia_publicaciones h

where h.id_empresa='$id_empresa' order by h.fecha_inicio DESC

";
//echo "<br>".$sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function AudienciaPublicacion($id_publicacion_envio,$id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select h.*

from tbl_audiencia_publicaciones h

where h.id_empresa='$id_empresa' and h.id='$id_publicacion_envio'
";
//echo "<br>".$sql; 
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;

}

function Audiencia_lista_tbl_audiencia_id_audiencia_rut($id_audiencia_envio, $id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select h.*, (select email from tbl_usuario where rut=h.rut) as email

from tbl_audiencia_id_audiencia_rut h

where h.id_empresa='$id_empresa' and h.id_audiencia='$id_audiencia_envio'
";
//echo "<br>".$sql; 
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	

}

function Audiencia_lista_tbl_audiencia_id_audiencia_rut_sinEnviar($id_audiencia_envio, $id_publicacion, $id_empresa){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select h.*, (select email from tbl_usuario where rut=h.rut) as email,
(select count(id) as cuenta from tbl_audiencia_notificaciones where rut=h.rut and id_publicacion='$id_publicacion')  as cuentaenvio


from tbl_audiencia_id_audiencia_rut h where h.id_empresa='$id_empresa' and h.id_audiencia='$id_audiencia_envio'

and

(select count(id) as cuenta from tbl_audiencia_notificaciones where rut=h.rut and id_publicacion='$id_publicacion')=0

";
//echo "<br>".$sql; 
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;	

}


function lista_noti_fns_data($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select h.*,
(select nombre from tbl_audiencia where id=h.id_audiencia) as audiencia,
(select nombre from tbl_audiencia_documentos where id=h.id_documento) as documento,
(select count(rut) from tbl_audiencia_id_audiencia_rut where id_audiencia=h.id_audiencia) as num_colaboradores,
(select count(id) from tbl_audiencia_notificaciones where id_publicacion=h.id) as num_notificaciones

from tbl_audiencia_publicaciones h

where h.id_empresa='$id_empresa' order by h.fecha_inicio DESC
";
//echo "<br>".$sql; 
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function lista_becas_validacion_data($idcategoria, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if($_SESSION["rut_col"]<>""){
$Jquery=" and h.rut='".$_SESSION["rut_col"]."' ";
} else {
$Jquery="  ";
}

$tbl_becas=$_SESSION["tbl_becas"];

$sql = "select h.*, 
(select nombre_completo from tbl_usuario where rut=h.rut) as nombre,
(select cargo from tbl_usuario where rut=h.rut) as cargo,
(select division from tbl_usuario where rut=h.rut) as division

from $tbl_becas h

where h.id_empresa='$id_empresa' 
$Jquery
and h.tipo_beca='$idcategoria' ";

// echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lista_becas_becas_validacion_data($idcategoria, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.*, (select nombre_completo from tbl_usuario where rut=h.rut) as nombre

from tbl_becas h

where h.id_empresa='$id_empresa' and h.tipo_beca='$idcategoria' ";

// echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lista_formacion_continua_validacion_data($idcategoria, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.*

from tbl_postulaciones h

where h.id_empresa='$id_empresa' and h.id_postulable='$idcategoria' ";

// echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lista_talent_vista_data($id_cargo, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.*,
(select cargo from tbl_skills where id_empresa=h.id_empresa and id_cargo=h.id_cargo limit 1) as cargo,
(select nivel from tbl_skills where id_empresa=h.id_empresa and id_cargo=h.id_cargo limit 1) as niv_esperado

from tbl_skills_usuarios h

where h.id_empresa='$id_empresa' and h.id_cargo='$id_cargo' ";

// echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lista_talent_vista_rut_data($id_cargo, $id_empresa, $rut) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select h.*

from tbl_skills_usuarios h

where h.id_empresa='$id_empresa' and h.id_cargo='$id_cargo' and h.rut='$rut'

";

// echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function Talent_Skills_Resultados($rut, $id_cargo, $id_nivel_esperado, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.* from tbl_skills_resultados h
where h.id_empresa='$id_empresa' and h.id_cargo='$id_cargo' and h.id_nivel_esperado='$id_nivel_esperado'
and h.puntos<>'' and h.rut='$rut'";

//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function FC_actualizaEstado($idFC, $id_tipo, $v, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "update tbl_postulaciones set jefeok='$v' where id='$idFC' and id_empresa='$id_empresa'";

//echo $sql;    sleep(3);
$database->setquery($sql);
$database->query();

}


function BecasUpdateDocumentacionTipo($idenc, $tipo, $validacion_doc, $fecha) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$sql = "update tbl_becas set $tipo='$validacion_doc' where     id='$idenc' ";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function BecasUpdateDocumentacion($idenc, $estado, $fecha) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "update tbl_becas set documentacionok='$estado', fechadocumentacion='$fecha' where     id='$idenc' ";

// echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function BecasUpdateValidacion($idenc, $estado, $fecha) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "update tbl_becas set validacionok='$estado', fechavalidacion='$fecha' where     id='$idenc' ";

// echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}
function BeneficiosUpdateValidacion($idenc, $estado, $fecha) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "update tbl_becas set documentacionok='$estado', fechavalidacion='$fecha' where     id='$idenc' ";

// echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}
function lista_emb_equipo_data($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = " select h.* from tbl_emb_equipos h where h.id_empresa='$id_empresa'  ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function Inserta_Certificaciones_Historicas($rut, $id_curso, $inscripcion, $nota,
$fecha_inicio, $fecha_termino, $estado, $reprobado_inasistencia, $realizado, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT id FROM tbl_certificaciones_historicas WHERE id_empresa = '$id_empresa' and rut='$rut' and id_curso='$id_curso' and id_inscripcion='$inscripcion'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

//echo $sql;

$id = $cod[0]->id;

if ($id > 0) {
} else {
$sql = "
INSERT INTO tbl_certificaciones_historicas (rut,id_curso,id_inscripcion,fecha_inicio,fecha_termino,realizado,reprobado_inasistencia,nota,id_empresa,estado)
VALUES ('$rut','$id_curso','$inscripcion',    '$fecha_inicio','$fecha_termino', '$realizado', '$reprobado_inasistencia', '$nota', '$id_empresa', '$estado')    ";
}

//echo $sql; sleep(5);

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function emb_olas_Save_data($codigo, $nombre, $descripcion, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT id FROM tbl_emb_olas WHERE id_empresa = '$id_empresa' and codigo='$codigo' order by id DESC Limit 1";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

//echo $sql;

$id = $cod[0]->id;
$nuevo_id = $id_empresa . "_" . $nuevo;
$nombre = utf8_decode($nombre);
$descripcion = utf8_decode($descripcion);

if ($id > 0) {
$sql = "
UPDATE tbl_emb_olas set codigo='$codigo', nombre='$nombre', descripcion='$descripcion' where  id_empresa='$id_empresa' and id='$id'

";
} else {
$sql = "
INSERT INTO tbl_emb_olas (codigo, nombre, descripcion,  id_empresa)
VALUES ('$codigo', '$nombre', '$descripcion','$id_empresa')
";
}

//echo $sql; sleep(5);

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function com_stories_360_data($rut, $id_empresa, $id_registro) {

//echo "$rut, $id_empresa, $id_registro";
global $c_host, $c_user, $c_pass, $c_db;
$id_empresa = $_SESSION["id_empresa"];

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT id_st FROM tbl_mp_stories WHERE id_empresa = '$id_empresa' order by id DESC Limit 1";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

$hora = date("H:m:s");
$fecha = date("Y-m-d");

$id_st = $cod[0]->id_st;
$porciones = explode("st", $id_st);
$nuevo_id = $porciones[1] + 1;
$nuevo_id_st = "st" . $nuevo_id;

if ($id_registro > 0) {
$video = "https://ngd.cl/capacitacionbci/compartebci/convencion/" . $rut . ".mp4";
$imagen = "https://ngd.cl/capacitacionbci/compartebci/convencion/" . $rut . ".jpg";
$sql = "
UPDATE tbl_mp_stories set rut='$rut', video='$video', imagen='$imagen'  where  id_empresa='$id_empresa' and id='$id_registro'

";
} else {

$video = "https://ngd.cl/capacitacionbci/compartebci/convencion/" . $rut . ".mp4";
$imagen = "https://ngd.cl/capacitacionbci/compartebci/convencion/" . $rut . ".jpg";

$sql = "
INSERT INTO tbl_mp_stories (id_st,rut,fecha,hora,id_categoria,video, imagen, id_empresa)
VALUES ('$nuevo_id_st', '$rut', '$fecha','$hora', 'stories_360','$video', '$imagen','$id_empresa')
";
}

//echo $sql; sleep(5);

if ($rut != '') {
$database->setquery($sql);
$database->query();
}
$cod = $database->listObjects();
return $cod;
}

function com_stories_twit_data($rut, $id_empresa, $contenido, $id_registro) {

//echo "$rut, $id_empresa, $id_registro, $contenido";
global $c_host, $c_user, $c_pass, $c_db;
$id_empresa = $_SESSION["id_empresa"];

$contenido = utf8_decode($contenido);
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT id_st FROM tbl_mp_stories WHERE id_empresa = '$id_empresa' order by id DESC Limit 1";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

$hora = date("H:m:s");
$fecha = date("Y-m-d");

$id_st = $cod[0]->id_st;
$porciones = explode("st", $id_st);
$nuevo_id = $porciones[1] + 1;
$nuevo_id_st = "st" . $nuevo_id;

if ($id_registro > 0) {
$imagen = "https://ngd.cl/capacitacionbci/compartebci/convencion/" . $rut . ".jpg";
$sql = "
UPDATE tbl_mp_stories set rut='$rut', stories='$contenido', imagen='$imagen'  where  id_empresa='$id_empresa' and id='$id_registro'

";
} else {

$video = "https://ngd.cl/capacitacionbci/compartebci/convencion/" . $rut . ".mp4";
$imagen = "https://ngd.cl/capacitacionbci/compartebci/convencion/" . $rut . ".jpg";

$sql = "
INSERT INTO tbl_mp_stories (id_st,rut,fecha,hora,id_categoria,stories, imagen, id_empresa)
VALUES ('$nuevo_id_st', '$rut', '$fecha','$hora', 'stories_360','$contenido', '$imagen','$id_empresa')
";
}

//echo $sql; sleep(5);

if ($rut != '') {
$database->setquery($sql);
$database->query();
}
$cod = $database->listObjects();
return $cod;
}

function emb_equipo_Save_data($codigo, $nombre, $descripcion, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT id FROM tbl_emb_equipos WHERE id_empresa = '$id_empresa' and codigo='$codigo' order by id DESC Limit 1";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

//echo $sql;

$id = $cod[0]->id;
$nuevo_id = $id_empresa . "_" . $nuevo;
$nombre = utf8_decode($nombre);
$descripcion = utf8_decode($descripcion);

if ($id > 0) {
$sql = "
UPDATE tbl_emb_equipos set codigo='$codigo', nombre='$nombre', descripcion='$descripcion' where  id_empresa='$id_empresa' and id='$id'

";
} else {
$sql = "
INSERT INTO tbl_emb_equipos (codigo, nombre, descripcion,  id_empresa)
VALUES ('$codigo', '$nombre', '$descripcion','$id_empresa')
";
}

//echo $sql; sleep(5);

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function BuscaGrupodadoIdgrupo($idgrupo, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select grupo from tbl_emb_embajadores where id_empresa='$id_empresa' and idgrupo='$idgrupo' and grupo<>'' limit 1";
//echo $sql; sleep(5);

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod[0]->grupo;
}

function lista_emb_embajadores_data($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select h.*

from tbl_emb_embajadores h where h.id_empresa='$id_empresa'

order by h.id_ola, h.idgrupo";

//  echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lista_emb_embajadores_data_order($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select h.*

from tbl_emb_embajadores h where h.id_empresa='62'
and h.email <>'@'
group by h.rut
order by h.email";

//  echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lista_emb_tutores_data($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select h.*, (select rut_completo from tbl_usuario where rut=h.rut limit 1) as rut_completo,
(select nombre_completo from tbl_usuario where rut=h.rut limit 1) as nombre_completo,
(select cargo from tbl_usuario where rut=h.rut limit 1) as cargo,
(select gerencia from tbl_usuario where rut=h.rut limit 1) as gerencia,
(select gerenciaR2 from tbl_usuario where rut=h.rut limit 1) as gerenciaR2,
(select gerenciaR3 from tbl_usuario where rut=h.rut limit 1) as gerenciaR3


from tbl_emb_tutores h where h.id_empresa='$id_empresa' ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lista_emb_tutores_data_asignacion($rut, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select h.*, (select rut_completo from tbl_usuario where rut=h.rut limit 1) as rut_completo,
(select nombre_completo from tbl_usuario where rut=h.rut limit 1) as nombre_completo,
(select cargo from tbl_usuario where rut=h.rut limit 1) as cargo,
(select gerencia from tbl_usuario where rut=h.rut limit 1) as gerencia,
(select gerenciaR2 from tbl_usuario where rut=h.rut limit 1) as gerenciaR2,
(select gerenciaR3 from tbl_usuario where rut=h.rut limit 1) as gerenciaR3


from tbl_emb_embajadores h where h.id_empresa='$id_empresa' and rut_tutor='$rut' ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function emb_embajadores_Save_data($rut, $ola, $tutores, $sponsor, $idgrupo, $grupo, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT id FROM tbl_emb_embajadores WHERE id_empresa = '$id_empresa' order by id DESC Limit 1";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

$nuevo = $cod[0]->id + 1;
$nuevo_id = $id_empresa . "_" . $nuevo;
$nombre = utf8_decode($nombre);
$descripcion = utf8_decode($descripcion);
$descripcion_accion = utf8_decode($descripcion_accion);
$emailUser = usernameEmail($rut, $id_empresa);

$sql = "
INSERT INTO tbl_emb_embajadores (rut, id_ola, rut_tutor, rut_sponsor, grupo, idgrupo, email, id_empresa)
VALUES ('$rut', '$ola','$tutores','$sponsor','$grupo','$idgrupo', '$emailUser', '$id_empresa')
";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function emb_embajadores_Edit_data($rut, $ola, $tutores, $sponsor, $idgrupo, $grupo, $id_empresa, $id) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
UPDATE tbl_emb_embajadores set rut='$rut', id_ola='$ola', rut_tutor='$tutores', rut_sponsor='$sponsor', grupo='$grupo', idgrupo='$idgrupo' where id='$id'
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function emb_tutores_Save_data($rut, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT id FROM tbl_emb_tutores WHERE id_empresa = '$id_empresa' order by id DESC Limit 1";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

$nuevo = $cod[0]->id + 1;
$nuevo_id = $id_empresa . "_" . $nuevo;
$nombre = utf8_decode($nombre);
$descripcion = utf8_decode($descripcion);
$descripcion_accion = utf8_decode($descripcion_accion);

$sql = "
INSERT INTO tbl_emb_tutores (rut,   id_empresa)
VALUES ('$rut',  '$id_empresa')
";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function lista_rel_emb_tareas_data($rut, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select h.*, (select nombre from tbl_emb_tareas where codigo=h.id_tarea) as nombre_tarea

from tbl_emb_rel_embajadores_tareas h where h.id_empresa='$id_empresa' and rut='$rut'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lista_emb_rel_embajadores_tareas_data($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select h.*,

(select id_ola from tbl_emb_embajadores where rut=h.rut limit 1) as id_ola,
(select email from tbl_emb_embajadores where rut=h.rut limit 1) as email,

(select nombre from tbl_emb_olas where codigo=h.codigo limit 1) as nombre_ola,

(select nombre from tbl_emb_tareas where codigo=h.id_tarea     LIMIT 1) as nombretarea,
(select fecha_registro from tbl_emb_respuestas_embajadores_tareas where id_tarea=h.id_tarea and rut=h.rut LIMIT 1 )     as fecha_registro,
(select comentarios from tbl_emb_respuestas_embajadores_tareas where id_tarea=h.id_tarea and rut=h.rut     LIMIT 1) as comentarios,
(select link from tbl_emb_respuestas_embajadores_tareas where id_tarea=h.id_tarea and rut=h.rut     LIMIT 1) as link,
(select estado from tbl_emb_respuestas_embajadores_tareas where id_tarea=h.id_tarea and rut=h.rut     LIMIT 1) as estado,
(select fecha_validacion from tbl_emb_respuestas_embajadores_tareas where id_tarea=h.id_tarea and rut=h.rut    LIMIT 1) as fecha_validacion,
(select conquientrabajaste from tbl_emb_respuestas_embajadores_tareas where id_tarea=h.id_tarea and rut=h.rut     LIMIT 1) as trabajaste

from tbl_emb_rel_embajadores_tareas h where h.id_empresa='$id_empresa' order by h.codigo, h.rut ";

//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
// print_r($cod);
return $cod;
}

function emb_rel_embajadores_tareas_Save_data($rut, $tarea, $id_grupo, $id_empresa) {

//echo   ""$rut, $tarea, $id_grupo, $id_empresa"; sleep(10);
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT id FROM tbl_emb_rel_embajadores_tareas WHERE id_empresa = '$id_empresa' order by id DESC Limit 1";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

$nuevo = $cod[0]->id + 1;
$nuevo_id = $id_empresa . "_" . $nuevo;

$fecha = date("Y-m-d");
$sql = "
INSERT INTO tbl_emb_rel_embajadores_tareas (rut, id_tarea, codigo, id_empresa)
VALUES ('$rut', '$tarea', '$id_grupo', '$id_empresa')
";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

$sql = "
INSERT INTO tbl_emb_respuestas_embajadores_tareas (rut, id_tarea, id_empresa, fecha_inicio, fecha_registro, estado, id_grupo_interes)
VALUES ('$rut', '$tarea', '$id_empresa','$fecha','$fecha','INICIADA','$id_grupo')
";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function emb_inscribir_Edit_data($rut_tutor, $id_tutor, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "update tbl_emb_tutores set rut='$rut_tutor'     where id='$id_tutor' and    id_empresa='$id_empresa'";

//    echo $sql; exit();
$database->setquery($sql);
$database->query();
}

function emb_relemb_delete_data($rut, $id_tarea, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "delete from tbl_emb_rel_embajadores_tareas     where rut='$rut' and id_tarea='$id_tarea' and   id_empresa='$id_empresa'";

//    echo $sql; exit();
$database->setquery($sql);
$database->query();
}
function BorraPremiocanje($id, $id_empresa){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "delete from tbl_premios      where id='$id' and id_empresa='$id_empresa'   ";
$database->setquery($sql);
$database->query();

}
function SaveMPGaleria($rut, $mensaje, $foto, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$fecha = date("Y-m-d");
$sql = "
INSERT INTO tbl_mp_fotomensaje (rut, foto, mensaje, id_empresa, grupo, fecha)
VALUES ('$rut', '$foto', '$mensaje', '$id_empresa','', '$fecha')
";

//echo "SQL $sql"; exit();
$database->setquery($sql);

if ($foto != '') {
$database->query();
$cod = $database->listObjects();
}

return $cod;
}
function SaveSliderImagen($rut, $mensaje, $foto, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$mensaje = ($mensaje);
$fecha = date("Y-m-d");
$sql = "
INSERT INTO tbl_lms_slider (rut, foto, mensaje, id_empresa, grupo, fecha)
VALUES ('$rut', '$foto', '$mensaje', '$id_empresa','', '$fecha')
";

// echo "SQL $sql"; sleep(5);
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}



function AudienciaInsertNotificaciones($rut,$id_publicacion_envio,$id_empresa){


global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$mensaje = ($mensaje);
$fecha = date("Y-m-d");

$sql = "
INSERT INTO tbl_audiencia_notificaciones (id_publicacion, id_audiencia, rut, fecha, id_empresa)
VALUES ('$id_publicacion_envio', '', '$rut', '$fecha', '$id_empresa')
";

//echo "SQL $sql";exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;	



}

function puntos_stock_Edit_data($id, $nombre, $descripcion, $condiciones, $requisitos, $puntos, $stock, $validajefe, $temporal, $region, $ultimas,
$solicitadia, $dia, $orden, $alertaweb, $alertaemailcol, $alertaemailjefe, $imagen, $fecha_vencimiento, $fecha_inicio, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$nombre = utf8_decode($nombre);
$descripcion = utf8_decode($descripcion);
$condiciones = utf8_decode($condiciones);
$requisitos = utf8_decode($requisitos);
$alertaweb  = utf8_decode($alertaweb);
$alertaemailcol   = utf8_decode($alertaemailcol);
$alertaemailjefe   = utf8_decode($alertaemailjefe);

$sql = "update tbl_premios

set premio='$nombre', premioludico='$nombre', premio_descripcion='$descripcion', condiciones='$condiciones', requisitos='$requisitos',
puntos='$puntos', stock='$stock', region='$region', aprobacionjefe='$validajefe', temporalidad='$temporal', alertaultimasunidades='$ultimas',
dia='$dia', solicitadia='$solicitadia',
orden='$orden',   imagen='$imagen',         alertaweb='$alertaweb', alertaemailusuario='$alertaemailcol', alertaemailjefe='$alertaemailjefe'
,  fecha_vencimiento='$fecha_vencimiento',  fecha_inicio='$fecha_inicio'

where id='$id' and   id_empresa='$id_empresa'";
//echo $sql; exit();
$database->setquery($sql);
$database->query();
}

function puntos_stock_Add_data($id, $codigo, $id_dimension, $segmento, $nombre, $descripcion, $condiciones, $requisitos, $puntos, $stock, $validajefe, $temporal, $region, $ultimas,
$solicitadia, $dia, $orden, $alertaweb, $alertaemailcol, $alertaemailjefe, $imagen, $fecha_vencimiento, $fecha_inicio, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$nombre = utf8_decode($nombre);
$descripcion = utf8_decode($descripcion);
$condiciones = utf8_decode($condiciones);
$requisitos = utf8_decode($requisitos);
$sql = "INSERT INTO tbl_premios (id_premio, id_dimension,segmento,premio, premioludico, premio_descripcion,
condiciones, requisitos, puntos, stock,   region  ,
aprobacionjefe, temporalidad,  alertaultimasunidades, dia, solicitadia,

orden, alertaweb, alertaemailusuario, alertaemailjefe, imagen,
fecha_vencimiento,fecha_inicio, id_empresa) " .
"VALUES (   '$codigo', '$id_dimension','$segmento','$nombre','$nombre', '$descripcion',
'$condiciones', '$requisitos', '$puntos', '$stock', '$region',
'$validajefe', '$temporal','$ultimas','$dia','$solicitadia',
'$orden', '$alertaweb', '$alertaemailcol',  '$alertaemailjefe','$imagen',
'$fecha_vencimiento','$fecha_inicio', '$id_empresa');";
//echo $sql; exit();
// sleep(10);
$database->setquery($sql);
$database->query();
}

function FC_Edit_data($id, $modalidad, $ficha, $institucion, $region, $dimension,
$invisible, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$nombre = utf8_decode($nombre);
$descripcion = utf8_decode($descripcion);

$sql = "update tbl_postulables

set modalidad='$modalidad',
ficha='$ficha', dato4='$institucion',
region='$region', dimension='$dimension', invisible='$invisible'

where id='$id' and    id_empresa='$id_empresa'";
//echo $sql;exit();
$database->setquery($sql);
$database->query();
}

function UpdatePreguntaIdOBjetoTodos($id_evaluacion, $id_objeto, $id_pregunta, $sufijo) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$id_evaluacionueva = $id_evaluacion . "$sufijo";
$id_objetonuevo = $id_objeto . "$sufijo";
$id_preguntanuevo = $id_pregunta . "$sufijo";

$sql = "update tbl_evaluaciones_asociacion_preguntas_usuario
set rut=CONCAT(rut,'$sufijo')

where  id_evaluacion='$id_evaluacion' and
id_objeto='$id_objeto' and
id_pregunta='$id_pregunta'";

$database->setquery($sql);
$database->query();

$sql = "update tbl_evaluaciones_respuestas
set rut=CONCAT(rut,'$sufijo')

where
id_objeto='$id_objeto' and
id_pregunta='$id_pregunta'";
$database->setquery($sql);
$database->query();

$sql = "update tbl_evaluaciones_respuestas_intentos
set rut=CONCAT(rut,'$sufijo')

where
id_objeto='$id_objeto' and
id_pregunta='$id_pregunta'";
$database->setquery($sql);
$database->query();

$database->setquery($sql);
$database->query();
}

function BuscaPreguntasDadaEvaluacion($id_eval, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = " select h.* from tbl_evaluaciones_preguntas h where h.evaluacion='$id_eval' ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ReporteAvanceEvalCial() {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT
baseevaluado.rut_completo as rut_evaluado,
baseevaluado.nombre_completo as nombre_evaluado,
baseevaluado.cargo as cargo_evaluado,
baseevaluado.gerencia as gerencia_evaluado,
baseevaluador.rut_completo as rut_evaluador,
baseevaluador.nombre_completo as nombre_evaluador,
baseevaluador.cargo as cargo_evaluador,
baseevaluador.gerencia as gerencia_evaluador,
tbl_sgd_finalizados_evaluado_evaluador.fecha as fecha_finalizacion
FROM
tbl_sgd_relaciones

left join tbl_sgd_finalizados_evaluado_evaluador
on tbl_sgd_finalizados_evaluado_evaluador.evaluado=tbl_sgd_relaciones.evaluado and tbl_sgd_finalizados_evaluado_evaluador.evaluador=tbl_sgd_relaciones.evaluador
inner join tbl_usuario as baseevaluado
on baseevaluado.rut=tbl_sgd_relaciones.evaluado


inner join tbl_usuario as baseevaluador
on baseevaluador.rut=tbl_sgd_relaciones.evaluador

where tbl_sgd_relaciones.id_proceso=$id_proceso_sgd;



order by tbl_sgd_relaciones.evaluador asc";
//echo $sql; echo "<br>";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ReporteFijacionCial() {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT
tbl_usuario.rut_completo,
tbl_usuario.nombre_completo,
tbl_usuario.cargo,
tbl_usuario.gerencia,
tbl_usuario.centro_costo,
tbl_objetivos_individuales.descripcion_objetivo as Descriptor,
tbl_objetivos_individuales.metrica as TipoMedicion,
tbl_objetivos_individuales.ponderacion as Ponderacion,
tbl_objetivos_individuales.fecha_limite as Fecha,
tbl_objetivos_individuales.nocumple as NoCumple,
tbl_objetivos_individuales.cumple as Cumple,
tbl_objetivos_individuales.sobresale as Sobresale
FROM
tbl_objetivos_individuales
inner JOIN tbl_usuario
on tbl_usuario.rut=tbl_objetivos_individuales.rut
WHERE
tbl_objetivos_individuales.id_empresa = '74'";
//echo $sql; echo "<br>";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}
function ReporteAvanceFijacionCial() {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT
baseevaluado.rut_completo as rut_evaluado,
baseevaluado.nombre_completo as nombre_evaluado,
baseevaluado.cargo as cargo_evaluado,
baseevaluado.gerencia as gerencia_evaluado,
baseevaluado.centro_costo as centro_costo_evaluado,

baseevaluador.rut_completo as rut_evaluador,
baseevaluador.nombre_completo AS nombre_evaluador,
baseevaluador.cargo AS cargo_evaluador,
baseevaluador.gerencia AS gerencia_evaluador,
baseevaluador.centro_costo AS centro_costo_evaluador,
(
SELECT
count(*)AS total
FROM
tbl_objetivos_individuales
WHERE
tbl_objetivos_individuales.rut = tbl_sgd_relaciones.evaluado
)AS total_objetivos_ingresados,
(
SELECT
count(*)AS total
FROM
tbl_objetivos_indviduales_finalizado
WHERE
tbl_objetivos_indviduales_finalizado.evaluado = tbl_sgd_relaciones.evaluado
AND tbl_objetivos_indviduales_finalizado.evaluador = tbl_sgd_relaciones.evaluador
AND tbl_objetivos_indviduales_finalizado.id_proceso = tbl_sgd_relaciones.id_proceso
)AS total_finalizados
FROM
tbl_sgd_relaciones
INNER JOIN tbl_usuario AS baseevaluado ON baseevaluado.rut = tbl_sgd_relaciones.evaluado
INNER JOIN tbl_usuario AS baseevaluador ON baseevaluador.rut = tbl_sgd_relaciones.evaluador
WHERE
tbl_sgd_relaciones.id_proceso = '111'";
//echo $sql; echo "<br>";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function SGD_delete_vtbl_sgd_relaciones($evaluado, $evaluador, $id_proceso, $id_empresa, $observaciones) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "delete from tbl_sgd_relaciones      where

evaluador='$evaluador' and
evaluado='$evaluado' and
id_proceso='$id_proceso' and
id_empresa='$id_empresa'
";
$database->setquery($sql);
$database->query();

$sql = "INSERT INTO tbl_sgd_noevaluables (evaluado, evaluador, observacion) " .
"VALUES ('$evaluado', '$evaluador', '$observaciones');";

$database->setquery($sql);
$database->query();
}

function SGD_ACtualizaInserta_vtbl_sgd_relaciones($evaluado, $evaluador, $id_proceso, $id_empresa, $nuevoevaluador) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($nuevoevaluador != '') {$evaluador = $nuevoevaluador;}

$sql = "select id from tbl_sgd_relaciones where

evaluado='$evaluado' and
id_proceso='$id_proceso' and
id_empresa='$id_empresa' ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

if (count($cod) > 0) {
$sql = "update tbl_sgd_relaciones set evaluador='$evaluador'
where  evaluado='$evaluado' and
id_proceso='$id_proceso' and
id_empresa='$id_empresa'";
} else {

$sql = "INSERT INTO tbl_sgd_relaciones (evaluado, evaluador, id_proceso, id_empresa) " .
"VALUES ('$evaluado', '$evaluador', '$id_proceso','$id_empresa');";
}

$database->setquery($sql);
$database->query();
}

function BuscaMallaPrograma($id_programa, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.id_malla, (select nombre  from tbl_lms_malla where id=h.id_malla) as malla from rel_lms_malla_curso  h where h.id_programa='" . $id_programa . "' and h.id_empresa='" . $id_empresa . "' and h.id_malla<>'' group by h.id_malla";
//echo $sql; echo "<br>";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function BuscaClasificacionPrograma($id_programa, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.id_clasificacion, (select clasificacion from tbl_lms_clasificacion where id_clasificacion=h.id_clasificacion) as clasificacion from rel_lms_malla_curso h where h.id_programa='" . $id_programa . "' and h.id_empresa='" . $id_empresa . "' and h.id_clasificacion<>'' group by h.id_clasificacion";
//echo $sql; echo "<br>";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function BuscaCursoDadoIdObjeto($id_objeto, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select id_curso from tbl_objeto where id='$id_objeto' and id_empresa='$id_empresa' limit 1";
//echo $sql; echo "<br>";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function BuscaCursoPrograma($id_programa, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.id_curso, (select nombre  from tbl_lms_curso where id=h.id_curso) as curso from rel_lms_malla_curso  h where h.id_programa='" . $id_programa . "' and h.id_empresa='" . $id_empresa . "' and h.id_curso<>'' group by h.id_curso";
//echo $sql; echo "<br>";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function VerSiExisteMalla($id_malla_sugerido) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select id from tbl_lms_malla where id='$id_malla_sugerido'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
$cuenta = count($cod);
return $cuenta;
}

function BuscaObjetosDadoIdCurso($id_curso) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_objeto  where id_curso='" . $id_curso . "' order by orden ASC";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function EVALUACION_ActualizoORdenPreguntas($orden, $id_evaluacion) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "update tbl_evaluaciones_preguntas set orden=orden-1 where orden>$orden and evaluacion='$id_evaluacion'";

$database->setquery($sql);
$database->query();
}

function EVALUACION_EliminaPreguntasAlternativas($id_pregunta, $id_grupo_alternativas) {
global $c_host, $c_user, $c_pass, $c_db;

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "delete from tbl_evaluaciones_preguntas      where id='$id_pregunta'     ";
$database->setquery($sql);
$database->query();

$sql = "delete from tbl_evaluaciones_alternativas      where id_grupo_alternativas='$id_grupo_alternativas'    ";
$database->setquery($sql);
$database->query();
}

function EVALUACION_DatosPregunta($id_pregunta) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_evaluaciones_preguntas where id='$id_pregunta'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function EvaluacionesInsertaAlternativas($id_grupo_alternativas, $alternativa, $puntaje, $correcta, $orden) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "INSERT INTO tbl_evaluaciones_alternativas (id_grupo_alternativas, alternativa, puntaje, correcta, orden) " .
"VALUES ('$id_grupo_alternativas', '$alternativa', '$puntaje', '$correcta', '$orden');";

//echo $sql;
//sleep(2);

$database->setquery($sql);
$database->query();
}

function EvaluacionesInsertaPregunta($pregunta, $tipo, $evaluacion, $orden, $id_grupo_alternativas, $imagen) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
if ($id_grupo_alternativas == "") {
$sql = "INSERT INTO tbl_evaluaciones_preguntas (pregunta, tipo, evaluacion, orden, id_grupo_alternativas, url_archivo) " .
"VALUES ('$pregunta', '$tipo', '$evaluacion', '$orden', null, '$imagen');";
} else {
$sql = "INSERT INTO tbl_evaluaciones_preguntas (pregunta, tipo, evaluacion, orden, id_grupo_alternativas, url_archivo) " .
"VALUES ('$pregunta', '$tipo', '$evaluacion', '$orden', '$id_grupo_alternativas', '$imagen');";
}

$database->setquery($sql);
$database->query();
}

function EvaluacionesInsertaPreguntaMedicion($pregunta, $tipo, $evaluacion, $orden, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO tbl_enc_elearning_preg (id_encuesta,id_pregunta,pregunta,id_empresa,tipo) " .
"VALUES ('$evaluacion', '$orden', '$pregunta', '$id_empresa','$tipo');";

$database->setquery($sql);
$database->query();
}
function     EvaluacionesInsertaPreguntaEncuestaLB($id_encuesta,$id_pregunta,$pregunta,$id_empresa,
$tipo,$alt1,$alt2,$alt3,$alt4,$alt5,$alt6,$alt7,$alt8,$alt9,$alt10,
$alt11,$alt12,$alt13,$alt14,$alt15,$alt16,$alt17,$alt18,$alt19,$alt20,
$niv1,$niv2,$linkpregunta,$linkopcion, $orde_de_pregunta, $id_seccion, $Obligatoria) {
/* echo "$id_encuesta,$id_pregunta,$pregunta,$id_empresa,
$tipo,$alt1,$alt2,$alt3,$alt4,$alt5,$alt6,$alt7,$alt8,$alt9,$alt10,
$alt11,$alt12,$alt13,$alt14,$alt15,$alt16,$alt17,$alt18,$alt19,$alt20,
$niv1,$niv2,$linkpregunta,$linkopcion, $orde_de_pregunta";    */
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
if($niv1<>''){$alt1=$niv1;}
if($niv2<>''){$alt2=$niv2;}
if($obligatoria=="")
$sql = "INSERT INTO tbl_enc_elearning_preg (id_encuesta,
id_pregunta,pregunta,id_empresa,tipo,dimension,alt1,alt2,alt3,
alt4,alt5,alt6,alt7,alt8,alt9,alt10,
dimension_descripcion,descripcion_pregunta,
alt11,alt12,alt13,alt14,alt15,alt16,alt17,alt18,alt19,alt20,
linkpregunta,linkopcion, id_seccion, obligatoria) " .
"VALUES (
'$id_encuesta',
'$orde_de_pregunta','$pregunta','$id_empresa','$tipo','$dimension','$alt1','$alt2','$alt3',
'$alt4','$alt5','$alt6','$alt7','$alt8','$alt9','$alt10',
'$dimension_descripcion','$descripcion_pregunta',
'$alt11','$alt12','$alt13','$alt14','$alt15','$alt16','$alt17','$alt18','$alt19','$alt20',
'$linkpregunta','$linkopcion','$id_seccion','$Obligatoria');";
//echo $sql;
// exit();
$database->setquery($sql);
$database->query();
}
function     EvaluacionesInsertaSeccionEncuestaLB($nombre, $descripcion, $id_empresa,
$id_encuesta, $id_seccion, $bajada_subtitulo, $bajada_texto, $imagensuperior, $imageninferior, $imagenlogo) {
/* echo "$id_encuesta,$id_pregunta,$pregunta,$id_empresa,
$tipo,$alt1,$alt2,$alt3,$alt4,$alt5,$alt6,$alt7,$alt8,$alt9,$alt10,
$alt11,$alt12,$alt13,$alt14,$alt15,$alt16,$alt17,$alt18,$alt19,$alt20,
$niv1,$niv2,$linkpregunta,$linkopcion, $orde_de_pregunta";    */
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
if($niv1<>''){$alt1=$niv1;}
if($niv2<>''){$alt2=$niv2;}
$sql = "INSERT INTO tbl_enc_elearning_seccion (nombre, descripcion, id_empresa,
id_encuesta, id_seccion, bajada_subtitulo, bajada_texto, imagensuperior, imageninferior, imagenlogo) " .
"VALUES (
'$nombre', '$descripcion', '$id_empresa',
'$id_encuesta', '$id_seccion', '$bajada_subtitulo', '$bajada_texto', '$imagensuperior', '$imageninferior', '$imagenlogo');";
//echo $sql;
//exit();
$database->setquery($sql);
$database->query();
}
function     EvaluacionesActualizaSeccionEncuestaLB($nombre, $descripcion, $id_empresa,
$id_encuesta, $id_seccion, $bajada_subtitulo, $bajada_texto, $imagensuperior, $imageninferior, $imagenlogo) {
/* echo "$id_encuesta,$id_pregunta,$pregunta,$id_empresa,
$tipo,$alt1,$alt2,$alt3,$alt4,$alt5,$alt6,$alt7,$alt8,$alt9,$alt10,
$alt11,$alt12,$alt13,$alt14,$alt15,$alt16,$alt17,$alt18,$alt19,$alt20,
$niv1,$niv2,$linkpregunta,$linkopcion, $orde_de_pregunta";    */
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
if($niv1<>''){$alt1=$niv1;}
if($niv2<>''){$alt2=$niv2;}
$sql = "UPDATE tbl_enc_elearning_seccion SET  nombre='$nombre', descripcion='$descripcion'
where
id_seccion='$id_seccion' and id_encuesta='$id_encuesta'
;";
// echo $sql;
// exit();
$database->setquery($sql);
$database->query();
}
function     EvaluacionesActualizaPreguntaEncuestaLB($id_encuesta,$id_pregunta,$pregunta,$id_empresa,
$tipo,$alt1,$alt2,$alt3,$alt4,$alt5,$alt6,$alt7,$alt8,$alt9,$alt10,
$alt11,$alt12,$alt13,$alt14,$alt15,$alt16,$alt17,$alt18,$alt19,$alt20,
$niv1,$niv2,$linkpregunta,$linkopcion, $orde_de_pregunta, $id_seccion, $obligatoria) {
/* echo "$id_encuesta,$id_pregunta,$pregunta,$id_empresa,
$tipo,$alt1,$alt2,$alt3,$alt4,$alt5,$alt6,$alt7,$alt8,$alt9,$alt10,
$alt11,$alt12,$alt13,$alt14,$alt15,$alt16,$alt17,$alt18,$alt19,$alt20,
$niv1,$niv2,$linkpregunta,$linkopcion, $orde_de_pregunta";    */
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
if($niv1<>''){$alt1=$niv1;}
if($niv2<>''){$alt2=$niv2;}
$sql = "UPDATE tbl_enc_elearning_preg

SET  pregunta='$pregunta',  tipo='$tipo',

alt1='$alt1',alt2='$alt2',alt3='$alt3',
alt4='$alt4',alt5='$alt5',alt6='$alt6',alt7='$alt7',alt8='$alt8',alt9='$alt9',alt10='$alt10',

alt11='$alt11',alt12='$alt12',alt13='$alt13',alt14='$alt14',alt15='$alt15',alt16='$alt16',alt17='$alt17',alt18='$alt18',
alt19='$alt19',alt20='$alt20',
linkpregunta='$linkpregunta',linkopcion='$linkopcion' , obligatoria='$obligatoria'

WHERE id_encuesta='$id_encuesta' and id_pregunta='$id_pregunta'     ";



// echo $sql;
// exit();
$database->setquery($sql);
$database->query();
}

function TRaigoTotalPReguntasPorEval($id_evaluacion) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_evaluaciones_preguntas where evaluacion='" . $id_evaluacion . "'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}
function Enc_Actualiza_Seccion_SINO_SECCION($SECCION_NO , $id_encuesta,$id_empresa){


global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "SELECT * FROM tbl_enc_elearning_preg WHERE id_encuesta = '$id_encuesta' AND tipo = 'SI_NO_BOTON' and id_empresa='$id_empresa'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

// print_r($cod);
$id_pregunta= $cod[0]->id_pregunta;

$sql = "UPDATE tbl_enc_elearning_preg SET linkpregunta='".$cod[0]->id_pregunta."', linkopcion='$SECCION_NO' WHERE id_encuesta = '$id_encuesta' and id_seccion='$SECCION_NO' and id_empresa='$id_empresa'";

// echo "<br>sql $sql";  exit();
$database->setquery($sql);
$database->query();


//echo "$SECCION_NO, $id_encuesta,$id_empresa"; exit();
return $cod;

}
function TraigoTotalPreguntasMedicionPorEval($id_evaluacion) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_enc_elearning_preg where id_encuesta='" . $id_evaluacion . "'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}
function BuscaSeccionEncEval($idEval, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$id_empresa = $_SESSION["id_empresa"];
$sql = "select * from tbl_enc_elearning_seccion where id_encuesta='" . $idEval . "' and id_empresa='$id_empresa'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}
function TraigoTotalPreguntasMedicionPorEvalCuenta($id_evaluacion) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select count(id) as cuenta from tbl_enc_elearning_preg where id_encuesta='" . $id_evaluacion . "'";
$database->setquery($sql);
$database->query();
//    echo $sql;
$cod = $database->listObjects();
return $cod[0]->cuenta;
}

function TraigoTotalSeccionesMedicionPorEval($id_evaluacion) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select count(id) as cuenta from tbl_enc_elearning_seccion where id_encuesta='" . $id_evaluacion . "'";
//    echo $sql;exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod[0]->cuenta;
}

function TraigoMAximoIdGrupoAlternativas() {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select max(id_grupo_alternativas) as numero_maximo from tbl_evaluaciones_preguntas
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function UpdateEvaluacionObjeto($id_objeto, $id_empresa, $id_evaluacion) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "update tbl_objeto set id_evaluacion='$id_evaluacion'
where id='$id_objeto' and id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
}

function BuscaEvaluaciones($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_evaluaciones where id_empresa='$id_empresa' order by id DESC";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function check_usuario_envio_emails($rut, $tipo, $dato) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select count(id) as cuenta from tbl_log_emails where rut='$rut' and tipo='$tipo' and dato='$dato'";
//echo "<br><br><br><br>$sql";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function traeCursosPorEvaluaciones($id_empresa, $id_evaluacion) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select h.id_curso, (select nombre from tbl_lms_curso where id=h.id_curso) as nombre  from tbl_objeto h
where h.id_evaluacion='$id_evaluacion' and h.id_empresa='$id_empresa'

";
//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ENCSat_CuentaDeRespuestasPorDimension($id_empresa, $id_inscripcion, $id_dimension) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "    select h.*,
round(avg(h.nota),1) as Datonota,
round(avg(h.porcentaje)) as Datoporcentaje,
(select dimension from tbl_enc_satis_dim where iddimension=h.id_dimension and id_empresa='$id_empresa') as Dimension
from tbl_enc_sat_resultados h
where h.id_dimension='$id_dimension' and h.id_inscripcion='$id_inscripcion' and h.id_empresa='$id_empresa'
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ENCSat_CuentaParticipantesPorEncuesta($id_empresa, $id_inscripcion) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT * FROM `tbl_enc_satis_respuestas` WHERE  id_inscripcion = '$id_inscripcion'  and id_empresa='$id_empresa' group by rut";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

//echo "<br>ENC_CuentaParticipantesPorEncuesta $sql";

return $cod;
}

function ENCSat_CuentaParticipantesPorEncuestaRut($id_empresa, $id_inscripcion) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "


SELECT h.*,

(select rut_completo from tbl_usuario where rut=h.rut) as rut_completo,
(select nombre_completo from tbl_usuario where rut=h.rut) as nombre_completo,
(select cargo from tbl_usuario where rut=h.rut) as cargo,
(select gerencia from tbl_usuario where rut=h.rut) as gerencia,
(select nombre from tbl_relatores where rut=h.rut_relator) as relator,
(select iddimension from  tbl_enc_satis_preg where idpregunta=h.id_pregunta ) as id_dimension,
(select pregunta from  tbl_enc_satis_preg where idpregunta=h.id_pregunta) as pregunta,
(select dimension from  tbl_enc_satis_dim where iddimension=(select iddimension from  tbl_enc_satis_preg where idpregunta=h.id_pregunta)   limit 1) as dimension


FROM `tbl_enc_satis_respuestas` h WHERE h.id_inscripcion = '$id_inscripcion' and h.id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

//echo "<br>ENC_CuentaParticipantesPorEncuesta $sql";

return $cod;
}

function Preg_lista_usuarios_data($id_empresa, $id_objeto) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
SELECT h.* FROM `tbl_usuario` h WHERE h.id_empresa = '$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//echo "<br>ENC_CuentaParticipantesPorEncuesta $sql";

return $cod;
}

function Preg_datos_detalle_preguntas($id_empresa, $id_objeto) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

SELECT

h.*,

(select id_evaluacion from tbl_objeto where id='be_preguntados_m1'),
(select count(id) from tbl_evaluaciones_respuestas_intentos where  id_pregunta=h.id) as Respondida,
(select count(id) from tbl_evaluaciones_respuestas_intentos where  id_pregunta=h.id and correcta='1') as Correcta,
round(100*(select count(id) from tbl_evaluaciones_respuestas_intentos where  id_pregunta=h.id and correcta='1')/(select count(id) from tbl_evaluaciones_respuestas_intentos where  id_pregunta=h.id)) as Porcentaje


FROM

tbl_evaluaciones_preguntas h

where evaluacion=(select id_evaluacion from tbl_objeto where id='$id_objeto')
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

//echo "<br>ENC_CuentaParticipantesPorEncuesta $sql";

return $cod;
}

function Preg_datos_Detalle_usuario($id_empresa, $id_objeto, $rut) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT
tbl_evaluaciones_respuestas_intentos.rut,
sum(
tbl_evaluaciones_respuestas_intentos.correcta
) AS suma_correctas,
nombre_completo,
(select rut_completo from tbl_usuario where rut=tbl_evaluaciones_respuestas_intentos.rut) as rut_completo,

(
SELECT            count(*) AS total        FROM            tbl_preguntados_ganadores        WHERE            tbl_preguntados_ganadores.rut = tbl_evaluaciones_respuestas_intentos.rut    ) AS total_veces_ganado,
(SELECT  COUNT(DISTINCT(id_desafio_preguntados))  FROM `tbl_evaluaciones_respuestas_intentos` WHERE `rut` = '$rut') AS vecesjugado,

(select sum(tiempo) as total_tiempo from tbl_preguntados_ganadores WHERE            tbl_preguntados_ganadores.rut = tbl_evaluaciones_respuestas_intentos.rut    ) as total_segundos
FROM
tbl_evaluaciones_respuestas_intentos
INNER JOIN tbl_usuario ON tbl_usuario.rut = tbl_evaluaciones_respuestas_intentos.rut
WHERE
tbl_evaluaciones_respuestas_intentos.id_objeto = '$id_objeto'
AND tbl_evaluaciones_respuestas_intentos.id_empresa = '$id_empresa'
AND tbl_evaluaciones_respuestas_intentos.rut = '$rut'

GROUP BY
tbl_evaluaciones_respuestas_intentos.rut
ORDER BY
(
SELECT
count(*) AS total
FROM
tbl_preguntados_ganadores
WHERE
tbl_preguntados_ganadores.rut = tbl_evaluaciones_respuestas_intentos.rut
) DESC,
suma_correctas DESC, (select sum(tiempo) as total_tiempo from tbl_preguntados_ganadores WHERE
tbl_preguntados_ganadores.rut = tbl_evaluaciones_respuestas_intentos.rut    ) asc";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

//echo "<br>Preg_datos_Detalle_usuario $sql";

return $cod;
}

function ENCSat_LiteralesPorEncuestaRut($id_empresa, $id_inscripcion) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "


SELECT h.*,

(select rut_completo from tbl_usuario where rut=h.rut) as rut_completo,
(select nombre_completo from tbl_usuario where rut=h.rut) as nombre_completo,
(select cargo from tbl_usuario where rut=h.rut) as cargo,
(select gerencia from tbl_usuario where rut=h.rut) as gerencia,
(select nombre from tbl_relatores where rut=h.rut_relator) as relator,
(select iddimension from  tbl_enc_satis_preg where idpregunta=h.id_pregunta ) as id_dimension,
(select pregunta from  tbl_enc_satis_preg where idpregunta=h.id_pregunta) as pregunta,
(select dimension from  tbl_enc_satis_dim where iddimension=(select iddimension from  tbl_enc_satis_preg where idpregunta=h.id_pregunta)   limit 1) as dimension


FROM `tbl_enc_satis_respuestas` h WHERE h.id_inscripcion = '$id_inscripcion' and h.id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

//echo "<br>ENC_CuentaParticipantesPorEncuesta $sql";

return $cod;
}

function ENCSat_TraigoDimensionesPorEncuesta($id_empresa, $id_encuesta) {

//echo "<br>$id_empresa, $id_encuesta";
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_enc_satis_dim where empresa='$id_encuesta' and id_empresa='$id_empresa'";
//echo "<br>ENCSat_TraigoDimensionesPorEncuesta ".$sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function BuscadatosEncuestaSat($id_empresa, $id_inscripcion) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.*,
(select COUNT(DISTINCT rut) from tbl_enc_satis_respuestas where id_inscripcion='$id_inscripcion'
and id_empresa='$id_empresa') as respuestas
from tbl_enc_satis_respuestas h
where h.id_inscripcion='$id_inscripcion'
and h.id_empresa='$id_empresa' limit 1";

//echo "<br>BuscadatosEncuestaSat ";echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function BuscaDataCampoGeneral($clima_campo_general, $id_indicador, $id_empresa) {

if ($id_indicador == '') {$id_indicador = "i1";}
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.* from tbl_dash_data h  where h.id_empresa='$id_empresa' and
h.campo='$clima_campo_general' and
h.id_indicador='$id_indicador'";

//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//print_r($cod); exit();
return $cod;
}

function BuscaDataCampoPorDimension($clima_campo_general, $id_indicador, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select h.* from tbl_dash_data h where h.id_empresa='$id_empresa' and h.campo='$clima_campo_general' and h.id_dimension<>'d0' and h.id_dimension is not null order by h.positivo DESC";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeClimaCamposGenerales($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.* from tbl_dash_data h  where id_empresa='$id_empresa' group by h.campo order by h.nombre_campo";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TraeClimaIndicadoresGenerales($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.* from tbl_dash_data h  where id_empresa='$id_empresa' group by h.id_indicador order by h.indicador";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TieneComentariosEscuelaBpCHECK($dia, $colaborador) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_escuela_bp_comentarios_finales where  dia='$dia' and rut_colaborador='$colaborador' ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TieneCheckPorDiaColaboradorActividad($dia, $colaborador, $actividad) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_escuela_bp_check_list_respuesta where  dia='$dia' and rut_colaborador='$colaborador' and id_actividad='$actividad'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraigoUsuariosEscuelaBP() {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT     rel_lms_malla_persona.rut, tbl_usuario.nombre_completo, tbl_usuario.cargo, tbl_usuario.lider, tabla_lider.nombre_completo as nombre_lider

FROM
rel_lms_malla_persona

inner join tbl_usuario

on tbl_usuario.rut=rel_lms_malla_persona.rut

inner join tbl_usuario as tabla_lider
on tabla_lider.rut=tbl_usuario.lider

WHERE
id_malla LIKE '%bci_escbp%'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraigoActividadesPorDiaEscuelaBP($dia) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_escuela_bp_dia_actividad where  dia='$dia'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraifoDiasEscualeBP() {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_escuela_bp_dia";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function buscaModificacionclave($rut) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_clave where rut='$rut'";


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function resetea_clave2017($rut) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$clave = substr($rut, 0, 4);

$sql = "update tbl_clave set clave='$clave', cambiado=0, fecha_cambio='" . date("Y-m-d") . "' where rut='$rut'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function resetea_clave_2021_cambiado1($rut, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql_insert = "INSERT INTO tbl_clave
(rut, id_empresa) 
VALUES ('$rut','$id_empresa');";
$database->setquery($sql_insert);
$database->query();		

$clave = substr($rut, 0, 4);
$sql = "update tbl_clave set clave_encodeada='$clave', cambiado=1, fecha_cambio='" . date("Y-m-d") . "' where rut='$rut'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}



function VistaCursosHistoricosCertificadosData($rut, $post, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.id_inscripcion, h.id_curso,

(select fecha_inicio from tbl_inscripcion_curso where codigo_inscripcion= h.id_inscripcion limit 1) as fecha_inicio,
(select fecha_termino from tbl_inscripcion_curso where codigo_inscripcion= h.id_inscripcion limit 1) as fecha_termino,
(select ejecutivo from tbl_inscripcion_curso where codigo_inscripcion= h.id_inscripcion limit 1) as ejecutivo,
(select modalidad from tbl_lms_curso where id= h.id_curso limit 1) as modalidad,
(select estado_descripcion from tbl_inscripcion_cierre where id_inscripcion= h.id_inscripcion and rut=h.rut limit 1) as estado,
(select nota from tbl_inscripcion_cierre where id_inscripcion= h.id_inscripcion and rut=h.rut limit 1) as nota,
(select avance from tbl_inscripcion_cierre where id_inscripcion= h.id_inscripcion and rut=h.rut limit 1) as avance,

(select estado_descripcion from tbl_inscripcion_cierre where id_curso= h.id_curso and rut=h.rut limit 1) as estado2,
(select nota from tbl_inscripcion_cierre where id_curso= h.id_curso and rut=h.rut limit 1) as nota2,
(select avance from tbl_inscripcion_cierre where id_curso= h.id_curso and rut=h.rut limit 1) as avance2,



(select nombre from tbl_lms_curso where id= h.id_curso limit 1) as curso

from tbl_inscripcion_usuarios h where h.rut='$rut' and h.id_empresa='$id_empresa'

order by (select fecha_termino from tbl_inscripcion_curso where codigo_inscripcion= h.id_inscripcion) DESC";
// echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return ($cod);
}

function buscaclave($rut) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select clave from tbl_clave where rut='$rut'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function buscanombre($rut) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select nombre_completo from tbl_usuario where rut='$rut'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function CreaIdEvaluacionNueva($id_evaluacion, $id_curso, $id_objeto, $nombre_objeto, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$nombre_objeto = utf8_decode($nombre_objeto);
$sql = "select id from tbl_evaluaciones where id='$id_evaluacion'";
$database->setquery($sql);
$database->query();
$cod2 = $database->listObjects();

if ($cod2[0]->id == '') {
$sql = "
INSERT INTO tbl_evaluaciones (id, nombre_evaluacion, id_empresa, id_curso, id_objeto
)

VALUES (
'$id_evaluacion','$nombre_objeto','$id_empresa','$id_curso','$id_objeto'
)


";
//echo "<br>$sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
}

return $cod;
}

function CreaNuevoObjeto($id_objeto, $nombre_objeto, $objeto_descripcion, $tipo_objeto, $extension_objeto,
$objeto_url, $objeto_duracion, $objeto_orden, $objeto_numpreguntas, $objeto_aprobacion, $id_curso, $id_evaluacion, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$nombre_objeto = utf8_decode($nombre_objeto);
$objeto_descripcion = utf8_decode($objeto_descripcion);

$sql = "select id from tbl_objeto where id='$id_objeto'";
$database->setquery($sql);
$database->query();
$cod2 = $database->listObjects();

if ($cod2[0]->id == '') {
$sql = "
INSERT INTO tbl_objeto (id, titulo, descripcion,tipo_objeto,extension_objeto,

archivo,url_objeto,url,
preguntas_aleatorias,orden,duracion_video,
nota_aprobacion,id_evaluacion,
id_curso,
id_empresa, gamificado, puntos, medallas

)

VALUES (
'$id_objeto','$nombre_objeto','$objeto_descripcion','$tipo_objeto','$extension_objeto',
'$objeto_url','$objeto_url','$objeto_url',
'$objeto_numpreguntas','$objeto_orden','$objeto_duracion',

'$objeto_aprobacion','$id_evaluacion',
'$id_curso', '$id_empresa','1','1','0'
)


";
//echo "<br>$sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
}

return $cod;
}

function CreaNuevoObjetoEvaluacionSinEvaluacion($id_objeto, $nombre_objeto, $objeto_descripcion, $tipo_objeto, $extension_objeto, $objeto_url, $objeto_duracion, $objeto_orden, $objeto_numpreguntas, $objeto_aprobacion, $id_curso, $objeto_permitir_ver_nota, $objeto_recalcular_notas, $objeto_distribucion_opciones, $objeto_duracion_evaluacion_total, $objeto_permitir_ver_nota, $id_empresa, $titulo_cierre, $texto_cierre, $objeto_intentos, $fecha_inicio, $hora_inicio, $fecha_termino, $hora_termino) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$objeto_valido = 0;
if (strpos($objeto_url, '.mp4') !== false) {
$objeto_valido = 1;} elseif (strpos($objeto_url, '.pdf') !== false) {
$objeto_valido = 1;} elseif (strpos($objeto_url, '.zip') !== false) {
$objeto_valido = 1;} elseif (strpos($objeto_url, '.ZIP') !== false) {
$objeto_valido = 1;} elseif (strpos($objeto_url, '.MP4') !== false) {
$objeto_valido = 1;} elseif (strpos($objeto_url, '.PDF') !== false) {
$objeto_valido = 1;} elseif (strpos($objeto_url, '.html') !== false) {
$objeto_valido = 1;}

if ($objeto_valido == 1) {
$objeto_url = $objeto_url;
} else {
$objeto_url = "";
}

if ($fecha_inicio == "") {$fecha_inicio = 'NULL';} else { $fecha_inicio = "'" . $fecha_inicio . "'";}
if ($hora_inicio == "") {$hora_inicio = 'NULL';} else { $hora_inicio = "'" . $hora_inicio . "'";}
if ($fecha_termino == "") {$fecha_termino = 'NULL';} else { $fecha_termino = "'" . $fecha_termino . "'";}
if ($hora_termino == "") {$hora_termino = 'NULL';} else { $hora_termino = "'" . $hora_termino . "'";}

//echo "$fecha_inicio,$hora_inicio,$fecha_termino,$hora_termino";

$nombre_objeto = utf8_decode($nombre_objeto);
$objeto_descripcion = utf8_decode($objeto_descripcion);
$titulo_cierre = utf8_decode($titulo_cierre);
$texto_cierre = utf8_decode($texto_cierre);

$sql = "select id from tbl_objeto where id='$id_objeto'";
$database->setquery($sql);
$database->query();
$cod2 = $database->listObjects();

if ($cod2[0]->id == '') {
$sql = "
INSERT INTO tbl_objeto
(id, titulo, descripcion,tipo_objeto,
extension_objeto,
archivo,url_objeto,url,
preguntas_aleatorias,orden,duracion_video,
nota_aprobacion,id_curso,
currentorg,
idmoodle,
urlmoodle,
linkabrir,
id_empresa, gamificado, puntos, medallas, titulo_principal, bajada_principal,intentos_trivia,
fecha_inicio, hora_inicio,fecha_termino,hora_termino)

VALUES (
'$id_objeto','$nombre_objeto','$objeto_descripcion','$tipo_objeto','$extension_objeto',
'$objeto_url','$objeto_url','$objeto_url',
'$objeto_numpreguntas','$objeto_orden','$objeto_duracion',
'$objeto_aprobacion','$id_curso',
'$objeto_duracion_evaluacion_total',
'$objeto_recalcular_notas',
'$objeto_distribucion_opciones',
'$objeto_permitir_ver_nota',
'$id_empresa','1','1','1','$titulo_cierre','$texto_cierre','$objeto_intentos',
$fecha_inicio,$hora_inicio,$fecha_termino,$hora_termino)

";

//echo $sql; sleep(10);

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
}

return $cod;
}

function BuscaSiguienteObjeto($id_curso) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.*,

(select max(orden) from tbl_objeto where id_curso=h.id_curso) as MaxOrden


from tbl_objeto h where h.id_curso='$id_curso'
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function BuscaSiguienteEvaluacion() {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select max(id)  as MaxEval from tbl_evaluaciones
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function BuscaUsuariosRespondieronEval($id_objeto, $arreglo) {global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($arreglo == 1) {
foreach ($id_objeto as $unico) {
$cuentaj++;
$queryObj .= " h.id_objeto='" . $unico . "' ";
if ($cuentaj < count($id_objeto)) {
$queryObj .= " or ";
}
}
} else {

$queryObj .= " h.id_objeto='" . $id_objeto . "' ";
}

$sql = "select h.*,

(select rut_completo from tbl_usuario where rut=h.rut) as rut_completo,
(select nombre_completo from tbl_usuario where rut=h.rut) as nombre_completo,
(select cargo from tbl_usuario where rut=h.rut) as cargo,
(select gerencia from tbl_usuario where rut=h.rut) as gerencia,
(select gerenciaR2 from tbl_usuario where rut=h.rut) as gerenciaR2,
(select gerenciaR3 from tbl_usuario where rut=h.rut) as gerenciaR3,
(select email from tbl_usuario where rut=h.rut) as email,
(select nota from tbl_objetos_finalizados where id_objeto=h.id_objeto and rut=h.rut and nota<>''  order by fecha DESC limit 1) as nota,
(select nota_aprobacion from tbl_objeto where id=h.id_objeto limit 1) as nota_aprobacion

from tbl_evaluaciones_respuestas h

where $queryObj

group by h.rut

order by h.fecha, h.hora, h.rut";
//echo $sql; exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function BuscaFechasdadaMedicion($idMed) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.* from tbl_enc_elearning_medicion h where h.id='$idMed'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

if ($cod[0]->fecha1 != '') {$Array[0] = $cod[0]->fecha1;}
if ($cod[0]->fecha2 != '') {$Array[1] = $cod[0]->fecha2;}
if ($cod[0]->fecha3 != '') {$Array[2] = $cod[0]->fecha3;}

//print_r($Array); exit();

return $Array;
}

function BuscaUsuariosRespondieronMed($idMed) {global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.*,
(select rut_completo from tbl_usuario where rut=h.rut) as rut_completo,
(select nombre_completo from tbl_usuario where rut=h.rut) as nombre_completo,
(select cargo from tbl_usuario where rut=h.rut) as cargo,
(select gerencia from tbl_usuario where rut=h.rut) as gerencia,
(select gerenciaR2 from tbl_usuario where rut=h.rut) as gerenciaR2,
(select gerenciaR3 from tbl_usuario where rut=h.rut) as gerenciaR3,
(select email from tbl_usuario where rut=h.rut) as email,
(select rut_completo from tbl_usuario where rut=h.jefe) as Jrut_completo,
(select nombre_completo from tbl_usuario where rut=h.jefe) as Jnombre_completo,
(select cargo from tbl_usuario where rut=h.jefe) as Jcargo,
(select gerencia from tbl_usuario where rut=h.jefe) as Jgerencia,
(select gerenciaR2 from tbl_usuario where rut=h.jefe) as JgerenciaR2,
(select gerenciaR3 from tbl_usuario where rut=h.jefe) as JgerenciaR3,
(select email from tbl_usuario where rut=h.jefe) as Jemail,
(select fecha from tbl_enc_elearning_respuestas where id_medicion='$idMed' and rut=h.rut  limit 1) as fecharespuesta,
(select comentario from tbl_enc_elearning_respuestas where id_medicion='$idMed' and rut=h.rut  limit 1) as comentario

from tbl_enc_elearning_usuarios h where h.id_medicion='$idMed'

order by h.fecha_carga DESC
";
//and fecha<>'0000-00-00'
//and fecha<>'0000-00-00'
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function BuscaUsuariosRespondieronMedSinUsuario($idMed) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT h.*,
(select fecha_carga from tbl_enc_elearning_usuarios where rut=h.rut and id_medicion=h.id_medicion LIMIT 1) as fecha_carga,
(select grupo from tbl_enc_elearning_usuarios where rut=h.rut and id_medicion=h.id_medicion  LIMIT 1) as grupo



FROM tbl_enc_elearning_respuestas h WHERE h.id_medicion= '$idMed' group by h.rut";

//  echo $sql;  EXIT();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function BuscaUsuariosRespondieronEvalSinRespuestas($id_objeto, $arreglo) {global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($arreglo == 1) {
foreach ($id_objeto as $unico) {
$cuentaj++;
$queryObj .= " id_objeto='" . $unico . "' ";
$queryObj_ .= " id_objeto='" . $unico . "' ";
if ($cuentaj < count($id_objeto)) {
$queryObj .= " or ";
$queryObj_ .= " or ";
}
}
} else {

$queryObj .= " id_objeto='" . $id_objeto . "' ";
$queryObj_ .= " id='" . $id_objeto . "' ";
}

$sql = "

select h.*,

(select rut_completo from tbl_usuario where rut=h.rut) as rut_completo,
(select nombre_completo from tbl_usuario where rut=h.rut) as nombre_completo,
(select cargo from tbl_usuario where rut=h.rut) as cargo,
(select gerencia from tbl_usuario where rut=h.rut) as gerencia,
(select gerenciaR2 from tbl_usuario where rut=h.rut) as gerenciaR2,
(select gerenciaR3 from tbl_usuario where rut=h.rut) as gerenciaR3,
(select email from tbl_usuario where rut=h.rut) as email,
''  as nota,
''  as nota_aprobacion

from tbl_inscripcion_usuarios h where h.id_curso=(select id_curso from tbl_objeto where $queryObj_)
and (select count(id) from tbl_evaluaciones_respuestas where $queryObj and rut=h.rut)='0'

order by h.fecha, h.hora, h.rut";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function BuscaObjetosEval_IDeEval($id_eval) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.*

from tbl_objeto h

where h.id_evaluacion='$id_eval'

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function BuscaRespuestasUsuarioObjetoIdPregunta($rut, $id_pregunta, $id_objeto, $arreglo) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($arreglo == 1) {
$queryObj .= " and ( ";
foreach ($id_objeto as $unico) {
$cuentaj++;
$queryObj .= " h.id_objeto='" . $unico . "'";
if ($cuentaj < count($id_objeto)) {
$queryObj .= " or ";
}
}

$queryObj .= " ) ";
} else {

$queryObj .= " and h.id_objeto='" . $id_objeto . "' ";
}

$sql = "
SELECT h.*,

(select orden from tbl_evaluaciones_alternativas where id=h.id_alternativa) as orden,
(select alternativa from tbl_evaluaciones_alternativas where id=h.id_alternativa) as alternativa


FROM tbl_evaluaciones_respuestas h

WHERE

h.rut = '$rut' and h.id_pregunta='$id_pregunta' $queryObj ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function BuscaRespuestasUsuarioMed($rut, $id_pregunta, $idMed) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = " select h.* from tbl_enc_elearning_respuestas h where h.rut_colaborador='$rut' and h.id_pregunta='$id_pregunta' and h.id_medicion='$idMed'";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//print_r($cod);
return $cod;
}

function BuscaRespuestasUsuarioMedFecha($rut, $id_pregunta, $idMed, $fecha) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = " select h.* from tbl_enc_elearning_respuestas h where h.rut_colaborador='$rut' and h.id_pregunta='$id_pregunta'
and h.id_medicion='$idMed' and h.id_tipo='$fecha'";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//print_r($cod);
return $cod;
}

function BuscaRespuestasUsuarioMedSinFecha($rut, $id_pregunta, $idMed) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = " SELECT
h.*
FROM
tbl_enc_elearning_respuestas h
WHERE
h.rut_colaborador = '$rut'
AND h.id_pregunta = '$id_pregunta'
AND h.id_medicion = '$idMed'

ORDER BY
h.respuesta DESC

LIMIT 1";     //echo $sql; exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//print_r($cod);
return $cod;
}
function BuscaRespuestasUsuarioMedSinFechaRUT($rut, $id_pregunta, $idMed) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = " SELECT
h.*
FROM
tbl_enc_elearning_respuestas h
WHERE
h.rut = '$rut'
AND h.id_pregunta = '$id_pregunta'
AND h.id_medicion = '$idMed'

ORDER BY
h.respuesta DESC

LIMIT 1";     //echo $sql; exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//print_r($cod);
return $cod;
}

function BuscaPreguntaDadaEvaluacion($idEval) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT h.*,
(select orden from tbl_evaluaciones_alternativas where id_grupo_alternativas=h.id_grupo_alternativas and correcta=1 limit 1) correcta,
(select alternativa from tbl_evaluaciones_alternativas where id_grupo_alternativas=h.id_grupo_alternativas and correcta=1 limit 1) Altcorrecta


FROM tbl_evaluaciones_preguntas h  WHERE h.evaluacion = '$idEval' ";
//echo $sql;exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function BuscaPreguntaDadaMedicion($idMed) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "Select h.*, (select id_encuesta from tbl_enc_elearning_medicion where id='$idMed' limit 1)

from tbl_enc_elearning_preg h

where h.id_encuesta=(select id_encuesta from tbl_enc_elearning_medicion where id='$idMed' limit 1)";
//   echo $sql;exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function LMS_InsertaRegistroCierreCursoImparticion($rut, $id_curso, $id_empresa, $nota, $estado, $avance, $id_inscripcion, $porcentaje_asistencia) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($estado == "Reprobado" or $estado == "REPROBADO") {
$id_estado = "0";
$estado = "REPROBADO";
} else if ($estado == "Aprobado" or $estado == "APROBADO") {
$id_estado = "1";
$estado = "APROBADO";
}

$sql = "INSERT INTO tbl_inscripcion_cierre (rut, nota, estado, estado_descripcion, id_curso, id_empresa, avance, id_inscripcion, porcentaje_asistencia) " .
"VALUES ('$rut', '$nota','$id_estado', '$estado', '$id_curso', '$id_empresa', '$avance', '$id_inscripcion', '$porcentaje_asistencia');";


$database->setquery($sql);
$database->query();
//echo $sql;exit;
}

function LMS_ActualizaRegistroCierreCursoImparticion($rut, $id_curso, $id_empresa, $nota, $estado, $porcentaje_asistencia, $id_inscripcion, $porcentaje_asistencia) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$estado=trim($estado);

if ($estado == "Reprobado" or $estado == "REPROBADO") {
$id_estado = "0";
$estado = "REPROBADO";
} else if ($estado == "Aprobado" or $estado == "APROBADO") {
$id_estado = "1";
$estado = "APROBADO";
}
$sql = "update tbl_inscripcion_cierre set nota='$nota', estado_descripcion='$estado', estado='$id_estado', avance='$porcentaje_asistencia', porcentaje_asistencia='$porcentaje_asistencia'
where rut='$rut' and id_curso='$id_curso' and id_empresa='$id_empresa' and id_inscripcion='$id_inscripcion'";

//echo "<br>".$sql;exit();

$database->setquery($sql);
$database->query();
}

function actualizaTablaCierreRut($rut, $id_curso, $id_imparticion, $asistencia, $id_empresa, $nota) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "update tbl_inscripcion_cierre set porcentaje_asistencia='$asistencia' , nota='$nota'
where rut='$rut' and id_curso='$id_curso' and id_empresa='$id_empresa' and id_inscripcion='$id_imparticion'";

$database->setquery($sql);
$database->query();
}

function InsertMallaLmsMalla($id_malla_sugerido, $malla_nombre, $malla_descripcion, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$malla_nombre = utf8_decode($malla_nombre);
$malla_descripcion = utf8_decode($malla_descripcion);

$sql = "INSERT INTO tbl_lms_malla (id, nombre, descripcion, id_empresa, tipo, columnas_clasificacion) " .
"VALUES ('$id_malla_sugerido', '$malla_nombre', '$malla_descripcion', '$id_empresa',
'obligatorio', '2');";

$database->setquery($sql);
$database->query();
}

function InsertClasLmsClas($id_malla_sugerido, $malla_nombre, $malla_descripcion, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$malla_nombre = utf8_decode($malla_nombre);
$malla_descripcion = utf8_decode($malla_descripcion);

$sql = "INSERT INTO tbl_lms_clasificacion (id_clasificacion, clasificacion,descripcion, id_empresa,
opcional, inactivo) " .
"VALUES ('$id_malla_sugerido', '$malla_nombre', '$malla_descripcion', '$id_empresa',
'0', '0');";

$database->setquery($sql);
$database->query();
}

function InsertMallaRelLmsMallaCla($id_malla_sugerido, $id_programa, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "INSERT INTO rel_lms_malla_curso (id_malla, id_clasificacion, id_empresa,id_programa) " .
"VALUES ('$id_malla_sugerido', '$id_malla_sugerido',  '$id_empresa',  '$id_programa');";

$database->setquery($sql);
$database->query();
}

function InsertMallaRelLmsMallaClaCurso($id_malla, $id_clasificacion, $id_curso, $id_programa, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "INSERT INTO rel_lms_malla_curso (id_malla, id_clasificacion, id_curso,
orden_curso, opcional, inactivo, id_empresa,id_programa) " .
"VALUES ('$id_malla', '$id_clasificacion',  '$id_curso',
'1', '0',  '0', '$id_empresa', '$id_programa');";

$database->setquery($sql);
$database->query();
}

function InsertaTablaCierreRutCursoImparticionAsistenciaEmpresa($rut, $id_curso, $id_imparticion, $asistencia, $id_empresa, $nota) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "INSERT INTO tbl_inscripcion_cierre (rut, porcentaje_asistencia,  estado, id_curso, id_empresa, id_inscripcion, nota) " .
"VALUES ('$rut', '$asistencia', '4', '$id_curso', '$id_empresa', '$id_imparticion', '$nota');";

$database->setquery($sql);
$database->query();
}



function DatosPremios($idcanje, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.id_premio, (select premio from tbl_premios where id_premio=h.id_premio and id_empresa=h.id_empresa) as premio,
(select nombre_completo from tbl_usuario where rut=h.rut) as nombre_completo,
(select email from tbl_usuario where rut=h.rut) as email
from tbl_premios_canje h where h.id='$idcanje' and h.id_empresa='$id_empresa'";

//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}
function Puntos_Query_Descarga($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.rut,
h.id_premio as id_item,
(select premio from tbl_premios where id_premio=h.id_premio limit 1) as Item,
(select premio_descripcion from tbl_premios where id_premio=h.id_premio limit 1) as ItemDescripcion,
(select dimension from tbl_premios where id_premio=h.id_premio limit 1) as Dimension,
(select segmento from tbl_premios where id_premio=h.id_premio limit 1) as Segmento,
(select puntos from tbl_premios where id_premio=h.id_premio limit 1) as Puntos,
h.fecha as fechasolicitud,
h.hora as horasolicitud,
h.puntos as puntos,
h.fecha_texto as fechaUso,
h.hora_inicio as HoraInicioUso,
h.hora_termino as HoraTerminoUso,
(select jefe from tbl_usuario where rut=h.rut) as rut_jefe,
(select responsable from tbl_usuario where rut=h.rut) as rut_backup1,
(select lider from tbl_usuario where rut=h.rut) as rut_backup2,
h.estadovalidacion,
h.despacho,
h.fecha_despacho,
h.entrega,
h.fecha_entrega

from tbl_premios_canje h

where h.id_empresa='$id_empresa'

order by h.id DESC, h.fecha DESC, h.hora DESC";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function RechazaPuntosPremiosJefe($id_beneficiocanje, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "update tbl_premios_puntos_usuarios_jefe_entregados set puntos='0'
where id='$id_beneficiocanje' and id_empresa='$id_empresa'";

//        echo $sql; sleep(2);
$database->setquery($sql);
$database->query();
}

function ValidaPuntosPremios($id_beneficiocanje, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "update tbl_premios_canje set estadovalidacion='1'
where id='$id_beneficiocanje' and id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
}

function RechazaPuntosPremios($id_beneficiocanje, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "update tbl_premios_canje set estadovalidacion='3', puntos='0'
where id='$id_beneficiocanje' and id_empresa='$id_empresa'";

//        echo $sql; sleep(2);
$database->setquery($sql);
$database->query();
}

function ValidaPuntosPremiosDespachos($id_beneficiocanje, $valida, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$fecha = date("Y-m-d");
$sql = "update tbl_premios_canje set despacho='$valida', fecha_despacho='$fecha'
where id='$id_beneficiocanje' and id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
}
function ValidaPuntosPremiosDespachosDeshacer($id_beneficiocanje, $valida, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$fecha = date("Y-m-d");
$sql = "update tbl_premios_canje set despacho='', fecha_despacho=''
where id='$id_beneficiocanje' and id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
}

function ValidaPuntosPremiosEntregas($id_beneficiocanje, $valida, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$fecha = date("Y-m-d");
$sql = "update tbl_premios_canje set entrega='$valida', fecha_entrega='$fecha'
where id='$id_beneficiocanje' and id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
}

function ValidaPuntosPremiosDeshacer($id_beneficiocanje, $valida, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$fecha = date("Y-m-d");
$sql = "update tbl_premios_canje set entrega='', fecha_entrega=''
where id='$id_beneficiocanje' and id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
}

function LMS_ActualizaRegistroCierreCurso($rut, $id_curso, $id_empresa, $nota, $estado, $avance) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
if ($estado == "Reprobado") {
$id_estado = "0";
} else if ($estado == "Aprobado") {
$id_estado = "1";
}
$sql = "update tbl_inscripcion_cierre set nota='$nota', estado='$id_estado', avance='$avance'
where rut='$rut' and id_curso='$id_curso' and id_empresa='$id_empresa'";
$database->setquery($sql);
$database->query();
}

function LMS_InsertaRegistroCierreCurso($rut, $id_curso, $id_empresa, $nota, $estado, $avance) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($estado == "Reprobado") {
$id_estado = "0";
} else if ($estado == "Aprobado") {
$id_estado = "1";
}

$sql = "INSERT INTO tbl_inscripcion_cierre (rut, nota, estado, id_curso, id_empresa, avance) " .
"VALUES ('$rut', '$nota', '$id_estado', '$id_curso', '$id_empresa', '$avance');";
$database->setquery($sql);
$database->query();
}


function SGD_borra_Sesion_finalizado($evaluado, $evaluador, $id_proceso) {
global $c_host, $c_user, $c_pass, $c_db;

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "delete from tbl_sgd_finalizados_evaluado_evaluador      where evaluado='$evaluado' and evaluador='$evaluador' and id_proceso='$id_proceso'    ";
$database->setquery($sql);
$database->query();

$sql = "delete from tbl_sgd_sesion_evaluacion      where evaluado='$evaluado' and evaluador='$evaluador' and id_proceso='$id_proceso'    ";
$database->setquery($sql);
$database->query();
}

function MP_SaveEditgrupointeres($grupo_interes, $id_categoria, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
UPDATE  tbl_mp_categorias  set categoria='$grupo_interes'
where id_empresa='$id_empresa' and id_categoria='$id_categoria'
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//exit();
return $cod;
}

function MP_SaveEditPalabra($palabra, $id_palabra, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
UPDATE  tbl_mp_palabras_prohibidas  set palabra='$palabra'
where id_empresa='$id_empresa' and id='$id_palabra'
";

//echo $sql; exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//exit();
return $cod;
}

function MP_SaveEditFrase($frase, $autor, $id_frase, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
UPDATE  tbl_mp_frases  set frase='$frase', autor='$autor'
where id_empresa='$id_empresa' and id='$id_frase'
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//exit();
return $cod;
}
function DeleteTagMp($deleteid, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
DELETE FROM tbl_mp_tag_admin
where id_empresa='$id_empresa' and id='$deleteid'
";

$database->setquery($sql);
$database->query();
}
function MP_SaveEditTag($tag, $id_tag, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
UPDATE  tbl_mp_tag_admin  set tag='$tag'
where id_empresa='$id_empresa' and id='$id_tag'
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//exit();
return $cod;
}

function MP_SaveEditMiniEncuesta($pregunta, $opcion1, $opcion2, $opcion3, $opcion4, $activa, $id_empresa, $id_encuesta) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
if ($activa == "on" or $activa == "1") {
$activa = "1";
} else {
$activa = "0";
}
$sql = "
UPDATE  tbl_miniencuestas  set pregunta='$pregunta',
opcion1='$opcion1',opcion2='$opcion2',opcion3='$opcion3',opcion4='$opcion4',
activa='$activa'     where id_empresa='$id_empresa' and id='$id_encuesta'
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//exit();
return $cod;
}

function MP_Savenuevogrupointeres($nuevogrupo_interes, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT id FROM tbl_mp_categorias WHERE id_empresa = '$id_empresa' order by id DESC Limit 1";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

//print_r($cod );

$nuevo_id = $id_empresa . "_" . $cod[0]->id;

$sql = "
INSERT INTO tbl_mp_categorias (id_categoria, categoria, id_empresa)
VALUES ('$nuevo_id', '$nuevogrupo_interes', '$id_empresa')
";

//echo $sql;    exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function MP_SavenuevaPalabra($nuevogrupo_interes, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
INSERT INTO tbl_mp_palabras_prohibidas (palabra, id_empresa)
VALUES ('$nuevogrupo_interes', '$id_empresa')
";

//echo $sql;    exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function MP_SavenuevaFrase($frase, $autor, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
INSERT INTO tbl_mp_frases (frase, autor, id_empresa)
VALUES ('$frase','$autor', '$id_empresa')
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function MP_save_TAG($tag, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
INSERT INTO tbl_mp_tag_admin (tag, id_empresa)
VALUES ('$tag','$id_empresa')
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function MP_SavenuevaMiniEncuesta($pregunta, $opcion1, $opcion2, $opcion3, $opcion4, $activa, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$fecha = date("Y-m-d");

if ($activa == "on") {
$activa = "1";
} else {
$activa = "0";
}
$sql = "
INSERT INTO tbl_miniencuestas (fecha, pregunta, opcion1, opcion2, opcion3, opcion4, activa, id_empresa)
VALUES ('$fecha','$pregunta', '$opcion1','$opcion2','$opcion3', '$opcion4', '$activa','$id_empresa')
";

//echo $sql;    sleep(5);

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function MP_BuscaCatDadoId($idcat, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select categoria from  tbl_mp_categorias  where id_categoria='$idcat' and id_empresa='$id_empresa'
";
//    echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//exit();
return $cod[0]->categoria;
}

function MP_SaveEditExpertogrupointeres($rut, $grupo_interes, $cat, $id, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
UPDATE  tbl_mp_vista  set contenido='$grupo_interes', icono='$cat', codigo='$rut'
where id_empresa='$id_empresa' and id='$id'
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//exit();
return $cod;
}

function MP_SavenuevoExpertogrupointeres($nuevogrupo_interes, $rut, $cat, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
INSERT INTO tbl_mp_vista (contenido, tipo, ambiente, codigo, id_empresa, icono)
VALUES ('$nuevogrupo_interes', 'vistaexperto','?sw=com_mp_personal&vp=1&rut_enviado=', '$rut', '$id_empresa', '$cat')
";

//echo $sql;    exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function VerificaMallaidPrograma($id_malla, $id_programa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT id FROM `rel_lms_malla_curso` WHERE `id_malla` = '$id_malla' AND `id_programa` = '$id_programa'
";
//    echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}
function ImparticionesNumSesiones_2021($id_inscripcion){

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT count(id) as cuenta from tbl_inscripcion_curso_sesiones_horarios where id_inscripcion='$id_inscripcion'

";
//    echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod[0]->cuenta;	


}

function IMPARTICION_UsuariosPorInscripcionConDatos($id_inscripcion, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$datos_empresa = DatosEmpresa($id_empresa);
$campo1 = $datos_empresa[0]->campo1;
$campo2 = $datos_empresa[0]->campo2;
$campo3 = $datos_empresa[0]->campo3;

$sql = "

SELECT tbl_inscripcion_usuarios.rut,
(select count(id) as cuenta from tbl_inscripcion_curso_sesiones_horarios where id_inscripcion=tbl_inscripcion_usuarios.id_inscripcion) as sesiones
from tbl_inscripcion_usuarios
WHERE
tbl_inscripcion_usuarios.id_inscripcion = '$id_inscripcion' and tbl_inscripcion_usuarios.id_empresa='$id_empresa'
and tbl_inscripcion_usuarios.rut<>'' 
and tbl_inscripcion_usuarios.rut<>'12345' 
and tbl_inscripcion_usuarios.rut<>'12121212' 
and tbl_inscripcion_usuarios.rut<>'13131313' 
and tbl_inscripcion_usuarios.rut<>'14141414' 
";
//echo "<br>IMPARTICION_UsuariosPorInscripcionConDatos<br>($id_inscripcion, $id_empresa)<br>".$sql."<br>";
//	exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function MP_SaveNuevaEvaluacion_data($nombre_evaluacion, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select id from tbl_evaluaciones order by id DESC limit 1";
$database->setquery($sql);
$database->query();
$cod2 = $database->listObjects();

$id_nuevo = $cod2[0]->id + 1;
$sql = "
INSERT INTO tbl_evaluaciones (id, nombre_evaluacion, id_empresa)
VALUES ('$id_nuevo', '" . utf8_decode($nombre_evaluacion) . "','$id_empresa')
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
}

function MP_SaveNuevaMedicion_data($nombre_evaluacion, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select id from tbl_enc_elearning order by id DESC limit 1";
$database->setquery($sql);
$database->query();
$cod2 = $database->listObjects();

$id_nuevo = $cod2[0]->id + 1;
$sql = "
INSERT INTO tbl_enc_elearning (id, nombre, id_empresa)
VALUES ('$id_nuevo', '" . utf8_decode($nombre_evaluacion) . "','$id_empresa')
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
}

function MP_SaveNuevaEncuesta_data($nombre_evaluacion, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select id from tbl_enc_elearning order by id DESC limit 1";
$database->setquery($sql);
$database->query();
$cod2 = $database->listObjects();

$id_nuevo = $cod2[0]->id + 1;
$sql = "
INSERT INTO tbl_enc_elearning (id, nombre, id_empresa)
VALUES ('$id_nuevo', '" . utf8_decode($nombre_evaluacion) . "','$id_empresa')
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
}
function MP_SaveEditNuevaEncuesta_data($nombre_evaluacion, $id_evaluacion, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select id from tbl_enc_elearning order by id DESC limit 1";
$database->setquery($sql);
$database->query();
$cod2 = $database->listObjects();

$id_nuevo = $cod2[0]->id + 1;
$sql = "
UPDATE tbl_enc_elearning SET nombre='" . utf8_decode($nombre_evaluacion) . "'
WHERE id='$id_evaluacion' and id_empresa='$id_empresa'
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
}

function MP_SaveNuevaEncuesta_dataMed($nombre_medicion, $banco_preguntas, $tipo_medicion, $descripcion_medicion, $datos_medicion,
$imagen_medicion, $footer_medicion, $id_empresa, $imagen_back) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select id from tbl_enc_elearning_medicion order by id DESC limit 1";
$database->setquery($sql);
$database->query();
$cod2 = $database->listObjects();

$id_nuevo = $cod2[0]->id + 1;
$sql = "
INSERT INTO tbl_enc_elearning_medicion (id, nombre, descripcion, id_empresa, tipo_medicion, id_encuesta,
fecha1, fecha2, fecha3,
titulo,bajada_titulo,
footer1,footer2,footerfinal,bajada_subtitulo,bajada_texto,imagensuperior,imageninferior,imagenlogo
)

VALUES ('$id_nuevo', '" . utf8_decode($nombre_medicion) . "', '" . utf8_decode($descripcion_medicion) . "',
'$id_empresa', '" . ($tipo_medicion) . "', '" . ($banco_preguntas) . "',
'" . ($fecha1) . "','" . ($fecha2) . "','" . ($fecha3) . "',
'" . utf8_decode($nombre_medicion) . "', '" . utf8_decode($descripcion_medicion) . "',
'" . utf8_decode($footer_medicion) . "', '', '',  '','x',
'" . utf8_decode($imagen_medicion) . "', '$imagen_back', ''

)
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
}

function MP_SaveNuevaEncuestaAdmin_dataMed($usuario_user, $usuario_clave, $usuario_name, $acceso, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select id from tbl_admin order by id DESC limit 1";
$database->setquery($sql);
$database->query();
$cod2 = $database->listObjects();

$id_nuevo = $cod2[0]->id + 1;
$sql = "
INSERT INTO tbl_admin (user, pass, nombre, acceso, id_empresa
)

VALUES ('$usuario_user','$usuario_clave', '" . utf8_decode($usuario_name) . "',
'$acceso','$id_empresa'

)
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
}

function MP_SaveNuevaMedicion_dataMed($nombre_medicion, $banco_preguntas, $tipo_medicion, $fecha1, $fecha2, $fecha3, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select id from tbl_enc_elearning_medicion order by id DESC limit 1";
$database->setquery($sql);
$database->query();
$cod2 = $database->listObjects();

$id_nuevo = $cod2[0]->id + 1;
$sql = "
INSERT INTO tbl_enc_elearning_medicion (id, nombre, id_empresa, tipo_medicion, id_encuesta, fecha1, fecha2, fecha3)
VALUES ('$id_nuevo', '" . utf8_decode($nombre_medicion) . "','$id_empresa', '" . ($tipo_medicion) . "', '" . ($banco_preguntas) . "',
'" . ($fecha1) . "','" . ($fecha2) . "','" . ($fecha3) . "')
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
}

function MP_SaveNuevoEjecutivo_data($rut_ejecutivo, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select nombre_completo from tbl_usuario where rut='$rut_ejecutivo'";
$database->setquery($sql);
$database->query();
$cod2 = $database->listObjects();

if ($cod2[0]->nombre_completo != '') {
$sql = "
INSERT INTO tbl_ejecutivos (rut, nombre, id_empresa)
VALUES ('$rut_ejecutivo', '" . $cod2[0]->nombre_completo . "','$id_empresa')
";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
}

return $cod;
}

function MP_SaveEditEjecutivo_data($rut_ejecutivo, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "
delete from  tbl_ejecutivos
where id_empresa='$id_empresa' and rut='$rut_ejecutivo'
";
//echo $sql;    exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}



function MP_SaveNuevoRelator_data($rut, $rut_relator, $nombre_relator, $empresa_relator, $tipo_relator, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
INSERT INTO tbl_relatores (rut, rut_completo, nombre, empresa, cargo, id_empresa)
VALUES ('$rut', '$rut_relator', '$nombre_relator','$empresa_relator', '$tipo_relator','$id_empresa')
";

//echo $sql; sleep(10);
//exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function MP_SaveEditRelator_data($rut_relator, $nombre_relator, $empresa_relator, $tipo_relator, $id_empresa, $id) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$rut = LimpiaRut($rut_relator);

$sql = "
update  tbl_relatores

set rut='$rut', rut_completo='$rut_relator', nombre='$nombre_relator', empresa='$empresa_relator', cargo='$tipo_relator'

where id_empresa='$id_empresa' and id='$id'
";
//echo $sql; sleep(10);
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function MP_SaveEditMedicionRow_data($nombre_medicion, $banco_preguntas, $tipo_medicion, $fecha1, $fecha2, $fecha3, $id_empresa, $id) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$rut = LimpiaRut($rut_relator);

$sql = "
update tbl_enc_elearning_medicion

set nombre='$nombre_medicion', id_encuesta='$banco_preguntas', tipo_medicion='$tipo_medicion',
fecha1='$fecha1',fecha2='$fecha2',fecha3='$fecha3'

where id_empresa='$id_empresa' and id='$id'
";
//echo $sql; sleep(10);
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function MP_SaveEditAdminMedicionRow_data($usuario_user, $usuario_clave, $usuario_nombre_usuario, $acceso, $id_empresa, $id) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$rut = LimpiaRut($rut_relator);

$sql = "
update tbl_admin

set user='$usuario_user', pass='$usuario_clave', nombre='$usuario_nombre_usuario',
acceso='$acceso'

where id_empresa='$id_empresa' and id='$id'
";
// echo $sql; exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function MP_SaveEditEvaluacion_data($id_evaluacion, $nombre_evaluacion, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$rut = LimpiaRut($rut_relator);

$sql = "
update  tbl_evaluaciones

set nombre_evaluacion='$nombre_evaluacion'

where id_empresa='$id_empresa' and id='$id_evaluacion'
";
//echo $sql; sleep(10);
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function MP_SaveEditMedicion_data($id_evaluacion, $nombre_evaluacion, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$rut = LimpiaRut($rut_relator);

$sql = "
update  tbl_evaluaciones

set nombre_evaluacion='$nombre_evaluacion'

where id_empresa='$id_empresa' and id='$id_evaluacion'
";
//echo $sql; sleep(10);
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TraeEvaluacionesPorEmpresa($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.*,
(select id from tbl_objeto where id_evaluacion=h.id limit 1) as id_objeto,
(select id_curso from tbl_objeto where id_evaluacion=h.id limit 1) as id_curso,
(select nombre from tbl_lms_curso where id=(select id_curso from tbl_objeto where id_evaluacion=h.id limit 1) ) as nombre_curso,
(select id from tbl_lms_curso where id=(select id_curso from tbl_objeto where id_evaluacion=h.id limit 1) ) as id_id_curso,
(select count(id) from tbl_evaluaciones_preguntas where evaluacion=h.id) as num_preguntas

from tbl_evaluaciones h where id_empresa='$id_empresa'
order by h.id DESC";
//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}
function BuscaPreguntaEnc_LB($idEval, $idPreg){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.*



from tbl_enc_elearning_preg h where id_encuesta='$idEval'   and id_pregunta='$idPreg'
order by h.id DESC";
//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}
function BuscaSeccionEnc_LB($idEval, $idSecc){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.*



from tbl_enc_elearning_seccion h where id_encuesta='$idEval'   and id_seccion='$idSecc'
order by h.id DESC";
//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeMedicionesPorEmpresa($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.*,

(select count(id) from tbl_enc_elearning_preg where id_encuesta=h.id) as num_preguntas

from tbl_enc_elearning h where id_empresa='$id_empresa'
order by h.id DESC";
//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}



function TraeRelatoresPorEmpresa2($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.* from tbl_relatores h where h.id_empresa='$id_empresa' order by h.nombre ASC";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TraeMedicionesEmpresa($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.*,

(select count(DISTINCT(rut)) from tbl_enc_elearning_respuestas  where id_medicion=h.id ) as cuentarespuestas,
(select nombre from tbl_enc_elearning where id=h.id_encuesta) as bancopreguntas

from tbl_enc_elearning_medicion h

where h.id_empresa='$id_empresa'
order by h.id DESC";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function BorroRegistrosInscritosCheckinPorSesionImparticionPorUsuario($codigo_imparticion, $id_empresa, $id_sesion, $rut) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "delete from rel_lms_inscripcion_usuario_checkin where id_empresa='$id_empresa' and codigo_imparticion='$codigo_imparticion' and sesion='$id_sesion' and rut='$rut'";

$database->setquery($sql);
$database->query();
}
function TraigoRegistrosPorSesionDeCheckinPorUsuario($codigo_inscripcion, $id_sesion, $id_empresa, $rut) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from rel_lms_inscripcion_usuario_checkin where codigo_imparticion='$codigo_inscripcion' and sesion='$id_sesion' and id_empresa='$id_empresa' and rut='$rut'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DatosAvanceEmbajadores($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT
tbl_planes_embajadores_reunion_inicial.rut,
baseembajador.nombre_completo AS nombre_embajador,
baseembajador.cargo AS cargo_embajador,
baseembajador.gerencia AS gerencia_embajador,
tbl_planes_embajadores_reunion_inicial.r2,
baser2.nombre_completo AS nombre_r2,
tbl_planes_embajadores_reunion_inicial.tutor,
basetutor.nombre_completo AS nombre_tutor,
tbl_planes_embajadores_reunion_inicial.fecha,
(SELECT            tbl_planes_embajadores.nombre_emb        FROM            tbl_planes_embajadores        WHERE            tbl_planes_embajadores.id_plan_emb = tbl_planes_embajadores_reunion_inicial.plan        LIMIT 1    ) AS nombrePlanSeleccionado,
tbl_planes_embajadores_reunion_inicial.plan as id_plan,
factor_exito,
ambito,
periodicidad,
nombre_kpi,
kpi_inicial,
kpi_esperado,
(SELECT            count(id)        FROM            tbl_plan_embajadores_tareas_por_actividad        WHERE            rut = tbl_planes_embajadores_reunion_inicial.rut        AND id_plan = tbl_planes_embajadores_reunion_inicial.plan    ) AS NumTareas

FROM

tbl_planes_embajadores_reunion_inicial

INNER JOIN tbl_usuario AS baseembajador ON baseembajador.rut = tbl_planes_embajadores_reunion_inicial.rut
INNER JOIN tbl_usuario AS baser2 ON baser2.rut = tbl_planes_embajadores_reunion_inicial.r2
INNER JOIN tbl_usuario AS basetutor ON basetutor.rut = tbl_planes_embajadores_reunion_inicial.tutor

order by baseembajador.nombre_completo";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ConsultaDataPorEjecutivo($ejecutivo, $fecha_inicio, $fecha_termino, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($ejecutivo == '' or $ejecutivo == '0') {
$query_ej = "";
} else {

$query_ej = " and h.rut_ejecutivo='" . $ejecutivo . "'";
}

if ($fecha_inicio != '') {$query_fi = " and h.fecha_inicio>='" . $fecha_inicio . "' ";}
if ($fecha_termino != '') {$query_ft = " and h.fecha_termino<='" . $fecha_termino . "' ";}

$sql = "

SELECT
h.*,
(select programa_global from rel_programa_bbdd_global where id_programa=h.id_programa) as  programa_global,
(select foco from rel_programa_bbdd_global where id_programa=h.id_programa) as  foco_global

from tbl_lms_reportes_full_inscripcion h

where h.id>0


$query_ej $query_fi $query_ft
group by h.id_inscripcion";

//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ConsultaDataPorEjecutivoMetrica($ejecutivo, $fecha_inicio, $fecha_termino, $id_empresa, $metodologia) {

//echo "$ejecutivo, $fecha_inicio, $fecha_termino, $id_empresa, $metodologia";

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($ejecutivo == '' or $ejecutivo == '0') {
$query_ej = "";
} else {

$query_ej = " and h.rut_ejecutivo='" . $ejecutivo . "'";
}

if ($metodologia == "Presencial") {$query_metodologia = " and h.status='Presencial' ";}
if ($metodologia == "Elearning") {$query_metodologia = " and h.status='Elearning' ";}

if ($fecha_inicio != '') {$query_fi = " and h.fecha_inicio>='" . $fecha_inicio . "' ";}
if ($fecha_termino != '') {$query_ft = " and h.fecha_termino<='" . $fecha_termino . "' ";}

$sql = "
SELECT

h.*,
(select round(avg(nota),2) from tbl_enc_sat_resultados where id_inscripcion=h.id_inscripcion) as EncuestaPromedio

from tbl_lms_reportes_full_inscripcion h

where h.id>0

$query_ej $query_fi $query_ft

$query_metodologia

group by h.id_inscripcion
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ConsultaDataPorEjecutivoMetricaGroupby($ejecutivo, $fecha_inicio, $fecha_termino, $id_empresa, $metodologia, $groupby) {

//echo "$ejecutivo, $fecha_inicio, $fecha_termino, $id_empresa, $metodologia";

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($ejecutivo == '' or $ejecutivo == '0') {
$query_ej = "";
} else {

$query_ej = " and rut_ejecutivo='" . $ejecutivo . "'";
}

if ($metodologia == "Presencial") {$query_metodologia = " and status='Presencial' ";}
if ($metodologia == "Elearning") {$query_metodologia = " and status='Elearning' ";}

if ($fecha_inicio != '') {$query_fi = " and fecha_inicio>='" . $fecha_inicio . "' ";}
if ($fecha_termino != '') {$query_ft = " and fecha_termino<='" . $fecha_termino . "' ";}

$sql = "
SELECT  count(id) as cuenta, $groupby  as tipo

from tbl_lms_reportes_full_inscripcion

where id>0


$query_ej $query_fi $query_ft

$query_metodologia

group by $groupby
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ConsultaDataPorRelator($relator, $fecha_inicio, $fecha_termino, $consolidado, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

if ($consolidado == "1") {
$add = " group by (select rut_completo from tbl_relatores where rut=rel_lms_inscripcion_sesion.relator)
order by sum(rel_lms_inscripcion_sesion.numero_horas) DESC    ";

$sum = "sum";
} else {
$add = "";
$sum = "";
}
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
if ($ejecutivo == '' or $ejecutivo == '0') {
$query_ej = "";
} else {
$query_ej = " (select cargo from tbl_relatores where rut=rel_lms_inscripcion_sesion.relator)='" . $relator . "'";
}
if ($fecha_inicio != '') {$query_fi = " and h.fecha_inicio>='" . $fecha_inicio . "' ";}
if ($fecha_termino != '') {$query_ft = " and h.fecha_termino<='" . $fecha_termino . "' ";}

$sql = "
select h.codigo_inscripcion, h.fecha_inicio, h.fecha_termino, h.id_curso,
h.ejecutivo,
(select nombre_completo from tbl_usuario where rut=h.ejecutivo) as NombreEjecutivo,
(select rut_completo from tbl_usuario where rut=h.ejecutivo) as RutEjecutivo,
rel_lms_inscripcion_sesion.relator,
$sum(rel_lms_inscripcion_sesion.numero_horas) as numero_horas,

(select numero_horas from tbl_lms_curso where id=h.id_curso) as NumHoras,
(select nombre from tbl_lms_curso where id=h.id_curso) as NombreCurso,
(select nombre from tbl_relatores where rut=rel_lms_inscripcion_sesion.relator) as NombreRelator,
(select cargo from tbl_relatores where rut=rel_lms_inscripcion_sesion.relator) as CargoRelator,
(select rut_completo from tbl_relatores where rut=rel_lms_inscripcion_sesion.relator) as RutRelator,
(select empresa from tbl_relatores where rut=rel_lms_inscripcion_sesion.relator) as EmpresaRelator

from tbl_inscripcion_curso h

LEFT JOIN rel_lms_inscripcion_sesion ON rel_lms_inscripcion_sesion.codigo_inscripcion=h.codigo_inscripcion

where h.id_empresa='$id_empresa'
and (select modalidad from tbl_lms_curso where id=h.id_curso)='2'

$query_ej $query_fi $query_ft

$add

(select nombre from tbl_relatores where rut=rel_lms_inscripcion_sesion.relator)
";

//echo $sql; exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ConsultaDataPorPersona($rut, $fecha_inicio, $fecha_termino, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($fecha_inicio != '') {$query_fi = " and (select fecha_inicio from tbl_lms_reportes_full
where id_curso=h.id_curso and fecha_inicio<>'0000-00-00'
order by fecha_inicio ASC limit 1)>='" . $fecha_inicio . "'";} else {
$query_fi = "";
}

if ($fecha_termino != '') {$query_ft = " and (select fecha_termino from tbl_lms_reportes_full
where id_curso=h.id_curso and fecha_termino<>'0000-00-00'
order by fecha_inicio ASC limit 1)<='" . $fecha_termino . "'";} else {
$query_ft = "";
}

$sql = "

SELECT
h.*,

(select nombre_completo from tbl_usuario where rut=h.rut) as nombre_usuario,
(select cargo from tbl_usuario where rut=h.rut) as cargo_usuario,
(select gerencia from tbl_usuario where rut=h.rut) as gerencia_usuario,
(select asistencia from tbl_usuario where rut=h.rut) as asistencia,


(select fecha_inicio from tbl_lms_reportes_full where id_curso=h.id_curso and rut=h.rut and fecha_inicio<>'0000-00-00' order by fecha_inicio ASC limit 1) as fecha_inicio_elearning,
(select fecha_termino from tbl_lms_reportes_full where id_curso=h.id_curso and rut=h.rut order by fecha_termino DESC limit 1) as fecha_termino_elearning



from tbl_lms_reportes_full h

where h.rut='$rut'
$query_fi $query_ft
group by h.id_curso";

//echo $sql; sleep(4);
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ConsultaDataPorUsuario($rut, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

SELECT
h.*,

(select nombre_completo from tbl_usuario where rut=h.ejecutivo) as nombre_ejecutivo,

count(id)  as inscritos,

(select count(id) from tbl_lms_reportes_full where id_curso=h.id_curso and asistencia='100%') as asistentes,
(select count(id) from tbl_lms_reportes_full where id_curso=h.id_curso and asistencia<>'0%' and asistencia<>'100%') as incompletos,
(select count(id) from tbl_lms_reportes_full where id_curso=h.id_curso and asistencia='0%') as inasistentes


from tbl_lms_reportes_full h

where h.rut='$rut'

group by h.id_curso";

//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function SGD_descarga_full($filtro_division, $tipo) {
global $c_host, $c_user, $c_pass, $c_db;

//echo "tipo $tipo";
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
if($filtro_division<>''){
$filtro_division_query= " and h.evaluado_division<>'$filtro_division' ";
} else {
$filtro_division_query= "";
}
if($tipo==""){ $jqyeryTipo="";
}
elseif($tipo=="ASC"){
//$jqyeryTipo=" and h.subperfil='ASCENDENTE' AND (select cantidad_evaluadores_ascendentes from tbl_sgd_reporte_full WHERE evaluado=h.evaluado and subperfil='DESCENDENTE' LIMIT 1)>=3 ";
$jqyeryTipo=" and h.subperfil='ASCENDENTE' AND (
(
SELECT
cantidad_evaluadores_ascendentes
FROM
tbl_sgd_reporte_full
WHERE
evaluado = h.evaluado
AND subperfil = 'DESCENDENTE'
LIMIT 1
) >= 3
OR (
SELECT
count(id) AS total
FROM
tbl_sgd_reporte_full
WHERE
evaluado = h.evaluado
AND subperfil = 'ASCENDENTE'
) >= 3
)";
}
elseif($tipo=="ASCsf"){
$jqyeryTipo=" and h.subperfil='ASCENDENTE'
";
}
elseif($tipo=="ASC_Pendientes"){
$jqyeryTipo=" and h.subperfil='ASCENDENTE' and h.fecha_evaluacion='0000-00-00' AND (select cantidad_evaluadores_ascendentes from tbl_sgd_reporte_full WHERE evaluado=h.evaluado and subperfil='DESCENDENTE' LIMIT 1)>=3
";
}
elseif($tipo=="DESC"){
$jqyeryTipo=" and h.subperfil='DESCENDENTE'
";
}
elseif($tipo=="DESC_Pendientes"){
$jqyeryTipo=" and h.subperfil='DESCENDENTE' and h.fecha_evaluacion='0000-00-00'
";
}
elseif($tipo=="VAL"){
$jqyeryTipo=" and h.subperfil='DESCENDENTE'
";
}
elseif($tipo=="VAL_Pendientes"){
$jqyeryTipo=" and h.subperfil='DESCENDENTE' and h.fecha_validacion='0000-00-00'
";
}

$sql = "SELECT h.* from tbl_sgd_reporte_full h where h.id>0 and h.evaluado<>'' $jqyeryTipo $filtro_division_query";

//echo $sql; exit();
//and h.evaluado='10033383'
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
// print_r($cod);
return $cod;
}

function TraeEjecutivosDeTabla($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select h.*, (select nombre_completo from tbl_usuario where rut=h.rut) as nombre_ejecutivo

from tbl_ejecutivos h

where h.id_empresa='$id_empresa'
and  (select vigencia from tbl_usuario where rut=h.rut)=0
and  (select rut_completo from tbl_usuario where rut=h.rut)<>''

order by (select nombre_completo from tbl_usuario where rut=h.rut)
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeEjecutivosPorEmpresa2($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.*,
(select nombre_completo from tbl_usuario where rut=h.rut) as nombre_completo,
(select cargo from tbl_usuario where rut=h.rut) as cargo,
(select gerencia from tbl_usuario where rut=h.rut) as gerencia

from tbl_ejecutivos h where h.id_empresa='$id_empresa'
and  (select vigencia from tbl_usuario where rut=h.rut)=0
and  (select rut_completo from tbl_usuario where rut=h.rut)<>''
order by h.nombre ASC";

// echo "sql $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function reporteResultadoActual() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = " SELECT
tbl_sgd_relaciones.evaluado,
base_evaluado.nombre_completo AS nombre_evaluado,
base_evaluado.cargo AS cargo_evaluado,
base_evaluado.gerencia as gerencia_evaluado,
base_evaluado.local as local_evaluado,
base_evaluado.zonal as zonal_evaluado,
base_evaluado.gerente_rf as gerente_rf_evaluado,

tbl_sgd_relaciones.evaluador,
base_evaluador.nombre_completo AS nombre_evaluador,
tbl_sgd_relaciones.perfil_evaluacion_competencias,
format((
SELECT
avg(puntaje)
FROM
tbl_sgd_respuestas
INNER JOIN tbl_sgd_preguntas ON tbl_sgd_preguntas.id = tbl_sgd_respuestas.id_pregunta
WHERE
tbl_sgd_relaciones.evaluado = tbl_sgd_respuestas.evaluado
AND tbl_sgd_relaciones.evaluador = tbl_sgd_respuestas.evaluador
AND tbl_sgd_relaciones.id_proceso = tbl_sgd_respuestas.id_proceso
AND tbl_sgd_preguntas.id_determinante = 1
), 2) AS notaSabe,

format((
SELECT
avg(puntaje)
FROM
tbl_sgd_respuestas
INNER JOIN tbl_sgd_preguntas ON tbl_sgd_preguntas.id = tbl_sgd_respuestas.id_pregunta
WHERE
tbl_sgd_relaciones.evaluado = tbl_sgd_respuestas.evaluado
AND tbl_sgd_relaciones.evaluador = tbl_sgd_respuestas.evaluador
AND tbl_sgd_relaciones.id_proceso = tbl_sgd_respuestas.id_proceso
AND tbl_sgd_preguntas.id_determinante = 2
), 2) AS notaPuede,

format((
SELECT
avg(puntaje)
FROM
tbl_sgd_respuestas
INNER JOIN tbl_sgd_preguntas ON tbl_sgd_preguntas.id = tbl_sgd_respuestas.id_pregunta
WHERE
tbl_sgd_relaciones.evaluado = tbl_sgd_respuestas.evaluado
AND tbl_sgd_relaciones.evaluador = tbl_sgd_respuestas.evaluador
AND tbl_sgd_relaciones.id_proceso = tbl_sgd_respuestas.id_proceso
AND tbl_sgd_preguntas.id_determinante = 3
), 2) AS notaQuiere,


format(
(
SELECT
avg(nota)
FROM
tbl_sgd_resultados_calculados_competencia
WHERE
tbl_sgd_resultados_calculados_competencia.evaluado = tbl_sgd_relaciones.evaluado
AND tbl_sgd_resultados_calculados_competencia.evaluador = tbl_sgd_relaciones.evaluador
AND tbl_sgd_resultados_calculados_competencia.id_proceso = tbl_sgd_relaciones.id_proceso
),
2
)AS nota_final,
format(
(
SELECT
avg(nota)
FROM
tbl_sgd_resultados_calculados_competencia
inner join tbl_sgd_componente on tbl_sgd_componente.id = tbl_sgd_resultados_calculados_competencia.id_competencia
WHERE
tbl_sgd_resultados_calculados_competencia.evaluado = tbl_sgd_relaciones.evaluado
AND tbl_sgd_resultados_calculados_competencia.evaluador = tbl_sgd_relaciones.evaluador
AND tbl_sgd_resultados_calculados_competencia.id_proceso = tbl_sgd_relaciones.id_proceso
and tbl_sgd_componente.reporte_resultados = 'lider'
),
2
)as nota_lider,



(select respuesta from tbl_sgd_respuestas

inner join tbl_sgd_preguntas
on tbl_sgd_preguntas.id=tbl_sgd_respuestas.id_pregunta and tbl_sgd_preguntas.id_determinante='1' and tbl_sgd_preguntas.agrupacion_para_reportes='lider'

where tbl_sgd_respuestas.evaluado=tbl_sgd_relaciones.evaluado and
tbl_sgd_respuestas.evaluador=tbl_sgd_relaciones.evaluador and
tbl_sgd_respuestas.id_proceso=tbl_sgd_relaciones.id_proceso


) as p1_lider,

(select comentario from tbl_sgd_respuestas

inner join tbl_sgd_preguntas
on tbl_sgd_preguntas.id=tbl_sgd_respuestas.id_pregunta and tbl_sgd_preguntas.id_determinante='1' and tbl_sgd_preguntas.agrupacion_para_reportes='lider'

where tbl_sgd_respuestas.evaluado=tbl_sgd_relaciones.evaluado and
tbl_sgd_respuestas.evaluador=tbl_sgd_relaciones.evaluador and
tbl_sgd_respuestas.id_proceso=tbl_sgd_relaciones.id_proceso


) as cp1_lider,


(select respuesta from tbl_sgd_respuestas

inner join tbl_sgd_preguntas
on tbl_sgd_preguntas.id=tbl_sgd_respuestas.id_pregunta and tbl_sgd_preguntas.id_determinante='2' and tbl_sgd_preguntas.agrupacion_para_reportes='lider'

where tbl_sgd_respuestas.evaluado=tbl_sgd_relaciones.evaluado and
tbl_sgd_respuestas.evaluador=tbl_sgd_relaciones.evaluador and
tbl_sgd_respuestas.id_proceso=tbl_sgd_relaciones.id_proceso


) as p2_lider,



(select comentario from tbl_sgd_respuestas

inner join tbl_sgd_preguntas
on tbl_sgd_preguntas.id=tbl_sgd_respuestas.id_pregunta and tbl_sgd_preguntas.id_determinante='2' and tbl_sgd_preguntas.agrupacion_para_reportes='lider'

where tbl_sgd_respuestas.evaluado=tbl_sgd_relaciones.evaluado and
tbl_sgd_respuestas.evaluador=tbl_sgd_relaciones.evaluador and
tbl_sgd_respuestas.id_proceso=tbl_sgd_relaciones.id_proceso


) as cp2_lider,


(select respuesta from tbl_sgd_respuestas

inner join tbl_sgd_preguntas
on tbl_sgd_preguntas.id=tbl_sgd_respuestas.id_pregunta and tbl_sgd_preguntas.id_determinante='3' and tbl_sgd_preguntas.agrupacion_para_reportes='lider'

where tbl_sgd_respuestas.evaluado=tbl_sgd_relaciones.evaluado and
tbl_sgd_respuestas.evaluador=tbl_sgd_relaciones.evaluador and
tbl_sgd_respuestas.id_proceso=tbl_sgd_relaciones.id_proceso


) as p3_lider,


(select comentario from tbl_sgd_respuestas

inner join tbl_sgd_preguntas
on tbl_sgd_preguntas.id=tbl_sgd_respuestas.id_pregunta and tbl_sgd_preguntas.id_determinante='3' and tbl_sgd_preguntas.agrupacion_para_reportes='lider'

where tbl_sgd_respuestas.evaluado=tbl_sgd_relaciones.evaluado and
tbl_sgd_respuestas.evaluador=tbl_sgd_relaciones.evaluador and
tbl_sgd_respuestas.id_proceso=tbl_sgd_relaciones.id_proceso


) as cp3_lider,



format(
(
SELECT
avg(nota)
FROM
tbl_sgd_resultados_calculados_competencia
inner join tbl_sgd_componente on tbl_sgd_componente.id = tbl_sgd_resultados_calculados_competencia.id_competencia
WHERE
tbl_sgd_resultados_calculados_competencia.evaluado = tbl_sgd_relaciones.evaluado
AND tbl_sgd_resultados_calculados_competencia.evaluador = tbl_sgd_relaciones.evaluador
AND tbl_sgd_resultados_calculados_competencia.id_proceso = tbl_sgd_relaciones.id_proceso
and tbl_sgd_componente.reporte_resultados = 'miembro'
),
2
)as nota_miembro,




(select respuesta from tbl_sgd_respuestas

inner join tbl_sgd_preguntas
on tbl_sgd_preguntas.id=tbl_sgd_respuestas.id_pregunta and tbl_sgd_preguntas.id_determinante='1' and tbl_sgd_preguntas.agrupacion_para_reportes='miembro'

where tbl_sgd_respuestas.evaluado=tbl_sgd_relaciones.evaluado and
tbl_sgd_respuestas.evaluador=tbl_sgd_relaciones.evaluador and
tbl_sgd_respuestas.id_proceso=tbl_sgd_relaciones.id_proceso


) as p1_miembro,


(select comentario from tbl_sgd_respuestas

inner join tbl_sgd_preguntas
on tbl_sgd_preguntas.id=tbl_sgd_respuestas.id_pregunta and tbl_sgd_preguntas.id_determinante='1' and tbl_sgd_preguntas.agrupacion_para_reportes='miembro'

where tbl_sgd_respuestas.evaluado=tbl_sgd_relaciones.evaluado and
tbl_sgd_respuestas.evaluador=tbl_sgd_relaciones.evaluador and
tbl_sgd_respuestas.id_proceso=tbl_sgd_relaciones.id_proceso


) as cp1_miembro,



(select respuesta from tbl_sgd_respuestas

inner join tbl_sgd_preguntas
on tbl_sgd_preguntas.id=tbl_sgd_respuestas.id_pregunta and tbl_sgd_preguntas.id_determinante='2' and tbl_sgd_preguntas.agrupacion_para_reportes='miembro'

where tbl_sgd_respuestas.evaluado=tbl_sgd_relaciones.evaluado and
tbl_sgd_respuestas.evaluador=tbl_sgd_relaciones.evaluador and
tbl_sgd_respuestas.id_proceso=tbl_sgd_relaciones.id_proceso


) as p2_miembro,


(select comentario from tbl_sgd_respuestas

inner join tbl_sgd_preguntas
on tbl_sgd_preguntas.id=tbl_sgd_respuestas.id_pregunta and tbl_sgd_preguntas.id_determinante='2' and tbl_sgd_preguntas.agrupacion_para_reportes='miembro'

where tbl_sgd_respuestas.evaluado=tbl_sgd_relaciones.evaluado and
tbl_sgd_respuestas.evaluador=tbl_sgd_relaciones.evaluador and
tbl_sgd_respuestas.id_proceso=tbl_sgd_relaciones.id_proceso


) as cp2_miembro,


(select respuesta from tbl_sgd_respuestas

inner join tbl_sgd_preguntas
on tbl_sgd_preguntas.id=tbl_sgd_respuestas.id_pregunta and tbl_sgd_preguntas.id_determinante='3' and tbl_sgd_preguntas.agrupacion_para_reportes='miembro'

where tbl_sgd_respuestas.evaluado=tbl_sgd_relaciones.evaluado and
tbl_sgd_respuestas.evaluador=tbl_sgd_relaciones.evaluador and
tbl_sgd_respuestas.id_proceso=tbl_sgd_relaciones.id_proceso


) as p3_miembro,


(select comentario from tbl_sgd_respuestas

inner join tbl_sgd_preguntas
on tbl_sgd_preguntas.id=tbl_sgd_respuestas.id_pregunta and tbl_sgd_preguntas.id_determinante='3' and tbl_sgd_preguntas.agrupacion_para_reportes='miembro'

where tbl_sgd_respuestas.evaluado=tbl_sgd_relaciones.evaluado and
tbl_sgd_respuestas.evaluador=tbl_sgd_relaciones.evaluador and
tbl_sgd_respuestas.id_proceso=tbl_sgd_relaciones.id_proceso


) as cp3_miembro,





format(
(
SELECT
avg(nota)
FROM
tbl_sgd_resultados_calculados_competencia
inner join tbl_sgd_componente on tbl_sgd_componente.id = tbl_sgd_resultados_calculados_competencia.id_competencia
WHERE
tbl_sgd_resultados_calculados_competencia.evaluado = tbl_sgd_relaciones.evaluado
AND tbl_sgd_resultados_calculados_competencia.evaluador = tbl_sgd_relaciones.evaluador
AND tbl_sgd_resultados_calculados_competencia.id_proceso = tbl_sgd_relaciones.id_proceso
and tbl_sgd_componente.reporte_resultados = 'colaborador'
),
2
)as nota_colaborador,




(select respuesta from tbl_sgd_respuestas

inner join tbl_sgd_preguntas
on tbl_sgd_preguntas.id=tbl_sgd_respuestas.id_pregunta and tbl_sgd_preguntas.id_determinante='1' and tbl_sgd_preguntas.agrupacion_para_reportes='colaborador'

where tbl_sgd_respuestas.evaluado=tbl_sgd_relaciones.evaluado and
tbl_sgd_respuestas.evaluador=tbl_sgd_relaciones.evaluador and
tbl_sgd_respuestas.id_proceso=tbl_sgd_relaciones.id_proceso


) as p1_colaborador,


(select comentario from tbl_sgd_respuestas

inner join tbl_sgd_preguntas
on tbl_sgd_preguntas.id=tbl_sgd_respuestas.id_pregunta and tbl_sgd_preguntas.id_determinante='1' and tbl_sgd_preguntas.agrupacion_para_reportes='colaborador'

where tbl_sgd_respuestas.evaluado=tbl_sgd_relaciones.evaluado and
tbl_sgd_respuestas.evaluador=tbl_sgd_relaciones.evaluador and
tbl_sgd_respuestas.id_proceso=tbl_sgd_relaciones.id_proceso


) as cp1_colaborador,


(select respuesta from tbl_sgd_respuestas

inner join tbl_sgd_preguntas
on tbl_sgd_preguntas.id=tbl_sgd_respuestas.id_pregunta and tbl_sgd_preguntas.id_determinante='2' and tbl_sgd_preguntas.agrupacion_para_reportes='colaborador'

where tbl_sgd_respuestas.evaluado=tbl_sgd_relaciones.evaluado and
tbl_sgd_respuestas.evaluador=tbl_sgd_relaciones.evaluador and
tbl_sgd_respuestas.id_proceso=tbl_sgd_relaciones.id_proceso


) as p2_colaborador,


(select comentario from tbl_sgd_respuestas

inner join tbl_sgd_preguntas
on tbl_sgd_preguntas.id=tbl_sgd_respuestas.id_pregunta and tbl_sgd_preguntas.id_determinante='2' and tbl_sgd_preguntas.agrupacion_para_reportes='colaborador'

where tbl_sgd_respuestas.evaluado=tbl_sgd_relaciones.evaluado and
tbl_sgd_respuestas.evaluador=tbl_sgd_relaciones.evaluador and
tbl_sgd_respuestas.id_proceso=tbl_sgd_relaciones.id_proceso


) as cp2_colaborador,


(select respuesta from tbl_sgd_respuestas

inner join tbl_sgd_preguntas
on tbl_sgd_preguntas.id=tbl_sgd_respuestas.id_pregunta and tbl_sgd_preguntas.id_determinante='3' and tbl_sgd_preguntas.agrupacion_para_reportes='colaborador'

where tbl_sgd_respuestas.evaluado=tbl_sgd_relaciones.evaluado and
tbl_sgd_respuestas.evaluador=tbl_sgd_relaciones.evaluador and
tbl_sgd_respuestas.id_proceso=tbl_sgd_relaciones.id_proceso


) as p3_colaborador,

(select comentario from tbl_sgd_respuestas

inner join tbl_sgd_preguntas
on tbl_sgd_preguntas.id=tbl_sgd_respuestas.id_pregunta and tbl_sgd_preguntas.id_determinante='3' and tbl_sgd_preguntas.agrupacion_para_reportes='colaborador'

where tbl_sgd_respuestas.evaluado=tbl_sgd_relaciones.evaluado and
tbl_sgd_respuestas.evaluador=tbl_sgd_relaciones.evaluador and
tbl_sgd_respuestas.id_proceso=tbl_sgd_relaciones.id_proceso


) as cp3_colaborador,





format(
(
SELECT
avg(nota)
FROM
tbl_sgd_resultados_calculados_competencia
inner join tbl_sgd_componente on tbl_sgd_componente.id = tbl_sgd_resultados_calculados_competencia.id_competencia
WHERE
tbl_sgd_resultados_calculados_competencia.evaluado = tbl_sgd_relaciones.evaluado
AND tbl_sgd_resultados_calculados_competencia.evaluador = tbl_sgd_relaciones.evaluador
AND tbl_sgd_resultados_calculados_competencia.id_proceso = tbl_sgd_relaciones.id_proceso
and tbl_sgd_componente.reporte_resultados = 'proveedor'
),
2
)as nota_proveedor,




(select respuesta from tbl_sgd_respuestas

inner join tbl_sgd_preguntas
on tbl_sgd_preguntas.id=tbl_sgd_respuestas.id_pregunta and tbl_sgd_preguntas.id_determinante='1' and tbl_sgd_preguntas.agrupacion_para_reportes='proveedor'

where tbl_sgd_respuestas.evaluado=tbl_sgd_relaciones.evaluado and
tbl_sgd_respuestas.evaluador=tbl_sgd_relaciones.evaluador and
tbl_sgd_respuestas.id_proceso=tbl_sgd_relaciones.id_proceso


) as p1_proveedor,

(select comentario from tbl_sgd_respuestas

inner join tbl_sgd_preguntas
on tbl_sgd_preguntas.id=tbl_sgd_respuestas.id_pregunta and tbl_sgd_preguntas.id_determinante='1' and tbl_sgd_preguntas.agrupacion_para_reportes='proveedor'

where tbl_sgd_respuestas.evaluado=tbl_sgd_relaciones.evaluado and
tbl_sgd_respuestas.evaluador=tbl_sgd_relaciones.evaluador and
tbl_sgd_respuestas.id_proceso=tbl_sgd_relaciones.id_proceso


) as cp1_proveedor,


(select respuesta from tbl_sgd_respuestas

inner join tbl_sgd_preguntas
on tbl_sgd_preguntas.id=tbl_sgd_respuestas.id_pregunta and tbl_sgd_preguntas.id_determinante='2' and tbl_sgd_preguntas.agrupacion_para_reportes='proveedor'

where tbl_sgd_respuestas.evaluado=tbl_sgd_relaciones.evaluado and
tbl_sgd_respuestas.evaluador=tbl_sgd_relaciones.evaluador and
tbl_sgd_respuestas.id_proceso=tbl_sgd_relaciones.id_proceso


) as p2_proveedor,


(select comentario from tbl_sgd_respuestas

inner join tbl_sgd_preguntas
on tbl_sgd_preguntas.id=tbl_sgd_respuestas.id_pregunta and tbl_sgd_preguntas.id_determinante='2' and tbl_sgd_preguntas.agrupacion_para_reportes='proveedor'

where tbl_sgd_respuestas.evaluado=tbl_sgd_relaciones.evaluado and
tbl_sgd_respuestas.evaluador=tbl_sgd_relaciones.evaluador and
tbl_sgd_respuestas.id_proceso=tbl_sgd_relaciones.id_proceso


) as cp2_proveedor,


(select respuesta from tbl_sgd_respuestas

inner join tbl_sgd_preguntas
on tbl_sgd_preguntas.id=tbl_sgd_respuestas.id_pregunta and tbl_sgd_preguntas.id_determinante='3' and tbl_sgd_preguntas.agrupacion_para_reportes='proveedor'

where tbl_sgd_respuestas.evaluado=tbl_sgd_relaciones.evaluado and
tbl_sgd_respuestas.evaluador=tbl_sgd_relaciones.evaluador and
tbl_sgd_respuestas.id_proceso=tbl_sgd_relaciones.id_proceso


) as p3_proveedor,

(select comentario from tbl_sgd_respuestas

inner join tbl_sgd_preguntas
on tbl_sgd_preguntas.id=tbl_sgd_respuestas.id_pregunta and tbl_sgd_preguntas.id_determinante='3' and tbl_sgd_preguntas.agrupacion_para_reportes='proveedor'

where tbl_sgd_respuestas.evaluado=tbl_sgd_relaciones.evaluado and
tbl_sgd_respuestas.evaluador=tbl_sgd_relaciones.evaluador and
tbl_sgd_respuestas.id_proceso=tbl_sgd_relaciones.id_proceso


) as cp3_proveedor,



format(
(
SELECT
avg(nota)
FROM
tbl_sgd_resultados_calculados_competencia
inner join tbl_sgd_componente on tbl_sgd_componente.id = tbl_sgd_resultados_calculados_competencia.id_competencia
WHERE
tbl_sgd_resultados_calculados_competencia.evaluado = tbl_sgd_relaciones.evaluado
AND tbl_sgd_resultados_calculados_competencia.evaluador = tbl_sgd_relaciones.evaluador
AND tbl_sgd_resultados_calculados_competencia.id_proceso = tbl_sgd_relaciones.id_proceso
and tbl_sgd_componente.reporte_resultados = 'gestor'
),
2
)as nota_gestor,




(select respuesta from tbl_sgd_respuestas

inner join tbl_sgd_preguntas
on tbl_sgd_preguntas.id=tbl_sgd_respuestas.id_pregunta and tbl_sgd_preguntas.id_determinante='1' and tbl_sgd_preguntas.agrupacion_para_reportes='gestor'

where tbl_sgd_respuestas.evaluado=tbl_sgd_relaciones.evaluado and
tbl_sgd_respuestas.evaluador=tbl_sgd_relaciones.evaluador and
tbl_sgd_respuestas.id_proceso=tbl_sgd_relaciones.id_proceso


) as p1_gestor,


(select comentario from tbl_sgd_respuestas

inner join tbl_sgd_preguntas
on tbl_sgd_preguntas.id=tbl_sgd_respuestas.id_pregunta and tbl_sgd_preguntas.id_determinante='1' and tbl_sgd_preguntas.agrupacion_para_reportes='gestor'

where tbl_sgd_respuestas.evaluado=tbl_sgd_relaciones.evaluado and
tbl_sgd_respuestas.evaluador=tbl_sgd_relaciones.evaluador and
tbl_sgd_respuestas.id_proceso=tbl_sgd_relaciones.id_proceso


) as cp1_gestor,


(select respuesta from tbl_sgd_respuestas

inner join tbl_sgd_preguntas
on tbl_sgd_preguntas.id=tbl_sgd_respuestas.id_pregunta and tbl_sgd_preguntas.id_determinante='2' and tbl_sgd_preguntas.agrupacion_para_reportes='gestor'

where tbl_sgd_respuestas.evaluado=tbl_sgd_relaciones.evaluado and
tbl_sgd_respuestas.evaluador=tbl_sgd_relaciones.evaluador and
tbl_sgd_respuestas.id_proceso=tbl_sgd_relaciones.id_proceso


) as p2_gestor,


(select comentario from tbl_sgd_respuestas

inner join tbl_sgd_preguntas
on tbl_sgd_preguntas.id=tbl_sgd_respuestas.id_pregunta and tbl_sgd_preguntas.id_determinante='2' and tbl_sgd_preguntas.agrupacion_para_reportes='gestor'

where tbl_sgd_respuestas.evaluado=tbl_sgd_relaciones.evaluado and
tbl_sgd_respuestas.evaluador=tbl_sgd_relaciones.evaluador and
tbl_sgd_respuestas.id_proceso=tbl_sgd_relaciones.id_proceso


) as cp2_gestor,


(select respuesta from tbl_sgd_respuestas

inner join tbl_sgd_preguntas
on tbl_sgd_preguntas.id=tbl_sgd_respuestas.id_pregunta and tbl_sgd_preguntas.id_determinante='3' and tbl_sgd_preguntas.agrupacion_para_reportes='gestor'

where tbl_sgd_respuestas.evaluado=tbl_sgd_relaciones.evaluado and
tbl_sgd_respuestas.evaluador=tbl_sgd_relaciones.evaluador and
tbl_sgd_respuestas.id_proceso=tbl_sgd_relaciones.id_proceso


) as p3_gestor,


(select comentario from tbl_sgd_respuestas

inner join tbl_sgd_preguntas
on tbl_sgd_preguntas.id=tbl_sgd_respuestas.id_pregunta and tbl_sgd_preguntas.id_determinante='3' and tbl_sgd_preguntas.agrupacion_para_reportes='gestor'

where tbl_sgd_respuestas.evaluado=tbl_sgd_relaciones.evaluado and
tbl_sgd_respuestas.evaluador=tbl_sgd_relaciones.evaluador and
tbl_sgd_respuestas.id_proceso=tbl_sgd_relaciones.id_proceso


) as cp3_gestor,



format(
(
SELECT
avg(nota)
FROM
tbl_sgd_resultados_calculados_competencia
inner join tbl_sgd_componente on tbl_sgd_componente.id = tbl_sgd_resultados_calculados_competencia.id_competencia
WHERE
tbl_sgd_resultados_calculados_competencia.evaluado = tbl_sgd_relaciones.evaluado
AND tbl_sgd_resultados_calculados_competencia.evaluador = tbl_sgd_relaciones.evaluador
AND tbl_sgd_resultados_calculados_competencia.id_proceso = tbl_sgd_relaciones.id_proceso
and tbl_sgd_componente.reporte_resultados = 'servicio'
),
2
)as nota_servicio,





(select respuesta from tbl_sgd_respuestas

inner join tbl_sgd_preguntas
on tbl_sgd_preguntas.id=tbl_sgd_respuestas.id_pregunta and tbl_sgd_preguntas.id_determinante='1' and tbl_sgd_preguntas.agrupacion_para_reportes='servicio'

where tbl_sgd_respuestas.evaluado=tbl_sgd_relaciones.evaluado and
tbl_sgd_respuestas.evaluador=tbl_sgd_relaciones.evaluador and
tbl_sgd_respuestas.id_proceso=tbl_sgd_relaciones.id_proceso


) as p1_servicio,


(select comentario from tbl_sgd_respuestas

inner join tbl_sgd_preguntas
on tbl_sgd_preguntas.id=tbl_sgd_respuestas.id_pregunta and tbl_sgd_preguntas.id_determinante='1' and tbl_sgd_preguntas.agrupacion_para_reportes='servicio'

where tbl_sgd_respuestas.evaluado=tbl_sgd_relaciones.evaluado and
tbl_sgd_respuestas.evaluador=tbl_sgd_relaciones.evaluador and
tbl_sgd_respuestas.id_proceso=tbl_sgd_relaciones.id_proceso


) as cp1_servicio,


(select respuesta from tbl_sgd_respuestas

inner join tbl_sgd_preguntas
on tbl_sgd_preguntas.id=tbl_sgd_respuestas.id_pregunta and tbl_sgd_preguntas.id_determinante='2' and tbl_sgd_preguntas.agrupacion_para_reportes='servicio'

where tbl_sgd_respuestas.evaluado=tbl_sgd_relaciones.evaluado and
tbl_sgd_respuestas.evaluador=tbl_sgd_relaciones.evaluador and
tbl_sgd_respuestas.id_proceso=tbl_sgd_relaciones.id_proceso


) as p2_servicio,


(select comentario from tbl_sgd_respuestas

inner join tbl_sgd_preguntas
on tbl_sgd_preguntas.id=tbl_sgd_respuestas.id_pregunta and tbl_sgd_preguntas.id_determinante='2' and tbl_sgd_preguntas.agrupacion_para_reportes='servicio'

where tbl_sgd_respuestas.evaluado=tbl_sgd_relaciones.evaluado and
tbl_sgd_respuestas.evaluador=tbl_sgd_relaciones.evaluador and
tbl_sgd_respuestas.id_proceso=tbl_sgd_relaciones.id_proceso


) as cp2_servicio,



(select respuesta from tbl_sgd_respuestas

inner join tbl_sgd_preguntas
on tbl_sgd_preguntas.id=tbl_sgd_respuestas.id_pregunta and tbl_sgd_preguntas.id_determinante='3' and tbl_sgd_preguntas.agrupacion_para_reportes='servicio'

where tbl_sgd_respuestas.evaluado=tbl_sgd_relaciones.evaluado and
tbl_sgd_respuestas.evaluador=tbl_sgd_relaciones.evaluador and
tbl_sgd_respuestas.id_proceso=tbl_sgd_relaciones.id_proceso


) as p3_servicio,

(select comentario from tbl_sgd_respuestas

inner join tbl_sgd_preguntas
on tbl_sgd_preguntas.id=tbl_sgd_respuestas.id_pregunta and tbl_sgd_preguntas.id_determinante='3' and tbl_sgd_preguntas.agrupacion_para_reportes='servicio'

where tbl_sgd_respuestas.evaluado=tbl_sgd_relaciones.evaluado and
tbl_sgd_respuestas.evaluador=tbl_sgd_relaciones.evaluador and
tbl_sgd_respuestas.id_proceso=tbl_sgd_relaciones.id_proceso


) as cp3_servicio,



(select comentario from tbl_sgd_comentarios_finales where tbl_sgd_comentarios_finales.evaluado=tbl_sgd_relaciones.evaluado and tbl_sgd_comentarios_finales.evaluador=tbl_sgd_relaciones.evaluador) as comentario_final_evaluacion

FROM
tbl_sgd_relaciones
INNER JOIN tbl_usuario AS base_evaluado ON base_evaluado.rut = tbl_sgd_relaciones.evaluado
INNER JOIN tbl_usuario AS base_evaluador ON base_evaluador.rut = tbl_sgd_relaciones.evaluador
limit 10

-- inner join rut_comentarios
-- on rut_comentarios.evaluado=tbl_sgd_relaciones.evaluado and rut_comentarios.evaluador=tbl_sgd_relaciones.evaluador

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ReporteFeedback() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "
SELECT
baseevaluado.rut_completo as rut_evaluado, baseevaluado.nombre_completo, baseevaluado.cargo as cargo_evaluado, baseevaluado.gerencia as gerenciaevaluado,
baseevaluador.rut_completo as rut_evaluador, baseevaluador.nombre_completo as nombre_evaluador, baseevaluador.cargo as cargo_evaluador, baseevaluador.gerencia as gerenciaevaluador,
tbl_calibracion_liberados.fecha as fecha_calibracion_realizada,
tbl_sgd_finalizado_proceso.fecha as fecha_liberacion_informe_a_evaluado,
tbl_sgd_feedback_evaluado.realizado as Recibi_Feedback_de_mi_Jefatura,
tbl_sgd_feedback_evaluado.nota,
tbl_sgd_feedback_evaluado.pregunta1 as Estas_de_acuerdo_con_tu_evaluacion,
tbl_sgd_feedback_evaluado.pregunta2 as Ingresa_comentarios_sobre_el_Feedback_Recibido
FROM
tbl_sgd_relaciones
inner join tbl_usuario as baseevaluado
on baseevaluado.rut=tbl_sgd_relaciones.evaluado
inner join tbl_usuario as baseevaluador
on baseevaluador.rut=tbl_sgd_relaciones.evaluador
LEFT JOIN tbl_calibracion_liberados
on tbl_calibracion_liberados.evaluado=tbl_sgd_relaciones.evaluado and tbl_calibracion_liberados.evaluador
left join tbl_sgd_finalizado_proceso
on tbl_sgd_finalizado_proceso.evaluado=tbl_sgd_relaciones.evaluado and tbl_sgd_finalizado_proceso.evaluador=tbl_sgd_relaciones.evaluador
left join tbl_sgd_feedback_evaluado
on tbl_sgd_feedback_evaluado.evaluado=tbl_sgd_relaciones.evaluado

WHERE
tbl_sgd_relaciones.evaluado <> tbl_sgd_relaciones.evaluador
AND tbl_sgd_relaciones.id_empresa = '61'
order by tbl_sgd_relaciones.evaluador

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ActualizaDatosTblUsuario($rut, $gerencia, $local, $zonal, $gerente_rf) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "update tbl_usuario set gerencia='$gerencia', local='$local', zonal='$zonal', gerente_rf='$gerente_rf'          where rut='$rut'";
$database->setquery($sql);
$database->query();
}

function EstaEnTablaTemporal($rut) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_usuario_trabajando where rut='$rut'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function SGD_borra_Relacion($evaluado, $evaluador, $id_proceso) {
global $c_host, $c_user, $c_pass, $c_db;

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "delete from tbl_sgd_relaciones where  evaluado='$evaluado'  and evaluador='$evaluador' and id_proceso='$id_proceso'    ";

$database->setquery($sql);
$database->query();
$sql = "delete from tbl_sgd_validacion_equipo where  evaluado='$evaluado'  and evaluador='$evaluador'    ";

$database->setquery($sql);
$database->query();

// agrega como no evaluable

$sql = "INSERT INTO tbl_sgd_noevaluables (evaluado,evaluador)
VALUES ('$evaluado','$evaluador');";
$database->setquery($sql);
$database->query();
}

function SGD_borra_respuestas_Sesion_finalizado_datos_calculados($evaluado, $evaluador, $id_proceso) {
global $c_host, $c_user, $c_pass, $c_db;

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "delete from tbl_sgd_respuestas where  evaluador='$evaluador'           and evaluador='$evaluador' and id_proceso='$id_proceso'    ";
$database->setquery($sql);
$database->query();

$sql = "delete from tbl_sgd_finalizados_evaluado_evaluador      where evaluado='$evaluado' and evaluador='$evaluador' and id_proceso='$id_proceso'    ";
$database->setquery($sql);
$database->query();

$sql = "delete from tbl_sgd_sesion_evaluacion      where evaluado='$evaluado' and evaluador='$evaluador' and id_proceso='$id_proceso'    ";
$database->setquery($sql);
$database->query();

$sql = "delete from  tbl_sgd_resultados_calculados_competencia      where evaluado='$evaluado' and evaluador='$evaluador' and id_proceso='$id_proceso'    ";
$database->setquery($sql);
$database->query();
}

function SGD_ActualizaPerfilEval($evaluado, $evaluador, $id_proceso, $nuevo_perfil) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "update tbl_sgd_relaciones set perfil_evaluacion_competencias='$nuevo_perfil'          where evaluado='$evaluado' and evaluador='$evaluador' and id_proceso='$id_proceso'    ";
$database->setquery($sql);
$database->query();
}

function PerfilesEvalPorEmpresa($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_sgd_perfiles_ponderaciones where id_empresa='$id_empresa' ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function SGD_ActualizaDatosEvaluacionRespuestas($evaluador_original, $evaluado, $evaluador, $id_proceso) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "update tbl_sgd_respuestas set evaluador='$evaluador'          where evaluado='$evaluado' and evaluador='$evaluador_original' and id_proceso='$id_proceso'    ";
$database->setquery($sql);
$database->query();

$sql = "update tbl_sgd_finalizados_evaluado_evaluador set evaluador='$evaluador'          where evaluado='$evaluado' and evaluador='$evaluador_original' and id_proceso='$id_proceso'    ";
$database->setquery($sql);
$database->query();

$sql = "update tbl_sgd_sesion_evaluacion set evaluador='$evaluador'          where evaluado='$evaluado' and evaluador='$evaluador_original' and id_proceso='$id_proceso'    ";
$database->setquery($sql);
$database->query();

$sql = "update tbl_sgd_resultados_calculados_competencia set evaluador='$evaluador'          where evaluado='$evaluado' and evaluador='$evaluador_original' and id_proceso='$id_proceso'    ";
$database->setquery($sql);
$database->query();
}

function BuscaCursoDadoImp($id_imparticion) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select h.id_curso,
(select nombre from tbl_lms_curso where id=h.id_curso) as nombre_curso
from tbl_inscripcion_curso h where h.codigo_inscripcion='$id_imparticion'
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function BuscaNombreCursoDadoID($id_curso) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select nombre from tbl_lms_curso where id='$id_curso'
";

//echo "<br><br><br><br><br>$sql;";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function UpdateRelObjetoImpT($fechaT1, $fechaT2, $horaH1, $horaH2, $codigo_imparticion, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
update rel_objeto_imparticiones SET fecha_inicio='$fechaT1', fecha_termino='$fechaT2', hora_inicio='$horaH1', hora_termino='$horaH2'
where id_inscripcion='$codigo_imparticion'
";

//echo "<br><br><br><br><br>$sql;";
$database->setquery($sql);
$database->query();

$sql = "update tbl_inscripcion_curso SET fecha_inicio='$fechaT1', fecha_termino='$fechaT2' where codigo_inscripcion='$codigo_imparticion' ";
$database->setquery($sql);
$database->query();

//echo "<br><br><br><br><br>$sql;";
//return $cod;
}

function BuscaFechasRelInscripcion($id_inscripcion) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select * from rel_objeto_imparticiones where id_inscripcion='$id_inscripcion'
";

//echo "<br><br><br><br><br>$sql;";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ValidoImparticionPorCodigoEmpresa($id_inscripcion, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_inscripcion_curso where codigo_inscripcion='$id_inscripcion' and id_empresa='$id_empresa'    ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function SGD_Entrega_IdCriterio($key, $perfil) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "
select h.id, h.criterio

from tbl_sgd_matriz_criterios h

where h.dimension='$key' and h.perfil='$perfil' and h.tipo_objeto='grafico_frecuencia'

";

//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function SGD_Entrega_RangosFrecuenciaCalibracion($perfil) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "
select h.criterio, h.dimension, h.rangomenor, h.rangomayor

from tbl_sgd_matriz_criterios h

where h.perfil='$perfil' and h.tipo_objeto='grafico_frecuencia'

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function ENC_TraigoEncuestasFinalizadasArregloPost($id_empresa, $arreglo_objetos, $arreglo_post) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$i = 1;

if ($arreglo_post["imparticion"]) {
}

$sql = "select * , tbl_usuario.nombre_completo as nombre, tbl_usuario.rut_completo, tbl_usuario.cargo,


tbl_usuario.gerencia as c1,
tbl_usuario.gerenciaR2 as c2,
tbl_usuario.gerenciaR3 as c3



from tbl_inscripcion_usuarios h

inner join tbl_usuario
on tbl_usuario.rut=h.rut
where h.id_empresa='$id_empresa'  $filtro_codigo_inscripcion  group by h.rut";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function ClasificacionPorEjecutivoEmpresa($ejecutivo, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "
select distinct(rel_lms_malla_curso.id_clasificacion), tbl_lms_clasificacion.clasificacion as nombre_clasificacion from tbl_inscripcion_curso
inner join rel_lms_malla_curso
on rel_lms_malla_curso.id_curso=tbl_inscripcion_curso.id_curso
left join tbl_lms_clasificacion
on rel_lms_malla_curso.id_clasificacion=tbl_lms_clasificacion.id_clasificacion

where ejecutivo='$ejecutivo' and rel_lms_malla_curso.id_empresa='$id_empresa' and rel_lms_malla_curso.id_clasificacion<>''
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function MallasPorEjecutivoEmpresa($ejecutivo, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "
select distinct(rel_lms_malla_curso.id_malla), tbl_lms_malla.nombre as nombre_malla from tbl_inscripcion_curso
inner join rel_lms_malla_curso
on rel_lms_malla_curso.id_curso=tbl_inscripcion_curso.id_curso
left join tbl_lms_malla
on rel_lms_malla_curso.id_malla=tbl_lms_malla.id

where ejecutivo='$ejecutivo' and rel_lms_malla_curso.id_empresa='$id_empresa' and rel_lms_malla_curso.id_malla<>''

ORDER BY tbl_lms_malla.nombre
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function ProgramasPorEjecutivoEmpresa($ejecutivo, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select distinct(rel_lms_malla_curso.id_programa), tbl_lms_programas_bbdd.nombre_programa from tbl_inscripcion_curso
inner join rel_lms_malla_curso
on rel_lms_malla_curso.id_curso=tbl_inscripcion_curso.id_curso
left join tbl_lms_programas_bbdd
on tbl_lms_programas_bbdd.id_programa=rel_lms_malla_curso.id_programa

where ejecutivo='$ejecutivo' and rel_lms_malla_curso.id_empresa='$id_empresa' and rel_lms_malla_curso.id_programa<>''

ORDER BY     tbl_lms_programas_bbdd.nombre_programa    ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function FocosPorEjecutivoEmpresa($ejecutivo, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select distinct(rel_lms_malla_curso.id_foco), tbl_lms_foco.descripcion from tbl_inscripcion_curso
inner join rel_lms_malla_curso
on rel_lms_malla_curso.id_curso=tbl_inscripcion_curso.id_curso
left join tbl_lms_foco
on tbl_lms_foco.codigo_foco=rel_lms_malla_curso.id_foco

where ejecutivo='$ejecutivo' and rel_lms_malla_curso.id_empresa='$id_empresa' and id_foco<>''

ORDER BY tbl_lms_foco.descripcion
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function CursosPorEjecutivo($ejecutivo) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select distinct(tbl_inscripcion_curso.id_curso) as id_curso, tbl_lms_curso.nombre as nombre_curso from tbl_inscripcion_curso
inner join tbl_lms_curso
on tbl_lms_curso.id=tbl_inscripcion_curso.id_curso where ejecutivo='$ejecutivo'
ORDER BY tbl_lms_curso.nombre asc

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function BorraUsuarioRelacionMallaUsuario($id_malla, $rut, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "delete from rel_lms_malla_persona where id_empresa='$id_empresa' and id_malla='$id_malla' and rut='$rut'";
//echo "<br>$sql<br>";

$database->setquery($sql);
$database->query();

$sql = "delete from tbl_inscripcion_usuarios where id_empresa='$id_empresa' and id_malla='$id_malla' and rut='$rut'";
$database->setquery($sql);
$database->query();
//echo "<br>$sql<br>";

//    echo $sql;
//    exit();
}

function Ingresa_malla_personaConOpcional($rut, $id_malla, $id_empresa, $opcional, $hoy, $id_programa, $opcional_inscripcion) {

/*echo "<br>
<h2>Ingresa_malla_personaConOpcional(rut $rut, id_malla $id_malla,  id_empresa $id_empresa, opcional $opcional, hoy $hoy, id_programa $id_programa, opcional_inscripcion $opcional_inscripcion)</h2>
<br>";
*/
//exit();
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select h.*, (select id_malla from rel_lms_malla_curso where id_programa='$id_programa' and id_malla=h.id_malla limit 1)
from rel_lms_malla_persona h
where h.rut='$rut' and
(select id_malla from rel_lms_malla_curso where id_programa='$id_programa' and id_malla=h.id_malla limit 1)=h.id_malla
and h.id_empresa='$id_empresa'
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

if (count($cod) >= 1) {
$sql = "

delete h.*

from rel_lms_malla_persona h

where h.rut='$rut'
and (select id_malla from rel_lms_malla_curso where id_programa='$id_programa' and id_malla=h.id_malla limit 1)=h.id_malla
and h.id_empresa='$id_empresa'";
$database->setquery($sql);
$database->query();

foreach ($cod as $codunico) {
$miListaCursosDadaMalla2 = TraeSoloCursos($codunico->id_malla, $id_empresa);
//print_r($miListaCursosDadaMalla2);

foreach ($miListaCursosDadaMalla2 as $miListaCursoDadaMalla2) {
BorraRelacionInscripcionUsuarioMallaPersonaempresa($rut, $codunico->id_malla, $miListaCursoDadaMalla2->id_curso, $id_empresa, $hoy, $id_programa);
}
}
}

if ($opcional_inscripcion == "Si") {
$valor_opcional = "1";
} else {
$valor_opcional = "";
}
$sql = "INSERT INTO rel_lms_malla_persona(rut,id_malla,id_empresa, opcional)
VALUES ('$rut','$id_malla','$id_empresa', '$valor_opcional');";
$database->setquery($sql);
$database->query();

$miListaCursosDadaMalla = TraeSoloCursos($id_malla, $id_empresa);
//print_r($miListaCursosDadaMalla);
foreach ($miListaCursosDadaMalla as $miListaCursoDadaMalla) {
InsertaRelacionInscripcionUsuarioMallaPersonaempresa($rut, $id_malla, $miListaCursoDadaMalla->id_curso, $id_empresa, $hoy, $id_programa, $multimalla, $fecha_inscripcion, $opcional_inscripcion);
}
}

function SGD_MATRIZ_updateData($id_solicitud, $id_sgd_relaciones, $evaluado, $evaluador, $validador, $calibrador, $perfil_evaluacion, $subperfil) {
//echo "<br>$id_solicitud, $id_sgd_relaciones, $evaluado, $evaluador, $validador, $calibrador";
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$evaluado = LimpiaRut($evaluado);
$evaluador = LimpiaRut($evaluador);
$validador = LimpiaRut($validador);

$calibrador = LimpiaRut($calibrador);

$sql = "    update
tbl_sgd_relaciones set
evaluado='$evaluado',
evaluador='$evaluador',
calibrador='$calibrador',
validador='$validador',
perfil_evaluacion_competencias='$perfil_evaluacion'

where id='$id_sgd_relaciones'

";

$database->setquery($sql);
$database->query();

if ($id_solicitud != '') {
$sql = "    update tbl_sgd_validacion_equipo set estado_admin='OK', estado='1'
where id='$id_solicitud'
";

$database->setquery($sql);
$database->query();
}

//echo "<br>$id_solicitud $sql";
//exit();
$cod = $database->listObjects();
return $cod;
}

function SGD_MATRIZ_InsertData($id_proceso, $evaluado, $evaluador, $validador, $calibrador, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$evaluado = LimpiaRut($evaluado);
$evaluador = LimpiaRut($evaluador);
$validador = LimpiaRut($validador);
$calibrador = LimpiaRut($calibrador);

$sql = "
INSERT INTO tbl_sgd_relaciones (evaluado, evaluador, calibrador, validador, id_proceso, id_empresa)
VALUES ('$evaluado', '$evaluador', '$calibrador', '$validador', '$id_proceso', '$id_empresa')
";

//echo $sql;    exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function SGD_DatosTablaRelaciones($id_empresa, $id_proceso, $rut_evaluado_filtrado, $rut_evaluador_filtrado) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($rut_evaluado_filtrado) {
$filtro_evaluado = " and h.evaluado='$rut_evaluado_filtrado'";
}

if ($rut_evaluador_filtrado) {
$filtro_evaluador = " and h.evaluador='$rut_evaluador_filtrado'";
}

$sql = "

select h.*,

(select rut_completo from tbl_usuario where id_empresa='$id_empresa' and rut=h.evaluado) as RutEvaluado,
(select nombre_completo from tbl_usuario where id_empresa='$id_empresa' and rut=h.evaluado) as NombreEvaluado,
(select cargo from tbl_usuario where id_empresa='$id_empresa' and rut=h.evaluado) as CargoEvaluado,
(select gerencia from tbl_usuario where id_empresa='$id_empresa' and rut=h.evaluado) as GerenciaEvaluado,

(select rut_completo from tbl_usuario where id_empresa='$id_empresa' and rut=h.evaluador) as RutEvaluador,
(select nombre_completo from tbl_usuario where id_empresa='$id_empresa' and rut=h.evaluador) as NombreEvaluador,
(select cargo from tbl_usuario where id_empresa='$id_empresa' and rut=h.evaluador) as CargoEvaluador,
(select gerencia from tbl_usuario where id_empresa='$id_empresa' and rut=h.evaluador) as GerenciaEvaluador,

(select rut_completo from tbl_usuario where id_empresa='$id_empresa' and rut=h.validador) as RutValidador,
(select nombre_completo from tbl_usuario where id_empresa='$id_empresa' and rut=h.validador) as NombreValidador,
(select cargo from tbl_usuario where id_empresa='$id_empresa' and rut=h.validador) as CargoValidador,
(select gerencia from tbl_usuario where id_empresa='$id_empresa' and rut=h.validador) as GerenciaValidador,

(select rut_completo from tbl_usuario where id_empresa='$id_empresa' and rut=h.calibrador) as RutCalibrador,
(select nombre_completo from tbl_usuario where id_empresa='$id_empresa' and rut=h.calibrador) as NombreCalibrador,
(select cargo from tbl_usuario where id_empresa='$id_empresa' and rut=h.calibrador) as CargoCalibrador,
(select gerencia from tbl_usuario where id_empresa='$id_empresa' and rut=h.calibrador) as GerenciaCalibrador,

(select descripcion_proceso from tbl_sgd_proceso_evaluacion where id_empresa='$id_empresa' and id_proceso=h.id_proceso) as Proceso,
(select descripcion from tbl_sgd_perfiles_ponderaciones where id_empresa='$id_empresa' and perfil=h.perfil_evaluacion_competencias) as Perfil,
(select perfil from tbl_sgd_subperfiles where id_empresa='$id_empresa' and id=h.subperfil) as NombreSubPerfil,
perfil_evaluacion_competencias

from tbl_sgd_relaciones h

where

h.id_empresa='$id_empresa' and h.id_proceso='$id_proceso' $filtro_evaluado $filtro_evaluador

";



$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function SGD_DatosTablaRelacionesNoEvaluables($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select h.*,

(select rut_completo from tbl_usuario where id_empresa='$id_empresa' and rut=h.evaluado) as RutEvaluado,
(select nombre_completo from tbl_usuario where id_empresa='$id_empresa' and rut=h.evaluado) as NombreEvaluado,
(select cargo from tbl_usuario where id_empresa='$id_empresa' and rut=h.evaluado) as CargoEvaluado,
(select gerencia from tbl_usuario where id_empresa='$id_empresa' and rut=h.evaluado) as GerenciaEvaluado,

(select rut_completo from tbl_usuario where id_empresa='$id_empresa' and rut=h.evaluador) as RutEvaluador,
(select nombre_completo from tbl_usuario where id_empresa='$id_empresa' and rut=h.evaluador) as NombreEvaluador,
(select cargo from tbl_usuario where id_empresa='$id_empresa' and rut=h.evaluador) as CargoEvaluador,
(select gerencia from tbl_usuario where id_empresa='$id_empresa' and rut=h.evaluador) as GerenciaEvaluador
from tbl_sgd_noevaluables h

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function SGD_datosFeedback($id_empresa, $id_proceso) {

$sql = "select h.evaluado,
(select nombre_completo from tbl_usuario where id_empresa='62' and rut=h.evaluado) as NombreEvaluado,
(select cargo from tbl_usuario where id_empresa='62' and rut=h.evaluado) as CargoEvaluado,
(select gerencia from tbl_usuario where id_empresa='62' and rut=h.evaluado) as GerenciaEvaluado,

h.evaluador,
(select nombre_completo from tbl_usuario where id_empresa='62' and rut=h.evaluador) as NombreEvaluador,
(select cargo from tbl_usuario where id_empresa='62' and rut=h.evaluador) as CargoEvaluador,
(select gerencia from tbl_usuario where id_empresa='62' and rut=h.evaluador) as GerenciaEvaluador,

(select realizado from tbl_sgd_feedback_evaluado where evaluado=h.evaluado and evaluador=h.evaluador limit 1) as Feedback_Realizado,
(select fecha from tbl_sgd_feedback_realizado where evaluado=h.evaluado and evaluador=h.evaluador limit 1) as Feedback_Fecha,
(select fecha from tbl_sgd_feedback_finalizado where evaluado=h.evaluado and evaluador=h.evaluador limit 1) as Feedback_Finalizado,

(select pregunta1 from tbl_sgd_feedback_evaluado where evaluado=h.evaluado and evaluador=h.evaluador limit 1) as EvaluadoComentarios



from tbl_sgd_relaciones h where h.id_proceso='108'

order by (select fecha from tbl_sgd_feedback_finalizado where evaluado=h.evaluado and evaluador=h.evaluador limit 1)";
}

function SGD_DatosTablaRelacionesSolicitudes($id_empresa, $id_proceso) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "


select h.*,
(select nombre_completo from tbl_usuario where id_empresa='$id_empresa' and rut=h.evaluador2) as NombreNuevoJefeEvaluado,
(select nombre_completo from tbl_usuario where id_empresa='$id_empresa' and rut=h.evaluado) as NombreEvaluado,
(select cargo from tbl_usuario where id_empresa='$id_empresa' and rut=h.evaluado) as CargoEvaluado,
(select gerencia from tbl_usuario where id_empresa='$id_empresa' and rut=h.evaluado) as GerenciaEvaluado,

(select nombre_completo from tbl_usuario where id_empresa='$id_empresa' and rut=h.evaluador) as NombreEvaluador,
(select cargo from tbl_usuario where id_empresa='$id_empresa' and rut=h.evaluador) as CargoEvaluador,
(select gerencia from tbl_usuario where id_empresa='$id_empresa' and rut=h.evaluador) as GerenciaEvaluador,
(select id from tbl_sgd_relaciones where evaluado=h.evaluado and evaluador=h.evaluador and
id_empresa='$id_empresa' and id_proceso='$id_proceso') as idsgdrelaciones

from tbl_sgd_validacion_equipo h

where

h.id_empresa='$id_empresa' and h.estado<10 and h.estado>1



";
// and h.id_proceso='$id_proceso'
//echo "<br>SGD_DatosTablaRelacionesSolicitudes ".$sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function SGD_DatosTablaRelacionesSolicitudesPendientes($id_empresa, $id_proceso) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select h.*,
(select nombre_completo from tbl_usuario where id_empresa='$id_empresa' and rut=h.evaluado) as NombreEvaluado,
(select cargo from tbl_usuario where id_empresa='$id_empresa' and rut=h.evaluado) as CargoEvaluado,
(select gerencia from tbl_usuario where id_empresa='$id_empresa' and rut=h.evaluado) as GerenciaEvaluado,

(select nombre_completo from tbl_usuario where id_empresa='$id_empresa' and rut=h.evaluador) as NombreEvaluador,
(select cargo from tbl_usuario where id_empresa='$id_empresa' and rut=h.evaluador) as CargoEvaluador,
(select gerencia from tbl_usuario where id_empresa='$id_empresa' and rut=h.evaluador) as GerenciaEvaluador,

(select evaluado from tbl_sgd_validacion_equipo where evaluado=h.evaluado limit 1) as EvaluadoEquipo,

(select estado from tbl_sgd_validacion_equipo where evaluado=h.evaluado limit 1) As EstadoEquipo

from tbl_sgd_relaciones h where h.id_proceso='$id_proceso' and h.id_empresa='$id_empresa'


";
// and h.id_proceso='$id_proceso'

//echo "<br>SGD_DatosTablaRelacionesSolicitudesPendientes $sql";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function SGD_DatosTablaRelacionesPorEvaluador($id_empresa, $id_proceso, $arreglo_post, $filtro_excel) {
global $c_host, $c_user, $c_pass, $c_db;
//echo   "SGD_DatosTablaRelacionesPorEvaluador<br>$c_host, $c_user, $c_pass, $c_db";
//echo   "<br>filtro_excel<br>$filtro_excel";


$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$datos_empresa = DatosEmpresa($id_empresa);
$campo1 = $datos_empresa[0]->campo1;
$campo2 = $datos_empresa[0]->campo2;
$campo3 = $datos_empresa[0]->campo3;
$filtro1 = "";
$filtro2 = "";
$filtro3 = "";
$filtro22 = "";
$filtro2_2 = "";
$filtro22_2 = "";
if ($arreglo_post["filtro_campo1"]) {
$filtro1 = " and base_evaluador." . $campo1 . "='" . $arreglo_post["filtro_campo1"] . "'";
}

if ($arreglo_post["filtro_campo2"] == "AE") {
$filtro2 = "   and evaluador=evaluado";
$filtro22 = "   and h.evaluador=h.evaluado";
}

if ($arreglo_post["filtro_campo2"] == "DESC") {
$filtro2_2 = "   and evaluador<>evaluado";
$filtro22_2 = "   and h.evaluador<>h.evaluado";
}
if($filtro_excel=="AE"){
$filtro2  = "   and evaluador=evaluado";
$filtro22 = "   and h.evaluador=h.evaluado";
}
if($filtro_excel=="DESC"){
$filtro2_2  = "   and evaluador<>evaluado";
$filtro22_2 = "   and h.evaluador<>h.evaluado";
}

if ($arreglo_post["filtro_campo3"]) {
$filtro3 = " and base_evaluador." . $campo3 . "='" . $arreglo_post["filtro_campo3"] . "'";
}

$sql = "

select h.*,

(select count(id) from tbl_sgd_relaciones where evaluador=h.evaluador and id_proceso='$id_proceso'
and  tbl_sgd_relaciones.id_empresa='$id_empresa' and evaluado<>'' $filtro2 $filtro2_2) as CuentaEvaluados,

(select count(id) from tbl_sgd_finalizados_evaluado_evaluador where id_proceso='$id_proceso'
and    evaluador=h.evaluador $filtro2 $filtro2_2) as CuentaFinalizados,


(select descripcion_proceso from tbl_sgd_proceso_evaluacion where tbl_sgd_proceso_evaluacion.id_empresa='$id_empresa' and id_proceso=h.id_proceso) as Proceso,
(select descripcion from tbl_sgd_perfiles_ponderaciones where tbl_sgd_perfiles_ponderaciones.id_empresa='$id_empresa' and perfil=h.perfil_evaluacion_competencias) as Perfil,
(select perfil from tbl_sgd_subperfiles where tbl_sgd_subperfiles.id_empresa='$id_empresa' and id=h.subperfil) as NombreSubPerfil

from tbl_sgd_relaciones h

where

h.id_empresa='$id_empresa'

and h.id_proceso='$id_proceso'

and h.evaluador<>''
$filtro22
$filtro22_2
" . utf8_decode($filtro1) . "
" . utf8_decode($filtro2) . "
" . utf8_decode($filtro3) . "


group by h.evaluador

";

//echo "<br>sql $sql";

if ($arreglo_post["filtro_campo2"] != "" or $filtro_excel<>"") {
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
}
return $cod;
}
function SGD_AgrupacionDivision($id_empresa){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql="

select h.evaluado_division from tbl_sgd_reporte_full h

where h.subperfil='DESCENDENTE'
and h.evaluado_division <>''

group by h.evaluado_division

";

//echo "<br> SGD_AgrupacionDivision ".$sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function SGD_AgrupacionGerenciaDivision($id_empresa){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql="

select h.evaluado_division, h.evaluado_gerencia from tbl_sgd_reporte_full h

where h.subperfil='DESCENDENTE'
and h.evaluado_gerencia <>''

group by h.evaluado_division,h.evaluado_gerencia   order by h.evaluado_division

";

//  echo "<br> SGD_AgrupacionGerenciaDivision ".$sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function SGD_DatosTablaRelacionesPorEvaluadoEvaluadorFull($id_empresa, $subperfil, $division, $gerencia, $area) {
global $c_host, $c_user, $c_pass, $c_db;

//print_r($arreglo_post);

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$datos_empresa = DatosEmpresa($id_empresa);
$campo1 = $datos_empresa[0]->campo1;
$campo2 = $datos_empresa[0]->campo2;
$campo3 = $datos_empresa[0]->campo3;
$filtro1 = "";
$filtro2 = "";
$filtro3 = "";
$filtro22 = "";
$filtro2_2 = "";
$filtro22_2 = "";

if ($arreglo_post["filtro_campo1"]) {
$filtro1 = " and base_evaluador." . $campo1 . "='" . $arreglo_post["filtro_campo1"] . "'";
}

if ($arreglo_post["filtro_campo2"] == "AE") {
$filtro2 = "   and evaluador=evaluado";
$filtro22 = "   and h.evaluador=h.evaluado";
}

if ($arreglo_post["filtro_campo2"] == "DESC") {
$filtro2_2 = "   and evaluador<>evaluado";
$filtro22_2 = "   and h.evaluador<>h.evaluado";
}

if ($arreglo_post["filtro_campo3"]) {
$filtro3 = " and base_evaluador." . $campo3 . "='" . $arreglo_post["filtro_campo3"] . "'";
}

$qDivision=""; $qGerencia=""; $qArea="";
if($division<>'')      { $qDivision ="and h.evaluado_division='$division'";}
if($gerencia<>'')      { $qGerencia="and h.evaluado_gerencia='$gerencia'";}


$sql1AE="select count(h.id) as cuenta_evaluablesAE from tbl_sgd_reporte_full h where h.subperfil='ASCENDENTE'AND (select cantidad_evaluadores_ascendentes from tbl_sgd_reporte_full WHERE evaluado=h.evaluado and subperfil='DESCENDENTE' LIMIT 1)>=3 $qDivision $qGerencia $qArea;";


//$sql1="select count(h.id) as cuenta_evaluables from tbl_sgd_reporte_full h where h.subperfil='$subperfil' $qDivision $qGerencia $qArea;";
$sql1="select count(h.id) as cuenta_evaluables from tbl_sgd_reporte_full h where h.subperfil='$subperfil'  and h.evaluador<>'jefe_div' and h.perfil<>'no_evaluable'  $qDivision $qGerencia $qArea;";
$sql2="select count(h.id) as cuenta_validacion from tbl_sgd_reporte_full h where h.subperfil='$subperfil' and h.validacion_equipo_realizada='Aprobado' and h.fecha_validacion <>'0000-00-00'  $qDivision $qGerencia $qArea;";
$sql3="select count(h.id) as cuenta_evaluacion_DESC from tbl_sgd_reporte_full h where h.subperfil='$subperfil' and h.resultado_evaluacion_descendente>0 and h.evaluador<>'jefe_div' and h.perfil<>'no_evaluable' and h.fecha_evaluacion <>'0000-00-00'  $qDivision $qGerencia $qArea;";
$sql4="select count(h.id) as cuenta_evaluacion_ASC from tbl_sgd_reporte_full h where h.subperfil='ASCENDENTE' and h.fecha_evaluacion <>'0000-00-00'  $qDivision $qGerencia $qArea;";
$sql5="select count(h.id) as cuenta_calibracion from tbl_sgd_reporte_full h where h.subperfil='$subperfil' and h.fecha_calibracion <>'0000-00-00'  $qDivision $qGerencia $qArea;";
$sql6="select count(h.id) as cuenta_plan from tbl_sgd_reporte_full h where h.subperfil='$subperfil' and h.fecha_plan <>'0000-00-00'  $qDivision $qGerencia $qArea;";
$sql7="select count(h.id) as cuenta_retro from tbl_sgd_reporte_full h where h.subperfil='$subperfil' and h.fecha_retro <>'0000-00-00'  $qDivision $qGerencia $qArea;";
$sql8="select count(h.id) as cuenta_informe from tbl_sgd_reporte_full h where h.subperfil='$subperfil' and h.fecha_informe <>'0000-00-00'  $qDivision $qGerencia $qArea;";
$sql_ae="select count(h.id) as cuenta_autoevaluacion from tbl_sgd_reporte_full h where h.subperfil='$subperfil' and h.autoevaluacion_SI >'1'  $qDivision $qGerencia $qArea;";

//echo "<br>sql4 $sql4";


// echo "<br><br> SGD_DatosTablaRelacionesPorEvaluadoEvaluadorFull subperfil $subperfil, division $division".$sql1;
$database->setquery($sql1AE); $database->query();    $cod1AE = $database->listObjects();

$database->setquery($sql1);   $database->query();    $cod1 = $database->listObjects();
$database->setquery($sql2);   $database->query();    $cod2 = $database->listObjects();
$database->setquery($sql3);   $database->query();    $cod3 = $database->listObjects();
$database->setquery($sql4);   $database->query();    $cod4 = $database->listObjects();
$database->setquery($sql5);   $database->query();    $cod5 = $database->listObjects();
$database->setquery($sql6);   $database->query();    $cod6 = $database->listObjects();
$database->setquery($sql7);   $database->query();    $cod7 = $database->listObjects();
$database->setquery($sql8);   $database->query();    $cod8 = $database->listObjects();
$database->setquery($sql_ae);   $database->query();    $cod_sql = $database->listObjects();


$array[0]=$cod1[0]->cuenta_evaluables;
$array[1]=$cod2[0]->cuenta_validacion;
$array[2]=$cod3[0]->cuenta_evaluacion_DESC;
$array[3]=$cod4[0]->cuenta_evaluacion_ASC;
$array[4]=$cod5[0]->cuenta_calibracion;
$array[5]=$cod6[0]->cuenta_plan;
$array[6]=$cod7[0]->cuenta_retro;
$array[7]=$cod8[0]->cuenta_informe;
$array[8]=$cod1AE[0]->cuenta_evaluablesAE;
$array[9]=$cod_sql[0]->cuenta_autoevaluacion;

//print_r($array);

return $array;
}

function SGD_DatosTablaResultadosPorEvaluado($id_empresa, $id_proceso, $sql_promedios_competencias) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sqlBK = "

select h.evaluado,


(select rut_completo from tbl_usuario where id_empresa='$id_empresa' and rut=h.evaluado) as RutEvaluado,

(select nombre_completo from tbl_usuario where rut= h.evaluado) as NombreEvaluado,
(select cargo from tbl_usuario where rut= h.evaluado) as CargoEvaluado,
(select gerencia from tbl_usuario where rut= h.evaluado) as GerenciaEvaluado,


(select nombre from tbl_sgd_dimensiones where id=h.id_dimension) as NombreDim,
(select evaluado from tbl_sgd_relaciones where evaluado=h.evaluado and id_proceso='$id_proceso') as Evaluado,

(select rut_completo from tbl_usuario where id_empresa='$id_empresa' and rut=(select evaluador from tbl_sgd_relaciones where evaluado=h.evaluado  and id_proceso='$id_proceso')) as RutEvaluador,

(select nombre_completo from tbl_usuario where rut= (select evaluador from tbl_sgd_relaciones where evaluado=h.evaluado  and id_proceso='$id_proceso')) as NombreEvaluador,
(select cargo from tbl_usuario where rut= (select evaluador from tbl_sgd_relaciones where evaluado=h.evaluado  and id_proceso='$id_proceso')) as CargoEvaluador,
(select gerencia from tbl_usuario where rut= (select evaluador from tbl_sgd_relaciones where evaluado=h.evaluado  and id_proceso='$id_proceso')) as GerenciaEvaluador,


(select descripcion_proceso from tbl_sgd_proceso_evaluacion where id_empresa='$id_empresa' and id_proceso=h.id_proceso) as Proceso,

(select descripcion from tbl_sgd_perfiles_ponderaciones where id_empresa='$id_empresa' and perfil=(select perfil_evaluacion_competencias from  tbl_sgd_relaciones  where evaluado=h.evaluado and id_empresa='$id_empresa' and id_proceso='$id_proceso') limit 1)
as Perfil,

(select perfil from tbl_sgd_subperfiles where id_empresa='$id_empresa' and id=h.subperfil) as NombreSubPerfil,

(select opcional from tbl_sgd_dimensiones where id=h.id_dimension) as DimOpcional,
h.evaluador, h.id_dimension,



$sql_promedios_competencias




round(avg(respuesta),2) as Puntaje ,
(select count(id) as cuenta from tbl_sgd_finalizados_evaluado_evaluador where evaluado=h.evaluado and evaluador=h.evaluador and id_proceso='$id_proceso') as Finalizado

from tbl_sgd_respuestas h

where (select count(id) as cuenta from tbl_sgd_finalizados_evaluado_evaluador where evaluado=h.evaluado and evaluador=h.evaluador and id_proceso='$id_proceso')>0
and (select evaluado from tbl_sgd_relaciones where evaluado=h.evaluado and id_proceso='$id_proceso')<>''

and h.id_proceso='$id_proceso'
and h.id_empresa='$id_empresa'
and h.id_pregunta is not null

group by h.id_dimension, h.evaluado

order by h.evaluador,h.evaluado, h.id_dimension





";

$sql = "SELECT
h.evaluado,
baseevaluado.rut_completo as RutEvaluado,
baseevaluado.nombre_completo as NombreEvaluado,
baseevaluado.gerencia as GerenciaEvaluado,
baseevaluado.cargo as CargoEvaluado,


baseevaluador.rut_completo as RutEvaluador,
baseevaluador.nombre_completo as NombreEvaluador,
baseevaluador.gerencia as GerenciaEvaluador,
baseevaluador.cargo as CargoEvaluador,


(select perfil from tbl_sgd_subperfiles where id_empresa='$id_empresa' and id=h.subperfil) as NombreSubPerfil,
(select opcional from tbl_sgd_dimensiones where id=h.id_dimension) as DimOpcional,
h.evaluador, h.id_dimension,
(select nombre from tbl_sgd_dimensiones where id=h.id_dimension) as NombreDim,
(select descripcion_proceso from tbl_sgd_proceso_evaluacion where id_empresa='$id_empresa' and id_proceso=h.id_proceso) as Proceso,

$sql_promedios_competencias


h.evaluador,
h.id_dimension,



(select round(avg(respuesta), 2) AS Puntaje from tbl_sgd_respuestas as res where res.evaluado=h.evaluado and res.evaluador=h.evaluado and res.id_proceso=h.id_proceso and res.id_objetivo is null) as nota_comp_ae,

round(avg(respuesta), 2) AS Puntaje,
(        SELECT            count(id) AS cuenta        FROM            tbl_sgd_finalizados_evaluado_evaluador        WHERE            evaluado = h.evaluado        AND evaluador = h.evaluador        AND id_proceso = '112'    ) AS Finalizado

FROM
tbl_sgd_respuestas h


inner join tbl_usuario as baseevaluado
on baseevaluado.rut=h.evaluado

inner join tbl_usuario as baseevaluador
on baseevaluador.rut=h.evaluador


WHERE
(
SELECT
count(id) AS cuenta
FROM
tbl_sgd_finalizados_evaluado_evaluador
WHERE
evaluado = h.evaluado
AND evaluador = h.evaluador
AND id_proceso = '$id_proceso'
) > 0
AND (
SELECT
evaluado
FROM
tbl_sgd_relaciones
WHERE
evaluado = h.evaluado
AND evaluador = h.evaluador
AND id_proceso = '$id_proceso'
) <> ''
AND h.id_proceso = '$id_proceso'
AND h.id_empresa = '$id_empresa'
AND h.id_pregunta IS NOT NULL
and h.evaluado<>h.evaluador
GROUP BY
h.id_dimension,
h.evaluado
ORDER BY
h.evaluador,
h.evaluado,
h.id_dimension";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function SGD_DatosTablaCalibracionPorEvaluado($id_empresa, $id_proceso) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
if ($id_empresa == "61") {
$sql = "
SELECT
(h.evaluado),
h.evaluador,
h.id_dimension,
round(avg(respuesta), 2) AS Puntaje,
(select rut_completo from tbl_usuario where id_empresa='61' and rut=h.evaluado) as RutEvaluado,
(select nombre_completo from tbl_usuario where rut= h.evaluado) as NombreEvaluado,

(select gerencia from tbl_usuario where rut= h.evaluado) as GerenciaEvaluado,
(select nombre from tbl_sgd_dimensiones where id=h.id_dimension) as NombreDim,
(select evaluado from tbl_sgd_relaciones where evaluado=h.evaluado and evaluado<>h.evaluador limit 1) as Evaluado,

(select rut_completo from tbl_usuario where id_empresa='61' and rut=(select evaluador from tbl_sgd_relaciones where evaluado=h.evaluado and evaluado<>h.evaluador limit 1)) as RutEvaluador,
(select nombre_completo from tbl_usuario where rut= (select evaluador from tbl_sgd_relaciones where evaluado=h.evaluado and evaluado<>h.evaluador limit 1)) as NombreEvaluador,
(select cargo from tbl_usuario where rut= (select evaluador from tbl_sgd_relaciones where evaluado=h.evaluado and evaluado<>h.evaluador limit 1)) as CargoEvaluador,

(select gerencia from tbl_usuario where rut= (select evaluador from tbl_sgd_relaciones where evaluado=h.evaluado and evaluado<>h.evaluador limit 1)) as GerenciaEvaluador,

(select nombre_completo from tbl_usuario where rut= (select validador from tbl_sgd_relaciones where evaluado=h.evaluado and evaluado<>h.evaluador limit 1)) as NombreValidador,




(select descripcion_proceso from tbl_sgd_proceso_evaluacion where id_empresa='61' and id_proceso=h.id_proceso) as Proceso,
(select perfil_evaluacion_competencias from  tbl_sgd_relaciones where evaluado=h.evaluado and id_empresa='61' and id_proceso='108' and evaluado<>h.evaluador limit 1) as IdPerfil

FROM
tbl_sgd_respuestas h
WHERE
h.id_proceso = '108'
AND h.id_empresa = '61'
AND h.evaluado <> h.evaluador
GROUP BY
h.id_dimension,
h.evaluado;





";
} else {

$sql = "
select
h.evaluado,
(select rut_completo from tbl_usuario where id_empresa='62' and rut=h.evaluado) as RutEvaluado,
(select nombre_completo from tbl_usuario where rut= h.evaluado) as NombreEvaluado,
(select cargo from tbl_usuario where rut= h.evaluado) as CargoEvaluado,
(select gerencia from tbl_usuario where rut= h.evaluado) as GerenciaEvaluado,
(select nombre from tbl_sgd_dimensiones where id=h.id_dimension) as NombreDim,
(select evaluado from tbl_sgd_relaciones where evaluado=h.evaluado and tbl_sgd_relaciones.id_proceso=$id_proceso_sgd;) as Evaluado,
(select rut_completo from tbl_usuario where id_empresa='62' and rut=(select evaluador from tbl_sgd_relaciones where evaluado=h.evaluado and tbl_sgd_relaciones.id_proceso=$id_proceso_sgd;)) as RutEvaluador,
(select nombre_completo from tbl_usuario where rut= (select evaluador from tbl_sgd_relaciones where evaluado=h.evaluado and tbl_sgd_relaciones.id_proceso=$id_proceso_sgd;)) as NombreEvaluador,
(select cargo from tbl_usuario where rut= (select evaluador from tbl_sgd_relaciones where evaluado=h.evaluado and tbl_sgd_relaciones.id_proceso=$id_proceso_sgd;)) as CargoEvaluador,
(select gerencia from tbl_usuario where rut= (select evaluador from tbl_sgd_relaciones where evaluado=h.evaluado and tbl_sgd_relaciones.id_proceso=$id_proceso_sgd;)) as GerenciaEvaluador,
(select nombre_completo from tbl_usuario where rut= (select validador from tbl_sgd_relaciones where evaluado=h.evaluado and tbl_sgd_relaciones.id_proceso=$id_proceso_sgd;)) as NombreValidador,
(select descripcion_proceso from tbl_sgd_proceso_evaluacion where id_empresa='62' and id_proceso=h.id_proceso) as Proceso,
(select perfil_evaluacion_competencias from tbl_sgd_relaciones where evaluado=h.evaluado and id_empresa='62' and id_proceso=$id_proceso_sgd;) as IdPerfil,
(select descripcion from tbl_sgd_perfiles_ponderaciones where id_empresa='62' and perfil=(select perfil_evaluacion_competencias from tbl_sgd_relaciones where evaluado=h.evaluado and id_empresa='62' and id_proceso=$id_proceso_sgd;) limit 1) as Perfil,
(select perfil from tbl_sgd_subperfiles where id_empresa='62' and id=h.subperfil) as NombreSubPerfil,
(select opcional from tbl_sgd_dimensiones where id=h.id_dimension) as DimOpcional,
h.evaluador, h.id_dimension, round(avg(respuesta),2) as Puntaje,
(select count(id) as cuenta from tbl_sgd_finalizados_evaluado_evaluador where evaluado=h.evaluado and evaluador=h.evaluador and tbl_sgd_finalizados_evaluado_evaluador.id_proceso=$id_proceso_sgd;) as Finalizado







from tbl_sgd_respuestas h

where
(select count(id) as cuenta from tbl_sgd_finalizados_evaluado_evaluador where evaluado=h.evaluado and evaluador=h.evaluador)>0 and
(select evaluado from tbl_sgd_relaciones where evaluado=h.evaluado and tbl_sgd_relaciones.id_proceso=$id_proceso_sgd;)<>''
and h.id_proceso=$id_proceso_sgd;
and h.id_empresa='62'


group by h.id_dimension, h.evaluado

order by (select nombre_completo from tbl_usuario where rut= (select evaluador from tbl_sgd_relaciones where evaluado=h.evaluado and tbl_sgd_relaciones.id_proceso=$id_proceso_sgd;)),
(select rut_completo from tbl_usuario where id_empresa='62' and rut=h.evaluado)


";
}

//echo $sql;
//echo "<br><br>";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//print_r($cod);
return $cod;
}

function TraeDiasEstadisticas($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select fecha from tbl_log_sistema where fecha>='2017-05-01' and id_empresa='$id_empresa' group by fecha ";

//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TraeDiasEstadisticasFechas($id_empresa, $fi, $ft) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$querrFI = "";
$querrFT = "";
if ($fi != '') {$querrFI = " and fecha >='$fi'";}
if ($ft != '') {$querrFT = " and fecha <='$ft'";}

$sql = "select fecha from tbl_log_sistema where  id_empresa='$id_empresa' $querrFI $querrFT group by fecha ";

//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function MPTraeInteraccionesPorDia($fecha, $id_empresa, $tipo_interaccion) {
global $c_host, $c_user, $c_pass, $c_db;

if ($tipo_interaccion == "VISITA") {$query_unica = " and (h.tipo='VISITA' or h.tipo='VISITA_VIDEO') ";} elseif ($tipo_interaccion == "COMENTARIO") {$query_unica = " and (h.tipo='COMENTARIO' or h.tipo='COMENTARIO_REPLAY') ";} elseif ($tipo_interaccion == "MEGUSTA") {$query_unica = " and (h.tipo='MEGUSTA' or h.tipo='MEGUSTA_POST') ";} elseif ($tipo_interaccion != "0" AND $tipo_interaccion != "VISITA" AND $tipo_interaccion != "COMENTARIO" AND $tipo_interaccion != "MEGUSTA") {
$query_unica = " and h.tipo='$tipo_interaccion'";} ELSE {
$query_unica = "";
}

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "  select
h.fecha as FechaInt,
h.tipo as tipoInteraccion,

(select categoria from tbl_mp_categorias where id_categoria=h.contenido limit 1) as GrupoSeguido,
(select categoria from tbl_mp_aptitudes where id_categoria=h.contenido limit 1) as Aptitud,
h.contenido as contenido,
h.mensaje as mensaje,

h.id_mp as id_post,
(select nombre from tbl_mp where id_mp=h.id_mp limit 1) As TituloPost,
(select rut from tbl_mp where id_mp=h.id_mp limit 1) As RutAutor,
(select nombre_completo from tbl_usuario where rut=(select rut from tbl_mp where id_mp=h.id_mp limit 1) limit 1) As NombreAutor,
(select cargo from tbl_usuario where rut=(select rut from tbl_mp where id_mp=h.id_mp limit 1) limit 1) As AutorCargo,
(select email from tbl_usuario where rut=(select rut from tbl_mp where id_mp=h.id_mp limit 1) limit 1) As AutorEmail,
(select gerencia from tbl_usuario where rut=(select rut from tbl_mp where id_mp=h.id_mp limit 1) limit 1) As AutorGerencia,
(select gerenciaR2 from tbl_usuario where rut=(select rut from tbl_mp where id_mp=h.id_mp limit 1) limit 1) As AutorGerenciaR2,
(select gerenciaR3 from tbl_usuario where rut=(select rut from tbl_mp where id_mp=h.id_mp limit 1) limit 1) As AutorGerenciaR3,



(select tipo from tbl_mp where id_mp=h.id_mp limit 1 ) As TipoPost,
(select id_subcategoria from tbl_mp where id_mp=h.id_mp limit 1 ) As id_GrupoIntPost,
(select nombre from tbl_emb_olas where codigo=(select id_subcategoria from tbl_mp where id_mp=h.id_mp limit 1 ) limit 1 ) As GrupoIntPost,

h.rut as RUTcolaborador,
(select nombre_completo from tbl_usuario where rut=h.rut limit 1 ) As ColNombre,
(select cargo from tbl_usuario where rut=h.rut limit 1 ) As ColCargo,
(select email from tbl_usuario where rut=h.rut limit 1 ) As ColEmail,
(select gerencia from tbl_usuario where rut=h.rut limit 1 ) As ColGerencia,
(select gerenciaR2 from tbl_usuario where rut=h.rut limit 1 ) As ColGerenciaR2,
(select gerenciaR3 from tbl_usuario where rut=h.rut limit 1 ) As ColGerenciaR3,

h.rut_remitente as RUTremitente,
(select nombre_completo from tbl_usuario where rut=h.rut_remitente limit 1 ) As RemNombre,
(select cargo from tbl_usuario where rut=h.rut_remitente limit 1 ) As RemCargo,
(select email from tbl_usuario where rut=h.rut_remitente limit 1 ) As RemEmail,
(select gerencia from tbl_usuario where rut=h.rut_remitente limit 1 ) As RemGerencia,
(select gerenciaR2 from tbl_usuario where rut=h.rut_remitente limit 1 ) As RemGerenciaR2,
(select gerenciaR3 from tbl_usuario where rut=h.rut_remitente limit 1 ) As RemGerenciaR3

from tbl_mp_interacciones h

where h.fecha='$fecha' and h.tipo<>'FAVORITA' AND h.tipo<>'DESCARGA'
$query_unica

";
// echo $sql; exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function ReportesValidaCodigoImparticion($codigo) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select count(id) as cuenta from tbl_inscripcion_curso where codigo_inscripcion='$codigo' ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function MPTraePostPorDia($fecha, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select
h.fecha as FechaInt,

'PUBLICACION_POST' as tipoInteraccion,

(select categoria from tbl_mp_categorias where id_categoria=h.contenido) as GrupoSeguido,
(select categoria from tbl_mp_aptitudes where id_categoria=h.contenido) as Aptitud,
h.id_ambito as mensaje,

h.id_mp as id_post,

(select nombre from tbl_mp where id_mp=h.id_mp) As TituloPost,
(select rut from tbl_mp where id_mp=h.id_mp) As RutAutor,
(select nombre_completo from tbl_usuario where rut=(select rut from tbl_mp where id_mp=h.id_mp)) As NombreAutor,
(select cargo from tbl_usuario where rut=(select rut from tbl_mp where id_mp=h.id_mp)) As AutorCargo,
(select email from tbl_usuario where rut=(select rut from tbl_mp where id_mp=h.id_mp)) As AutorEmail,
(select gerencia from tbl_usuario where rut=(select rut from tbl_mp where id_mp=h.id_mp)) As AutorGerencia,
(select gerenciaR2 from tbl_usuario where rut=(select rut from tbl_mp where id_mp=h.id_mp)) As AutorGerenciaR2,
(select gerenciaR3 from tbl_usuario where rut=(select rut from tbl_mp where id_mp=h.id_mp)) As AutorGerenciaR3,

(select tipo from tbl_mp where id_mp=h.id_mp) As TipoPost,
(select id_categoria from tbl_mp where id_mp=h.id_mp) As id_GrupoIntPost,
(select categoria from tbl_mp_categorias where id_categoria=(select id_categoria from tbl_mp where id_mp=h.id_mp)) As GrupoIntPost,

h.rut as RUTcolaborador,
(select nombre_completo from tbl_usuario where rut=h.rut) As ColNombre,
(select cargo from tbl_usuario where rut=h.rut) As ColCargo,
(select email from tbl_usuario where rut=h.rut) As ColEmail,
(select gerencia from tbl_usuario where rut=h.rut) As ColGerencia,
(select gerenciaR2 from tbl_usuario where rut=h.rut) As ColGerenciaR2,
(select gerenciaR3 from tbl_usuario where rut=h.rut) As ColGerenciaR3,

'' as RUTremitente,
'' As RemNombre,
(select cargo from tbl_usuario where rut=h.id_ambito) As RemCargo,
(select email from tbl_usuario where rut=h.id_ambito) As RemEmail,
(select gerencia from tbl_usuario where rut=h.id_ambito) As RemGerencia,
(select gerenciaR2 from tbl_usuario where rut=h.id_ambito) As RemGerenciaR2,
(select gerenciaR3 from tbl_usuario where rut=h.id_ambito) As RemGerenciaR3

from tbl_mp h where h.fecha='$fecha'";

// echo "<br><br>$sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function MPTraeAceptaCondicionesPorDia($fecha, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select
h.fecha as FechaInt,

'ACEPTA_CONDICIONES' as tipoInteraccion,

'' as GrupoSeguido,
'' as Aptitud,
''  as mensaje,

'' as id_post,

'' As TituloPost,
'' As RutAutor,
'' As NombreAutor,
'' As AutorCargo,
'' As AutorEmail,
''As AutorGerencia,
''As AutorGerenciaR2,
'' As AutorGerenciaR3,

'' As TipoPost,
'' As id_GrupoIntPost,
'' As GrupoIntPost,

h.rut as RUTcolaborador,
(select nombre_completo from tbl_usuario where rut=h.rut) As ColNombre,
(select cargo from tbl_usuario where rut=h.rut) As ColCargo,
(select email from tbl_usuario where rut=h.rut) As ColEmail,
(select gerencia from tbl_usuario where rut=h.rut) As ColGerencia,
(select gerenciaR2 from tbl_usuario where rut=h.rut) As ColGerenciaR2,
(select gerenciaR3 from tbl_usuario where rut=h.rut) As ColGerenciaR3,

'' as RUTremitente,
'' As RemNombre,
'' As RemCargo,
'' As RemEmail,
'' As RemGerencia,
'' As RemGerenciaR2,
'' As RemGerenciaR3

from tbl_banner_visto h where h.fecha='$fecha' AND h.ambiente='com_mp_personal'";

//echo "<br><br>MPTraeAceptaCondicionesPorDia $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function MPTraeFotoMensajeDia($fecha, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select
h.fecha as FechaInt,

'FOTO_MENSAJE' as tipoInteraccion,
'' as GrupoSeguido,
'' as Aptitud,
h.mensaje  as mensaje,
h.id as id_post,

h.foto As TituloPost,
'' As RutAutor,
'' As NombreAutor,
'' As AutorCargo,
'' As AutorEmail,
''As AutorGerencia,
''As AutorGerenciaR2,
'' As AutorGerenciaR3,

h.grupo As TipoPost,


IF(h.id_empresa='99', 'DESPUBLICADA', '' ) As id_GrupoIntPost,
'' As GrupoIntPost,

h.rut as RUTcolaborador,
(select nombre_completo from tbl_usuario where rut=h.rut) As ColNombre,
(select cargo from tbl_usuario where rut=h.rut) As ColCargo,
(select email from tbl_usuario where rut=h.rut) As ColEmail,
(select gerencia from tbl_usuario where rut=h.rut) As ColGerencia,
(select gerenciaR2 from tbl_usuario where rut=h.rut) As ColGerenciaR2,
(select gerenciaR3 from tbl_usuario where rut=h.rut) As ColGerenciaR3,

'' as RUTremitente,
'' As RemNombre,
'' As RemCargo,
'' As RemEmail,
'' As RemGerencia,
'' As RemGerenciaR2,
'' As RemGerenciaR3 ,
(select count(id) from tbl_mp_interacciones where id_mp=CONCAT('62_gpw_', h.id) and tipo like 'MEGUSTA%') as megusta


from tbl_mp_fotomensaje h where h.fecha='$fecha'";

//echo "MPTraeFotoMensajeDia $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}


function MPTraeLogueosPorDia($fecha, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select
h.fecha as FechaInt,

'LOGIN' as tipoInteraccion,
h.rut as Rut,


(SELECT count(id) FROM tbl_log_sistema WHERE ambiente LIKE '%com_mp%' and rut=h.rut and fecha=h.fecha) as cuenta


from tbl_analitica h


where h.fecha='$fecha' and h.rut<>'' and h.ambiente='LOGIN'
and (SELECT count(id) FROM tbl_log_sistema WHERE ambiente LIKE '%com_mp%' and rut=h.rut and fecha=h.fecha) >0

";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function DatosObjetoEncuestaPorImparticion($id_inscripcion) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_objeto where id_curso='$id_inscripcion' and tipo_objeto='6'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function ParticipantesPorInscripcion($id_empresa, $id_inscripcion) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * , tbl_usuario.nombre_completo as nombre,

tbl_usuario.nombre as nombrepila,
tbl_usuario.apaterno as apaterno,
tbl_usuario.amaterno as amaterno,

tbl_usuario.rut_completo as rut_completo, tbl_usuario.rut_completo, tbl_usuario.cargo,


tbl_usuario.gerencia as c1,
tbl_usuario.gerenciaR2 as c2,
tbl_usuario.gerenciaR3 as c3



from tbl_inscripcion_usuarios h

inner join tbl_usuario
on tbl_usuario.rut=h.rut
where h.id_empresa='$id_empresa'  and h.id_inscripcion='$id_inscripcion'   group by h.rut
order by tbl_usuario.apaterno asc";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function SelectInactivoNoTblusuario($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "


select h.*,
(select rut from tbl_usuario where rut=h.rut)

from tbl_lms_reportes h

where h.nombre='USUARIO_INACTIVO'
and (select rut from tbl_usuario where rut=h.rut) is null
group by h.rut    ";

$database->setquery($sql);
$database->query();

$cod = $database->listObjects();

return $cod;
}

function SelectInactivoNoTbRelMallPersona($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "

select h.*,
(select rut from tbl_usuario where rut=h.rut)

from tbl_lms_reportes h

where h.nombre='USUARIO_INACTIVO'
and (select rut from rel_lms_malla_persona where rut=h.rut and id_malla=h.id_malla) is null

group by h.rut, h.id_malla
";

$database->setquery($sql);
$database->query();

$cod = $database->listObjects();

return $cod;
}

function insertRelLmsMallaUsuarioInactivo($rut, $id_malla, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "INSERT INTO rel_lms_malla_persona (rut, id_malla,  id_empresa) " .
"VALUES ('$rut', '$id_malla','$id_empresa');";
//echo $sql;
//exit();

$database->setquery($sql);
$database->query();
}

function insertTblUsuarioInactivo($rut, $id_malla, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "INSERT INTO tbl_usuario (rut, rut_completo, nombre, nombre_completo, id_empresa, vigencia) " .
"VALUES ('$rut', '$rut','USUARIO INACTIVO', 'USUARIO INACTIVO', '$id_empresa',  '1');";
//echo $sql;
//exit();

$database->setquery($sql);
$database->query();
}

function SGD_ActualizoSoloEvaluador($id_empresa, $id_proceso, $evaluado, $evaluador) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "

update tbl_sgd_relaciones set
evaluador='$evaluador'          where evaluado='$evaluado' and id_empresa='$id_empresa' and id_proceso='$id_proceso'    ";
//echo $sql;Exit;
$database->setquery($sql);
$database->query();
}

function RELATOR_ENC_CuentaDeRespuestasPorPregunta_7opciones_CriterioCH($id_empresa, $id_encuesta, $id_pregunta, $array_objetos, $criterio, $rut_relator) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$cuenta_arreglo = count($array_objetos);

if ($cuenta_arreglo == 1) {
$id_objeto = $array_objetos[0]->id;
$query_arreglo_objeto = " and id_objeto='$id_objeto' ";
}
if ($cuenta_arreglo > 1) {
$query_arreglo_objetoI = " and ( ";
foreach ($array_objetos as $array_objeto) {
$query_arreglo_objetoM .= " id_objeto='" . $array_objeto->id . "' OR ";
}

$query_arreglo_objetoF = " id<>id) ";
$query_arreglo_objeto = $query_arreglo_objetoI . $query_arreglo_objetoM . $query_arreglo_objetoF;
}

$sql = "            select count(h.id) as cuenta,

(select count(id) from tbl_enc_satis_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and rut_relator='$rut_relator' and respuesta='1') as cuenta1,
(select count(id) from tbl_enc_satis_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and rut_relator='$rut_relator' and respuesta='2') as cuenta2,
(select count(id) from tbl_enc_satis_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and rut_relator='$rut_relator' and respuesta='3') as cuenta3,
(select count(id) from tbl_enc_satis_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and rut_relator='$rut_relator' and respuesta='4') as cuenta4,
(select count(id) from tbl_enc_satis_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and rut_relator='$rut_relator' and respuesta='5') as cuenta5,
(select count(id) from tbl_enc_satis_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and rut_relator='$rut_relator' and respuesta='6') as cuenta6,
(select count(id) from tbl_enc_satis_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and rut_relator='$rut_relator' and respuesta='7') as cuenta7,
(select count(id) from tbl_enc_satis_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta'  and rut_relator='$rut_relator' ) as cuentaPreg

from tbl_enc_satis_respuestas h

where h.id_empresa='$id_empresa'
and h.id_encuesta='$id_encuesta'
and h.id_objeto='$id_objeto'
and h.id_pregunta='$id_pregunta'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DistinctRelatoresPorImparticion($id_empresa, $codigo_imparticion) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$datos_empresa = DatosEmpresa($id_empresa);
$sql = "select distinct(relator) as relator, tbl_usuario.nombre_completo
from rel_lms_inscripcion_sesion
inner join tbl_usuario
on relator=tbl_usuario.rut

where codigo_inscripcion='$codigo_imparticion' and rel_lms_inscripcion_sesion.id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function BorrarUsuariosPorEmpresa2($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "delete from tbl_usuario where id_empresa='$id_empresa'";
$database->setquery($sql);
$database->query();
//    echo $sql;
//    exit();
}

function SGD_delete_validacion_equipo($id) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "delete from tbl_sgd_validacion_equipo where id='$id'";
//echo $sql;
//sleep(10);
$database->setquery($sql);
$database->query();
//    echo $sql;
//    exit();
}

function SGD_update_validacion_equipo($id, $id_estado) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($id_estado == 2) {
$sql = "update tbl_sgd_validacion_equipo set estado='22' where id='$id'";
}

if ($id_estado == 3) {
$sql = "update tbl_sgd_validacion_equipo set estado='33' where id='$id'";
}

if ($id_estado == 4) {
$sql = "update tbl_sgd_validacion_equipo set estado='44' where id='$id'";
}

if ($id_estado == 1) {
$sql = "update tbl_sgd_validacion_equipo set estado='11' where id='$id'";
}
//echo $sql;
//sleep(10);

$database->setquery($sql);
$database->query();
//    echo $sql;
//    exit();
}

function BuscaDatosValidacionEquipo($id) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_sgd_validacion_equipo where id='$id'";
//echo $sql;
//

//

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

if ($cod[0]->estado == 2) {
}

if ($cod[0]->estado == 3) {
}

if ($cod[0]->estado == 4) {
}

return $cod;
}

function InsertaConQuery($sql) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$database->setquery($sql);
$database->query();
}

function DatosTablaUsuarioPorEmpresa2($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_usuario where id_empresa='$id_empresa' and vigencia='0'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DatosSesionDadoId($id_sesion) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "    select     * from rel_lms_inscripcion_sesion  where id='$id_sesion' ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}



function VerificoSiEstaEnInscripcionUsuario($codigo_inscripcion, $rut, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_inscripcion_usuarios where id_inscripcion='$codigo_inscripcion' and rut='$rut' and id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function InsertaRegistroCheckinSesionImparticion($rut, $codigo_imparticion, $id_empresa, $fecha, $hora, $sesion) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO rel_lms_inscripcion_usuario_checkin(rut, codigo_imparticion, id_empresa, fecha, hora, relator, sesion) " .
"VALUES ('$rut', '$codigo_imparticion', '$id_empresa', '$fecha', '$hora', '0', '$sesion');";

$database->setquery($sql);
$database->query();
}

function BorroRegistrosInscritosCheckinPorSesionImparticion($codigo_imparticion, $id_empresa, $id_sesion) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "delete from rel_lms_inscripcion_usuario_checkin where id_empresa='$id_empresa' and codigo_imparticion='$codigo_imparticion' and sesion='$id_sesion'";

$database->setquery($sql);
$database->query();
}

function TraigoRegistrosPorSesionDeCheckin($codigo_inscripcion, $id_sesion, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from rel_lms_inscripcion_usuario_checkin where codigo_imparticion='$codigo_inscripcion' and sesion='$id_sesion' and id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ActualizarDatosSesionDeImparticion($fecha, $desde_am, $hasta_am, $desde_pm, $hasta_pm, $numero_horas, $relator, $codigo_inscripcion, $id_empresa, $id_Sesion) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE rel_lms_inscripcion_sesion  SET fecha= '$fecha', desde_am='$desde_am', hasta_am='$hasta_am', desde_pm='$desde_pm', hasta_pm='$hasta_pm', numero_horas='$numero_horas', relator='$relator'

WHERE codigo_inscripcion='$codigo_inscripcion' and id_empresa='$id_empresa' and id='$id_Sesion'";

$database->setquery($sql);
$database->query();
}

function FechaInicioTerminoImparticionPorEmpresa($codigo_inscripcion, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "SELECT
h.*, tbl_inscripcion_curso.id_curso,
tbl_lms_curso.nombre AS nombre_curso,
tbl_usuario.nombre_completo AS nombre_relator,
(
SELECT
count(*)
FROM
rel_lms_inscripcion_usuario_checkin
WHERE
rel_lms_inscripcion_usuario_checkin.id_empresa = '$id_empresa'
AND sesion = h.id
AND rel_lms_inscripcion_usuario_checkin.codigo_imparticion = h.codigo_inscripcion
) AS total_inscritos
FROM
rel_lms_inscripcion_sesion h
INNER JOIN tbl_inscripcion_curso ON tbl_inscripcion_curso.codigo_inscripcion = h.codigo_inscripcion
INNER JOIN tbl_lms_curso ON tbl_lms_curso.id = tbl_inscripcion_curso.id_curso
AND tbl_lms_curso.id_empresa = '$id_empresa'
LEFT JOIN tbl_usuario ON tbl_usuario.rut = h.relator
WHERE
h.codigo_inscripcion = '$codigo_inscripcion' order by h.fecha asc ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeComentariosPorEmpresaIdMP($id_mp, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.*,
(select rut_completo from tbl_usuario where rut=h.rut) as rut_completo,
(select nombre_completo from tbl_usuario where rut=h.rut) as nombre_completo,
(select cargo from tbl_usuario where rut=h.rut) as cargo,
(select gerencia from tbl_usuario where rut=h.rut) as gerencia



from tbl_mp_comentarios h where h.id_mp='$id_mp' and  h.comentario<>''";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ObtieneDatosProgramasPorEmpresa($id_programa, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select tbl_lms_programas_bbdd.* from tbl_lms_programas_bbdd where id_programa='$id_programa' and id_empresa='$id_empresa'     ";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function SabanaFijacion($id_empresa, $id_proceso) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$datos_empresa = DatosEmpresa($id_empresa);

if ($datos_empresa[0]->campo1) {
$c1_evaluador = " baseevaluador." . $datos_empresa[0]->campo1 . " as c1_evaluador, ";
$c1_evaluado = " tbl_usuario." . $datos_empresa[0]->campo1 . " as c1_evaluado, ";
}

if ($datos_empresa[0]->campo2) {
$c2_evaluador = " baseevaluador." . $datos_empresa[0]->campo2 . " as c2_evaluador, ";
$c2_evaluado = " tbl_usuario." . $datos_empresa[0]->campo2 . " as c2_evaluado, ";
}

if ($datos_empresa[0]->campo3) {
$c3_evaluador = " baseevaluador." . $datos_empresa[0]->campo3 . " as c3_evaluador, ";
$c3_evaluado = " tbl_usuario." . $datos_empresa[0]->campo3 . " as c3_evaluado, ";
}

$sql = "SELECT
tbl_usuario.nombre_completo as nombre_evaluado,
tbl_usuario.rut_completo as rut_evaluado,
tbl_usuario.cargo as cargo_evaluado,
baseevaluador.nombre_completo AS nombre_evaluador,
baseevaluador.rut_completo AS rut_evaluador,
baseevaluador.cargo AS cargo_evaluador,
tbl_objetivos_individuales.descripcion_objetivo,
tbl_objetivos_individuales.id as id_objetivo_ingresado,
tbl_objetivos_individuales.meta,
tbl_objetivos_metricas.metrica,
tbl_objetivos_individuales.comentarios as comentarios_objetivos,

dimension,
$c1_evaluador
$c2_evaluador
$c3_evaluador
$c1_evaluado
$c2_evaluado
$c3_evaluado
tbl_objetivos_dimension.nombre AS nombre_dimension,
tbl_objetivos_individuales.ponderacion,
tbl_objetivos_individuales.accion_clave,
tbl_sgd_respuestas.puntaje
FROM
tbl_objetivos_individuales

left join tbl_sgd_respuestas
on tbl_sgd_respuestas.id_objetivo=tbl_objetivos_individuales.id and tbl_sgd_respuestas.evaluado<>tbl_sgd_respuestas.evaluador


LEFT JOIN tbl_objetivos_metricas ON tbl_objetivos_metricas.id_metrica = tbl_objetivos_individuales.descripcion_objetivo
INNER JOIN tbl_usuario ON tbl_usuario.rut = tbl_objetivos_individuales.rut
INNER JOIN tbl_objetivos_dimension ON tbl_objetivos_dimension.id = tbl_objetivos_individuales.dimension
INNER JOIN tbl_sgd_relaciones ON tbl_sgd_relaciones.evaluado = tbl_objetivos_individuales.rut
and tbl_sgd_relaciones.id_proceso='$id_proceso'
AND tbl_sgd_relaciones.evaluado <> tbl_sgd_relaciones.evaluador
INNER JOIN tbl_usuario AS baseevaluador ON baseevaluador.rut = tbl_sgd_relaciones.evaluador
WHERE
tbl_objetivos_individuales.id_empresa = '$id_empresa' and
tbl_objetivos_individuales.id_proceso = '$id_proceso'

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function REPORTE_FIJACION_Evaluadores($id_empresa, $id_proceso, $arreglo_post) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$datos_empresa = DatosEmpresa($id_empresa);

if ($datos_empresa[0]->campo1) {
$c1_colaborador = " baseevaluador." . $datos_empresa[0]->campo1 . " as c1_evaluador, ";
$c1_evaluado = " baseevaluado." . $datos_empresa[0]->campo1 . " as c1_evaluado, ";
}

if ($datos_empresa[0]->campo2) {
$c2_colaborador = " baseevaluador." . $datos_empresa[0]->campo2 . " as c2_evaluador, ";
$c2_evaluado = " baseevaluado." . $datos_empresa[0]->campo2 . " as c2_evaluado, ";
}

if ($datos_empresa[0]->campo3) {
$c3_colaborador = " baseevaluador." . $datos_empresa[0]->campo3 . " as c3_evaluador, ";
$c3_evaluado = " baseevaluado." . $datos_empresa[0]->campo3 . " as c3_evaluado, ";
}

if ($arreglo_post["filtro_campo1"]) {
$filtro_campo1 .= " and baseevaluador." . $datos_empresa[0]->campo1 . " = '" . utf8_decode($arreglo_post["filtro_campo1"]) . "'";
}

if ($arreglo_post["filtro_campo2"]) {
$filtro_campo2 .= " and baseevaluador." . $datos_empresa[0]->campo2 . " = '" . utf8_decode($arreglo_post["filtro_campo2"]) . "'";
}

if ($arreglo_post["filtro_campo3"]) {
$filtro_campo3 .= " and baseevaluador." . $datos_empresa[0]->campo3 . " = '" . utf8_decode($arreglo_post["filtro_campo3"]) . "'";
}

$sql = "SELECT
baseevaluado.rut_completo as rut_evaluado,
baseevaluado.nombre_completo as nombre_evaluado,
baseevaluado.cargo as cargo_evaluado,
baseevaluado.gerencia as gerencia_evaluado,
baseevaluado.centro_costo as centro_costo_evaluado,


(select count(*) as total from tbl_objetivos_validaciones where tbl_objetivos_validaciones.evaluado=tbl_sgd_relaciones.evaluado and tbl_objetivos_validaciones.evaluador=tbl_sgd_relaciones.evaluador and tbl_objetivos_validaciones.id_proceso=tbl_sgd_relaciones.id_proceso) as total_dimensiones_finalizadas,
(select count(*) as total from tbl_objetivos_dimension where tbl_objetivos_dimension.id_empresa=tbl_sgd_relaciones.id_empresa) as total_dimensiones,


$c1_evaluado
$c2_evaluado
$c3_evaluado

baseevaluador.rut_completo as rut_evaluador,
baseevaluador.nombre_completo AS nombre_evaluador,
baseevaluador.cargo AS cargo_evaluador,
baseevaluador.gerencia AS gerencia_evaluador,
baseevaluador.centro_costo AS centro_costo_evaluador,
$c1_colaborador
$c2_colaborador
$c3_colaborador
(
SELECT
count(*)AS total
FROM
tbl_objetivos_individuales
WHERE
tbl_objetivos_individuales.rut = tbl_sgd_relaciones.evaluado and tbl_objetivos_individuales.id_proceso='$id_proceso'
)AS total_objetivos_ingresados,
(
SELECT
count(*)AS total
FROM
tbl_objetivos_indviduales_finalizado
WHERE
tbl_objetivos_indviduales_finalizado.evaluado = tbl_sgd_relaciones.evaluado
AND tbl_objetivos_indviduales_finalizado.evaluador = tbl_sgd_relaciones.evaluador
AND tbl_objetivos_indviduales_finalizado.id_proceso = tbl_sgd_relaciones.id_proceso
)AS total_finalizados
FROM
tbl_sgd_relaciones
INNER JOIN tbl_usuario AS baseevaluado ON baseevaluado.rut = tbl_sgd_relaciones.evaluado
INNER JOIN tbl_usuario AS baseevaluador ON baseevaluador.rut = tbl_sgd_relaciones.evaluador
WHERE
tbl_sgd_relaciones.id_proceso = '$id_proceso'
and baseevaluado.perfil_competencia<>'CyA'
$filtro_campo1
$filtro_campo2
$filtro_campo3



";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TRaeDatosRelADminPerfil($id_empresa, $rut, $tipo_filtro) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "SELECT *   FROM rel_admin_rut_perfil WHERE rut = '$rut' and id_empresa='$id_empresa' and tipo_filtro='$tipo_filtro'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeObjetosPorEmpresa($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$filtro_perfilado = FiltroPerfilado($_SESSION["admin_"], $id_empresa, "rel_lms_malla_curso");

$sql = "SELECT
tbl_objeto.*
FROM
tbl_objeto

left join rel_lms_malla_curso
on rel_lms_malla_curso.id_curso=tbl_objeto.id_curso

WHERE
tbl_objeto.id_empresa = '$id_empresa' $filtro_perfilado
order BY
tbl_objeto.titulo asc";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeObjetosCursosPorEmpresa($id_curso, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$filtro_perfilado = FiltroPerfilado($_SESSION["admin_"], $id_empresa, "rel_lms_malla_curso");

$sql = "SELECT
tbl_objeto.*
FROM
tbl_objeto

left join rel_lms_malla_curso
on rel_lms_malla_curso.id_curso=tbl_objeto.id_curso

WHERE
tbl_objeto.id_empresa = '$id_empresa' $filtro_perfilado
order BY
tbl_objeto.titulo asc";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function FechaInicioTerminoImparticion($codigo_inscripcion) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select  min(fecha) as inicio, max(fecha) as termino from rel_lms_inscripcion_sesion  h where h.codigo_inscripcion='$codigo_inscripcion'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function InsertaSesionPorImparticion($id_inscripcion, $id_empresa, $fecha, $hora_desde_am, $hora_hasta_am, $hora_desde_pm, $hora_hasta_pm, $numero_horas, $rut_relator) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO rel_lms_inscripcion_sesion(codigo_inscripcion, fecha, desde_am, hasta_am, desde_pm, hasta_pm, numero_horas, relator, id_empresa) " .
"VALUES ('$id_inscripcion', '$fecha', '$hora_desde_am', '$hora_hasta_am', '$hora_desde_pm', '$hora_hasta_pm', '$numero_horas', '$rut_relator', '$id_empresa');";

$database->setquery($sql);
$database->query();
}

function InsertaUsuarioMedicion($rut_colaborador, $rut_jefe, $id_medicion, $id_encuesta, $hoy, $id_empresa, $fecha_carga, $grupo) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "INSERT INTO tbl_enc_elearning_usuarios
(id_medicion, id_encuesta, rut, jefe, fecha, id_empresa, fecha_carga, grupo)
VALUES ('$id_medicion', '$id_encuesta', '$rut_colaborador','$rut_jefe', '$hoy', '$id_empresa','$fecha_carga', '$grupo');";
//echo $sql;
$database->setquery($sql);

if (!$database->query_error()) {
return $database->errores(mysql_error());
}
}

function InsertaRelacionMallaPersonaempresaOpcional($rut, $id_malla, $id_empresa, $opcional, $hoy, $id_programa, $multimalla) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql1 = "SELECT id from rel_lms_malla_persona where rut='$rut' and id_malla='$id_malla' and id_empresa='$id_empresa'
and opcional='$opcional' ";
$database->setquery($sql1);
$database->query();
$cod1 = $database->listObjects();
//echo $sql1;
$estaigual = count($cod1);

if ($estaigual > 0) {
//no hace nada
} else {

$sql2 = "SELECT h.id, h.id_malla,
(select id_programa from rel_lms_malla_curso where id_malla=h.id_malla limit 1)

from rel_lms_malla_persona h
where rut='$rut'

and  (select id_programa from rel_lms_malla_curso where id_malla=h.id_malla limit 1)='$id_programa' ";
//echo $sql2;
$database->setquery($sql2);
$database->query();
$cod2 = $database->listObjects();

$estaenprograma = count($cod2);

if ($estaenprograma > 0) {
//borra registro
if ($multimalla == "no") {
$sql3 = "delete h.*
from rel_lms_malla_persona h
where h.rut='$rut'
and  (select id_programa from rel_lms_malla_curso where id_malla=h.id_malla limit 1)='$id_programa'
";
// echo $sql3;
$database->setquery($sql3);
$database->query();
$cod3 = $database->listObjects();
}
}

$sql = "INSERT INTO rel_lms_malla_persona
(id_malla, rut, id_empresa, opcional)
VALUES ('$id_malla', '$rut', '$id_empresa', '$opcional');";
//echo $sql;
$database->setquery($sql);
if (!$database->query_error()) {
return $database->errores(mysql_error());
}
}

//echo "<br>".$sql; sleep(5);
}


function InsertaRelacionMallaPersonaempresaOpcionalI($rut, $id_malla, $id_empresa, $opcional, $hoy) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql1 = "SELECT id from rel_lms_malla_persona where rut='$rut' and id_malla='$id_malla' and id_empresa='$id_empresa'
and opcional='$opcional' ";
$database->setquery($sql1);
$database->query();
$cod1 = $database->listObjects();
//echo $sql1;
$estaigual = count($cod1);

if ($estaigual > 0) {
//no hace nada
} else {


//borra registro
$sql3 = "delete h.*
from rel_lms_malla_persona h
where h.rut='$rut'
and and id_malla='$id_malla'
";
// echo $sql3;
$database->setquery($sql3);
$database->query();
$cod3 = $database->listObjects();



$sql = "INSERT INTO rel_lms_malla_persona
(id_malla, rut, id_empresa, opcional)
VALUES ('$id_malla', '$rut', '$id_empresa', '$opcional');";
//echo $sql;
$database->setquery($sql);
if (!$database->query_error()) {
return $database->errores(mysql_error());
}
}

//echo "<br>".$sql; sleep(5);
}


function BorraRelacionInscripcionUsuarioMallaPersonaempresa($rut, $id_malla, $id_curso, $id_empresa, $hoy, $id_programa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$modalidad_curso = ModalidadCurso($id_curso, $id_empresa);

if ($modalidad_curso != 4) {
$sql = "delete h.* from tbl_inscripcion_usuarios h

where h.rut='$rut' and id_malla='$id_malla' and id_curso='$id_curso' and id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
}
}

function InsertaRelacionInscripcionUsuarioMallaPersonaempresa($rut, $id_malla, $id_curso, $id_empresa, $hoy, $id_programa, $multimalla, $fecha_inscripcion, $opcional_inscripcion) {

//echo "<br><h2>hola InsertaRelacionInscripcionUsuarioMallaPersonaempresa $rut, $id_malla, $id_curso, $id_empresa, $hoy, $id_programa, $multimalla, $fecha_inscripcion, opcional inscripcion $opcional_inscripcion</h2>";
//exit();
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($fecha_inscripcion == "") {$fecha_inscripcion = date("Y-m-d");}

$modalidad_idCurso = ModalidadCurso($id_curso, $id_empresa);
if ($modalidad_idCurso != '4') {
$sql_delete = "delete from tbl_inscripcion_usuarios WHERE     id_empresa = '$id_empresa' AND rut='$rut' and id_curso='$id_curso' and id_malla='$id_malla'";
$database->setquery($sql_delete);
$database->query();
}

$sql1 = "SELECT id from tbl_inscripcion_usuarios
where id_curso='$id_curso' and rut='$rut' and id_malla='$id_malla' and id_empresa='$id_empresa'";
$database->setquery($sql1);
$database->query();
$cod1 = $database->listObjects();
//echo "<br>sql1 ".$sql1;
$estaigual = count($cod1);

if ($estaigual > 0) {
//no hace nada
} else {

$sql2 = "SELECT h.id, h.id_curso, h.id_malla,
(select id_programa from rel_lms_malla_curso where id_malla=h.id_malla limit 1)

from tbl_inscripcion_usuarios h
where rut='$rut'

and  (select id_programa from rel_lms_malla_curso where id_malla=h.id_malla limit 1)='$id_programa' ";
//echo "<br>sql2 ".$sql2;
$database->setquery($sql2);
$database->query();
$cod2 = $database->listObjects();

$estaenprograma = count($cod2);

if ($estaenprograma > 0) {
if ($multimalla == "no") {
//borra registro
$sql3 = "delete h.*
from tbl_inscripcion_usuarios h
where h.rut='$rut'
and h.id_curso='$id_curso'

";
//    echo "<br>sql3 ".$sql3;
$database->setquery($sql3);
$database->query();
$cod3 = $database->listObjects();
}
}

$modalidad_idCurso = ModalidadCurso($id_curso, $id_empresa);

$sqlOp = "SELECT opcional from rel_lms_malla_curso
where id_curso='$id_curso' and id_malla='$id_malla' and id_programa='$id_programa' and id_empresa='$id_empresa' limit 1";
$database->setquery($sqlOp);
$database->query();
$codOp = $database->listObjects();
//echo "<br>sql1 ".$sql1$
$curso_opcional = $codOp[0]->opcional;
if ($curso_opcional == "") {$curso_opcional = 0;}

if($opcional_inscripcion=="Si"){
$curso_opcional = "1";
}
// echo "<h1>opcional_inscripcion $opcional_inscripcion</h1>";

// exit();

if ($modalidad_idCurso != '4') {
$sqlIYU = "INSERT INTO tbl_inscripcion_usuarios
(id_malla, id_curso, id_inscripcion,  rut, id_empresa, fecha)
VALUES ('$id_malla', '$id_curso', '$id_curso', '$rut', '$id_empresa', '$fecha_inscripcion');";
//echo "<br>-----INSERT INTO tbl_inscripcion_usuarios  $sql";

$database->setquery($sqlIYU);
$database->query();

// verifica que esta en reportes
$sqlLmR = "SELECT id from tbl_lms_reportes
where id_curso='$id_curso' and id_malla='$id_malla' and id_programa='$id_programa' and id_empresa='$id_empresa' and rut='$rut' limit 1";
$database->setquery($sqlLmR);
$database->query();
$estaenLmsReportes = $database->listObjects();
if ($estaenLmsReportes[0]->id == "") {
$sql = "INSERT INTO tbl_lms_reportes
(rut, id_curso, id_malla, id_programa, id_empresa, curso_opcional, avance, estado)
VALUES ('$rut', '$id_curso', '$id_malla', '$id_programa', '$id_empresa', '$curso_opcional','0', 'NO_INICIADO' );";
// echo "<br>tbl_lms_reportes -----INSERT INTO, $sql";    sleep(1);

$database->setquery($sql);
$database->query();
}
}
}

//echo "<br>InsertaRelacionInscripcionUsuarioMallaPersonaempresa<br><br>";echo "$sql"; sleep(5);
}
function buscaUltimaFechaFull(){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql_usuarios_novigentes = "select fecha from tbl_lms_reporte_full  where fecha<>'0000-00-00' order by fecha DESC limit 1";
$database->setquery($sql_usuarios_novigentes);
$database->query();
$cod = $database->listObjects();

return $cod[0]->fecha;

}
function UsuarioVigente($rut){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql_usuarios_novigentes = "select id from tbl_usuario where rut='$rut' and vigencia='0'";
$database->setquery($sql_usuarios_novigentes);
$database->query();
$cod = $database->listObjects();

return $cod[0]->id;
}


function InsertaRelacionInscripcionUsuarioMallaPersonaempresaI($rut, $id_programa,$id_malla, $id_inscripcion, $id_curso, $id_empresa, $hoy, $fecha_inscripcion) {

//echo "<br>hola InsertaRelacionInscripcionUsuarioMallaPersonaempresa $id_curso";

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($fecha_inscripcion == "") {$fecha_inscripcion = date("Y-m-d");}

$modalidad_idCurso = ModalidadCurso($id_curso, $id_empresa);
if ($modalidad_idCurso != '4') {
$sql_delete = "delete from tbl_inscripcion_usuarios WHERE     id_empresa = '$id_empresa' AND rut='$rut' and id_curso='$id_curso' and id_malla='$id_malla'";
$database->setquery($sql_delete);
$database->query();
}

$sql1 = "SELECT id from tbl_inscripcion_usuarios
where id_curso='$id_curso' and rut='$rut' and id_malla='$id_malla' and id_empresa='$id_empresa'";
$database->setquery($sql1);
$database->query();
$cod1 = $database->listObjects();
// echo "<br>sql1 ".$sql1;
$estaigual = count($cod1);

if ($estaigual > 0) {
//no hace nada
} else {



$modalidad_idCurso = ModalidadCurso($id_curso, $id_empresa);

$sqlOp = "SELECT opcional from rel_lms_malla_curso
where id_curso='$id_curso' and id_malla='$id_malla' and id_programa='$id_programa' and id_empresa='$id_empresa' limit 1";
$database->setquery($sqlOp);
$database->query();
$codOp = $database->listObjects();
//echo "<br>sql1 ".$sql1$
$curso_opcional = $codOp[0]->opcional;
if ($curso_opcional == "") {$curso_opcional = 0;}

if ($modalidad_idCurso != '4') {
$sqlIYU = "INSERT INTO tbl_inscripcion_usuarios
(id_malla, id_curso, id_inscripcion,  rut, id_empresa, fecha)
VALUES ('$id_malla', '$id_curso', '$id_inscripcion', '$rut', '$id_empresa', '$fecha_inscripcion');";
//  echo "<br>-----INSERT INTO tbl_inscripcion_usuarios  $sql";

$database->setquery($sqlIYU);
$database->query();

// verifica que esta en reportes
$sqlLmR = "SELECT id from tbl_lms_reportes
where id_curso='$id_curso' and id_malla='$id_malla' and id_programa='$id_programa' and id_empresa='$id_empresa' and rut='$rut' and id_inscripcion='$id_inscripcion' limit 1";
$database->setquery($sqlLmR);
$database->query();
//echo "<br>LMS&nbsp;REPORTES";
// echo $sqlLmR;
$estaenLmsReportes = $database->listObjects();
//print_r($estaenLmsReportes);
if ($estaenLmsReportes[0]->id == "") {
$sql = "INSERT INTO tbl_lms_reportes
(rut, id_curso, id_malla, id_programa, id_empresa, curso_opcional, avance, estado, id_inscripcion)
VALUES ('$rut', '$id_curso', '$id_malla', '$id_programa', '$id_empresa', '$curso_opcional','0', 'NO_INICIADO','$id_inscripcion' );";
//  echo "<br>tbl_lms_reportes -----INSERT INTO, $sql";

$database->setquery($sql);
$database->query();
}
}
}

//echo "<br>InsertaRelacionInscripcionUsuarioMallaPersonaempresa<br><br>";echo "$sql"; sleep(5);
}

function ActualizaDatosLmsReportesUsuarios_data($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select tbl_lms_reportes.rut, tbl_lms_reportes.id_empresa,
(select campo1 from tbl_empresa where id=tbl_lms_reportes.id_empresa) as c1,
(select campo2 from tbl_empresa where id=tbl_lms_reportes.id_empresa) as c2,
(select campo3 from tbl_empresa where id=tbl_lms_reportes.id_empresa) as c3,
(select campo4 from tbl_empresa where id=tbl_lms_reportes.id_empresa) as c4

from tbl_lms_reportes

where tbl_lms_reportes.nombre is null  and  tbl_lms_reportes.id_empresa='$id_empresa'


group by tbl_lms_reportes.rut";

//echo "<br><br>ActualizaDatosLmsReportesUsuarios_data <br>$sql";  sleep(1);

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
foreach ($cod as $unico) {
$sql_us = "update tbl_lms_reportes set
nombre=(select nombre_completo from tbl_usuario where rut='" . $unico->rut . "'),
cargo=(select cargo from tbl_usuario where rut='" . $unico->rut . "'),
email=(select email from tbl_usuario where rut='" . $unico->rut . "'),
c1=(select " . $unico->c1 . " from tbl_usuario where rut='" . $unico->rut . "'),
c2=(select " . $unico->c2 . " from tbl_usuario where rut='" . $unico->rut . "'),
c3=(select " . $unico->c3 . " from tbl_usuario where rut='" . $unico->rut . "'),
c4=(select " . $unico->c4 . " from tbl_usuario where rut='" . $unico->rut . "')
where rut='" . $unico->rut . "'";

//       echo "<br><br>... cada uno ActualizaDatosLmsReportesUsuarios_data <br>$sql_us";  sleep(1);
$database->setquery($sql_us);
$database->query();
}

//echo "<br>ActualizaDatosLmsReportesUsuarios_data BORRA ";

$sql_usuarios_novigentes = "delete from tbl_lms_reportes where nombre is null";
$database->setquery($sql_usuarios_novigentes);
$database->query();
}

function BorrarUsuarioMedicion($id_empresa, $id_medicion) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$database->setquery($sql);
$database->query();

$sql = "delete from tbl_enc_elearning_usuarios WHERE  id_empresa = '$id_empresa' AND id_medicion='$id_medicion'";

$database->setquery($sql);
$database->query();
}

function BorroRelacionesMallaPersonaPorempresaYPrograma($id_empresa, $mallas) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$filtro_mallas = "";
$i = 1;

foreach ($mallas as $mall) {
$filtro_mallas .= " id_malla='" . trim($mall->id_malla) . "'";
if ($i < count($mallas)) {
$filtro_mallas .= " or ";
}
$i++;
}

if ($filtro_mallas != '') {
$sql = "delete from rel_lms_malla_persona WHERE     rel_lms_malla_persona.id_empresa = '$id_empresa' AND ( $filtro_mallas)";

// echo $sql;

$database->setquery($sql);
$database->query();
//exit();
//    $sql = "delete from tbl_inscripcion_usuarios WHERE     id_empresa = '$id_empresa' AND ( $filtro_mallas )";
//echo $sql; sleep(5);
//    $database->setquery($sql);
//    $database->query();
}
}

function UsuariosPorEmpresa($id_empresa, $mallas) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$filtro_mallas = "";
$i = 1;

foreach ($mallas as $mall) {
$filtro_mallas .= " id_malla='" . $mall->id_malla . "'";
if ($i < count($mallas)) {
$filtro_mallas .= " or ";
}
$i++;
}

$datos_empresa = DatosEmpresa($id_empresa);

if ($datos_empresa[0]->campo1) {
$c1_colaborador = " tbl_usuario." . $datos_empresa[0]->campo1 . " as c1_colaborador, ";
}

if ($datos_empresa[0]->campo2) {
$c2_colaborador = " tbl_usuario." . $datos_empresa[0]->campo2 . " as c2_colaborador, ";
}

if ($datos_empresa[0]->campo3) {
$c3_colaborador = " tbl_usuario." . $datos_empresa[0]->campo3 . " as c3_colaborador, ";
}

$sql = " select rut, nombre_completo, cargo, email,
(select id_malla from rel_lms_malla_persona where rel_lms_malla_persona.id_empresa='$id_empresa' and  rel_lms_malla_persona.rut=tbl_usuario.rut and ($filtro_mallas) limit 1 ) as id_malla

from tbl_usuario where id_empresa='$id_empresa'

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function totalUsuariosPorProgramaConMallasTblUsuario($id_empresa, $mallas) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$filtro_mallas = "";
$i = 1;

$datos_empresa = DatosEmpresa($id_empresa);

if ($datos_empresa[0]->campo1) {
$c1_colaborador = " tbl_usuario." . $datos_empresa[0]->campo1 . " as c1_colaborador, ";
}

if ($datos_empresa[0]->campo2) {
$c2_colaborador = " tbl_usuario." . $datos_empresa[0]->campo2 . " as c2_colaborador, ";
}

if ($datos_empresa[0]->campo3) {
$c3_colaborador = " tbl_usuario." . $datos_empresa[0]->campo3 . " as c3_colaborador, ";
}

foreach ($mallas as $mall) {
$filtro_mallas .= " id_malla='" . $mall->id_malla . "'";
if ($i < count($mallas)) {
$filtro_mallas .= " or ";
}
$i++;
}

$sql = "  SELECT
rel_lms_malla_persona.*, tbl_usuario.nombre_completo, $c1_colaborador $c2_colaborador $c3_colaborador tbl_usuario.cargo,
tbl_lms_malla.nombre as nombre_malla
FROM
tbl_usuario

left join     rel_lms_malla_persona
on tbl_usuario.rut=rel_lms_malla_persona.rut

inner join tbl_lms_malla
on tbl_lms_malla.id=rel_lms_malla_persona.id_malla and tbl_lms_malla.id_empresa='$id_empresa'

WHERE
tbl_usuario.id_empresa = '$id_empresa'
AND(
$filtro_mallas

)";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function totalUsuariosPorProgramaConMallas($id_empresa, $mallas) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$filtro_mallas = "";
$i = 1;

$datos_empresa = DatosEmpresa($id_empresa);

if ($datos_empresa[0]->campo1) {
$c1_colaborador = " tbl_usuario." . $datos_empresa[0]->campo1 . " as c1_colaborador, ";
}

if ($datos_empresa[0]->campo2) {
$c2_colaborador = " tbl_usuario." . $datos_empresa[0]->campo2 . " as c2_colaborador, ";
}

if ($datos_empresa[0]->campo3) {
$c3_colaborador = " tbl_usuario." . $datos_empresa[0]->campo3 . " as c3_colaborador, ";
}

foreach ($mallas as $mall) {
$filtro_mallas .= " id_malla='" . $mall->id_malla . "'";
if ($i < count($mallas)) {
$filtro_mallas .= " or ";
}
$i++;
}

$sql = "  SELECT
rel_lms_malla_persona.*, tbl_usuario.rut_completo,tbl_usuario.nombre_completo, $c1_colaborador $c2_colaborador $c3_colaborador tbl_usuario.cargo, tbl_usuario.email,
tbl_lms_malla.nombre as nombre_malla,
(select fecha from tbl_inscripcion_usuarios where rut=rel_lms_malla_persona.rut and id_malla=rel_lms_malla_persona.id_malla limit 1) as fecha
FROM
rel_lms_malla_persona

inner join tbl_usuario
on tbl_usuario.rut=rel_lms_malla_persona.rut

inner join tbl_lms_malla
on tbl_lms_malla.id=rel_lms_malla_persona.id_malla and tbl_lms_malla.id_empresa='$id_empresa'

WHERE
rel_lms_malla_persona.id_empresa = '$id_empresa'
AND(
$filtro_mallas

)";

//         echo $sql; exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}


function totalUsuariosPorInscripcionUsuarioProgramaConMallas($id_empresa, $mallas) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$filtro_mallas = "";
$i = 1;

$datos_empresa = DatosEmpresa($id_empresa);

if ($datos_empresa[0]->campo1) {
$c1_colaborador = " tbl_usuario." . $datos_empresa[0]->campo1 . " as c1_colaborador, ";
}

if ($datos_empresa[0]->campo2) {
$c2_colaborador = " tbl_usuario." . $datos_empresa[0]->campo2 . " as c2_colaborador, ";
}

if ($datos_empresa[0]->campo3) {
$c3_colaborador = " tbl_usuario." . $datos_empresa[0]->campo3 . " as c3_colaborador, ";
}

foreach ($mallas as $mall) {
$filtro_mallas .= " id_malla='" . $mall->id_malla . "'";
if ($i < count($mallas)) {
$filtro_mallas .= " or ";
}
$i++;
}

$sql = "

SELECT h.* from tbl_inscripcion_usuarios h

where h.id_empresa='$id_empresa'

AND(

$filtro_mallas

)";

//  echo $sql; exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function totalUsuariosPorProgramaConMallasLight($id_empresa, $mallas) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$filtro_mallas = "";
$i = 1;

$datos_empresa = DatosEmpresa($id_empresa);

if ($datos_empresa[0]->campo1) {
$c1_colaborador = " tbl_usuario." . $datos_empresa[0]->campo1 . " as c1_colaborador, ";
}

if ($datos_empresa[0]->campo2) {
$c2_colaborador = " tbl_usuario." . $datos_empresa[0]->campo2 . " as c2_colaborador, ";
}

if ($datos_empresa[0]->campo3) {
$c3_colaborador = " tbl_usuario." . $datos_empresa[0]->campo3 . " as c3_colaborador, ";
}

foreach ($mallas as $mall) {
$filtro_mallas .= " id_malla='" . $mall->id_malla . "'";
if ($i < count($mallas)) {
$filtro_mallas .= " or ";
}
$i++;
}

$sql = "

SELECT count(id) as cuenta FROM rel_lms_malla_persona WHERE rel_lms_malla_persona.id_empresa = '$id_empresa'
AND (
$filtro_mallas

)
limit 1
";

// echo $sql; exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod[0]->cuenta;
}

function totalUsuariosPorMedicion($id_empresa, $id_medicion) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "  SELECT  h.*,

(select nombre from tbl_enc_elearning_medicion where id=h.id_medicion) as Medicion,
(select rut_completo from tbl_usuario where rut=h.rut) as rut_completo_colaborador,
(select nombre_completo from tbl_usuario where rut=h.rut) as nombre_completo_colaborador,
(select rut_completo from tbl_usuario where rut=h.jefe) as rut_completo_jefe,
(select nombre_completo from tbl_usuario where rut=h.jefe) as nombre_completo_jefe

FROM    tbl_enc_elearning_usuarios h

WHERE
h.id_medicion = '$id_medicion'
and h.id_empresa = '$id_empresa'

";

//  echo $sql; exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeMallasDadoPrograma($id_empresa, $id_programa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$arreglo_rut = $arreglo_archivo = explode("-", $rut);
$key = $arreglo_rut[0];

$sql = "
SELECT DISTINCT
(id_malla), tbl_lms_malla.nombre
id_programa
FROM
rel_lms_malla_curso

inner join tbl_lms_malla
on tbl_lms_malla.id=rel_lms_malla_curso.id_malla and tbl_lms_malla.id_empresa='$id_empresa'
WHERE
rel_lms_malla_curso.id_empresa = '$id_empresa' and rel_lms_malla_curso.id_programa='$id_programa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function BuscaEmpresaUser($email) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$arreglo_rut = $arreglo_archivo = explode("-", $rut);
$key = $arreglo_rut[0];
//echo "$c_db $c_host,$c_user,$c_pass<br>";

$sql = "select h.*, (select home from tbl_admin_perfiles where id=h.acceso) as home_admin from tbl_admin h where h.user='$email'";
//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

//print_r($cod);
return $cod;
}


function BuscaEmpresaUserRut($rut) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$arreglo_rut = $arreglo_archivo = explode("-", $rut);
$key = $arreglo_rut[0];
//echo "$c_db $c_host,$c_user,$c_pass<br>";

$sql = "select h.*, (select home from tbl_admin_perfiles where id=h.acceso) as home_admin from tbl_admin h where h.user='$rut'";
//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

//print_r($cod);
return $cod;
}

function WS_existeusuariodataAdmin($rut, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$arreglo_rut = $arreglo_archivo = explode("-", $rut);
$key = $arreglo_rut[0];
//echo "$c_db $c_host,$c_user,$c_pass<br>";

$sql = "select * from tbl_admin where rut='$key' and id_empresa='$id_empresa'";
//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

//print_r($cod);
return $cod;
}

function WS_actualizadatosAdmin($rut, $nombre, $apellido, $imagenUrl, $cargo, $gerenciaR2, $gerenciaR3, $gerencia, $ola, $jefe, $email, $id_empresa, $tipo) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$arreglo_rut = $arreglo_archivo = explode("-", $rut);
$key = $arreglo_rut[0];
$nombre_completo = $nombre . " " . $apellido;

if ($tipo == "actualiza") {
$sql = "UPDATE tbl_usuario
SET rut_completo='$rut', nombre='$nombre', apaterno='$apellido', nombre_completo='$nombre_completo',
avatar='$imagenUrl', seccion='$ola', cargo='$cargo', gerencia='$gerencia', gerenciaR2='$gerenciaR2',
gerencia='$gerenciaR3', jefe='$jefe', email='$email', id_empresa='$id_empresa'

WHERE rut= '$key' AND id_empresa='$id_empresa'";
$database->setquery($sql);
$database->query();
}

if ($tipo == "inserta") {
$sql = "INSERT INTO tbl_usuario (
rut, rut_completo, nombre, apaterno, nombre_completo, avatar, seccion, cargo, gerencia, gerenciaR2, gerenciaR3, jefe, email, id_empresa
) VALUES (
'$key', '$rut', '$nombre', '$apellido', '$nombre_completo', '$imagenUrl', '$ola', '$cargo',
'$gerencia', '$gerenciaR2', '$gerenciaR3', '$jefe', '$email', '$id_empresa' );";
$database->setquery($sql);
$database->query();
}
}

function SGD_TraigoDatosCompetenciaDadoComponenteReporteYPerfil($perfil_evaluacion, $id_componente_reporte) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$datos_empresa = DatosEmpresa($id_empresa);
$sql = "select tbl_sgd_componente.id as id_competencia from tbl_sgd_componente
inner join rel_sgd_perfil_competencias
on rel_sgd_perfil_competencias.id_componente=tbl_sgd_componente.id and rel_sgd_perfil_competencias.perfil_evaluacion='$perfil_evaluacion'

where tbl_sgd_componente.id_componente_reporte='$id_componente_reporte'

";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function SGD_TraigoRespuestaPorDeterminante($evaluado, $evaluador, $id_proceso, $id_determinante, $id_competencia) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$datos_empresa = DatosEmpresa($id_empresa);
$sql = "SELECT
tbl_sgd_respuestas.*
FROM
tbl_sgd_respuestas

inner join tbl_sgd_preguntas
on tbl_sgd_preguntas.id=tbl_sgd_respuestas.id_pregunta

WHERE
tbl_sgd_respuestas.evaluado = '$evaluado'
AND tbl_sgd_respuestas.evaluador = '$evaluador'
AND tbl_sgd_respuestas.id_proceso = '$id_proceso'
and tbl_sgd_preguntas.id_determinante='$id_determinante'
and tbl_sgd_preguntas.id_competencia='$id_competencia'

";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function SGD_PreguntasPorIdComponenteReporteAgrupadosPorDeterminante($id_componente_reporte, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$datos_empresa = DatosEmpresa($id_empresa);
$sql = "SELECT
tbl_sgd_preguntas.id_determinante, tbl_sgd_preguntas.pregunta as nombre_pregunta
FROM
tbl_sgd_preguntas
INNER JOIN tbl_sgd_componente ON tbl_sgd_componente.id = tbl_sgd_preguntas.id_competencia
WHERE
tbl_sgd_preguntas.id_empresa = '$id_empresa'
AND tbl_sgd_componente.id_componente_reporte = '$id_componente_reporte'
GROUP BY
id_determinante
ORDER BY
id_determinante ASC

";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function SGD_ResultadoPorCompetenciaIdComponenteReporte($evaluado, $evaluador, $id_proceso, $id_componente_reporte) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$datos_empresa = DatosEmpresa($id_empresa);
$sql = "select tbl_sgd_resultados_calculados_competencia.*,
tbl_sgd_componente.id_componente_reporte from tbl_sgd_resultados_calculados_competencia

inner join tbl_sgd_componente
on tbl_sgd_componente.id=tbl_sgd_resultados_calculados_competencia.id_competencia


where tbl_sgd_resultados_calculados_competencia.evaluado='$evaluado' and tbl_sgd_resultados_calculados_competencia.evaluador='$evaluador'
and tbl_sgd_resultados_calculados_competencia.id_proceso='$id_proceso'
and tbl_sgd_componente.id_componente_reporte='$id_componente_reporte'

";

$sql = "select tbl_sgd_resultados_calculados_competencia.*,
tbl_sgd_componente.id_componente_reporte from tbl_sgd_resultados_calculados_competencia

inner join tbl_sgd_componente
on tbl_sgd_componente.id=tbl_sgd_resultados_calculados_competencia.id_competencia


where tbl_sgd_resultados_calculados_competencia.evaluado='$evaluado' and tbl_sgd_resultados_calculados_competencia.evaluador='$evaluador'
and tbl_sgd_resultados_calculados_competencia.id_proceso='$id_proceso'
and tbl_sgd_componente.id='$id_componente_reporte'

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DistinctDeCompetenciasPorEmpresaIdComponenteReporte($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$datos_empresa = DatosEmpresa($id_empresa);
$sql = "select distinct(id_componente_reporte), nombre as nombre_competencia from tbl_sgd_componente where id_empresa='$id_empresa'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeRelacionesProcesosConDetalle($id_empresa, $id_proceso) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$datos_empresa = DatosEmpresa($id_empresa);

if ($datos_empresa[0]->campo1) {
$c1_evaluado = " baseevaluado." . $datos_empresa[0]->campo1 . " as c1_evaluado, ";
$c1_evaluador = " baseevaluador." . $datos_empresa[0]->campo1 . " as c1_evaluador, ";
}

if ($datos_empresa[0]->campo2) {
$c2_evaluado = " baseevaluado." . $datos_empresa[0]->campo2 . " as c2_evaluado, ";
$c2_evaluador = " baseevaluador." . $datos_empresa[0]->campo2 . " as c2_evaluador, ";
}

if ($datos_empresa[0]->campo3) {
$c3_evaluado = " baseevaluado." . $datos_empresa[0]->campo3 . " as c3_evaluado, ";
$c3_evaluador = " baseevaluador." . $datos_empresa[0]->campo3 . " as c3_evaluador, ";
}

$sql = "SELECT
tbl_sgd_finalizados_evaluado_evaluador.fecha AS fecha_finalizacion,
tbl_sgd_relaciones.evaluado,
baseevaluado.nombre_completo AS nombre_evaluado,
$c1_evaluado $c2_evaluado  $c3_evaluado
baseevaluado.cargo AS cargo_evaluado,
tbl_sgd_relaciones.evaluador,
baseevaluador.nombre_completo AS nombre_evaluador,
$c1_evaluador $c2_evaluador  $c3_evaluador
baseevaluador.cargo AS cargo_evaluador,
tbl_sgd_relaciones.id_proceso,
tbl_sgd_relaciones.perfil_evaluacion_competencias,
tbl_sgd_comentarios_finales.comentario as comentarios_finales,
(
SELECT
count(*)
FROM
tbl_sgd_respuestas
WHERE
tbl_sgd_respuestas.evaluado = tbl_sgd_relaciones.evaluado
AND tbl_sgd_respuestas.evaluador = tbl_sgd_relaciones.evaluador
AND tbl_sgd_respuestas.id_proceso = tbl_sgd_relaciones.id_proceso
LIMIT 1
)AS total_respuestas
FROM
tbl_sgd_relaciones
INNER JOIN tbl_usuario AS baseevaluado ON baseevaluado.rut = tbl_sgd_relaciones.evaluado
INNER JOIN tbl_usuario AS baseevaluador ON baseevaluador.rut = tbl_sgd_relaciones.evaluador
LEFT JOIN tbl_sgd_finalizados_evaluado_evaluador ON tbl_sgd_finalizados_evaluado_evaluador.id_proceso = tbl_sgd_relaciones.id_proceso
AND tbl_sgd_finalizados_evaluado_evaluador.evaluado = tbl_sgd_relaciones.evaluado
AND tbl_sgd_finalizados_evaluado_evaluador.evaluador = tbl_sgd_relaciones.evaluador

left join tbl_sgd_comentarios_finales
on tbl_sgd_comentarios_finales.evaluado=tbl_sgd_relaciones.evaluado
and tbl_sgd_comentarios_finales.evaluador=tbl_sgd_relaciones.evaluador
and tbl_sgd_comentarios_finales.id_proceso=tbl_sgd_relaciones.id_proceso


WHERE
tbl_sgd_relaciones.id_empresa = '$id_empresa'
AND tbl_sgd_relaciones.id_proceso = '$id_proceso'
and tbl_sgd_finalizados_evaluado_evaluador.fecha is not null


order by         tbl_sgd_finalizados_evaluado_evaluador.fecha  ASC
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeMallaCursoConDatos($id_curso, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT
rel_lms_malla_curso.id_malla,
tbl_lms_malla.nombre as nombre_malla,
rel_lms_malla_curso.id_curso,
rel_lms_malla_curso.id_clasificacion,
tbl_lms_clasificacion.clasificacion as nombre_clasificacion,
rel_lms_malla_curso.id_programa,
tbl_lms_programas_bbdd.nombre_programa,
rel_lms_malla_curso.id_foco,
tbl_lms_foco.descripcion as nombre_foco
FROM
rel_lms_malla_curso

inner join tbl_lms_malla
on tbl_lms_malla.id=rel_lms_malla_curso.id_malla

inner join tbl_lms_clasificacion
on tbl_lms_clasificacion.id_clasificacion=rel_lms_malla_curso.id_clasificacion

inner join tbl_lms_programas_bbdd
on tbl_lms_programas_bbdd.id_programa=rel_lms_malla_curso.id_programa

left join tbl_lms_foco
on tbl_lms_foco.id=rel_lms_malla_curso.id_foco
WHERE
rel_lms_malla_curso.id_curso = '$id_curso'
AND rel_lms_malla_curso.id_empresa = '$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function Estadisticas_QueryPorCase($id_empresa, $tipo_estadistica) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select count(distinct(rut)) as total from tbl_log_sistema where ambiente='$tipo_estadistica' and rut<>'' and id_empresa='$id_empresa' ;

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function Estadisticas_Query($id_empresa, $tipo_estadistica) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT
count(tbl_log_sistema.id)AS total,
tbl_log_sistema.rut,
ambiente,
tbl_usuario.rut_completo, tbl_usuario.nombre_completo, tbl_usuario.cargo, tbl_usuario.email, gerencia as campo1, gerenciaR2 as campo2, gerenciaR3 as campo3
FROM
tbl_log_sistema

inner join tbl_usuario
on tbl_usuario.rut=tbl_log_sistema.rut

WHERE
ambiente = '$tipo_estadistica'
AND tbl_log_sistema.rut <> ''
AND tbl_log_sistema.id_empresa = '$id_empresa'
GROUP BY
ambiente,
tbl_log_sistema.rut
ORDER BY
total DESC
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function Estadisticas_distinct($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_case_estadisticas where id_empresa='$id_empresa' order by id ASC";
//cho $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function IMPARTICION_DistinctTipovalidacionPorInscripcion($id_inscripcion, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select distinct(tipo_validacion) as valor from tbl_inscripcion_postulantes where id_inscripcion='$id_inscripcion' and id_empresa='$id_empresa'
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function IMPARTICION_PostulantesPorInscripcionDadoRut($id_inscripcion, $id_empresa, $rut) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT * from tbl_inscripcion_postulantes
WHERE id_inscripcion = '$id_inscripcion'
and id_empresa='$id_empresa'
and rut='$rut'
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function IMPARTICION_PostulantesPorInscripcionConDatosUsuarioConPreinscritoCero($id_inscripcion, $id_empresa, $datos_empresa, $id_curso) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
//print_r($datos_empresa);
if ($datos_empresa[0]->campo1) {
$c1 = " tbl_usuario." . $datos_empresa[0]->campo1 . " as c1, ";
}

if ($datos_empresa[0]->campo2) {
$c2 = " tbl_usuario." . $datos_empresa[0]->campo2 . " as c2, ";
}

if ($datos_empresa[0]->campo3) {
$c3 = " tbl_usuario." . $datos_empresa[0]->campo3 . " as c3, ";
}

$sql = "SELECT
tbl_usuario.rut_completo, tbl_usuario.nombre_completo, tbl_usuario.email, tbl_usuario.cargo, $c1 $c2 $c3 tbl_inscripcion_postulantes.*
FROM
tbl_inscripcion_postulantes

left join tbl_usuario
on tbl_usuario.rut=tbl_inscripcion_postulantes.rut
WHERE
tbl_inscripcion_postulantes.id_inscripcion = '$id_inscripcion'
AND tbl_inscripcion_postulantes.id_empresa = '$id_empresa'
AND  tbl_inscripcion_postulantes.preinscrito<>'0'
";

if ($id_curso) {
$sql = "SELECT
tbl_inscripcion_curso.fecha_inicio,
tbl_inscripcion_curso.fecha_termino    ,
tbl_inscripcion_curso.cupos,
tbl_inscripcion_curso.direccion,
tbl_inscripcion_curso.ciudad as lugar,
tbl_usuario.rut_completo,
tbl_usuario.nombre_completo,
tbl_usuario.email,
tbl_usuario.cargo,
$c1 $c2 $c3
tbl_inscripcion_postulantes.*,
tbl_lms_curso.nombre as nombre_curso
FROM
tbl_inscripcion_postulantes
LEFT JOIN tbl_usuario ON tbl_usuario.rut = tbl_inscripcion_postulantes.rut

inner join tbl_lms_curso
on tbl_lms_curso.id=tbl_inscripcion_postulantes.id_curso


inner join tbl_inscripcion_curso
on tbl_inscripcion_curso.codigo_inscripcion=tbl_inscripcion_postulantes.id_inscripcion


WHERE
tbl_inscripcion_postulantes.id_curso = '$id_curso'
AND tbl_inscripcion_postulantes.id_empresa = '$id_empresa'
AND tbl_inscripcion_postulantes.preinscrito <> '0'";
} else {
$sql = "SELECT
tbl_inscripcion_curso.fecha_inicio,
tbl_inscripcion_curso.fecha_termino    ,
tbl_inscripcion_curso.cupos,
tbl_inscripcion_curso.direccion,
tbl_inscripcion_curso.ciudad as lugar,
tbl_usuario.rut_completo,
tbl_usuario.nombre_completo,
tbl_usuario.email,
tbl_usuario.cargo,
$c1 $c2 $c3
tbl_inscripcion_postulantes.*,
tbl_lms_curso.nombre as nombre_curso
FROM
tbl_inscripcion_postulantes
LEFT JOIN tbl_usuario ON tbl_usuario.rut = tbl_inscripcion_postulantes.rut

inner join tbl_lms_curso
on tbl_lms_curso.id=tbl_inscripcion_postulantes.id_curso


inner join tbl_inscripcion_curso
on tbl_inscripcion_curso.codigo_inscripcion=tbl_inscripcion_postulantes.id_inscripcion


WHERE
tbl_inscripcion_postulantes.id_inscripcion = '$id_inscripcion'
AND tbl_inscripcion_postulantes.id_empresa = '$id_empresa'
AND tbl_inscripcion_postulantes.preinscrito <> '0'";
}

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function IMPARTICION_EliminaPostulantesInscripcionUsuario($codigo_imparticion, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "delete from tbl_inscripcion_postulantes where id_empresa='$id_empresa' and id_inscripcion='$codigo_imparticion'";
$database->setquery($sql);
$database->query();
}

function IMPARTICION_PostulantesPorInscripcion($id_inscripcion, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT * from tbl_inscripcion_postulantes
WHERE
id_inscripcion = '$id_inscripcion' and id_empresa='$id_empresa'
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function IMPARTICION_PostulantesPorInscripcionConDatosUsuario($id_inscripcion, $id_empresa, $datos_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
//print_r($datos_empresa);
if ($datos_empresa[0]->campo1) {
$c1 = " tbl_usuario." . $datos_empresa[0]->campo1 . " as c1, ";
}

if ($datos_empresa[0]->campo2) {
$c2 = " tbl_usuario." . $datos_empresa[0]->campo2 . " as c2, ";
}

if ($datos_empresa[0]->campo3) {
$c3 = " tbl_usuario." . $datos_empresa[0]->campo3 . " as c3, ";
}

$sql = "SELECT
tbl_usuario.nombre_completo, tbl_usuario.cargo, $c1 $c2 $c3 tbl_inscripcion_postulantes.*
FROM
tbl_inscripcion_postulantes

left join tbl_usuario
on tbl_usuario.rut=tbl_inscripcion_postulantes.rut
WHERE
tbl_inscripcion_postulantes.id_inscripcion = '$id_inscripcion'
AND tbl_inscripcion_postulantes.id_empresa = '$id_empresa'
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}



function InsertaPostulantePorInscripcion($rut, $id_empresa, $id_inscripcion, $id_curso, $tipo_validacion) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "INSERT INTO tbl_inscripcion_postulantes
(rut, id_empresa, id_inscripcion, id_curso, tipo_validacion, preinscrito, validado_jefe)
VALUES ('$rut','$id_empresa', '$id_inscripcion', '$id_curso', '$tipo_validacion', '0', '0');";

$database->setquery($sql);

if (!$database->query_error()) {
return $database->errores(mysql_error());
}
}

function EliminiInscripcionUsuarioYInscripcionCurso($codigo_imparticion) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "DELETE FROM tbl_inscripcion_curso WHERE codigo_inscripcion= '$codigo_imparticion'";

$database->setquery($sql);
$database->query();

$sql = "DELETE FROM tbl_inscripcion_usuarios WHERE id_inscripcion= '$codigo_imparticion'";
$database->setquery($sql);
$database->query();
}

function TRaeTablaUsuarioDadoUnidadNegocio($id_empresa, $unidad_negocio) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_usuario where id_empresa='$id_empresa' and unidad_negocio='$unidad_negocio'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TraeUsuarioBecas($idenc, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select rut, nombre_beca from tbl_becas where id='$idenc'";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function BorraInscritosEventos($codigo, $id_dimension, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "

delete from tbl_eventos_inscritos where id_empresa='$id_empresa' and codigo='$codigo' and id_dimension='$id_dimension'";

//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TraeInscritosEventos($codigo, $id_dimension, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select rut, fecha, hora, estado from tbl_eventos_inscritos where codigo='$codigo' and id_dimension='$id_dimension' and id_empresa='$id_empresa'";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TraeInscritosExtEmpresaUsuarios($rut_empresa, $id_dimension, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "    select *

from tbl_empresas_ext_usuarios

where rut_ext_empresa='$rut_empresa'
and id_empresa='$id_empresa'";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TraeInscritosEventosFull($codigo, $id_dimension, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);

if ($codigo != '') {$query_cod = " and h.codigo='$codigo'  ";}

$database->setDb($c_db);
$sql = "

select h.rut,


(select codigo from tbl_eventos where codigo=h.codigo and id_dimension=h.id_dimension and id_empresa=h.id_empresa) as CodigoEvento,
(select nombre from tbl_eventos where codigo=h.codigo and id_dimension=h.id_dimension and id_empresa=h.id_empresa) as Nombre_evento,
(select descripcion from tbl_eventos where codigo=h.codigo and id_dimension=h.id_dimension and id_empresa=h.id_empresa) as DescripcionEvento,

(select fecha_inicio from tbl_eventos where codigo=h.codigo and id_dimension=h.id_dimension and id_empresa=h.id_empresa) as Fecha_Inicio,
(select hora_inicio from tbl_eventos where codigo=h.codigo and id_dimension=h.id_dimension and id_empresa=h.id_empresa) as Hora_Inicio,
(select fecha_termino from tbl_eventos where codigo=h.codigo and id_dimension=h.id_dimension and id_empresa=h.id_empresa) as Fecha_Termino,
(select hora_termino from tbl_eventos where codigo=h.codigo and id_dimension=h.id_dimension and id_empresa=h.id_empresa) as Hora_Termino,
(select id_categoria from tbl_eventos where codigo=h.codigo and id_dimension=h.id_dimension and id_empresa=h.id_empresa) as id_categoria,
(select categoria from tbl_eventos where codigo=h.codigo and id_dimension=h.id_dimension and id_empresa=h.id_empresa) as categoria,

(select instruccion from tbl_eventos where codigo=h.codigo and id_dimension=h.id_dimension and id_empresa=h.id_empresa) as Instruccion,
(select direccion from tbl_eventos where codigo=h.codigo and id_dimension=h.id_dimension and id_empresa=h.id_empresa) as Direccion,
(select region from tbl_eventos where codigo=h.codigo and id_dimension=h.id_dimension and id_empresa=h.id_empresa) as Region,
(select link_acceso from tbl_eventos where codigo=h.codigo and id_dimension=h.id_dimension and id_empresa=h.id_empresa) as LinkAcceso,
h.estado,
(select count(id) from tbl_log_emails where id_empresa=h.id_empresa and tipo='Email_invitacion_evento' and dato=h.codigo and rut=h.rut) as num_emails_log

from tbl_eventos_inscritos h

where  h.id_dimension='$id_dimension' and h.id_empresa='$id_empresa' $query_cod ";
//echo $sql; exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TraeInscritosEventosEmails($codigo, $id_dimension, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "

select h.rut,
(select nombre_completo from tbl_usuario where rut=h.rut) as nombre_completo,
(select email from tbl_usuario where rut=h.rut) as email,

(select nombre from tbl_eventos where codigo=h.codigo and id_dimension=h.id_dimension and id_empresa=h.id_empresa) as Nombre,
(select descripcion from tbl_eventos where codigo=h.codigo and id_dimension=h.id_dimension and id_empresa=h.id_empresa) as Descripcion,

(select fecha_inicio from tbl_eventos where codigo=h.codigo and id_dimension=h.id_dimension and id_empresa=h.id_empresa) as Fecha_Inicio,
(select hora_inicio from tbl_eventos where codigo=h.codigo and id_dimension=h.id_dimension and id_empresa=h.id_empresa) as Hora_Inicio,
(select fecha_termino from tbl_eventos where codigo=h.codigo and id_dimension=h.id_dimension and id_empresa=h.id_empresa) as Fecha_Termino,
(select hora_termino from tbl_eventos where codigo=h.codigo and id_dimension=h.id_dimension and id_empresa=h.id_empresa) as Hora_Termino,

(select instruccion from tbl_eventos where codigo=h.codigo and id_dimension=h.id_dimension and id_empresa=h.id_empresa) as Instruccion,
(select direccion from tbl_eventos where codigo=h.codigo and id_dimension=h.id_dimension and id_empresa=h.id_empresa) as Direccion,
(select region from tbl_eventos where codigo=h.codigo and id_dimension=h.id_dimension and id_empresa=h.id_empresa) as Region,
(select link_acceso from tbl_eventos where codigo=h.codigo and id_dimension=h.id_dimension and id_empresa=h.id_empresa) as LinkAcceso


from tbl_eventos_inscritos h

where h.codigo='$codigo' and h.id_dimension='$id_dimension' and h.id_empresa='$id_empresa' and h.estado='OK' ";
//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TraeNombreUsuario($rut) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select nombre_completo from tbl_usuario where rut='$rut'";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TraeDatosUsuario($rut) {

global $c_host, $c_user, $c_pass, $c_db;
//echo "$c_host,$c_user,$c_pass,$c_db";
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_usuario where rut='$rut'";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

//print_r($cod);
return $cod;
}


function TraeDatosUsuarioNombreCargoDivision($rut) {

global $c_host, $c_user, $c_pass, $c_db;
//echo "$c_host,$c_user,$c_pass,$c_db";
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select rut_completo, nombre_completo, cargo, division from tbl_usuario where rut='$rut'";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

//print_r($cod);
return $cod;
}




function TraeDatosJefeNumEquipo($rut) {

global $c_host, $c_user, $c_pass, $c_db;
//echo "$c_host,$c_user,$c_pass,$c_db";
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select count(id) as cuenta from tbl_usuario where jefe='$rut'";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

//print_r($cod);
return $cod[0]->cuenta;
}

function TRaeDistincTablaUsuario($id_empresa, $campo) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select distinct($campo) as valor from tbl_usuario where id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function ActualizaRelacionNoticiaCorreo($id_correo, $id_noticia, $fila, $columna) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE rel_correos_noticias  SET id_noticia= '$id_noticia'

WHERE id_correo='$id_correo' and fila='$fila' and columna='$columna'";

$database->setquery($sql);
$database->query();
}

function InsertaRelacionCorreoNoticia($id_correo, $id_noticia, $fila, $columna) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "INSERT INTO rel_correos_noticias
(id_correo, id_noticia, fila, columna)
VALUES ('$id_correo', '$id_noticia', '$fila', '$columna');";
$database->setquery($sql);

if (!$database->query_error()) {
return $database->errores(mysql_error());
}
}

function VerificoNoticiaFilaColumna($id_correo, $fila, $columna) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "SELECT
tbl_noticias.portada,
tbl_noticias.titulo,
rel_correos_noticias.*
FROM
rel_correos_noticias

left JOIN tbl_noticias
on tbl_noticias.id=rel_correos_noticias.id_noticia
WHERE
rel_correos_noticias.id_correo = '$id_correo'
AND rel_correos_noticias.fila = '$fila'
AND rel_correos_noticias.columna = '$columna'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function DatosDeCorreoDadoIdEmpresa($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select * from tbl_correos where id_empresa='$id_empresa'


";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function LmsexportarImparticionesXLS_fn_data($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "


select

h.codigo_inscripcion as id,
h.fecha_inicio,
h.fecha_termino,
h.direccion,
h.ciudad,
h.id_curso,
h.ejecutivo,
h.sesiones,
h.cupos,
(select id from tbl_lms_curso where id=h.id_curso) as idcurso,
(select nombre from tbl_lms_curso where id=h.id_curso) as nombrecurso,
(select descripcion from tbl_lms_curso where id=h.id_curso) as descripcioncurso,
(select modalidad from tbl_lms_curso where id=h.id_curso) as modalidadcurso,
(select id_foco from tbl_lms_curso where id=h.id_curso) as idfococurso,
(select id_empresa_programa from tbl_lms_curso where id=h.id_curso) as idprogramacurso,
(select descripcion from tbl_lms_foco where codigo_foco=(select id_foco from tbl_lms_curso where id=h.id_curso)) as Foco,
(select nombre_programa from tbl_lms_programas_bbdd where id_programa=(select id_empresa_programa from tbl_lms_curso where id=h.id_curso)) as Programa,
(select count(id) from tbl_inscripcion_usuarios where id_inscripcion=h.codigo_inscripcion) as participantes

from tbl_inscripcion_curso h

WHERE

h.id_empresa='$id_empresa'

and h.id_curso is not null
and h.id_curso<>''

";

//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function LmsexportarCursosXLS_fn_data($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "
select h.*,
(select count(id) from tbl_inscripcion_curso where id_curso=h.id) as NumImparticiones,
(select descripcion from tbl_lms_foco where codigo_foco=h.id_foco) as Foco,
(select nombre_programa from tbl_lms_programas_bbdd where id_programa=h.id_empresa_programa) as Programa

from tbl_lms_curso h

WHERE

h.id_empresa='$id_empresa'


order by h.id_foco, id_empresa_programa, h.nombre
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TraeMallaDadoProgramaCurso($id_empresa, $programa, $id_curso) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "SELECT DISTINCT
(
rel_lms_malla_curso.id_malla
), tbl_lms_malla.nombre as nombre_malla
FROM
rel_lms_malla_curso
inner join tbl_lms_malla
on tbl_lms_malla.id=rel_lms_malla_curso.id_malla

WHERE
rel_lms_malla_curso.id_empresa = '$id_empresa'
AND rel_lms_malla_curso.id_curso = '$id_curso'    ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TraeProgramasUnicosDadoCursoDeRelMallaCurso($id_empresa, $id_curso) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select DISTINCT(rel_lms_malla_curso.id_programa), tbl_lms_programas_bbdd.nombre_programa
from rel_lms_malla_curso
inner join tbl_lms_programas_bbdd
on tbl_lms_programas_bbdd.id_programa=rel_lms_malla_curso.id_programa

where rel_lms_malla_curso.id_curso='$id_curso' and rel_lms_malla_curso.id_empresa='$id_empresa'        ";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TraeProgramasDadoFocoDeTablaPrograma($id_empresa, $foco) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_lms_programas_bbdd where codigo_foco='$foco' and tipo='GLOBAL' and id_empresa='$id_empresa'        order by nombre_programa ASC";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TraeProgramasDadoFocoDeTablaProgramaElearning($id_empresa, $foco) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_lms_programas_bbdd where codigo_foco='$foco' and tipo<>'GLOBAL' and id_empresa='$id_empresa'        order by nombre_programa ASC";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

//echo $sql;exit();

return $cod;
}

function TraeProgramasDadoFocoDeTablaProgramaElearningSoloGlobal($id_empresa, $foco) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_lms_programas_bbdd where codigo_foco='$foco' and tipo='GLOBAL' and id_empresa='$id_empresa'        order by nombre_programa ASC";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//echo $sql;
//echo $sql;exit();

return $cod;
}

function TraeProgramasDadoFocoDeTablaProgramaElearningDadoGlobalDistinct($id_empresa, $programa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select distinct(id_programa), nombre_programa from tbl_lms_programas_bbdd where id_programa_global='$programa' and tipo<>'GLOBAL' and id_empresa='$id_empresa'
order by nombre_programa ASC";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//echo $sql;

//echo $sql;exit();

return $cod;
}


function TraeProgramasDadoFocoDeTablaProgramaElearningDadoGlobal($id_empresa, $programa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_lms_programas_bbdd where id_programa_global='$programa' and tipo<>'GLOBAL' and id_empresa='$id_empresa'        order by nombre_programa ASC";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//echo $sql;

//echo $sql;exit();

return $cod;
}

function TraigoDatosTablareportesConsolidadTrivias($id_empresa, $arreglo_post) {global $c_host, $c_user, $c_pass, $c_db;

//print_r($arreglo_post);

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($arreglo_post["objetos"]) {
$campos_objeto = "tbl_objetos_finalizados.fecha as fecha_objeto_finalizado,
tbl_gamificado_puntos.puntos,
tbl_gamificado_puntos.medallas,";

$filtro_objetos = "left join tbl_objetos_finalizados
on tbl_objetos_finalizados.id_objeto='" . $arreglo_post["objetos"] . "' and tbl_objetos_finalizados.rut=tbl_usuario.rut
left join tbl_gamificado_puntos
on tbl_gamificado_puntos.rut=tbl_usuario.rut and tbl_gamificado_puntos.id_objeto='" . $arreglo_post["objetos"] . "'";
}

if ($arreglo_post["malla"]) {
$filtro_malla = " and tbl_lms_reportes.id_malla='" . $arreglo_post["malla"] . "'";
}

if ($arreglo_post["cursos"]) {
//$filtro_curso=" and tbl_lms_reportes.id_curso='".$arreglo_post["cursos"]."'";

//echo "<br>".$campo->campo;
if (count($arreglo_post["cursos"]) > 0 && $arreglo_post["cursos"][0] != '0') {
$total_campos++;
if ($total_campos == 1) {
$filtro_curso .= " and ";
}
if ($total_campos >= 2) {
$filtro_curso .= " or ";
}
//echo "<br>".$campo->campo;
$total = count($arreglo_post["cursos"]);
$filtro_curso .= " ( ";
for ($i = 1; $i <= $total; $i++) {
if ($i >= 2) {
$filtro_curso .= " or ";
}
$filtro_curso .= " tbl_lms_reportes.id_curso='" . $arreglo_post["cursos"][$i - 1] . "'";
}
$filtro_curso .= " ) ";
}
}

if ($arreglo_post["clasificacion"]) {
$filtro_clasificacion = " and tbl_lms_reportes.id_clasificacion='" . $arreglo_post["clasificacion"] . "'";
}

if ($arreglo_post["foco"]) {
$filtro_foco = " and tbl_lms_reportes.id_foco='" . $arreglo_post["foco"] . "'";
}

if ($arreglo_post["programabbdd"]) {
$filtro_programabbdd = " and tbl_lms_reportes.id_programa='" . $arreglo_post["programabbdd"] . "'";
}

if ($arreglo_post["c1"]) {
$filtro_c1 = " and tbl_lms_reportes.c1='" . $arreglo_post["c1"] . "'";
}

if ($arreglo_post["c2"]) {
$filtro_c2 = " and tbl_lms_reportes.c2='" . $arreglo_post["c2"] . "'";
}

if ($arreglo_post["c3"]) {
$filtro_c3 = " and tbl_lms_reportes.c3='" . $arreglo_post["c3"] . "'";
}

$campos_subida = REL_MALLA_CURSO_trarCamposSubidaParaReporte($id_empresa);
//print_r($campos_subida);

$total_campos = 0;
foreach ($campos_subida as $campo) {
//echo "<br>".$campo->campo;
if (count($arreglo_post[$campo->campo]) > 0 && $arreglo_post[$campo->campo][0] != '0') {
$total_campos++;
if ($total_campos >= 2) {
$filtros_campos_dinamicos .= " and ";
}
//echo "<br>".$campo->campo;
$total = count($arreglo_post[$campo->campo]);
$filtros_campos_dinamicos .= " ( ";
for ($i = 1; $i <= $total; $i++) {
if ($i >= 2) {
$filtros_campos_dinamicos .= " or ";
}
$filtros_campos_dinamicos .= " tbl_usuario." . $campo->campo . "='" . $arreglo_post[$campo->campo][$i - 1] . "'";
}
$filtros_campos_dinamicos .= " ) ";
}
}

if ($filtros_campos_dinamicos) {
$filtros_campos_dinamicos = "and ($filtros_campos_dinamicos)";
}

//excel detalle
$add_groupbycursos = "";
if ($arreglo_post[excel] == '2') {
$add_groupbycursos = " ,
rel_lms_malla_curso.id_curso";
}

$sql = "
SELECT

$campos_objeto
tbl_usuario.rut,
tbl_usuario.rut_completo,
tbl_lms_reportes.nombre,
tbl_lms_reportes.cargo,
tbl_lms_reportes.email,
tbl_lms_reportes.c1,
tbl_lms_reportes.c2,
tbl_lms_reportes.c3,
tbl_usuario.fecha_antiguedad,
rel_lms_malla_curso.id_curso,
(select nombre from tbl_lms_curso where id=rel_lms_malla_curso.id_curso limit 1) as nombre_curso,

rel_lms_malla_persona.id_malla,
(select nombre from tbl_lms_malla where id=rel_lms_malla_persona.id_malla and id_empresa = '$id_empresa') as nombremalla,

count(
rel_lms_malla_curso.id_curso
) AS total_cursos,
ROUND(
avg(tbl_lms_reportes.avance)
) AS avance,
(sum(tbl_lms_reportes.puntos)) AS suma_puntos,
ROUND(
avg(tbl_lms_reportes.resultado)
) AS resultado,
ROUND(
sum(tbl_lms_reportes.medallas)
) AS suma_medallas,
(select fecha from tbl_objetos_finalizados where rut=tbl_usuario.rut order by id ASC limit 1) as FechaLogIn,
(select fecha from tbl_objetos_finalizados where rut=tbl_usuario.rut order by id DESC limit 1) as FechaFin

FROM

tbl_usuario

left JOIN rel_lms_malla_persona ON rel_lms_malla_persona.rut = tbl_usuario.rut
left JOIN rel_lms_malla_curso ON rel_lms_malla_curso.id_malla = rel_lms_malla_persona.id_malla
left JOIN tbl_lms_reportes ON tbl_lms_reportes.rut = tbl_usuario.rut

$filtro_objetos

AND tbl_lms_reportes.id_curso = rel_lms_malla_curso.id_curso
WHERE

tbl_usuario.id_empresa = '$id_empresa'

AND tbl_usuario.vigencia = '0'

$filtro_malla $filtro_curso $filtro_clasificacion $filtro_foco $filtro_programabbdd $filtro_c1 $filtro_c2 $filtro_c3
and (rel_lms_malla_curso.opcional is null or rel_lms_malla_curso.opcional=0)
and rel_lms_malla_curso.inactivo='0'
and abs(tbl_usuario.rut)<>0
$filtros_campos_dinamicos

GROUP BY tbl_usuario.rut
$add_groupbycursos
";

//echo "$sql";
//exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function LMS_REPORTE_VerificaObjetoFinalizadoDadoObjetoUltima($id_curso, $rut) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_objetos_finalizados where rut='$rut' and id_curso='$id_curso' order by fecha desc limit 1";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function LMS_REPORTE_VerificaFechasObjetoFinalizadoDadoObjetoPrimero($id_curso, $rut) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select

(select fecha from tbl_objetos_finalizados where rut='$rut' and id_curso='$id_curso' order by fecha ASC limit 1) as fecha_inicio,
(select fecha from tbl_objetos_finalizados where rut='$rut' and id_curso='$id_curso' order by fecha DESC limit 1) as fecha_termino,

(select hora from tbl_objetos_finalizados where rut='$rut' and id_curso='$id_curso' order by fecha ASC limit 1) as     hora_inicio,
(select hora from tbl_objetos_finalizados where rut='$rut' and id_curso='$id_curso' order by fecha DESC limit 1) as hora_termino


from tbl_objetos_finalizados

where rut='$rut' and id_curso='$id_curso' group by id_curso
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function LMS_REPORTE_VerificaObjetoFinalizadoDadoObjetoPrimero($id_curso, $rut) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_objetos_finalizados where rut='$rut' and id_curso='$id_curso' order by fecha asc limit 1";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function LMS_REPORTE_TraeMallaCurso($id_curso, $id_malla, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT rel_lms_malla_curso.*


FROM rel_lms_malla_curso

WHERE rel_lms_malla_curso.id_curso = '$id_curso' AND rel_lms_malla_curso.id_empresa = '$id_empresa'

AND rel_lms_malla_curso.id_malla = '$id_malla'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function LMS_REPORTE_TraeCursosInscripcionUsuario($rut, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT
tbl_inscripcion_usuarios.*
FROM
tbl_inscripcion_usuarios

WHERE
tbl_inscripcion_usuarios.rut= '$rut' and tbl_inscripcion_usuarios.id_empresa='$id_empresa'
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function REL_MALLA_CURSO_trarCamposSubidaParaReporte($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_empresa_subida_usuarios where id_empresa='$id_empresa' and filtro_reporte='1'    ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

//echo $sql;

return $cod;
}

function REL_MALLA_CURSO_TraeObjetosDadoFoco($id_empresa, $arreglo_post) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($arreglo_post["foco"] != '' and $arreglo_post["foco"] != '0') {
$filtro_foco = " and  rel_lms_malla_curso.id_foco = '" . $arreglo_post["foco"] . "'";
}

if ($arreglo_post["programabbdd"] != '' and $arreglo_post["programabbdd"] != '0') {
$filtro_programabbdd = " and  rel_lms_malla_curso.id_programa = '" . $arreglo_post["programabbdd"] . "'";
}

if ($arreglo_post["malla"] != '' and $arreglo_post["malla"] != '0') {
$filtro_malla = "  and rel_lms_malla_curso.id_malla= '" . $arreglo_post["malla"] . "'";
}

if ($arreglo_post["clasificacion"] != '' and $arreglo_post["clasificacion"] != '0') {
$filtro_clasificacion = " and  rel_lms_malla_curso.id_clasificacion= '" . $arreglo_post["clasificacion"] . "'";
}

if ($arreglo_post["cursos"] != '' and $arreglo_post["cursos"] != '0') {
$filtro_curso = " and  rel_lms_malla_curso.id_curso= '" . $arreglo_post["cursos"] . "'";
}

$sql = "SELECT

DISTINCT(
rel_lms_malla_curso.id_curso
),
tbl_lms_curso.nombre AS nombre,
tbl_objeto.id as id_objeto, tbl_objeto.titulo
FROM
rel_lms_malla_curso
INNER JOIN tbl_lms_curso ON tbl_lms_curso.id = rel_lms_malla_curso.id_curso
inner join tbl_objeto
on tbl_objeto.id_curso=rel_lms_malla_curso.id_curso
WHERE
rel_lms_malla_curso.id_empresa = '$id_empresa'
$filtro_foco $filtro_programabbdd $filtro_malla $filtro_clasificacion $filtro_curso
";

//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function num_colaboradores_activos($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "    select     count(id) as CuentaUsuarios from tbl_usuario  where id_empresa='$id_empresa' and vigencia='0' ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function VerificaRutActivo($rut) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "    select     vigencia from tbl_usuario  where rut='$rut' ";
// echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function REL_MALLA_CURSO_TraeImparticionesDadoFoco($id_empresa, $arreglo_post) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($arreglo_post["ejecutivo"] != '' and $arreglo_post["ejecutivo"] != '0') {
$filtro_ejecutivo = "  and rel_lms_malla_curso.id_curso  in (SELECT distinct(tbl_inscripcion_curso.id_curso) from tbl_inscripcion_curso where tbl_inscripcion_curso.ejecutivo='" . $arreglo_post["ejecutivo"] . "')
";
}

if ($arreglo_post["foco"] != '' and $arreglo_post["foco"] != '0') {
$filtro_foco = " and  rel_lms_malla_curso.id_foco = '" . $arreglo_post["foco"] . "'";
}

if ($arreglo_post["programabbdd"] != '' and $arreglo_post["programabbdd"] != '0') {
$filtro_programabbdd = " and  rel_lms_malla_curso.id_programa = '" . $arreglo_post["programabbdd"] . "'";
}

if ($arreglo_post["malla"] != '' and $arreglo_post["malla"] != '0') {
$filtro_malla = "  and rel_lms_malla_curso.id_malla= '" . $arreglo_post["malla"] . "'";
}

if ($arreglo_post["clasificacion"] != '' and $arreglo_post["clasificacion"] != '0') {
$filtro_clasificacion = " and  rel_lms_malla_curso.id_clasificacion= '" . $arreglo_post["clasificacion"] . "'";
}

if ($arreglo_post["cursos"] != '' and $arreglo_post["cursos"] != '0') {
$filtro_curso = " and  rel_lms_malla_curso.id_curso= '" . $arreglo_post["cursos"] . "'";
}

$sql = "select distinct(rel_lms_malla_curso.id_curso), tbl_lms_curso.nombre as nombre
from rel_lms_malla_curso
inner join tbl_lms_curso
on tbl_lms_curso.id=rel_lms_malla_curso.id_curso

where rel_lms_malla_curso.id_empresa='$id_empresa' and bl_lms_curso.modalidad='1'
$filtro_foco $filtro_programabbdd $filtro_malla $filtro_clasificacion $filtro_curso ";

if ($arreglo_post["ejecutivo"] != '' and $arreglo_post["ejecutivo"] != '0') {
$filtro_ejecutivo = " and  tbl_inscripcion_curso.ejecutivo = '" . $arreglo_post["ejecutivo"] . "'";
}

if ($arreglo_post["curso"] != '' and $arreglo_post["curso"] != '0') {
$filtro_curso = " and id_curso='" . $arreglo_post["curso"] . "'";
}

$sql = "select * from tbl_inscripcion_curso where  id_empresa='" . $id_empresa . "' $filtro_curso $filtro_ejecutivo";

//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function REL_MALLA_CURSO_TraeCursosDadoFoco($id_empresa, $arreglo_post) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$filtro_perfilado = FiltroPerfilado($_SESSION["admin_"], $id_empresa, "rel_lms_malla_curso");

if ($arreglo_post["ejecutivo"] != '' and $arreglo_post["ejecutivo"] != '0') {
$filtro_ejecutivo = "  and rel_lms_malla_curso.id_curso  in (SELECT distinct(tbl_inscripcion_curso.id_curso) from tbl_inscripcion_curso where tbl_inscripcion_curso.ejecutivo='" . $arreglo_post["ejecutivo"] . "')
";
}

if ($arreglo_post["foco"] != '' and $arreglo_post["foco"] != '0') {
$filtro_foco = " and  rel_lms_malla_curso.id_foco = '" . $arreglo_post["foco"] . "'";
}

if ($arreglo_post["programabbdd"] != '' and $arreglo_post["programabbdd"] != '0') {
$filtro_programabbdd = " and  rel_lms_malla_curso.id_programa = '" . $arreglo_post["programabbdd"] . "'";
}

if ($arreglo_post["malla"] != '' and $arreglo_post["malla"] != '0') {
$filtro_malla = "  and rel_lms_malla_curso.id_malla= '" . $arreglo_post["malla"] . "'";
$filtro_programabbdd="";  $filtro_foco="";$filtro_ejecutivo="";
}

if ($arreglo_post["clasificacion"] != '' and $arreglo_post["clasificacion"] != '0') {
$filtro_clasificacion = " and  rel_lms_malla_curso.id_clasificacion= '" . $arreglo_post["clasificacion"] . "'";
}

if ($arreglo_post["cursos"] != '' and $arreglo_post["cursos"] != '0') {
if (is_array($arreglo_post["cursos"])) {
} else {
$filtro_curso = " and  rel_lms_malla_curso.id_curso= '" . $arreglo_post["cursos"] . "'";
}
}

$sql = "select distinct(rel_lms_malla_curso.id_curso), tbl_lms_curso.nombre as nombre
from rel_lms_malla_curso
inner join tbl_lms_curso
on tbl_lms_curso.id=rel_lms_malla_curso.id_curso

where rel_lms_malla_curso.id_empresa='$id_empresa'  and rel_lms_malla_curso.inactivo<>'1'  $filtro_perfilado
$filtro_foco $filtro_programabbdd $filtro_malla $filtro_clasificacion $filtro_curso $filtro_ejecutivo order by nombre asc
";

//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function REL_MALLA_CURSO_TraeClasificacionesDadoFoco($id_empresa, $arreglo_post) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$filtro_perfilado = FiltroPerfilado($_SESSION["admin_"], $id_empresa, "rel_lms_malla_curso");

if ($arreglo_post["ejecutivo"] != '' and $arreglo_post["ejecutivo"] != '0') {
$filtro_ejecutivo = "  and rel_lms_malla_curso.id_curso  in (SELECT distinct(tbl_inscripcion_curso.id_curso) from tbl_inscripcion_curso where tbl_inscripcion_curso.ejecutivo='" . $arreglo_post["ejecutivo"] . "')
";
}

if ($arreglo_post["foco"] != '' and $arreglo_post["foco"] != '0') {
$filtro_foco = " and  rel_lms_malla_curso.id_foco = '" . $arreglo_post["foco"] . "'";
}

if ($arreglo_post["programabbdd"] != '' and $arreglo_post["programabbdd"] != '0') {
$filtro_programabbdd = " and  rel_lms_malla_curso.id_programa = '" . $arreglo_post["programabbdd"] . "'";
}

if ($arreglo_post["malla"] != '' and $arreglo_post["malla"] != '0') {
$filtro_malla = "  and rel_lms_malla_curso.id_malla= '" . $arreglo_post["malla"] . "'";
}

if ($arreglo_post["clasificacion"] != '' and $arreglo_post["clasificacion"] != '0') {
$filtro_clasificacion = " and  rel_lms_malla_curso.id_clasificacion= '" . $arreglo_post["clasificacion"] . "'";
}

if ($arreglo_post["cursos"] != '' and $arreglo_post["cursos"] != '0') {
$filtro_curso = " and  rel_lms_malla_curso.id_curso= '" . $arreglo_post["cursos"] . "'";
}

$sql = "select distinct(rel_lms_malla_curso.id_clasificacion), tbl_lms_clasificacion.clasificacion as nombre
from rel_lms_malla_curso
inner join tbl_lms_clasificacion
on tbl_lms_clasificacion.id_clasificacion=rel_lms_malla_curso.id_clasificacion

where rel_lms_malla_curso.id_empresa='$id_empresa'  $filtro_perfilado
$filtro_foco $filtro_programabbdd $filtro_malla $filtro_clasificacion $filtro_curso $filtro_ejecutivo  order by nombre asc
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function REL_MALLA_CURSO_TraeMallasDadoFoco($id_empresa, $arreglo_post) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$filtro_perfilado = FiltroPerfilado($_SESSION["admin_"], $id_empresa, "rel_lms_malla_curso");

if ($arreglo_post["ejecutivo"] != '' and $arreglo_post["ejecutivo"] != '0') {
$filtro_ejecutivo = "  and rel_lms_malla_curso.id_curso  in (SELECT distinct(tbl_inscripcion_curso.id_curso) from tbl_inscripcion_curso where tbl_inscripcion_curso.ejecutivo='" . $arreglo_post["ejecutivo"] . "')";
}

if ($arreglo_post["foco"] != '' and $arreglo_post["foco"] != '0') {
$filtro_foco = " and  rel_lms_malla_curso.id_foco = '" . $arreglo_post["foco"] . "'";
}

if ($arreglo_post["programabbdd"] != '' and $arreglo_post["programabbdd"] != '0') {
$filtro_programabbdd = " and  rel_lms_malla_curso.id_programa = '" . $arreglo_post["programabbdd"] . "'";
$filtro_foco="";
}

if ($arreglo_post["malla"] != '' and $arreglo_post["malla"] != '0') {
$filtro_malla = "  and rel_lms_malla_curso.id_malla= '" . $arreglo_post["malla"] . "'";
}

if ($arreglo_post["clasificacion"] != '' and $arreglo_post["clasificacion"] != '0') {
$filtro_clasificacion = " and  rel_lms_malla_curso.id_clasificacion= '" . $arreglo_post["clasificacion"] . "'";
}

if ($arreglo_post["cursos"] != '' and $arreglo_post["cursos"] != '0') {
if (is_array($arreglo_post["cursos"])) {
} else {
$filtro_curso = " and  rel_lms_malla_curso.id_curso= '" . $arreglo_post["cursos"] . "'";
}

//$filtro_curso=" and  rel_lms_malla_curso.id_curso= '".$arreglo_post["cursos"]."'";
}

$sql = "select distinct(rel_lms_malla_curso.id_malla), tbl_lms_malla.nombre as nombre
from rel_lms_malla_curso
inner join tbl_lms_malla
on tbl_lms_malla.id=rel_lms_malla_curso.id_malla

where rel_lms_malla_curso.id_empresa='$id_empresa' and rel_lms_malla_curso.inactivo<>'1' $filtro_perfilado
$filtro_foco $filtro_programabbdd $filtro_malla $filtro_clasificacion $filtro_curso $filtro_ejecutivo  order by nombre asc
";

// echo $sql;exit;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}
function TraeProgramasGlobalDadoFoco($id_empresa, $arreglo_post) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

//echo "<br>id_empresa $id_empresa, arreglo $arreglo_post<br>";
//print_r($arreglo_post);

$sql = "  select h.id_programa_global, h.programa_global
from tbl_lms_programas_bbdd h
where h.codigo_foco='" . $arreglo_post[foco] . "'
and h.programa_global<>'' group by h.id_programa_global  ";
$sql="
select h.id_programa, h.nombre_programa
from tbl_lms_programas_bbdd h
where h.codigo_foco='" . $arreglo_post[foco] . "'   and h.tipo='GLOBAL'  order by h.programa_global ASC
" ;
// echo "<br>sql $sql<br>";exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

// print_r($cod);
return $cod;
}

function TraeProgramasElearningDadoFocoProgramaGlobal($id_empresa, $foco, $id_programa_global) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

//echo "<br>id_empresa $id_empresa, id foco $foco, id programa $id_programa_global";
//print_r($arreglo_post);
if ($foco != '') {$queryFoco = "  and h.codigo_foco='$foco' ";} else { $queryFoco = " ";}

//$queryFoco

if ($id_programa_global != '') {$queryProgramaGlobal = "  and h.id_programa_global='$id_programa_global' ";} else { $queryProgramaGlobal = " ";}

$sql = "

select h.id_programa,h.nombre_programa


from tbl_lms_programas_bbdd h where h.id_empresa='$id_empresa' and h.id_programa<>''
$queryProgramaGlobal

group by h.id_programa order by h.nombre_programa ASC


";

// echo "<br>sql $sql<br>";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

// print_r($cod);
return $cod;
}
function BuscaOkReco($rut_destinatario,$rut_remitente,$categorita, $id_empresa){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql=" select count(id) as cuenta from tbl_reconoce_gracias h where h.id_empresa='$id_empresa'

and rut_remitente='$rut_remitente' and rut_destinatario='$rut_destinatario' and estado='OK'

AND categorita='$categorita'   and tipo<>'GRACIAS'

";
//echo "<br>$sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

// print_r($cod);
return $cod[0]->cuenta;
}
function RECO_Query_Descarga_estado($id_empresa, $tipo2, $year, $s, $tipo, $estado){

//echo "<br>DATA<br>RECO_Query_Descarga_estado($id_empresa, year $year, s $s, tipo $tipo, estado $estado";

$query_s="";

if($year=="2019"){
if($tipo=="sel"){
$fecha_inicio_sem1="2019-01-01";
$fecha_termino_sem1="2019-08-19";
$fecha_inicio_sem2="2019-08-20";
$fecha_termino_sem2="2020-02-28";
}
if($tipo=="col"){
$fecha_inicio_sem1="2019-03-01";
$fecha_termino_sem1="2019-06-31";
$fecha_inicio_sem2="2019-12-01";
$fecha_termino_sem2="2020-02-28";
}
}

if($year=="2020"){
if($tipo=="sel"){
$fecha_inicio_sem1=$year."-03-01";
$fecha_termino_sem1=$year."-06-31";
$fecha_inicio_sem2=$year."-07-01";
$fecha_termino_sem2=$year."-12-31";
}
if($tipo=="col"){
$fecha_inicio_sem1=$year."-03-01";
$fecha_termino_sem1=$year."-06-31";
$fecha_inicio_sem2=$year."-07-01";
$fecha_termino_sem2=$year."-12-31";
}
}

if($s==1){ $query_s=" and h.fecha >='$fecha_inicio_sem1' and  h.fecha <='$fecha_termino_sem1' ";}
if($s==2){ $query_s=" and h.fecha >='$fecha_inicio_sem2' and  h.fecha <='$fecha_termino_sem2' ";}

$query_tipo="";
if($tipo=="sel"){
$query_tipo=" and h.id_categoria='Reconocimiento Seleccion del Chile 2019'";
}

if($tipo=="col"){
$query_tipo=" and h.id_categoria='COLABORACION'";
}

//echo "<br> $id_empresa, $tipo, $estado";
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if($estado=="OK"){    $query_estado=" and h.estado='OK' ";
$sql = "

select h.*

from tbl_reconoce_gracias h where h.id_empresa='$id_empresa'

$query_estado
$query_s
$query_tipo
order by h.id DESC



";
} else {    $query_estado=" ";

}
if($estado=="PENDIENTE"){    $query_estado=" and h.estado='PENDIENTE' ";

$sql = "

select h.*

from tbl_reconoce_gracias h where h.id_empresa='$id_empresa'
$query_estado
$query_s
$query_tipo

order by h.id DESC



";
} else {    $query_estado=" ";


//echo "<br>sql<br>$sql";exit();

}

if($estado=="APROBADO"){    $query_estado=" and h.estado='APROBADO' ";

$sql = "

select h.*

from tbl_reconoce_gracias h where h.id_empresa='$id_empresa'
$query_estado
$query_s
$query_tipo
order by h.id DESC



";
} else {    $query_estado=" ";

}

// echo "<br>sql $sql<br>";exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

// print_r($cod);
return $cod;

}

function RECO_Query_Descarga($id_empresa, $tipo, $year){



global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);



$sql = "

select h.*

from tbl_reconoce_gracias h where h.id_empresa='$id_empresa'
and h.tipo='$tipo'
and YEAR(h.fecha)='$year'
order by id DESC

";

// echo "<br>sql $sql<br>";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

// print_r($cod);
return $cod;

}

function lms_reportes_full_excel_filtro_rut_data($id_empresa, $id_foco, $id_programa, $id_programa_elearning, $id_malla, $id_curso,
$tipo_filtro, $imparticion, $ejecutivo, $modalidad, $fecha_inicio, $fecha_termino, $estado) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
/* echo   "<br>lms_reportes_full_excel_data<br>$id_empresa, $id_foco, $id_programa, $id_programa_elearning, $id_malla, $id_curso,
$tipo_filtro, $imparticion, $ejecutivo, MODALIDAD $modalidad, FI $fecha_inicio, FT $fecha_termino, ESTADO $estado";
*/
if ($id_foco != "0")                {$QueryIdFoco = " and h.id_foco='$id_foco' ";}                          else { $QueryIdFoco = "";}
if ($id_programa != "0")            {$QueryIdPrograma = " and h.id_programa_global='$id_programa' ";}       else { $QueryIdPrograma = "";}
if ($id_programa_elearning != "0")  {$QueryId_programa_elearning = " and h.id_programa='$id_programa_elearning' ";} else { $QueryId_programa_elearning = "";}
if ($id_malla != "0")               {$QueryIdMalla = " and h.id_malla='$id_malla' ";}                       else { $QueryIdMalla = "";}
if ($id_curso != "0")               {$QueryIdCurso = " and h.id_curso='$id_curso' ";}                       else { $QueryIdCurso = "";}
if ($imparticion != "0")            {$QueryIdImparticion    = " and h.id_inscripcion='$imparticion' ";}     else { $QueryIdImparticion = "";}
if ($ejecutivo != "0")              {$QueryEjecutivo        = " and h.rut_ejecutivo='$id_curso' ";}         else { $QueryEjecutivo = "";}
if ($modalidad != "0")              {$QueryModalidad        = " and h.status='$modalidad' ";}               else { $QueryModalidad = "";}
if ($fecha_inicio != "")            {$fecha_inicio=$fecha_inicio."-01";
$QueryFecha_inicio     = " and h.fecha_inicio>='$fecha_inicio' ";}          else { $QueryFecha_inicio = "";}
if ($fecha_termino != "")           {$fecha_termino=$fecha_termino."-31";
$QueryFecha_termino    = " and h.fecha_termino<='$fecha_termino' ";}         else { $QueryFecha_termino = "";}
if ($estado != "0")                 {

if($estado=="FINALIZADO")   { $QEstado=" and h.asistencia='100%'  ";}
if($estado=="EN_PROCESO")   { $QEstado=" and h.asistencia<>'100%' and h.asistencia='0%'  ";}
if($estado=="NO_INICIADO")  { $QEstado=" and h.asistencia='0%'  ";}

$QueryEstado           = $QEstado;} else { $QueryEstado = "";}

$sql = "  select h.* from tbl_lms_reportes_full h where h.id>0
$QueryIdFoco
$QueryIdPrograma
$QueryId_programa_elearning
$QueryIdMalla
$QueryIdCurso
$QueryIdImparticion
$QueryEjecutivo
$QueryModalidad
$QueryFecha_inicio
$QueryFecha_termino
$QueryEstado

group by h.rut
order by h.nombre
";
// echo "<br>sql<br> $sql<br>";      exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//print_r($cod);
return $cod;
}

function lms_reportes_full_excel_data($id_empresa, $id_foco, $id_programa, $id_programa_elearning, $id_malla, $id_curso,
$tipo_filtro, $imparticion, $ejecutivo, $modalidad, $fecha_inicio, $fecha_termino, $estado) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
/* echo   "<br>lms_reportes_full_excel_data<br>$id_empresa, $id_foco, $id_programa, $id_programa_elearning, $id_malla, $id_curso,
$tipo_filtro, $imparticion, $ejecutivo, MODALIDAD $modalidad, FI $fecha_inicio, FT $fecha_termino, ESTADO $estado";
*/
if ($id_foco != "0")                {$QueryIdFoco = " and h.id_foco='$id_foco' ";}                          else { $QueryIdFoco = "";}
if ($id_programa != "0")            {$QueryIdPrograma = " and h.id_programa_global='$id_programa' ";}       else { $QueryIdPrograma = "";}
if ($id_programa_elearning != "0")  {$QueryId_programa_elearning = " and h.id_programa='$id_programa_elearning' ";} else { $QueryId_programa_elearning = "";}
if ($id_malla != "0")               {$QueryIdMalla = " and h.id_malla='$id_malla' ";}                       else { $QueryIdMalla = "";}
if ($id_curso != "0")               {$QueryIdCurso = " and h.id_curso='$id_curso' ";}                       else { $QueryIdCurso = "";}
if ($imparticion != "0")            {$QueryIdImparticion    = " and h.id_inscripcion='$imparticion' ";}     else { $QueryIdImparticion = "";}
if ($ejecutivo != "0")              {$QueryEjecutivo        = " and h.rut_ejecutivo='$id_curso' ";}         else { $QueryEjecutivo = "";}
if ($modalidad != "0")              {$QueryModalidad        = " and h.status='$modalidad' ";}               else { $QueryModalidad = "";}
if ($fecha_inicio != "")            {$fecha_inicio=$fecha_inicio."-01";
$QueryFecha_inicio     = " and h.fecha_inicio>='$fecha_inicio' ";}          else { $QueryFecha_inicio = "";}
if ($fecha_termino != "")           {$fecha_termino=$fecha_termino."-31";
$QueryFecha_termino    = " and h.fecha_termino<='$fecha_termino' ";}         else { $QueryFecha_termino = "";}
if ($estado != "0")                 {

if($estado=="FINALIZADO")   { $QEstado=" and h.asistencia='100%'  ";}
if($estado=="EN_PROCESO")   { $QEstado=" and h.asistencia<>'100%' and h.asistencia='0%'  ";}
if($estado=="NO_INICIADO")  { $QEstado=" and h.asistencia='0%'  ";}

$QueryEstado           = $QEstado;} else { $QueryEstado = "";}

$sql = "  select h.* from tbl_lms_reportes_full h where h.id>0
$QueryIdFoco
$QueryIdPrograma
$QueryId_programa_elearning
$QueryIdMalla
$QueryIdCurso
$QueryIdImparticion
$QueryEjecutivo
$QueryModalidad
$QueryFecha_inicio
$QueryFecha_termino
$QueryEstado

order by h.nombre
";
//echo "<br>sql<br> $sql<br>";      exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//print_r($cod);
return $cod;
}

function lms_reportes_full_excel_solocurso_data($id_empresa, $id_foco, $id_programa, $id_programa_elearning, $id_malla, $id_curso,
$tipo_filtro, $imparticion, $ejecutivo, $modalidad, $fecha_inicio, $fecha_termino, $estado) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
/* echo   "<br>lms_reportes_full_excel_data<br>$id_empresa, $id_foco, $id_programa, $id_programa_elearning, $id_malla, $id_curso,
$tipo_filtro, $imparticion, $ejecutivo, MODALIDAD $modalidad, FI $fecha_inicio, FT $fecha_termino, ESTADO $estado";
*/
if ($id_foco != "0")                {$QueryIdFoco = " and h.id_foco='$id_foco' ";}                          else { $QueryIdFoco = "";}
if ($id_programa != "0")            {$QueryIdPrograma = " and h.id_programa_global='$id_programa' ";}       else { $QueryIdPrograma = "";}
if ($id_programa_elearning != "0")  {$QueryId_programa_elearning = " and h.id_programa='$id_programa_elearning' ";} else { $QueryId_programa_elearning = "";}
if ($id_malla != "0")               {$QueryIdMalla = " and h.id_malla='$id_malla' ";}                       else { $QueryIdMalla = "";}
if ($id_curso != "0")               {$QueryIdCurso = " and h.id_curso='$id_curso' ";}                       else { $QueryIdCurso = "";}
if ($imparticion != "0")            {$QueryIdImparticion    = " and h.id_inscripcion='$imparticion' ";}     else { $QueryIdImparticion = "";}
if ($ejecutivo != "0")              {$QueryEjecutivo        = " and h.rut_ejecutivo='$id_curso' ";}         else { $QueryEjecutivo = "";}
if ($modalidad != "0")              {$QueryModalidad        = " and h.status='$modalidad' ";}               else { $QueryModalidad = "";}
if ($fecha_inicio != "")            {$fecha_inicio=$fecha_inicio."-01";
$QueryFecha_inicio     = " and h.fecha_inicio>='$fecha_inicio' ";}          else { $QueryFecha_inicio = "";}
if ($fecha_termino != "")           {$fecha_termino=$fecha_termino."-31";
$QueryFecha_termino    = " and h.fecha_termino<='$fecha_termino' ";}         else { $QueryFecha_termino = "";}
if ($estado != "0")                 {

if($estado=="FINALIZADO")   { $QEstado=" and h.asistencia='100%'  ";}
if($estado=="EN_PROCESO")   { $QEstado=" and h.asistencia<>'100%'   and h.asistencia='0%'  ";}
if($estado=="NO_INICIADO")  { $QEstado=" and h.asistencia='0%'  ";}

$QueryEstado           = $QEstado;} else { $QueryEstado = "";}

$sql = "
select h.* from tbl_lms_reportes_full h where h.id>0

$QueryIdFoco
$QueryIdPrograma
$QueryId_programa_elearning
$QueryIdMalla
$QueryIdCurso
$QueryIdImparticion
$QueryEjecutivo
$QueryModalidad
$QueryFecha_inicio
$QueryFecha_termino
$QueryEstado

group by h.id_curso
order by h.curso
";
//echo "<br>sql<br> $sql<br>";      exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//print_r($cod);
return $cod;
}

function lms_reportes_full_excel_solocurso_rut_data($id_empresa, $id_foco, $id_programa, $id_programa_elearning, $id_malla, $id_curso,
$tipo_filtro, $imparticion, $ejecutivo, $modalidad, $fecha_inicio, $fecha_termino, $estado, $rut) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
/* echo   "<br>lms_reportes_full_excel_data<br>$id_empresa, $id_foco, $id_programa, $id_programa_elearning, $id_malla, $id_curso,
$tipo_filtro, $imparticion, $ejecutivo, MODALIDAD $modalidad, FI $fecha_inicio, FT $fecha_termino, ESTADO $estado";
*/
if ($id_foco != "0")                {$QueryIdFoco = " and h.id_foco='$id_foco' ";}                          else { $QueryIdFoco = "";}
if ($id_programa != "0")            {$QueryIdPrograma = " and h.id_programa_global='$id_programa' ";}       else { $QueryIdPrograma = "";}
if ($id_programa_elearning != "0")  {$QueryId_programa_elearning = " and h.id_programa='$id_programa_elearning' ";} else { $QueryId_programa_elearning = "";}
if ($id_malla != "0")               {$QueryIdMalla = " and h.id_malla='$id_malla' ";}                       else { $QueryIdMalla = "";}
if ($id_curso != "0")               {$QueryIdCurso = " and h.id_curso='$id_curso' ";}                       else { $QueryIdCurso = "";}
if ($imparticion != "0")            {$QueryIdImparticion    = " and h.id_inscripcion='$imparticion' ";}     else { $QueryIdImparticion = "";}
if ($ejecutivo != "0")              {$QueryEjecutivo        = " and h.rut_ejecutivo='$id_curso' ";}         else { $QueryEjecutivo = "";}
if ($modalidad != "0")              {$QueryModalidad        = " and h.status='$modalidad' ";}               else { $QueryModalidad = "";}
if ($fecha_inicio != "")            {$fecha_inicio=$fecha_inicio."-01";
$QueryFecha_inicio     = " and h.fecha_inicio>='$fecha_inicio' ";}          else { $QueryFecha_inicio = "";}
if ($fecha_termino != "")           {$fecha_termino=$fecha_termino."-31";
$QueryFecha_termino    = " and h.fecha_termino<='$fecha_termino' ";}         else { $QueryFecha_termino = "";}
if ($estado != "0")                 {

if($estado=="FINALIZADO")   { $QEstado=" and h.asistencia='100%'  ";}
if($estado=="EN_PROCESO")   { $QEstado=" and h.asistencia<>'100%'   and h.asistencia='0%'  ";}
if($estado=="NO_INICIADO")  { $QEstado=" and h.asistencia='0%'  ";}

$QueryEstado           = $QEstado;} else { $QueryEstado = "";}

$sql = "
select h.* from tbl_lms_reportes_full h where h.id>0

$QueryIdFoco
$QueryIdPrograma
$QueryId_programa_elearning
$QueryIdMalla
$QueryIdCurso
$QueryIdImparticion
$QueryEjecutivo
$QueryModalidad
$QueryFecha_inicio
$QueryFecha_termino
$QueryEstado
and h.rut='$rut'  and h.id_curso='$id_curso'
group by h.id_curso
order by h.curso
";
//echo "<br>sql<br> $sql<br>";      exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//print_r($cod);
return $cod;
}

function lms_reportes_full_excel_rut_data($id_empresa, $id_foco, $id_programa, $id_programa_elearning, $id_malla, $id_curso,
$tipo_filtro, $imparticion, $ejecutivo, $modalidad, $fecha_inicio, $fecha_termino, $estado, $rut) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
/* echo   "<br>lms_reportes_full_excel_data<br>$id_empresa, $id_foco, $id_programa, $id_programa_elearning, $id_malla, $id_curso,
$tipo_filtro, $imparticion, $ejecutivo, MODALIDAD $modalidad, FI $fecha_inicio, FT $fecha_termino, ESTADO $estado";
*/
if ($id_foco != "0")                {$QueryIdFoco = " and h.id_foco='$id_foco' ";}                          else { $QueryIdFoco = "";}
if ($id_programa != "0")            {$QueryIdPrograma = " and h.id_programa_global='$id_programa' ";}       else { $QueryIdPrograma = "";}
if ($id_programa_elearning != "0")  {$QueryId_programa_elearning = " and h.id_programa='$id_programa_elearning' ";} else { $QueryId_programa_elearning = "";}
if ($id_malla != "0")               {$QueryIdMalla = " and h.id_malla='$id_malla' ";}                       else { $QueryIdMalla = "";}
if ($id_curso != "0")               {$QueryIdCurso = " and h.id_curso='$id_curso' ";}                       else { $QueryIdCurso = "";}
if ($imparticion != "0")            {$QueryIdImparticion    = " and h.id_inscripcion='$imparticion' ";}     else { $QueryIdImparticion = "";}
if ($ejecutivo != "0")              {$QueryEjecutivo        = " and h.rut_ejecutivo='$id_curso' ";}         else { $QueryEjecutivo = "";}
if ($modalidad != "0")              {$QueryModalidad        = " and h.status='$modalidad' ";}               else { $QueryModalidad = "";}
if ($fecha_inicio != "")            {$fecha_inicio=$fecha_inicio."-01";
$QueryFecha_inicio     = " and h.fecha_inicio>='$fecha_inicio' ";}          else { $QueryFecha_inicio = "";}
if ($fecha_termino != "")           {$fecha_termino=$fecha_termino."-31";
$QueryFecha_termino    = " and h.fecha_termino<='$fecha_termino' ";}         else { $QueryFecha_termino = "";}
if ($estado != "0")                 {

if($estado=="FINALIZADO")   { $QEstado=" and h.asistencia='100%'  ";}
if($estado=="EN_PROCESO")   { $QEstado=" and h.asistencia<>'100%' and h.asistencia='0%'  ";}
if($estado=="NO_INICIADO")  { $QEstado=" and h.asistencia='0%'  ";}

$QueryEstado           = $QEstado;} else { $QueryEstado = "";}

$sql = "  select h.* from tbl_lms_reportes_full h where h.id>0
$QueryIdFoco
$QueryIdPrograma
$QueryId_programa_elearning
$QueryIdMalla
$QueryIdCurso
$QueryIdImparticion
$QueryEjecutivo
$QueryModalidad
$QueryFecha_inicio
$QueryFecha_termino
$QueryEstado
and h.rut='$rut'
order by h.nombre
";
//echo "<br>sql<br> $sql<br>";      exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//print_r($cod);
return $cod;
}

function REL_MALLA_CURSO_TraeProgramasDadoFoco($id_empresa, $arreglo_post) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$filtro_perfilado = FiltroPerfilado($_SESSION["admin_"], $id_empresa, "rel_lms_malla_curso");

if ($arreglo_post["ejecutivo"] != '' and $arreglo_post["ejecutivo"] != '0') {
$filtro_ejecutivo = "  and rel_lms_malla_curso.id_curso  in (SELECT distinct(tbl_inscripcion_curso.id_curso) from tbl_inscripcion_curso where tbl_inscripcion_curso.ejecutivo='" . $arreglo_post["ejecutivo"] . "')

";
}

if ($arreglo_post["foco"] != '' and $arreglo_post["foco"] != '0') {
$filtro_foco = " and  rel_lms_malla_curso.id_foco = '" . $arreglo_post["foco"] . "'";
}

if ($arreglo_post["programabbdd"] != '' and $arreglo_post["programabbdd"] != '0') {
$filtro_programabbdd = " and  rel_lms_malla_curso.id_programa = '" . $arreglo_post["programabbdd"] . "'";
}

if ($arreglo_post["malla"] != '' and $arreglo_post["malla"] != '0') {
$filtro_malla = "  and rel_lms_malla_curso.id_malla= '" . $arreglo_post["malla"] . "'";
}

if ($arreglo_post["clasificacion"] != '' and $arreglo_post["clasificacion"] != '0') {
$filtro_clasificacion = " and  rel_lms_malla_curso.id_clasificacion= '" . $arreglo_post["clasificacion"] . "'";
}

if ($arreglo_post["cursos"] != '' and $arreglo_post["cursos"] != '0') {
$filtro_curso = " and  rel_lms_malla_curso.id_curso= '" . $arreglo_post["cursos"] . "'";
}

$sql = "select distinct(rel_lms_malla_curso.id_programa), tbl_lms_programas_bbdd.nombre_programa as nombre
from rel_lms_malla_curso
inner join tbl_lms_programas_bbdd
on tbl_lms_programas_bbdd.id_programa=rel_lms_malla_curso.id_programa
where rel_lms_malla_curso.id_empresa='$id_empresa'  $filtro_perfilado
$filtro_foco $filtro_programabbdd $filtro_malla $filtro_clasificacion $filtro_curso $filtro_ejecutivo

order by tbl_lms_programas_bbdd.nombre_programa
";

//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function IMPARTICION_UsuariosPorInscripcionConDatosUsuario($id_inscripcion, $id_empresa, $datos_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
//print_r($datos_empresa);
if ($datos_empresa[0]->campo1) {
$c1 = " tbl_usuario." . $datos_empresa[0]->campo1 . " as c1, ";
}

if ($datos_empresa[0]->campo2) {
$c2 = " tbl_usuario." . $datos_empresa[0]->campo2 . " as c2, ";
}

if ($datos_empresa[0]->campo3) {
$c3 = " tbl_usuario." . $datos_empresa[0]->campo3 . " as c3, ";
}

$sql = "SELECT
tbl_usuario.nombre_completo,tbl_usuario.cargo,
tbl_usuario.cargo as cargoUsuario, $c1 $c2 $c3 tbl_inscripcion_usuarios.*
FROM
tbl_inscripcion_usuarios

left join tbl_usuario
on tbl_usuario.rut=tbl_inscripcion_usuarios.rut
WHERE
tbl_inscripcion_usuarios.id_inscripcion = '$id_inscripcion'
AND tbl_inscripcion_usuarios.id_empresa = '$id_empresa'
";

//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

//print_r($cod);

return $cod;
}

function verifica_CantidadCheckinVsSesionesImparticion($rut, $id_inscripcion, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "

SELECT h.codigo_inscripcion, (h.sesiones),
(select count(id) as cuenta from rel_lms_inscripcion_usuario_checkin where
codigo_imparticion='$id_inscripcion' and rut='$rut' and id_empresa='$id_empresa') as cuentaCheck
from tbl_inscripcion_curso    h

WHERE

h.codigo_inscripcion = '$id_inscripcion' and h.id_empresa='$id_empresa'
";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

//echo $sql;

return $cod;
}

function ENC_CuentaDeRespuestasPorPregunta_7opciones_CriterioCH($id_empresa, $id_encuesta, $id_pregunta, $array_objetos, $criterio) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$cuenta_arreglo = count($array_objetos);

if ($cuenta_arreglo == 1) {
$id_objeto = $array_objetos[0]->id;
$query_arreglo_objeto = " and id_objeto='$id_objeto' ";
}
if ($cuenta_arreglo > 1) {
$query_arreglo_objetoI = " and ( ";
foreach ($array_objetos as $array_objeto) {
$query_arreglo_objetoM .= " id_objeto='" . $array_objeto->id . "' OR ";
}

$query_arreglo_objetoF = " id<>id) ";
$query_arreglo_objeto = $query_arreglo_objetoI . $query_arreglo_objetoM . $query_arreglo_objetoF;
}

$sql = "            select count(h.id) as cuenta,

(select count(id) from tbl_enc_satis_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and respuesta='1') as cuenta1,
(select count(id) from tbl_enc_satis_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and respuesta='2') as cuenta2,
(select count(id) from tbl_enc_satis_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and respuesta='3') as cuenta3,
(select count(id) from tbl_enc_satis_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and respuesta='4') as cuenta4,
(select count(id) from tbl_enc_satis_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and respuesta='5') as cuenta5,
(select count(id) from tbl_enc_satis_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and respuesta='6') as cuenta6,
(select count(id) from tbl_enc_satis_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and respuesta='7') as cuenta7,
(select count(id) from tbl_enc_satis_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' ) as cuentaPreg

from tbl_enc_satis_respuestas h

where h.id_empresa='$id_empresa'
and h.id_encuesta='$id_encuesta'
and h.id_objeto='$id_objeto'
and h.id_pregunta='$id_pregunta'";

//    echo "<br>.$sql";
//exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function EventosBorrarInscrito($rut_col,$codigo, $id_empresa){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "delete from tbl_eventos_inscritos where id_empresa='$id_empresa' and codigo='$codigo' and rut='$rut_col'";


echo "<br>Z sql<br>$sql";

$database->setquery($sql);
$database->query();
}

function IMPARTICION_EliminaUsuariosInscripcionUsuario($codigo_imparticion, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "delete from tbl_inscripcion_usuarios where id_empresa='$id_empresa' and id_inscripcion='$codigo_imparticion'";

$database->setquery($sql);
$database->query();
}



function IMPARTICION_UsuariosPorInscripcion($id_inscripcion, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT * from tbl_inscripcion_usuarios
WHERE
id_inscripcion = '$id_inscripcion' and id_empresa='$id_empresa'
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}





function TraeEjecutivosPorEmpresa($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "SELECT distinct(h.ejecutivo), (select nombre_completo from tbl_usuario where rut= h.ejecutivo) as             nombre_completo

FROM tbl_inscripcion_curso h

WHERE h.id_empresa = '$id_empresa' and h.ejecutivo<>'' and h.ejecutivo<>'0'
order by
(select nombre_completo from tbl_usuario where rut= h.ejecutivo) asc";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function Lms_Busca_Objetos_Enc_sat_Imparticion($arreglo_post, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

// $id_malla=$arreglo_post[""]
$id_curso = $arreglo_post["curso"];
if ($arreglo_post["cursos"][0]) {
$id_curso = $arreglo_post["cursos"][0];
}
$id_curso = $arreglo_post["cursos"];
$id_foco = $arreglo_post["foco"];
$id_programa = $arreglo_post["programabbdd"];
$id_imparticion = $arreglo_post["imparticion"];
$ejecutivo = $arreglo_post["ejecutivo"];

$fechas = $arreglo_post[fechas];
$fechasString = explode(" - ", $fechas);
$fechaInicio = $fechasString[0]; // porcin1
$fechaTermino = $fechasString[1]; // porcin2

if ($id_curso != '' and $id_curso != '0') {$querycursos = " And h.id_curso='$id_curso' ";}
if ($fechaInicio != '') {$queryFechaInicio = " and DATE(h.fecha_inicio) BETWEEN '$fechaInicio' ";}
if ($fechaTermino != '') {$queryFechaTermino = " And '$fechaTermino' ";}
if ($ejecutivo != '' and $ejecutivo != '0') {$queryejecutivos = " And h.ejecutivo='$ejecutivo' ";}
if ($id_imparticion != '' and $id_imparticion != '0') {$queryimparticion = " And h.codigo_inscripcion='$id_imparticion' ";}
//if($jefe<>''  and $jefe<>'0'){$queryjefe=" And (select jefe from tbl_enc_evidencias_respuestas where id_curso=h.id and id_empresa='$id_empresa')='$jefe'";}

$sql = "
select
(select id from tbl_objeto where tipo_objeto='6' and id_curso=h.codigo_inscripcion) as id,
h.codigo_inscripcion




from  tbl_inscripcion_curso h


where

id_empresa='$id_empresa' $querycursos $queryFechaInicio $queryFechaTermino $queryejecutivos $queryjefe $queryimparticion
and (select id from tbl_objeto where tipo_objeto='6' and id_curso=h.codigo_inscripcion) is not null
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lms_trae_relatores_por_sesion($imparticion, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.*,
(Select nombre from tbl_relatores where rut=h.relator) as nombre_relator,
(Select rut_completo from tbl_relatores where rut=h.relator) as rut_completo

from rel_lms_inscripcion_sesion h

where h.codigo_inscripcion='$imparticion' and h.id_empresa='$id_empresa' group by h.relator";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lms_lista_Imparticiones_filtros_($id_empresa, $arreglo_post) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

// $id_malla=$arreglo_post[""]
$id_curso = $arreglo_post["cursos"];
if ($arreglo_post["cursos"][0]) {
$id_curso = $arreglo_post["cursos"][0];
}
$id_curso = $arreglo_post["cursos"];
$id_foco = $arreglo_post["foco"];
$id_programa = $arreglo_post["programabbdd"];
$id_imparticion = $arreglo_post["imparticion"];
$ejecutivo = $arreglo_post["ejecutivo"];

$fechas = $arreglo_post[fechas];
$fechasString = explode(" - ", $fechas);
$fechaInicio = $fechasString[0]; // porcin1
$fechaTermino = $fechasString[1]; // porcin2

if ($id_curso != '' and $id_curso != '0') {$querycursos = " And h.id_curso='$id_curso' ";}
if ($fechaInicio != '') {$queryFechaInicio = " and DATE(h.fecha_inicio) BETWEEN '$fechaInicio' ";}
if ($fechaTermino != '') {$queryFechaTermino = " And '$fechaTermino' ";}
if ($ejecutivo != '' and $ejecutivo != '0') {$queryejecutivos = " And h.ejecutivo='$ejecutivo' ";}
if ($id_imparticion != '' and $id_imparticion != '0') {$queryimparticion = " And h.codigo_inscripcion='$id_imparticion' ";}
//if($jefe<>''  and $jefe<>'0'){$queryjefe=" And (select jefe from tbl_enc_evidencias_respuestas where id_curso=h.id and id_empresa='$id_empresa')='$jefe'";}

$sql = "select h.*,
(select count(id) from tbl_inscripcion_usuarios where id_curso=h.id_curso and id_empresa='$id_empresa' and id_inscripcion=h.codigo_inscripcion) as participantes,
(select count(id) from tbl_inscripcion_usuarios where id_curso=h.id_curso and id_empresa='$id_empresa' AND (relator='0' or relator is null) and id_inscripcion=h.codigo_inscripcion) as participantes_participantes,
(select count(id) from tbl_inscripcion_usuarios where id_curso=h.id_curso and id_empresa='$id_empresa' AND relator='1' and  id_inscripcion=h.codigo_inscripcion) as participantes_relator,
(select nombre from tbl_lms_curso where id=h.id_curso limit 1) as nombre_curso,
(select nombre_completo from tbl_usuario where rut=h.ejecutivo) as nombre_ejecutivo

from  tbl_inscripcion_curso h


where

id_empresa='$id_empresa' $querycursos $queryFechaInicio $queryFechaTermino $queryejecutivos $queryjefe $queryimparticion";

//echo $sql;exit;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeCursos_con_Enc_sat_Presencial($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

//echo "$id_malla,$id_empresa";

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT
tbl_inscripcion_curso.*,(
SELECT
count(id)AS cuentaencuestas
FROM
tbl_objeto
WHERE
tbl_objeto.id_curso = tbl_inscripcion_curso.codigo_inscripcion
AND tipo_objeto = '6'
)AS encuesta_presencial, tbl_lms_curso.nombre as nombre_curso
FROM
tbl_inscripcion_curso
left join tbl_lms_curso
on tbl_lms_curso.id=tbl_inscripcion_curso.id_curso
WHERE
tbl_inscripcion_curso.id_empresa = '$id_empresa' and (
SELECT
count(id)AS cuentaencuestas
FROM
tbl_objeto
WHERE
tbl_objeto.id_curso = tbl_inscripcion_curso.codigo_inscripcion
AND tipo_objeto = '6'
)>0 and tbl_lms_cursos.modalidad='2'

group by tbl_lms_curso.id
order by tbl_lms_curso.nombre asc



;

";

//echo $sql;
//echo "<br><br>";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TraeImparticionesPorCurso($id_curso, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($id_curso == "" or $id_curso == "0") {
$sql = "SELECT     tbl_inscripcion_curso.* ,(select count(id) from tbl_inscripcion_usuarios where id_inscripcion=tbl_inscripcion_curso.codigo_inscripcion) as participantes
FROM tbl_inscripcion_curso
WHERE tbl_inscripcion_curso.id_empresa='$id_empresa'     and (select modalidad from tbl_lms_curso where id=    tbl_inscripcion_curso.id_curso  and id_empresa='$id_empresa')='2'
ORDER BY tbl_inscripcion_curso.codigo_inscripcion ASC ";
} else {

$sql = "SELECT     tbl_inscripcion_curso.* ,(select count(id) from tbl_inscripcion_usuarios where id_inscripcion=tbl_inscripcion_curso.codigo_inscripcion) as participantes
FROM tbl_inscripcion_curso
WHERE tbl_inscripcion_curso.id_empresa='$id_empresa'   and tbl_inscripcion_curso.id_curso='$id_curso'   and (select modalidad from tbl_lms_curso where id=    tbl_inscripcion_curso.id_curso and id_empresa='$id_empresa')='2'
ORDER BY tbl_inscripcion_curso.codigo_inscripcion ASC ";
}

//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TraedatosDadoCampo($id_empresa, $campo) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "SELECT distinct($campo) as valor  FROM tbl_usuario WHERE tbl_usuario.id_empresa = '$id_empresa' order BY distinct($campo) asc";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeProgramasBBDDPorEmpresa($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

//Funcion para obtener perfiles por Rut Admin - desde tabla
$filtro_perfilado = FiltroPerfilado($_SESSION["admin_"], $id_empresa);

$sql = "SELECT

tbl_lms_programas_bbdd.*

FROM

tbl_lms_programas_bbdd

WHERE
tbl_lms_programas_bbdd.id_empresa = '$id_empresa' $filtro_perfilado
order BY
tbl_lms_programas_bbdd.nombre_programa asc";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeProgramasBBDDPorEmpresaElearning($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

//Funcion para obtener perfiles por Rut Admin - desde tabla
$filtro_perfilado = FiltroPerfilado($_SESSION["admin_"], $id_empresa);

$sql = "SELECT
tbl_lms_programas_bbdd.*
FROM
tbl_lms_programas_bbdd

WHERE
tbl_lms_programas_bbdd.id_empresa = '$id_empresa' $filtro_perfilado
and tbl_lms_programas_bbdd.tipo<>'GLOBAL'
order BY
tbl_lms_programas_bbdd.nombre_programa asc";

//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeFocosPorEmpresa($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$filtro_perfilado = FiltroPerfilado($_SESSION["admin_"], $id_empresa, "rel_lms_malla_curso");

$sql = "SELECT
tbl_lms_foco.*
FROM
tbl_lms_foco

left join rel_lms_malla_curso
on rel_lms_malla_curso.id_foco=tbl_lms_foco.codigo_foco


WHERE
tbl_lms_foco.id_empresa = '$id_empresa' $filtro_perfilado

GROUP BY codigo_foco


order BY
tbl_lms_foco.descripcion asc";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function IMPARTCION_Obtienefocos($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select tbl_lms_foco.* from tbl_lms_foco where id_empresa='$id_empresa'     order by descripcion ASC ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function IMPARTCION_MallaPorImparticion($id_imparticion) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select DISTINCT(rel_lms_malla_persona.id_malla) as id_malla, tbl_lms_programas_bbdd.nombre_programa

from rel_lms_malla_persona

inner join rel_lms_malla_programa
on rel_lms_malla_programa.id_malla=rel_lms_malla_persona.id_malla

inner join tbl_lms_programas_bbdd
on tbl_lms_programas_bbdd.id_programa=rel_lms_malla_programa.id_programa

where rel_lms_malla_persona.id_imparticion='$id_imparticion'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function IMPARTCION_VerificoEstaRelMallaPersona($rut, $id_malla, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select rel_lms_malla_persona.*  from rel_lms_malla_persona where id_malla='$id_malla' and id_empresa='$id_empresa' and rut='$rut'     ";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function IMPARTCION_ObtieneDatosProgramas($id_programa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select tbl_lms_programas_bbdd.* from tbl_lms_programas_bbdd where id_programa='$id_programa'     ";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function IMPARTCION_TraigoMallasPorProgramaPorEmpresa($id_programa, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "
select
distinct(rel_lms_malla_curso.id_malla) , tbl_lms_malla.nombre as nombre_malla
from rel_lms_malla_curso

inner join tbl_lms_malla
on tbl_lms_malla.id=rel_lms_malla_curso.id_malla
where rel_lms_malla_curso.id_programa='$id_programa' and rel_lms_malla_curso.id_empresa='$id_empresa'
order by nombre_malla
";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function IMPARTCION_TraigoMallasPorPrograma($id_programa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

//$sql = "select rel_lms_malla_programa.* from rel_lms_malla_programa where id_programa='$id_programa'     ";
$sql = "select rel_lms_malla_curso.* from rel_lms_malla_curso where id_programa='$id_programa'     ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function totalUsuariosPorMallas($id_empresa, $id_malla) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select count(DISTINCT(rut)) as cuenta from tbl_inscripcion_usuarios h where h.id_malla='$id_malla' and h.id_empresa='$id_empresa' and (select vigencia from tbl_usuario where rut=h.rut)='0' group by  h.id_malla
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function IMPARTCION_ObtieneProgramasBBDD($id_empresa, $id_programa, $id_curso) {
//   echo      "IMPARTCION_ObtieneProgramasBBDD($id_empresa, $id_programa, $id_curso)"; sleep(1);
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$QProg = "";
$QCurso = "";
if ($id_programa != '') {
$QProg = " and h.id_programa='$id_programa' ";
}

if ($id_curso != '') {
$QCurso = "";
}

$sql = "select h.*,
(select count(id) from rel_lms_malla_curso where id_programa=h.id_programa and id_malla<>'presencial')

from tbl_lms_programas_bbdd h where

h.id_empresa='$id_empresa'
$QProg
and (tipo='ELEARNING' or   tipo<>'GLOBAL')

AND
(select count(id) from rel_lms_malla_curso where id_programa=h.id_programa  and id_malla<>'presencial')>0  order by h.nombre_programa";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}


function IMPARTCION_ObtieneProgramasBBDDI($id_empresa, $id_programa, $id_curso) {
//   echo      "IMPARTCION_ObtieneProgramasBBDD($id_empresa, $id_programa, $id_curso)"; sleep(1);
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$QProg = "";
$QCurso = "";
if ($id_programa != '') {
$QProg = " and h.id_programa='$id_programa' ";
}

if ($id_curso != '') {
$QCurso = "";
}

$sql = "select h.*,
(select count(id) from rel_lms_malla_curso where id_programa=h.id_programa and id_malla<>'presencial')

from tbl_lms_programas_bbdd h where

h.id_empresa='$id_empresa'
$QProg
and (tipo='ELEARNING' or   tipo<>'GLOBAL')

AND
(select count(id) from rel_lms_malla_curso where id_programa=h.id_programa  and id_malla<>'presencial')>0  order by h.nombre_programa";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function CursosExtUsuariosNotasAsistencia($id_empresa, $id_curso) {
//   echo      "IMPARTCION_ObtieneProgramasBBDD($id_empresa, $id_programa, $id_curso)"; sleep(1);
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select h.*,
(select nombre_completo from tbl_usuario where rut=h.rut)  as nombreusuario,
(select nombre from tbl_lms_curso where id= h.id_curso limit 1) as nombrecurso,
(select avance from tbl_inscripcion_cierre where rut=h.rut and id_curso=h.id_curso order by avance DESC limit 1) as avance,
(select estado_descripcion from tbl_inscripcion_cierre where rut=h.rut and id_curso=h.id_curso order by avance DESC limit 1) as estado_descripcion,
(select nota from tbl_inscripcion_cierre where rut=h.rut and id_curso=h.id_curso order by avance DESC limit 1) as nota,
(select fecha_inicio from tbl_inscripcion_cierre where rut=h.rut and id_curso=h.id_curso order by avance DESC limit 1) as fecha

from tbl_inscripcion_usuarios h

where  h.id_curso='$id_curso' and h.id_empresa='$id_empresa'

order by (select nombre_completo from tbl_usuario where rut=h.rut) ASC
";

//echo $sql; Sleep(2);

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ConsultadatosBoxMatris($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_sgd_matriz_criterios where tipo_objeto='nota_final' and id_empresa='66'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function borrarTblUsuarioRelMalla($idEmpresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
//    $sql = "delete from tbl_usuario where id_empresa='$idEmpresa'";

//$database->setquery($sql);
//$database->query();

$sql = "delete from rel_lms_malla_persona where id_empresa='$idEmpresa'";
$database->setquery($sql);
$database->query();
}

function Lms_avanceEsperadoData($dia, $id_malla, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_lms_malla_avance_esperado where dia='$dia' and id_malla='$id_malla' and id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}
function BorraTblLmsReporte() {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "delete from tbl_lms_reportes";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

echo "<br>BorraTblLmsReporte $sql<br>";
}

function TraeLocal($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT distinct(local) as valor
FROM tbl_usuario
where id_empresa='$id_empresa'
and local<>''

GROUP BY valor asc";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeSucursales($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT distinct(sucursal) as valor
FROM tbl_usuario
where id_empresa='$id_empresa'
and sucursal<>''

GROUP BY valor asc";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function sgd_relaciones_procesoConResultados($id_empresa, $id_proceso, $arreglo_post, $criterio, $valor) {global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$datos_empresa = DatosEmpresa($id_empresa);

$campos_subida = REL_MALLA_CURSO_trarCamposSubidaParaReporte($id_empresa);

$total_campos = 0;
foreach ($campos_subida as $campo) {
//echo "<br>".$campo->campo;
if (count($arreglo_post[$campo->campo]) > 0 && $arreglo_post[$campo->campo][0] != '0') {
$total_campos++;
if ($total_campos >= 2) {
$filtros_campos_dinamicos .= " and ";
}
//echo "<br>".$campo->campo;
$total = count($arreglo_post[$campo->campo]);
$filtros_campos_dinamicos .= " ( ";
for ($i = 1; $i <= $total; $i++) {
if ($i >= 2) {
$filtros_campos_dinamicos .= " or ";
}
$filtros_campos_dinamicos .= " baseevaluado." . $campo->campo . "='" . $arreglo_post[$campo->campo][$i - 1] . "'";
}
$filtros_campos_dinamicos .= " ) ";
}
}

if ($filtros_campos_dinamicos) {
$filtros_campos_dinamicos = "and ($filtros_campos_dinamicos)";
}

if ($criterio & $valor) {
} else {
if ($arreglo_post["sucursal"] != '0' or $arreglo_post["sucursal"] != '') {
//$filtro_sucursal=" and baseevaluado.sucursal='".$arreglo_post['sucursal']."'";
}

if ($arreglo_post["local"] != '0' or $arreglo_post["local"] != '') {
//$filtro_local=" and baseevaluado.local='".$arreglo_post['local']."'";
}
}

if ($criterio & $valor) {
$filtro_criterio_valor = " and baseevaluado.$criterio='" . $valor . "'";
}

//if($arreglo_post["tipo_reporte"]=="detalle"){
$campos_respuestas = ",

(select respuesta from tbl_sgd_respuestas where tbl_sgd_respuestas.evaluado=h.evaluado and tbl_sgd_respuestas.evaluador=h.evaluador and tbl_sgd_respuestas.id_proceso=h.id_proceso and tbl_sgd_respuestas.id_pregunta='149') as pregunta1,
(select respuesta from tbl_sgd_respuestas where tbl_sgd_respuestas.evaluado=h.evaluado and tbl_sgd_respuestas.evaluador=h.evaluador and tbl_sgd_respuestas.id_proceso=h.id_proceso and tbl_sgd_respuestas.id_pregunta='150') as pregunta2,
(select respuesta from tbl_sgd_respuestas where tbl_sgd_respuestas.evaluado=h.evaluado and tbl_sgd_respuestas.evaluador=h.evaluador and tbl_sgd_respuestas.id_proceso=h.id_proceso and tbl_sgd_respuestas.id_pregunta='151') as pregunta3,
(select respuesta from tbl_sgd_respuestas where tbl_sgd_respuestas.evaluado=h.evaluado and tbl_sgd_respuestas.evaluador=h.evaluador and tbl_sgd_respuestas.id_proceso=h.id_proceso and tbl_sgd_respuestas.id_pregunta='152') as pregunta4,
(select respuesta from tbl_sgd_respuestas where tbl_sgd_respuestas.evaluado=h.evaluado and tbl_sgd_respuestas.evaluador=h.evaluador and tbl_sgd_respuestas.id_proceso=h.id_proceso and tbl_sgd_respuestas.id_pregunta='231') as pregunta5 ";
//}

if ($arreglo_post["subperfil"] == 1) {
$filtro_subperfil = " and h.evaluado<>h.evaluador ";
} else if ($arreglo_post["subperfil"] == 2) {
$filtro_subperfil = " and h.evaluado=h.evaluador ";
}

$sql = "
SELECT

tbl_sgd_finalizados_evaluado_evaluador.id as id_finalizado,

baseevaluado.local, baseevaluado.sucursal,


h.*,
format((select avg(nota) as nota_final from tbl_sgd_resultados_calculados_competencia where tbl_sgd_resultados_calculados_competencia.evaluado=h.evaluado and tbl_sgd_resultados_calculados_competencia.evaluador=h.evaluador  and tbl_sgd_resultados_calculados_competencia.id_proceso=h.id_proceso ), 2) as nota_final_competencias,
(

select avg(respuesta) as nota_final_objetivos from tbl_sgd_respuestas where tbl_sgd_respuestas.evaluado=h.evaluado and tbl_sgd_respuestas.evaluador=h.evaluador and tbl_sgd_respuestas.id_proceso=h.id_proceso and tbl_sgd_respuestas.id_objetivo is not null and tbl_sgd_respuestas.respuesta>0


) as nota_final_objetivos,
(    SELECT rut_completo FROM tbl_usuario WHERE rut = h.evaluado )AS RutEvaluado,
(SELECT nombre_completo FROM             tbl_usuario         WHERE             rut = h.evaluado    )AS Evaluado,
(SELECT cargo FROM             tbl_usuario         WHERE             rut = h.evaluado    )AS cargoEvaluado,
(SELECT local FROM             tbl_usuario         WHERE             rut = h.evaluado    )AS localEvaluado,
(SELECT perfil_evaluacion FROM             tbl_usuario         WHERE             rut = h.evaluado    )AS tipoEvaluado,
(SELECT sucursal FROM             tbl_usuario         WHERE             rut = h.evaluado    )AS sucursalEvaluado,
(SELECT rut_completo FROM tbl_usuario         WHERE             rut = h.evaluador    )AS RutEvaluador,
(SELECT    nombre_completo FROM             tbl_usuario         WHERE             rut = h.evaluador    )AS Evaluador,
(SELECT    cargo FROM             tbl_usuario         WHERE             rut = h.evaluador    )AS cargoEvaluador,
(SELECT    local FROM             tbl_usuario         WHERE             rut = h.evaluador    )AS localEvaluador,
(SELECT    sucursal FROM             tbl_usuario         WHERE             rut = h.evaluador    )AS sucursalEvaluador,

(SELECT    perfil FROM             tbl_sgd_subperfiles         WHERE             id = h.subperfil    )AS Tipo,
(SELECT    id FROM             tbl_sgd_finalizados_evaluado_evaluador         WHERE             id_proceso = '$id_proceso'         AND evaluado = h.evaluado         AND evaluador = h.evaluador     )AS EstadoCuenta
$campos_respuestas
FROM
tbl_sgd_relaciones h

left join tbl_usuario as baseevaluado
on baseevaluado.rut=h.evaluado

LEFT JOIN tbl_sgd_finalizados_evaluado_evaluador
on tbl_sgd_finalizados_evaluado_evaluador.evaluado=h.evaluado and tbl_sgd_finalizados_evaluado_evaluador.evaluador=h.evaluador and tbl_sgd_finalizados_evaluado_evaluador.id_proceso=h.id_proceso





WHERE
h.id_proceso = '$id_proceso'  $filtro_subperfil $filtro_sucursal $filtro_local $filtro_criterio_valor   $filtros_campos_dinamicos


";

if ($filtro_criterio_valor) {
//echo $sql."<br><br>";
} else {
}

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function sgd_relaciones_procesoConResultadosAEDESC($id_empresa, $id_proceso, $arreglo_post, $criterio, $valor)
{global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$datos_empresa = DatosEmpresa($id_empresa);

$campos_subida = REL_MALLA_CURSO_trarCamposSubidaParaReporte($id_empresa);

$total_campos = 0;
foreach ($campos_subida as $campo) {
//echo "<br>".$campo->campo;
if (count($arreglo_post[$campo->campo]) > 0 && $arreglo_post[$campo->campo][0] != '0') {
$total_campos++;
if ($total_campos >= 2) {
$filtros_campos_dinamicos .= " and ";
}
//echo "<br>".$campo->campo;
$total = count($arreglo_post[$campo->campo]);
$filtros_campos_dinamicos .= " ( ";
for ($i = 1; $i <= $total; $i++) {
if ($i >= 2) {
$filtros_campos_dinamicos .= " or ";
}
$filtros_campos_dinamicos .= " baseevaluado." . $campo->campo . "='" . $arreglo_post[$campo->campo][$i - 1] . "'";
}
$filtros_campos_dinamicos .= " ) ";
}
}

if ($filtros_campos_dinamicos) {
$filtros_campos_dinamicos = "and ($filtros_campos_dinamicos)";
}

if ($criterio & $valor) {
} else {
if ($arreglo_post["sucursal"] != '0' or $arreglo_post["sucursal"] != '') {
//$filtro_sucursal=" and baseevaluado.sucursal='".$arreglo_post['sucursal']."'";
}

if ($arreglo_post["local"] != '0' or $arreglo_post["local"] != '') {
//$filtro_local=" and baseevaluado.local='".$arreglo_post['local']."'";
}
}

if ($criterio & $valor) {
$filtro_criterio_valor = " and baseevaluado.$criterio='" . $valor . "'";
}

//if($arreglo_post["tipo_reporte"]=="detalle"){
$campos_respuestas = ",

(select respuesta from tbl_sgd_respuestas where tbl_sgd_respuestas.evaluado=h.evaluado and tbl_sgd_respuestas.evaluador=h.evaluador and tbl_sgd_respuestas.id_proceso=h.id_proceso and tbl_sgd_respuestas.id_pregunta='149') as pregunta1,
(select respuesta from tbl_sgd_respuestas where tbl_sgd_respuestas.evaluado=h.evaluado and tbl_sgd_respuestas.evaluador=h.evaluador and tbl_sgd_respuestas.id_proceso=h.id_proceso and tbl_sgd_respuestas.id_pregunta='150') as pregunta2,
(select respuesta from tbl_sgd_respuestas where tbl_sgd_respuestas.evaluado=h.evaluado and tbl_sgd_respuestas.evaluador=h.evaluador and tbl_sgd_respuestas.id_proceso=h.id_proceso and tbl_sgd_respuestas.id_pregunta='151') as pregunta3,
(select respuesta from tbl_sgd_respuestas where tbl_sgd_respuestas.evaluado=h.evaluado and tbl_sgd_respuestas.evaluador=h.evaluador and tbl_sgd_respuestas.id_proceso=h.id_proceso and tbl_sgd_respuestas.id_pregunta='152') as pregunta4,
(select respuesta from tbl_sgd_respuestas where tbl_sgd_respuestas.evaluado=h.evaluado and tbl_sgd_respuestas.evaluador=h.evaluador and tbl_sgd_respuestas.id_proceso=h.id_proceso and tbl_sgd_respuestas.id_pregunta='231') as pregunta5 ";
//}

if ($arreglo_post["subperfil"] == 1) {
$filtro_subperfil = " and h.evaluado<>h.evaluador ";
} else if ($arreglo_post["subperfil"] == 2) {
$filtro_subperfil = " and h.evaluado=h.evaluador ";
}

$sql = "

SELECT
h.evaluado,
h.evaluado_nombre,
h.evaluado_cargo,
h.tipo,
h.resultado,

IF (
h.resultado >= 100,
'ALTO',
'BAJO'
) AS CuadranteDS,
(
SELECT
resultado
FROM
tbl_box9_ae_desc
WHERE
evaluado = h.evaluado
AND tipo = 'AUTOEVALUACION'
) AS ResultadoAE,

IF (
(
SELECT
resultado
FROM
tbl_box9_ae_desc
WHERE
evaluado = h.evaluado
AND tipo = 'AUTOEVALUACION'
) >=100,
'ALTO',
'BAJO'
) AS CuadranteAE
FROM
tbl_box9_ae_desc h
where h.tipo='DESCENDENTE'
and
(h.evaluado_cargo like 'GERENTE%' or  h.evaluado_cargo like 'JEFE%' or h.evaluado_cargo like 'SUBGERENTE%')

order by h.evaluado_nombre ASC

";

if ($filtro_criterio_valor) {
//echo $sql."<br><br>";
} else {
}
// echo "<br>sql $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function IMPARTICION_DatosPorRelMallaPersona($id_inscripcion, $id_empresa, $datos_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select rel_lms_malla_persona.rut, nombre_completo, cargo,
tbl_usuario." . $datos_empresa[0]->campo1 . " as campo1,
tbl_usuario." . $datos_empresa[0]->campo2 . " as campo2,
tbl_usuario." . $datos_empresa[0]->campo3 . " as campo3


from rel_lms_malla_persona

inner join tbl_usuario
on tbl_usuario.rut=rel_lms_malla_persona.rut

where rel_lms_malla_persona.id_imparticion='$id_inscripcion' and rel_lms_malla_persona.id_empresa='$id_empresa'



";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function InsertaRelacionMallaPersonaImparticion($rut, $id_empresa, $id_malla, $codigo_imparticion) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "INSERT INTO rel_lms_malla_persona
(id_malla, rut, id_empresa, id_imparticion)
VALUES ('$id_malla', '$rut', '$id_empresa', '$codigo_imparticion');";
if($id_malla<>'presencial'){
$database->setquery($sql);
$database->query();
}

}

function IMPARTICION_DatosPorInscripcion($id_inscripcion, $id_empresa, $datos_empresa, $id_curso) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select tbl_inscripcion_usuarios.rut,   tbl_usuario.nombre_completo, tbl_usuario.cargo, tbl_usuario.email,

tbl_usuario." . $datos_empresa[0]->campo1 . " as campo1,
tbl_usuario." . $datos_empresa[0]->campo2 . " as campo2,
tbl_usuario." . $datos_empresa[0]->campo3 . " as campo3,
tbl_usuario.rut_completo

from tbl_inscripcion_usuarios

inner join tbl_usuario
on  tbl_usuario.rut=tbl_inscripcion_usuarios.rut
where tbl_inscripcion_usuarios.id_inscripcion='$id_inscripcion' and tbl_inscripcion_usuarios.id_empresa='$id_empresa'";

if ($id_curso) {
$sql = "SELECT
tbl_inscripcion_usuarios.rut,
tbl_usuario.nombre_completo,
tbl_usuario.cargo,
tbl_usuario.email,
tbl_usuario." . $datos_empresa[0]->campo1 . " as campo1,
tbl_usuario." . $datos_empresa[0]->campo2 . " as campo2,
tbl_usuario." . $datos_empresa[0]->campo3 . " as campo3,
tbl_usuario.rut_completo,
tbl_inscripcion_usuarios.id_inscripcion,
tbl_inscripcion_usuarios.id_curso,
tbl_lms_curso.nombre AS nombre_curso, tbl_inscripcion_curso.fecha_inicio,
tbl_inscripcion_curso.fecha_termino    ,
tbl_inscripcion_curso.cupos,
tbl_inscripcion_curso.direccion,
tbl_inscripcion_curso.ciudad as lugar,
(select count(id) from rel_lms_inscripcion_sesion where codigo_inscripcion=tbl_inscripcion_usuarios.id_inscripcion) as cuentasesiones,
(select count(id) from rel_lms_inscripcion_usuario_checkin where codigo_imparticion=tbl_inscripcion_usuarios.id_inscripcion and rut=tbl_inscripcion_usuarios.rut) as cuentaasistencia

FROM
tbl_inscripcion_usuarios
INNER JOIN tbl_usuario ON tbl_usuario.rut = tbl_inscripcion_usuarios.rut
INNER JOIN tbl_lms_curso ON tbl_lms_curso.id = tbl_inscripcion_usuarios.id_curso
INNER JOIN tbl_inscripcion_curso ON tbl_inscripcion_usuarios.id_inscripcion = tbl_inscripcion_curso.codigo_inscripcion
WHERE
tbl_inscripcion_usuarios.id_curso = '$id_curso'
AND tbl_inscripcion_usuarios.id_empresa = '$id_empresa'";
} else {
$sql = "SELECT
tbl_inscripcion_usuarios.rut,
tbl_usuario.nombre_completo,
tbl_usuario.cargo,
tbl_usuario.email,
tbl_usuario." . $datos_empresa[0]->campo1 . " as campo1,
tbl_usuario." . $datos_empresa[0]->campo2 . " as campo2,
tbl_usuario." . $datos_empresa[0]->campo3 . " as campo3,
tbl_usuario.rut_completo,
tbl_inscripcion_usuarios.id_inscripcion,
tbl_inscripcion_usuarios.id_curso,
tbl_lms_curso.nombre AS nombre_curso, tbl_inscripcion_curso.fecha_inicio,
tbl_inscripcion_curso.fecha_termino    ,
tbl_inscripcion_curso.cupos,
tbl_inscripcion_curso.direccion,
tbl_inscripcion_curso.ciudad as lugar,
tbl_inscripcion_cierre.avance AS porcentaje_asistencia,

(select count(id) from rel_lms_inscripcion_sesion where codigo_inscripcion=tbl_inscripcion_usuarios.id_inscripcion) as cuentasesiones,
(select count(id) from rel_lms_inscripcion_usuario_checkin where codigo_imparticion=tbl_inscripcion_usuarios.id_inscripcion and rut=tbl_inscripcion_usuarios.rut) as cuentaasistencia


FROM
tbl_inscripcion_usuarios
INNER JOIN tbl_usuario ON tbl_usuario.rut = tbl_inscripcion_usuarios.rut
INNER JOIN tbl_lms_curso ON tbl_lms_curso.id = tbl_inscripcion_usuarios.id_curso
INNER JOIN tbl_inscripcion_curso ON tbl_inscripcion_usuarios.id_inscripcion = tbl_inscripcion_curso.codigo_inscripcion
left JOIN tbl_inscripcion_cierre ON tbl_inscripcion_cierre.id_inscripcion = tbl_inscripcion_curso.codigo_inscripcion
and tbl_inscripcion_cierre.id_curso=tbl_inscripcion_usuarios.id_curso and tbl_inscripcion_cierre.rut=tbl_inscripcion_usuarios.rut


WHERE
tbl_inscripcion_usuarios.id_inscripcion = '$id_inscripcion'
AND tbl_inscripcion_usuarios.id_empresa = '$id_empresa'";
}



$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}


function IMPARTICION_DatosPorInscripcionEstado($id_inscripcion, $id_empresa, $datos_empresa, $id_curso, $asistente) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
// echo "<br>($id_inscripcion, $id_empresa, $datos_empresa, $id_curso,asistente $asistente)<b



if($asistente==1){$queryasistente=" and tbl_inscripcion_cierre.porcentaje_asistencia>'0'    ";} else {$queryasistente="";}
$sql = "select tbl_inscripcion_usuarios.rut,   tbl_usuario.nombre_completo, tbl_usuario.cargo, tbl_usuario.email,

tbl_usuario." . $datos_empresa[0]->campo1 . " as campo1,
tbl_usuario." . $datos_empresa[0]->campo2 . " as campo2,
tbl_usuario." . $datos_empresa[0]->campo3 . " as campo3,
tbl_usuario.rut_completo

from tbl_inscripcion_usuarios

inner join tbl_usuario
on  tbl_usuario.rut=tbl_inscripcion_usuarios.rut
where tbl_inscripcion_usuarios.id_inscripcion='$id_inscripcion' and tbl_inscripcion_usuarios.id_empresa='$id_empresa'";

if ($id_curso) {
$sql = "SELECT
tbl_inscripcion_usuarios.rut,
tbl_usuario.nombre_completo,
tbl_usuario.cargo,
tbl_usuario.email,
tbl_usuario." . $datos_empresa[0]->campo1 . " as campo1,
tbl_usuario." . $datos_empresa[0]->campo2 . " as campo2,
tbl_usuario." . $datos_empresa[0]->campo3 . " as campo3,
tbl_usuario.rut_completo,
tbl_inscripcion_usuarios.id_inscripcion,
tbl_inscripcion_usuarios.id_curso,
tbl_lms_curso.nombre AS nombre_curso, tbl_inscripcion_curso.fecha_inicio,
tbl_inscripcion_curso.fecha_termino    ,
tbl_inscripcion_curso.cupos,
tbl_inscripcion_curso.direccion,
tbl_inscripcion_curso.ciudad as lugar

FROM
tbl_inscripcion_usuarios
INNER JOIN tbl_usuario ON tbl_usuario.rut = tbl_inscripcion_usuarios.rut
INNER JOIN tbl_lms_curso ON tbl_lms_curso.id = tbl_inscripcion_usuarios.id_curso
INNER JOIN tbl_inscripcion_curso ON tbl_inscripcion_usuarios.id_inscripcion = tbl_inscripcion_curso.codigo_inscripcion
WHERE
tbl_inscripcion_usuarios.id_curso = '$id_curso'
AND tbl_inscripcion_usuarios.id_empresa = '$id_empresa'";
} else {
$sql = "SELECT
tbl_inscripcion_usuarios.rut,
tbl_usuario.nombre_completo,
tbl_usuario.cargo,
tbl_usuario.email,
tbl_usuario." . $datos_empresa[0]->campo1 . " as campo1,
tbl_usuario." . $datos_empresa[0]->campo2 . " as campo2,
tbl_usuario." . $datos_empresa[0]->campo3 . " as campo3,
tbl_usuario.rut_completo,
tbl_inscripcion_usuarios.id_inscripcion,
tbl_inscripcion_usuarios.id_curso,
tbl_lms_curso.nombre AS nombre_curso, tbl_inscripcion_curso.fecha_inicio,
tbl_inscripcion_curso.fecha_termino    ,
tbl_inscripcion_curso.cupos,
tbl_inscripcion_curso.direccion,
tbl_inscripcion_curso.ciudad as lugar,
tbl_inscripcion_cierre.porcentaje_asistencia AS porcentaje_asistencia

FROM
tbl_inscripcion_usuarios

INNER JOIN tbl_usuario ON tbl_usuario.rut = tbl_inscripcion_usuarios.rut
INNER JOIN tbl_lms_curso ON tbl_lms_curso.id = tbl_inscripcion_usuarios.id_curso
INNER JOIN tbl_inscripcion_curso ON tbl_inscripcion_usuarios.id_inscripcion = tbl_inscripcion_curso.codigo_inscripcion
left JOIN tbl_inscripcion_cierre ON tbl_inscripcion_cierre.id_inscripcion = tbl_inscripcion_curso.codigo_inscripcion
and tbl_inscripcion_cierre.id_curso=tbl_inscripcion_usuarios.id_curso and tbl_inscripcion_cierre.rut=tbl_inscripcion_usuarios.rut

WHERE
tbl_inscripcion_usuarios.id_inscripcion = '$id_inscripcion'
AND tbl_inscripcion_usuarios.id_empresa = '$id_empresa'

$queryasistente
";
}

//echo $sql; exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function clima_distint_campos($campo, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select distinct($campo) as dato from tbl_usuario where id_empresa='$id_empresa' and $campo<>''
order by $campo";
// echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function clima_total_usuarios_completos($id_empresa, $arreglo_post, $campo, $dato, $campo2, $dato2, $campo3, $dato3, $campo4, $dato4, $campo5, $dato5, $campo6, $dato6, $campo7, $dato7) {
//echo "<br>$id_empresa, $arreglo_post, $campo, $dato, $campo2, $dato2, $campo3, $dato3, $campo4, $dato4, $campo5, $dato5, $campo6, $dato6, $campo7, $dato7";
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$query = "";
$query1 = "";
$query2 = "";
$query3 = "";
$query4 = "";
$query5 = "";
$query6 = "";
$query7 = "";
$query8 = "";
$query9 = "";

if ($campo != '' and $dato != '') {$query1 = " h.$campo='$dato'";}
if ($campo2 != '' or $dato2 != '') {$query2 = "  and h.$dato2='$campo2'";}
if ($campo3 != '' or $dato3 != '') {$query5 = "  and h.$dato3='$campo3'";}
if ($campo4 != '' or $dato4 != '') {$query6 = "  and h.$dato4='$campo4'";}
if ($campo5 != '' or $dato5 != '') {$query7 = "  and h.$dato5='$campo5'";}
if ($campo6 != '' or $dato6 != '') {$query8 = "  and h.$dato6='$campo6'";}
if ($campo7 != '' or $dato7 != '') {$query9 = "  and h.$dato7='$campo7'";}

if ($campo2 != '' or $dato2 != '' or $campo3 != '' or $dato3 != '' or $campo4 != '' or $dato4 != '' or $campo != '' or $dato != '') {$query3 = "  WHERE ";}
if ($campo2 != '' or $dato2 != '' or $campo3 != '' or $dato3 != '' or $campo4 != '' or $dato4 != '' or $campo != '' or $dato != '') {$query4 = " and h.id_empresa='$id_empresa' ";}

$query = $query3 . " " . $query1 . " " . $query2 . " " . $query4 . " " . $query5 . " " . $query6 . " " . $query7 . " " . $query8 . " " . $query9;

$sql = "
select h.*,
(select count(id) as cuenta from tbl_turbus_respuestas_clima16 where rut=h.rut) as cuenta
from tbl_usuario h
$query
";
//echo "<br> clima_total_usuarios_completos$sql";
//echo "hola campo $campo dato $dato, campo2 $campo2, dato2 $dato2, campo3 $campo3, dato3 $dato3, campo4 $campo4, dato4 $dato4";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function clima_calculadatosfinales_data($id_empresa, $arreglo_post, $campo, $dato, $campo2, $dato2, $campo3, $dato3, $campo4, $dato4, $campo5, $dato5, $campo6, $dato6, $campo7, $dato7) {
//echo "<br><strong>$id_empresa, $arreglo_post, $campo, $dato, $campo2, $dato2, $campo3, $dato3, $campo4, $dato4, $campo5, $dato5, $campo6, $dato6, $campo7, $dato7</strong></br>";
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$query = "";
$query1 = "";
$query2 = "";
$query3 = "";
$query4 = "";
$query5 = "";
$query6 = "";
$query7 = "";
$query8 = "";
$query9 = "";
if ($campo != '' and $dato != '') {$query1 = " h.$campo='$dato'";}
if ($campo2 != '' or $dato2 != '') {$query2 = "  and h.$dato2='$campo2'";}
if ($campo3 != '' or $dato3 != '') {$query5 = "  and h.$dato3='$campo3'";}
if ($campo4 != '' or $dato4 != '') {$query6 = "  and h.$dato4='$campo4'";}
if ($campo5 != '' or $dato5 != '') {$query7 = "  and h.$dato5='$campo5'";}
if ($campo6 != '' or $dato6 != '') {$query8 = "  and h.$dato6='$campo6'";}
if ($campo7 != '' or $dato7 != '') {$query9 = "  and h.$dato7='$campo7'";}

if ($campo2 != '' or $dato2 != '' or $campo3 != '' or $dato3 != '' or $campo4 != '' or $dato4 != '' or $campo != '' or $dato != '') {$query3 = "  WHERE ";}
if ($campo2 != '' or $dato2 != '' or $campo3 != '' or $dato3 != '' or $campo4 != '' or $dato4 != '' or $campo != '' or $dato != '') {$query4 = " and h.id_empresa='$id_empresa' and (select count(id) from tbl_turbus_respuestas_clima16 where rut=h.rut)>0";}

$query = $query3 . " " . $query1 . " " . $query2 . " " . $query4 . " " . $query5 . " " . $query6 . " " . $query7 . " " . $query8 . " " . $query9;

$sql = "
select h.*,

(select count(id) from tbl_turbus_respuestas_clima16 where puntaje>=4 and rut=h.rut) as positivo,
(select count(id) from tbl_turbus_respuestas_clima16 where puntaje<=2 and rut=h.rut) as negativo,
(select count(id) from tbl_turbus_respuestas_clima16 where puntaje=3  and rut=h.rut) as neutro,
(select count(id) from tbl_turbus_respuestas_clima16 where rut=h.rut) as total

from tbl_usuario h

$query


group by h.rut
";

//echo "<br>clima_calculadatosfinales_data<br><br> $sql";

//exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function clima_filtrorut_data_dim($id_empresa, $campo, $dato) {
//echo "<br><strong>$id_empresa, $campo, $dato</strong></br>";

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$query = "";
$query1 = "";

if ($campo != '' and $dato != '') {$query1 = " and  h.$campo='$dato'";}

$query = $query3 . " " . $query1 . " " . $query2 . " " . $query4 . " " . $query5 . " " . $query6 . " " . $query7 . " " . $query8 . " " . $query9;

//echo $query;
//exit();

$sql = "
select h.*,  (select count(id) from tbl_turbus_respuestas_clima16 where rut=h.rut) as cuenta
from tbl_usuario h

where (select count(id) from tbl_turbus_respuestas_clima16 where rut=h.rut)>=60

$query

group by h.rut
";

//echo $sql;
//exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function clima_calculadatosfinales_data_dim($id_empresa, $campo, $dato, $rut, $filtrodim, $datodim) {
//echo "<br>clima_calculadatosfinales_data_dim($id_empresa, $campo, $dato, $rut, $filtrodim, $datodim)<strong>$id_empresa, $campo, $dato, $rut, $filtrodim, $datodim</strong></br>";
//

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$query = "";
$query1 = "";

if ($campo != '' and $dato != '') {$query1 = " Where  h.$campo='$dato'";}

$query = $query3 . " " . $query1 . " " . $query2 . " " . $query4 . " " . $query5 . " " . $query6 . " " . $query7 . " " . $query8 . " " . $query9;

$sql = "
SELECT
h.*,

(select count(id) from tbl_turbus_respuestas_clima16 where puntaje>=4 and rut=h.rut and $filtrodim='$datodim') as positivo,
(select count(id) from tbl_turbus_respuestas_clima16 where puntaje<=2 and rut=h.rut and $filtrodim='$datodim') as negativo,
(select count(id) from tbl_turbus_respuestas_clima16 where puntaje=3  and rut=h.rut and $filtrodim='$datodim') as neutro,
(select count(id) from tbl_turbus_respuestas_clima16 where rut=h.rut) as total

FROM

tbl_turbus_respuestas_clima16 h

where h.$filtrodim='$datodim'

and h.rut='$rut'

group by h.$filtrodim
";

//echo "<br>$sql";
//exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function clima_driverdimensiones($campo, $empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select $campo as dato from tbl_turbus_respuestas_clima16 group by $campo order by $campo";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function IMPARTICION_InsertaInscripcionUsuarios($id_inscripcion, $rut, $id_curso, $id_empresa, $estado_inscripcion, $inscrito) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO tbl_inscripcion_usuarios(id_inscripcion, rut, id_curso, id_empresa, estadoinscripcion, inscrito, fecha, hora, relator


) " .
"VALUES ('$id_inscripcion', '$rut', '$id_curso', '$id_empresa', '$estado_inscripcion', '$inscrito', '" . date("Y-m-d") . "', '" . date("H:i:s") . "', '0');";

$database->setquery($sql);
$database->query();
}



function AUDIENCIA_QueryDinamicaTraeUsuarios($id_empresa, $id_audiencia, $sql) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "    select     * from tbl_usuario as a where a.id_empresa='$id_empresa' and ( $sql ) ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeUsuariosEmpresaFiltrosUltimoRutColaborador($id_empresa, $rut, $Campos1, $Campos2, $Campos3) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
SELECT *,
$Campos1 as campo1,
$Campos2 as campo2,
$Campos3 as campo3
from vista_usuario
WHERE
vigencia='0' AND
id_empresa='$id_empresa' and rut='$rut' order by id DESC limit 1
";

//echo $sql;exit;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function IMPARTICIONES_traeImparticionesCreadas($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select tbl_empresa.prefijo, tbl_inscripcion_curso.* from tbl_inscripcion_curso
inner join tbl_empresa
on tbl_empresa.id=tbl_inscripcion_curso.id_empresa
where tbl_inscripcion_curso.id_empresa='$id_empresa'
";
//    echo $sql;
//    echo "<br>";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function Audiencias_totalcursosPorEmpresa($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "SELECT
tbl_empresa.prefijo, tbl_lms_curso.*
FROM
tbl_lms_curso

inner join tbl_empresa
on tbl_empresa.id=tbl_lms_curso.id_empresa
WHERE
tbl_lms_curso.id_empresa = '$id_empresa'
";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Audiencias_PorEmpresaUltima($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "SELECT
tbl_empresa.prefijo, tbl_lms_curso.*
FROM
tbl_lms_curso

inner join tbl_empresa
on tbl_empresa.id=tbl_lms_curso.id_empresa
WHERE
tbl_lms_curso.id_empresa = '$id_empresa'
ORDER BY
tbl_lms_curso.id_correlativo DESC
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Audiencias_RutPorAudienciaEmpresa($id_audiencia, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "
select tbl_usuario.*
from tbl_audiencia_rut
inner join tbl_usuario
on tbl_usuario.rut=tbl_audiencia_rut.rut
where tbl_audiencia_rut.id_empresa='$id_empresa' and tbl_audiencia_rut.id_audiencia='$id_audiencia'        ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function verficiaidnuevocursonoestas($id_nuevo_curso, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "    select count(h.id) as cuenta from tbl_lms_curso h where id_empresa='$id_empresa' and id='$id_nuevo_curso'        ";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Audiencias_DatosValores_tbl_audiencia_valores_audiencia($id_audiencia, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_audiencia_valores_audiencia where id_empresa='$id_empresa' and id_audiencia='$id_audiencia'        ";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function AUDIENCIA_InsertaRelacionRutAudiencia($rut, $id_audiencia, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO tbl_audiencia_rut(id_audiencia, rut, id_empresa) " .
"VALUES ('$id_audiencia', '$rut', '$id_empresa' );";

$database->setquery($sql);
$database->query();
}

function IMPARTICION_CreaImparticion($id_empresa, $codigo_imparticion, $id_curso, $fecha_inicio, $fecha_termino, $direccion, $ciudad, $cupos, $id_audiencia, $tipo_audiencia, $arreglo_post, $sesiones, $ejecutivo, $comentarios) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "INSERT INTO tbl_inscripcion_curso(codigo_inscripcion, fecha_inicio, fecha_termino, direccion, comuna, ciudad, id_curso, id_empresa, cupos, id_audiencia, tipo_audiencia,
lunes_d_am,lunes_h_am,lunes_d_pm,lunes_h_pm,
martes_d_am,martes_h_am,martes_d_pm,martes_h_pm,
miercoles_d_am,miercoles_h_am,miercoles_d_pm,miercoles_h_pm,
jueves_d_am,jueves_h_am,jueves_d_pm,jueves_h_pm,
viernes_d_am,viernes_h_am,viernes_d_pm,viernes_h_pm, sesiones, ejecutivo, comentarios) " .
"VALUES ('$codigo_imparticion', '$fecha_inicio', '$fecha_termino', '$direccion', '$ciudadu', '$ciudad', '$id_curso', '$id_empresa', '$cupos', '$id_audiencia', '$tipo_audiencia',

'" . $arreglo_post["lunes_d_am"] . "',
'" . $arreglo_post["lunes_h_am"] . "',
'" . $arreglo_post["lunes_d_pm"] . "',
'" . $arreglo_post["lunes_h_pm"] . "',

'" . $arreglo_post["martes_d_am"] . "',
'" . $arreglo_post["martes_h_am"] . "',
'" . $arreglo_post["martes_d_pm"] . "',
'" . $arreglo_post["martes_h_pm"] . "',

'" . $arreglo_post["miercoles_d_am"] . "',
'" . $arreglo_post["miercoles_h_am"] . "',
'" . $arreglo_post["miercoles_d_pm"] . "',
'" . $arreglo_post["miercoles_h_pm"] . "',

'" . $arreglo_post["jueves_d_am"] . "',
'" . $arreglo_post["jueves_h_am"] . "',
'" . $arreglo_post["jueves_d_pm"] . "',
'" . $arreglo_post["jueves_h_pm"] . "',

'" . $arreglo_post["viernes_d_am"] . "',
'" . $arreglo_post["viernes_h_am"] . "',
'" . $arreglo_post["viernes_d_pm"] . "',
'" . $arreglo_post["viernes_h_pm"] . "',
'$sesiones',
'$ejecutivo',
'$comentarios' );";

echo $sql;
exit();

$database->setquery($sql);
$database->query();
}

function IMPARTICION_CreaImparticionT($id_empresa, $codigo_imparticion, $id_curso, $fecha_inicio, $fecha_termino, $cupos, $ejecutivo, $comentarios, $hora_inicio, $hora_termino) {
//echo "id empresa $id_empresa, codigo impa $codigo_imparticion, id curso $id_curso, fecha inicio $fecha_inicio, fecha termino $fecha_termino, cupos $cupos, array post $arreglo_post, ejecutivo $ejecutivo, comentarios $comentarios, $hora_inicio, $hora_termino";

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "INSERT INTO tbl_inscripcion_curso
(codigo_inscripcion, fecha_inicio, fecha_termino, id_curso, id_empresa, cupos, ejecutivo, comentarios) " .
"VALUES ('$codigo_imparticion', '$fecha_inicio', '$fecha_termino', '$id_curso',
'$id_empresa', '$cupos', '$ejecutivo', '$comentarios' );";

$database->setquery($sql);
$database->query();
//echo "<br>";echo $sql;

$sql = "INSERT INTO rel_objeto_imparticiones
(id_inscripcion,id_curso,id_objeto,fecha_inicio,fecha_termino,hora_inicio,hora_termino) " .
"VALUES ('$codigo_imparticion', '$id_curso', '', '$fecha_inicio', '$fecha_termino',
'$hora_inicio', '$hora_termino');";

$database->setquery($sql);
$database->query();
//echo "<br>";echo $sql;exit();
}

function DatosInscripcionImparticiones($id_inscripcion, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select
tbl_inscripcion_curso.*,

tbl_lms_curso.nombre as nombre_curso,

tbl_lms_curso.cantidad_maxima_participantes,

tbl_lms_clasificacion.clasificacion as nombre_clasificacion


from tbl_inscripcion_curso

inner join tbl_lms_curso
on tbl_lms_curso.id=tbl_inscripcion_curso.id_curso


where tbl_inscripcion_curso.id='$id_inscripcion' and id_empresa='$id_empresa'

order by tbl_inscripcion_curso.id DESC

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}





function ListaUsuariosEncuestaEmailInscripcion($inscripcion, $id_empresa, $rut, $rut_individual) {

global $c_host, $c_user, $c_pass, $c_db;

if ($rut_individual == "") {
$query_rut = "    and (select count(id) from rel_lms_inscripcion_usuario_checkin WHERE   codigo_imparticion = h.id_inscripcion and rut=h.rut) >0
and (select count(id) from tbl_enc_satis_respuestas where rut=h.rut and id_inscripcion= h.id_inscripcion)='0' ";
}

if ($rut_individual != "") {
$query_rut = " and h.rut='$rut_individual' ";
}
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT h.rut,
(select nombre_completo from tbl_usuario where rut=h.rut) as nombre_completo,
(select email from tbl_usuario where rut=h.rut) as email,
(select id_curso from tbl_inscripcion_curso where codigo_inscripcion=h.id_inscripcion) as id_curso,
(select fecha_inicio from tbl_inscripcion_curso where codigo_inscripcion=h.id_inscripcion) as fecha_inicio,
(select fecha_termino from tbl_inscripcion_curso where codigo_inscripcion=h.id_inscripcion) as fecha_termino,
(select nombre from tbl_lms_curso where id=(select id_curso from tbl_inscripcion_curso where codigo_inscripcion=h.id_inscripcion) ) as nombre_curso,

(select count(id) from rel_lms_inscripcion_usuario_checkin WHERE   codigo_imparticion = h.id_inscripcion and rut=h.rut) as Asistentes,
(select count(id) from tbl_enc_satis_respuestas where rut=h.rut and id_inscripcion= h.id_inscripcion) as EncuestaRespondida
FROM tbl_inscripcion_usuarios h WHERE h.id_inscripcion = '$inscripcion'
and h.id_empresa='$id_empresa'
$query_rut


";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TraeImparticionEmpresaEncSat($id_curso, $id_inscripcion, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($id_curso != '') {
$sql_curso = " and tbl_inscripcion_curso.id_curso='$id_curso' ";
}

if ($id_inscripcion != '') {
$sql_inscripcion = " and tbl_inscripcion_curso.codigo_inscripcion='$id_inscripcion' ";
}

$sql = "SELECT
tbl_inscripcion_curso.id_curso,
tbl_inscripcion_curso.codigo_inscripcion,
tbl_lms_curso.nombre,
tbl_lms_curso.modalidad,
tbl_lms_curso.numero_horas,
tbl_inscripcion_curso.fecha_inicio,
tbl_inscripcion_curso.fecha_termino,
tbl_inscripcion_curso.direccion,
tbl_inscripcion_curso.ciudad,
tbl_inscripcion_curso.comuna,
tbl_inscripcion_curso.cupos,
tbl_inscripcion_curso.sesiones,
tbl_inscripcion_curso.ejecutivo as ejecutivo,
(select id_programa from rel_lms_malla_curso where id_curso=tbl_inscripcion_curso.id_curso limit 1) as id_programa,
(select nombre_programa from tbl_lms_programas_bbdd where id_programa=(select id_programa from rel_lms_malla_curso where id_curso=tbl_inscripcion_curso.id_curso limit 1)  limit 1) as programa,
(select nombre_completo from tbl_usuario WHERE rut=(tbl_inscripcion_curso.ejecutivo)) as ejecutivo,
(select count(DISTINCT(rut)) from tbl_enc_satis_respuestas where id_inscripcion=tbl_inscripcion_curso.codigo_inscripcion) as numrespuestas,

(select count(DISTINCT(rut)) from tbl_inscripcion_usuarios where id_curso=tbl_lms_curso.id and id_inscripcion=tbl_inscripcion_curso.codigo_inscripcion)  as inscritos,
(SELECT count(DISTINCT(rut))    FROM    rel_lms_inscripcion_usuario_checkin WHERE   codigo_imparticion = tbl_inscripcion_curso.codigo_inscripcion   ) AS chequeados,
(SELECT count(tbl_inscripcion_usuarios.id)  FROM    tbl_inscripcion_usuarios INNER JOIN tbl_usuario on tbl_usuario.rut=tbl_inscripcion_usuarios.rut
WHERE       id_inscripcion = tbl_inscripcion_curso.codigo_inscripcion) as num_participantes,

(select count(*) as total from rel_lms_inscripcion_sesion where rel_lms_inscripcion_sesion.codigo_inscripcion=tbl_inscripcion_curso.codigo_inscripcion) as total_sesiones
FROM tbl_inscripcion_curso

LEFT JOIN tbl_lms_curso on tbl_lms_curso.id=tbl_inscripcion_curso.id_curso

WHERE tbl_inscripcion_curso.id_empresa='$id_empresa'
$sql_curso
$sql_inscripcion

and tbl_lms_curso.modalidad='2'
ORDER BY tbl_inscripcion_curso.id DESC ";

// and tbl_inscripcion_curso.codigo_inscripcion='15320'

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TraExpertosPorEmpresa($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select h.*,
(select categoria from tbl_mp_categorias where id_categoria=h.contenido) as categoria,
(select rut_completo from tbl_usuario where rut=h.codigo) as rut_completo,
(select nombre_completo from tbl_usuario where rut=h.codigo) as nombre_completo,
(select cargo from tbl_usuario where rut=h.codigo) as cargo,
(select gerencia from tbl_usuario where rut=h.codigo) as gerencia

from tbl_mp_vista h

where h.id_empresa='$id_empresa' and h.tipo='vistaexperto'
order by (select categoria from tbl_mp_categorias where id_categoria=h.contenido) ASC

";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function InsObjetosImparticion($id_empresa, $codigo_inscripcion) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "

select * from tbl_objeto where id_curso='$codigo_inscripcion'
and id_empresa='$id_empresa'
";

//echo "<br>$sql";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function InsSesionesImparticion($id_empresa, $codigo_inscripcion) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "

select h.*,
(select nombre from tbl_relatores where rut=h.relator) as Nombre_Relator,
(select count(DISTINCT(rut)) from rel_lms_inscripcion_usuario_checkin where codigo_imparticion='$codigo_inscripcion' and sesion=h.id) as chequeados

from rel_lms_inscripcion_sesion h

where id_empresa='$id_empresa' and codigo_inscripcion='$codigo_inscripcion'

";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function InsSesionesRelatoresImparticion($id_empresa, $codigo_inscripcion) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "

select h.*,
(select rut_completo from tbl_relatores where rut=h.relator) as rut_relator,
(select nombre from tbl_relatores where rut=h.relator) as nombre_relator

from rel_lms_inscripcion_sesion h

where id_empresa='$id_empresa' and codigo_inscripcion='$codigo_inscripcion'

group by h.relator

";
//echo "relatores ".$sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function AUDIENCIA_ValoresDatoAudienciaEmpresaSoloCampoSoloValor($id_empresa, $id_audiencia, $campo) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "
select distinct(valor) as valor, campo from tbl_audiencia_valores_audiencia where id_empresa='$id_empresa' and id_audiencia='$id_audiencia' and campo='$campo'


";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function AUDIENCIA_ValoresDatoAudienciaEmpresaSoloCampo($id_empresa, $id_audiencia) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "
select distinct(campo) as campo from tbl_audiencia_valores_audiencia where id_empresa='$id_empresa' and id_audiencia='$id_audiencia' order by campo


";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function AUDIENCIA_TotalAudienciasPorempresaParaListado($id_empresa, $id_audiencia) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
if ($id_audiencia) {
$filtro_id_audiencia = " and tbl_audiencia.id='$id_audiencia'";
}
$sql = "SELECT * FROM tbl_audiencia where id_empresa='$id_empresa' and nombre is not null $filtro_id_audiencia";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function AUDIENCIA_QueryDinamicaListadoUsuarios($id_empresa, $id_audiencia, $sql) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "
SELECT
*
FROM
tbl_usuario
WHERE
tbl_usuario.id_empresa = '$id_empresa' and ( $sql )

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function AUDIENCIA_TotalAudienciasPorempresa($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT * FROM tbl_audiencia where id_empresa='$id_empresa'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function AUDIENCIA_TotalAudienciasPorempresaOrderDesc($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT * FROM tbl_audiencia where id_empresa='$id_empresa' order by nombre ASC";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}


function AUDIENCIA_ActualizaDatos($id_audiencia, $nombre, $descripcion) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE tbl_audiencia  SET nombre= '$nombre', descripcion='$descripcion'

WHERE id='$id_audiencia'";

$database->setquery($sql);
$database->query();
}

function AUDIENCIA_TraeDatosPorId($id_empresa, $id) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT *  FROM tbl_audiencia where id='$id'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function AUDIENCIA_TraeUltimo($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT MAX(id) as ultimo_id FROM tbl_audiencia where id_empresa='$id_empresa'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function AUDIENCIA_CreaAudienciaDuplicada($id_empresa, $nombre, $descripcion) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO tbl_audiencia(id_empresa, nombre, descripcion) " .
"VALUES ('$id_empresa', '$nombre', '$descripcion' );";

$database->setquery($sql);
$database->query();
}

function AUDIENCIA_CreaAudiencia($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO tbl_audiencia(id_empresa) " .
"VALUES ('$id_empresa' );";

$database->setquery($sql);
$database->query();
}

function AUDIENCIA_SelectDistinc_Lectura($id_empresa, $campo, $id_audiencia) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
SELECT valor


FROM
tbl_audiencia_valores_audiencia
WHERE
tbl_audiencia_valores_audiencia.id_empresa = '$id_empresa' and campo='$campo'
ORDER BY
valor ASC


";

$sql = "SELECT valor,
(select count(*) as total from tbl_usuario as a where a.id_empresa='$id_empresa' and a.$campo=valor) as total_por_valor

FROM tbl_audiencia_valores_audiencia
WHERE tbl_audiencia_valores_audiencia.id_empresa = '$id_empresa' and campo='$campo' and tbl_audiencia_valores_audiencia.id_audiencia='$id_audiencia' ORDER BY valor ASC

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function AUDIENCIA_QueryDinamica($id_empresa, $id_audiencia, $sql) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "
SELECT
count(*)AS total_usuario,
(select count(*) as total from tbl_usuario as a where a.id_empresa='$id_empresa' and ( $sql ) ) as total_audiencia
FROM
tbl_usuario
WHERE
tbl_usuario.id_empresa = '$id_empresa'

";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function AUDIENCIA_ValoresDatoAudienciaEmpresa($id_empresa, $id_audiencia) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "
select * from tbl_audiencia_valores_audiencia where id_empresa='$id_empresa' and id_audiencia='$id_audiencia' order by campo


";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function AUDIENCIA_InsertaCamposValores($id_audiencia, $id_empresa, $campo, $valor) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO tbl_audiencia_valores_audiencia(id_audiencia, id_empresa, campo, valor) " .
"VALUES ('$id_audiencia', '$id_empresa', '$campo', '$valor' );";
$database->setquery($sql);
$database->query();
}

function AUDIENCIA_SelectDistincSinTotalPorValor($id_empresa, $campo) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "
SELECT DISTINCT
(tbl_usuario.$campo)AS valor


FROM
tbl_usuario
WHERE
tbl_usuario.id_empresa = '$id_empresa'
ORDER BY
valor ASC
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function AUDIENCIA_SelectDistinc($id_empresa, $campo) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "
SELECT DISTINCT
(tbl_usuario.$campo)AS valor,
(select count(*) as total from tbl_usuario as a where a.id_empresa='70' and a.$campo=valor) as total_por_valor

FROM
tbl_usuario
WHERE
tbl_usuario.id_empresa = '$id_empresa'
ORDER BY
valor ASC
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function AUDIENCIA_CamposPorAudiencia($id_empresa, $id_audiencia) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "
select tbl_empresa_subida_usuarios.*, nombrecampoamostrar, rel_audiencia_campo.campo
from rel_audiencia_campo
inner join tbl_empresa_subida_usuarios
on tbl_empresa_subida_usuarios.id_empresa='$id_empresa'
and tbl_empresa_subida_usuarios.campo=rel_audiencia_campo.campo

where rel_audiencia_campo.id_empresa='$id_empresa' and rel_audiencia_campo.id_audiencia    ='$id_audiencia'
";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function AUDIENCIA_InsertaCamposinAudiencia($id_empresa, $campo, $id_audiencia) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO rel_audiencia_campo(id_empresa, campo, id_audiencia) " .
"VALUES ('$id_empresa', '$campo', '$id_audiencia');";

$database->setquery($sql);
$database->query();
}

function AUDIENCIAS_TraeCampos($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "
select * from tbl_empresa_subida_usuarios where id_empresa='$id_empresa' and para_audiencia='0'
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function EliminarelacionMalaCursoclasificacionEmpresa($id_malla, $id_clasificacion, $id_curso, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "delete from rel_lms_malla_curso where id_malla='$id_malla' and id_clasificacion='$id_clasificacion' and id_curso='$id_curso' and id_empresa='$id_empresa'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
}

function MANTENEDOR_TraeCamporPorTipoEmpresaParaListado($id_empresa, $tipo) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "
select tbl_lms_mantenedor_campos.*, tbl_lms_mantenedor_tipo_input.template
from tbl_lms_mantenedor_campos
inner join tbl_lms_mantenedor_tipo_input
on tbl_lms_mantenedor_tipo_input.tipo_input=tbl_lms_mantenedor_campos.tipo_input

where id_empresa='$id_empresa' and tipo='$tipo' and tbl_lms_mantenedor_campos.muestra_listado='0'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function InsertaRelacionMallaClasificacionCursoAdmin($id_malla, $id_curso, $id_clasificacion, $id_empresa, $id_foco, $id_programa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO rel_lms_malla_curso(id_malla, id_curso,id_clasificacion,id_empresa, id_foco, id_programa) " .
"VALUES ('$id_malla', '$id_curso','$id_clasificacion', '$id_empresa', '$id_foco', '$id_programa');";
//echo $sql;exit();
$database->setquery($sql);
$database->query();
}

function ValorSelectDinaico2Admin($tabla, $campo_mostrar, $campo_valor, $order) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);

$database->setDb($c_db);

$sql = "select $campo_valor as id, $campo_mostrar as nombre from $tabla $order";

$database->setquery($sql);

$database->query();

$cod = $database->listObjects();

return $cod;
}

function ValorSelectDinaicoAdmin($tabla, $campo_mostrar, $campo_valor, $order, $id_empresa, $where) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);

$database->setDb($c_db);

$sql = "select $campo_valor as id, $campo_mostrar as nombre from $tabla

where id_empresa='$id_empresa' $where $order";

$database->setquery($sql);

$database->query();

$cod = $database->listObjects();

return $cod;
}

function ListadoRespuestasTriviaVersion1($id_evaluacion) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT
tbl_evaluaciones_respuestas.rut,
tbl_usuario.nombre_completo,
tbl_evaluaciones.nombre_evaluacion,
tbl_evaluaciones_preguntas.id,
tbl_evaluaciones_preguntas.pregunta,
tbl_evaluaciones_respuestas.id_alternativa,
tbl_evaluaciones_alternativas.alternativa,
tbl_evaluaciones_alternativas.correcta
FROM
tbl_evaluaciones_preguntas
INNER JOIN tbl_evaluaciones ON tbl_evaluaciones.id = tbl_evaluaciones_preguntas.evaluacion
INNER JOIN tbl_evaluaciones_respuestas ON tbl_evaluaciones_respuestas.id_pregunta = tbl_evaluaciones_preguntas.id
INNER JOIN tbl_usuario ON tbl_usuario.rut = tbl_evaluaciones_respuestas.rut
INNER JOIN tbl_evaluaciones_alternativas ON tbl_evaluaciones_alternativas.id = tbl_evaluaciones_respuestas.id_alternativa
where tbl_evaluaciones.id='$id_evaluacion'
order by tbl_evaluaciones_preguntas.evaluacion, tbl_evaluaciones_respuestas.rut
";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ListadoDePreguntasDadaEvaluacionOrdenadas($id_evaluacion) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select tbl_evaluaciones_preguntas.*, tbl_evaluaciones_tipo_preguntas.tipo as tipo_pregunta
from tbl_evaluaciones_preguntas
inner join tbl_evaluaciones_tipo_preguntas
on tbl_evaluaciones_tipo_preguntas.id=tbl_evaluaciones_preguntas.tipo
where evaluacion='$id_evaluacion' order by orden asc";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DeleteLmsRankingPorCriterioEmpresa($campo, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "delete from tbl_lms_ranking_criterios where tipo='$campo' and id_empresa='$id_empresa'

";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
}

function MANTENEDOR_TraigoDatosTabla($id_empresa, $tabla) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from $tabla where id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function MANTENEDOR_InsertaConCamposDinamicos($id_empresa, $nombre_tabla, $datos_campos, $datos_valores) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO $nombre_tabla($datos_campos id_empresa)
VALUES ($datos_valores '$id_empresa');";

$database->setquery($sql);
$database->query();
return mysql_insert_id();
}

function MANTENEDOR_TraeTipoEmpresa($tipo, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_lms_mantenedor_tipo where id_empresa='$id_empresa' and tipo='$tipo'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function MANTENEDOR_TraeCamporPorTipoEmpresa($id_empresa, $tipo) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "
select tbl_lms_mantenedor_campos.*, tbl_lms_mantenedor_tipo_input.template
from tbl_lms_mantenedor_campos
inner join tbl_lms_mantenedor_tipo_input
on tbl_lms_mantenedor_tipo_input.tipo_input=tbl_lms_mantenedor_campos.tipo_input

where id_empresa='$id_empresa' and tipo='$tipo'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function MANTENEDOR_TrarTotalTipos($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_lms_mantenedor_tipo where id_empresa='$id_empresa'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeClasificaciones($id_malla, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$filtro_perfilado = FiltroPerfilado($_SESSION["admin_"], $id_empresa, "rel_lms_malla_curso");

if ($id_malla) {
$filtro_malla = " and rel_lms_malla_curso.id_malla='$id_malla'";
}

$sql = "SELECT
tbl_lms_clasificacion.*
FROM
tbl_lms_clasificacion
INNER JOIN rel_lms_malla_curso ON rel_lms_malla_curso.id_clasificacion = tbl_lms_clasificacion.id_clasificacion $filtro_malla $filtro_perfilado
WHERE
tbl_lms_clasificacion.id_empresa = '$id_empresa'
GROUP BY
tbl_lms_clasificacion.id";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function InsertaInscripcionSimpleTablacierre($id_inscripcion, $rut, $id_curso, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "INSERT INTO tbl_inscripcion_cierre(rut, id_inscripcion, id_curso, id_empresa)
VALUES ('$rut','$id_inscripcion', '$id_curso','$id_empresa');";

$database->setquery($sql);
$database->query();
return mysql_insert_id();
}

function TruncaLmsRanking($campo, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "truncate tbl_lms_ranking_criterios where tipo='$campo' and id_empresa='$id_empresa'

";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
}

function Inserta_tbl_lms_ranking_criterios($tipo, $criterio, $participantes, $avance, $puntos, $resultados, $medallas, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

//$sql = "INSERT INTO tbl_usuario ($values,vigencia) VALUES ($registros,'0');";
$sql = "INSERT INTO
tbl_lms_ranking_criterios
(tipo, criterio, participantes, avance, puntos, resultado, medallas, id_empresa)
VALUES
('$tipo', '$criterio', '$participantes', '$avance', '$puntos', '$resultados', '$medallas', '$id_empresa');";
$database->setquery($sql);
$database->query();
}

function TraigoValoresDadoCampoPorEmpreasLMSReporte($campo, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select distinct($campo) as valor from tbl_lms_reportes where id_empresa='$id_empresa' and $campo is not null and $campo <>'' ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraigoValoresDadoCampoPorEmpreasSGDReporte($campo, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select distinct($campo) as valor from tbl_usuario where id_empresa='$id_empresa' and $campo is not null and $campo <>'' ";
//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function AvancePorCriterioSGD($id_empresa, $nombre_campo, $valor_campo, $arreglo_post) {

//echo "<br>$id_empresa, $nombre_campo, $valor_campo";
$id_proceso = sgd_buscar_proceso($id_empresa);

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "


SELECT
count(id) AS Total,
(
SELECT
count(f.id)
FROM
tbl_sgd_finalizados_evaluado_evaluador f
WHERE
id_proceso = '$id_proceso' and (select $nombre_campo from tbl_usuario where rut=f.evaluado)='$valor_campo'

) AS Finalizados
FROM
tbl_sgd_relaciones h
WHERE
h.id_proceso = '$id_proceso'
AND (
SELECT
$nombre_campo
FROM
tbl_usuario
WHERE
rut = h.evaluado
) = '$valor_campo' and
( SELECT perfil_evaluacion FROM tbl_usuario WHERE rut = h.evaluado ) <> 'DO'


";

$sql = "


SELECT
count(id) AS Total,
(
SELECT
count(f.id)
FROM
tbl_sgd_finalizados_evaluado_evaluador f
WHERE
id_proceso = '$id_proceso' and (select $nombre_campo from tbl_usuario where rut=f.evaluado)='$valor_campo'

) AS Finalizados
FROM
tbl_sgd_relaciones h
WHERE
h.id_proceso = '$id_proceso'
AND (
SELECT
$nombre_campo
FROM
tbl_usuario
WHERE
rut = h.evaluado
) = '$valor_campo'


";

//    echo "<BR>$sql";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function AvancePorCriterio($id_empresa, $nombre_campo, $valor_campo, $arreglo_post) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($arreglo_post["malla"]) {
$filtro_malla = " and tbl_lms_reportes.id_malla='" . $arreglo_post["malla"] . "' ";
}

if ($arreglo_post["curso"]) {
$filtro_curso = " and tbl_lms_reportes.id_curso='" . $arreglo_post["curso"] . "' ";
}

if ($arreglo_post["clasificacion"]) {
$filtro_clasificacion = " and tbl_lms_reportes.id_clasificacion='" . $arreglo_post["clasificacion"] . "' ";
}

$sql = "
SELECT
count(*) as total_usuarios,
tbl_lms_reportes.c1,
tbl_lms_reportes.nombre,
tbl_lms_reportes.cargo,
tbl_lms_reportes.c1,
tbl_lms_reportes.c2,
tbl_lms_reportes.c3,
rel_lms_malla_persona.id_malla,
count(rel_lms_malla_curso.id_curso) as total_cursos,
avg(tbl_lms_reportes.avance) as avance,
sum(tbl_lms_reportes.puntos) as suma_puntos,
avg(tbl_lms_reportes.resultado) as resultado

FROM
tbl_lms_reportes
INNER JOIN rel_lms_malla_persona ON rel_lms_malla_persona.rut = tbl_lms_reportes.rut
INNER JOIN rel_lms_malla_curso ON rel_lms_malla_curso.id_malla = rel_lms_malla_persona.id_malla and tbl_lms_reportes.id_curso=rel_lms_malla_curso.id_curso

WHERE
tbl_lms_reportes.id_empresa = '$id_empresa'
AND  tbl_lms_reportes.$nombre_campo='$valor_campo' $filtro_malla $filtro_curso $filtro_clasificacion
GROUP BY tbl_lms_reportes.$nombre_campo

";

$sql = "
SELECT
count(*)AS total_usuarios,
tbl_lms_reportes.c1,
tbl_lms_reportes.nombre,
tbl_lms_reportes.cargo,
tbl_lms_reportes.c1,
tbl_lms_reportes.c2,
tbl_lms_reportes.c3,
avg(tbl_lms_reportes.avance)AS avance,
sum(tbl_lms_reportes.puntos)AS suma_puntos,
avg(tbl_lms_reportes.resultado)AS resultado,
sum(tbl_lms_reportes.medallas) as suma_medallas

FROM
tbl_lms_reportes

WHERE
tbl_lms_reportes.id_empresa = '$id_empresa'
AND tbl_lms_reportes.$nombre_campo = '$valor_campo' $filtro_malla $filtro_clasificacion and tbl_lms_reportes.id_clasificacion<>''
GROUP BY
tbl_lms_reportes.$nombre_campo

";

$sql = "
SELECT
count(DISTINCT(rut)) as total_usuarios,
tbl_lms_reportes.c1,
tbl_lms_reportes.nombre,
tbl_lms_reportes.cargo,
tbl_lms_reportes.c1,
tbl_lms_reportes.c2,
tbl_lms_reportes.c3,
avg(tbl_lms_reportes.avance)AS avance,
sum(tbl_lms_reportes.puntos)AS suma_puntos,
avg(tbl_lms_reportes.resultado)AS resultado,
sum(tbl_lms_reportes.medallas) as suma_medallas

FROM
tbl_lms_reportes

WHERE
tbl_lms_reportes.id_empresa = '$id_empresa'
AND tbl_lms_reportes.$nombre_campo = '$valor_campo' $filtro_malla $filtro_clasificacion and tbl_lms_reportes.id_clasificacion<>''
GROUP BY
tbl_lms_reportes.$nombre_campo

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraigoDatosTablareportesConsolidadPorerio($id_empresa, $nombre_campo, $valor) {global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "SELECT
tbl_usuario.rut,
tbl_lms_reportes.nombre,
tbl_lms_reportes.cargo,
tbl_lms_reportes.c1,
tbl_lms_reportes.c2,
tbl_lms_reportes.c3,
rel_lms_malla_persona.id_malla,
(select nombre from tbl_lms_malla where id=rel_lms_malla_persona.id_malla) as nombremalla,
count(rel_lms_malla_curso.id_curso) as total_cursos,
avg(tbl_lms_reportes.avance) as avance,
sum(tbl_lms_reportes.puntos) as suma_puntos,
avg(tbl_lms_reportes.resultado) as resultado

FROM
tbl_usuario
INNER JOIN rel_lms_malla_persona ON rel_lms_malla_persona.rut = tbl_usuario.rut
INNER JOIN rel_lms_malla_curso ON rel_lms_malla_curso.id_malla = rel_lms_malla_persona.id_malla
inner join tbl_lms_reportes on tbl_lms_reportes.rut=tbl_usuario.rut and tbl_lms_reportes.id_curso=rel_lms_malla_curso.id_curso
WHERE
tbl_usuario.id_empresa = '$id_empresa'
AND tbl_usuario.vigencia = '0'
GROUP BY tbl_usuario.rut";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TraeEvaluadoEvaluadorPorProceso3CamposMedioCiclo($id_proceso, $registros_por_pagina, $pagina, $arreglo_post, $campo_criterio, $criterio, $valor_criterio, $campos_para_reporte, $datos_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
SELECT DISTINCT

tbl_sgd_relaciones.evaluador,
tbl_sgd_relaciones.evaluado,

base_evaluador.nombre_completo AS nombre_evaluador,
base_evaluador." . $datos_empresa[0]->campo1 . " AS campo1,
base_evaluador." . $datos_empresa[0]->campo2 . " AS campo2,
base_evaluador." . $datos_empresa[0]->campo3 . " AS campo3,
base_evaluador.rut_completo AS rut_completo_evaluador,
base_evaluador.cargo AS cargo_evaluador,
base_evaluador.gerencia AS gerencia_evaluador,
base_evaluador.nombre_empresa_holding AS nombre_empresa_holding_evaluador,

base_evaluado.nombre_completo AS nombre_evaluado,
base_evaluado." . $datos_empresa[0]->campo1 . " AS campo1_evaluado,
base_evaluado." . $datos_empresa[0]->campo2 . " AS campo_evaluado2,
base_evaluado." . $datos_empresa[0]->campo3 . " AS campo3_evaluado,
base_evaluado.rut_completo AS rut_completo_evaluado,
base_evaluado.cargo AS cargo_evaluado,
base_evaluado.gerencia AS gerencia_evaluado,
base_evaluado.nombre_empresa_holding AS nombre_empresa_holding_evaluado








FROM
tbl_sgd_relaciones
INNER JOIN tbl_usuario AS base_evaluador ON base_evaluador.rut = tbl_sgd_relaciones.evaluador
INNER JOIN tbl_usuario as base_evaluado on base_evaluado.rut=tbl_sgd_relaciones.evaluado
WHERE
tbl_sgd_relaciones.id_proceso = '$id_proceso'

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function Tragotb_DatosdesdeFull_Filtros($ejecutivo, $fecha_inicio, $fecha_termino) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$queryEj = "";
$queryFi = "";
$queryFt = "";

if ($ejecutivo != '' and $ejecutivo != '0') {$queryEj = " and h.rut_ejecutivo='$ejecutivo' ";
$txt_e = "_" . $ejecutivo;}
if ($fecha_inicio != '') {$queryFi = " and h.fecha_inicio>='$fecha_inicio' ";
$txt_fi = "_" . $fecha_inicio;}
if ($fecha_termino != '') {$queryFt = " and h.fecha_termino<='$fecha_termino' ";
$txt_ft = "_" . $fecha_termino;}

$sql = "select h.*

from tbl_lms_reportes_full h

where h.id>0
$queryEj $queryFi $queryFt



";
//  echo $sql; exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Tragotb_DatosdesdeFull_FiltrosPersona($rut, $fecha_inicio, $fecha_termino) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$queryEj = "";
$queryFi = "";
$queryFt = "";

if ($rut != '') {$queryEj = " and h.rut='$rut' ";
$txt_e = "_" . $rut;}
if ($fecha_inicio != '') {$queryFi = " and h.fecha_inicio>='$fecha_inicio' ";
$txt_fi = "_" . $fecha_inicio;}
if ($fecha_termino != '') {$queryFt = " and h.fecha_termino<='$fecha_termino' ";
$txt_ft = "_" . $fecha_termino;}

$sql = "select h.* from tbl_lms_reportes_full h where h.rut<>''
$queryEj $queryFi $queryFt
order by h.rut ";

//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Tragotb_DatosdesdeFull() {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.* from tbl_lms_reportes_full h where h.rut<>'' order by h.rut";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TraigoDatosTablareportesConsolidad_Full($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$filtro_usuarios_activos = "";

$sql = "
select  h.id_inscripcion,h.rut, h.id_curso, h.id_empresa, h.inscrito,
(select rut_completo from tbl_usuario where rut=h.rut limit 1) as rut_completo,
(select nombre from tbl_usuario where rut=h.rut limit 1) as nombre_completo,
(select cargo from tbl_usuario where rut=h.rut limit 1) as cargo,
(select c4 from tbl_lms_reportes where rut=h.rut limit 1) as c4,
(select c3 from tbl_lms_reportes where rut=h.rut limit 1) as c3,(select c2 from tbl_lms_reportes where rut=h.rut limit 1) as c2,
(select c1 from tbl_lms_reportes where rut=h.rut limit 1) as c1,
(select nombre_empresa_holding from tbl_usuario where rut=h.rut limit 1) as empresa_holding,

(select nombre_completo from tbl_usuario where rut=(select jefe from tbl_usuario where rut=h.rut limit 1)) as jefe,

(select rut_completo from tbl_usuario where rut=(select jefe from tbl_usuario where rut=h.rut limit 1) limit 1) as Rutjefe,

(select ejecutivo from tbl_inscripcion_curso where codigo_inscripcion=h.id_inscripcion limit 1    ) as Ejecutivo,
(select id_empresa_programa from tbl_lms_curso where id=(select id_curso from tbl_inscripcion_curso where codigo_inscripcion=h.id_inscripcion limit 1) limit 1) as id_programa,
(select nombre_programa from tbl_lms_programas_bbdd  where id_programa=(select id_empresa_programa from tbl_lms_curso where id=(select id_curso from tbl_inscripcion_curso where codigo_inscripcion=h.id_inscripcion limit 1) limit 1)) as Programa,
(select id_foco from tbl_lms_curso where id=(select id_curso from tbl_inscripcion_curso where codigo_inscripcion=h.id_inscripcion limit 1) limit 1) as id_foco,
(select descripcion from tbl_lms_foco  where codigo_foco=(select id_foco from tbl_lms_curso where id=(select id_curso from tbl_inscripcion_curso where codigo_inscripcion=h.id_inscripcion limit 1) limit 1)) as Foco,
(select nombre from tbl_lms_curso where id=h.id_curso limit 1) as NombreCurso,
(select modalidad from tbl_lms_curso where id=h.id_curso limit 1) as ModalidadCurso,
(select tipo from tbl_lms_curso where id=h.id_curso limit 1) as TipoCurso,
(select count(id) as cuenta from rel_lms_inscripcion_usuario_checkin
where rut=h.rut and codigo_imparticion= h.id_inscripcion) as avanceElearning,
NULL as notaElearning,
(select direccion from tbl_inscripcion_curso where codigo_inscripcion=h.id_inscripcion limit 1) as LugarEjecucion,
(select numero_horas from tbl_lms_curso where id=h.id_curso limit 1) as HorasCurso,
(select fecha_inicio from tbl_inscripcion_curso where codigo_inscripcion=h.id_inscripcion limit 1) as FechaInicioPres,
(select fecha_termino from tbl_inscripcion_curso where codigo_inscripcion=h.id_inscripcion limit 1) as FechaTerminoPres,
NULL as FechaInicioElearning,
NULL as FechaTerminoElearning,
NULL as opcional,
NULL as puntosElearning

from tbl_inscripcion_usuarios h

where h.id_empresa='$id_empresa'
and (select modalidad from tbl_lms_curso where id=h.id_curso limit 1)=2
and h.rut<>'' and h.id_inscripcion
and (select cargo from tbl_usuario where rut=h.rut limit 1)<>'RELATOR'
and (select nombre_completo from tbl_usuario where rut=h.rut limit 1)<>'USUARIO_INACTIVO'

union

select
h.id_curso,h.rut, h.id_curso, h.id_empresa, '1',
h.rut_completo,
h.nombre as nombre_completo, h.cargo,
h.c4,h.c3,h.c2,h.c1,
(select nombre_empresa_holding from tbl_usuario where rut=h.rut limit 1) as empresa_holding,
(select nombre_completo from tbl_usuario where rut=(select jefe from tbl_usuario where rut=h.rut limit 1)) as jefe,
(select rut_completo from tbl_usuario where rut=(select jefe from tbl_usuario where rut=h.rut limit 1) limit 1) as Rutjefe,
(select ejecutivo from tbl_inscripcion_curso where codigo_inscripcion=h.id_curso limit 1    ) as Ejecutivo,
h.id_programa as id_programa,
(select nombre_programa from tbl_lms_programas_bbdd  where id_programa=h.id_programa) as Programa,
h.id_foco,
(select descripcion from tbl_lms_foco  where codigo_foco=h.id_foco) as Foco,
(select nombre from tbl_lms_curso where id=h.id_curso limit 1) as NombreCurso,
(select modalidad from tbl_lms_curso where id=h.id_curso limit 1) as ModalidadCurso,
(select tipo from tbl_lms_curso where id=h.id_curso limit 1) as TipoCurso,
(select round(avg(avance)) from tbl_lms_reportes where id_programa=h.id_programa  and rut=h.rut limit 1) as avanceElearning,
(select round(avg(resultado)) from tbl_lms_reportes  where id_programa=h.id_programa and  rut=h.rut limit 1) as notaElearning,
NULL as LugarEjecucion,
(select sum(numero_horas) from tbl_lms_reportes where id_programa=h.id_programa and rut=h.rut ) as HorasCurso,
NULL as FechaInicioPres,
NULL as FechaTerminoPres,
(select fecha_inicio from tbl_lms_reportes where id_programa=h.id_programa and rut=h.rut and fecha_inicio<>'0000-00-00' order by fecha_inicio ASC limit 1) as FechaInicioElearning,
(select fecha_termino from tbl_lms_reportes where id_programa=h.id_programa and rut=h.rut  and fecha_termino<>'0000-00-00'  order by fecha_termino DESC limit 1) as FechaTerminoElearning,
h.curso_opcional as opcional,
(select round(sum(puntos)) from tbl_lms_reportes  where id_programa=h.id_programa and  rut=h.rut limit 1) as puntosElearning


from tbl_lms_reportes h



where h.id_empresa='$id_empresa'


and h.rut<>'' and h.id_curso<>''
and (select cargo from tbl_usuario where rut=h.rut limit 1)<>'RELATOR'
and (select nombre_completo from tbl_usuario where rut=h.rut limit 1)<>'USUARIO_INACTIVO'
group by h.rut, h.id_programa
";

//
//and h.rut='14334779'
//ho $sql; and h.rut='10426466'

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Lms_reporteFullData_Truncate($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "TRUNCATE tbl_lms_reportes_full ";
//echo $sql;
$database->setquery($sql);
$database->query();
}
function TraigoDatosTablareportesConsolidad2018($id_empresa, $arreglo_post, $trivias, $excel) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$filtro_usuarios_activos = "";

//echo "<br><br>TraigoDatosTablareportesConsolidad arreglo_post<br>";
//print_r($arreglo_post);

if ($arreglo_post["objetos"] AND $arreglo_post["objetos"] != '0') {
$campos_objeto = ",
tbl_objetos_finalizados.fecha as fecha_objeto_finalizado,
tbl_objetos_finalizados.nota as notaobjeto,
tbl_gamificado_puntos.puntos,
tbl_gamificado_puntos.medallas,
tbl_objeto.titulo as tituloobjeto";
$filtro_objetos = "left join tbl_objetos_finalizados
on tbl_objetos_finalizados.id_objeto='" . $arreglo_post["objetos"] . "' and tbl_objetos_finalizados.rut=tbl_usuario.rut
left join tbl_gamificado_puntos
on tbl_gamificado_puntos.rut=tbl_usuario.rut and tbl_gamificado_puntos.id_objeto='" . $arreglo_post["objetos"] . "'
left join tbl_objeto
on tbl_objeto.id='" . $arreglo_post["objetos"] . "'



";
}

if ($arreglo_post["malla"]) {
$filtro_malla = " and tbl_lms_reportes.id_malla='" . $arreglo_post["malla"] . "'";
}

if ($trivias) {
$dato_trivia = " tbl_objetos_finalizados.nota as nota_eval_curso, ";
$filtro_trivia = " LEFT JOIN tbl_objetos_finalizados
on tbl_objetos_finalizados.id_curso=tbl_lms_reportes.id_curso and
tbl_objetos_finalizados.rut=tbl_lms_reportes.rut and
tbl_objetos_finalizados.nota is not null and
tbl_objetos_finalizados.nota<>''";
}

if ($arreglo_post["cursos"]) {
$filtro_curso = " and tbl_lms_reportes.id_curso='" . $arreglo_post["cursos"] . "'";
}

if ($arreglo_post["clasificacion"]) {
$filtro_clasificacion = " and tbl_lms_reportes.id_clasificacion='" . $arreglo_post["clasificacion"] . "'";
}

if ($arreglo_post["foco"]) {
$filtro_foco = " and tbl_lms_reportes.id_foco='" . $arreglo_post["foco"] . "'";
}

if ($arreglo_post["programabbdd"]) {
$filtro_programabbdd = " and tbl_lms_reportes.id_programa='" . $arreglo_post["programabbdd"] . "'";
}

if ($arreglo_post["c1"]) {
$filtro_c1 = " and tbl_lms_reportes.c1='" . $arreglo_post["c1"] . "'";
}

if ($arreglo_post["c2"]) {
$filtro_c2 = " and tbl_lms_reportes.c2='" . $arreglo_post["c2"] . "'";
}

if ($arreglo_post["c3"]) {
$filtro_c3 = " and tbl_lms_reportes.c3='" . $arreglo_post["c3"] . "'";
}

if ($arreglo_post["c4"]) {
$filtro_c3 = " and tbl_lms_reportes.c4='" . $arreglo_post["c4"] . "'";
}

$campos_subida = REL_MALLA_CURSO_trarCamposSubidaParaReporte($id_empresa);
//print_r($campos_subida);

$total_campos = 0;
foreach ($campos_subida as $campo) {
//echo "<br>".$campo->campo;
if (count($arreglo_post[$campo->campo]) > 0 && $arreglo_post[$campo->campo][0] != '0') {
$total_campos++;
if ($total_campos >= 2) {
$filtros_campos_dinamicos .= " and ";
}
//echo "<br>".$campo->campo;
$total = count($arreglo_post[$campo->campo]);
$filtros_campos_dinamicos .= " ( ";
for ($i = 1; $i <= $total; $i++) {
if ($i >= 2) {
$filtros_campos_dinamicos .= " or ";
}
$filtros_campos_dinamicos .= " tbl_usuario." . $campo->campo . "='" . $arreglo_post[$campo->campo][$i - 1] . "'";
}
$filtros_campos_dinamicos .= " ) ";
}
}

if ($filtros_campos_dinamicos) {
$filtros_campos_dinamicos = "and ($filtros_campos_dinamicos)";
}

if ($filtros_campos_dinamicos) {
$filtros_campos_dinamicos = utf8_decode($filtros_campos_dinamicos);
}

//excel detalle
$add_groupbycursos = "";
$add_curso = "";
//if($arreglo_post[excel]=='2')
if ($excel == "2") {
$add_groupbycursos = " ,
tbl_lms_reportes.id_curso";

$add_curso = "    and     tbl_lms_reportes.id_curso=rel_lms_malla_curso.id_curso ";
}

if ($arreglo_post["activo"] == "activos") {
$filtro_usuarios_activos = " ";
}

$filtro_perfilado = FiltroPerfilado($_SESSION["admin_"], $id_empresa, "rel_lms_malla_curso");

$filtro_audiencia = FiltroPerfiladoAudiencias($_SESSION["admin_"], $id_empresa);




$sql="SELECT


tbl_lms_reportes.rut,
tbl_lms_reportes.rut_completo,
tbl_lms_reportes.nombre,
tbl_lms_reportes.cargo,
tbl_lms_reportes.email,
tbl_lms_reportes.c1,
tbl_lms_reportes.c2,
tbl_lms_reportes.c3,
tbl_lms_reportes.fecha_inscripcion as fecha_antiguedad,
tbl_lms_reportes.id_curso,

(select nombre from tbl_lms_curso where id=tbl_lms_reportes.id_curso limit 1) as nombre_curso,

tbl_lms_reportes.id_malla,

(select nombre from tbl_lms_malla where id=tbl_lms_reportes.id_malla and id_empresa = '$id_empresa') as nombremalla,


ROUND(

(select     count(id)            FROM
tbl_lms_reportes
WHERE
tbl_lms_reportes.rut = tbl_lms_reportes.rut
$filtro_malla $filtro_curso $filtro_clasificacion $filtro_foco $filtro_programabbdd
and (select inactivo from  rel_lms_malla_curso where id_curso=tbl_lms_reportes.id_curso and id_malla=tbl_lms_reportes.id_malla limit 1) = '0'

)
)
AS total_cursos,


ROUND(    avg(tbl_lms_reportes.avance)    ) AS avance,
ROUND((select avg( tbl_lms_reportes.resultado ) from tbl_lms_reportes where tbl_lms_reportes.resultado<>'-' and tbl_lms_reportes.rut=tbl_lms_reportes.rut  $filtro_malla $filtro_curso $filtro_clasificacion $filtro_foco $filtro_programabbdd $add_curso) ) as resultado,
ROUND(    sum(tbl_lms_reportes.medallas)) AS suma_medallas,
ROUND(    sum(tbl_lms_reportes.puntos)) AS suma_puntos,

(select fecha_inicio from tbl_lms_reportes where rut=tbl_lms_reportes.rut and fecha_inicio<>'0000-00-00'   $filtro_malla $filtro_curso $filtro_clasificacion $filtro_foco $filtro_programabbdd order by fecha_inicio ASC limit 1) as FechaLogIn,
(select fecha_termino from tbl_lms_reportes where rut=tbl_lms_reportes.rut and fecha_termino<>'0000-00-00'   $filtro_malla $filtro_curso $filtro_clasificacion $filtro_foco $filtro_programabbdd order by fecha_termino DESC limit 1) as FechaFin,

(select count(id) as total_aprobados from tbl_lms_reportes where rut=tbl_lms_reportes.rut and estado='APROBADO'   $filtro_malla $filtro_curso $filtro_clasificacion $filtro_foco $filtro_programabbdd

and (select inactivo from  rel_lms_malla_curso where id_curso=tbl_lms_reportes.id_curso and id_malla=tbl_lms_reportes.id_malla limit 1) = '0'


order by fecha_termino DESC limit 1) as total_aprobados,
(select count(id) as total_aprobados from tbl_lms_reportes where rut=tbl_lms_reportes.rut and estado='REPROBADO'   $filtro_malla $filtro_curso $filtro_clasificacion $filtro_foco $filtro_programabbdd
and (select inactivo from  rel_lms_malla_curso where id_curso=tbl_lms_reportes.id_curso and id_malla=tbl_lms_reportes.id_malla limit 1) = '0'
order by fecha_termino DESC limit 1) as total_reprobados,
tbl_lms_reportes.hora_termino,
tbl_lms_reportes.estado,
tbl_lms_reportes.fecha_inscripcion,
tbl_lms_reportes.intentos,
(select avg(nota_aprobacion) as nota_aprobacion from tbl_objeto where id_curso=rel_lms_malla_curso.id_curso and cm is null) as nota_aprobacion


$campos_objeto

FROM

tbl_lms_reportes

left JOIN rel_lms_malla_persona ON rel_lms_malla_persona.rut = tbl_lms_reportes.rut
left JOIN rel_lms_malla_curso ON rel_lms_malla_curso.id_malla = rel_lms_malla_persona.id_malla

$filtro_objetos
$filtro_trivia
AND tbl_lms_reportes.id_curso = rel_lms_malla_curso.id_curso
WHERE

tbl_lms_reportes.id_empresa = '$id_empresa'

$filtro_usuarios_activos

$filtro_audiencia

$filtro_malla $filtro_curso $filtro_clasificacion $filtro_foco $filtro_programabbdd $filtro_c1 $filtro_c2 $filtro_c3



and (rel_lms_malla_curso.opcional is null or rel_lms_malla_curso.opcional=0)
and rel_lms_malla_curso.inactivo='0'
and abs(tbl_lms_reportes.rut)<>0

GROUP BY tbl_lms_reportes.rut
$add_groupbycursos
";

//echo $sql;exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}
function TraigoDatosTablareportesConsolidad($id_empresa, $arreglo_post, $trivias, $excel) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$filtro_usuarios_activos = "";

//echo "<br><br>TraigoDatosTablareportesConsolidad arreglo_post<br>";
//print_r($arreglo_post);

if ($arreglo_post["objetos"] AND $arreglo_post["objetos"] != '0') {
$campos_objeto = ",
tbl_objetos_finalizados.fecha as fecha_objeto_finalizado,
tbl_objetos_finalizados.nota as notaobjeto,
tbl_gamificado_puntos.puntos,
tbl_gamificado_puntos.medallas,
tbl_objeto.titulo as tituloobjeto";
$filtro_objetos = "left join tbl_objetos_finalizados
on tbl_objetos_finalizados.id_objeto='" . $arreglo_post["objetos"] . "' and tbl_objetos_finalizados.rut=tbl_usuario.rut
left join tbl_gamificado_puntos
on tbl_gamificado_puntos.rut=tbl_usuario.rut and tbl_gamificado_puntos.id_objeto='" . $arreglo_post["objetos"] . "'
left join tbl_objeto
on tbl_objeto.id='" . $arreglo_post["objetos"] . "'



";
}

if ($arreglo_post["malla"]) {
$filtro_malla = " and h.id_malla='" . $arreglo_post["malla"] . "'";
$filtro_mallaSH = " and id_malla='" . $arreglo_post["malla"] . "'";
}

if ($trivias) {
$dato_trivia = " tbl_objetos_finalizados.nota as nota_eval_curso, ";
$filtro_trivia = " LEFT JOIN tbl_objetos_finalizados
on tbl_objetos_finalizados.id_curso=tbl_lms_reportes.id_curso and
tbl_objetos_finalizados.rut=tbl_lms_reportes.rut and
tbl_objetos_finalizados.nota is not null and
tbl_objetos_finalizados.nota<>''";
}

if ($arreglo_post["cursos"]) {
$filtro_curso = " and h.id_curso='" . $arreglo_post["cursos"] . "'";
$filtro_cursoSH = " and id_curso='" . $arreglo_post["cursos"] . "'";
}

if ($arreglo_post["clasificacion"]) {
$filtro_clasificacion = " and h.id_clasificacion='" . $arreglo_post["clasificacion"] . "'";
$filtro_clasificacionSH = " and id_clasificacion='" . $arreglo_post["clasificacion"] . "'";
}

if ($arreglo_post["foco"]) {
$filtro_foco = " and h.id_foco='" . $arreglo_post["foco"] . "'";
$filtro_focoSH = " and id_foco='" . $arreglo_post["foco"] . "'";
}

if ($arreglo_post["programabbdd"]) {
$filtro_programabbdd = " and h.id_programa='" . $arreglo_post["programabbdd"] . "'";
$filtro_programabbddSH = " and id_programa='" . $arreglo_post["programabbdd"] . "'";
}

if ($arreglo_post["c1"]) {
$filtro_c1 = " and h.c1='" . $arreglo_post["c1"] . "'";
}

if ($arreglo_post["c2"]) {
$filtro_c2 = " and h.c2='" . $arreglo_post["c2"] . "'";
}

if ($arreglo_post["c3"]) {
$filtro_c3 = " and h.c3='" . $arreglo_post["c3"] . "'";
}

if ($arreglo_post["c4"]) {
$filtro_c3 = " and h.c4='" . $arreglo_post["c4"] . "'";
}

$campos_subida = REL_MALLA_CURSO_trarCamposSubidaParaReporte($id_empresa);
//print_r($campos_subida);

$total_campos = 0;
foreach ($campos_subida as $campo) {
//echo "<br>".$campo->campo;
if (count($arreglo_post[$campo->campo]) > 0 && $arreglo_post[$campo->campo][0] != '0') {
$total_campos++;
if ($total_campos >= 2) {
$filtros_campos_dinamicos .= " and ";
}
//echo "<br>".$campo->campo;
$total = count($arreglo_post[$campo->campo]);
$filtros_campos_dinamicos .= " ( ";
for ($i = 1; $i <= $total; $i++) {
if ($i >= 2) {
$filtros_campos_dinamicos .= " or ";
}
$filtros_campos_dinamicos .= " tbl_usuario." . $campo->campo . "='" . $arreglo_post[$campo->campo][$i - 1] . "'";
}
$filtros_campos_dinamicos .= " ) ";
}
}

if ($filtros_campos_dinamicos) {
$filtros_campos_dinamicos = "and ($filtros_campos_dinamicos)";
}

if ($filtros_campos_dinamicos) {
$filtros_campos_dinamicos = utf8_decode($filtros_campos_dinamicos);
}

//excel detalle
$add_groupbycursos = "";
$add_curso = "";
//if($arreglo_post[excel]=='2')
if ($excel == "2") {
$add_groupbycursos = " ,
h.id_curso";

$add_curso = "    and     h.id_curso=rel_lms_malla_curso.id_curso ";
$add_cursoSH = "    and     id_curso=rel_lms_malla_curso.id_curso ";
}

if ($arreglo_post["activo"] == "activos") {
$filtro_usuarios_activos = " ";
}

$filtro_perfilado = FiltroPerfilado($_SESSION["admin_"], $id_empresa, "rel_lms_malla_curso");

$filtro_audiencia = FiltroPerfiladoAudiencias($_SESSION["admin_"], $id_empresa);




$sql="SELECT


h.rut,
h.rut_completo,
h.nombre,
h.cargo,
h.email,
h.c1,
h.c2,
h.c3,
h.fecha_inscripcion as fecha_antiguedad,
h.id_curso,

(select nombre from tbl_lms_curso where id=h.id_curso limit 1) as nombre_curso,

h.id_malla,

(select nombre from tbl_lms_malla where id=h.id_malla and id_empresa = '$id_empresa') as nombremalla,


ROUND(

(select     count(id)            FROM
tbl_lms_reportes
WHERE
rut = h.rut
$filtro_mallaSH $filtro_cursoSH $filtro_clasificacionSH $filtro_focoSH $filtro_programabbddSH


and curso_opcional = '0'

)
)
AS total_cursos,


ROUND(    avg(h.avance)    ) AS avance,
ROUND((select avg( resultado ) from tbl_lms_reportes where resultado<>'-' and rut=h.rut  $filtro_mallaSH $filtro_cursoSH $filtro_clasificacionSH $filtro_focoSH $filtro_programabbddSH $add_cursoSH) ) as resultado,
ROUND(    sum(h.medallas)) AS suma_medallas,
ROUND(    sum(h.puntos)) AS suma_puntos,

(select fecha_inicio from tbl_lms_reportes where rut=h.rut and fecha_inicio<>'0000-00-00'   $filtro_malla $filtro_curso $filtro_clasificacion $filtro_foco $filtro_programabbdd order by fecha_inicio ASC limit 1) as FechaLogIn,
(select fecha_termino from tbl_lms_reportes where rut=h.rut and fecha_termino<>'0000-00-00'   $filtro_malla $filtro_curso $filtro_clasificacion $filtro_foco $filtro_programabbdd order by fecha_termino DESC limit 1) as FechaFin,

(select count(id) as total_aprobados from tbl_lms_reportes where rut=h.rut and estado='APROBADO'   $filtro_mallaSH $filtro_cursoSH $filtro_clasificacionSH $filtro_focoSH $filtro_programabbddSH

AND curso_opcional = '0'

order by fecha_termino DESC limit 1) as total_aprobados,
(select count(id) as total_aprobados from tbl_lms_reportes where rut=h.rut and estado='REPROBADO'   $filtro_mallaSH $filtro_cursoSH $filtro_clasificacionSH $filtro_focoSH $filtro_programabbddSH
AND curso_opcional = '0'
order by fecha_termino DESC limit 1) as total_reprobados,
h.hora_termino,
h.estado,
h.fecha_inscripcion,
h.intentos,
(select avg(nota_aprobacion) as nota_aprobacion from tbl_objeto where id_curso=rel_lms_malla_curso.id_curso and cm is null) as nota_aprobacion


$campos_objeto

FROM

tbl_lms_reportes h

left JOIN rel_lms_malla_persona ON rel_lms_malla_persona.rut = h.rut
left JOIN rel_lms_malla_curso ON rel_lms_malla_curso.id_malla = rel_lms_malla_persona.id_malla

$filtro_objetos
$filtro_trivia
AND h.id_curso = rel_lms_malla_curso.id_curso
WHERE

h.id_empresa = '$id_empresa'

$filtro_usuarios_activos

$filtro_audiencia

$filtro_malla $filtro_curso $filtro_clasificacion $filtro_foco $filtro_programabbdd $filtro_c1 $filtro_c2 $filtro_c3



and (rel_lms_malla_curso.opcional is null or rel_lms_malla_curso.opcional=0)
and rel_lms_malla_curso.inactivo='0'
and abs(h.rut)<>0

GROUP BY h.rut
$add_groupbycursos
";

//echo $sql;  exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function nombrecursolimit1($id_curso) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select nombre from tbl_lms_curso where id='$id_curso' limit 1";
//echo "<br>$sql"; exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function BuscaComentariosFinalEncuesta($id_encuesta, $id_medicion, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select comentario from tbl_enc_elearning_respuestas where id_encuesta='$id_encuesta'
and id_medicion='$id_medicion' and id_empresa='$id_empresa' limit 1";
//echo "<br>$sql"; exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TraigoDatosTablareportesConsolidadBK2($id_empresa) {global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select rel_lms_malla_persona.rut, rel_lms_malla_persona.id_malla,
(select count(a.id) as total from tbl_lms_reportes as a where a.rut=rel_lms_malla_persona.rut and a.id_malla=rel_lms_malla_persona.id_malla  ) as total_cursos,
(select avg(b.avance) as avance_total from tbl_lms_reportes as b where b.rut=rel_lms_malla_persona.rut and b.id_malla=rel_lms_malla_persona.id_malla) as avance,
(select sum(c.puntos) as suma_puntos from tbl_lms_reportes as c where c.rut=rel_lms_malla_persona.rut  and c.id_malla=rel_lms_malla_persona.id_malla) as suma_puntos,
(select avg(d.resultado) as promedio_resultados from tbl_lms_reportes as d where d.rut=rel_lms_malla_persona.rut  and d.id_malla=rel_lms_malla_persona.id_malla) as promedio_resultados,
(select sum(e.medallas) as suma_medallas from tbl_lms_reportes as e where e.rut=rel_lms_malla_persona.rut  and e.id_malla=rel_lms_malla_persona.id_malla) as suma_medallas,

(select DISTINCT(f.nombre) as nombre from tbl_lms_reportes as f where f.rut=rel_lms_malla_persona.rut  and f.id_malla=rel_lms_malla_persona.id_malla) as nombre,
(select DISTINCT(g.cargo) as cargo from tbl_lms_reportes as g where g.rut=rel_lms_malla_persona.rut  and g.id_malla=rel_lms_malla_persona.id_malla) as cargo,
(select DISTINCT(h.c1) as c1 from tbl_lms_reportes as h where h.rut=rel_lms_malla_persona.rut  and h.id_malla=rel_lms_malla_persona.id_malla) as c1,
(select DISTINCT(i.c2) as c2 from tbl_lms_reportes as i where i.rut=rel_lms_malla_persona.rut  and i.id_malla=rel_lms_malla_persona.id_malla) as c2,
(select DISTINCT(j.c3) as c3 from tbl_lms_reportes as j where j.rut=rel_lms_malla_persona.rut  and j.id_malla=rel_lms_malla_persona.id_malla) as c3



from rel_lms_malla_persona
where rel_lms_malla_persona.id_empresa='$id_empresa'
ORDER BY rut asc";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TraigoDatosTablareportesConsolidadBK($id_empresa) {global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "SELECT
tbl_lms_reportes.rut,
tbl_lms_reportes.id_malla,
(select count(a.id) as total from tbl_lms_reportes as a where a.rut=tbl_lms_reportes.rut and a.id_malla=tbl_lms_reportes.id_malla  ) as total_cursos,
(select avg(b.avance) as avance_total from tbl_lms_reportes as b where b.rut=tbl_lms_reportes.rut and b.id_malla=tbl_lms_reportes.id_malla) as avance,
(select sum(c.puntos) as suma_puntos from tbl_lms_reportes as c where c.rut=tbl_lms_reportes.rut  and c.id_malla=tbl_lms_reportes.id_malla) as suma_puntos,
(select avg(d.resultado) as promedio_resultados from tbl_lms_reportes as d where d.rut=tbl_lms_reportes.rut  and d.id_malla=tbl_lms_reportes.id_malla) as promedio_resultados,
(select sum(e.medallas) as suma_medallas from tbl_lms_reportes as e where e.rut=tbl_lms_reportes.rut  and e.id_malla=tbl_lms_reportes.id_malla) as suma_medallas,
nombre,
cargo,
c1,
c2,
c3

FROM tbl_lms_reportes

inner join rel_lms_malla_persona
on rel_lms_malla_persona.rut=tbl_lms_reportes.rut and rel_lms_malla_persona.id_malla=tbl_lms_reportes.id_malla

WHERE tbl_lms_reportes.id_empresa = '$id_empresa'
GROUP BY tbl_lms_reportes.rut, tbl_lms_reportes.id_malla
order by tbl_lms_reportes.rut asc ;";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TraigoDatosTablareportes($id_empresa, $arreglo_post) {global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($arreglo_post["malla"]) {
$filtro_malla = " and h.id_malla='" . $arreglo_post["malla"] . "'";
}

if ($arreglo_post["curso"]) {
$filtro_curso = " and h.id_curso='" . $arreglo_post["curso"] . "'";
}

if ($arreglo_post["clasificacion"]) {
$filtro_clasificacion = " and h.id_clasificacion='" . $arreglo_post["clasificacion"] . "'";
}

if ($arreglo_post["foco"]) {
$filtro_foco = " and h.id_foco='" . $arreglo_post["foco"] . "'";
}

if ($arreglo_post["programabbdd"]) {
$filtro_programabbdd = " and h.id_programa='" . $arreglo_post["programabbdd"] . "'";
}

if ($arreglo_post["c1"]) {
$filtro_c1 = " and h.c1='" . $arreglo_post["c1"] . "'";
}

if ($arreglo_post["c2"]) {
$filtro_c2 = " and h.c2='" . $arreglo_post["c2"] . "'";
}

if ($arreglo_post["c3"]) {
$filtro_c3 = " and h.c3='" . $arreglo_post["c3"] . "'";
}

$sql = "

select h.*, (select nombre from tbl_lms_malla where id=h.id_malla) as nombremalla,
(select nombre from tbl_lms_curso where id=h.id_curso) as nombrecurso

from tbl_lms_reportes h where h.id_empresa='$id_empresa'

$filtro_malla $filtro_clasificacion $filtro_curso $filtro_foco $filtro_programabbdd $filtro_c1 $filtro_c2 $filtro_c2 and abs(rut)<>0";
//echo "<br>$sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Inserta_tbl_lms_reportes($rut, $nombre, $cargo, $email, $c1, $c2, $c3, $id_malla, $id_clasificacion, $id_curso, $avance, $puntos, $resultados, $medallas, $id_empresa, $rut_completo) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($avance > 100) {$avance = 100;}

$resultados = round($resultados);
//$sql = "INSERT INTO tbl_usuario ($values,vigencia) VALUES ($registros,'0');";
$sql = "INSERT INTO
tbl_lms_reportes
(rut, nombre, cargo, email, c1, c2, c3, id_malla, id_clasificacion, id_curso, avance, puntos, resultado, medallas, fecha, hora, id_empresa, rut_completo)
VALUES
('$rut', '$nombre', '$cargo', '$email', '$c1', '$c2', '$c3', '$id_malla', '$id_clasificacion', '$id_curso', '$avance', '$puntos', '$resultados', '$medallas', '" . date("Y-m-d") . "', '" . date("H:i:s") . "', '$id_empresa', '$rut_completo');";

$database->setquery($sql);
if (!$database->query_error()) {
return $database->errores(mysql_error());
}

// Verifica que avance sea igual a cierre
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select avance from tbl_inscripcion_cierre where id_empresa='$id_empresa' and rut='$rut' and id_curso='$id_curso'";
//echo "<br>$sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//echo "<br>".count($cod);
if (count($cod) > 0) {
if ($cod[0]->avance != $avance) {
//echo "<br>ACTUALIZA $rut $id_curso, avance lms reportes $avance, avance cierre ".$cod[0]->avance;
//echo "<br>";
if ($avance > 100) {$avance = 100;}
$sql = "UPDATE tbl_inscripcion_cierre  SET avance= '$avance' WHERE  id_empresa='$id_empresa' and rut='$rut' and id_curso='$id_curso'";
$database->setquery($sql);
$database->query();
}

//rectifica mayores a 100

if ($cod[0]->avance > 100) {$avance = 100;
$sql = "UPDATE tbl_inscripcion_cierre  SET avance= '$avance' WHERE  id_empresa='$id_empresa' and rut='$rut' and id_curso='$id_curso'";
$database->setquery($sql);
$database->query();
}
}

return $cod;
}

function LMS_Buscabbddhost($id_programa, $id_empresa) {

{global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select *


from tbl_lms_programas_bbdd
where id_programa='$id_programa' and id_empresa='$id_empresa'
";

//echo $sql;echo "<br><br>";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}
}

function buscaFocodesdePrograma($id_programa, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select codigo_foco from tbl_lms_programas_bbdd where id_empresa='$id_empresa' and id_programa='$id_programa'";

//echo $sql;echo "<br><br>";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Inserta_tbl_lms_reportes_sinempresa(
$rut,
$nombre,
$cargo,
$email,
$c1,
$c2,
$c3,
$id_malla,
$id_clasificacion,
$id_curso,
$avance,
$puntos,
$resultados,
$medallas,
$id_empresa,
$rut_completo,
$id_foco,
$id_programa,
$fecha_inicio,
$fecha_final, $c4,
$curso_opcional
) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($avance > 100) {$avance = 100;}
$resultados = ($resultados);

if ($id_foco == '') {
$resultado_foco = buscaFocodesdePrograma($id_programa, $id_empresa);
$id_foco = $resultado_foco[0]->codigo_foco;
}

if ($curso_opcional == "") {$curso_opcional = 0;}

$sql = "

INSERT INTO

tbl_lms_reportes

(rut, nombre, cargo, email, c1, c2, c3, c4, id_malla, id_clasificacion, id_curso, avance, puntos, resultado, medallas, fecha, hora,
id_empresa, rut_completo, id_foco, id_programa, fecha_inicio, fecha_termino, curso_opcional)
VALUES
('$rut', '$nombre', '$cargo', '$email', '$c1', '$c2', '$c3', '$c4', '$id_malla', '$id_clasificacion', '$id_curso', '$avance', '$puntos', '$resultados', '$medallas', '" . date("Y-m-d") . "', '" . date("H:i:s") . "', '$id_empresa', '$rut_completo',
'$id_foco', '$id_programa', '$fecha_inicio', '$fecha_final','$curso_opcional');";

$database->setquery($sql);
if (!$database->query_error()) {
return $database->errores(mysql_error());
}

//echo "<br>SQL $sql";
//

// Verifica que avance sea igual a cierre
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select avance from tbl_inscripcion_cierre where id_empresa='$id_empresa' and rut='$rut' and id_curso='$id_curso'";
//echo "<br>$sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//echo "<br>".count($cod);
if (count($cod) > 0) {
if ($cod[0]->avance != $avance) {
//echo "<br>ACTUALIZA $rut $id_curso, avance lms reportes $avance, avance cierre ".$cod[0]->avance;
//echo "<br>";
if ($avance > 100) {$avance = 100;}
$sql = "UPDATE tbl_inscripcion_cierre  SET avance= '$avance' WHERE  id_empresa='$id_empresa' and rut='$rut' and id_curso='$id_curso'";
$database->setquery($sql);
$database->query();
}

//rectifica mayores a 100

if ($cod[0]->avance > 100) {$avance = 100;
$sql = "UPDATE tbl_inscripcion_cierre  SET avance= '$avance' WHERE  id_empresa='$id_empresa' and rut='$rut' and id_curso='$id_curso'";
$database->setquery($sql);
$database->query();
}
}

return $cod;
}

function EliminoRegistrosTablaReportes($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "delete FROM tbl_lms_reportes WHERE id_empresa='$id_empresa'";

$database->setquery($sql);
if (!$database->query_error()) {
return $database->errores(mysql_error());
}
}

function Inserta_tbl_lms_reportes_full($fecha,
$id_inscripcion,
$rut,
$rut_completo,
$nombre,
$cargo,
$c4,
$c3,
$c2,
$c1,
$empresa,
$rut_jefe,
$jefe,
$ejecutivo,
$id_foco,
$foco,
$id_programa,
$programa,
$id_curso,
$curso,
$tipo_curso,
$fecha_inicio,
$anno_inicio,
$mes_inicio,
$fecha_termino,
$anno_termino,
$mes_termino,
$status,
$asistencia,
$evaluacion,
$horas,
$lugar,
$curso_opcional,
$puntos

) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "INSERT INTO
tbl_lms_reportes_full
(
fecha,
id_inscripcion,
rut,
rut_completo,
nombre,
cargo,
c4,
c3,
c2,
c1,
empresa,
rut_jefe,
jefe,
ejecutivo,
id_foco,
foco,
id_programa,
programa,
id_curso,
curso,
tipo_curso,
fecha_inicio,
anno_inicio,
mes_inicio,
fecha_termino,
anno_termino,
mes_termino,
status,
asistencia,
evaluacion,
horas,
lugar,
curso_opcional,
puntos

)
VALUES
(

'$fecha',
'$id_inscripcion',
'$rut',
'$rut_completo',
'$nombre',
'$cargo',
'$c4',
'$c3',
'$c2',
'$c1',
'$empresa',
'$rut_jefe',
'$jefe',
'$ejecutivo',
'$id_foco',
'$foco',
'$id_programa',
'$programa',
'$id_curso',
'$curso',
'$tipo_curso',
'$fecha_inicio',
'$anno_inicio',
'$mes_inicio',
'$fecha_termino',
'$anno_termino',
'$mes_termino',
'$status',
'$asistencia',
'$evaluacion',
'$horas',
'$lugar',
'$curso_opcional',
'$puntos'



);";

//echo "<br><br>$sql";
$database->setquery($sql);
if (!$database->query_error()) {
return $database->errores(mysql_error());
}
}

function Inserta_tbl_lms_reportes_acumulada($rut, $nombre, $cargo, $email, $c1, $c2, $c3, $id_malla, $id_clasificacion, $id_curso, $avance, $puntos, $resultados, $medallas, $id_empresa, $rut_completo) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
if ($avance > 100) {$avance = 100;}
//$sql = "INSERT INTO tbl_usuario ($values,vigencia) VALUES ($registros,'0');";
$sql = "INSERT INTO
tbl_lms_reportes_acumulada
(rut, nombre, cargo, email, c1, c2, c3, id_malla, id_clasificacion, id_curso, avance, puntos, resultado, medallas, fecha, hora, id_empresa, rut_completo)
VALUES
('$rut', '$nombre', '$cargo', '$email', '$c1', '$c2', '$c3', '$id_malla', '$id_clasificacion', '$id_curso', '$avance', '$puntos', '$resultados', '$medallas', '" . date("Y-m-d") . "', '" . date("H:i:s") . "', '$id_empresa', '$rut_completo');";

$database->setquery($sql);
if (!$database->query_error()) {
return $database->errores(mysql_error());
}
}

function Inserta_tbl_lms_reportes_acumulada_sinempresa($rut, $nombre, $cargo, $email, $c1, $c2, $c3, $id_malla, $id_clasificacion, $id_curso, $avance, $puntos, $resultados, $medallas, $id_empresa, $rut_completo) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
if ($avance > 100) {$avance = 100;}
//$sql = "INSERT INTO tbl_usuario ($values,vigencia) VALUES ($registros,'0');";
$sql = "INSERT INTO
tbl_lms_reportes_acumulada
(rut, nombre, cargo, email, c1, c2, c3, id_malla, id_clasificacion, id_curso, avance, puntos, resultado, medallas, fecha, hora, id_empresa, rut_completo)
VALUES
('$rut', '$nombre', '$cargo', '$email', '$c1', '$c2', '$c3', '$id_malla', '$id_clasificacion', '$id_curso', '$avance', '$puntos', '$resultados', '$medallas', '" . date("Y-m-d") . "', '" . date("H:i:s") . "', '$id_empresa', '$rut_completo');";

$database->setquery($sql);
if (!$database->query_error()) {
return $database->errores(mysql_error());
}
}

function TraigoRespuestasEncSatisPorRutInsc($id_empresa, $rut, $id_inscripcion) {global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_enc_satis_respuestas where rut='$rut' and id_inscripcion='$id_inscripcion' and id_empresa='$id_empresa'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TraeEnsSatisfinalizadas($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "SELECT
tbl_enc_satis_finalizados.*, tbl_inscripcion_curso.id_curso AS codigo_curso, tbl_usuario.nombre_completo
FROM
tbl_enc_satis_finalizados
INNER JOIN tbl_inscripcion_curso ON tbl_inscripcion_curso.codigo_inscripcion = tbl_enc_satis_finalizados.id_inscripcion
inner join tbl_usuario on tbl_usuario.rut=tbl_enc_satis_finalizados.rut
WHERE
tbl_enc_satis_finalizados.id_empresa = '$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function ActualizaPagoPorInscripcion($id_inscripcion, $valor) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE tbl_inscripcion_curso  SET pago= '$valor'

WHERE codigo_inscripcion='$id_inscripcion'";

$database->setquery($sql);
$database->query();
}

function TraigoUsuarioXObjetos($id_empresa, $campo1, $campo2, $campo3, $arreglo_post) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($arreglo_post["malla"]) {
$filtro_malla = " and rel_lms_malla_persona.id_malla='" . $arreglo_post["malla"] . "'";
}

if ($arreglo_post["curso"]) {
$filtro_curso = " and rel_lms_malla_curso.id_curso='" . $arreglo_post["curso"] . "'";
}
if ($arreglo_post["objetos"]) {
$filtro_objetos = " and tbl_objeto.id='" . $arreglo_post["objetos"] . "'";
}
$sql = "SELECT
tbl_usuario.rut,
tbl_usuario.rut_completo,
tbl_usuario.nombre_completo,
tbl_usuario.cargo,
tbl_usuario.email,


tbl_usuario.$campo1 as campo1_usuario,
tbl_usuario.$campo2 as campo2_usuario,
tbl_usuario.$campo3 as campo3_usuario,


rel_lms_malla_persona.id_malla,
tbl_lms_malla.nombre AS nombre_malla,
rel_lms_malla_curso.id_curso AS id_curso,
tbl_lms_curso.nombre AS nombre_curso,
tbl_objeto.id AS id_objeto,
tbl_objeto.titulo AS nombre_objeto,
tbl_objeto.idmoodle AS id_moodle,
tbl_objeto.id_scorm AS id_scorm,
tbl_objetos_finalizados.fecha AS fecha_finalizacion_modulo,
tbl_objetos_finalizados.nota AS nota_final_modulo
FROM
tbl_usuario
INNER JOIN rel_lms_malla_persona ON rel_lms_malla_persona.rut = tbl_usuario.rut
AND rel_lms_malla_persona.id_empresa = '$id_empresa' $filtro_malla
INNER JOIN tbl_lms_malla ON tbl_lms_malla.id = rel_lms_malla_persona.id_malla
AND tbl_lms_malla.id_empresa = '$id_empresa'
INNER JOIN rel_lms_malla_curso ON rel_lms_malla_curso.id_malla = rel_lms_malla_persona.id_malla $filtro_curso
INNER JOIN tbl_lms_curso ON tbl_lms_curso.id = rel_lms_malla_curso.id_curso
AND tbl_lms_curso.id_empresa = '$id_empresa'
INNER JOIN tbl_objeto ON tbl_objeto.id_curso = rel_lms_malla_curso.id_curso $filtro_objetos
LEFT JOIN tbl_objetos_finalizados ON tbl_objetos_finalizados.id_objeto = tbl_objeto.id
AND tbl_objetos_finalizados.rut = tbl_usuario.rut
AND rel_lms_malla_curso.id_curso = tbl_objetos_finalizados.id_curso
WHERE
tbl_usuario.id_empresa = '$id_empresa'
and abs(tbl_usuario.rut)<>0
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function CursosPorEmpresaV2SoloElearning($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_lms_curso where id_empresa='$id_empresa' and modalidad='3' order by nombre asc ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function CursosPorEmpresaV2($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_lms_curso where id_empresa='$id_empresa' order by nombre asc";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TraeTotalcursosPorEmpresaYClasificacion($id_empresa, $id_clasificacion, $id_malla) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select * from rel_lms_malla_curso

where rel_lms_malla_curso.id_malla='$id_malla' and rel_lms_malla_curso.id_clasificacion='$id_clasificacion' and rel_lms_malla_curso.id_empresa='$id_empresa

'
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function EliminoAlternativasDadoIdPregunta($id_alternativa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "DELETE FROM tbl_evaluaciones_alternativas WHERE id='$id_alternativa'";
$database->setquery($sql);
$database->query();
}

function VerificoSiAlterativaEstEnTmp($id) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT * FROM tbl_evaluaciones_alternativas_tmp WHERE id='$id'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraigoAernativasDadoIdGrupoAlternativaV2($id) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT * FROM tbl_evaluaciones_alternativas WHERE id_grupo_alternativas='$id'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function EliminoPreguntayalternativasDadoIdPregunta($id_pregunta, $id_grupo_alternativas) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "DELETE FROM tbl_evaluaciones_alternativas WHERE id_grupo_alternativas='$id_grupo_alternativas'";
$database->setquery($sql);
$database->query();

$sql = "DELETE FROM tbl_evaluaciones_preguntas WHERE id='$id_pregunta'";
$database->setquery($sql);
$database->query();
}

function VerificoPreguntaEnTablaPReguntasTmp($id) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT * FROM tbl_evaluaciones_preguntas_tmp WHERE id='$id'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function InsertaEvaluacionDesdeAdmin($nombre_evaluacion, $id_empresa, $id_curso, $id_objeto) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

//$sql = "INSERT INTO tbl_usuario ($values,vigencia) VALUES ($registros,'0');";
$sql = "INSERT INTO tbl_evaluaciones (nombre_evaluacion, id_empresa, id_objeto, id_curso) VALUES ('$nombre_evaluacion', '$id_empresa', '$id_curso', '$id_objeto');";

$database->setquery($sql);
if (!$database->query_error()) {
return $database->errores(mysql_error());
}
}

function EliminaProcesoAnual($id_proceso_anual) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "DELETE FROM tbl_sgd_proceso_anual WHERE id = '$id_proceso_anual'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
}

function ActualizaCursoMasivo($valuesUpdate, $id_empresa, $codigo_curso) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE tbl_lms_curso SET $valuesUpdate     WHERE id= '$codigo_curso' AND id_empresa='$id_empresa'";
$database->setquery($sql);
if (!$database->query_error()) {
return $database->errores(mysql_error());
}
}

function TotalCursosParaPaginacion2PorParticipantes($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$filtro = "";

$sql = "SELECT
tbl_usuario.rut,     tbl_usuario.nombre_completo, tbl_lms_curso.*, tbl_modalidad_curso.modalidad AS nombre_modalidad

FROM
tbl_lms_curso
LEFT JOIN tbl_modalidad_curso ON tbl_lms_curso.modalidad = tbl_modalidad_curso.id
LEFT JOIN tbl_otec ON tbl_otec.rut = tbl_lms_curso.rut_otec
inner join tbl_CI_participantes
on tbl_CI_participantes.id_curso=tbl_lms_curso.id and tbl_CI_participantes.id_empresa=tbl_lms_curso.id_empresa

inner join tbl_usuario
on tbl_CI_participantes.rut=tbl_usuario.rut
WHERE
tbl_lms_curso.activo = 0
AND tbl_lms_curso.id_empresa = '$id_empresa'
ORDER BY
tbl_lms_curso.id ASC";

//echo $sql;exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function EliminaProcesoEval($id_proceso) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "DELETE FROM tbl_sgd_proceso_evaluacion WHERE id_proceso = '$id_proceso'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
}

function ActualizaDatosProcesoAnual($id, $nombre, $descripcion, $fecha_inicio, $fecha_termino) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE tbl_sgd_proceso_anual  SET nombre_proceso= '$nombre', descripcion='$descripcion', fecha_inicio='$fecha_inicio', fecha_termino='$fecha_termino'

WHERE id='$id'";

$database->setquery($sql);
$database->query();
}

function ActualizaDatosProcesoEvaluacion($id, $nombre, $descripcion, $fecha_inicio, $fecha_termino) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE tbl_sgd_proceso_evaluacion  SET descripcion_proceso= '$nombre', descripcion='$descripcion', fecha_inicio='$fecha_inicio', fecha_termino='$fecha_termino'

WHERE id_proceso='$id'";
$database->setquery($sql);
$database->query();
}

function InsertaCursosMasivo($values, $registros) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

//$sql = "INSERT INTO tbl_usuario ($values,vigencia) VALUES ($registros,'0');";
$sql = "INSERT INTO tbl_lms_curso ($values) VALUES ($registros);";

$database->setquery($sql);
if (!$database->query_error()) {
return $database->errores(mysql_error());
}
}

function TraeTotalcursosTemporal($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT * FROM tbl_lms_curso_temporal WHERE id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function buscarRegistroNombreCampoParaCursos($idEmpresa, $campoVisual) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_empresa_subida_cursos where id_empresa = $idEmpresa and nombrecampoamostrar = '$campoVisual'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function InsertaCursoTemporal($values, $registros, $id_empresa, $accion) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "INSERT INTO tbl_lms_curso_temporal ($values,id_empresa,accion) VALUES ($registros,'$id_empresa','$accion');";
$database->setquery($sql);

if (!$database->query_error()) {
return $database->errores(mysql_error());
}
}

function buscarRegistroNombreCampoTablaCursoTemporal($idEmpresa, $campoVisual) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_lms_curso_temporal where id_empresa = $idEmpresa and nombrecampoamostrar = '$campoVisual'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function CancelaProcesamientoPrevioCursos($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "DELETE FROM tbl_lms_curso_temporal WHERE id_empresa = '$id_empresa'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
}

function TraeCursosPorEmpresaParaSubidaMasiva($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT *
FROM
tbl_lms_curso
WHERE
id_empresa = '$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function listarEmpresaSubidaCursos($idEmpresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_empresa_subida_cursos where id_empresa = $idEmpresa order by id ASC"; //echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function consultaEmpresaSubidaCursos($idEmpresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select count(*) as total from tbl_empresa_subida_cursos where id_empresa = $idEmpresa";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ActualizaDescripcionImagenConId($id, $descripcion) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE tbl_galeria_archivos  SET descripcion= '$descripcion'

WHERE id='$id'";
$database->setquery($sql);
$database->query();
}

function ActualizaCampoOrdenPorIdNoticia($id_noticia, $orden) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE tbl_noticias  SET orden= '$orden'

WHERE id='$id_noticia'";
$database->setquery($sql);
$database->query();
}

function TodasLasNoticiasPublicadasSinSlider($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_noticias where id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function InsertaEtapaPorProcesoChilquinta($etapa, $id_proceso, $id_empresa, $orden, $etiqueta_icono, $etiqueta_semaforo, $muestra_reportes_admin) {

global $c_host, $c_user, $c_pass, $c_db;
$etapa = utf8_decode($etapa);
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "INSERT INTO tbl_sgd_proceso_etapa(etapa, id_proceso, id_empresa, orden, etiqueta_icono, etiqueta_semaforo, muestra_reportes_admin)
VALUES ('$etapa', '$id_proceso', '$id_empresa', '$orden', '$etiqueta_icono', '$etiqueta_semaforo', '$muestra_reportes_admin');";

$database->setquery($sql);
$database->query();
}

function ActualizaRelacionSGDPorEvaluadoProcesoSubperfil($evaluado, $evaluador, $calibrador, $id_proceso, $perfil, $subperfil, $comentario, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE tbl_sgd_relaciones SET evaluador= '$evaluador', calibrador='$calibrador', perfil_evaluacion_competencias='$perfil', comentario='$comentario'
WHERE evaluado = '$evaluado' and id_proceso='$id_proceso' and subperfil='$subperfil'";
$database->setquery($sql);
$database->query();
}

function VerificaRelEvaluadoProcesoSubperfil($evaluado, $id_proceso, $subperfil) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_sgd_relaciones where evaluado='$evaluado' and id_proceso='$id_proceso' and subperfil='$subperfil'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function VerificaEmpresaHoldingPorEmpresa($empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_empresa_holding where rut='$empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function VerificaProcesoAnualPorEmpresa($ano, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_sgd_proceso_anual where ano='$ano' and id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function InsertaNuevaClaveDinamicoCambio($rut, $clave, $id_empresa, $cambiada) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

//$sql = "INSERT INTO tbl_clave(rut, clave, id_empresa, cambiado) VALUES ('$rut', '$clave', '$id_empresa', '$cambiada');";

$database->setquery($sql);
$database->query();
}

function DatosInscripcionConMasInfoV2($id_inscripcion, $rut_empresa_holding) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($rut_empresa_holding) {
$filtro_empresa = " and tbl_inscripcion_usuarios.empresa='$rut_empresa_holding'";
} else {
$filtro_empresa = "";
}
$sql = "

select
tbl_inscripcion_curso.*,
tbl_lms_curso.numero_horas,
tbl_lms_curso.valor_hora as valor_h,
tbl_lms_curso.objetivo_curso,
tbl_lms_curso.nombre as nombre_curso,
tbl_lms_curso.valor_hora_sence as valor_hs,
tbl_lms_curso.fecha_inicio as fecha_inicio_curso,
tbl_lms_curso.fecha_finalizacion as fecha_termino_curso,
tbl_lms_curso.valor_hora_sence,
(select count(*) from tbl_inscripcion_usuarios where tbl_inscripcion_usuarios.id_inscripcion=tbl_inscripcion_curso.id $filtro_empresa) as total_inscritos

from tbl_inscripcion_curso
inner join tbl_lms_curso
on tbl_lms_curso.id=tbl_inscripcion_curso.id_curso
where tbl_inscripcion_curso.codigo_inscripcion='$id_inscripcion'

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeIncripcionEmpresaExcelV2($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT
tbl_inscripcion_curso.id_curso,
tbl_inscripcion_curso.codigo_inscripcion,
tbl_lms_curso.nombre,
tbl_lms_curso.descripcion,
tbl_lms_curso.objetivo_curso,
tbl_lms_curso.modalidad,
tbl_lms_curso.tipo,
tbl_lms_curso.cbc,
tbl_lms_curso.sence,
tbl_lms_curso.cantidad_maxima_participantes,
tbl_lms_curso.valor_hora_sence,
tbl_lms_curso.numero_horas,
tbl_lms_curso.nombre_otec,
tbl_inscripcion_curso.abierto_cerrado,
tbl_inscripcion_curso.direccion,
tbl_inscripcion_curso.comuna,
tbl_inscripcion_curso.ciudad,
tbl_inscripcion_curso.comentarios,
tbl_lms_clasificacion.clasificacion,
tbl_inscripcion_curso.fecha_inicio,
tbl_inscripcion_curso.fecha_termino
FROM
tbl_inscripcion_curso
INNER JOIN tbl_lms_curso ON tbl_lms_curso.id = tbl_inscripcion_curso.id_curso
INNER JOIN tbl_lms_clasificacion ON tbl_lms_clasificacion.id_clasificacion = tbl_lms_curso.clasificacion
WHERE
tbl_inscripcion_curso.id_empresa = '$id_empresa'
ORDER BY
tbl_inscripcion_curso.codigo_inscripcion";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeObjetosDadoCursoEmpresa($id_curso, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT
tbl_tipo_objeto.nombre,

tbl_objeto.*,
(select count(id) from tbl_evaluaciones_preguntas where evaluacion=tbl_objeto.id_evaluacion) as numpreg,
(select count(id) from tbl_evaluaciones_preguntas where evaluacion=tbl_objeto.id_evaluacion and pregunta<>'') as numpregValidas


FROM
tbl_objeto

left join tbl_tipo_objeto
on tbl_tipo_objeto.id=tbl_objeto.tipo_objeto
WHERE
id_curso = '$id_curso'
AND id_empresa = '$id_empresa'
order by orden
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeMallasPorProgramaEmpresaRut($id_empresa, $id_programa, $rut) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$queryrut = "";
if ($rut != '') {
$queryrut = " and (select id_malla from rel_lms_malla_persona where rut='$rut' and id_malla=h.id_malla and rel_lms_malla_persona.id_empresa=h.id_empresa)=h.id_malla";
}

$sql = "select h.*,(select nombre from tbl_lms_malla where id=h.id_malla) as nombre_malla from rel_lms_malla_curso h where h.id_programa='$id_programa' and h.id_empresa='$id_empresa'
$queryrut
group by h.id_malla
order by (select nombre from tbl_lms_malla where id=h.id_malla) ";

//echo "<br>$sql<br>";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeMallasPorProgramaEmpresaRutSinVacios($id_empresa, $id_programa, $rut) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$queryrut = "";
if ($rut != '') {
$queryrut = " and (select id_malla from rel_lms_malla_persona where rut='$rut' and id_malla=h.id_malla and
rel_lms_malla_persona.id_empresa=h.id_empresa)=h.id_malla";
}

$sql = "select h.*,(select nombre from tbl_lms_malla where id=h.id_malla) as nombre_malla

from rel_lms_malla_curso h
where h.id_programa='$id_programa' and h.id_empresa='$id_empresa'

$queryrut

and h.id_curso<>'' and h.id_clasificacion<>''
group by h.id_malla

order by (select nombre from tbl_lms_malla where id=h.id_malla)";

//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeMallasPorProgramaT($id_empresa, $rut, $id_curso) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$queryrut = "";
if ($rut != '') {
$queryrut = " and (select id_malla from rel_lms_malla_persona where rut='$rut' and id_malla=h.id_malla and
rel_lms_malla_persona.id_empresa=h.id_empresa)=h.id_malla";
}

$sql = "select h.*,(select nombre from tbl_lms_malla where id=h.id_malla limit 1) as nombre_malla

from rel_lms_malla_curso h
where  h.id_empresa='$id_empresa' and id_curso='$id_curso'

$queryrut

and h.id_curso<>''
group by h.id_malla

order by (select nombre from tbl_lms_malla where id=h.id_malla limit 1) limit 1";

//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeMallasPorProgramaEmpresa($id_empresa, $id_programa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.*,(select nombre from tbl_lms_malla where id=h.id_malla) as nombre_malla from rel_lms_malla_curso h where h.id_programa='$id_programa' and h.id_empresa='$id_empresa'
group by h.id_malla
order by (select nombre from tbl_lms_malla where id=h.id_malla) ";

//    echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeMallasPorEmpresa($id_empresa, $id_malla) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$filtro_malla = "";
if ($id_malla) {
$filtro_malla = " and tbl_lms_malla.id='$id_malla'";
}

$sql = "select * from tbl_lms_malla where id_empresa='$id_empresa' $filtro_malla  ORDER BY orden DESC;";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ActualizaIdMoodleDeTablaUsuario($rut, $id_moodle) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE tbl_usuario SET userid_moodle= '$id_moodle' WHERE rut = '$rut'";
$database->setquery($sql);
$database->query();
}

function ActualizaTramoSencePorInscripcion($rut, $tramo_sence, $id_inscripcion) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE tbl_inscripcion_usuarios SET tramo_sence='$tramo_sence'

WHERE rut = '$rut' and id_inscripcion='$id_inscripcion'";
$database->setquery($sql);
$database->query();
}

function ActualizaTramoSence($rut, $tramo_sence) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE tbl_usuario SET tramo_sence='$tramo_sence'

WHERE rut = '$rut'";
$database->setquery($sql);
$database->query();
}

function InsertaRelacionMallaPersona($rut, $id_empresa, $id_malla) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "INSERT INTO rel_lms_malla_persona
(id_malla, rut, id_empresa)
VALUES ('$id_malla', '$rut', '$id_empresa');";

$database->setquery($sql);

if (!$database->query_error()) {
return $database->errores(mysql_error());
}
}

function ActualizaMallaRelacionMallaPersona($id_empresa, $rut, $nueva_id_malla) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "UPDATE rel_lms_malla_persona SET id_malla= '$nueva_id_malla' WHERE id_empresa = '$id_empresa' and rut='$rut'";
$database->setquery($sql);
$database->query();
}

function Busca_Usuario_EnTablaRelMallaPersona($rut, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT * FROM rel_lms_malla_persona WHERE rut='$rut' AND id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod[0]->id;
}

function ActualizanActivaPorProcesoAnual($id_proceso_anual, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "UPDATE tbl_sgd_proceso_anual SET desactivado= '0' WHERE id_empresa = '$id_empresa' and id='$id_proceso_anual'";
$database->setquery($sql);
$database->query();
}

function ActualizanDesactivadoPorProcesoAnual($id_proceso_anual, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "UPDATE tbl_sgd_proceso_anual SET desactivado= '1' WHERE id_empresa = '$id_empresa' and id='$id_proceso_anual'";
$database->setquery($sql);
$database->query();
}

function ProcesosAnualesPorEmpresa($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT  * FROM tbl_sgd_proceso_anual where id_empresa='$id_empresa'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function EliminaNoticiaDeSlider($id) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "update tbl_noticias set slider_activo='0' where id='$id'";
$database->setquery($sql);
$database->query();
}

function DatosProcesoAnualPorIdAnual($id) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT  * FROM tbl_sgd_proceso_anual where id='$id'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeUltimoIdProcesoPorEmpresa($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT MAX(id) as ultimo_id FROM tbl_sgd_proceso_evaluacion where id_empresa='$id_empresa'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function VerificoFeedbackSGD($evaluado, $evaluador, $id_proceso) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_sgd_feedback_evaluado    where evaluado='$evaluado' and evaluador='$evaluador' and id_proceso='$id_proceso'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function VerificoCalibradoSGD($evaluado, $evaluador, $id_proceso) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_calibracion_liberados    where evaluado='$evaluado' and evaluador='$evaluador' and id_proceso='$id_proceso'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function totalRelacionesDadoCriterioCruceFinalizados($id_empresa, $id_proceso, $campo1, $campo2, $campo3, $valor_campo1, $valor_campo2, $valor_campo3) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
if ($valor_campo1) {
$filtro_campo1 = " and $campo1='" . $valor_campo1 . "'";
}

if ($valor_campo2) {
$filtro_campo2 = " and $campo2='" . $valor_campo2 . "'";
}

if ($valor_campo3) {
$filtro_campo3 = " and $campo3='" . $valor_campo3 . "'";
}

$sql = " SELECT
count(*)AS total
FROM
tbl_sgd_relaciones
inner join tbl_usuario
on tbl_usuario.rut=tbl_sgd_relaciones.evaluado

inner join tbl_sgd_finalizados_evaluado_evaluador
on tbl_sgd_finalizados_evaluado_evaluador.evaluado=tbl_sgd_relaciones.evaluado and
tbl_sgd_finalizados_evaluado_evaluador.evaluador=tbl_sgd_relaciones.evaluador and
tbl_sgd_finalizados_evaluado_evaluador.id_proceso=tbl_sgd_relaciones.id_proceso

WHERE
tbl_sgd_relaciones.id_proceso = '$id_proceso'
AND tbl_sgd_relaciones.id_empresa = '$id_empresa'
and tbl_sgd_relaciones.evaluado<>tbl_sgd_relaciones.evaluador
$filtro_campo1
$filtro_campo2
$filtro_campo3



";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeRespuestasPorPreguntaConcurso($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select tbl_concurso_respuesta.*, tbl_usuario.nombre_completo, tbl_concurso_pregunta.pregunta
FROM
tbl_concurso_respuesta
INNER JOIN tbl_concurso_pregunta ON tbl_concurso_pregunta.id = tbl_concurso_respuesta.id_pregunta
INNER JOIN tbl_usuario ON tbl_usuario.rut = tbl_concurso_respuesta.rut
where tbl_concurso_pregunta.id_empresa='$id_empresa'
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TotalComentariosPorEmpresa($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select tbl_noticias_comentarios.*
from tbl_noticias_comentarios

";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraigoBibliotecasPorEmpresa($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select
tbl_biblio_categorias.*
from tbl_biblio_categorias
where tbl_biblio_categorias.id_empresa='$id_empresa' and id_categoria<>'0'
order by categoria asc
";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraigoAlbunesPorEmpresa($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select
tbl_galeria.*
from tbl_galeria
where tbl_galeria.id_empresa='$id_empresa' and id_categoria<>'0'
order by categoria asc
";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ActualizoContenidosPagina($id, $contenido) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "update tbl_paginas_templates set contenido='$contenido' where id='$id'";
$database->setquery($sql);
$database->query();
}

function TraigoTotalPaginasPorEmpresaDetalle($id) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select
tbl_paginas_templates.*
from tbl_paginas_templates


where tbl_paginas_templates.id='$id'

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraigoTotalPaginasPorEmpresa($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select
tbl_paginas_templates.*
from tbl_paginas_templates


where tbl_paginas_templates.id_empresa='$id_empresa'

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DatosEmpresaCampos($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select campo1, campo2, campo3
from tbl_empresa
where id='$id_empresa'
";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function FotosPorObjetoDesdeAdmin($id_objeto, $id_empresa) {
$datos_empresa = DatosEmpresa($id_empresa);

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select
tbl_galeria_archivos.*,
tbl_usuario.nombre_completo,
(select count(*) as total from tbl_megusta_registro where tbl_galeria_archivos.id=tbl_megusta_registro.id_imagen_galeria) as total_megusta
from tbl_galeria_archivos
inner join tbl_usuario
on tbl_usuario.rut=tbl_galeria_archivos.rut_autor
where tbl_galeria_archivos.id_objeto='$id_objeto'
and tbl_galeria_archivos.id_empresa='$id_empresa'
and tbl_galeria_archivos.estado is null
ORDER BY
total_megusta DESC
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function totalRelacionesDadoCriterio($id_proceso, $id_empresa, $campo1, $campo2, $campo3, $valor_campo1, $valor_campo2, $valor_campo3) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
if ($valor_campo1) {
$filtro_campo1 = " and $campo1='" . $valor_campo1 . "'";
}

if ($valor_campo2) {
$filtro_campo2 = " and $campo2='" . $valor_campo2 . "'";
}

if ($valor_campo3) {
$filtro_campo3 = " and $campo3='" . $valor_campo3 . "'";
}

$sql = " SELECT
count(*)AS total
FROM
tbl_sgd_relaciones
inner join tbl_usuario
on tbl_usuario.rut=tbl_sgd_relaciones.evaluado
WHERE
tbl_sgd_relaciones.id_proceso = '1'
AND tbl_sgd_relaciones.id_empresa = '28'
and tbl_sgd_relaciones.evaluado<>tbl_sgd_relaciones.evaluador
$filtro_campo1
$filtro_campo2
$filtro_campo3



";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function EliminaBloqueTips($id) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "DELETE FROM tbl_sgd_home_tips WHERE id= '$id'";
$database->setquery($sql);
$database->query();
}

function InsertaTextoTips($id_empresa, $texto) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "INSERT INTO tbl_sgd_home_tips
(id_empresa, texto)
VALUES ('$id_empresa', '$texto');";

$database->setquery($sql);

if (!$database->query_error()) {
return $database->errores(mysql_error());
}
}

function EliminaBloqueImportante($id) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "DELETE FROM tbl_sgd_home_importante WHERE id= '$id'";
$database->setquery($sql);
$database->query();
}

function InsertaTextoImportante($id_empresa, $texto) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "INSERT INTO tbl_sgd_home_importante
(id_empresa, texto)
VALUES ('$id_empresa', '$texto');";

$database->setquery($sql);

if (!$database->query_error()) {
return $database->errores(mysql_error());
}
}

function ActualizarDatosHomeSGD($id_empresa, $titulo, $introduccion, $competencias_transversales, $competencias_liderazgo) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "UPDATE tbl_sgd_home_contenidos SET titulo= '$titulo', introduccion='$introduccion', competencias_transversales='$competencias_transversales', competencias_liderazgo='$competencias_liderazgo' WHERE id_empresa = '$id_empresa'";
$database->setquery($sql);
$database->query();
}

function ActualizoProcesoAnualActivo($id_proceso_anual, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "UPDATE tbl_sgd_proceso_anual SET activo= '0' WHERE id_empresa = '$id_empresa'";
$database->setquery($sql);
$database->query();

$sql = "UPDATE tbl_sgd_proceso_anual SET activo= '1' WHERE id_empresa = '$id_empresa' and id='$id_proceso_anual'";
$database->setquery($sql);
$database->query();
}

function InsertaRelacionSGD($evaluado, $evaluador, $calibrador, $id_proceso, $perfil, $subperfil, $comentario, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "INSERT INTO tbl_sgd_relaciones
(evaluado, evaluador, calibrador, perfil_evaluacion_competencias, subperfil, id_proceso, comentario, id_empresa)
VALUES ('$evaluado', '$evaluador', '$calibrador', '$perfil', '$subperfil', '$id_proceso', '$comentario', '$id_empresa');";

$database->setquery($sql);

if (!$database->query_error()) {
return $database->errores(mysql_error());
}
}

function CriteriosParaTablaResumenReporteAvance2Campo3($id_empresa, $campo3, $campo1, $valor_campo1, $campo2, $valor_campo2) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = " select distinct($campo3) as valor
from tbl_usuario
where id_empresa='$id_empresa' and
$campo1='$valor_campo1' and
$campo2='$valor_campo2'

";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function CriteriosParaTablaResumenReporteAvance2Campo2($id_empresa, $campo2, $campo1, $valor_campo1, $arreglo_post) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
if ($arreglo_post["filtro2"] != '0' and $arreglo_post["filtro2"] != '') {
$filtro_campo2 = " and $campo2='" . $arreglo_post["filtro2"] . "'";
}

$sql = " select distinct($campo2) as valor
from tbl_usuario
where id_empresa='$id_empresa' and
$campo1='$valor_campo1'
$filtro_campo2

";
//echo $sql;Exit;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeTotalBitacorasPorEmpresa($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$Campos = TraeCampos($id_empresa);
$Campos1 = $Campos[0]->campo1;
$Campos2 = $Campos[0]->campo2;
$Campos3 = $Campos[0]->campo3;

$sql = "SELECT
tbl_sgd_componente.nombre as nombre_valor,
baseevaluado.nombre_completo AS nombre_evaluado,
baseevaluado.cargo as cargo_evaluado,
baseevaluado.$Campos1 as campo1_evaluado,
baseevaluado.$Campos2 as campo2_evaluado,
baseevaluado.$Campos3 as campo3_evaluado,


basefijador.nombre_completo AS nombre_fijador,
basefijador.cargo AS cargo_fijador,

basefijador.$Campos1 AS campo1_fijador,
basefijador.$Campos2 AS campo2_fijador,
basefijador.$Campos3 AS campo3_fijador,


tbl_bitacora_textos.*
FROM
tbl_bitacora_textos
INNER JOIN tbl_usuario AS baseevaluado ON baseevaluado.rut = tbl_bitacora_textos.evaluado
INNER JOIN tbl_usuario AS basefijador ON basefijador.rut = tbl_bitacora_textos.creador

left join tbl_sgd_componente
on tbl_sgd_componente.id=tbl_bitacora_textos.valor


WHERE
tbl_bitacora_textos.id_empresa = '$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TotalPreviaCierreMasivoPorEmpresa($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select tbl_inscripcion_cierre_temp.*, nombre_completo
from tbl_inscripcion_cierre_temp
left join tbl_usuario
on tbl_usuario.rut=tbl_inscripcion_cierre_temp.rut
where  tbl_inscripcion_cierre_temp.id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

//    echo "sql $sql";
return $cod;
}

function InsertaDatosTablaTemporalCierreCapacitaciones($rut, $id_curso, $nota, $porcentaje_asistencia,
$estado, $comentario, $fecha_inicio, $fecha_termino, $ubicacion, $region, $lugar_ejecucion, $rut_jefe,
$nombre_jefe, $rut_entrenador, $nombre_entrenador, $observaciones, $accion, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$porcionidcurso = $id_curso;
$Arrayid_curso = explode(".", $porcionidcurso);
$id_curso = $Arrayid_curso[0];
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($estado == "APROBADO" or $estado == "Aprobado" or $estado == "aprobado") {
$avance = 100;
$estado = 1;
} else {
$avance = 0;
$estado = 0;
}

$puntos = round($porcentaje_asistencia * $nota / 100);

if ($accion == "Inserta") {
// INSERTA
$sql = "INSERT INTO tbl_inscripcion_cierre_temp(
rut, id_curso, nota, porcentaje_asistencia, estado, comentario,
fecha_inicio, fecha_termino, ubicacion, region, lugar_ejecucion, jefatura,
nombre_jefatura,rut_entrenador, entrenador, observaciones,  id_empresa, avance, accion )
VALUES ('$rut', '$id_curso', '$nota', '$porcentaje_asistencia',
'$estado', '$comentario', '$fecha_inicio', '$fecha_termino', '$ubicacion', '$region',
'$lugar_ejecucion', '$rut_jefe',
'$nombre_jefe', '$rut_entrenador', '$nombre_entrenador', '$observaciones', '$id_empresa', '$avance', '$accion');";

$database->setquery($sql);
$database->query();

//echo "<br>sql 462 $sql";

//    $sql = "INSERT INTO tbl_gamificado_puntos  (rut,id_curso,id_empresa,fecha,puntos) values    ('$rut', '$id_curso', '$id_empresa', '$fecha_termino','$puntos');";
//    $database->setquery($sql);
//    $database->query();

//echo "<br>sql 468 $sql";
}
// ACTUALIZA

// borra actual y luego inserta
if ($accion == "Actualiza") {
$sql_borra = "delete from tbl_inscripcion_cierre where rut='$rut' and id_empresa='$id_empresa' and id_curso='$id_curso'";
$database->setquery($sql_borra);
$database->query();

$sql = "INSERT INTO tbl_inscripcion_cierre_temp(
rut, id_curso, nota, porcentaje_asistencia, estado, comentario,
fecha_inicio, fecha_termino, ubicacion, region, lugar_ejecucion, jefatura,
nombre_jefatura,rut_entrenador, entrenador, observaciones,  id_empresa, avance, accion )

VALUES

('$rut', '$id_curso', '$nota', '$porcentaje_asistencia',
'$estado', '$comentario', '$fecha_inicio', '$fecha_termino', '$ubicacion', '$region',
'$lugar_ejecucion', '$rut_jefe',
'$nombre_jefe', '$rut_entrenador', '$nombre_entrenador', '$observaciones',  '$id_empresa',
'$avance', '$accion');";

$database->setquery($sql);
$database->query();
//echo "<br>sql  494 $sql_borra";

//echo "<br>sql 496 $sql";

//$sql = "DELETE tbl_gamificado_puntos  rut='$rut' and id_empresa='$id_empresa' and id_curso='$id_curso'";
//$database->setquery($sql);
//$database->query();

//echo "<br>sql 502 $sql";

//$sql = "INSERT INTO tbl_gamificado_puntos  (rut,id_curso,id_empresa,fecha,puntos) values    ('$rut', '$id_curso', '$id_empresa', '$fecha_termino','$puntos');";
//$database->setquery($sql);
//$database->query();

//echo "<br>sql 508 $sql";
}
//EXIT();
}

function InsertaDatosTablaFinalCierreCapacitaciones($rut, $id_curso, $nota, $porcentaje_asistencia,
$estado, $comentario, $fecha_inicio, $fecha_termino, $ubicacion, $region, $lugar_ejecucion, $rut_jefe,
$nombre_jefe, $rut_entrenador, $nombre_entrenador, $observaciones, $accion, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$porcionidcurso = $id_curso;
$Arrayid_curso = explode(".", $porcionidcurso);
$id_curso = $Arrayid_curso[0];
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

//LEE TEMPORAL

// ESCRIBE

if ($estado == "1") {
$avance = 100;
$estado = 1;
} else {
$avance = 0;
$estado = 0;
}

if ($porcentaje_asistencia != '' and $nota != '') {
$puntos = round($porcentaje_asistencia * $nota / 100);
}

if ($porcentaje_asistencia != '' and $nota == '') {
$puntos = round($porcentaje_asistencia);
}

if ($porcentaje_asistencia == '' and $nota != '') {
$puntos = round($nota);
}

if ($accion == "Inserta") {
// INSERTA
$sql = "INSERT INTO tbl_inscripcion_cierre(
rut, id_curso, nota, porcentaje_asistencia, estado, comentario,
fecha_inicio, fecha_termino, ubicacion, region, lugar_ejecucion, jefatura,
nombre_jefatura,rut_entrenador, entrenador, observaciones,  id_empresa, avance )
VALUES ('$rut', '$id_curso', '$nota', '$porcentaje_asistencia',
'$estado', '$comentario', '$fecha_inicio', '$fecha_termino', '$ubicacion', '$region',
'$lugar_ejecucion', '$rut_jefe',
'$nombre_jefe', '$rut_entrenador', '$nombre_entrenador', '$observaciones', '$id_empresa', '$avance');";

$database->setquery($sql);
$database->query();

//echo "<br>sql 462 $sql";

$sql = "INSERT INTO tbl_gamificado_puntos  (rut,id_curso,id_empresa,fecha,puntos) values    ('$rut', '$id_curso', '$id_empresa', '$fecha_termino','$puntos');";
$database->setquery($sql);
$database->query();

//echo "<br>sql 468 $sql";
//
}
// ACTUALIZA

// borra actual y luego inserta
if ($accion == "Actualiza") {
$sql_borra = "delete from tbl_inscripcion_cierre where rut='$rut' and id_empresa='$id_empresa' and id_curso='$id_curso'";
$database->setquery($sql_borra);
$database->query();

$sql = "INSERT INTO tbl_inscripcion_cierre(
rut, id_curso, nota, porcentaje_asistencia, estado, comentario,
fecha_inicio, fecha_termino, ubicacion, region, lugar_ejecucion, jefatura,
nombre_jefatura,rut_entrenador, entrenador, observaciones,  id_empresa, avance )

VALUES

('$rut', '$id_curso', '$nota', '$porcentaje_asistencia',
'$estado', '$comentario', '$fecha_inicio', '$fecha_termino', '$ubicacion', '$region',
'$lugar_ejecucion', '$rut_jefe',
'$nombre_jefe', '$rut_entrenador', '$nombre_entrenador', '$observaciones',  '$id_empresa',
'$avance');";

$database->setquery($sql);
$database->query();
//echo "<br>sql  494 $sql_borra";

//echo "<br>sql 496 $sql";

$sql = "DELETE tbl_gamificado_puntos  rut='$rut' and id_empresa='$id_empresa' and id_curso='$id_curso'";
$database->setquery($sql);
$database->query();
// echo "<br>sql 502 $sql";

$sql = "INSERT INTO tbl_gamificado_puntos  (rut,id_curso,id_empresa,fecha,puntos) values    ('$rut', '$id_curso', '$id_empresa', '$fecha_termino','$puntos');";
$database->setquery($sql);
$database->query();

//echo "<br>sql 508 $sql";
}
//EXIT();
}

function VerificaCursoEstaEnCierrePorEmpresaImparticion($id_curso, $rut, $id_empresa, $id_imparticion) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_inscripcion_cierre where
id_curso='$id_curso' and rut='$rut' and id_empresa='$id_empresa'
and id_inscripcion='$id_imparticion'";

//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function VerificaCursoEstaEnCierrePorEmpresa($id_curso, $rut, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_inscripcion_cierre where  id_curso='$id_curso' and rut='$rut' and id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}



function DatosTablaUsuarioPorEmpresaV2($rut, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_usuario where rut='$rut' and id_empresa='$id_empresa'";
//echo $sql;
//echo "<br>";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function CancelaProcesamientoPrevioInscripcionCierre($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "DELETE FROM tbl_inscripcion_cierre_temp WHERE id_empresa = '$id_empresa'";
$database->setquery($sql);
$database->query();
}

function TotalCierresInscripcionesPorEmpresa($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_inscripcion_cierre where  id_empresa='$id_empresa'            ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ActualizoSliderActivo($id_noticia, $numero_slider) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE tbl_noticias SET slider_activo= '$numero_slider' WHERE id = '$id_noticia'";
$database->setquery($sql);
$database->query();
}

//MEJORES PRACTICAS

function mp_busca_Categorias_data($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_mp_categorias where id_empresa = '$id_empresa'";
//echo "hola $sql";
$database->setquery($sql);
$database->query();

$cod = $database->listObjects();

return $cod;
}

function DatosMedicionAdmin($idMed) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_enc_elearning_medicion where id = '$idMed' order by id DESC";
//echo "hola $sql";
$database->setquery($sql);
$database->query();

$cod = $database->listObjects();

return $cod;
}


function DatosMedicionAdminUsers($idMed, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.*,

(select nombre from tbl_enc_elearning where id=h.id_encuesta) as bancopreguntas,
(select count(id) from tbl_nomina_encuesta where id_encuesta=h.id_encuesta) as usuarios,
(select count(id) from tbl_nomina_encuesta_editor where id_encuesta=h.id_encuesta and perfil='editor') as editores,
(select count(id) from tbl_nomina_encuesta_editor where id_encuesta=h.id_encuesta and perfil='visualizador') as visualizadores

from tbl_enc_elearning_medicion h

where h.id_empresa='$id_empresa' and id='$idMed'";

$database->setquery($sql);
$database->query();

$cod = $database->listObjects();

return $cod;
}

function DatosClusterAdminUsers($idCluster, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.*,

(select count(id) from rel_encuestas_cluster_usuarios) as usuarios

from tbl_encuestas_cluster h

where h.id_empresa='$id_empresa' and id='$idCluster'";

$database->setquery($sql);
$database->query();

$cod = $database->listObjects();

return $cod;
}


function MedicionListaBancoPreguntas_data($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_enc_elearning where id_empresa = '$id_empresa' order by id DESC";
//echo "hola $sql";
$database->setquery($sql);
$database->query();

$cod = $database->listObjects();

return $cod;
}

function mp_busca_Estados_data($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_mp_estados where id_empresa = '$id_empresa'";
$database->setquery($sql);
$database->query();

$cod = $database->listObjects();

return $cod;
}

function mp_actualiza_estado($id_mp, $id_estado, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE tbl_mp SET id_estado= '$id_estado' WHERE id_mp = '$id_mp' and id_empresa='$id_empresa'";
$database->setquery($sql);
$database->query();
}

function TraeMejoresPracticasPorEmpresa($idproceso, $id_empresa, $id_mp) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($id_mp == "") {$queryMp = " ";} else { $queryMp = " and id_mp='$id_mp' ";}

$sql = "SELECT
h.*, (
SELECT
nombre_completo
FROM
tbl_usuario
WHERE
rut = h.rut
) AS nombreautor,
(
SELECT
gerencia
FROM
tbl_usuario
WHERE
rut = h.rut
) AS gerenciaautor,
(
SELECT
unidad_negocio
FROM
tbl_usuario
WHERE
rut = h.rut
) AS areaautor,
(
SELECT
cargo
FROM
tbl_usuario
WHERE
rut = h.rut
) AS cargoautor,
(
SELECT
categoria
FROM
tbl_mp_categorias
WHERE
id_categoria = h.id_categoria
) AS nombrecategoria,
(
SELECT
icono
FROM
tbl_mp_categorias
WHERE
id_categoria = h.id_categoria
) AS iconocategoria,
(
SELECT
style
FROM
tbl_mp_categorias
WHERE
id_categoria = h.id_categoria
) AS style,
(
SELECT
estado
FROM
tbl_mp_estados
WHERE
id_estado = h.id_estado
) AS nombreestado,
(
SELECT
estilo
FROM
tbl_mp_estados
WHERE
id_estado = h.id_estado
) AS nombreestiloestado
,


(
SELECT
count(id)
FROM
tbl_mp_interacciones
WHERE
id_mp = h.id_mp
AND tipo = 'FAVORITA'
) AS numfavorita,
(
SELECT
count(id)
FROM
tbl_mp_interacciones
WHERE
id_mp = h.id_mp
AND (tipo = 'MEGUSTA' or tipo = 'MEGUSTA_POST' )
) AS nummegusta,
(
SELECT
count(id)
FROM
tbl_mp_interacciones
WHERE
id_mp = h.id_mp
AND tipo = 'COMPARTIDO'
) AS numcompartido,
(
SELECT
count(id)
FROM
tbl_mp_interacciones
WHERE
id_mp = h.id_mp
AND (tipo = 'COMENTARIO'     or tipo='COMENTARIO_REPLY')
) AS numcomentarios,
(
SELECT
count(id)
FROM
tbl_mp_interacciones
WHERE
id_mp = h.id_mp
AND tipo = 'VISITA'
) AS numvisita,

(
SELECT
count(id)
FROM
tbl_mp_interacciones
WHERE
id_mp = h.id_mp
AND tipo = 'VISITA_VIDEO'
) AS numvisitasvideo,

(
SELECT
count(id)
FROM
tbl_mp_interacciones
WHERE
id_mp = h.id_mp
AND (tipo = 'VISITA_VIDEO' or tipo = 'VISITA')
) AS numvisitastotales,

(
SELECT
COUNT(DISTINCT rut)
FROM
tbl_mp_interacciones
WHERE
id_mp = h.id_mp
) AS numvisitantes,



(
SELECT
count(id)
FROM
tbl_mp_interacciones
WHERE
id_mp = h.id_mp
AND tipo = 'DESCARGA'
) AS numdescargas,




(
SELECT
tag
FROM
tbl_mp_tag
WHERE
id_mp = h.id_mp

limit 0,1

) AS tag1,


(
SELECT
tag
FROM
tbl_mp_tag
WHERE
id_mp = h.id_mp

limit 1,1

) AS tag2,


(
SELECT
tag
FROM
tbl_mp_tag
WHERE
id_mp = h.id_mp

limit 2,1

) AS tag3,


(
SELECT
tag
FROM
tbl_mp_tag
WHERE
id_mp = h.id_mp

limit 3,1

) AS tag4,

(
SELECT
tag
FROM
tbl_mp_tag
WHERE
id_mp = h.id_mp

limit 4,1

) AS tag5


FROM
tbl_mp h
WHERE
h.id_empresa='$id_empresa'
and h.id_estado>=0
$queryMp
and h.tipo<>'Pregunta'

order by
h.fecha DESC
";

//echo "sql $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ActualizaDatosMPBCI_dataadmin($id_mp, $autor_MP, $id_categoria, $nombre, $contenido, $video, $archivo, $tipo, $imagenfondo, $url_documento, $resumen, $fuente, $id_ambito, $id_subcategoria, $rut) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if($imagenfondo<>''){ $txt_updateImagen="imagenfondo='$imagenfondo',";} else {$txt_updateImagen="";}

$sql = "UPDATE tbl_mp
SET rut='$autor_MP', id_categoria= '$id_categoria',  nombre='$nombre',
contenido='$contenido', video='$video', archivo='$archivo',
tipo='$tipo', url_documento='$url_documento', resumen='$resumen', fuente='$fuente',
id_ambito='$id_ambito', id_subcategoria='$id_subcategoria', rut='$rut'

where id_mp='$id_mp'";

//echo "<br>" . $sql;
//  sleep(10);
$database->setquery($sql);
$database->query();
}

function TraeMejoresPracticasPreguntasPorEmpresa($idproceso, $id_empresa, $id_mp) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($id_mp == "") {$queryMp = " ";} else { $queryMp = " and id_mp='$id_mp' ";}

$sql = "SELECT
h.*, (
SELECT
nombre_completo
FROM
tbl_usuario
WHERE
rut = h.rut
) AS nombreautor,
(
SELECT
gerencia
FROM
tbl_usuario
WHERE
rut = h.rut
) AS gerenciaautor,
(
SELECT
unidad_negocio
FROM
tbl_usuario
WHERE
rut = h.rut
) AS areaautor,
(
SELECT
cargo
FROM
tbl_usuario
WHERE
rut = h.rut
) AS cargoautor,
(
SELECT
categoria
FROM
tbl_mp_categorias
WHERE
id_categoria = h.id_categoria
) AS nombrecategoria,
(
SELECT
icono
FROM
tbl_mp_categorias
WHERE
id_categoria = h.id_categoria
) AS iconocategoria,
(
SELECT
style
FROM
tbl_mp_categorias
WHERE
id_categoria = h.id_categoria
) AS style,
(
SELECT
estado
FROM
tbl_mp_estados
WHERE
id_estado = h.id_estado
) AS nombreestado,
(
SELECT
estilo
FROM
tbl_mp_estados
WHERE
id_estado = h.id_estado
) AS nombreestiloestado
, (
SELECT
count(id)
FROM
tbl_mp_interacciones
WHERE
id_mp = h.id_mp
AND tipo = 'FAVORITA'
) AS numfavorita,
(
SELECT
count(id)
FROM
tbl_mp_interacciones
WHERE
id_mp = h.id_mp
AND tipo = 'MEGUSTA'
) AS nummegusta,
(
SELECT
count(id)
FROM
tbl_mp_interacciones
WHERE
id_mp = h.id_mp
AND tipo = 'COMPARTIDO'
) AS numcompartido,
(
SELECT
count(id)
FROM
tbl_mp_interacciones
WHERE
id_mp = h.id_mp
AND tipo = 'COMENTARIO'
) AS numcomentarios,
(
SELECT
count(id)
FROM
tbl_mp_interacciones
WHERE
id_mp = h.id_mp
AND tipo = 'VISITA'
) AS numvisitas,
(
SELECT
count(id)
FROM
tbl_mp_interacciones
WHERE
id_mp = h.id_mp
AND tipo = 'DESCARGA'
) AS numdescargas,



(
SELECT
tag
FROM
tbl_mp_tag
WHERE
id_mp = h.id_mp

limit 0,1

) AS tag1,


(
SELECT
tag
FROM
tbl_mp_tag
WHERE
id_mp = h.id_mp

limit 1,1

) AS tag2,


(
SELECT
tag
FROM
tbl_mp_tag
WHERE
id_mp = h.id_mp

limit 2,1

) AS tag3,


(
SELECT
tag
FROM
tbl_mp_tag
WHERE
id_mp = h.id_mp

limit 3,1

) AS tag4,

(
SELECT
tag
FROM
tbl_mp_tag
WHERE
id_mp = h.id_mp

limit 4,1

) AS tag5


FROM
tbl_mp h
WHERE
h.id_empresa='$id_empresa'
and h.id_estado>=0
$queryMp
and h.tipo='Pregunta'
order by h.id_estado ASC, h.fecha DESC
";

//echo "sql $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeCategoriasMP($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.* from tbl_mp_categorias h where h.id_empresa='$id_empresa' and h.categoria<>'' order by h.categoria";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraePalabrasMP($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.* from tbl_mp_palabras_prohibidas h where h.id_empresa='$id_empresa' and h.palabra<>'' order by h.palabra";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeFrasesMP($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.* from tbl_mp_frases h where h.id_empresa='$id_empresa' and h.frase<>'' order by h.id";
// echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeTagsMP($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

SELECT
h.*, (
SELECT DISTINCT(count(id_mp))
FROM
tbl_mp_tag
WHERE
tag = h.tag
) AS cuenta

from tbl_mp_tag_admin h
WHERE
id_empresa = '$id_empresa'

";
// echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeMiniEncuestasMP($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.*,
(select COUNT(DISTINCT rut) from tbl_miniencuestas_respuestas
where id_empresa=h.id_empresa and id_encuesta=h.id) as num_respuestas



from tbl_miniencuestas h where h.id_empresa='$id_empresa' and h.pregunta<>'' order by h.fecha DESC";
// echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeInteraccionporGrupo($tipo, $id_categoria, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select h.*, (select count(id)) as cuenta FROM tbl_mp_interacciones h where h.tipo='$tipo'
and h.id_empresa='$id_empresa' and (select id_categoria from tbl_mp where id_mp=h.id_mp limit 1) ='$id_categoria'
";

//echo "<br>$sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

if ($cod[0]->cuenta != '') {$cuenta = $cod[0]->cuenta;} else { $cuenta = 0;}

return $cuenta;
}

function buscatag($id_mp, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.*
from tbl_mp_tag h where h.id_empresa='$id_empresa'  and id_mp='$id_mp'";

//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeMejoresPracticasPorEmpresaCriterio($idproceso, $id_empresa, $criterio) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
//LUEGO SE FILTRAR POR CATEGORIA

$sql = "select h.*,
(select nombre_completo from tbl_usuario where rut=h.rut) as nombre,
(select $criterio  from tbl_usuario where rut=h.rut) as criterio,
(select cargo from tbl_usuario where rut=h.rut) as cargo,
(SELECT COUNT(ID) from tbl_dnc_sugerencias_por_objetivo where rut_jefe= h.rut) as numsolicitudes


from tbl_dnc_jefes h where h.id_empresa='$id_empresa'

order by (select $criterio  from tbl_usuario where rut=h.rut)  ASC

";
//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeEstadosMejoresPracticas($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
//LUEGO SE FILTRAR POR CATEGORIA

$sql = "select h.*

from tbl_mp_estados h where h.id_empresa='$id_empresa'

order by id_estado ASC

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeCategoriasNPMejoresPracticas($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
//LUEGO SE FILTRAR POR CATEGORIA

$sql = "select h.*

from tbl_mp_categorias h where h.id_empresa='$id_empresa'

order by orden ASC";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeUsuariosNPMejoresPracticas($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
//LUEGO SE FILTRAR POR CATEGORIA

$sql = "select h.*

from tbl_usuario h where h.id_empresa='$id_empresa'

order by nombre ASC";

//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function MP_EditaAdmin_Full($id_MP, $id_empresa, $titulo, $contenido, $autor_MP, $tipo, $tag1_MP, $tag2_MP, $tag3_MP, $tag4_MP, $tag5_MP, $url_MP, $archivo_MP) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

//echo "<br>$id_MP, $id_empresa, $titulo, $contenido, $autor_MP, $tipo, $tag1_MP, $tag2_MP, $tag3_MP, $tag4_MP, $tag5_MP, $url_MP, $archivo_MP";
//tag

$sql = "delete from tbl_mp_tag where id_mp='$id_MP' and id_empresa='$id_empresa'";
$database->setquery($sql);
$database->query();

$sql = "INSERT INTO tbl_mp_tag(id_mp, tag, id_empresa) " .
"VALUES ('$id_MP', '$tag1_MP', '$id_empresa');";

if ($tag1_MP != '') {$database->setquery($sql);
$database->query();}

$sql = "INSERT INTO tbl_mp_tag(id_mp, tag, id_empresa) " .
"VALUES ('$id_MP', '$tag2_MP', '$id_empresa');";
if ($tag2_MP != '') {$database->setquery($sql);
$database->query();}

$sql = "INSERT INTO tbl_mp_tag(id_mp, tag, id_empresa) " .
"VALUES ('$id_MP', '$tag3_MP', '$id_empresa');";
if ($tag3_MP != '') {$database->setquery($sql);
$database->query();}

$sql = "INSERT INTO tbl_mp_tag(id_mp, tag, id_empresa) " .
"VALUES ('$id_MP', '$tag4_MP', '$id_empresa');";
if ($tag4_MP != '') {$database->setquery($sql);
$database->query();}

$sql = "INSERT INTO tbl_mp_tag(id_mp, tag, id_empresa) " .
"VALUES ('$id_MP', '$tag5_MP', '$id_empresa');";
if ($tag5_MP != '') {$database->setquery($sql);
$database->query();}

//

//echo "<br>";

$sql = "update

tbl_mp set nombre='$titulo', contenido='$contenido', rut='$autor_MP',
tipo='$tipo', url_documento='$url_MP', archivo='$archivo_MP'

where id_mp='$id_MP' and id_empresa='$id_empresa'";
$database->setquery($sql);
$database->query();

//echo $sql;
// sleep(10);

$database->setquery($sql);
$database->query();
}
function TraeDNCMejoresPracticasPorEmpresa($rut, $idcategoria, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
//LUEGO SE FILTRAR POR CATEGORIA

$sql = "select h.*,
(select nombre_completo from tbl_usuario where rut=h.rut_jefe) as nombre,
(select cargo from tbl_usuario where rut=h.rut_jefe) as cargo,
(select gerencia from tbl_usuario where rut=h.rut_jefe) as gerencia





from tbl_dnc_sugerencias_por_objetivo h where rut_jefe='$rut'";
//echo "sql $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

//DNC SOLICITUDES
function TraeJefesDNCSolicitudesPorEmpresa($idproceso, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
//LUEGO SE FILTRAR POR CATEGORIA

$sql = "select h.*,
(select nombre_completo from tbl_usuario where rut=h.rut) as nombre,
(select gerencia from tbl_usuario where rut=h.rut) as gerencia,
(select unidad_negocio from tbl_usuario where rut=h.rut) as area,
(select cargo from tbl_usuario where rut=h.rut) as cargo,
(SELECT COUNT(ID) from tbl_dnc_sugerencias_por_objetivo where rut_jefe= h.rut) as numsolicitudes


from tbl_dnc_jefes h where h.id_empresa='$id_empresa'

order by (
SELECT
gerencia
FROM
tbl_usuario
WHERE
rut = h.rut
), (
SELECT
unidad_negocio
FROM
tbl_usuario
WHERE
rut = h.rut
),
(
SELECT
nombre_completo
FROM
tbl_usuario
WHERE
rut = h.rut
)

";
//    echo "sql $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeJefesDNCSolicitudesPorEmpresaCriterio($idproceso, $id_empresa, $criterio) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
//LUEGO SE FILTRAR POR CATEGORIA

$sql = "select h.*,
(select nombre_completo from tbl_usuario where rut=h.rut) as nombre,
(select $criterio  from tbl_usuario where rut=h.rut) as criterio,
(select cargo from tbl_usuario where rut=h.rut) as cargo,
(SELECT COUNT(ID) from tbl_dnc_sugerencias_por_objetivo where rut_jefe= h.rut) as numsolicitudes


from tbl_dnc_jefes h where h.id_empresa='$id_empresa'

order by (select $criterio  from tbl_usuario where rut=h.rut)  ASC

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeDNCSolicitudesPorEmpresa($rut, $idcategoria, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
//LUEGO SE FILTRAR POR CATEGORIA

$sql = "select h.*,
(select nombre_completo from tbl_usuario where rut=h.rut_jefe) as nombre,
(select cargo from tbl_usuario where rut=h.rut_jefe) as cargo,
(select gerencia from tbl_usuario where rut=h.rut_jefe) as gerencia





from tbl_dnc_sugerencias_por_objetivo h where rut_jefe='$rut'";
//echo "sql $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

//PREGUNTAS Y RESPUESTAS
function TraepreguntasyrespuestasPorEmpresa($idcategoria, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
//LUEGO SE FILTRAR POR CATEGORIA

$sql = "select h.*,

(select nombre  from tbl_mensaje_tipo where id=h.tipo_mensaje) as tipo,
(select nombre  from tbl_mensajes_destinatarios where id=h.tipo_mensaje) as destinatario,

(select nombre_completo  from tbl_usuario where rut=h.rut_creador) as nombrepersona


from tbl_mensajes_principal h WHERE  h.id_empresa='$id_empresa'";
//echo "sql $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ActualizaRelacionEval($evaluado, $evaluador, $validador, $calibrador, $comentario, $rut_evaluador_original, $perfil_evaluacion, $subperfil_evaluacion, $id_proceso) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "

update tbl_sgd_relaciones set
evaluador='$evaluador',
validador='$validador',
calibrador='$calibrador',
perfil_evaluacion_competencias='$perfil_evaluacion',
subperfil='$subperfil_evaluacion'

where evaluado='$evaluado' and evaluador='$rut_evaluador_original' and id_proceso='$id_proceso'

";
//echo $sql;Exit;
$database->setquery($sql);
$database->query();
}

function ActualizzaRelacion($evaluado, $evaluador, $validador, $calibrador, $comentario) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "

update tbl_sgd_relaciones set
evaluador='$evaluador',
validador='$validador',
calibrador='$calibrador'

where evaluado='$evaluado'

";
//echo $sql;Exit;
$database->setquery($sql);
$database->query();
}

function TraeEvaluadoEvaluadorPorProceso3Campos($id_proceso, $registros_por_pagina, $pagina, $arreglo_post, $campo_criterio, $criterio, $valor_criterio, $campos_para_reporte, $datos_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
SELECT DISTINCT

tbl_sgd_relaciones.evaluador,
tbl_sgd_relaciones.evaluado,

base_evaluador.nombre_completo AS nombre_evaluador,
base_evaluador." . $datos_empresa[0]->campo1 . " AS campo1,
base_evaluador." . $datos_empresa[0]->campo2 . " AS campo2,
base_evaluador." . $datos_empresa[0]->campo3 . " AS campo3,
base_evaluador.rut_completo AS rut_completo_evaluador,
base_evaluador.cargo AS cargo_evaluador,
base_evaluador.gerencia AS gerencia_evaluador,
base_evaluador.nombre_empresa_holding AS nombre_empresa_holding_evaluador,

base_evaluado.nombre_completo AS nombre_evaluado,
base_evaluado." . $datos_empresa[0]->campo1 . " AS campo1_evaluado,
base_evaluado." . $datos_empresa[0]->campo2 . " AS campo_evaluado2,
base_evaluado." . $datos_empresa[0]->campo3 . " AS campo3_evaluado,
base_evaluado.rut_completo AS rut_completo_evaluado,
base_evaluado.cargo AS cargo_evaluado,
base_evaluado.gerencia AS gerencia_evaluado,
base_evaluado.nombre_empresa_holding AS nombre_empresa_holding_evaluado,

(select count(*) as total from tbl_objetivos_indviduales_finalizado where tbl_objetivos_indviduales_finalizado.evaluado=tbl_sgd_relaciones.evaluado and tbl_objetivos_indviduales_finalizado.evaluador=tbl_sgd_relaciones.evaluador and tbl_sgd_relaciones.id_proceso=tbl_objetivos_indviduales_finalizado.id_proceso) as total_finalizados_fijados,

(select count(*) as total
from tbl_sgd_descarga_informe
where tbl_sgd_relaciones.evaluado=tbl_sgd_descarga_informe.evaluado and
tbl_sgd_relaciones.evaluador=tbl_sgd_descarga_informe.evaluador and
tbl_sgd_descarga_informe.id_proceso=tbl_sgd_relaciones.id_proceso

) as total_descarga_informes

,
(
SELECT
count(*)AS total
FROM
tbl_objetivos_validaciones
WHERE
tbl_objetivos_validaciones.evaluado = tbl_sgd_relaciones.evaluado
AND tbl_objetivos_validaciones.evaluador = tbl_sgd_relaciones.evaluador
AND tbl_objetivos_validaciones.id_proceso = tbl_sgd_relaciones.id_proceso
)AS total_validados









FROM
tbl_sgd_relaciones
INNER JOIN tbl_usuario AS base_evaluador ON base_evaluador.rut = tbl_sgd_relaciones.evaluador
INNER JOIN tbl_usuario as base_evaluado on base_evaluado.rut=tbl_sgd_relaciones.evaluado
WHERE
tbl_sgd_relaciones.id_proceso = '$id_proceso'

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function InsertLogPrueba() {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "INSERT INTO tbl_log_sistema(rut, ambiente, fecha, hora, ip, id_empresa)
VALUES ('xx', 'xx', 'xx', 'xx', 'xx', 'xx');";

$database->setquery($sql);
$database->query();
}

function InsertaNuevaClaveYaCambiada($rut, $clave, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

//$sql = "INSERT INTO tbl_clave(rut, clave, id_empresa, cambiado) VALUES ('$rut', '$clave', '$id_empresa', '1');";

$database->setquery($sql);
$database->query();
}

function InsertaNuevaClave($rut, $clave, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

//$sql = "INSERT INTO tbl_clave(rut, clave, id_empresa)    VALUES ('$rut', '$clave', '$id_empresa');";

$database->setquery($sql);
$database->query();
}

function ProcesosEvalPorProcesoAnualSoloFij($id_proceso_anual) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "
select * from tbl_sgd_proceso_evaluacion where id_proceso_anual='$id_proceso_anual' and (tipo_proceso='2' or tipo_proceso='6')";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function aprobar_comentario($id) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "update tbl_noticias_comentarios set estado='1' where id='$id';";
$database->setquery($sql);
$database->query();
}

function CuentaNoticias($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select count(*) as total from tbl_noticias where id_empresa='$id_empresa'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod[0]->total;
}
function CuentaComentarios($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "SELECT count(*) as total FROM `tbl_noticias_comentarios` INNER JOIN tbl_noticias ON tbl_noticias.id=tbl_noticias_comentarios.id_noticia where tbl_noticias.id_empresa='$id_empresa'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod[0]->total;
}

function cuenta_likes_noticias($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select COUNT(*) as total  from tbl_megusta_registro where id_empresa='$id_empresa' AND id_noticia IS NOT NULL";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod[0]->total;
}

function TraePrincipalEmpresa($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_noticias_principal where id_empresa='$id_empresa'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod[0]->principal;
}
function cuenta_visitas_noticias($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select COUNT(*) as total  from tbl_noticias_log where id_empresa='$id_empresa'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod[0]->total;
}

function Busca_Usuario_malla($rut, $id_malla, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT * FROM rel_lms_malla_persona WHERE id_malla='$id_malla' AND rut='$rut' AND id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod[0]->id;
}

function BuscaUsuarioMallaPrograma($rut, $id_malla, $id_programa, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
if ($id_malla == "") {$queryMalla = " ";} else { $queryMalla = " h.id_malla='" . $id_malla . "'";}
$sql = "SELECT h.*,
(select id_programa from rel_lms_malla_curso where id_malla=h.id_malla limit 1),
(select nombre from tbl_lms_malla where id=h.id_malla limit 1) as nombremalla

FROM rel_lms_malla_persona h
WHERE  h.rut='$rut' AND h.id_empresa='$id_empresa' AND $queryMalla
(select id_programa from rel_lms_malla_curso where id_malla=h.id_malla limit 1) ='$id_programa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function Actualiza_malla_persona($id, $id_malla) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE rel_lms_malla_persona SET id_malla='$id_malla' WHERE id = '$id'";
$database->setquery($sql);
if (!$database->query_error()) {
return $database->errores(mysql_error());
}
}

function Ingresa_malla_persona($rut, $id_malla, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "INSERT INTO rel_lms_malla_persona(rut,id_malla,id_empresa)
VALUES ('$rut','$id_malla','$id_empresa');";

$database->setquery($sql);
$database->query();
}

function TraeUsuarioCierre1($codigo, $Campos1, $Campos2, $Campos3) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT
tbl_usuario.$Campos1 as campo1,
tbl_usuario.$Campos2 as campo2,
tbl_usuario.$Campos3 as campo3,
tbl_inscripcion_cierre.*,
tbl_usuario.*
from tbl_inscripcion_cierre INNER JOIN tbl_usuario ON tbl_usuario.rut=tbl_inscripcion_cierre.rut  where id_inscripcion='$codigo'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeEvaluadoresPorProceso3Campos($id_proceso, $registros_por_pagina, $pagina, $arreglo_post, $campo_criterio, $criterio, $valor_criterio, $campos_para_reporte, $datos_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($arreglo_post["gerencia"]) {
$filtro = " and tbl_usuario.gerencia='" . $arreglo_post["gerencia"] . "'";
}

if ($arreglo_post["un"]) {
$filtro .= " and tbl_usuario.unidad_negocio='" . $arreglo_post["un"] . "'";
}

if ($arreglo_post["area"]) {
$filtro .= " and tbl_usuario.area='" . $arreglo_post["area"] . "'";
}

if ($arreglo_post["filtro_empresa_holding"]) {
$filtro .= " and tbl_usuario.empresa_holding='" . $arreglo_post["filtro_empresa_holding"] . "'";
}

if ($arreglo_post["filtro_centrocosto"]) {
$filtro .= " and tbl_usuario.centro_costo='" . $arreglo_post["filtro_centrocosto"] . "'";
}

if ($arreglo_post["asc_desc"]) {
$ascdesc = $arreglo_post["asc_desc"];
}

if ($arreglo_post["filtro1"] != '0' and $arreglo_post["filtro1"] != '') {
$filtro_campo1 = " and base_evaluador." . $datos_empresa[0]->campo1 . "='" . $arreglo_post["filtro1"] . "' ";
}

if ($arreglo_post["filtro2"] != '0' and $arreglo_post["filtro2"] != '') {
$filtro_campo2 = " and base_evaluador." . $datos_empresa[0]->campo2 . "='" . $arreglo_post["filtro2"] . "' ";
}

if ($arreglo_post["filtro3"] != '0' and $arreglo_post["filtro3"] != '') {
$filtro_campo3 = " and base_evaluador." . $datos_empresa[0]->campo3 . "='" . $arreglo_post["filtro3"] . "' ";
}

if ($arreglo_post["orderBy"]) {
$orderBy = " order by base_evaluador." . $arreglo_post["orderBy"] . " " . $ascdesc;
} else {
$orderBy = " order by tbl_sgd_relaciones.id desc";
}

if ($criterio && $valor_criterio) {
$filtro_desde_tabla_resumen = " and base_evaluador.$criterio='$valor_criterio'";
}

if (count($campos_para_reporte) > 0) {
for ($i = 0; $i < count($campos_para_reporte); $i++) {
$datos_campos_reportes .= " base_evaluador." . $campos_para_reporte[$i]->campo . " AS campo" . $campos_para_reporte[$i]->orden . ", ";
}
}

if ($tabla == "tbl_usuarios") {
$cruce_holding = ", tbl_empresa_holding.empresa as nombre_empresa_holding ";
$cruce_left_join_empresa = "left join tbl_empresa_holding
on tbl_empresa_holding.rut=tbl_usuario.empresa_holding";
}

if (!$pagina or $pagina == 1) {
$limite_interior = 0;
} else {
$limite_interior = ($pagina - 1) * $registros_por_pagina;
}

if ($campo_criterio) {
$sql = "
SELECT DISTINCT
(
tbl_sgd_relaciones.evaluador
),
base_evaluador.nombre_completo AS nombre_evaluador,
base_evaluador.rut_completo AS rut_completo_evaluador,
base_evaluador.cargo AS cargo_evaluador,
base_evaluador.gerencia AS gerencia_evaluador,
base_evaluador.$campo_criterio AS valor_campo_criterio,
base_evaluador.nombre_empresa_holding AS nombre_empresa_holding_evaluador,
(
SELECT
count(*)
FROM
tbl_sgd_relaciones AS relaciones_evaluado
WHERE
relaciones_evaluado.id_proceso = '$id_proceso'
AND relaciones_evaluado.evaluador = tbl_sgd_relaciones.evaluador
)AS total_evaluados,
(
SELECT
count(*)
FROM
tbl_sgd_finalizados_evaluado_evaluador
WHERE
tbl_sgd_finalizados_evaluado_evaluador.id_proceso = '$id_proceso'
AND tbl_sgd_finalizados_evaluado_evaluador.evaluador = tbl_sgd_relaciones.evaluador
)AS total_finalizados,


tbl_clave.cambiado as clave_creada

FROM
tbl_sgd_relaciones
INNER JOIN tbl_usuario AS base_evaluador ON base_evaluador.rut = tbl_sgd_relaciones.evaluador
inner join tbl_clave on tbl_clave.rut=tbl_sgd_relaciones.evaluador
WHERE
tbl_sgd_relaciones.id_proceso = '$id_proceso' $filtro_desde_tabla_resumen order by base_evaluador.$campo_criterio asc


";
} else {
$sql = "
SELECT DISTINCT
(
tbl_sgd_relaciones.evaluador
),
base_evaluador.nombre_completo AS nombre_evaluador,

base_evaluador." . $datos_empresa[0]->campo1 . " AS campo1,
base_evaluador." . $datos_empresa[0]->campo2 . " AS campo2,
base_evaluador." . $datos_empresa[0]->campo3 . " AS campo3,


$datos_campos_reportes
base_evaluador.rut_completo AS rut_completo_evaluador,
base_evaluador.cargo AS cargo_evaluador,
base_evaluador.gerencia AS gerencia_evaluador,
base_evaluador.nombre_empresa_holding AS nombre_empresa_holding_evaluador,
(
SELECT
count(*)
FROM
tbl_sgd_relaciones AS relaciones_evaluado
WHERE
relaciones_evaluado.id_proceso = '$id_proceso'
AND relaciones_evaluado.evaluador = tbl_sgd_relaciones.evaluador
)AS total_evaluados,
(
SELECT
count(*)
FROM
tbl_sgd_finalizados_evaluado_evaluador
WHERE
tbl_sgd_finalizados_evaluado_evaluador.id_proceso = '$id_proceso'
AND tbl_sgd_finalizados_evaluado_evaluador.evaluador = tbl_sgd_relaciones.evaluador
)AS total_finalizados,


tbl_clave.cambiado as clave_creada,
(
SELECT
count(*)AS total_feecback_evaluado
FROM
tbl_sgd_feedback_evaluado
WHERE
tbl_sgd_feedback_evaluado.evaluador = tbl_sgd_relaciones.evaluador
and tbl_sgd_feedback_evaluado.realizado is not null and tbl_sgd_feedback_evaluado.realizado <>''
and tbl_sgd_feedback_evaluado.comentario is not null and tbl_sgd_feedback_evaluado.comentario <>''
and tbl_sgd_feedback_evaluado.compromisos_evaluado is not null and tbl_sgd_feedback_evaluado.compromisos_evaluado <>''

)AS total_feedback

FROM
tbl_sgd_relaciones
INNER JOIN tbl_usuario AS base_evaluador ON base_evaluador.rut = tbl_sgd_relaciones.evaluador
inner join tbl_clave on tbl_clave.rut=tbl_sgd_relaciones.evaluador
WHERE
tbl_sgd_relaciones.id_proceso = '$id_proceso' $filtro_desde_tabla_resumen

$filtro_campo1

$filtro_campo2

$filtro_campo3

$orderBy



";
}

//LIMIT $limite_interior,  $registros_por_pagina
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function InsertaInscripcionParticipanteBK($id_inscripcion, $rut, $movilizacion, $viatico,
$tramo_sence, $empresa, $gerencia, $centro_costo, $cargo, $rutempresaholding, $empresaholding,
$idcentrocosto, $id_curso, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "INSERT INTO tbl_inscripcion_usuarios(id_inscripcion,rut,movilizacion,viatico,
tramo_sence,empresa,gerencia,centro_costo,cargo,rutempresaholding,empresaholding,
idcentrocosto,id_curso,id_empresa)
VALUES ('$id_inscripcion','$rut','$movilizacion','$viatico',
'$tramo_sence','$empresa','$gerencia','$centro_costo','$cargo','$rutempresaholding','$empresaholding',
'$idcentrocosto','$id_curso','$id_empresa');";

$database->setquery($sql);
$database->query();
}

function inscripcion_compleja_cursoBK($fecha_inicio, $fecha_termino, $dias,
$modalidad, $valor_curso, $valor_hora,
$direccion, $comuna, $region, $comentarios, $curso,
$lunes_d_am, $lunes_h_am, $lunes_d_pm, $lunes_h_pm,
$martes_d_am, $martes_h_am, $martes_d_pm, $martes_h_pm,
$miercoles_d_am, $miercoles_h_am, $miercoles_d_pm, $miercoles_h_pm,
$jueves_d_am, $jueves_h_am, $jueves_d_pm, $jueves_h_pm,
$viernes_d_am, $viernes_h_am, $viernes_d_pm, $viernes_h_pm,
$id_malla, $id_empresa, $codigo) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "INSERT INTO tbl_inscripcion_curso(fecha_inicio,fecha_termino,numero_dias,
abierto_cerrado,valor_curso,valor_hora_curso,
direccion,comuna,ciudad,comentarios,id_curso,
lunes_d_am,lunes_h_am,lunes_d_pm,lunes_h_pm,
martes_d_am,martes_h_am,martes_d_pm,martes_h_pm,
miercoles_d_am,miercoles_h_am,miercoles_d_pm,miercoles_h_pm,
jueves_d_am,jueves_h_am,jueves_d_pm,jueves_h_pm,
viernes_d_am,viernes_h_am,viernes_d_pm,viernes_h_pm,
id_malla,id_empresa,codigo_inscripcion)
VALUES ('$fecha_inicio','$fecha_termino','$dias',
'$modalidad','$valor_curso','$valor_hora',
'$direccion','$comuna','$region','$comentarios','$curso',
'$lunes_d_am','$lunes_h_am','$lunes_d_pm','$lunes_h_pm',
'$martes_d_am','$martes_h_am','$martes_d_pm','$martes_h_pm',
'$miercoles_d_am','$miercoles_h_am','$miercoles_d_pm','$miercoles_h_pm',
'$jueves_d_am','$jueves_h_am','$jueves_d_pm','$jueves_h_pm',
'$viernes_d_am','$viernes_h_am','$viernes_d_pm','$viernes_h_pm',
'$id_malla','$id_empresa','$codigo');";

$database->setquery($sql);
$database->query();
}

function TraeMallaCurso($id_curso, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT * FROM rel_lms_malla_curso where id_curso='$id_curso' and id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod[0]->id_malla;
}

function TraeUsuarioRut($rut) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT *
FROM
tbl_usuario
WHERE
rut = '$rut'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function CuentaCursosMalla($id, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT COUNT(*) as total from rel_lms_malla_curso where id_malla='$id' and id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod[0]->total;
}

function TraeOrdenClasificacion($id) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT orden_clasificacion as orden FROM rel_lms_malla_curso where id_clasificacion='$id'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod[0]->orden;
}
function TraeUltimaOrdenClasificacion($id_malla, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT MAX(orden_clasificacion) as orden FROM rel_lms_malla_curso where id_malla='$id_malla' and id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod[0]->orden;
}

function TraeOrdenClasificacionCurso($id) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT MAX(orden_curso) as orden FROM rel_lms_malla_curso where id_clasificacion='$id'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod[0]->orden;
}

function InsertaMalla2($codigo_malla, $nombre_malla, $descripcion_malla, $tipo_malla, $certificable, $ponderacion, $tipo_fecha, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$orden = 1 + (Cuenta_Mallas($id_empresa));

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "INSERT INTO tbl_lms_malla(id,nombre, descripcion, tipo, certificable, ponderacion, tipo_fecha,id_empresa, orden) " .
"VALUES ('$codigo_malla','$nombre_malla', '$descripcion_malla', '$tipo_malla', '$certificable', '$ponderacion', '$tipo_fecha', $id_empresa, $orden);";

$database->setquery($sql);
$database->query();
}

function TraeCursosEmpresa($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT tbl_lms_curso.id,tbl_lms_curso.nombre,tbl_lms_curso.numero_identificador,tbl_lms_curso.rut_otec,tbl_lms_clasificacion.clasificacion,tbl_lms_curso.numero_horas,tbl_lms_curso.valor_hora,tbl_lms_curso.valor_hora_sence,tbl_lms_curso.nombre_otec FROM tbl_lms_curso
LEFT JOIN tbl_lms_clasificacion ON tbl_lms_clasificacion.id_clasificacion=rel_lms_malla_curso.id_clasificacion
WHERE tbl_lms_curso.id_empresa='$id_empresa'";

$sql = "SELECT
tbl_lms_curso.id,
tbl_lms_curso.nombre,
tbl_lms_curso.numero_identificador,
tbl_lms_curso.rut_otec,
tbl_lms_curso.numero_horas,
tbl_lms_curso.valor_hora,
tbl_lms_curso.valor_hora_sence,
tbl_lms_curso.nombre_otec,
tbl_lms_curso.clasificacion,
tbl_lms_clasificacion.clasificacion as nombre_clasificacion
FROM
tbl_lms_curso
left join tbl_lms_clasificacion
on tbl_lms_clasificacion.id_clasificacion=tbl_lms_curso.clasificacion
WHERE
tbl_lms_curso.id_empresa = '$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function CuentaCursosClasificacion($id) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT COUNT(*) as total FROM tbl_lms_curso where clasificacion='$id'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod[0]->total;
}

function CuentaCursosEmpresa($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT count(*) as total FROM tbl_lms_curso WHERE tbl_lms_curso.id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod[0]->total;
}

function ActualizaUsuarioMasivo($rut, $valuesUpdate, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE tbl_usuario SET $valuesUpdate ,vigencia='0'    WHERE rut = '$rut' AND id_empresa='$id_empresa'";
$database->setquery($sql);
if (!$database->query_error()) {
return $database->errores(mysql_error());
}
}

function DesvinculaUsuariosExcel($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE tbl_usuario SET vigencia='1'    WHERE id_empresa='$id_empresa'";
$database->setquery($sql);
if (!$database->query_error()) {
return $database->errores(mysql_error());
}
}

function resetea_claveConClave($rut, $nueva_clave) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE tbl_clave SET clave='$nueva_clave',cambiado='0'    WHERE rut = '$rut'";
$database->setquery($sql);
if (!$database->query_error()) {
return $database->errores(mysql_error());
}
}

function resetea_clave($rut) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE tbl_clave SET clave='" . substr($rut, 0, 4) . "', cambiado='0'    WHERE rut = '$rut'";
$database->setquery($sql);
if (!$database->query_error()) {
return $database->errores(mysql_error());
}
}

function InsertaUsuarioMasivo($values, $registros) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

//$sql = "INSERT INTO tbl_usuario ($values,vigencia) VALUES ($registros,'0');";
$sql = "INSERT INTO tbl_usuario ($values) VALUES ($registros);";
//echo "$sql";exit();
$database->setquery($sql);
if (!$database->query_error()) {
return $database->errores(mysql_error());
}
}

function Lms_Update_malla($rut, $id_malla, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT count(*) as total FROM rel_lms_malla_persona WHERE rut='$rut' and id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

$hay_malla = $cod[0]->total;

//echo "<br>$rut $hay_malla";

if ($hay_malla > 0) {
$sql = "UPDATE rel_lms_malla_persona SET id_malla='$id_malla'    WHERE rut = '$rut' and id_empresa='$id_empresa'";
$database->setquery($sql);
$database->query();
}
if ($hay_malla == 0) {
$sql = "INSERT INTO rel_lms_malla_persona(rut, id_malla, id_empresa) " .
"VALUES ('$rut','$id_malla', '$id_empresa');";

$database->setquery($sql);
$database->query();
}
}

function truncateUsuarioTemporal() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "truncate tbl_usuario_temporal";
//echo $sql;
$database->setquery($sql);
$database->query();
}
function InsertaUsuarioTemporal($values, $registros, $id_empresa, $accion) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO tbl_usuario_temporal ($values,id_empresa,accion) VALUES ($registros,'$id_empresa','$accion');";

return $sql;
//$database->setquery($sql);
//$database->setquery($sql);
//$database->query();
}

function ActualizaNombreCompletoUsuarioTemporal($id_empresa) {
}

function UsuariosTemporal($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT * FROM tbl_usuario_temporal WHERE id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeCursosInscritosParticipante($id_empresa, $rut) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT * from tbl_inscripcion_usuarios
where rut='$rut' AND id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeCursosInscritosMallaParticipante($id_empresa, $id_malla, $rut) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT * from rel_lms_malla_curso
where id_malla='$id_malla' AND id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ConsultaCursoCierre($id_empresa, $rut, $id_inscripcion, $id_curso) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT estado,id from
tbl_inscripcion_cierre where
rut='$rut'AND
id_inscripcion='$id_inscripcion' AND
id_curso='$id_curso' AND
id_empresa='$id_empresa'";
//echo "$sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ConsultaCursoCierreMalla($id_empresa, $rut, $id_curso) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT estado, avance, id from
tbl_inscripcion_cierre where
rut='$rut' AND

id_curso='$id_curso' AND
id_empresa='$id_empresa'";
//echo "$sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeMallaUsuarioSubida($rut, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT id_malla FROM rel_lms_malla_persona where id_empresa='$id_empresa' and rut='$rut'";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod[0]->id_malla;
}

function TraeCampos($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT campo1,campo2,campo3 FROM tbl_empresa where id='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeCamposPlantilla() {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT * FROM tbl_plantilla_usuarios";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function AgrupaCampos($campo, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT $campo as campo FROM tbl_usuario where not $campo='' AND id_empresa='$id_empresa' GROUP BY $campo";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeParticipantes($id_empresa, $campo1, $campo2, $campo3, $desde, $limit, $scampo1, $scampo2, $scampo3, $id_malla) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($id_malla == "sinmalla") {
$sql = "SELECT h.$campo1 as campo1,
h.$campo2 as campo2,
h.$campo3 as campo3,
h.nombre,
h.apaterno,
h.amaterno,
h.cargo,
h.rut,
h.email,

(SELECT
id_malla
FROM
rel_lms_malla_persona
WHERE
rut = h.rut
AND id_empresa = '$id_empresa' limit 1

)    FROM `tbl_usuario` h
WHERE
h.$campo1 LIKE '%$scampo1%' AND
h.$campo2 LIKE '%$scampo2%' AND
h.$campo3 LIKE '%$scampo3%' AND



h.vigencia='0' AND
h.id_empresa='$id_empresa'


and (
SELECT
id_malla
FROM
rel_lms_malla_persona
WHERE
rut = h.rut
AND id_empresa = '$id_empresa'  limit 1

) IS NULL

";
} else {
$sql = "SELECT tbl_usuario.$campo1 as campo1,
tbl_usuario.$campo2 as campo2,
tbl_usuario.$campo3 as campo3,
tbl_usuario.nombre,
tbl_usuario.apaterno,
tbl_usuario.amaterno,
tbl_usuario.cargo,
tbl_usuario.rut,
tbl_usuario.email,
tbl_lms_malla.nombre as malla,
tbl_lms_malla.id as idmalla,
rel_lms_malla_persona.id_malla FROM `tbl_usuario`
LEFT JOIN rel_lms_malla_persona ON rel_lms_malla_persona.rut=tbl_usuario.rut
LEFT JOIN tbl_lms_malla ON tbl_lms_malla.id=rel_lms_malla_persona.id_malla
WHERE
tbl_usuario.$campo1 LIKE '%$scampo1%' AND
tbl_usuario.$campo2 LIKE '%$scampo2%' AND
tbl_usuario.$campo3 LIKE '%$scampo3%' AND
tbl_lms_malla.id LIKE '%$id_malla%' AND
tbl_usuario.vigencia='0' AND
tbl_usuario.id_empresa='$id_empresa' LIMIT $desde,$limit";
}
//echo "$sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TraeIncripcionEmpresa($id_empresa, $desde, $limit, $codigo, $fecha1, $fecha2) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
if ($fecha1 != "" && $fecha2 != "") {
$filtro_fechas = "AND tbl_inscripcion_curso.fecha_inicio BETWEEN '" . $fecha1 . "'  AND '" . $fecha2 . "'";
}

$sql = "SELECT tbl_inscripcion_curso.id_curso,
tbl_inscripcion_curso.codigo_inscripcion,
tbl_lms_curso.nombre,
tbl_lms_clasificacion.clasificacion ,
tbl_inscripcion_curso.fecha_inicio,
tbl_inscripcion_curso.fecha_termino
FROM tbl_inscripcion_curso
INNER JOIN tbl_lms_curso on tbl_lms_curso.id=tbl_inscripcion_curso.id_curso
INNER JOIN tbl_lms_clasificacion on tbl_lms_clasificacion.id_clasificacion=rel_lms_malla_curso.id_clasificacion
WHERE tbl_inscripcion_curso.id_empresa='$id_empresa'AND
tbl_inscripcion_curso.codigo_inscripcion LIKE '%$codigo%'
$filtro_fechas
ORDER BY tbl_inscripcion_curso.fecha_inicio DESC LIMIT $desde,$limit";

$sql = "SELECT tbl_inscripcion_curso.id_curso,
tbl_inscripcion_curso.codigo_inscripcion,
tbl_lms_curso.nombre,
tbl_inscripcion_curso.fecha_inicio,
tbl_inscripcion_curso.fecha_termino
FROM tbl_inscripcion_curso
INNER JOIN tbl_lms_curso on tbl_lms_curso.id=tbl_inscripcion_curso.id_curso
WHERE tbl_inscripcion_curso.id_empresa='$id_empresa'AND
tbl_inscripcion_curso.codigo_inscripcion LIKE '%$codigo%'
$filtro_fechas
ORDER BY tbl_inscripcion_curso.fecha_inicio DESC LIMIT $desde,$limit";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function CuentaIncripcionEmpresa($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT count(*) as total
FROM tbl_inscripcion_curso
INNER JOIN tbl_lms_curso on tbl_lms_curso.id=tbl_inscripcion_curso.id_curso
INNER JOIN tbl_lms_clasificacion on tbl_lms_clasificacion.id_clasificacion=rel_lms_malla_curso.id_clasificacion
WHERE tbl_inscripcion_curso.id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod[0]->total;
}

function CuentaUsuarios($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT count(*) as total
FROM tbl_usuario
WHERE id_empresa='$id_empresa' and vigencia='0'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod[0]->total;
}

function CuentaParticipantesEmpresa($id_empresa, $Campos1, $Campos2, $Campos3, $scampo1, $scampo2, $scampo3, $id_malla) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT count(*) as total FROM `tbl_usuario`
LEFT JOIN rel_lms_malla_persona ON rel_lms_malla_persona.rut=tbl_usuario.rut
LEFT JOIN tbl_lms_malla ON tbl_lms_malla.id=rel_lms_malla_persona.id_malla
WHERE
tbl_usuario.$Campos1 LIKE '%$scampo1%' AND
tbl_usuario.$Campos2 LIKE '%$scampo2%' AND
tbl_usuario.$Campos3 LIKE '%$scampo3%' AND
tbl_lms_malla.id LIKE '%$id_malla%' AND
tbl_usuario.vigencia='0' AND
tbl_usuario.id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod[0]->total;
}

function CuentaUsuariosFiltro($id_empresa, $Campos1, $Campos2, $Campos3, $scampo1, $scampo2, $scampo3) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT count(*) as total
FROM tbl_usuario
WHERE
tbl_usuario.$Campos1 LIKE '%$scampo1%' AND
tbl_usuario.$Campos2 LIKE '%$scampo2%' AND
tbl_usuario.$Campos3 LIKE '%$scampo3%' AND
tbl_usuario.vigencia='0' AND
tbl_usuario.id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod[0]->total;
}

function TraeUsuariosEmpresaFiltros($id_empresa, $Campos1, $Campos2, $Campos3, $rut_colaborador) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($rut_colaborador) {
$filtro_colaborador = " and rut='$rut_colaborador'";
}

$sql = "
SELECT *,
$Campos1 as campo1,
$Campos2 as campo2,
$Campos3 as campo3
from vista_usuario
WHERE
vigencia='0' AND
id_empresa='$id_empresa' $filtro_colaborador
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeUsuariosEmpresaFiltrosUltimo($id_empresa, $Campos1, $Campos2, $Campos3) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
SELECT *,
$Campos1 as campo1,
$Campos2 as campo2,
$Campos3 as campo3
from vista_usuario
WHERE
vigencia='0' AND
id_empresa='$id_empresa' order by id DESC limit 1
";

//echo $sql;exit;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeUsuariosDncSolicitudesTodos($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select h.*,
(select nombre_completo from tbl_usuario where rut=h.rut_jefe) as nombre_lider,
(select cargo from tbl_usuario where rut=h.rut_jefe) as cargo,
(select gerencia from tbl_usuario where rut=h.rut_jefe) as gerencia,
(select unidad_negocio from tbl_usuario where rut=h.rut_jefe) as area,
(select count(id) from tbl_dnc_colaboradores_por_objetivo where id_sugerencia=h.id and rut_jefe=h.rut_jefe) as numparticipantes

from tbl_dnc_sugerencias_por_objetivo h
order by

(select gerencia from tbl_usuario where rut=h.rut_jefe),
(select unidad_negocio from tbl_usuario where rut=h.rut_jefe),
(select nombre_completo from tbl_usuario where rut=h.rut_jefe)
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeUsuariosDncSolicitudesTodoParticipantes($id_sugerencia, $id_empresa, $jefe) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select h.*

from tbl_dnc_colaboradores_por_objetivo h
where
h.rut_jefe='$jefe' and h.id_sugerencia ='$id_sugerencia'


";

// echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function Total_Participantes($id_empresa, $id_inscripcion) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT count(*) as total FROM `tbl_inscripcion_usuarios` WHERE id_inscripcion='$id_inscripcion' AND id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod[0]->total;
}

function TraeOtec($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT * FROM `tbl_otec` where id_empresa='$id_empresa'";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Total_InscripcionesBK($id_empresa, $id_inscripcion) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT
sum(costototal) as costototal,
tbl_usuario.empresa_holding,
sum(tbl_inscripcion_cierre.costootec) as franquicia,
sum(tbl_inscripcion_cierre.costoempresa) as costo_empresa,
sum(tbl_inscripcion_cierre.viatico_utilizado) as viatico,
sum(tbl_inscripcion_cierre.movilizacion_utilizada) as movilizacion

FROM tbl_inscripcion_cierre
INNER JOIN tbl_usuario ON tbl_usuario.rut=tbl_inscripcion_cierre.rut
INNER JOIN tbl_empresa_holding
where tbl_inscripcion_cierre.id_inscripcion='$id_inscripcion' AND tbl_inscripcion_cierre.id_empresa='$id_empresa' GROUP BY  tbl_usuario.empresa_holding";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

//funcion carga inscripciones
function TraeMallas($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT tbl_usuario.rut,rel_lms_malla_persona.id_malla FROM tbl_usuario INNER JOIN rel_lms_malla_persona ON rel_lms_malla_persona.rut=tbl_usuario.rut WHERE id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeSoloCursos($id_malla, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT id_curso FROM rel_lms_malla_curso WHERE id_malla = '$id_malla' and id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeCursos($id_malla, $id_empresa, $id_clasificacion) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$filtro_clasificacion = "";
if ($id_clasificacion != "0" and $id_clasificacion != "") {
$filtro_clasificacion = " and rel_lms_malla_curso.id_clasificacion='$id_clasificacion'";
}

if ($id_malla == "0" or $id_malla == "") {
$sql = "SELECT tbl_lms_curso.*
FROM tbl_lms_curso
INNER JOIN rel_lms_malla_curso
ON rel_lms_malla_curso.id_curso=tbl_lms_curso.id    $filtro_clasificacion
WHERE tbl_lms_curso.id_empresa='$id_empresa'
GROUP BY tbl_lms_curso.id";
} else if ($id_malla == "-1") {
$sql = "SELECT tbl_lms_curso.* FROM tbl_lms_curso WHERE tbl_lms_curso.id_empresa='$id_empresa'  GROUP BY tbl_lms_curso.id order by tbl_lms_curso.nombre";
} else {
$sql = "SELECT tbl_lms_curso.* FROM tbl_lms_curso INNER JOIN rel_lms_malla_curso ON rel_lms_malla_curso.id_curso=tbl_lms_curso.id  $filtro_clasificacion WHERE rel_lms_malla_curso.id_malla='$id_malla' and tbl_lms_curso.id_empresa='$id_empresa'";
}

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeCursosSinEmpresa($id_malla, $id_clasificacion) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$filtro_clasificacion = "";
if ($id_clasificacion != "0" and $id_clasificacion != "") {
$filtro_clasificacion = " and rel_lms_malla_curso.id_clasificacion='$id_clasificacion'";
}

if ($id_malla == "0" or $id_malla == "") {
$sql = "SELECT tbl_lms_curso.*
FROM tbl_lms_curso
INNER JOIN rel_lms_malla_curso
ON rel_lms_malla_curso.id_curso=tbl_lms_curso.id    $filtro_clasificacion


GROUP BY tbl_lms_curso.id";
} else if ($id_malla == "-1") {
$sql = "SELECT tbl_lms_curso.* FROM tbl_lms_curso  GROUP BY tbl_lms_curso.id order by tbl_lms_curso.nombre";
} else {
$sql = "SELECT tbl_lms_curso.* FROM tbl_lms_curso INNER JOIN rel_lms_malla_curso ON rel_lms_malla_curso.id_curso=tbl_lms_curso.id  $filtro_clasificacion
WHERE rel_lms_malla_curso.id_malla='$id_malla'
";
}

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ENC_TraigoEncuestasFinalizadas($id_empresa, $arreglo_objetos) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$i = 1;
foreach ($arreglo_objetos as $arr) {
if ($i == 1) {
$filtro_codigo_inscripcion .= "and (";
}
$filtro_codigo_inscripcion .= "h.id_inscripcion='" . $arr->codigo_inscripcion . "' ";
if ($i == count($arreglo_objetos)) {
$filtro_codigo_inscripcion .= " )";
} else {
$filtro_codigo_inscripcion .= " or ";
}
$i++;
}

$sql = "select * , tbl_usuario.nombre_completo as nombre, tbl_usuario.rut_completo, tbl_usuario.cargo,


tbl_usuario.gerencia as c1,
tbl_usuario.gerenciaR2 as c2,
tbl_usuario.gerenciaR3 as c3,
nota as nota_cierre
, tbl_inscripcion_cierre.estado as estado_cierre,
tbl_inscripcion_cierre.estado as estado_cierre,
porcentaje_asistencia



from tbl_inscripcion_usuarios h

inner join tbl_usuario
on tbl_usuario.rut=h.rut

left join tbl_inscripcion_cierre
on tbl_inscripcion_cierre.rut=h.rut  and
h.id_inscripcion=tbl_inscripcion_cierre.id_inscripcion


where h.id_empresa='$id_empresa'  $filtro_codigo_inscripcion  group by h.rut";

//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function VerificaEncSatFinalizada($rut, $id_imparticion, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

//echo "$rut, $id_imparticion, $id_empresa";

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
SELECT h.*, (select id_curso from tbl_objeto where id=h.id_objeto limit 1) as id_curso

FROM tbl_enc_satis_finalizados h where h.rut='$rut' and h.id_empresa='$id_empresa'
and (select id_curso from tbl_objeto where id=h.id_objeto limit 1) ='$id_imparticion'

";

//echo "<br>";
//echo $sql;
//exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ENC_TraigoEncuestasFinalizadasDetalle($id_empresa, $id_objeto, $id_encuesta, $id_curso) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
if ($id_curso != '') {
$sql = "
select h.rut,h.fecha,(select rut_completo from tbl_usuario where rut=h.rut) as rut_completo,
(select nombre_completo from tbl_usuario where rut=h.rut) as nombre,
(select cargo from tbl_usuario where rut=h.rut) as cargo,
(select gerencia from tbl_usuario where rut=h.rut) as gerencia,
(select nombre from tbl_lms_curso where id='$id_curso') as curso,
(select id from tbl_lms_curso where id='$id_curso') as idcurso,

h.respuesta,
(select pregunta from tbl_enc_satis_preg where idpregunta=h.id_pregunta limit 1) as pregunta

from tbl_enc_satis_respuestas h

where h.id_objeto='$id_objeto'

";
}
//echo $sql; exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}
function ENC_TraigoParticipantesInscritos($id_empresa, $id_objeto, $id_encuesta, $id_curso) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($id_curso == 0) {
$query_C = "";
} else {
$query_C = " and (select id_curso from tbl_inscripcion_curso where codigo_inscripcion=h.id_inscripcion)='$id_curso' ";
}
$sql = "

select h.*,
(select nombre from tbl_lms_curso where id=h.id_curso) as nombrecurso,
(select fecha_inicio  from tbl_inscripcion_curso where codigo_inscripcion=h.id_inscripcion) as fecha_inicio,
(select fecha_termino from tbl_inscripcion_curso where codigo_inscripcion=h.id_inscripcion) as fecha_termino,

(select rut_completo from tbl_usuario where rut=h.rut) as rut_completo,
(select nombre_completo from tbl_usuario where rut=h.rut) as nombre,
(select cargo from tbl_usuario where rut=h.rut) as cargo,
(select gerencia from tbl_usuario where rut=h.rut) as gerencia,
(select email from tbl_usuario where rut=h.rut) as email,
(select jefe from tbl_usuario where rut=h.rut) as jefatura,
(select nombre from tbl_usuario where rut=(select jefe from tbl_usuario where rut=h.rut)) as nombre_jefe,
(select email from tbl_usuario where rut=(select jefe from tbl_usuario where rut=h.rut)) as email_jefe

from tbl_inscripcion_usuarios h where h.id_empresa='$id_empresa'
$query_C
order by h.id_inscripcion

";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TraeCursos_con_Enc_sat($id_malla, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

//echo "$id_malla,$id_empresa";

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($id_malla == "0") {
$sql = "SELECT tbl_lms_curso.* FROM tbl_lms_curso INNER JOIN rel_lms_malla_curso ON rel_lms_malla_curso.id_curso=tbl_lms_curso.id WHERE
tbl_lms_curso.id_empresa='$id_empresa'
AND (select count(id) as cuentaencuestas from tbl_objeto where id_curso=tbl_lms_curso.id and tipo_objeto='6')>0
GROUP BY tbl_lms_curso.id order by tbl_lms_curso.nombre";

$sql = "SELECT
tbl_lms_curso.*,

(SELECT         count(id)AS cuentaencuestas     FROM         tbl_objeto     WHERE         id_curso = tbl_lms_curso.id     AND tipo_objeto = '6' ) as encuesta_eleaning

FROM
tbl_lms_curso
WHERE
tbl_lms_curso.id_empresa = '$id_empresa' and (SELECT         count(id)AS cuentaencuestas     FROM         tbl_objeto     WHERE         id_curso = tbl_lms_curso.id     AND tipo_objeto = '6' )>0

GROUP BY
tbl_lms_curso.id
ORDER BY
tbl_lms_curso.nombre";
} else if ($id_malla == "-1") {
$sql = "SELECT tbl_lms_curso.* FROM tbl_lms_curso
WHERE tbl_lms_curso.id_empresa='$id_empresa'
AND (select count(id) as cuentaencuestas from tbl_objeto where id_curso=tbl_lms_curso.id and tipo_objeto='6')>0
GROUP BY tbl_lms_curso.id order by tbl_lms_curso.nombre";

$sql = "SELECT
tbl_lms_curso.*,

(SELECT         count(id)AS cuentaencuestas     FROM         tbl_objeto     WHERE         id_curso = tbl_lms_curso.id     AND tipo_objeto = '6' ) as encuesta_eleaning

FROM
tbl_lms_curso
WHERE
tbl_lms_curso.id_empresa = '$id_empresa' and (SELECT         count(id)AS cuentaencuestas     FROM         tbl_objeto     WHERE         id_curso = tbl_lms_curso.id     AND tipo_objeto = '6' )>0

GROUP BY
tbl_lms_curso.id
ORDER BY
tbl_lms_curso.nombre";
} else {

$sql = "SELECT tbl_lms_curso.* FROM tbl_lms_curso INNER JOIN rel_lms_malla_curso ON rel_lms_malla_curso.id_curso=tbl_lms_curso.id
WHERE rel_lms_malla_curso.id_malla='$id_malla' and tbl_lms_curso.id_empresa='$id_empresa'
AND (select count(id) as cuentaencuestas from tbl_objeto where id_curso=tbl_lms_curso.id and tipo_objeto='6')>0
order by tbl_lms_curso.nombre
";

$sql = "SELECT
tbl_lms_curso.*,

(SELECT         count(id)AS cuentaencuestas     FROM         tbl_objeto     WHERE         id_curso = tbl_lms_curso.id     AND tipo_objeto = '6' ) as encuesta_eleaning

FROM
tbl_lms_curso
WHERE
tbl_lms_curso.id_empresa = '$id_empresa' and (SELECT         count(id)AS cuentaencuestas     FROM         tbl_objeto     WHERE         id_curso = tbl_lms_curso.id     AND tipo_objeto = '6' )>0

GROUP BY
tbl_lms_curso.id
ORDER BY
tbl_lms_curso.nombre";
}

$sql = "select h.id_curso as id,
(select nombre from tbl_lms_curso where id=h.id_curso limit 1) as nombre,

(
SELECT
count(id) AS cuentaencuestas
FROM
tbl_objeto
WHERE
id_curso = h.codigo_inscripcion
AND tipo_objeto = '6'
) AS encuesta_eleaning


from tbl_inscripcion_curso h

where h.id_empresa = '$id_empresa' and

(
SELECT
count(id) AS cuentaencuestas
FROM
tbl_objeto
WHERE
id_curso = h.codigo_inscripcion
AND tipo_objeto = '6'
) >0
group by h.id_curso
order by (select nombre from tbl_lms_curso where id=h.id_curso limit 1)

";

//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TraeCursos_con_Enc_satjEFE($id_malla, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

//echo "$id_malla,$id_empresa";

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($id_malla == "0") {
if ($id_empresa == '62') {
$sql = "SELECT tbl_lms_curso.* FROM tbl_lms_curso INNER JOIN rel_lms_malla_curso ON rel_lms_malla_curso.id_curso=tbl_lms_curso.id
WHERE rel_lms_malla_curso.id_malla='$id_malla' and tbl_lms_curso.id_empresa='$id_empresa'

order by tbl_lms_curso.nombre
";
} else {

$sql = "SELECT tbl_lms_curso.* FROM tbl_lms_curso INNER JOIN rel_lms_malla_curso ON rel_lms_malla_curso.id_curso=tbl_lms_curso.id WHERE
tbl_lms_curso.id_empresa='$id_empresa'
and tbl_lms_curso.proveedor is not null

GROUP BY tbl_lms_curso.id order by tbl_lms_curso.nombre";
}
} else if ($id_malla == "-1") {
if ($id_empresa == '62') {
$sql = "SELECT tbl_lms_curso.* FROM tbl_lms_curso
WHERE  tbl_lms_curso.id_empresa='$id_empresa'
order by tbl_lms_curso.nombre
";
} else {

$sql = "SELECT tbl_lms_curso.* FROM tbl_lms_curso
WHERE tbl_lms_curso.id_empresa='$id_empresa'
and tbl_lms_curso.proveedor is not null
GROUP BY tbl_lms_curso.id order by tbl_lms_curso.nombre";
}
} else {
if ($id_empresa == '62') {
$sql = "SELECT tbl_lms_curso.* FROM tbl_lms_curso INNER JOIN rel_lms_malla_curso ON rel_lms_malla_curso.id_curso=tbl_lms_curso.id
WHERE rel_lms_malla_curso.id_malla='$id_malla' and tbl_lms_curso.id_empresa='$id_empresa'

order by tbl_lms_curso.nombre
";
} else {

$sql = "SELECT tbl_lms_curso.* FROM tbl_lms_curso INNER JOIN rel_lms_malla_curso ON rel_lms_malla_curso.id_curso=tbl_lms_curso.id
WHERE rel_lms_malla_curso.id_malla='$id_malla' and tbl_lms_curso.id_empresa='$id_empresa'
AND (select count(id) as cuentaencuestas from tbl_objeto where id_curso=tbl_lms_curso.id and tipo_objeto='6')>0
order by tbl_lms_curso.nombre
";
}
}
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TraeCursos_con_InscripcionMod5($id_malla, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($id_malla == "0") {
$sql = "SELECT tbl_lms_curso.* FROM tbl_lms_curso INNER JOIN rel_lms_malla_curso ON rel_lms_malla_curso.id_curso=tbl_lms_curso.id WHERE
tbl_lms_curso.id_empresa='$id_empresa'
AND tbl_lms_curso.modalidad='5'
GROUP BY tbl_lms_curso.id order by tbl_lms_curso.id";} else if ($id_malla == "-1") {
$sql = "SELECT tbl_lms_curso.* FROM tbl_lms_curso
WHERE tbl_lms_curso.id_empresa='$id_empresa'
AND tbl_lms_curso.modalidad='5'
GROUP BY tbl_lms_curso.id order by tbl_lms_curso.id";
} else {
$sql = "SELECT tbl_lms_curso.* FROM tbl_lms_curso INNER JOIN rel_lms_malla_curso ON rel_lms_malla_curso.id_curso=tbl_lms_curso.id
WHERE rel_lms_malla_curso.id_malla='$id_malla' and tbl_lms_curso.id_empresa='$id_empresa'
AND  tbl_lms_curso.modalidad='5'
order by tbl_lms_curso.id
";
}
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TraeObjetos($id_curso, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT tbl_objeto.* FROM tbl_objeto  WHERE tbl_objeto.id_curso='$id_curso' and tbl_objeto.id_empresa='$id_empresa'  ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeCursosActivos($id_malla, $id_empresa, $id_curso) {
//echo "$id_malla,$id_empresa, $id_curso";
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

//echo "$id_malla==0 && $id_curso==0";

if ($id_malla == '0' && $id_curso == '0') {
$sql = "SELECT tbl_lms_curso.*, id_malla, id_clasificacion
FROM tbl_lms_curso INNER JOIN rel_lms_malla_curso
ON rel_lms_malla_curso.id_curso=tbl_lms_curso.id WHERE tbl_lms_curso.id_empresa='$id_empresa' and rel_lms_malla_curso.opcional is null
and  rel_lms_malla_curso.inactivo='0'
GROUP BY tbl_lms_curso.id";
//echo "$sql 1";exit;
} else if ($id_malla != '0' && $id_curso == '0') {
$sql = "SELECT tbl_lms_curso.*, id_malla, id_clasificacion FROM tbl_lms_curso INNER JOIN rel_lms_malla_curso ON rel_lms_malla_curso.id_curso=tbl_lms_curso.id
WHERE rel_lms_malla_curso.id_malla='$id_malla'
and rel_lms_malla_curso.opcional is null
and  rel_lms_malla_curso.inactivo='0'
and tbl_lms_curso.id_empresa='$id_empresa'";
//echo "$sql 2";exit;
} else if ($id_malla != '0' && $id_curso != '0') {
$sql = "SELECT tbl_lms_curso.*, id_malla, id_clasificacion
FROM tbl_lms_curso
INNER JOIN rel_lms_malla_curso ON rel_lms_malla_curso.id_curso=tbl_lms_curso.id
WHERE rel_lms_malla_curso.id_malla='$id_malla'
and rel_lms_malla_curso.id_curso='$id_curso'
and rel_lms_malla_curso.opcional is null
and  rel_lms_malla_curso.inactivo='0'
and tbl_lms_curso.id_empresa='$id_empresa'
group by rel_lms_malla_curso.id_curso
";
//echo "$sql 3";exit;
} else if ($id_malla == '0' && $id_curso != '0') {
$sql = "SELECT tbl_lms_curso.*, id_malla, id_clasificacion FROM tbl_lms_curso
INNER JOIN rel_lms_malla_curso ON rel_lms_malla_curso.id_curso=tbl_lms_curso.id
WHERE rel_lms_malla_curso.id_curso='$id_curso'
and rel_lms_malla_curso.opcional is null
and  rel_lms_malla_curso.inactivo='0'
and tbl_lms_curso.id_empresa='$id_empresa'
group by rel_lms_malla_curso.id_curso
";
//echo "$sql 4";exit;
}

//echo "$sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeCursosActivosSinEmpresa($id_malla, $id_curso) {
//echo "$id_malla,$id_empresa, $id_curso";
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

//echo "$id_malla==0 && $id_curso==0";

if ($id_malla == '0' && $id_curso == '0') {
$sql = "SELECT tbl_lms_curso.*, id_malla, id_clasificacion
FROM tbl_lms_curso INNER JOIN rel_lms_malla_curso
ON rel_lms_malla_curso.id_curso=tbl_lms_curso.id
WHERE tbl_lms_curso.id=tbl_lms_curso.id  and rel_lms_malla_curso.opcional is null
and  rel_lms_malla_curso.inactivo='0'
GROUP BY tbl_lms_curso.id";
//echo "$sql 1";exit;
} else if ($id_malla != '0' && $id_curso == '0') {
$sql = "SELECT tbl_lms_curso.*, id_malla, id_clasificacion FROM tbl_lms_curso INNER JOIN rel_lms_malla_curso ON rel_lms_malla_curso.id_curso=tbl_lms_curso.id
WHERE rel_lms_malla_curso.id_malla='$id_malla'
and rel_lms_malla_curso.opcional is null
and  rel_lms_malla_curso.inactivo='0'
and tbl_lms_curso.id=tbl_lms_curso.id";
//echo "$sql 2";exit;
} else if ($id_malla != '0' && $id_curso != '0') {
$sql = "SELECT tbl_lms_curso.*, id_malla, id_clasificacion
FROM tbl_lms_curso
INNER JOIN rel_lms_malla_curso ON rel_lms_malla_curso.id_curso=tbl_lms_curso.id
WHERE rel_lms_malla_curso.id_malla='$id_malla'
and rel_lms_malla_curso.id_curso='$id_curso'
and rel_lms_malla_curso.opcional is null
and  rel_lms_malla_curso.inactivo='0'
and tbl_lms_curso.id=tbl_lms_curso.id
group by rel_lms_malla_curso.id_curso
";
//echo "$sql 3";exit;
} else if ($id_malla == '0' && $id_curso != '0') {
$sql = "SELECT tbl_lms_curso.*, id_malla, id_clasificacion FROM tbl_lms_curso
INNER JOIN rel_lms_malla_curso ON rel_lms_malla_curso.id_curso=tbl_lms_curso.id
WHERE rel_lms_malla_curso.id_curso='$id_curso'
and rel_lms_malla_curso.opcional is null
and  rel_lms_malla_curso.inactivo='0'
and tbl_lms_curso.id=tbl_lms_curso.id
group by rel_lms_malla_curso.id_curso
";
//echo "$sql 4";exit;
}

echo "$sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeCursosSinMallaActivos($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT tbl_lms_curso.*

FROM tbl_lms_curso

where

tbl_lms_curso.opcional is null
and  tbl_lms_curso.inactivo='0'
and tbl_lms_curso.id_empresa='$id_empresa'";

//echo $sql;Exit;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeUsuariosEmpresa($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT
tbl_usuario.*,rel_lms_malla_persona.id_malla
FROM
tbl_usuario
INNER JOIN rel_lms_malla_persona ON rel_lms_malla_persona.rut = tbl_usuario.rut
INNER JOIN tbl_lms_malla on tbl_lms_malla.id=rel_lms_malla_persona.id_malla
WHERE
tbl_usuario.id_empresa = '$id_empresa' and tbl_lms_malla.id_empresa='$id_empresa' AND tbl_usuario.vigencia = '0'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeUsuariosCommboIn($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT *
FROM
tbl_usuario
WHERE
id_empresa = '$id_empresa' AND vigencia = 0";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function InsertaInscripcionCurso($id_malla, $id_curso, $id_empresa, $prefijo_) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO tbl_inscripcion_curso(id_malla, id_curso,id_empresa,codigo_inscripcion) " .
"VALUES ('$id_malla', '$id_curso', '$id_empresa', '$prefijo_');";

$database->setquery($sql);
$database->query();
}

function InsertaInscripcionUsuario($rut, $id_curso, $empresa, $pref) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO tbl_inscripcion_usuarios(rut,id_curso,id_empresa,id_inscripcion) " .
"VALUES ('$rut', '$id_curso', '$empresa', '$pref');";
$database->setquery($sql);
$database->query();
}

function TotalCursosEmpresa2($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT DISTINCTROW tbl_lms_curso.id,tbl_lms_curso.nombre,tbl_lms_clasificacion.clasificacion,tbl_lms_clasificacion.id_clasificacion FROM tbl_lms_curso
LEFT JOIN rel_lms_malla_curso ON rel_lms_malla_curso.id_curso =tbl_lms_curso.id INNER JOIN tbl_lms_clasificacion ON tbl_lms_clasificacion.id_clasificacion=rel_lms_malla_curso.id_clasificacion
WHERE
( rel_lms_malla_curso.id_curso Is Null) AND tbl_lms_curso.id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TotalCursosEmpresa3($id_empresa, $id_malla) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT DISTINCTROW tbl_lms_curso.id,tbl_lms_curso.nombre,tbl_lms_clasificacion.clasificacion,tbl_lms_clasificacion.id_clasificacion FROM tbl_lms_curso
LEFT JOIN rel_lms_malla_curso ON rel_lms_malla_curso.id_curso =tbl_lms_curso.id  and rel_lms_malla_curso.id_malla='$id_malla'
INNER JOIN tbl_lms_clasificacion ON tbl_lms_clasificacion.id_clasificacion=rel_lms_malla_curso.id_clasificacion
WHERE
( rel_lms_malla_curso.id_curso Is Null) AND tbl_lms_curso.id_empresa='$id_empresa' ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ActualizaIncripcion($id_empresa, $rut, $id_curso, $id_mall) {
global $c_host, $c_user, $c_pass, $c_db;
$fecha = date("Y-m-d");
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "UPDATE tbl_lms_clasificacion SET id_clasificacion= '$id_clasificacion', clasificacion='$clasificacion', color='$color', imagen='$imagen', imagen_back='$imagen_back', fecha_actualizacion='$fecha' WHERE id = '$id'";

$database->setquery($sql);
$database->query();
}

function Ultima_incripcion($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select MAX(codigo_inscripcion) as codigo_inscripcion from tbl_inscripcion_curso where id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod[0]->codigo_inscripcion;
}

function InsertaInscripcionMallaCurso($id_malla, $id_curso, $id_empresa, $prefijo_) {
$id = Ultima_incripcion($id_empresa);
eregi('^([a-z]+)([0-9]+)$', $id, $arreglo);

$pref = $prefijo_ . "" . ($arreglo[2] + 1);

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO tbl_inscripcion_curso(id_malla, id_curso,id_empresa,codigo_inscripcion) " .
"VALUES ('$id_malla', '$id_curso', '$id_empresa', '$pref');";

$database->setquery($sql);
$database->query();
}

function Datos_curso($id) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_lms_curso WHERE id='$id'";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function Datos_objeto($id) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_objeto WHERE id='$id'";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ordena_campo($anterior, $orden, $tabla, $campo, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$fecha = date("Y-m-d");
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE " . $tabla . " SET " . $campo . "= '$anterior',temp='1' WHERE " . $campo . " = '$orden' AND id_empresa='$id_empresa'";
$database->setquery($sql);
$database->query();

$sql1 = "UPDATE " . $tabla . " SET " . $campo . "= '$orden',temp='0' WHERE " . $campo . " = '$anterior' AND id_empresa='$id_empresa' AND temp='0'";
$database->setquery($sql1);
$database->query();

$sql1 = "UPDATE " . $tabla . " SET temp='0' WHERE id_empresa='$id_empresa'";
$database->setquery($sql1);
$database->query();
}

function ordena_campo_curso($anterior, $orden, $tabla, $campo, $id_empresa, $id_malla, $id_clasificacion) {
global $c_host, $c_user, $c_pass, $c_db;
$fecha = date("Y-m-d");
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE " . $tabla . " SET " . $campo . "= '$anterior',temp='1' WHERE " . $campo . " = '$orden' AND id_empresa='$id_empresa' AND id_malla='$id_malla' AND id_clasificacion='$id_clasificacion'";
$database->setquery($sql);
$database->query();

$sql1 = "UPDATE " . $tabla . " SET " . $campo . "= '$orden',temp='0' WHERE " . $campo . " = '$anterior' AND id_empresa='$id_empresa' AND id_clasificacion='$id_clasificacion' AND id_malla='$id_malla' AND temp='0'";
$database->setquery($sql1);
$database->query();

$sql1 = "UPDATE " . $tabla . " SET temp='0' WHERE id_empresa='$id_empresa' AND id_malla='$id_malla'";
$database->setquery($sql1);
$database->query();
}

function ordena_campo_clasificacion($anterior, $orden, $tabla, $campo, $id_empresa, $id_malla, $id_clasificacion) {
global $c_host, $c_user, $c_pass, $c_db;
$fecha = date("Y-m-d");
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE " . $tabla . " SET " . $campo . "= '$anterior',temp='1' WHERE " . $campo . " = '$orden' AND id_empresa='$id_empresa' AND id_malla='$id_malla'";
$database->setquery($sql);
$database->query();

$sql1 = "UPDATE " . $tabla . " SET " . $campo . "= '$orden',temp='0' WHERE " . $campo . " = '$anterior' AND id_empresa='$id_empresa' AND id_clasificacion='$id_clasificacion' AND id_malla='$id_malla' AND temp='0'";
$database->setquery($sql1);
$database->query();

$sql1 = "UPDATE " . $tabla . " SET temp='0' WHERE id_empresa='$id_empresa' AND id_malla='$id_malla'";
$database->setquery($sql1);
$database->query();
}

function Datos_Malla($id) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_lms_malla where id='$id'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function Cuenta_Mallas($id_empresa, $id_malla) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
if ($id_malla) {
$sql_filtro_malla = " and id='$id_malla'";
}
$sql = "select * from tbl_lms_malla where id_empresa='$id_empresa' $sql_filtro_malla";

$database->setquery($sql);
$database->query();
return $database->counterResult();
}

function ActualizaMalla2($codigo, $nombre_malla, $descripcion_malla, $tipo_malla, $certificable, $ponderacion, $tipo_fecha, $id_malla, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "UPDATE tbl_lms_malla SET id='$codigo', nombre= '$nombre_malla', descripcion='$descripcion_malla', tipo='$tipo_malla', certificable='$certificable', ponderacion='$ponderacion', tipo_fecha='$tipo_fecha'   WHERE id = '$id_malla' AND id_empresa='$id_empresa'";
$database->setquery($sql);
$database->query();
}



function TotalCursosParaPaginacionT($id_empresa, $id_curso, $llamada) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$filtro = "";
if ($id_curso) {
$sql_id_curso = " and tbl_lms_curso.id='$id_curso'";
}
if ($llamada == "imparticion_solo_preenciales") {
$sql_presenciales = " and tbl_lms_curso.modalidad='4'";
}
$sql = "
SELECT

tbl_lms_curso.*, tbl_modalidad_curso.modalidad AS nombre_modalidad,
tbl_lms_foco.descripcion AS nombre_foco,
tbl_lms_programas_bbdd.nombre_programa,
tbl_otec.nombre AS nombre_otec,
(select count(*)as total from tbl_inscripcion_curso where tbl_inscripcion_curso.id_curso=tbl_lms_curso.id ) as total_inscripciones_curso,
(SELECT COUNT(DISTINCT(rel_lms_malla_curso.id_programa))as total from rel_lms_malla_curso where rel_lms_malla_curso.id_curso=tbl_lms_curso.id and rel_lms_malla_curso.id_programa is not null) as total_programas,
(select count(DISTINCT(rut)) from tbl_inscripcion_postulantes where id_curso=tbl_lms_curso.id)  as postulantes,
(select count(DISTINCT(rut)) from tbl_inscripcion_postulantes where id_curso=tbl_lms_curso.id and preinscrito='PREINSCRITO')  as preinscritos,
(select count(DISTINCT(rut)) from tbl_inscripcion_usuarios where id_curso=tbl_lms_curso.id)  as inscritos,
(SELECT    ejecutivo    FROM    tbl_inscripcion_curso    WHERE        tbl_inscripcion_curso.id_curso = tbl_lms_curso.id limit 1) AS rut_ejecutivo,
(select nombre_completo from tbl_usuario where rut=(SELECT    ejecutivo    FROM    tbl_inscripcion_curso    WHERE        tbl_inscripcion_curso.id_curso = tbl_lms_curso.id limit 1)) as ejecutivo

FROM tbl_lms_curso

LEFT JOIN tbl_modalidad_curso ON tbl_lms_curso.modalidad = tbl_modalidad_curso.id
LEFT JOIN tbl_otec ON tbl_otec.rut = tbl_lms_curso.rut_otec
LEFT JOIN tbl_lms_foco ON tbl_lms_foco.codigo_foco = tbl_lms_curso.id_foco
AND tbl_lms_foco.id_empresa = '$id_empresa'
LEFT JOIN tbl_lms_programas_bbdd ON tbl_lms_programas_bbdd.id_programa = tbl_lms_curso.id_empresa_programa
AND tbl_lms_programas_bbdd.id_empresa = '$id_empresa'

WHERE

tbl_lms_curso.activo = 0
and tbl_modalidad_curso.modalidad='e_p_f'
AND tbl_lms_curso.id_empresa = '$id_empresa' $sql_id_curso $sql_presenciales

ORDER BY

tbl_lms_curso.id_correlativo DESC";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TotalCursosParaPaginacion2Elearning($id_empresa, $id_curso, $llamada) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$filtro = "";
if ($id_curso) {
$sql_id_curso = " and h.id='$id_curso' ";
}

if ($llamada == "imparticion_solo_preenciales") {
$sql_presenciales = " and tbl_lms_curso.modalidad='2'";
}

$sql = "

SELECT

tbl_lms_curso.*, tbl_modalidad_curso.modalidad AS nombre_modalidad,
tbl_lms_foco.descripcion AS nombre_foco,
tbl_lms_programas_bbdd.nombre_programa,
tbl_lms_programas_bbdd.id_programa,
tbl_otec.nombre AS nombre_otec,

(select count(*)as total from tbl_inscripcion_curso where tbl_inscripcion_curso.id_curso=tbl_lms_curso.id ) as total_inscripciones_curso,
(SELECT COUNT(DISTINCT(rel_lms_malla_curso.id_programa))as total from rel_lms_malla_curso where rel_lms_malla_curso.id_curso=tbl_lms_curso.id and rel_lms_malla_curso.id_programa is not null) as total_programas,
(SELECT ejecutivo    FROM    tbl_inscripcion_curso    WHERE        tbl_inscripcion_curso.id_curso = tbl_lms_curso.id limit 1) AS rut_ejecutivo,
(select count(DISTINCT(rut)) from tbl_inscripcion_postulantes where id_curso=tbl_lms_curso.id)  as postulantes,
(select count(DISTINCT(rut)) from tbl_inscripcion_postulantes where id_curso=tbl_lms_curso.id and preinscrito='PREINSCRITO')  as preinscritos,
(select count(DISTINCT(rut)) from tbl_inscripcion_usuarios where id_curso=tbl_lms_curso.id)  as inscritos,
(select nombre_completo from tbl_usuario where rut=(SELECT    ejecutivo    FROM    tbl_inscripcion_curso    WHERE        tbl_inscripcion_curso.id_curso = tbl_lms_curso.id limit 1)) as ejecutivo

FROM

tbl_lms_curso

LEFT JOIN tbl_modalidad_curso ON tbl_lms_curso.modalidad = tbl_modalidad_curso.id
LEFT JOIN tbl_otec ON tbl_otec.rut = tbl_lms_curso.rut_otec
LEFT JOIN tbl_lms_foco ON tbl_lms_foco.codigo_foco = tbl_lms_curso.id_foco
AND tbl_lms_foco.id_empresa = '$id_empresa'
LEFT JOIN tbl_lms_programas_bbdd ON tbl_lms_programas_bbdd.id_programa = tbl_lms_curso.id_empresa_programa
AND tbl_lms_programas_bbdd.id_empresa = '$id_empresa'

WHERE

tbl_lms_curso.activo = 0
and tbl_modalidad_curso.modalidad='Elearning'
AND tbl_lms_curso.id_empresa = '$id_empresa' $sql_id_curso $sql_presenciales

ORDER BY

tbl_lms_curso.id_correlativo DESC";

$sql = "

select h.*,

(select ejecutivo from tbl_inscripcion_curso where id_curso=h.id and ejecutivo<>'' limit 1 ) as rut_ejecutivo,

(select nombre_completo from tbl_usuario where rut=(select ejecutivo from tbl_inscripcion_curso where id_curso=h.id and ejecutivo<>'' limit 1 )) as ejecutivo,
(select modalidad from tbl_modalidad_curso where id=h.modalidad) as modalidadcurso,

(select descripcion from tbl_lms_foco where codigo_foco=h.id_foco) as foco,
(select nombre_programa from tbl_lms_programas_bbdd where id_programa=h.id_empresa_programa) as programa_global


from tbl_lms_curso h where h.id_empresa='$id_empresa' and (h.modalidad<>'2')

$sql_id_curso $sql_presenciales

order by h.id_correlativo DESC ";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function BuscaIdImparticiondadoCursoT($id_curso, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.codigo_inscripcion
from tbl_inscripcion_curso h
where h.id_curso='$id_curso' and h.id_empresa='$id_empresa'
and (select modalidad from tbl_lms_curso where id=h.id_curso limit 1)='4'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function BuscaAsistentesCursoImparticion($id_curso, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select COUNT(DISTINCT(h.rut)) as asistentes,


(select id_curso from tbl_inscripcion_curso where codigo_inscripcion=h.codigo_imparticion limit 1)
from rel_lms_inscripcion_usuario_checkin h where



(select id_curso from tbl_inscripcion_curso where codigo_inscripcion=h.codigo_imparticion limit 1) ='$id_curso'";
//echo "<br>$sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function BuscaAsistentesImparticion($id_imparticion, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select COUNT(DISTINCT(h.rut)) as asistentes from tbl_inscripcion_usuarios h where h.id_inscripcion='$id_imparticion'";

//echo "<br>BuscaAsistentesImparticion $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TotalMallaClasificacion($id_malla, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select  distinct(rel_lms_malla_curso.id_clasificacion),tbl_lms_clasificacion.clasificacion as nombre_clasificacion,rel_lms_malla_curso.orden_clasificacion from tbl_lms_curso    inner join rel_lms_malla_curso on rel_lms_malla_curso.id_curso=tbl_lms_curso.id INNER JOIN tbl_lms_clasificacion on tbl_lms_clasificacion.id_clasificacion=rel_lms_malla_curso.id_clasificacion where tbl_lms_curso.id_empresa='$id_empresa' and rel_lms_malla_curso.id_malla='$id_malla'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TotalMallaClasificacionCurso($id_malla, $id_clasificacion, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT tbl_lms_curso.nombre as nombre,rel_lms_malla_curso.orden_curso,tbl_lms_curso.id
FROM
tbl_lms_curso
INNER JOIN rel_lms_malla_curso ON rel_lms_malla_curso.id_curso = tbl_lms_curso.id
INNER JOIN tbl_lms_clasificacion on tbl_lms_clasificacion.id_clasificacion=rel_lms_malla_curso.id_clasificacion
WHERE
tbl_lms_curso.id_empresa = '$id_empresa'
AND rel_lms_malla_curso.id_malla = '$id_malla'
AND rel_lms_malla_curso.id_clasificacion='$id_clasificacion' ORDER BY rel_lms_malla_curso.orden_curso ASC";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function CuentaTotalMallaClasificacion($id_malla, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select  distinct(rel_lms_malla_curso.id_clasificacion),tbl_lms_clasificacion.clasificacion as nombre_clasificacion,rel_lms_malla_curso.orden_clasificacion from tbl_lms_curso    inner join rel_lms_malla_curso on rel_lms_malla_curso.id_curso=tbl_lms_curso.id INNER JOIN tbl_lms_clasificacion on tbl_lms_clasificacion.id_clasificacion=rel_lms_malla_curso.id_clasificacion where tbl_lms_curso.id_empresa='$id_empresa' and rel_lms_malla_curso.id_malla='$id_malla'";
$database->setquery($sql);
$database->query();
return $database->counterResult();
}

function CuentaTotalMallaClasificacionCurso($id_malla, $id_empresa, $id_clasificacion) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT tbl_lms_curso.nombre as nombre,rel_lms_malla_curso.orden_curso,tbl_lms_curso.id
FROM
tbl_lms_curso
INNER JOIN rel_lms_malla_curso ON rel_lms_malla_curso.id_curso = tbl_lms_curso.id
INNER JOIN tbl_lms_clasificacion on tbl_lms_clasificacion.id_clasificacion=rel_lms_malla_curso.id_clasificacion
WHERE
tbl_lms_curso.id_empresa = '$id_empresa'
AND rel_lms_malla_curso.id_malla = '$id_malla'
AND rel_lms_malla_curso.id_clasificacion='$id_clasificacion' ORDER BY rel_lms_malla_curso.orden_curso ASC";

$database->setquery($sql);
$database->query();
return $database->counterResult();
}

function TotalMallas2($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_lms_malla where id_empresa='$id_empresa' ORDER BY orden DESC;";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TotalClasif($id_empresa, $id_malla) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT
h.*,
(select clasificacion from tbl_lms_clasificacion where id_clasificacion=h.id_clasificacion and id_empresa=h.id_empresa) as nombre,
(select descripcion from tbl_lms_clasificacion where id_clasificacion=h.id_clasificacion and id_empresa=h.id_empresa) as descripcion,
(select imagen from tbl_lms_clasificacion where id_clasificacion=h.id_clasificacion and id_empresa=h.id_empresa) as imagen,
(select opcional from tbl_lms_clasificacion where id_clasificacion=h.id_clasificacion and id_empresa=h.id_empresa) as opcional,
(select inactivo from tbl_lms_clasificacion where id_clasificacion=h.id_clasificacion and id_empresa=h.id_empresa) as inactivo
FROM
rel_lms_malla_curso h
WHERE
h.id_empresa = '$id_empresa'
AND h.id_malla = '$id_malla'
GROUP BY
h.id_clasificacion
ORDER BY
h.orden_clasificacion ASC;";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

//echo $sql;

return $cod;
}

function TotalClasifSinVacios($id_empresa, $id_malla) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT
h.*,
(select clasificacion from tbl_lms_clasificacion where id_clasificacion=h.id_clasificacion and id_empresa=h.id_empresa) as nombre,
(select descripcion from tbl_lms_clasificacion where id_clasificacion=h.id_clasificacion and id_empresa=h.id_empresa) as descripcion,
(select imagen from tbl_lms_clasificacion where id_clasificacion=h.id_clasificacion and id_empresa=h.id_empresa) as imagen,
(select opcional from tbl_lms_clasificacion where id_clasificacion=h.id_clasificacion and id_empresa=h.id_empresa) as opcional,
(select inactivo from tbl_lms_clasificacion where id_clasificacion=h.id_clasificacion and id_empresa=h.id_empresa) as inactivo
FROM
rel_lms_malla_curso h
WHERE
h.id_empresa = '$id_empresa'
AND h.id_malla = '$id_malla'
and h.id_clasificacion<>''
GROUP BY
h.id_clasificacion
ORDER BY
h.orden_clasificacion ASC;";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

//echo $sql;

return $cod;
}

function TotalCurso($id_empresa, $id_malla, $id_clasificacion) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT
h.*,(        SELECT            nombre        FROM            tbl_lms_curso        WHERE            id_curso = tbl_lms_curso.id        AND id_empresa = h.id_empresa    )AS nombre,
(        SELECT            descripcion        FROM            tbl_lms_curso        WHERE            tbl_lms_curso.id = h.id_curso        AND id_empresa = h.id_empresa    )AS descripcion,
(        SELECT            modalidad        FROM            tbl_lms_curso        WHERE            tbl_lms_curso.id = h.id_curso        AND id_empresa = h.id_empresa    )AS modalidad,
(        SELECT            tipo        FROM            tbl_lms_curso        WHERE            tbl_lms_curso.id = h.id_curso        AND id_empresa = h.id_empresa    )AS tipo,
(        SELECT            imagen        FROM            tbl_lms_curso        WHERE            tbl_lms_curso.id = h.id_curso        AND id_empresa = h.id_empresa    )AS imagen,
(        SELECT            opcional        FROM            tbl_lms_curso        WHERE            tbl_lms_curso.id = h.id_curso        AND id_empresa = h.id_empresa    )AS opcional,
(        SELECT            inactivo        FROM            tbl_lms_curso        WHERE            tbl_lms_curso.id = h.id_curso        AND id_empresa = h.id_empresa    )AS inactivocurso,
(        SELECT            modalidad        FROM            tbl_modalidad_curso        WHERE            id = (        SELECT            modalidad        FROM            tbl_lms_curso        WHERE            tbl_lms_curso.id = h.id_curso        AND id_empresa = h.id_empresa    )) as nombre_modalidad


FROM
rel_lms_malla_curso h
WHERE
h.id_empresa = '$id_empresa'
AND h.id_malla = '$id_malla'
AND h.id_clasificacion = '$id_clasificacion'
GROUP BY
h.id_curso
ORDER BY
h.orden_curso ASC";

//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TotalCursoSinVacios($id_empresa, $id_malla, $id_clasificacion) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT
h.*,(        SELECT            nombre        FROM            tbl_lms_curso        WHERE            id_curso = tbl_lms_curso.id        AND id_empresa = h.id_empresa    )AS nombre,
(        SELECT            descripcion        FROM            tbl_lms_curso        WHERE            tbl_lms_curso.id = h.id_curso        AND id_empresa = h.id_empresa    )AS descripcion,
(        SELECT            modalidad        FROM            tbl_lms_curso        WHERE            tbl_lms_curso.id = h.id_curso        AND id_empresa = h.id_empresa    )AS modalidad,
(        SELECT            tipo        FROM            tbl_lms_curso        WHERE            tbl_lms_curso.id = h.id_curso        AND id_empresa = h.id_empresa    )AS tipo,
(        SELECT            imagen        FROM            tbl_lms_curso        WHERE            tbl_lms_curso.id = h.id_curso        AND id_empresa = h.id_empresa    )AS imagen,
(        SELECT            opcional        FROM            tbl_lms_curso        WHERE            tbl_lms_curso.id = h.id_curso        AND id_empresa = h.id_empresa    )AS opcional,
(        SELECT            inactivo        FROM            tbl_lms_curso        WHERE            tbl_lms_curso.id = h.id_curso        AND id_empresa = h.id_empresa    )AS inactivocurso,
(        SELECT            modalidad        FROM            tbl_modalidad_curso        WHERE            id = (        SELECT            modalidad        FROM            tbl_lms_curso        WHERE            tbl_lms_curso.id = h.id_curso        AND id_empresa = h.id_empresa    )) as nombre_modalidad


FROM
rel_lms_malla_curso h
WHERE
h.id_empresa = '$id_empresa'
AND h.id_malla = '$id_malla'
AND h.id_clasificacion = '$id_clasificacion'
and h.id_curso<>''
GROUP BY
h.id_curso
ORDER BY
h.orden_curso ASC";

//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TotalCursoSinVaciosDadoCurso($id_empresa, $id_malla, $id_curso) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT
h.*,(        SELECT            nombre        FROM            tbl_lms_curso        WHERE            id_curso = tbl_lms_curso.id        AND id_empresa = h.id_empresa    )AS nombre,
(        SELECT            descripcion        FROM            tbl_lms_curso        WHERE            tbl_lms_curso.id = h.id_curso        AND id_empresa = h.id_empresa    )AS descripcion,
(        SELECT            modalidad        FROM            tbl_lms_curso        WHERE            tbl_lms_curso.id = h.id_curso        AND id_empresa = h.id_empresa    )AS modalidad,
(        SELECT            tipo        FROM            tbl_lms_curso        WHERE            tbl_lms_curso.id = h.id_curso        AND id_empresa = h.id_empresa    )AS tipo,
(        SELECT            imagen        FROM            tbl_lms_curso        WHERE            tbl_lms_curso.id = h.id_curso        AND id_empresa = h.id_empresa    )AS imagen,
(        SELECT            opcional        FROM            tbl_lms_curso        WHERE            tbl_lms_curso.id = h.id_curso        AND id_empresa = h.id_empresa    )AS opcional,
(        SELECT            inactivo        FROM            tbl_lms_curso        WHERE            tbl_lms_curso.id = h.id_curso        AND id_empresa = h.id_empresa    )AS inactivocurso,
(        SELECT            modalidad        FROM            tbl_modalidad_curso        WHERE            id = (        SELECT            modalidad        FROM            tbl_lms_curso        WHERE            tbl_lms_curso.id = h.id_curso        AND id_empresa = h.id_empresa    )) as nombre_modalidad


FROM
rel_lms_malla_curso h
WHERE
h.id_empresa = '$id_empresa'
AND h.id_malla = '$id_malla'
AND h.id_curso = '$id_curso'
and h.id_curso<>''
GROUP BY
h.id_curso
ORDER BY
h.orden_curso ASC";

//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function InsertaUsuarioSIGA(
$rut,
$dv,
$nombre,
$apaterno,
$amaterno,
$email,
$cargo,
$centro_costo,
$id_empresa,
$nombre_completo,
$clave,
$telefono,
$nombre_jefatura,
$cargo_jefatura,
$telefono_jefatura,
$email_jefatura) {
global $c_host, $c_user, $c_pass, $c_db;
$rut_completo = $rut . "-" . $dv;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO tbl_usuario
(rut, dv, rut_completo, nombre, apaterno, amaterno,
email,    cargo, centro_costo, id_empresa,     nombre_completo,
telefono, nombre_jefatura, cargo_jefatura, telefono_jefatura, email_jefatura, id_cargo
) " .

"VALUES                 ('$rut', '$dv', '$rut_completo', '$nombre',
'$apaterno', '$amaterno', '$email',
'$cargo', '$centro_costo', '$id_empresa', '$nombre_completo', '$telefono',
'$nombre_jefatura', '$cargo_jefatura', '$telefono_jefatura', '$email_jefatura', '19'
);";

$database->setquery($sql);
$database->query();

//$sql = "INSERT INTO tbl_clave                             (rut, clave, cambiado                           ) " .        "VALUES                 ('$rut', '$clave', '0');";
$database->setquery($sql);
$database->query();
}

function ObtenerFechaDeAlta($rut) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select distinct(fecha) as fecha_alta from tbl_log_sistema where rut='$rut' and ambiente='chp'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function RevisaSiUsuarioEstaEnAutoRegistro($id_empresa, $rut) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_registro_login where rut='$rut' and id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function cuenta_likes($id_noticia) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select COUNT(*) as total  from tbl_megusta_registro where id_noticia='$id_noticia'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function SeguimientoComentariosPorCategoriaYRut($id_categoria, $rut) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "
select tbl_objeto_comentarios.*, tbl_usuario.nombre_completo as nombre_persona
from tbl_objeto_comentarios
inner join tbl_usuario
on tbl_usuario.rut=tbl_objeto_comentarios.rut
where
id_categoria='$id_categoria' and tbl_objeto_comentarios.rut='$rut'
order by tbl_objeto_comentarios.id desc
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function SeguimientoCursoCertificacionPorEmpresa($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_lms_curso where id_empresa='$id_empresa' and certificacion='1'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function DatosParaListadoPaginadoSiga($tabla, $id_empresa, $registros_por_pagina, $pagina, $arreglo_post) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($arreglo_post["gerencia"]) {
$filtro = " and tbl_usuario.gerencia='" . $arreglo_post["gerencia"] . "'";
}

if ($arreglo_post["un"]) {
$filtro .= " and tbl_usuario.unidad_negocio='" . $arreglo_post["un"] . "'";
}

if ($arreglo_post["area"]) {
$filtro .= " and tbl_usuario.area='" . $arreglo_post["area"] . "'";
}

if ($arreglo_post["filtro_empresa_holding"]) {
$filtro .= " and tbl_usuario.empresa_holding='" . $arreglo_post["filtro_empresa_holding"] . "'";
}

if ($arreglo_post["filtro_centrocosto"]) {
$filtro .= " and tbl_usuario.centro_costo='" . $arreglo_post["filtro_centrocosto"] . "'";
}

if ($arreglo_post["asc_desc"]) {
$ascdesc = $arreglo_post["asc_desc"];
}

if ($arreglo_post["orderBy"]) {
$orderBy = " order by " . $arreglo_post["orderBy"] . " " . $ascdesc;
} else {
$orderBy = " order by $tabla.id desc";
}

if ($arreglo_post["orderBy"] == "" and $tabla == "tbl_usuario") {
$orderBy = " order by apaterno asc";
}

if ($arreglo_post["orderBy"] == "" and $tabla == "tbl_otec") {
$orderBy = " order by nombre asc";
}

if ($tabla == "tbl_usuarios") {
$cruce_holding = ", tbl_empresa_holding.empresa as nombre_empresa_holding ";
$cruce_left_join_empresa = "left join tbl_empresa_holding
on tbl_empresa_holding.rut=tbl_usuario.empresa_holding";
}

if (!$pagina or $pagina == 1) {
$limite_interior = 0;
} else {
$limite_interior = ($pagina - 1) * $registros_por_pagina;
}
$sql = "
SELECT clave, $tabla.* $cruce_holding from $tabla

$cruce_left_join_empresa
left join tbl_clave
on tbl_clave.rut=tbl_usuario.rut
where $tabla.id_empresa=$id_empresa and vigencia=0
$filtro $orderBy
limit $limite_interior, $registros_por_pagina


";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function SeguimientoVerificoRespuestaSoloPorCategoria($rut, $id_categoria) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_admin_seguimiento_respuestas where rut='$rut'  and id_categoria='$id_categoria' limit 1";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function SeguimientoVerificaCategoriaFinalizada($id_categoria, $rut) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_admin_seguimiento_categorias_finalizado where id_categoria='$id_categoria' and rut='$rut'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function SeguimientoInsertoFinalizadoCategoria($rut, $id_categoria) {
global $c_host, $c_user, $c_pass, $c_db;
$fecha = date("Y-m-d");
$hora = date("H:i:s");
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO tbl_admin_seguimiento_categorias_finalizado(rut, id_categoria) " .
"VALUES ('$rut', '$id_categoria');";
$database->setquery($sql);
$database->query();
}

function SeguimientoTotalCategoriasPorEmpresaDadoId($id_categoria) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_admin_seguimiento_categorias where id='$id_categoria'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function SeguimientoTotalCategoriasPorEmpresa($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_admin_seguimiento_categorias where id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function SeguimientoActualizaRespuestas($rut, $id_paso, $id_categoria, $respuesta) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "update tbl_admin_seguimiento_respuestas set respuesta='$respuesta' where rut='$rut' and id_paso='$id_paso' and id_categoria='$id_categoria'";
$database->setquery($sql);
$database->query();
}

function SeguimientoInsertoRespuesta($rut, $id_paso, $id_categoria, $respuesta) {
global $c_host, $c_user, $c_pass, $c_db;
$fecha = date("Y-m-d");
$hora = date("H:i:s");
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO tbl_admin_seguimiento_respuestas(rut, id_paso, id_categoria, respuesta, fecha, hora) " .
"VALUES ('$rut', '$id_paso', '$id_categoria', '$respuesta', '$fecha', '$hora');";
$database->setquery($sql);
$database->query();
}

function SeguimientoVerificoRespuestaPorRutCatePaso($rut, $id_paso, $id_categoria) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_admin_seguimiento_respuestas where rut='$rut' and id_paso='$id_paso' and id_categoria='$id_categoria'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function SeguimientoAlternativasPorId($id) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_admin_seguimiento_alternativas where id_grupo_alternativa='$id'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function CamposParaReporte($env, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "  select * from tbl_admin_reportes_campos where env='$env' and id_empresa='$id_empresa' order by orden asc";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function CriteriosParaTablaResumenReporteAvanceParaReportesSGD($id_empresa, $criterio) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = " select
distinct($criterio) as campo
from tbl_usuario where id_empresa='$id_empresa'
and ($criterio) <>''


";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function CriteriosParaTablaResumenReporteAvance2($id_empresa, $criterio, $arreglo_post) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
if ($arreglo_post["filtro1"] != '0' and $arreglo_post["filtro1"] != '') {
$filtro_campo1 = " and $criterio='" . $arreglo_post["filtro1"] . "'";
$sql = " select distinct($criterio) as valor from tbl_usuario where id_empresa='$id_empresa' $filtro_campo1";
} else {
$sql = " select distinct($criterio) as valor from tbl_usuario where id_empresa='$id_empresa' ";
}

//echo $sql;Exit;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function CriteriosParaTablaResumenReporteAvance($id_empresa, $criterio) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = " select distinct($criterio) from tbl_usuario where id_empresa='$id_empresa'";
//echo $sql;Exit;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DatosTablaUsuarioTodosPorEmpresa($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_usuario where id_empresa='$id_empresa' and vigencia='0' order by apaterno, nombre ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function PasosPorSeguimientoCategoria($id) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_admin_seguimiento_pasos where id_categoria='$id'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function PasosPorProcesoParaReportes($id_proceso) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_sgd_proceso_etapa where id_proceso='$id_proceso' and muestra_reportes_admin='1'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function PasosPorProceso($id_proceso) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_sgd_proceso_etapa where id_proceso='$id_proceso'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TotalFinalizadosPorProceso($id_proceso) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select count(id) as total from tbl_sgd_finalizados_evaluado_evaluador where id_proceso='$id_proceso'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TotalRelacionesProPRoceso($id_proceso) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select count(id) as total from tbl_sgd_relaciones where id_proceso='$id_proceso'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function SelectTotalParaPaginacionEvaluador($tabla, $id_empresas, $arreglo_post, $id_proceso) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if (!$pagina or $pagina == 1) {
$limite_interior = 0;
} else {
$limite_interior = ($pagina - 1) * $registros_por_pagina;
}

if ($arreglo_post["gerencia"]) {
$filtro = " and tbl_usuario.gerencia='" . $arreglo_post["gerencia"] . "'";
}

if ($arreglo_post["un"]) {
$filtro .= " and tbl_usuario.unidad_negocio='" . $arreglo_post["un"] . "'";
}

if ($arreglo_post["area"]) {
$filtro .= " and tbl_usuario.area='" . $arreglo_post["area"] . "'";
}

if ($arreglo_post["filtro_empresa_holding"]) {
$filtro .= " and tbl_usuario.empresa_holding='" . $arreglo_post["filtro_empresa_holding"] . "'";
}

if ($arreglo_post["filtro_centrocosto"]) {
$filtro .= " and tbl_usuario.centro_costo='" . $arreglo_post["filtro_centrocosto"] . "'";
}

if ($id_proceso) {
$filtro .= " and $tabla.id_proceso='$id_proceso' ";
}

if ($arreglo_post["asc_desc"]) {
$ascdesc = $arreglo_post["asc_desc"];
}

if ($arreglo_post["orderBy"]) {
$orderBy = " order by " . $arreglo_post["orderBy"] . " " . $ascdesc;
} else {
$orderBy = " order by $tabla.id desc";
}

if ($arreglo_post["orderBy"] == "" and $tabla == "tbl_usuario") {
$orderBy = " order by apaterno asc";
}

if ($arreglo_post["orderBy"] == "" and $tabla == "tbl_otec") {
$orderBy = " order by nombre asc";
}

$inner = "";
if ($tabla == "tbl_sgd_relaciones") {
$inner = "inner join tbl_usuario on $tabla.evaluado=tbl_usuario.rut";
}

$sql = "
SELECT distinct(evaluador) from tbl_sgd_relaciones where id_proceso='$id_proceso'



";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeEvaluadoresPorProceso($id_proceso, $registros_por_pagina, $pagina, $arreglo_post, $campo_criterio, $criterio, $valor_criterio, $campos_para_reporte, $datos_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($arreglo_post["gerencia"]) {
$filtro = " and tbl_usuario.gerencia='" . $arreglo_post["gerencia"] . "'";
}

if ($arreglo_post["un"]) {
$filtro .= " and tbl_usuario.unidad_negocio='" . $arreglo_post["un"] . "'";
}

if ($arreglo_post["area"]) {
$filtro .= " and tbl_usuario.area='" . $arreglo_post["area"] . "'";
}

if ($arreglo_post["filtro_empresa_holding"]) {
$filtro .= " and tbl_usuario.empresa_holding='" . $arreglo_post["filtro_empresa_holding"] . "'";
}

if ($arreglo_post["filtro_centrocosto"]) {
$filtro .= " and tbl_usuario.centro_costo='" . $arreglo_post["filtro_centrocosto"] . "'";
}

if ($arreglo_post["asc_desc"]) {
$ascdesc = $arreglo_post["asc_desc"];
}

if ($arreglo_post["orderBy"]) {
$orderBy = " order by base_evaluador." . $arreglo_post["orderBy"] . " " . $ascdesc;
} else {
$orderBy = " order by tbl_sgd_relaciones.id desc";
}

if ($criterio && $valor_criterio) {
$filtro_desde_tabla_resumen = " and base_evaluador.$criterio='$valor_criterio'";
}

if (count($campos_para_reporte) > 0) {
for ($i = 0; $i < count($campos_para_reporte); $i++) {
$datos_campos_reportes .= " base_evaluador." . $campos_para_reporte[$i]->campo . " AS campo" . $campos_para_reporte[$i]->orden . ", ";
}
}

if ($tabla == "tbl_usuarios") {
$cruce_holding = ", tbl_empresa_holding.empresa as nombre_empresa_holding ";
$cruce_left_join_empresa = "left join tbl_empresa_holding
on tbl_empresa_holding.rut=tbl_usuario.empresa_holding";
}

if (!$pagina or $pagina == 1) {
$limite_interior = 0;
} else {
$limite_interior = ($pagina - 1) * $registros_por_pagina;
}

$sqlBK = "

SELECT DISTINCT
(
tbl_sgd_relaciones.evaluador
),
base_evaluador.nombre_completo AS nombre_evaluador,
base_evaluador.rut_completo AS rut_completo_evaluador,
base_evaluador.cargo AS cargo_evaluador,
base_evaluador.gerencia AS gerencia_evaluador,
base_evaluador.nombre_empresa_holding AS nombre_empresa_holding_evaluador,
(
SELECT
count(*)
FROM
tbl_sgd_relaciones AS relaciones_evaluado
WHERE
relaciones_evaluado.id_proceso = '$id_proceso'
AND relaciones_evaluado.evaluador = tbl_sgd_relaciones.evaluador
)AS total_evaluados,
(
SELECT
count(*)
FROM
tbl_sgd_finalizados_evaluado_evaluador
WHERE
tbl_sgd_finalizados_evaluado_evaluador.id_proceso = '$id_proceso'
AND tbl_sgd_finalizados_evaluado_evaluador.evaluador = tbl_sgd_relaciones.evaluador
)AS total_finalizados,

(select count(*) as tot from tbl_sgd_respuestas where tbl_sgd_respuestas.id_objetivo is null and tbl_sgd_respuestas.evaluador=tbl_sgd_relaciones.evaluador GROUP BY  tbl_sgd_respuestas.evaluador) as total_en_proceso,
tbl_clave.cambiado as clave_creada

FROM
tbl_sgd_relaciones
INNER JOIN tbl_usuario AS base_evaluador ON base_evaluador.rut = tbl_sgd_relaciones.evaluador
inner join tbl_clave on tbl_clave.rut=tbl_sgd_relaciones.evaluador
WHERE
tbl_sgd_relaciones.id_proceso = '$id_proceso'

$orderBy
LIMIT $limite_interior,
$registros_por_pagina

";

if ($campo_criterio) {
$sql = "
SELECT DISTINCT
(
tbl_sgd_relaciones.evaluador
),
base_evaluador.nombre_completo AS nombre_evaluador,
base_evaluador.rut_completo AS rut_completo_evaluador,
base_evaluador.cargo AS cargo_evaluador,
base_evaluador.gerencia AS gerencia_evaluador,
base_evaluador.$campo_criterio AS valor_campo_criterio,
base_evaluador.nombre_empresa_holding AS nombre_empresa_holding_evaluador,
(
SELECT
count(*)
FROM
tbl_sgd_relaciones AS relaciones_evaluado
WHERE
relaciones_evaluado.id_proceso = '$id_proceso'
AND relaciones_evaluado.evaluador = tbl_sgd_relaciones.evaluador
)AS total_evaluados,
(
SELECT
count(*)
FROM
tbl_sgd_finalizados_evaluado_evaluador
WHERE
tbl_sgd_finalizados_evaluado_evaluador.id_proceso = '$id_proceso'
AND tbl_sgd_finalizados_evaluado_evaluador.evaluador = tbl_sgd_relaciones.evaluador
)AS total_finalizados,


tbl_clave.cambiado as clave_creada

FROM
tbl_sgd_relaciones
INNER JOIN tbl_usuario AS base_evaluador ON base_evaluador.rut = tbl_sgd_relaciones.evaluador
inner join tbl_clave on tbl_clave.rut=tbl_sgd_relaciones.evaluador
WHERE
tbl_sgd_relaciones.id_proceso = '$id_proceso' $filtro_desde_tabla_resumen order by base_evaluador.$campo_criterio asc


";
} else {
$sql = "
SELECT DISTINCT
(
tbl_sgd_relaciones.evaluador
),
base_evaluador.nombre_completo AS nombre_evaluador,
base_evaluador." . $datos_empresa[0]->campo1 . " AS campo1,
base_evaluador." . $datos_empresa[0]->campo2 . " AS campo2,
base_evaluador." . $datos_empresa[0]->campo3 . " AS campo3,
$datos_campos_reportes
base_evaluador.rut_completo AS rut_completo_evaluador,
base_evaluador.cargo AS cargo_evaluador,
base_evaluador.gerencia AS gerencia_evaluador,
base_evaluador.nombre_empresa_holding AS nombre_empresa_holding_evaluador,
(
SELECT
count(*)
FROM
tbl_sgd_relaciones AS relaciones_evaluado
WHERE
relaciones_evaluado.id_proceso = '$id_proceso'
AND relaciones_evaluado.evaluador = tbl_sgd_relaciones.evaluador
)AS total_evaluados,
(
SELECT
count(*)
FROM
tbl_sgd_finalizados_evaluado_evaluador
WHERE
tbl_sgd_finalizados_evaluado_evaluador.id_proceso = '$id_proceso'
AND tbl_sgd_finalizados_evaluado_evaluador.evaluador = tbl_sgd_relaciones.evaluador
)AS total_finalizados,


tbl_clave.cambiado as clave_creada

FROM
tbl_sgd_relaciones
INNER JOIN tbl_usuario AS base_evaluador ON base_evaluador.rut = tbl_sgd_relaciones.evaluador
inner join tbl_clave on tbl_clave.rut=tbl_sgd_relaciones.evaluador
WHERE
tbl_sgd_relaciones.id_proceso = '$id_proceso' $filtro_desde_tabla_resumen

$orderBy
LIMIT $limite_interior,
$registros_por_pagina
";
}

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeProcesosDeEvaluacionPorIDProceso($id_proceso) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "

select tbl_sgd_proceso_evaluacion.*, tbl_sgd_proceso_anual.ano as ano_proceso
from tbl_sgd_proceso_evaluacion
inner join tbl_sgd_proceso_anual
on tbl_sgd_proceso_anual.id=id_proceso_anual
where tbl_sgd_proceso_evaluacion.id_proceso='$id_proceso'

";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TieneRespuestasPorEvaluadoEvaluadorIdProcesoSinPrecargadas($evaluado, $evaluador, $id_proceso) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = sprintf("select id

from tbl_sgd_respuestas
where evaluado='$evaluado' and evaluador='$evaluador' and id_proceso='$id_proceso' and id_objetivo is null limit 1");

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TieneRespuestasPorEvaluadoEvaluadorIdProceso($evaluado, $evaluador, $id_proceso) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = sprintf("select id

from tbl_sgd_respuestas
where evaluado='$evaluado' and evaluador='$evaluador' and id_proceso='$id_proceso' limit 1");

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function EliminaRegistroEvaluadoEvaluadorFinalizado($id) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

delete from tbl_sgd_finalizados_evaluado_evaluador where id='$id'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
}

function TraeRelacionesPorProceso($id_proceso, $registros_por_pagina, $pagina, $arreglo_post, $rut_evaluador, $campo_criterio, $criterio, $valor_criterio, $campos_para_reporte, $campos_para_reporte_datos_evaluador, $datos_empresa, $filtro1, $filtro2, $rut_validador) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($rut_evaluador) {
$filtro_rut_evaluador = " and tbl_sgd_relaciones.evaluador ='" . $rut_evaluador . "'";
}

if ($arreglo_post["gerencia"]) {
$filtro = " and tbl_usuario.gerencia='" . $arreglo_post["gerencia"] . "'";
}

if ($arreglo_post["un"]) {
$filtro .= " and tbl_usuario.unidad_negocio='" . $arreglo_post["un"] . "'";
}

if ($arreglo_post["area"]) {
$filtro .= " and tbl_usuario.area='" . $arreglo_post["area"] . "'";
}

if ($arreglo_post["filtro_empresa_holding"]) {
$filtro .= " and tbl_usuario.empresa_holding='" . $arreglo_post["filtro_empresa_holding"] . "'";
}

if ($arreglo_post["filtro_centrocosto"]) {
$filtro .= " and tbl_usuario.centro_costo='" . $arreglo_post["filtro_centrocosto"] . "'";
}

if ($arreglo_post["asc_desc"]) {
$ascdesc = $arreglo_post["asc_desc"];
}

if ($arreglo_post["orderBy"]) {$orderBy = " order by base_evaluado." . $arreglo_post["orderBy"] . " " . $ascdesc;
} else { $orderBy = " order by tbl_sgd_relaciones.id desc";}

if ($criterio && $valor_criterio) {$filtro_desde_tabla_resumen = " and base_evaluado.$criterio='$valor_criterio'";}

if (count($campos_para_reporte) > 0) {for ($i = 0; $i < count($campos_para_reporte); $i++) {
$datos_campos_reportes .= " base_evaluado." . $campos_para_reporte[$i]->campo . " AS campo" . $campos_para_reporte[$i]->orden . ", ";
}
}

if (count($campos_para_reporte_datos_evaluador) > 0) {
for ($i = 0; $i < count($campos_para_reporte_datos_evaluador); $i++) {
$datos_campos_reportes_evaluador .= " base_evaluador." . $campos_para_reporte_datos_evaluador[$i]->campo . " AS campo" . $campos_para_reporte_datos_evaluador[$i]->orden . "_evaluador , ";
}
}

if ($tabla == "tbl_usuarios") {
$cruce_holding = ", tbl_empresa_holding.empresa as nombre_empresa_holding ";
$cruce_left_join_empresa = "left join tbl_empresa_holding
on tbl_empresa_holding.rut=tbl_usuario.empresa_holding";
}

if (!$pagina or $pagina == 1) {
$limite_interior = 0;
} else {
$limite_interior = ($pagina - 1) * $registros_por_pagina;
}

if ($arreglo_post) {
$filtro_evaluador = "";
if ($arreglo_post["rutevaluador"] && $arreglo_post["evaluador"]) {
$filtro_evaluador = "and tbl_sgd_relaciones.evaluador ='" . $arreglo_post["rutevaluador"] . "' ";
}

$filtro_calibrador = "";
if ($arreglo_post["rutcalibrador"] && $arreglo_post["calibrador"]) {
$filtro_calibrador = "and tbl_sgd_relaciones.calibrador ='" . $arreglo_post["rutcalibrador"] . "' ";
}

if ($arreglo_post[$datos_empresa[0]->campo1] != '-' and $arreglo_post[$datos_empresa[0]->campo1] != '') {
$filtro_campo1 = " and base_evaluado." . $datos_empresa[0]->campo1 . "='" . $arreglo_post[$datos_empresa[0]->campo1] . "'";
}

if ($arreglo_post[$datos_empresa[0]->campo2] != '-' and $arreglo_post[$datos_empresa[0]->campo2] != '') {
$filtro_campo2 = " and base_evaluado." . $datos_empresa[0]->campo2 . "='" . $arreglo_post[$datos_empresa[0]->campo2] . "'";
}

if ($arreglo_post[$datos_empresa[0]->campo3] != '-' and $arreglo_post[$datos_empresa[0]->campo3] != '') {
$filtro_campo3 = " and base_evaluado." . $datos_empresa[0]->campo3 . "='" . $arreglo_post[$datos_empresa[0]->campo3] . "'";
}
}

if ($filtro2) {
if ($filtro1 == '-' or $filtro2 == '-') {
} else {
$filtro1_2 = " and base_evaluado.$filtro1='$filtro2'";
}
}

if ($rut_validador) {
$filtro_validador = " and tbl_sgd_relaciones.calibrador='$rut_validador'";
}

$sql = "
SELECT
tbl_sgd_relaciones.*,
base_evaluado.nombre_completo AS nombre_evaluado,
base_evaluado.rut_completo AS rut_completo_evaluado,
base_evaluado.cargo AS cargo_evaluado,
base_evaluado." . $datos_empresa[0]->campo1 . " as campo1,
base_evaluado." . $datos_empresa[0]->campo2 . " as campo2,
base_evaluado." . $datos_empresa[0]->campo3 . " as campo3,

base_evaluado.gerencia AS gerencia_evaluado,
base_evaluado.nombre_empresa_holding AS nombre_empresa_evaluado,
$datos_campos_reportes
$datos_campos_reportes_evaluador

base_evaluador.nombre_completo AS nombre_evaluador,
base_evaluador.rut_completo AS rut_completo_evaluador,
base_evaluador.cargo AS cargo_evaluador,
base_evaluador.gerencia AS gerencia_evaluador,
base_evaluador.nombre_empresa_holding AS nombre_empresa_evaluador,

base_calibrador.nombre_completo AS nombre_calibrador,
base_calibrador.rut_completo AS rut_completo_calibrador,
base_calibrador.cargo AS cargo_calibrador,
base_calibrador.gerencia AS gerencia_calibrador,
base_calibrador.nombre_empresa_holding AS nombre_empresa_calibrador,



base_evaluador." . $datos_empresa[0]->campo1 . " as campo1_evaluador,
base_evaluador." . $datos_empresa[0]->campo2 . " as campo2_evaluador,
base_evaluador." . $datos_empresa[0]->campo3 . " as campo3_evaluador,


base_evaluado.perfil_evaluacion,
tbl_sgd_perfiles_ponderaciones.descripcion AS nombre_perfil,
tbl_sgd_subperfiles.perfil AS nombre_sub_perfil,
tbl_sgd_finalizados_evaluado_evaluador.fecha AS fecha_fin_eval,
tbl_sgd_finalizados_evaluado_evaluador.id AS id_registro_finalizado
FROM
tbl_sgd_relaciones
INNER JOIN tbl_usuario AS base_evaluado ON base_evaluado.rut = tbl_sgd_relaciones.evaluado
INNER JOIN tbl_usuario AS base_evaluador ON base_evaluador.rut = tbl_sgd_relaciones.evaluador

LEFT JOIN tbl_usuario AS base_calibrador ON base_calibrador.rut = tbl_sgd_relaciones.calibrador

INNER JOIN tbl_sgd_perfiles_ponderaciones ON tbl_sgd_perfiles_ponderaciones.perfil = base_evaluado.perfil_evaluacion
INNER JOIN tbl_sgd_subperfiles ON tbl_sgd_subperfiles.id = tbl_sgd_relaciones.subperfil
LEFT JOIN tbl_sgd_finalizados_evaluado_evaluador ON tbl_sgd_finalizados_evaluado_evaluador.evaluado = tbl_sgd_relaciones.evaluado
AND tbl_sgd_finalizados_evaluado_evaluador.evaluador = tbl_sgd_relaciones.evaluador
AND tbl_sgd_finalizados_evaluado_evaluador.id_proceso = tbl_sgd_relaciones.id_proceso

WHERE tbl_sgd_relaciones.id_proceso = '$id_proceso'
$filtro_evaluador
$filtro_calibrador
$filtro_campo1
$filtro_campo2
$filtro_campo3
$filtro_rut_evaluador
$filtro1_2






";

$sql = "
SELECT
tbl_sgd_relaciones.*,
base_evaluado.nombre_completo AS nombre_evaluado,
base_evaluado.rut_completo AS rut_completo_evaluado,
base_evaluado.cargo AS cargo_evaluado,
base_evaluado." . $datos_empresa[0]->campo1 . " as campo1,
base_evaluado." . $datos_empresa[0]->campo2 . " as campo2,
base_evaluado." . $datos_empresa[0]->campo3 . " as campo3,

base_evaluado.gerencia AS gerencia_evaluado,
base_evaluado.nombre_empresa_holding AS nombre_empresa_evaluado,
$datos_campos_reportes
$datos_campos_reportes_evaluador

base_evaluador.nombre_completo AS nombre_evaluador,
base_evaluador.rut_completo AS rut_completo_evaluador,
base_evaluador.cargo AS cargo_evaluador,
base_evaluador.gerencia AS gerencia_evaluador,
base_evaluador.nombre_empresa_holding AS nombre_empresa_evaluador,

base_calibrador.nombre_completo AS nombre_calibrador,
base_calibrador.rut_completo AS rut_completo_calibrador,
base_calibrador.cargo AS cargo_calibrador,
base_calibrador.gerencia AS gerencia_calibrador,
base_calibrador.nombre_empresa_holding AS nombre_empresa_calibrador,



base_evaluador." . $datos_empresa[0]->campo1 . " as campo1_evaluador,
base_evaluador." . $datos_empresa[0]->campo2 . " as campo2_evaluador,
base_evaluador." . $datos_empresa[0]->campo3 . " as campo3_evaluador,


tbl_sgd_relaciones.perfil_evaluacion_competencias as perfil_evaluacion,
tbl_sgd_perfiles_ponderaciones.descripcion AS nombre_perfil,
tbl_sgd_subperfiles.perfil AS nombre_sub_perfil,
tbl_sgd_finalizados_evaluado_evaluador.fecha AS fecha_fin_eval,
tbl_sgd_finalizados_evaluado_evaluador.id AS id_registro_finalizado
FROM
tbl_sgd_relaciones
INNER JOIN tbl_usuario AS base_evaluado ON base_evaluado.rut = tbl_sgd_relaciones.evaluado
INNER JOIN tbl_usuario AS base_evaluador ON base_evaluador.rut = tbl_sgd_relaciones.evaluador

LEFT JOIN tbl_usuario AS base_calibrador ON base_calibrador.rut = tbl_sgd_relaciones.calibrador

INNER JOIN tbl_sgd_perfiles_ponderaciones ON tbl_sgd_perfiles_ponderaciones.perfil = tbl_sgd_relaciones.perfil_evaluacion_competencias
INNER JOIN tbl_sgd_subperfiles ON tbl_sgd_subperfiles.id = tbl_sgd_relaciones.subperfil
LEFT JOIN tbl_sgd_finalizados_evaluado_evaluador ON tbl_sgd_finalizados_evaluado_evaluador.evaluado = tbl_sgd_relaciones.evaluado
AND tbl_sgd_finalizados_evaluado_evaluador.evaluador = tbl_sgd_relaciones.evaluador
AND tbl_sgd_finalizados_evaluado_evaluador.id_proceso = tbl_sgd_relaciones.id_proceso

WHERE tbl_sgd_relaciones.id_proceso = '$id_proceso'

$filtro_evaluador
$filtro_calibrador
$filtro_campo1
$filtro_campo2
$filtro_campo3
$filtro_rut_evaluador
$filtro1_2

$filtro_validador



";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function InsertaCompetenciaPorPerfil($perfil, $id_competencia) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO rel_sgd_perfil_competencias(perfil_evaluacion, id_componente) " .
"VALUES ('$perfil', '$id_competencia');";

$database->setquery($sql);
$database->query();
}

function TraeTotalNoticiasPorEmpresa($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
SELECT
tbl_noticias.*, tbl_noticias_categorias.categoria as nombre_categoria, tbl_noticias_principales.prioridad, tbl_noticias_principales.id as id_noticia_principal
FROM
tbl_noticias
left JOIN tbl_noticias_principales
on tbl_noticias_principales.idnoticia=tbl_noticias.id
inner join tbl_noticias_categorias
on tbl_noticias_categorias.id=tbl_noticias.categoria
WHERE
tbl_noticias.id_empresa='$id_empresa'
ORDER BY
tbl_noticias.id
LIMIT 0, $limit
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function InsertarProcesoEvalPorProcesoAnual(
$descripcion_proceso,
$fecha_inicio,
$fecha_termino,
$id_empresa,
$id_proceso_anual,
$id_proceso_anterior,
$tipo_proceso,
$titulo_informes_proceso,
$nota_final,
$environment,
$orden,
$muestra_ae_evaluacion,
$titulo_grafico_1,
$color_grafico_1,
$color_grafico_2,
$id_proceso_a_evaluar,
$id_proceso_a_calibrar,
$calibracion,
$descripcion) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "INSERT INTO tbl_sgd_proceso_evaluacion
(descripcion_proceso,
fecha_inicio,
fecha_termino,
id_empresa,
id_proceso_anual,
id_proceso,
tipo_proceso,
titulo_informes_proceso,
nota_final,
environment,
orden,
muestra_ae_evaluacion,
titulo_grafico_1,
color_grafico_1,
color_grafico_2,
id_proceso_a_evaluar,
id_proceso_a_calibrar,
calibracion,
descripcion
) " .
"VALUES ('$descripcion_proceso',
'$fecha_inicio',
'$fecha_termino',
'$id_empresa',
'$id_proceso_anual',
'$id_proceso_anterior',
'$tipo_proceso',
'$titulo_informes_proceso',
'$nota_final',
'$environment',
'$orden',
'$muestra_ae_evaluacion',
'$titulo_grafico_1',
'$color_grafico_1',
'$color_grafico_1',
'$id_proceso_a_evaluar',
'$id_proceso_a_calibrar',
'$calibracion',
'$descripcion');";

$database->setquery($sql);
$database->query();
}

function InsertaProcesoAnual($nombre_proceso, $descripcion_proceso, $ano, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO tbl_sgd_proceso_anual(nombre_proceso, descripcion, id_empresa, ano) " .
"VALUES ('$nombre_proceso', '$descripcion_proceso', '$id_empresa', '$ano');";
$database->setquery($sql);
$database->query();
}

function EncuestasSatisFinalizadasPorInscripcionEncuestaRut($id_inscripcion, $id_encuesta, $rut) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_enc_satis_finalizados where id_inscripcion='$id_inscripcion' and rut='$rut' and id_encuesta='$id_encuesta'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function CasosEspecialesPorId($id) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "

select * from tbl_inscripcion_excepciones where id='$id'

";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function DatosTiposReportesPorEmpresaParaCalculosCursos($id_empresa, $tipo_reporte) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "

select tbl_reportes_campos.* from tbl_reportes_campos
inner join tbl_reportes
on tbl_reportes.id=tbl_reportes_campos.id_reporte
where tbl_reportes.id_empresa='$id_empresa' and tbl_reportes.id=$tipo_reporte and id_curso is not null

";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function DatosReporteDinamico($sql, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "
select $sql
from tbl_usuario where tbl_usuario.id_empresa='$id_empresa'
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function DatosTiposReportesPorEmpresaParaSQL($id_empresa, $tipo_reporte) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "

select tbl_reportes_campos.* from tbl_reportes_campos
inner join tbl_reportes
on tbl_reportes.id=tbl_reportes_campos.id_reporte
where tbl_reportes.id_empresa='$id_empresa' and tbl_reportes.id=$tipo_reporte and campo is not null

";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function DatosTiposReportesPorEmpresa($id_empresa, $tipo_reporte) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "

select tbl_reportes_campos.* from tbl_reportes_campos
inner join tbl_reportes
on tbl_reportes.id=tbl_reportes_campos.id_reporte
where tbl_reportes.id_empresa='$id_empresa' and tbl_reportes.id=$tipo_reporte

";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TiposReportesPorEmpresa($id_empresa, $tipo_reporte) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "

select * from tbl_reportes where id_empresa='$id_empresa' and tipo_reporte='$tipo_reporte'

";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function ActualizoEstadoEnvioCorreoPorProceso($rut, $id_proceso) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "update tbl_correos_usuarios_proceso set estado='1' where rut='$rut' and id_proceso='$id_proceso'";
$database->setquery($sql);
$database->query();
}

function EncuestasSatisFinalizadasPorInscripcion($id_inscripcion) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_enc_satis_finalizados where id_inscripcion='$id_inscripcion'

";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TraigoUsuariosDadoIdPRoceso($id_proceso) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.*,
(select nombre_completo from tbl_usuario where rut=h.rut) as nombre,
(select cargo from tbl_usuario where rut=h.rut) as cargo,
(select gerencia from tbl_usuario where rut=h.rut) as gerencia

from tbl_correos_usuarios_proceso h where h.id_proceso='$id_proceso' and h.estado=0

";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TraigoUsuariosDadoIdPRocesoTotalEnviados($id_proceso) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_correos_usuarios_proceso where id_proceso='$id_proceso'

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TraigoUsuariosDadoIdPRocesoTotal($id_proceso) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "

SELECT
tbl_correos_usuarios_proceso.rut,
tbl_usuario.nombre_completo,
tbl_usuario.cargo,
tbl_usuario.email,
tbl_correos_usuarios_proceso.id_proceso,
tbl_correos_proceso.template as tipo_correo,
(
SELECT
count(*) AS total
FROM
tbl_correos_registros_envios
WHERE
tbl_correos_registros_envios.rut = tbl_correos_usuarios_proceso.rut
AND tbl_correos_registros_envios.id_proceso_masivo = tbl_correos_usuarios_proceso.id_proceso
) AS total_envios
FROM
tbl_correos_usuarios_proceso

INNER JOIN tbl_correos_proceso on tbl_correos_proceso.id=   tbl_correos_usuarios_proceso.id_proceso
INNER JOIN tbl_usuario on tbl_usuario.rut=  tbl_correos_usuarios_proceso.rut

WHERE
id_proceso = '$id_proceso'

";

//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TruncarTablaUsuariosEnvioCorreoPorProceso($id_proceso) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

delete from tbl_correos_usuarios_proceso where id_proceso='$id_proceso' and estado=0

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
}

function TraigoListadoUsuariosAEnviarCorreoPorProcesoMasivo($id_proceso, $limit) {
if ($limit == "") {$ql = "";} else { $ql = " limit $limit";}

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "
SELECT tbl_correos_usuarios_proceso.*,
tbl_correos_registros_envios.id AS dato_registro_envio,
tbl_correos_proceso.*,
tbl_usuario.nombre_completo


FROM tbl_correos_usuarios_proceso
LEFT JOIN tbl_correos_registros_envios ON tbl_correos_registros_envios.rut = tbl_correos_usuarios_proceso.rut AND tbl_correos_usuarios_proceso.id_proceso= tbl_correos_registros_envios.id_proceso_masivo
LEFT JOIN tbl_correos_proceso ON tbl_correos_proceso.id = tbl_correos_usuarios_proceso.id_proceso
LEFT JOIN tbl_usuario ON tbl_usuario.rut = tbl_correos_usuarios_proceso.rut


WHERE
tbl_correos_usuarios_proceso.id_proceso = '$id_proceso'
AND tbl_correos_registros_envios.id IS NULL
$ql

";
//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TraigoListadoUsuariosAEnviarCorreoPorProcesoMasivoRut($id_proceso, $rut) {
if ($limit == "") {$ql = "";} else { $ql = " limit $limit";}

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "
SELECT tbl_correos_usuarios_proceso.*,
tbl_correos_registros_envios.id AS dato_registro_envio,
tbl_correos_proceso.*,
tbl_usuario.nombre_completo


FROM tbl_correos_usuarios_proceso
LEFT JOIN tbl_correos_registros_envios ON tbl_correos_registros_envios.rut = tbl_correos_usuarios_proceso.rut AND tbl_correos_usuarios_proceso.id_proceso= tbl_correos_registros_envios.id_proceso_masivo
LEFT JOIN tbl_correos_proceso ON tbl_correos_proceso.id = tbl_correos_usuarios_proceso.id_proceso
LEFT JOIN tbl_usuario ON tbl_usuario.rut = tbl_correos_usuarios_proceso.rut


WHERE
tbl_correos_usuarios_proceso.id_proceso = '$id_proceso'
and tbl_usuario.rut='$rut'


";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TraigoListadoUsuariosAEnviarCorreoPorInscripcion($id_inscripcion, $limit) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "
SELECT
tbl_inscripcion_usuarios.*, tbl_correos_registros_envios.id AS dato_registro_envio
FROM
tbl_inscripcion_usuarios
LEFT JOIN tbl_correos_registros_envios ON tbl_correos_registros_envios.rut = tbl_inscripcion_usuarios.rut
AND tbl_inscripcion_usuarios.id_inscripcion = tbl_correos_registros_envios.id_inscripcion
WHERE
tbl_inscripcion_usuarios.id_inscripcion = '$id_inscripcion'
AND tbl_correos_registros_envios.id IS NULL
LIMIT $limit

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function ActualizarSubMenu($id_submenu, $nombre, $link, $tipo_link) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE tbl_menu_nivel2
SET
nombre= '$nombre',
link= '$link',
tipo_link= '$tipo_link'

WHERE id = '$id_submenu' ";

$database->setquery($sql);
$database->query();
}

function BorroSubMenu($id) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "DELETE FROM tbl_menu_nivel2 WHERE id='$id'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DatosSubMenuNivel2($id) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_menu_nivel2 where id='$id'

";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function ActualizoSubCategoria($id_subcategoria, $nombre, $descripcion) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE tbl_noticias_subcategorias
SET
nombre= '$nombre',
descripcion= '$descripcion'

WHERE id = '$id_subcategoria' ";

$database->setquery($sql);
$database->query();
}

function InsertaSubCategoriaNoticia($categoria, $descripcion, $id_categoria) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO tbl_noticias_subcategorias(nombre, descripcion, id_categoria) " .
"VALUES ('$categoria', '$descripcion', '$id_categoria');";

$database->setquery($sql);
$database->query();
}

function DatosSubCategoria($id) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_noticias_subcategorias where id='$id'

";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function BorroSubCategoria($id) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "DELETE FROM tbl_noticias_subcategorias WHERE id='$id'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ActualizoDatosCategoriaNoticia($id, $nombre, $descripcion) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE tbl_noticias_categorias
SET
categoria= '$nombre',
descripcion= '$descripcion'

WHERE id = '$id' ";

$database->setquery($sql);
$database->query();
}

function InsertaCategoriaNoticia($categoria, $descripcion) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO tbl_noticias_categorias(categoria, descripcion) " .
"VALUES ('$categoria', '$descripcion');";

$database->setquery($sql);
$database->query();
}

function DatosEquipoRF($tipo, $nivel, $gerencia) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "

select h.*, (select nombre_completo from tbl_usuario where rut=h.jefe) as nombrejefe from tbl_usuario h

order by gerencia, jefe, nombre_completo ASC

";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function DatosSugerenciasRF($tipo, $nivel, $gerencia) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "

select h.*,
(select gerencia from tbl_usuario where rut=h.rut_jefe) as gerencia,
(select nombre_completo from tbl_usuario where rut=h.rut_jefe) as nombrejefe,
(select count(id) from tbl_dnc_colaboradores_por_objetivo where  id_sugerencia=h.id) as participantes,
(select count(id) from tbl_dnc_colaboradores_por_objetivo where  id_sugerencia=h.id and prioridad='Critica') as prioritarios,
(select count(id) from tbl_dnc_colaboradores_por_objetivo where  id_sugerencia=h.id and prioridad='Importante') as importantes
from tbl_dnc_sugerencias_por_objetivo h

order by (select gerencia from tbl_usuario where rut=h.rut_jefe), (select nombre_completo from tbl_usuario where rut=h.rut_jefe), numero_sugerencia ASC

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function BorroRegistroNoticiaPrincipalConPrioridad4($id) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "DELETE FROM tbl_noticias_principales WHERE prioridad='4'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function InsertaNoticiaPrincipal($id_noticia, $numero) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO tbl_noticias_principales(idnoticia, prioridad ) " .
"VALUES ('$id_noticia', '$numero');";

$database->setquery($sql);
$database->query();
}

function ObtengoUltimaNoticiaPorEmpresa($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select max(id) as ultimo_id from tbl_noticias where id_empresa='$id_empresa'

";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function EliminaRegistroNoticiaPrincipal($id) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "DELETE FROM tbl_noticias_principales WHERE id='$id'";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeNoticiaPrincipal($id_empresa, $numero_noticia) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select
*
from
tbl_noticias
where id_empresa='$id_empresa' and principal='$numero_noticia'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ObtenerNoticiaPrincipalDadoNumero($id_empresa, $numero_noticia) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select
tbl_noticias_principales.*
from
tbl_noticias_principales
inner join tbl_noticias
on tbl_noticias.id=tbl_noticias_principales.idnoticia
where tbl_noticias.id_empresa='$id_empresa' and tbl_noticias_principales.prioridad='$numero_noticia'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DatosParaCombo2($centro_costo) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select DISTINCT(unidad_negocio) as unidad_negocio
from tbl_usuario
where centro_costo='$centro_costo'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DatosParaCombo1($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select DISTINCT(centro_costo) as centro_costo
from tbl_usuario
where empresa_holding='$id_empresa'
order by centro_costo    ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DatosTablaUsuarioPorEmpresa($id_empresa, $fecha_inicio, $fecha_termino, $arreglo_filtro) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$filtro_fecha = "";
$filtro_empresa = "";
$filtro_centro_costo = "";

if ($arreglo_filtro["filtro_empresa"]) {
$filtro_empresa = " and (tbl_inscripcion_usuarios.id_empresa='" . $arreglo_filtro["filtro_empresa"] . "')";
}

if ($arreglo_filtro["filtro_centrocosto"]) {
$filtro_centro_costo = " and (tbl_inscripcion_usuarios.centro_costo='" . $arreglo_filtro["filtro_centrocosto"] . "')";
}

if ($fecha_inicio && $fecha_termino) {
$filtro_fecha = " and (tbl_inscripcion_curso.fecha_inicio>='$fecha_inicio' && tbl_inscripcion_curso.fecha_termino<='$fecha_termino')";
}

$sql = "SELECT
tbl_usuario.rut,
nombre,
apaterno,
amaterno,
tramo_sence,
cargo,
gerencia,
centro_costo,
empresa_holding,
tbl_empresa_holding.empresa as nombre_empresa,
(
SELECT
count(*) AS total
FROM
tbl_usuario as a
INNER JOIN tbl_inscripcion_usuarios ON tbl_inscripcion_usuarios.rut = a.rut


inner join tbl_inscripcion_curso on tbl_inscripcion_curso.id=tbl_inscripcion_usuarios.id_inscripcion
where tbl_inscripcion_usuarios.rut=tbl_usuario.rut $filtro_fecha $filtro_empresa $filtro_centro_costo

GROUP BY
tbl_usuario.rut
ORDER BY
total DESC
) AS total_inscripciones
FROM
tbl_usuario

inner join tbl_empresa_holding
on tbl_empresa_holding.rut=empresa_holding
WHERE
tbl_usuario.id_empresa = '$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function CursosPorEmpresaPAraConsolidado($id_empresa, $fecha_inicio, $fecha_termino, $arreglo_filtro) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$filtro_empresa = "";
if ($arreglo_filtro["filtro_empresa"]) {
$filtro_empresa = " and tbl_inscripcion_usuarios.id_empresa='" . $arreglo_filtro["filtro_empresa"] . "'";
}

if ($fecha_inicio && $fecha_termino) {
$inner_fechas = "
inner join tbl_inscripcion_curso
on tbl_lms_curso.id = tbl_inscripcion_curso.id_curso ";

$where_fechas = " and (tbl_inscripcion_curso.fecha_inicio>='$fecha_inicio' and tbl_inscripcion_curso.fecha_termino<='$fecha_termino') ";
} else {
$inner_fechas = " inner join tbl_inscripcion_curso on tbl_lms_curso.id=tbl_inscripcion_curso.id_curso";
}

$sql = "

SELECT
tbl_lms_curso.nombre,
tbl_lms_curso.id,
(select count(*) as total from tbl_inscripcion_curso where tbl_inscripcion_curso.id_curso=tbl_lms_curso.id) as total_inscripciones,
(
select count(*)as total_participantes
from tbl_inscripcion_usuarios
inner join tbl_inscripcion_curso as a
ON a.id=tbl_inscripcion_usuarios.id_inscripcion
inner join tbl_lms_curso as b
on b.id=a.id_curso
where b.id=tbl_lms_curso.id $filtro_empresa
) as total_participantes_

FROM
tbl_lms_curso

$inner_fechas

WHERE
tbl_lms_curso.id_empresa = $id_empresa $where_fechas

group by tbl_lms_curso.id
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function SelectDistinctEmpresaPorInscripcion($id_inscripcion) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

SELECT DISTINCT
(tbl_inscripcion_usuarios.empresa),
tbl_empresa_holding.empresa as nombre_empresa_holding
FROM
tbl_inscripcion_usuarios
INNER JOIN tbl_empresa_holding ON tbl_empresa_holding.rut= tbl_inscripcion_usuarios.id_empresa
WHERE
id_inscripcion = '$id_inscripcion'


";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DatosDeCorreoDadoId($id_correo) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select * from tbl_correos where id='$id_correo'


";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ActualizaDatosOtec($rut, $nombre_otec, $direccion_otec, $telefono_otec, $email_otec, $contacto_otec, $id) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE tbl_otec
SET
nombre= '$nombre_otec',
direccion= '$direccion_otec',
telefono= '$telefono_otec',
email= '$email_otec',
contacto= '$contacto_otec'
WHERE id = '$id' ";

$database->setquery($sql);
$database->query();
}

function InsertaOtec($rut, $nombre_otec, $direccion_otec, $telefono_otec, $email_otec, $contacto_otec, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO tbl_otec(rut, nombre, direccion, telefono, email, contacto, id_empresa ) " .
"VALUES ('$rut', '$nombre_otec', '$direccion_otec', '$telefono_otec', '$email_otec', '$contacto_otec', '$id_empresa');";

$database->setquery($sql);
$database->query();
}

function TotalObjetivosIndividuales($arreglo_post) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($arreglo_post["area"]) {
$filtro .= " and base_evaluado.area='" . $arreglo_post["area"] . "'";
}

$sql = "
SELECT
tbl_objetivos_individuales.*, tbl_sgd_relaciones.evaluado,
tbl_sgd_relaciones.evaluador,
tbl_sgd_relaciones.validador,
base_evaluado.nombre_completo,
base_evaluado.rut_completo AS rut_completo_evaluado,
base_evaluado.area AS area,
base_evaluado.cargo AS cargo,
tbl_objetivos_dimension.nombre AS nombre_dimension,
tbl_sgd_relaciones.evaluador AS rut_evaluador,
base_evaluador.rut_completo AS rut_completo_evaluador,
base_evaluador.nombre_completo AS nombre_evaluador,
base_evaluador.cargo AS cargo_evaluador,
base_validador.rut_completo as rut_completo_validador,
tbl_sgd_relaciones.validador as rut_validador,
base_validador.nombre_completo as nombre_validador,
base_validador.cargo as cargo_validador
FROM
tbl_objetivos_individuales
INNER JOIN tbl_sgd_relaciones ON tbl_sgd_relaciones.evaluado = tbl_objetivos_individuales.rut
INNER JOIN tbl_usuario AS base_evaluado ON base_evaluado.rut = tbl_sgd_relaciones.evaluado
INNER JOIN tbl_usuario AS base_evaluador ON base_evaluador.rut = tbl_sgd_relaciones.evaluador
INNER JOIN tbl_usuario AS base_validador ON base_validador.rut = tbl_sgd_relaciones.validador
INNER JOIN tbl_objetivos_dimension ON tbl_objetivos_individuales.dimension = tbl_objetivos_dimension.id
WHERE
1 $filtro
";

$database->setquery(utf8_decode($sql));
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DistincCentroCostoInscripcion($id_inscripcion, $rut_empresa_holding) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($rut_empresa_holding) {
$filtro_empresa = ' and tbl_inscripcion_usuarios.id_empresa="' . $rut_empresa_holding . '"';
} else {
$filtro_empresa = "";
}

$sql = "SELECT DISTINCT
(
centro_costo
) AS centro_costo from tbl_inscripcion_usuarios
WHERE
id_inscripcion = '$id_inscripcion' $filtro_empresa
";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DistincEmpresasEnInscripcionesDeUsuariosPorInscripcionV2($id_inscripcion, $rut_empresa_holding) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
if ($rut_empresa_holding) {
$filtro_empresa = ' and tbl_inscripcion_usuarios.rutempresaholding="' . $rut_empresa_holding . '"';
} else {
$filtro_empresa = "";
}

$sql = "SELECT
distinct(tbl_inscripcion_usuarios.rutempresaholding) , tbl_empresa_holding.empresa as nombre_empresa

FROM
tbl_inscripcion_usuarios

inner JOIN tbl_empresa_holding
on tbl_empresa_holding.rut=tbl_inscripcion_usuarios.rutempresaholding
WHERE
id_inscripcion = '$id_inscripcion' $filtro_empresa
";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DistincEmpresasEnInscripcionesDeUsuariosPorInscripcion($id_inscripcion, $rut_empresa_holding) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
if ($rut_empresa_holding) {
$filtro_empresa = ' and tbl_inscripcion_usuarios.id_empresa="' . $rut_empresa_holding . '"';
} else {
$filtro_empresa = "";
}

$sql = "SELECT
distinct(tbl_inscripcion_usuarios.id_empresa) , tbl_empresa_holding.empresa as nombre_empresa

FROM
tbl_inscripcion_usuarios

inner JOIN tbl_empresa_holding
on tbl_empresa_holding.rut=tbl_inscripcion_usuarios.empresa
WHERE
id_inscripcion = '$id_inscripcion' $filtro_empresa
";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ObtenerTotalDeEvaluadores($arreglo_post, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($arreglo_post["area"]) {
$filtro .= " and tbl_usuario.area='" . $arreglo_post["area"] . "'";
}

$sql = "SELECT DISTINCT
(
tbl_sgd_relaciones.evaluador
) AS rut_evaluador,
nombre,
apaterno,
amaterno,
nombre_completo,
cargo,
gerencia,
area,
email,
(
SELECT
count(*) AS total
FROM
tbl_sgd_relaciones
WHERE
tbl_sgd_relaciones.evaluado <> tbl_sgd_relaciones.evaluador
AND tbl_sgd_relaciones.evaluador = rut_evaluador
) AS total_evaluados,
(
SELECT
count(*) AS total
FROM
tbl_clave
INNER JOIN tbl_sgd_relaciones AS tabla_relaciones1 ON tabla_relaciones1.evaluado = tbl_clave.rut
WHERE
tabla_relaciones1.evaluador = rut_evaluador
AND tbl_clave.cambiado = '1'
) AS total_claves_cambiadas,
(
SELECT
count(*) AS total
FROM
tbl_objetivos_indviduales_finalizado
INNER JOIN tbl_sgd_relaciones AS tabla_relaciones2 ON tabla_relaciones2.evaluado = tbl_objetivos_indviduales_finalizado.evaluado
WHERE
tabla_relaciones2.evaluador = rut_evaluador
) AS total_proposicion_finalizadas,
(
SELECT
count(*) AS total
FROM
tbl_objetivos_ajustes_jefe
INNER JOIN tbl_sgd_relaciones AS tabla_relaciones3 ON tabla_relaciones3.evaluado = tbl_objetivos_ajustes_jefe.evaluado
AND tabla_relaciones3.evaluador = tbl_objetivos_ajustes_jefe.evaluador
WHERE
tabla_relaciones3.evaluador = rut_evaluador
) AS total_fijacion_finalizados,
(
SELECT
count(*) AS total
FROM
tbl_objetivos_validaciones
INNER JOIN tbl_sgd_relaciones AS tabla_relaciones4 ON tabla_relaciones4.evaluado = tbl_objetivos_validaciones.evaluado
AND tabla_relaciones4.evaluador = tbl_objetivos_validaciones.evaluador
WHERE
tabla_relaciones4.evaluador = rut_evaluador
) AS total_validacion_finalizados,
(
SELECT
count(*) AS total
FROM
tbl_sgd_finalizados_evaluado_evaluador
INNER JOIN tbl_sgd_relaciones AS tabla_relaciones5 ON tabla_relaciones5.evaluado = tbl_sgd_finalizados_evaluado_evaluador.evaluado
AND tabla_relaciones5.evaluador = tbl_sgd_finalizados_evaluado_evaluador.evaluador
WHERE
tabla_relaciones5.evaluador = rut_evaluador
) AS total_evaluaciones_finalizadas
FROM
tbl_sgd_relaciones
INNER JOIN tbl_usuario ON tbl_usuario.rut = tbl_sgd_relaciones.evaluador
WHERE
tbl_usuario.id_empresa = '$id_empresa' $filtro
ORDER BY
tbl_usuario.area ASC
";

$database->setquery(utf8_decode($sql));
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ObtenerTotalDetalleEvaluadoEvaluador($arreglo_post, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($arreglo_post["area"]) {
$filtro .= " and tbl_usuario.area='" . $arreglo_post["area"] . "'";
}

$sql = "SELECT
tbl_sgd_relaciones.evaluado as rut_evaluado,
tbl_sgd_relaciones.evaluador as rut_evaluador,
tbl_sgd_relaciones.validador as rut_validador,
tbl_usuario.rut_completo as rut_completo_evaluado,
tbl_usuario.nombre,
tbl_usuario.apaterno,
tbl_usuario.amaterno,
tbl_usuario.nombre_completo,
tbl_usuario.cargo,
tbl_usuario.gerencia,
tbl_usuario.area,
tbl_usuario.email,
base_evaluador.nombre as nombre_evaluador,
base_evaluador.rut_completo as rut_completo_evaluador,
base_evaluador.cargo as cargo_evaluador,
base_validador.nombre as nombre_validador,
base_validador.rut_completo as rut_completo_validador,
base_validador.cargo as cargo_validador,

(
SELECT
count(*) AS total
FROM
tbl_sgd_relaciones
WHERE
tbl_sgd_relaciones.evaluado = rut_evaluado
AND tbl_sgd_relaciones.evaluador = rut_evaluador
) AS total_evaluados,
(
SELECT
count(*) AS total
FROM
tbl_clave
INNER JOIN tbl_sgd_relaciones AS tabla_relaciones1 ON tabla_relaciones1.evaluado = tbl_clave.rut
WHERE
tabla_relaciones1.evaluador = rut_evaluador
and tabla_relaciones1.evaluado = rut_evaluado
AND tbl_clave.cambiado = '1'
) AS total_claves_cambiadas,
(
SELECT
count(*) AS total
FROM
tbl_objetivos_indviduales_finalizado
INNER JOIN tbl_sgd_relaciones AS tabla_relaciones2 ON tabla_relaciones2.evaluado = tbl_objetivos_indviduales_finalizado.evaluado
WHERE
tabla_relaciones2.evaluador = rut_evaluador and tabla_relaciones2.evaluado = rut_evaluado
) AS total_proposicion_finalizadas,
(
SELECT
count(*) AS total
FROM
tbl_objetivos_ajustes_jefe
INNER JOIN tbl_sgd_relaciones AS tabla_relaciones3 ON tabla_relaciones3.evaluado = tbl_objetivos_ajustes_jefe.evaluado
AND tabla_relaciones3.evaluador = tbl_objetivos_ajustes_jefe.evaluador
WHERE
tabla_relaciones3.evaluador = rut_evaluador and tabla_relaciones3.evaluado = rut_evaluado
) AS total_fijacion_finalizados,
(
SELECT
count(*) AS total
FROM
tbl_objetivos_validaciones
INNER JOIN tbl_sgd_relaciones AS tabla_relaciones4 ON tabla_relaciones4.evaluado = tbl_objetivos_validaciones.evaluado
AND tabla_relaciones4.evaluador = tbl_objetivos_validaciones.evaluador
WHERE
tabla_relaciones4.evaluador = rut_evaluador and tabla_relaciones4.evaluado = rut_evaluado
) AS total_validacion_finalizados,



(
SELECT
count(*) AS total
FROM
tbl_objetivos_aceptacion
INNER JOIN tbl_sgd_relaciones AS tabla_relaciones5 ON tabla_relaciones5.evaluado = tbl_objetivos_aceptacion.rut

WHERE
tabla_relaciones5.evaluado =  rut_evaluado
) AS total_finalizacion_objetivos,

(
select count(*) as total
from tbl_sgd_finalizados_evaluado_evaluador

inner join tbl_sgd_relaciones as tabla_relaciones6
on tabla_relaciones6.evaluado=tbl_sgd_finalizados_evaluado_evaluador.evaluado and tbl_sgd_finalizados_evaluado_evaluador.evaluado

WHERE
tabla_relaciones6.evaluado =  rut_evaluado


) as total_fin_rev_inte






FROM
tbl_sgd_relaciones
INNER JOIN tbl_usuario ON tbl_usuario.rut = tbl_sgd_relaciones.evaluado
inner join tbl_usuario as base_evaluador on base_evaluador.rut=tbl_sgd_relaciones.evaluador
inner join tbl_usuario as base_validador on base_validador.rut=tbl_sgd_relaciones.validador

where tbl_usuario.id_empresa='$id_empresa'   $filtro
order by     tbl_usuario.area, rut_evaluador

";

$database->setquery(utf8_decode($sql));
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ObtenerHorarios($tipo) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_horario where  tipo='$tipo'
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ActualizaDatosCierreUsuarios($id_inscripcion, $rut, $porcentaje_asistencia, $caso_especial, $nota, $estado, $viatico_utilizado, $movilizacion_utilizado) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE tbl_inscripcion_cierre
SET
porcentaje_asistencia= '$porcentaje_asistencia',
caso_especial= '$caso_especial',
nota= '$nota',
estado= '$estado',
viatico_utilizado= '$viatico_utilizado',
movilizacion_utilizada= '$movilizacion_utilizado'






WHERE id_inscripcion = '$id_inscripcion' and rut='$rut'";
$database->setquery($sql);
$database->query();
}

function VerificaEstaEnCierreSoloIdInscripcion($id_inscripcion, $id_empresa_holding) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($id_empresa) {
$sql = "SELECT
tbl_inscripcion_cierre.*
FROM
tbl_inscripcion_cierre

inner join tbl_inscripcion_usuarios
on tbl_inscripcion_usuarios.rut=tbl_inscripcion_cierre.rut and tbl_inscripcion_usuarios.id_inscripcion='18' and tbl_inscripcion_usuarios.empresa='$id_empresa_holding'
WHERE
tbl_inscripcion_cierre.id_inscripcion = '$id_inscripcion'     ";
} else {
$sql = "select * from tbl_inscripcion_cierre where  id_inscripcion='$id_inscripcion'     ";
}

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function VerificaEstaEnCierre($id_inscripcion, $rut) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_inscripcion_cierre where  id_inscripcion='$id_inscripcion' and rut='$rut'
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function BorraUsuariosCierre($id_inscripcion) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "DELETE FROM tbl_inscripcion_cierre WHERE id_inscripcion='$id_inscripcion'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ActualizaDatosRelevantesInscripcion($id_inscripcion, $mejor_alumno, $comentario_mejor_alumno, $alumno_destacado, $comentario_alumno_destacado, $mejora_continua, $comentario_mejora_continua, $porcentaje_satisfaccion, $comentario_porcentaje_satisfaccion) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE tbl_inscripcion_datos_relevantes
SET
mejor_alumno= '$mejor_alumno',
mejor_alumno_comentario= '$comentario_mejor_alumno',
alumno_destacado= '$mejor_alumno',
alumno_destacado_comentario= '$comentario_alumno_destacado',
mejora_continua= '$mejora_continua',
mejora_continua_comentario= '$comentario_mejora_continua',
porcentaje_satisfaccion= '$porcentaje_satisfaccion',
porcentaje_satisfaccion_comentario= '$comentario_porcentaje_satisfaccion'





WHERE id_inscripcion = '$id_inscripcion'";
$database->setquery($sql);
$database->query();
}

function BorraInscripcionFinalizada($id_inscripcion) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "DELETE FROM tbl_inscripcion_finalizado WHERE id_inscripcion='$id_inscripcion'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function InsertaInscripcionFinalizada($id_inscripcion) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO tbl_inscripcion_finalizado
(id_inscripcion)
VALUES     ('$id_inscripcion');";

$database->setquery($sql);
$database->query();
}

function EstaFinalizadaInscripcion($id_inscripcion) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_inscripcion_finalizado where  id_inscripcion='$id_inscripcion'
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TieneDatosRelevantesPorInscripcion($id_inscripcion) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

SELECT
tbl_inscripcion_datos_relevantes.*, b_mejor_alumno.nombre AS nombre_mejor_alumno,
b_mejor_alumno.apaterno AS apaterno_mejor_alumno,
b_mejor_alumno.amaterno AS amaterno_mejor_alumno,
b_alumno_destacado.nombre AS nombre_alumno_destacado,
b_alumno_destacado.apaterno AS apaterno_alumno_destacado,
b_alumno_destacado.amaterno AS amaterno_alumno_destacado,
b_mejora_continua.nombre nombre_mejora_continua,
b_mejora_continua.apaterno AS apaterno_mejora_continua,
b_mejora_continua.amaterno AS amaterno_mejora_continua
FROM
tbl_inscripcion_datos_relevantes
LEFT JOIN tbl_usuario AS b_mejor_alumno ON b_mejor_alumno.rut = tbl_inscripcion_datos_relevantes.mejor_alumno
LEFT JOIN tbl_usuario AS b_alumno_destacado ON b_alumno_destacado.rut = tbl_inscripcion_datos_relevantes.alumno_destacado
LEFT JOIN tbl_usuario AS b_mejora_continua ON b_mejora_continua.rut = tbl_inscripcion_datos_relevantes.mejora_continua
WHERE
id_inscripcion = '$id_inscripcion'


";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function InsertarDatosRelevantesInscripcion($id_inscripcion, $mejor_alumno, $comentario_mejor_alumno, $alumno_destacado, $comentario_alumno_destacado, $mejora_continua, $comentario_mejora_continua, $porcentaje_satisfaccion, $comentario_porcentaje_satisfaccion) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO tbl_inscripcion_datos_relevantes
(mejor_alumno, mejor_alumno_comentario, alumno_destacado, alumno_destacado_comentario, mejora_continua, mejora_continua_comentario, porcentaje_satisfaccion, porcentaje_satisfaccion_comentario, id_inscripcion)
VALUES     ( '$mejor_alumno', '$comentario_mejor_alumno', '$alumno_destacado', '$comentario_alumno_destacado', '$mejora_continua', '$comentario_mejora_continua', '$porcentaje_satisfaccion', '$comentario_porcentaje_satisfaccion', '$id_inscripcion');";

$database->setquery($sql);
$database->query();
}

function InsertaUsuariosFinalizadosInscripcion($rut, $id_inscripcion, $porcentaje_asistencia, $caso_especial, $nota, $estado, $viatico_utilizado, $movilizacion_utilizada) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO tbl_inscripcion_cierre
(rut, id_inscripcion, porcentaje_asistencia, caso_especial, nota, estado, viatico_utilizado, movilizacion_utilizada) " .

"VALUES                 ( '$rut', '$id_inscripcion', '$porcentaje_asistencia', '$caso_especial', '$nota', '$estado', '$viatico_utilizado', '$movilizacion_utilizada');";

$database->setquery($sql);
$database->query();
}

function ActualizaImagenInscripcion($id, $archivo) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE tbl_inscripcion_curso SET archivo= '$archivo' WHERE id = '$id'";
$database->setquery($sql);
$database->query();
}



function ObtengoUltimoIdInscripcion() {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select max(id) as ultimo_id from tbl_inscripcion_curso

";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function InsertaInscritosPorInsc($rut, $movilizacion, $viatico, $id_inscripcion, $tramo, $empresa, $gerencia, $centro_costo, $cargo) {
global $c_host, $c_user, $c_pass, $c_db;
$rut_completo = $rut . "-" . $dv;
$nombre_completo = $nombre . " " . $apaterno . " " . $amaterno;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO tbl_inscripcion_usuarios
(id_inscripcion, rut, movilizacion, viatico, tramo_sence, empresa, gerencia, centro_costo, cargo) " .

"VALUES                 ( '$id_inscripcion', '$rut', '$movilizacion', '$viatico', '$tramo', '$empresa', '$gerencia', '$centro_costo', '$cargo');";

$database->setquery($sql);
$database->query();
}

function ActualizaInscripcionCurso($arreglo_post) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

//TRATO LAS FECHAS
//primero separo con explode
$fechas = explode('-', trim($arreglo_post["reservation"]));
$fecha_inicio = $fechas[0];
$fecha_inicio = str_replace("/", "-", $fecha_inicio);

$fecha_termino = $fechas[1];
$fecha_termino = str_replace("/", "-", $fecha_termino);

$sql = "

UPDATE tbl_inscripcion_curso SET
fecha_inicio= '" . trim($fecha_inicio) . "',
fecha_termino= '" . trim($fecha_termino) . "',
numero_dias= '" . $arreglo_post["numero_dias"] . "',
abierto_cerrado= '" . $arreglo_post["abiertocerrado"] . "',
valor_curso= '" . $arreglo_post["valor_curso"] . "',
valor_hora_curso= '" . $arreglo_post["valor_hora_curso"] . "',
direccion= '" . $arreglo_post["direccion"] . "',
comuna= '" . $arreglo_post["comuna"] . "',
ciudad= '" . $arreglo_post["ciudad"] . "',
comentarios= '" . $arreglo_post["comentario"] . "',
id_curso= '" . Decodear3($arreglo_post["idc"]) . "',
lunes_d_am= '" . $arreglo_post["HOR_LUNES_D_AM"] . "',
lunes_h_am= '" . $arreglo_post["HOR_LUNES_H_AM"] . "',
lunes_d_pm= '" . $arreglo_post["HOR_LUNES_D_PM"] . "',
lunes_h_pm= '" . $arreglo_post["HOR_LUNES_H_PM"] . "',
martes_d_am= '" . $arreglo_post["HOR_MARTES_D_AM"] . "',
martes_h_am= '" . $arreglo_post["HOR_MARTES_H_AM"] . "',
martes_d_pm= '" . $arreglo_post["HOR_MARTES_D_PM"] . "',
martes_h_pm= '" . $arreglo_post["HOR_MARTES_H_PM"] . "',
miercoles_d_am= '" . $arreglo_post["HOR_MIERCOLES_D_AM"] . "',
miercoles_h_am= '" . $arreglo_post["HOR_MIERCOLES_H_AM"] . "',
miercoles_d_pm= '" . $arreglo_post["HOR_MIERCOLES_D_PM"] . "',
miercoles_h_pm= '" . $arreglo_post["HOR_MIERCOLES_H_PM"] . "',
jueves_d_am= '" . $arreglo_post["HOR_JUEVES_D_AM"] . "',
jueves_h_am= '" . $arreglo_post["HOR_JUEVES_H_AM"] . "',
jueves_d_pm= '" . $arreglo_post["HOR_JUEVES_D_PM"] . "',
jueves_h_pm= '" . $arreglo_post["HOR_JUEVES_H_PM"] . "',
viernes_d_am= '" . $arreglo_post["HOR_VIERNES_D_AM"] . "',
viernes_h_am= '" . $arreglo_post["HOR_VIERNES_H_AM"] . "',
viernes_d_pm= '" . $arreglo_post["HOR_VIERNES_D_PM"] . "',
viernes_h_pm= '" . $arreglo_post["HOR_VIERNES_H_PM"] . "'





WHERE id = '" . Decodear3($arreglo_post["ide"]) . "'

";

$database->setquery($sql);
$database->query();
}

function TotalInscripciones($id_curso, $estado, $fecha_inicio, $fecha_termino, $arreglo_filtro, $orderBy) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

//ORDEN

if ($orderBy) {
if ($orderBy == "curso") {
$variable_orderBy = " order by tbl_lms_curso.nombre ASC";
} else if ($orderBy == "clasificacion") {
$variable_orderBy = " order by tbl_lms_clasificacion.clasificacion ASC";
}
} else {
$variabla_orderBy = "order by tbl_inscripcion_curso.fecha_inicio";
}

//Filtro de la empresa
$filtro_empresa = "";
if ($arreglo_filtro["filtro_empresa"]) {
$filtro_empresa = "";
}

if ($id_curso) {
$filtro_id_curso = " where tbl_inscripcion_curso.id_curso='$id_curso' ";
if ($fecha_inicio && $fecha_termino) {
$filtro_id_curso .= " and  tbl_inscripcion_curso.fecha_inicio>='$fecha_inicio' and tbl_inscripcion_curso.fecha_termino<='$fecha_termino'";
if ($arreglo_filtro["filtro_curso"]) {
$filtro_id_curso .= " and  tbl_inscripcion_curso.id_curso=='" . $arreglo_filtro["filtro_curso"] . "'";
}
}
} else {

if ($fecha_inicio && $fecha_termino) {
$filtro_id_curso = " where tbl_inscripcion_curso.fecha_inicio>='$fecha_inicio' and tbl_inscripcion_curso.fecha_termino<='$fecha_termino'";
if ($arreglo_filtro["filtro_curso"]) {
$filtro_id_curso .= " and  tbl_inscripcion_curso.id_curso='" . $arreglo_filtro["filtro_curso"] . "'";
}
} else {
if ($arreglo_filtro["filtro_curso"]) {
$filtro_id_curso .= " where  tbl_inscripcion_curso.id_curso='" . $arreglo_filtro["filtro_curso"] . "'";
}
}
}

$sql = "select
tbl_inscripcion_curso.*,
tbl_lms_curso.nombre as nombre_curso,
tbl_lms_curso.cantidad_maxima_participantes,
tbl_lms_clasificacion.clasificacion as nombre_clasificacion,
tbl_lms_curso_tipo.nombre as nombre_tipo,

(select count(*) as total from tbl_enc_satis_finalizados where tbl_enc_satis_finalizados.id_inscripcion=tbl_inscripcion_curso.id) as total_participantes_encuesta_finalizado,
(select count(*) as total from tbl_correos_registros_envios where tbl_correos_registros_envios.id_inscripcion=tbl_inscripcion_curso.id) as total_envio_correos,

(select sum(viatico) as suma_viatico from tbl_inscripcion_usuarios where tbl_inscripcion_usuarios.id_inscripcion=tbl_inscripcion_curso.id) as suma_total_viaticos,
(select sum(movilizacion) as suma_movilizacion from tbl_inscripcion_usuarios where tbl_inscripcion_usuarios.id_inscripcion=tbl_inscripcion_curso.id) as suma_total_movilizacion,

(select count(*) from tbl_inscripcion_usuarios where tbl_inscripcion_usuarios.id_inscripcion=tbl_inscripcion_curso.id) as total_inscritos

from tbl_inscripcion_curso

inner join tbl_lms_curso
on tbl_lms_curso.id=tbl_inscripcion_curso.id_curso

inner join tbl_lms_clasificacion
on tbl_lms_clasificacion.id=rel_lms_malla_curso.id_clasificacion

inner join tbl_lms_curso_tipo
on tbl_lms_curso_tipo.id=tbl_lms_curso.tipo

$filtro_id_curso

$variable_orderBy


";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TotalInscripcionesPorEmpresaHolding($id_inscripcion, $id_empresa_holding) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select
tbl_inscripcion_curso.*,

tbl_lms_curso.nombre as nombre_curso,

tbl_lms_curso.cantidad_maxima_participantes,

tbl_lms_clasificacion.clasificacion as nombre_clasificacion,

tbl_lms_curso_tipo.nombre as nombre_tipo,


(select sum(viatico) as suma_viatico from tbl_inscripcion_usuarios where tbl_inscripcion_usuarios.id_inscripcion=tbl_inscripcion_curso.id and tbl_inscripcion_usuarios.empresa='$id_empresa_holding') as suma_total_viaticos,


(select sum(movilizacion) as suma_movilizacion from tbl_inscripcion_usuarios where tbl_inscripcion_usuarios.id_inscripcion=tbl_inscripcion_curso.id and tbl_inscripcion_usuarios.empresa='$id_empresa_holding') as suma_total_movilizacion,


(select count(*) from tbl_inscripcion_usuarios where tbl_inscripcion_usuarios.id_inscripcion=tbl_inscripcion_curso.id and tbl_inscripcion_usuarios.empresa='$id_empresa_holding') as total_inscritos

from tbl_inscripcion_curso

inner join tbl_lms_curso
on tbl_lms_curso.id=tbl_inscripcion_curso.id_curso

inner join tbl_lms_clasificacion
on tbl_lms_clasificacion.id=rel_lms_malla_curso.id_clasificacion

inner join tbl_lms_curso_tipo
on tbl_lms_curso_tipo.id=tbl_lms_curso.tipo

where tbl_inscripcion_curso.id='$id_inscripcion'

order by tbl_inscripcion_curso.id DESC

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function InsertaInscripcion($arreglo_post) {
global $c_host, $c_user, $c_pass, $c_db;
$rut_completo = $rut . "-" . $dv;
$nombre_completo = $nombre . " " . $apaterno . " " . $amaterno;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

//TRATO LAS FECHAS
//primero separo con explode
$fechas = explode('-', trim($_POST["reservation"]));
$fecha_inicio = $fechas[0];
$fecha_inicio = str_replace("/", "-", $fecha_inicio);

$fecha_termino = $fechas[1];
$fecha_termino = str_replace("/", "-", $fecha_termino);

$sql = "INSERT INTO tbl_inscripcion_curso
(fecha_inicio, fecha_termino, numero_dias, abierto_cerrado, valor_curso, valor_hora_curso, direccion, comuna, ciudad, comentarios, id_curso,

lunes_d_am, lunes_h_am, lunes_d_pm, lunes_h_pm,
martes_d_am, martes_h_am, martes_d_pm, martes_h_pm,
miercoles_d_am, miercoles_h_am, miercoles_d_pm, miercoles_h_pm,
jueves_d_am, jueves_h_am, jueves_d_pm, jueves_h_pm,
viernes_d_am, viernes_h_am, viernes_d_pm, viernes_h_pm

)VALUES

('" . trim($fecha_inicio) . "', '" . trim($fecha_termino) . "', '" . $arreglo_post['numero_dias'] . "', '" . $arreglo_post['abiertocerrado'] . "', '" . $arreglo_post['valor_curso'] . "', '" . $arreglo_post['valor_hora_curso'] . "', '" . $arreglo_post['direccion'] . "', '" . $arreglo_post['comuna'] . "', '" . $arreglo_post['ciudad'] . "', '" . $arreglo_post['comentario'] . "', '" . Decodear3($arreglo_post['idc']) . "',
'" . $arreglo_post['HOR_LUNES_D_AM'] . "', '" . $arreglo_post['HOR_LUNES_H_AM'] . "', '" . $arreglo_post['HOR_LUNES_D_PM'] . "', '" . $arreglo_post['HOR_LUNES_H_PM'] . "',
'" . $arreglo_post['HOR_MARTES_D_AM'] . "', '" . $arreglo_post['HOR_MARTES_H_AM'] . "', '" . $arreglo_post['HOR_MARTES_D_PM'] . "', '" . $arreglo_post['HOR_MARTES_H_PM'] . "',
'" . $arreglo_post['HOR_MIERCOLES_D_AM'] . "', '" . $arreglo_post['HOR_MIERCOLES_H_AM'] . "', '" . $arreglo_post['HOR_MIERCOLES_D_PM'] . "', '" . $arreglo_post['HOR_MIERCOLES_H_PM'] . "',
'" . $arreglo_post['HOR_JUEVES_D_AM'] . "', '" . $arreglo_post['HOR_JUEVES_H_AM'] . "', '" . $arreglo_post['HOR_JUEVES_D_PM'] . "', '" . $arreglo_post['HOR_JUEVES_H_PM'] . "',
'" . $arreglo_post['HOR_VIERNES_D_AM'] . "', '" . $arreglo_post['HOR_VIERNES_H_AM'] . "', '" . $arreglo_post['HOR_VIERNES_D_PM'] . "', '" . $arreglo_post['HOR_VIERNES_H_PM'] . "'

);";
$database->setquery($sql);
$database->query();
}

function TotalUsuariosPorInscripcion2($id_inscripcion, $empresa_holding) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
if ($empresa_holding) {
$filtro_empresa = " and tbl_inscripcion_usuarios.empresa='$empresa_holding'";
} else {
$filtro_empresa = "";
}
$sql = "select
tbl_inscripcion_usuarios.*,
tbl_usuario.nombre,
tbl_usuario.rut_completo,
tbl_usuario.dv,
tbl_usuario.apaterno,
tbl_usuario.amaterno,
tbl_usuario.nombre_completo,
tbl_usuario.fecha_nacimiento,
tbl_usuario.genero,
tbl_usuario.codigo_escolaridad,
tbl_usuario.codigo_nivel,
tbl_usuario.tipo_contrato,
tbl_usuario.tramo_sence,
tbl_usuario.email,
tbl_usuario.comuna as comuna_usuario,
tbl_usuario.nacionalidad,
tbl_usuario.direccion_particular,
tbl_lms_curso.numero_identificador,
tbl_lms_curso.nombre as nombre_curso,
tbl_lms_curso.numero_horas,
tbl_lms_curso.valor_hora,
tbl_lms_curso.cbc,
tbl_empresa_holding.empresa as nombre_empresa_holding,
tbl_empresa_holding.codigo_sucursal,
tbl_otec.nombre as nombre_otec,
tbl_otec.direccion as direccion_otec,
tbl_otec.telefono as fono_otec,
tbl_inscripcion_curso.ciudad as ciudad_inscripcion,
tbl_inscripcion_curso.fecha_inicio as fecha_inicio_ins,
tbl_inscripcion_curso.fecha_termino as fecha_termino_ins,
tbl_inscripcion_curso.comentarios as comentario_inscripcion_curso,
tbl_inscripcion_curso.direccion as direccion_inscripcion

from tbl_inscripcion_usuarios

left join tbl_usuario
on tbl_usuario.rut=tbl_inscripcion_usuarios.rut

left join tbl_empresa_holding
on tbl_empresa_holding.rut=tbl_inscripcion_usuarios.rutempresaholding

inner join tbl_inscripcion_curso
on tbl_inscripcion_curso.codigo_inscripcion=tbl_inscripcion_usuarios.id_inscripcion

inner join tbl_lms_curso
on tbl_inscripcion_curso.id_curso=tbl_lms_curso.id

inner join tbl_otec
on tbl_otec.rut=tbl_lms_curso.rut_otec

where tbl_inscripcion_usuarios.id_inscripcion='$id_inscripcion' $filtro_empresa    ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TotalUsuariosPorInscripcion($id_inscripcion, $id_empresa_holding) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($id_empresa_holding) {
$sql = "select
tbl_inscripcion_usuarios.*,
tbl_usuario.nombre_completo,
tbl_usuario.nombre,
tbl_usuario.apaterno,
tbl_usuario.amaterno,
tbl_usuario.rut_completo, tbl_usuario.rut as rut_sin_dv, tbl_usuario.email, tbl_empresa_holding.empresa as nombre_empresa_holding

from tbl_inscripcion_usuarios

left join tbl_usuario
on tbl_usuario.rut=tbl_inscripcion_usuarios.rut

left join tbl_empresa_holding
on tbl_empresa_holding.rut=tbl_inscripcion_usuarios.empresa

where id_inscripcion='$id_inscripcion' and tbl_inscripcion_usuarios.empresa='$id_empresa_holding'";
} else {
$sql = "select
tbl_inscripcion_usuarios.*,
tbl_usuario.nombre_completo,
tbl_usuario.nombre,
tbl_usuario.apaterno,
tbl_usuario.amaterno,
tbl_usuario.rut_completo, tbl_usuario.rut as rut_sin_dv, tbl_usuario.email, tbl_empresa_holding.empresa as nombre_empresa_holding

from tbl_inscripcion_usuarios

left join tbl_usuario
on tbl_usuario.rut=tbl_inscripcion_usuarios.rut

left join tbl_empresa_holding
on tbl_empresa_holding.rut=tbl_inscripcion_usuarios.empresa

where id_inscripcion='$id_inscripcion'     ";
}

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TotalUsuariosPorInscripcionCerrados2($id_inscripcion, $id_empresa_holding, $rut_colaborador, $fecha_inicio, $fecha_termino, $arreglo_filtro) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($id_empresa_holding) {
$sql = "SELECT
tbl_inscripcion_cierre.*,
tbl_usuario.nombre_completo,
tbl_usuario.nombre,
tbl_usuario.apaterno,
tbl_usuario.amaterno,
tbl_usuario.rut_completo,
tbl_usuario.rut as rut_sin_dv,
tbl_usuario.tramo_sence,
tbl_usuario.email,
tbl_inscripcion_curso.id_curso as id_del_curso,
tbl_lms_curso.numero_horas,
tbl_inscripcion_excepciones.descripcion AS descripcion_caso_especial,
tbl_inscripcion_excepciones.porcentaje AS cobertura_sence_caso_especial
FROM
tbl_inscripcion_usuarios
LEFT JOIN tbl_inscripcion_cierre ON tbl_inscripcion_cierre.rut = tbl_inscripcion_usuarios.rut
AND tbl_inscripcion_cierre.id_inscripcion = tbl_inscripcion_usuarios.id_inscripcion
LEFT JOIN tbl_usuario ON tbl_usuario.rut = tbl_inscripcion_usuarios.rut
LEFT JOIN tbl_inscripcion_excepciones ON tbl_inscripcion_excepciones.id = tbl_inscripcion_cierre.caso_especial

LEFT JOIN tbl_inscripcion_curso ON tbl_inscripcion_curso.id = tbl_inscripcion_usuarios.id_inscripcion
LEFT JOIN tbl_lms_curso ON tbl_lms_curso.id = tbl_inscripcion_curso.id_curso

WHERE
tbl_inscripcion_usuarios.id_inscripcion = '$id_inscripcion' and tbl_inscripcion_usuarios.empresa='$id_empresa_holding'
";
} else if ($rut_colaborador) {
if ($arreglo_filtro["filtro_empresa"]) {
//$filtro_empresa=" and tbl_inscripcion_usuarios.empresa='".$arreglo_filtro["filtro_empresa"]."' ";
}

if ($fecha_inicio && $fecha_termino) {
$filtro_fechas = " and (tbl_inscripcion_curso.fecha_inicio>='$fecha_inicio' and tbl_inscripcion_curso.fecha_termino<='$fecha_termino')";
}
$sql = "SELECT
tbl_inscripcion_cierre.*,
tbl_usuario.nombre_completo,
tbl_usuario.nombre,
tbl_usuario.apaterno,
tbl_usuario.amaterno,
tbl_usuario.rut_completo,
tbl_usuario.rut as rut_sin_dv,
tbl_usuario.tramo_sence,
tbl_usuario.email,
tbl_inscripcion_curso.id_curso as id_del_curso,
tbl_lms_curso.numero_horas,

tbl_inscripcion_excepciones.descripcion AS descripcion_caso_especial,
tbl_inscripcion_excepciones.porcentaje AS cobertura_sence_caso_especial
FROM
tbl_inscripcion_usuarios
LEFT JOIN tbl_inscripcion_cierre ON tbl_inscripcion_cierre.rut = tbl_inscripcion_usuarios.rut
AND tbl_inscripcion_cierre.id_inscripcion = tbl_inscripcion_usuarios.id_inscripcion
LEFT JOIN tbl_usuario ON tbl_usuario.rut = tbl_inscripcion_usuarios.rut
LEFT JOIN tbl_inscripcion_excepciones ON tbl_inscripcion_excepciones.id = tbl_inscripcion_cierre.caso_especial

inner JOIN tbl_inscripcion_curso ON tbl_inscripcion_curso.id = tbl_inscripcion_usuarios.id_inscripcion $filtro_fechas
LEFT JOIN tbl_lms_curso ON tbl_lms_curso.id = tbl_inscripcion_curso.id_curso


WHERE
tbl_inscripcion_usuarios.rut = '$rut_colaborador'  $filtro_empresa
";

//echo $sql;
//echo "<br>";
} else {
if ($arreglo_filtro["filtro_empresa"]) {
//$filtro_empresa=" and tbl_inscripcion_usuarios.empresa='".$arreglo_filtro["filtro_empresa"]."' ";
}

$sql = "

SELECT
tbl_inscripcion_cierre.*,
tbl_usuario.nombre_completo,
tbl_usuario.nombre,
tbl_usuario.apaterno,
tbl_usuario.amaterno,
tbl_usuario.rut_completo,
tbl_usuario.rut as rut_sin_dv,
tbl_usuario.tramo_sence,
tbl_usuario.email,
tbl_inscripcion_curso.id_curso as id_del_curso,
tbl_lms_curso.numero_horas,

tbl_inscripcion_excepciones.descripcion AS descripcion_caso_especial,
tbl_inscripcion_excepciones.porcentaje AS cobertura_sence_caso_especial
FROM
tbl_inscripcion_usuarios
LEFT JOIN tbl_inscripcion_cierre ON tbl_inscripcion_cierre.rut = tbl_inscripcion_usuarios.rut
AND tbl_inscripcion_cierre.id_inscripcion = tbl_inscripcion_usuarios.id_inscripcion

LEFT JOIN tbl_usuario ON tbl_usuario.rut = tbl_inscripcion_usuarios.rut

LEFT JOIN tbl_inscripcion_excepciones ON tbl_inscripcion_excepciones.id = tbl_inscripcion_cierre.caso_especial

LEFT JOIN tbl_inscripcion_curso ON tbl_inscripcion_curso.id = tbl_inscripcion_usuarios.id_inscripcion
LEFT JOIN tbl_lms_curso ON tbl_lms_curso.id = tbl_inscripcion_curso.id_curso

WHERE
tbl_inscripcion_usuarios.id_inscripcion = '$id_inscripcion' $filtro_empresa


";
}

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TotalUsuariosPorInscripcionCerrados2SoloCasosEspeciales($id_inscripcion, $rut_empresa_holding) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($rut_empresa_holding) {
$filtro_curso = " and tbl_inscripcion_usuarios.empresa = '$rut_empresa_holding'";
} else {
$filtro_curso = "";
}

$sql = "

SELECT
tbl_inscripcion_cierre.*,
tbl_usuario.nombre_completo,
tbl_usuario.nombre,
tbl_usuario.apaterno,
tbl_usuario.amaterno,
tbl_usuario.rut_completo,
tbl_usuario.rut as rut_sin_dv,
tbl_usuario.tramo_sence,
tbl_usuario.email,
tbl_inscripcion_excepciones.descripcion AS descripcion_caso_especial,
tbl_inscripcion_excepciones.porcentaje AS cobertura_sence_caso_especial
FROM
tbl_inscripcion_usuarios
LEFT JOIN tbl_inscripcion_cierre ON tbl_inscripcion_cierre.rut = tbl_inscripcion_usuarios.rut
AND tbl_inscripcion_cierre.id_inscripcion = tbl_inscripcion_usuarios.id_inscripcion

LEFT JOIN tbl_usuario ON tbl_usuario.rut = tbl_inscripcion_usuarios.rut

LEFT JOIN tbl_inscripcion_excepciones ON tbl_inscripcion_excepciones.id = tbl_inscripcion_cierre.caso_especial

WHERE
tbl_inscripcion_usuarios.id_inscripcion = '$id_inscripcion' and (tbl_inscripcion_cierre.porcentaje_asistencia='0' or tbl_inscripcion_cierre.caso_especial <>'') $filtro_curso


";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TotalUsuariosPorInscripcionCerrados($id_inscripcion) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select
tbl_inscripcion_cierre.*,
tbl_usuario.nombre_completo,
tbl_usuario.rut_completo,
tbl_usuario.nombre,
tbl_usuario.apaterno,
tbl_usuario.amaterno,
tbl_usuario.tramo_sence,
tbl_usuario.email,
tbl_inscripcion_excepciones.descripcion as descripcion_caso_especial,
tbl_inscripcion_excepciones.porcentaje as cobertura_sence_caso_especial


from tbl_inscripcion_cierre

left join tbl_usuario
on tbl_usuario.rut=tbl_inscripcion_cierre.rut

left join tbl_inscripcion_excepciones
on tbl_inscripcion_excepciones.id=tbl_inscripcion_cierre.caso_especial



where id_inscripcion='$id_inscripcion'    ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DatosInscripcion2DadoIDCurso($id_curso) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select
tbl_inscripcion_curso.*,
tbl_lms_curso.numero_horas,
tbl_lms_curso.valor_hora_sence,
(select count(*) as total from tbl_inscripcion_usuarios where tbl_inscripcion_usuarios.id_inscripcion = tbl_inscripcion_curso.id) as num_participantes,
(select sum(viatico) as suma_viatico from tbl_inscripcion_usuarios where tbl_inscripcion_usuarios.id_inscripcion = tbl_inscripcion_curso.id) as suma_viatico,
(select sum(movilizacion) as suma_movilizacion from tbl_inscripcion_usuarios where tbl_inscripcion_usuarios.id_inscripcion = tbl_inscripcion_curso.id) as suma_movilizacion

from tbl_inscripcion_curso
inner join tbl_lms_curso
on tbl_lms_curso.id=tbl_inscripcion_curso.id_curso
where tbl_inscripcion_curso.id_curso='$id_curso'

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DatosInscripcion2($id_inscripcion) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select
tbl_inscripcion_curso.*,
tbl_lms_curso.numero_horas,
tbl_lms_curso.fecha_inicio as fecha_inicio_curso,
tbl_lms_curso.fecha_finalizacion as fecha_termino_curso,
tbl_lms_curso.valor_hora_sence,
tbl_lms_curso.nombre as nombre_curso,
(select count(*) from tbl_inscripcion_usuarios where tbl_inscripcion_usuarios.id_inscripcion=tbl_inscripcion_curso.id $filtro_empresa) as total_inscritos,
(select count(*) from tbl_enc_satis_finalizados where tbl_enc_satis_finalizados.id_inscripcion=tbl_inscripcion_curso.id) as total_encuestas_finalizadas


from tbl_inscripcion_curso
inner join tbl_lms_curso
on tbl_lms_curso.id=tbl_inscripcion_curso.id_curso
where tbl_inscripcion_curso.codigo_inscripcion='$id_inscripcion'

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DatosInscripcionConMasInfo($id_inscripcion, $rut_empresa_holding) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($rut_empresa_holding) {
$filtro_empresa = " and tbl_inscripcion_usuarios.empresa='$rut_empresa_holding'";
} else {
$filtro_empresa = "";
}
$sql = "

select
tbl_inscripcion_curso.*,
tbl_lms_curso.numero_horas,
tbl_lms_curso.valor_hora as valor_h,
tbl_lms_curso.objetivo_curso,
tbl_lms_curso.nombre as nombre_curso,
tbl_lms_curso.valor_hora_sence as valor_hs,
tbl_lms_curso.fecha_inicio as fecha_inicio_curso,
tbl_lms_curso.fecha_finalizacion as fecha_termino_curso,
tbl_lms_curso.valor_hora_sence,
(select count(*) from tbl_inscripcion_usuarios where tbl_inscripcion_usuarios.id_inscripcion=tbl_inscripcion_curso.id $filtro_empresa) as total_inscritos

from tbl_inscripcion_curso
inner join tbl_lms_curso
on tbl_lms_curso.id=tbl_inscripcion_curso.id_curso
where tbl_inscripcion_curso.id='$id_inscripcion'

";

//echo $sql;exit;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function VerificaUsuarioDadoIdInscripcionRutEmpresaHolding($id_inscripcion, $rut_empresa_holding, $rut) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select rut from tbl_inscripcion_usuarios
where empresa='$rut_empresa_holding' and id_inscripcion='$id_inscripcion' and rut='$rut'

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DatosInscripcion2121($id_inscripcion) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select
tbl_inscripcion_curso.*, tbl_lms_curso.numero_horas, tbl_lms_curso.valor_hora_sence
from tbl_inscripcion_curso
inner join tbl_lms_curso
on tbl_lms_curso.id=tbl_inscripcion_curso.id_curso
where tbl_inscripcion_curso.id='$id_inscripcion'

";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DatosInscripcion($id_inscripcion) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_inscripcion_curso where id='$id_inscripcion'    ";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DatosInscripcionConCodigo($id_inscripcion) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_inscripcion_curso where codigo_inscripcion='$id_inscripcion'    ";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DesvinculaUsuario($rut) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

UPDATE tbl_usuario
SET vigencia='1'
WHERE rut = '$rut'
";
//echo $sql;exit;
$database->setquery($sql);
$database->query();
}

function ActualizaUsuario(
$rut, $nombre, $apaterno, $amaterno, $nombre_completo,
$fecha_nacimiento, $fecha_antiguedad, $genero, $email, $telefono, $celular, $anexo, $jefe,
$nacionalidad, $direccion_particular, $cargo, $id_cargo, $gerencia, $id_gerencia, $centro_costo,
$id_centro_costo, $unidad_negocio, $id_unidad_negocio, $subgerencia, $id_subgerencia, $departamento,
$zona, $ubicacion, $nombre_empresa_holding, $rut_empresa_holding, $codigo_escolaridad, $codigo_nivel,
$tipo_contrato, $tramo_sence, $perfil_competencia, $id_perfil_competencia, $id_empresa, $sucursal,
$regional, $nombre_jefatura, $vicepresidencia,
$gerenciaR2, $gerenciaR3, $area, $organica, $fecha_ingreso,
$operador, $pais, $familia_cargo, $tipo_cargo, $codigo_sap, $division,
$perfil_competencia, $mundo, $tipo_servicio, $zonal, $empresa_holding) {

echo "$rut,$nombre, $apaterno, $amaterno,$nombre_completo,
$fecha_nacimiento,$fecha_antiguedad, $genero, $email, $telefono, $celular,$anexo,$jefe,
$nacionalidad, $direccion_particular, $cargo,$id_cargo, $gerencia,$id_gerencia,$centro_costo,
$id_centro_costo,$unidad_negocio,$id_unidad_negocio,$subgerencia,$id_subgerencia,$departamento,
$zona,$ubicacion,$nombre_empresa_holding,$rut_empresa_holding,$codigo_escolaridad, $codigo_nivel,
$tipo_contrato, $tramo_sence, $perfil_competencia, $id_perfil_competencia,$id_empresa, $sucursal, $regional, $nombre_jefatura, $vicepresidencia,
$gerenciaR2, $gerenciaR3, $area, $organica, $fecha_ingreso,
$operador, $pais, $familia_cargo, $tipo_cargo, $codigo_sap, $division, $perfil_competencia, $mundo, $tipo_servicio, $zonal, $empresa_holding";
echo "<br><br>";
if ($jefe != '') {
$cuerpoRutJefe = explode("-", $jefe);
$jefe = $cuerpoRutJefe[0]; // porcin1
$jefe = limpiarSimbolosExtranos($jefe);
//echo $rut_jefe;
}

//echo "rut $rut";
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$nombre_completo = $nombre . " " . $apaterno;
$sql = "

UPDATE tbl_usuario
SET nombre= '$nombre',
apaterno= '$apaterno',
amaterno= '$amaterno',
nombre_completo= '$nombre_completo',
fecha_nacimiento= '$fecha_nacimiento',
fecha_antiguedad= '$fecha_antiguedad',
fecha_ingreso= '$fecha_ingreso',
genero= '$genero',
email= '$email',
mundo='$mundo',


tipo_servicio='$tipo_servicio',
zonal='$zonal',
empresa_holding='$empresa_holding',



telefono='$telefono',
celular='$celular',
anexo='$anexo',
jefe='$jefe',
nacionalidad= '$nacionalidad',
direccion_particular= '$direccion_particular',
cargo= '$cargo',
id_cargo= '$id_cargo',
gerencia= '$gerencia',
division= '$division',
perfil_competencia='$perfil_competencia',

sucursal= '$sucursal',
regional= '$regional',

id_gerencia= '$id_gerencia',
centro_costo= '$centro_costo',
id_centro_costo= '$id_centro_costo',
unidad_negocio= '$unidad_negocio',
id_unidad_negocio= '$id_unidad_negocio',
subgerencia= '$subgerencia',
id_subgerencia= '$id_subgerencia',
departamento= '$departamento',
zona= '$zona',
ubicacion= '$ubicacion',
nombre_empresa_holding='$nombre_empresa_holding',
codigo_escolaridad= '$codigo_escolaridad',
codigo_nivel= '$codigo_nivel',
tipo_contrato= '$tipo_contrato',
tramo_sence= '$tramo_sence',
perfil_competencia='$perfil_competencia',
id_perfil_competencia='$id_perfil_competencia',
nombre_jefatura='$nombre_jefatura',
vicepresidencia='$vicepresidencia',
gerenciaR2='$gerenciaR2',
gerenciaR3='$gerenciaR3',
area='$area',
organica='$organica',
operador='$operador',
pais='$pais',
familia_cargo='$familia_cargo',
tipo_cargo='$tipo_cargo',
codigo_sap='$codigo_sap'


WHERE rut = '$rut' AND id_empresa='$id_empresa'";

//echo $sql;exit();
$database->setquery($sql);
$database->query();
}

function ActualizaUsuarioMALO(
$rut, $nombre, $apaterno, $amaterno, $nombre_completo,
$fecha_nacimiento, $fecha_antiguedad, $genero, $email, $telefono, $celular, $anexo, $jefe,
$nacionalidad, $direccion_particular, $cargo, $id_cargo, $gerencia, $id_gerencia, $centro_costo,
$id_centro_costo, $unidad_negocio, $id_unidad_negocio, $subgerencia, $id_subgerencia, $departamento,
$zona, $ubicacion, $nombre_empresa_holding, $rut_empresa_holding, $codigo_escolaridad, $codigo_nivel,
$tipo_contrato, $tramo_sence, $perfil_competencia, $id_perfil_competencia, $id_empresa, $sucursal, $regional, $nombre_jefatura, $vicepresidencia,
$gerenciaR2, $gerenciaR3, $area, $organica, $fecha_ingreso,
$operador, $pais, $familia_cargo, $tipo_cargo, $codigo_sap) {

//echo "rut $rut";
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$nombre_completo = $nombre . " " . $apaterno;
$sql = "

UPDATE tbl_usuario
SET nombre= '$nombre',
apaterno= '$apaterno',
amaterno= '$amaterno',
nombre_completo= '$nombre_completo',
fecha_nacimiento= '$fecha_nacimiento',
fecha_antiguedad= '$fecha_antiguedad',
fecha_ingreso= '$fecha_ingreso',
genero= '$genero',
email= '$email',
telefono='$telefono',
celular='$celular',
anexo='$anexo',
jefe='$jefe',
nacionalidad= '$nacionalidad',
direccion_particular= '$direccion_particular',
cargo= '$cargo',
id_cargo= '$id_cargo',
gerencia= '$gerencia',

sucursal= '$sucursal',
regional= '$regional',

id_gerencia= '$id_gerencia',
centro_costo= '$centro_costo',
id_centro_costo= '$id_centro_costo',
unidad_negocio= '$unidad_negocio',
id_unidad_negocio= '$id_unidad_negocio',
subgerencia= '$subgerencia',
id_subgerencia= '$id_subgerencia',
departamento= '$departamento',
zona= '$zona',
ubicacion= '$ubicacion',
nombre_empresa_holding='$nombre_empresa_holding',
empresa_holding='$rut_empresa_holding',
codigo_escolaridad= '$codigo_escolaridad',
codigo_nivel= '$codigo_nivel',
tipo_contrato= '$tipo_contrato',
tramo_sence= '$tramo_sence',
perfil_competencia='$perfil_competencia',
id_perfil_competencia='$id_perfil_competencia',
nombre_jefatura='$nombre_jefatura',
vicepresidencia='$vicepresidencia',
gerenciaR2='$gerenciaR2',
gerenciaR3='$gerenciaR3',
area='$area',
organica='$organica',
operador='$operador',
pais='$pais',
familia_cargo='$familia_cargo',
tipo_cargo='$tipo_cargo',
codigo_sap='$codigo_sap'


WHERE rut = '$rut' AND id_empresa='$id_empresa'";

//echo $sql;exit();
$database->setquery($sql);
$database->query();
}

function InsertaUsuario($rut, $dv, $rut_completo, $nombre, $apaterno, $amaterno, $nombre_completo,
$fecha_nacimiento, $fecha_antiguedad, $genero, $email, $telefono, $celular, $anexo, $rut_jefe,
$nacionalidad, $direccion_particular, $cargo, $id_cargo, $gerencia, $id_gerencia, $centro_costo,
$id_centro_costo, $unidad_negocio, $id_unidad_negocio, $subgerencia, $id_subgerencia, $departamento,
$zona, $ubicacion, $nombre_empresa_holding, $rut_empresa_holding, $codigo_escolaridad, $codigo_nivel,
$tipo_contrato, $tramo_sence, $perfil_competencia, $id_perfil_competencia, $id_empresa,
$sucursal, $regional, $nombre_jefatura, $vicepresidencia, $gerenciaR2, $gerenciaR3, $area, $organica,
$operador, $pais, $familia_cargo, $tipo_cargo, $codigo_sap, $jefe, $division,
$tipo_servicio, $mundo, $empresa_holding, $fecha_ingreso, $zonal) {

$rut_completo_original = $rut_completo;
//rut key

if ($rut_completo != '') {
$cuerpoRut = explode("-", $rut_completo);
$rut = $cuerpoRut[0]; // porcin1
$rut = limpiarSimbolosExtranos($rut);
}

//rut completo sin puntos
if ($rut_completo != '') {
$rut_completo = LimpiaRut($rut_completo);
}
//jefe
//echo "rut jefe $rut_jefe";
if ($rut_jefe != '') {
$rut_jefe = LimpiaRut($rut_jefe);
//echo $rut_jefe;
}

if ($jefe != '') {
$cuerpoJefe = explode("-", $jefe);
$jefe = $cuerpoJefe[0]; // porcin1
$jefe = limpiarSimbolosExtranos($jefe);
//echo $jefe;
}
//"anxro rut jefe $rut_jefe";

if ($id_empresa == 61) {
$rut_completo_original = str_replace(".", "", $rut_completo_original);
$rut_completo = $rut_completo_original;
}

if ($id_empresa == 52) {
$rut_completo_original = str_replace(".", "", $rut_completo_original);
$rut_completo = $rut_completo_original;
}

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO tbl_usuario
(rut, dv, rut_completo, nombre, apaterno, amaterno,
nombre_completo,cargo,id_cargo,fecha_nacimiento, genero, email,
nacionalidad, direccion_particular, codigo_escolaridad,
codigo_nivel, gerencia,  unidad_negocio,
centro_costo, empresa_holding, fecha_antiguedad,
tipo_contrato, tramo_sence, perfil_competencia, id_empresa, nombre_empresa_holding,
ubicacion, id_centro_costo, id_unidad_negocio,
telefono, sucursal,celular,anexo,id_gerencia,subgerencia,id_subgerencia,departamento,
zona,id_perfil_competencia, regional, nombre_jefatura, vicepresidencia, gerenciaR2, gerenciaR3, area, organica,
operador, pais, familia_cargo, tipo_cargo, codigo_sap, jefe, division,
tipo_servicio, mundo, fecha_ingreso, zonal) " .

"VALUES                 ('$rut', '$dv', '$rut_completo', '$nombre','$apaterno', '$amaterno',
'$nombre_completo','$cargo','$id_cargo','$fecha_nacimiento','$genero',
'$email', '$nacionalidad','$direccion_particular',
'$codigo_escolaridad','$codigo_nivel', '$gerencia',
'$unidad_negocio', '$centro_costo', '$empresa_holding',
'$fecha_antiguedad', '$tipo_contrato', '$tramo_sence', '$perfil_competencia',
'$id_empresa', '$nombre_empresa_holding', '$ubicacion',
'$id_centro_costo', '$id_unidad_negocio',  '$telefono',
'$sucursal','$celular','$anexo','$id_gerencia','$subgerencia','$id_subgerencia','$departamento',
'$zona','$id_perfil_competencia', '$regional','$nombre_jefatura', '$vicepresidencia', '$gerenciaR2', '$gerenciaR3', '$area', '$organica',
'$operador', '$pais', '$familia_cargo', '$tipo_cargo', '$codigo_sap', '$rut_jefe', '$division',
'$tipo_servicio', '$mundo', '$fecha_ingreso', '$zonal');";

//echo "<br>InsertaUsuario<br>".$sql;exit();
$database->setquery($sql);
$database->query();
}

function InsertaUsuarioTemp(
$rut, $dv, $nombre, $apaterno, $amaterno, $fecha_nacimiento, $genero,
$email, $nacionalidad, $direccion_particular, $codigo_escolaridad, $codigo_nivel,
$gerencia, $cargo, $unidad_negocio, $centro_costo, $empresa_holding,
$fecha_antiguedad, $tipo_contrato, $tramo_sence, $perfil_evaluacion, $nombre_empresa_holding,
$nombre_completo, $ubicacion, $id_centro_costo, $id_unidad_negocio, $escolaridad, $rut_jefe,
$telefono, $sucursal, $accion, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$rut_completo = $rut . "-" . $dv;
//$nombre_completo=$nombre." ".$apaterno." ".$amaterno;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO tbl_usuario_temp
(rut, dv, rut_completo, nombre, apaterno, amaterno,
cargo, fecha_nacimiento, genero, email,
nacionalidad, direccion_particular, codigo_escolaridad,
codigo_nivel, gerencia,  unidad_negocio,
centro_costo, empresa_holding, fecha_antiguedad,
tipo_contrato, tramo_sence, perfil_evaluacion, id_empresa, accion, nombre_empresa_holding,
nombre_completo, ubicacion, id_centro_costo, id_unidad_negocio, escolaridad,
jefe, telefono, sucursal) " .

"VALUES                 ('$rut', '$dv', '$rut_completo', '$nombre',
'$apaterno', '$amaterno',
'$cargo', '$fecha_nacimiento', '$genero',
'$email', '$nacionalidad','$direccion_particular',
'$codigo_escolaridad','$codigo_nivel', '$gerencia',
'$unidad_negocio', '$centro_costo', '$empresa_holding',
'$fecha_antiguedad', '$tipo_contrato', '$tramo_sence',
'$perfil_evaluacion', '$id_empresa', '$accion', '$nombre_empresa_holding',
'$nombre_completo', '$ubicacion', '$id_centro_costo', '$id_unidad_negocio',
'$escolaridad', '$rut_jefe', '$telefono', '$sucursal'

);";

$database->setquery($sql);
$database->query();
}

function TodosLosCursosTemp() {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT * from tbl_lms_curso_temp ";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function CancelaProcesamientoPrevioUsuarios($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "DELETE FROM tbl_usuario_temporal WHERE id_empresa = '$id_empresa'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
}

function CancelaProcesamientoPrevio() {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "truncate tbl_lms_curso_temp;

";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
}

function TotalUsuariosTemp($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT * FROM tbl_usuario_temporal WHERE id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function Lms_vigencia1_usuarios($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "delete from tbl_usuario WHERE id_empresa='$id_empresa'";

//echo $sql;
//exit();
//    $database->setquery($sql);
//    $database->query();
$cod = $database->listObjects();

return $cod;
}

function TotalCursosTemp() {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT
tbl_lms_curso_temp.*, tbl_modalidad_curso.modalidad as nombre_modalidad, tbl_lms_clasificacion.clasificacion as nombre_clasificacion
FROM
tbl_lms_curso_temp
INNER JOIN tbl_modalidad_curso ON tbl_lms_curso_temp.modalidad = tbl_modalidad_curso.id
left join tbl_lms_clasificacion
on tbl_lms_clasificacion.id=tbl_lms_curso_temp.clasificacion

order by tbl_lms_curso_temp.id desc

";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function InsertaCursoTemp($nombre_curso, $descripcion_curso, $modalidad, $tipo_curso, $prerequisito_curso, $archivo, $objetivo_curso, $sence, $numero_horas, $cantidad_maxima_participantes, $rut_otec, $clasificacion_curso, $cbc, $cod_identificador, $accion, $id_curso, $valor_hora, $valor_hora_sence) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO tbl_lms_curso_temp(nombre, descripcion, modalidad, tipo, prerequisito, imagen, objetivo_curso, sence, numero_horas,cantidad_maxima_participantes, rut_otec, clasificacion, cbc, numero_identificador,  accion, id_curso, valor_hora, valor_hora_sence) " .
"VALUES ('$nombre_curso', '$descripcion_curso', '$modalidad', '$tipo_curso', '$prerequisito_curso', '$archivo', '$objetivo_curso', '$sence', '$numero_horas', '$cantidad_maxima_participantes', '$rut_otec', '$clasificacion_curso', '$cbc', '$cod_identificador',  '$accion', $id_curso, '$valor_hora', '$valor_hora_sence');";

$database->setquery($sql);
$database->query();
}

function VerificaCodIdentificador($cod) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT * from tbl_lms_curso where numero_identificador='$cod'
";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function VerificaCodSence($codSence) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT * from tbl_lms_curso where cod_sence='$codSence'
";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function SelectParaPaginacion($tabla) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT * from $tabla where id_empresa=19
";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function SelectTotalParaPaginacionUsuario($tabla, $id_empresas, $arreglo_post, $id_proceso, $rut_evaluador) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if (!$pagina or $pagina == 1) {
$limite_interior = 0;
} else {
$limite_interior = ($pagina - 1) * $registros_por_pagina;
}

if ($arreglo_post["gerencia"]) {
$filtro = " and tbl_usuario.gerencia='" . $arreglo_post["gerencia"] . "'";
}

if ($arreglo_post["un"]) {
$filtro .= " and tbl_usuario.unidad_negocio='" . $arreglo_post["un"] . "'";
}

if ($arreglo_post["area"]) {
$filtro .= " and tbl_usuario.area='" . $arreglo_post["area"] . "'";
}

if ($arreglo_post["filtro_empresa_holding"]) {
$filtro .= " and tbl_usuario.empresa_holding='" . $arreglo_post["filtro_empresa_holding"] . "'";
}

if ($arreglo_post["filtro_centrocosto"]) {
$filtro .= " and tbl_usuario.centro_costo='" . $arreglo_post["filtro_centrocosto"] . "'";
}

if ($id_proceso) {
$filtro .= " and $tabla.id_proceso='$id_proceso' ";
}

if ($arreglo_post["asc_desc"]) {
$ascdesc = $arreglo_post["asc_desc"];
}

if ($arreglo_post["orderBy"]) {
$orderBy = " order by " . $arreglo_post["orderBy"] . " " . $ascdesc;
} else {
$orderBy = " order by $tabla.id desc";
}

if ($arreglo_post["orderBy"] == "" and $tabla == "tbl_usuario") {
$orderBy = " order by apaterno asc";
}

if ($arreglo_post["orderBy"] == "" and $tabla == "tbl_otec") {
$orderBy = " order by nombre asc";
}

$inner = "";
if ($tabla == "tbl_sgd_relaciones") {
$inner = "inner join tbl_usuario on $tabla.evaluado=tbl_usuario.rut";
}

$filtro_evaluador = "";
if ($rut_evaluador) {
$filtro_evaluador = " and tbl_sgd_relaciones.evaluador='$rut_evaluador'";
}

$sql = "
SELECT * from $tabla $inner where vigencia='0' AND id_empresa=$id_empresas $filtro $filtro_evaluador

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ColaboradoresDadoJefe($rut) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
if (!$pagina or $pagina == 1) {
$limite_interior = 0;
} else {
$limite_interior = ($pagina - 1) * $registros_por_pagina;
}
$sql = "
SELECT * from tbl_usuario where jefe=$rut



";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DatosParaListadoPaginado($tabla, $id_empresa, $registros_por_pagina, $pagina, $arreglo_post) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($arreglo_post["gerencia"]) {
$filtro = " and tbl_usuario.gerencia='" . $arreglo_post["gerencia"] . "'";
}

if ($arreglo_post["un"]) {
$filtro .= " and tbl_usuario.unidad_negocio='" . $arreglo_post["un"] . "'";
}

if ($arreglo_post["area"]) {
$filtro .= " and tbl_usuario.area='" . $arreglo_post["area"] . "'";
}

if ($arreglo_post["filtro_empresa_holding"]) {
$filtro .= " and tbl_usuario.empresa_holding='" . $arreglo_post["filtro_empresa_holding"] . "'";
}

if ($arreglo_post["filtro_centrocosto"]) {
$filtro .= " and tbl_usuario.centro_costo='" . $arreglo_post["filtro_centrocosto"] . "'";
}

if ($arreglo_post["asc_desc"]) {
$ascdesc = $arreglo_post["asc_desc"];
}

if ($arreglo_post["orderBy"]) {
$orderBy = " order by " . $arreglo_post["orderBy"] . " " . $ascdesc;
} else {
$orderBy = " order by $tabla.id desc";
}

if ($arreglo_post["orderBy"] == "" and $tabla == "tbl_usuario") {
$orderBy = " order by apaterno asc";
}

if ($arreglo_post["orderBy"] == "" and $tabla == "tbl_otec") {
$orderBy = " order by nombre asc";
}

if ($tabla == "tbl_usuario") {
$cruce_holding = ", tbl_empresa_holding.empresa as nombre_empresa_holding_, tbl_sgd_perfiles_ponderaciones.descripcion as perfil_evaluacion_descripcion  ";
$cruce_left_join_empresa = "left join tbl_empresa_holding
on tbl_empresa_holding.rut=tbl_usuario.empresa_holding left join tbl_sgd_perfiles_ponderaciones on tbl_sgd_perfiles_ponderaciones.perfil=tbl_usuario.perfil_evaluacion";
}

if (!$pagina or $pagina == 1) {
$limite_interior = 0;
} else {
$limite_interior = ($pagina - 1) * $registros_por_pagina;
}
$sqlBK = "
SELECT $tabla.* $cruce_holding from $tabla

$cruce_left_join_empresa
where vigencia='0' AND $tabla.id_empresa=$id_empresa
$filtro $orderBy
limit $limite_interior, $registros_por_pagina


";

$sql = "
SELECT tbl_clave.clave,tbl_clave.cambiado,$tabla.* $cruce_holding from $tabla

$cruce_left_join_empresa
INNER JOIN tbl_clave ON tbl_clave.rut=tbl_usuario.rut
where vigencia='0' AND $tabla.id_empresa=$id_empresa
$filtro $orderBy
limit $limite_interior, $registros_por_pagina


";

$sql = "
SELECT tbl_clave.clave,tbl_clave.cambiado,$tabla.* $cruce_holding from $tabla

$cruce_left_join_empresa
INNER JOIN tbl_clave ON tbl_clave.rut=tbl_usuario.rut
where vigencia='0' AND $tabla.id_empresa=$id_empresa
$filtro $orderBy



";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function SelectParaPaginacionUsuario($tabla, $id_empresa, $registros_por_pagina) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
if (!$pagina or $pagina == 1) {
$limite_interior = 0;
} else {
$limite_interior = ($pagina - 1) * $registros_por_pagina;
}
$sql = "
SELECT * from $tabla where id_empresa=$id_empresa
limit $limite_interior, $registros_por_pagina


";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TotalCursosParaPaginacion($arreglo_post, $pagina, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

if (!$pagina) {
$pagina = 0;
} else if ($pagina == 1) {
$pagina = 0;
} else {
$pagina = ($pagina - 1) * 10;
}
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$filtro = "";

if ($arreglo_post["filtro_clasificacion"] != 0) {
$filtro .= " and rel_lms_malla_curso.id_clasificacion='" . $arreglo_post["filtro_clasificacion"] . "'";
}

if ($arreglo_post["filtro_tipo_curso"] != 0) {
$filtro .= " and tbl_lms_curso.tipo='" . $arreglo_post["filtro_tipo_curso"] . "'";
}

if ($arreglo_post["filtro_sence"] != 0) {
$filtro .= " and tbl_lms_curso.sence='" . $arreglo_post["filtro_sence"] . "'";
}

if ($arreglo_post["filtro_modalidad"] != 0) {
$filtro .= " and tbl_lms_curso.modalidad='" . $arreglo_post["filtro_modalidad"] . "'";
}

if ($arreglo_post["filtro_otec"] != 0) {
$filtro .= " and tbl_lms_curso.rut_otec='" . $arreglo_post["filtro_otec"] . "'";
}

$sql = "SELECT
tbl_lms_curso.*, tbl_modalidad_curso.modalidad as nombre_modalidad, tbl_lms_clasificacion.clasificacion as nombre_clasificacion, tbl_otec.nombre as nombre_otec,
tbl_lms_curso_tipo.nombre as nombre_tipo_curso
FROM
tbl_lms_curso
INNER JOIN tbl_modalidad_curso ON tbl_lms_curso.modalidad = tbl_modalidad_curso.id
left join tbl_lms_clasificacion
on tbl_lms_clasificacion.id=rel_lms_malla_curso.id_clasificacion

left join tbl_otec
on tbl_otec.rut=tbl_lms_curso.rut_otec

left join tbl_lms_curso_tipo
on tbl_lms_curso_tipo.id=tbl_lms_curso.tipo

where 1 $filtro and tbl_lms_curso.activo=0 and tbl_lms_curso.id_empresa=$id_empresa
order by tbl_lms_curso.id desc limit $pagina, 10

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DatosOtecDadoRut($rut_otec) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT * from tbl_otec where rut='$rut_otec'
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TotalProcesosDeCorreos($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT
tbl_correos_proceso.*, (
SELECT
count(*)
FROM
tbl_correos_usuarios_proceso
WHERE
tbl_correos_usuarios_proceso.id_proceso = tbl_correos_proceso.id
) AS total_usuarios_por_inscripcion
FROM
tbl_correos_proceso

WHERE
tbl_correos_proceso.id_empresa='$id_empresa'
ORDER BY
tbl_correos_proceso.id DESC";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TotalOtecs($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT* from tbl_otec where id_empresa='$id_empresa' order by id asc
";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ActualizaActivoInactivoCurso($id) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$id_curso=Decodear3($id);
//echo "id_curso $id_curso";
$sql = "delete from tbl_lms_curso  WHERE id = '$id_curso'";
//echo $sql;exit();    
$database->setquery($sql);
$database->query();
}

function DatosporTBLCursos($curso) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "
select * from tbl_dnc_base_cursos_consolidado
where curso='$curso'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function DatosporCursos($curso) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "
select * from tbl_dnc_base_consolidado
where curso='$curso' group by conducta_esperada";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function DatosporpRankingRIORIZACIONCursos($gerencia) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select count(curso) as cuenta, curso from tbl_dnc_base_consolidado where gerencia='$gerencia' and priorizacioncursos>0 group by curso order by count(curso) DESC";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function DatosporpRIORIZACIONCursos($curso) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "
select * from tbl_dnc_base_consolidado
where curso='$curso' and priorizacioncursos>0 group by cargo order by gerencia, nivel, cargo";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function DatosconsolidadoDncCursos() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_dnc_base_consolidado GROUP BY curso";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function DatosconsolidadoListaGerencia() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.* from tbl_dnc_base_consolidado h group by gerencia";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function DatosconsolidadoListaCARGOS() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.* from tbl_dnc_base_consolidado h where gerencia<>'MANTENIMIENTO' group by cargo order by gerencia ASC, nivel ASC ";
//    echo "Sql $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function DatosconsolidadoListaCursos() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.* from tbl_dnc_base_consolidado h where priorizacioncursos>0 group by curso order by curso ASC";

//     echo "Sql $sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function DatosconsolidadoBuscaPrioridadListaCARGOS($codigo, $curso) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.* from tbl_dnc_base_consolidado h where curso='$curso' and codigo='$codigo' and priorizacioncursos>0";
//echo "<br />$sql";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

if ($codigo == '62' and $curso == 'Liderazgo Adaptativo') {
//    echo "<br />$sql";
// print_r($cod);
}

return $cod;
}
function DatosconsolidadoDncCursosG() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.*, (SELECT COUNT(*) FROM tbl_dnc_base_consolidado where curso=h.curso and priorizacioncursos>0) as cuenta from tbl_dnc_base_consolidado h where priorizacioncursos>0 group by curso
order by (SELECT COUNT(*) FROM tbl_dnc_base_consolidado where curso=h.curso and priorizacioncursos>0) DESC";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function DatosconsolidadoDncCursosT() {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_dnc_base_consolidado where gt='T' GROUP BY curso";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TematicasconsolidadoDadoCursosCargo($curso) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "
select tematica from tbl_dnc_base_cursos_consolidado
where  curso='$curso'
GROUP BY tematica

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}
function PerfilAdmin($id) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_admin_perfiles where id='$id'

";

//echo $sql; sleep(2);

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DatosconsolidadoCursosDadoAgrupados($id_cargo) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sqlDistinctDimension = "
select * from tbl_dnc_base_consolidado
where id_cargo='$id_cargo'
GROUP BY dimension
order by curso

";

$sql = "
select * from tbl_dnc_base_consolidado
where id_cargo='$id_cargo'
GROUP BY curso
order by curso

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DatosconsolidadoCursosG() {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select * from tbl_dnc_base_consolidado
where gt='G'
GROUP BY curso

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DatosconsolidadoCursosT() {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select * from tbl_dnc_base_consolidado
where gt='T'
GROUP BY curso

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DatosconsolidadoCursosDadoAgrupadosP($id_cargo) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_dnc_base_consolidado where id_cargo='$id_cargo'
and priorizacioncursos is not NULL GROUP BY curso order by priorizacioncursos ASC";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DatosconsolidadoCursosDadoAgrupadosG($id_cargo) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select * from tbl_dnc_base_consolidado
where id_cargo='$id_cargo' and gt='G'
GROUP BY curso
order by priorizacion

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DatosconsolidadoCursosDadoAgrupadosT($id_cargo) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sqlDistinctDimension = "
select * from tbl_dnc_base_consolidado
where id_cargo='$id_cargo' and gt='T'
GROUP BY curso
order by priorizacion

";

$sql = "
select * from tbl_dnc_base_consolidado
where id_cargo='$id_cargo' and gt='T'
GROUP BY curso
order by priorizacion

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DatosconsolidadoCursosDadoDimension($dimension) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select * from tbl_dnc_relacion_dimension_curso where dimension='$dimension'
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DatosconsolidadoConductasDadoIdCargo($id_cargo) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select * from tbl_dnc_base_consolidado where id_cargo='$id_cargo' group by conducta order by priorizacion
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DatosconsolidadoDnc($tipo, $nivel, $gerencia) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sq = "";
if ($nivel != "-") {
$sq .= " and nivel='$nivel'";
}
if ($gerencia != "-") {
$sq .= " and gerencia='$gerencia'";
}
$sql = "
select * from
tbl_dnc_base_consolidado
where (gt='G' or gt='T') " . $sq . "


group by cargo, objetivo_cargo
order by gerencia, nivel
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ObtenerTodosLosCursosDinamico($id_curso) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT
tbl_lms_curso.*, rel_nivel_curso.id_nivel AS nivel,
tbl_programa.nombre AS NombrePrograma,
(select count(*) from tbl_objeto where tbl_objeto.id_curso=tbl_lms_curso.id) as total_objetos
FROM
tbl_lms_curso
INNER JOIN rel_nivel_curso ON rel_nivel_curso.id_curso = tbl_lms_curso.id
INNER JOIN tbl_nivel ON tbl_nivel.id = rel_nivel_curso.id_nivel
INNER JOIN tbl_programa ON tbl_programa.id = tbl_nivel.id_programa

where tbl_lms_curso.id='$id_curso'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ObtenerTodosLosCursos($arreglo_post) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$filtro = "";
if ($arreglo_post["curso"] > 0) {
$filtro .= " and tbl_lms_curso.id='" . $arreglo_post["curso"] . "' ";
}

if ($arreglo_post["programa"] > 0) {
$filtro .= " and tbl_programa.id='" . $arreglo_post["programa"] . "' ";
}

$sql = "SELECT
tbl_lms_curso.*, rel_nivel_curso.id_nivel AS nivel,
tbl_programa.nombre AS NombrePrograma,
(select count(*) from tbl_objeto where tbl_objeto.id_curso=tbl_lms_curso.id) as total_objetos
FROM
tbl_lms_curso
INNER JOIN rel_nivel_curso ON rel_nivel_curso.id_curso = tbl_lms_curso.id
INNER JOIN tbl_nivel ON tbl_nivel.id = rel_nivel_curso.id_nivel
INNER JOIN tbl_programa ON tbl_programa.id = tbl_nivel.id_programa where 1 $filtro "
;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ObtenerUltimaPregunta() {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select max(id) as ultimo_id from tbl_evaluaciones_preguntas";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function VerificaObjetoFinalizadoDadoObjetoRut($id_objeto, $rut) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select nota from tbl_objetos_finalizados where rut='$rut' and id_objeto='$id_objeto'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TotalObjetosEvaluacionesDadoCursoYEmpresa($id_curso, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_objeto where id_curso='$id_curso' and id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TotalObjetosEvaluacionesDadoCurso($id_curso) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_objeto where id_curso='$id_curso'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ActualizarObjetivoDNCADMIN($objetivo, $conducta1, $conducta2, $conducta3, $id_objetivo) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "update tbl_dnc_objetivos set objetivo='$objetivo', conducta1='$conducta1', conducta2='$conducta2', conducta3='$conducta3' where id='$id_objetivo';";
$database->setquery($sql);
$database->query();
}

function TraeObjetivosDadoCargoYJefe($jefe, $cargo) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_dnc_objetivos where jefe='$jefe' and cargo='$cargo'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ListadoJefes($POST) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$filtro = "";
if ($POST["empresa"]) {$filtro .= " and negocio='" . $POST["empresa"] . "'";}
if ($POST["zona"]) {$filtro .= " and zona='" . $POST["zoa"] . "'";}
if ($POST["gerencia"]) {$filtro .= " and gerencia='" . $POST["gerencia"] . "'";}
if ($POST["area"]) {$filtro .= " and area='" . $POST["area"] . "'";}
if ($POST["local"]) {$filtro .= " and local='" . $POST["local"] . "'";}
$sql = "select distinct(jefe)
from tbl_usuario
where jefe is not null $filtro

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

/*
Creador: chis
Motivo: Obtener noticias dado id.
FEcha 01 03 2015
*/

function DatosNoticias($id) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_noticias where id=" . $id;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function InsertaNoticiaBK($titulo, $contenido, $tag, $categoria, $perfil, $fecha_creacion, $datos_subida, $estado, $bajada, $gerencia, $subcategoria, $id_empresa, $autor, $id_mundo, $id_comunidad, $imagen_thumb, $imagen_slider, $nombre_video) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO tbl_noticias(titulo, contenido, tag, categoria, perfil, fecha_creacion, portada, estado, bajada, gerencia,  subcategoria, id_empresa, rut_creador, id_mundo, id_comunidad, imagen_thumb, imagen_slider, nombre_video) " .
"VALUES ('$titulo', '$contenido', '$tag', '$categoria', '$perfil', '$fecha_creacion', '$datos_subida', '$estado', '$bajada', '$gerencia',  '$subcategoria', '$id_empresa', '$autor', '$id_mundo', '$id_comunidad', '$imagen_thumb', '$imagen_slider', '$nombre_video');";

$database->setquery($sql);
$database->query();
}

function InsertaNoticia($titulo, $contenido, $tag, $categoria, $perfil, $fecha_creacion, $datos_subida, $estado, $bajada, $gerencia, $subcategoria, $id_empresa, $autor, $id_mundo, $id_comunidad, $imagen_thumb, $imagen_slider, $principal, $nombre_video, $id_galeria, $id_biblioteca, $doc1, $doc2, $doc3, $doc4, $doc5, $descripcion_doc1, $descripcion_doc2, $descripcion_doc3, $descripcion_doc4, $descripcion_doc5) {

if ($imagen_slider == "") {
$activa_slider = 0;
} else {
$activa_slider = UltimoSlider($id_empresa);
}
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "INSERT INTO tbl_noticias(titulo, contenido, tag, categoria, perfil, fecha_creacion, portada, estado, bajada, gerencia,  subcategoria, id_empresa, rut_creador, id_mundo, id_comunidad, imagen_thumb, imagen_slider,slider_activo, principal, nombre_video, id_galeria, id_biblioteca, doc1, doc2, doc3, doc4, doc5, descripcion_doc1, descripcion_doc2, descripcion_doc3, descripcion_doc4, descripcion_doc5) " .
"VALUES ('$titulo', '$contenido', '$tag', '$categoria', '$perfil', '$fecha_creacion', '$datos_subida', '$estado', '$bajada', '$gerencia',  '$subcategoria', '$id_empresa', '$autor', '$id_mundo', '$id_comunidad', '$imagen_thumb', '$imagen_slider','$activa_slider','$principal', '$nombre_video', '$id_galeria', '$id_biblioteca', '$doc1', '$doc2', '$doc3', '$doc4', '$doc5', '$descripcion_doc1', '$descripcion_doc2', '$descripcion_doc3', '$descripcion_doc4', '$descripcion_doc5');";

$database->setquery($sql);
$database->query();
}

function ActualizaNoticiaConImagen($id_noticia, $titulo, $contenido, $tag, $categoria, $perfil, $estado, $portada,
$bajada, $gerencia, $subcategoria, $autor, $id_mundo, $id_comunidad, $thumb, $principal
, $nombre_video, $id_galeria, $id_biblioteca, $nombre_doc1, $nombre_doc2, $nombre_doc3, $nombre_doc4, $nombre_doc5,
$descripcion_doc1, $descripcion_doc2, $descripcion_doc3, $descripcion_doc4, $descripcion_doc5
) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE tbl_noticias SET
titulo= '$titulo',
contenido='$contenido',
tag='$tag',
categoria='$categoria',
perfil='$perfil',
estado='$estado',
portada='$portada',
bajada='$bajada',
id_mundo='$id_mundo',
id_comunidad='$id_comunidad',
gerencia='$gerencia',
subcategoria='$subcategoria',
imagen_thumb='$thumb',
principal='$principal',

nombre_video='$nombre_video',
id_galeria='$id_galeria',
id_biblioteca='$id_biblioteca',
doc1='$nombre_doc1',
descripcion_doc1='$descripcion_doc1',

doc2='$nombre_doc2',
descripcion_doc2='$descripcion_doc2',

doc3='$nombre_doc3',
descripcion_doc3='$descripcion_doc3',

doc4='$nombre_doc4',
descripcion_doc4='$descripcion_doc4',

doc5='$nombre_doc5',
descripcion_doc5='$descripcion_doc5'

WHERE id = '$id_noticia'";
$database->setquery($sql);
$database->query();
}

function ActualizaNoticiaConImagenSlider($id_noticia, $titulo, $contenido, $tag, $categoria, $perfil, $estado, $portada,
$bajada, $gerencia, $subcategoria, $autor, $id_mundo, $id_comunidad, $thumb, $slider, $id_empresa, $principal
, $nombre_video, $id_galeria, $id_biblioteca, $nombre_doc1, $nombre_doc2, $nombre_doc3, $nombre_doc4, $nombre_doc5,
$descripcion_doc1, $descripcion_doc2, $descripcion_doc3, $descripcion_doc4, $descripcion_doc5) {

$slider_activo = UltimoSlider($id_empresa);

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE tbl_noticias SET
titulo= '$titulo',
contenido='$contenido',
tag='$tag',
categoria='$categoria',
perfil='$perfil',
estado='$estado',
portada='$portada',
bajada='$bajada',
id_mundo='$id_mundo',
id_comunidad='$id_comunidad',
gerencia='$gerencia',
subcategoria='$subcategoria',
imagen_slider='$slider',
imagen_thumb='$thumb',
slider_activo='$slider_activo',
principal='$principal',

nombre_video='$nombre_video',
id_galeria='$id_galeria',
id_biblioteca='$id_biblioteca',
doc1='$nombre_doc1',
descripcion_doc1='$descripcion_doc1',

doc2='$nombre_doc2',
descripcion_doc2='$descripcion_doc2',

doc3='$nombre_doc3',
descripcion_doc3='$descripcion_doc3',

doc4='$nombre_doc4',
descripcion_doc4='$descripcion_doc4',

doc5='$nombre_doc5',
descripcion_doc5='$descripcion_doc5'

WHERE id = '$id_noticia'";
$database->setquery($sql);
$database->query();
}

function ActualizaNoticiaConSlider($id_noticia, $titulo, $contenido, $tag, $categoria, $perfil, $estado,
$bajada, $gerencia, $subcategoria, $autor, $id_mundo, $id_comunidad, $slider, $id_empresa, $principal
, $nombre_video, $id_galeria, $id_biblioteca, $nombre_doc1, $nombre_doc2, $nombre_doc3, $nombre_doc4, $nombre_doc5,
$descripcion_doc1, $descripcion_doc2, $descripcion_doc3, $descripcion_doc4, $descripcion_doc5
) {

$slider_activo = UltimoSlider($id_empresa);
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE tbl_noticias SET
titulo= '$titulo',
contenido='$contenido',
tag='$tag',
categoria='$categoria',
perfil='$perfil',
estado='$estado',
bajada='$bajada',
id_mundo='$id_mundo',
id_comunidad='$id_comunidad',
gerencia='$gerencia',
subcategoria='$subcategoria',
imagen_slider='$slider',
slider_activo='$slider_activo',
principal='$principal',

nombre_video='$nombre_video',
id_galeria='$id_galeria',
id_biblioteca='$id_biblioteca',
doc1='$nombre_doc1',
descripcion_doc1='$descripcion_doc1',

doc2='$nombre_doc2',
descripcion_doc2='$descripcion_doc2',

doc3='$nombre_doc3',
descripcion_doc3='$descripcion_doc3',

doc4='$nombre_doc4',
descripcion_doc4='$descripcion_doc4',

doc5='$nombre_doc5',
descripcion_doc5='$descripcion_doc5'



WHERE id = '$id_noticia'";

//echo $sql;exit;

$database->setquery($sql);
$database->query();
}

function Total_Noticias_Principal($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select
tbl_noticias.*
from tbl_noticias


where principal>0 and tbl_noticias.id_empresa='$id_empresa'
and estado=1

order by orden is  null, orden asc, fecha_creacion desc";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function Total_Noticias_SinPrincipal($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select
tbl_noticias.*
from tbl_noticias


where tbl_noticias.id_empresa='$id_empresa'


and estado=1
order by orden is  null, orden asc, fecha_creacion desc";



$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TotalNoticiasSinPrincipal($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select
tbl_noticias.*
from tbl_noticias

left join tbl_noticias_principales
on tbl_noticias_principales.idnoticia=tbl_noticias.id

where tbl_noticias_principales.id is null and tbl_noticias.id_empresa='$id_empresa'

order by fecha_creacion desc";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TotalNoticiasSlider($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select
tbl_noticias.*
from tbl_noticias
where slider_activo>0  and id_empresa='$id_empresa'
and estado=1
order by slider_activo asc";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TotalNoticiasBorrador($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select
tbl_noticias.*
from tbl_noticias
where estado=4  and id_empresa='$id_empresa'

order by fecha_creacion desc";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TotalNoticias() {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_noticias order by id desc";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}
function SubcategoriasDadaCategoria($id_categoria) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_noticias_subcategorias where id_categoria='$id_categoria'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TodosCategorias() {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_noticias_categorias";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TodosEstados() {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_noticias_estados";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function UnaCategoria($id) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_noticias_categorias where id ='$id'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TodosLosUsuariosParaReporte($arreglo_post, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$filtro = "";
if ($arreglo_post["malla"] > 0) {
$filtro = " and rel_malla_programa.id_malla='" . $arreglo_post["malla"] . "' ";
}

if ($arreglo_post["curso"] > 0) {
$filtro .= " and tbl_lms_curso.id='" . $arreglo_post["curso"] . "' ";
}

if ($arreglo_post["gerencia"]) {
$filtro .= " and tbl_usuario.gerencia='" . $arreglo_post["gerencia"] . "' ";
}

if ($arreglo_post["un"]) {
$filtro .= " and tbl_usuario.unidad_negocio='" . $arreglo_post["un"] . "' ";
}

if ($arreglo_post["area"]) {
$filtro .= " and tbl_usuario.area='" . $arreglo_post["area"] . "' ";
}

if ($arreglo_post["comuna"]) {
$filtro .= " and tbl_usuario.comuna='" . $arreglo_post["comuna"] . "' ";
}

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sqlBK = "SELECT
tbl_usuario.rut,
tbl_usuario.rut_completo,
tbl_usuario.nombre_completo,
tbl_usuario.gerencia,
tbl_usuario.email,
tbl_usuario.telefono,
tbl_usuario.cargo as cargo,
tbl_usuario.id_cargo as id_cargo,
rel_malla.id_malla as id_malla,
tbl_programa.nombre as nombre_programa,
tbl_nivel.nombre as nombre_nivel,
tbl_lms_curso.nombre as nombre_curso,
tbl_lms_curso.id as id_curso
FROM
tbl_usuario
INNER JOIN rel_malla ON rel_malla.valor = tbl_usuario.id_cargo
INNER JOIN rel_malla_programa ON rel_malla_programa.id_malla = rel_malla.id_malla
INNER JOIN tbl_programa ON tbl_programa.id = rel_malla_programa.id_programa
INNER JOIN tbl_nivel ON tbl_nivel.id_programa = tbl_programa.id
INNER JOIN rel_nivel_curso ON rel_nivel_curso.id_nivel = tbl_nivel.id
INNER JOIN tbl_lms_curso ON tbl_lms_curso.id = rel_nivel_curso.id_curso
where tbl_usuario.id_empresa='$id_empresa' $filtro";

$sql = "SELECT
rut,
rut_completo,
tbl_usuario.nombre_completo,
email,
gerencia,
tbl_usuario.id_cargo,
telefono cargo,
tbl_empresa.nombre_empresa,
rel_malla.id_malla,
rel_malla_programa.id_programa,
tbl_programa.nombre AS nombre_programa,
tbl_lms_curso.nombre AS nombre_curso,
tbl_lms_curso.id AS id_curso,
tbl_nivel.nombre AS nombre_nivel
FROM
tbl_usuario
INNER JOIN rel_malla ON rel_malla.valor = tbl_usuario.id_cargo
AND tbl_usuario.id_empresa = rel_malla.id_empresa
INNER JOIN tbl_empresa ON tbl_empresa.id = tbl_usuario.id_empresa
INNER JOIN tbl_lms_malla ON tbl_lms_malla.id = rel_malla.id_malla
INNER JOIN rel_malla_programa ON rel_malla_programa.id_malla = rel_malla.id_malla
INNER JOIN tbl_programa ON tbl_programa.id = rel_malla_programa.id_programa
INNER JOIN tbl_nivel ON tbl_nivel.id_programa = tbl_programa.id
INNER JOIN rel_nivel_curso ON rel_nivel_curso.id_nivel = tbl_nivel.id
INNER JOIN tbl_lms_curso ON tbl_lms_curso.id = rel_nivel_curso.id_curso
WHERE
tbl_usuario.id_empresa = '$id_empresa' $filtro";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TodosLosUsuariosParaReporteDetallePorModulo($arreglo_post, $id_empresa, $rut, $id_curso) {
global $c_host, $c_user, $c_pass, $c_db;

$filtro = "";
if ($arreglo_post["malla"] > 0) {
$filtro = " and rel_malla_programa.id_malla='" . $arreglo_post["malla"] . "' ";
}

if ($arreglo_post["curso"] > 0) {
$filtro .= " and tbl_lms_curso.id='" . $arreglo_post["curso"] . "' ";
}

if ($arreglo_post["gerencia"]) {
$filtro .= " and tbl_usuario.gerencia='" . $arreglo_post["gerencia"] . "' ";
}

if ($arreglo_post["un"]) {
$filtro .= " and tbl_usuario.unidad_negocio='" . $arreglo_post["un"] . "' ";
}

if ($arreglo_post["area"]) {
$filtro .= " and tbl_usuario.area='" . $arreglo_post["area"] . "' ";
}

if ($arreglo_post["comuna"]) {
$filtro .= " and tbl_usuario.comuna='" . $arreglo_post["comuna"] . "' ";
}

if ($rut) {
$filtro .= " and tbl_usuario.rut='$rut'";
}

if ($id_curso) {
$filtro .= " and tbl_lms_curso.id='" . $id_curso . "' ";
}

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

SELECT
tbl_usuario.rut,
rut_completo,
tbl_usuario.nombre_completo,
email,
gerencia,
tbl_usuario.id_cargo,
telefono cargo,
tbl_empresa.nombre_empresa,
rel_malla.id_malla,
rel_malla_programa.id_programa,
tbl_programa.nombre AS nombre_programa,
tbl_objeto.titulo as nombre_modulo,
tbl_objeto.id as id_objeto,
tbl_lms_curso.nombre AS nombre_curso,
tbl_lms_curso.id AS id_curso,
tbl_nivel.nombre AS nombre_nivel,
tbl_objetos_finalizados.fecha as fecha_finalizado
FROM
tbl_usuario
INNER JOIN rel_malla ON rel_malla.valor = tbl_usuario.id_cargo
AND tbl_usuario.id_empresa = rel_malla.id_empresa
INNER JOIN tbl_empresa ON tbl_empresa.id = tbl_usuario.id_empresa
INNER JOIN tbl_lms_malla ON tbl_lms_malla.id = rel_malla.id_malla
INNER JOIN rel_malla_programa ON rel_malla_programa.id_malla = rel_malla.id_malla
INNER JOIN tbl_programa ON tbl_programa.id = rel_malla_programa.id_programa
INNER JOIN tbl_nivel ON tbl_nivel.id_programa = tbl_programa.id
INNER JOIN rel_nivel_curso ON rel_nivel_curso.id_nivel = tbl_nivel.id
INNER JOIN tbl_lms_curso ON tbl_lms_curso.id = rel_nivel_curso.id_curso
inner JOIN tbl_objeto on tbl_objeto.id_curso=tbl_lms_curso.id
left join tbl_objetos_finalizados on tbl_objetos_finalizados.id_objeto=tbl_objeto.id and tbl_objetos_finalizados.rut=tbl_usuario.rut



WHERE
tbl_usuario.id_empresa = '$id_empresa' $filtro

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function vecesenviado($rut, $proceso, $empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select COUNT(id) as cuenta  from tbl_correos_registros_envios where rut='$rut'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TotalUsuarios($arreglo_post, $id_empresa, $pagina, $usuarios_por_pagina) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if (!$pagina) {
$pagina = 0;
} else if ($pagina == 1) {
$pagina = 0;
} else {
$pagina = ($pagina - 1) * $usuarios_por_pagina;
}

$filtro = "";
if ($arreglo_post["gerencia"]) {
$filtro = " and tbl_usuario.gerencia='" . $arreglo_post["gerencia"] . "'";
}

if ($arreglo_post["un"]) {
$filtro .= " and tbl_usuario.unidad_negocio='" . $arreglo_post["un"] . "'";
}

if ($arreglo_post["area"]) {
$filtro .= " and tbl_usuario.area='" . $arreglo_post["area"] . "'";
}

if ($arreglo_post["filtro_empresa_holding"]) {
$filtro .= " and tbl_usuario.empresa_holding='" . $arreglo_post["filtro_empresa_holding"] . "'";
}

if ($arreglo_post["filtro_centrocosto"]) {
$filtro .= " and tbl_usuario.centro_costo='" . $arreglo_post["filtro_centrocosto"] . "'";
}

$sql = "
select tbl_usuario.*, tbl_empresa.nombre_empresa, tbl_empresa_holding.empresa as nombre_empresa_holding
from tbl_usuario
inner join tbl_empresa
on tbl_empresa.id=tbl_usuario.id_empresa
left join tbl_empresa_holding
on tbl_empresa_holding.rut=tbl_usuario.empresa_holding

where tbl_usuario.id_empresa='$id_empresa' $filtro order by apaterno asc limit $pagina, $usuarios_por_pagina
";

$sql = "
select tbl_usuario.*, tbl_empresa.nombre_empresa, tbl_empresa_holding.empresa as nombre_empresa_holding
from tbl_usuario
inner join tbl_empresa
on tbl_empresa.id=tbl_usuario.id_empresa
left join tbl_empresa_holding
on tbl_empresa_holding.rut=tbl_usuario.empresa_holding

where tbl_usuario.id_empresa='$id_empresa' $filtro order by tbl_usuario.nombre_completo ASC
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DatosTablaUsuarioTodosSK() {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_usuario where id_empresa='19' order by apaterno ";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DatosTablaUsuario($rut) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_usuario where rut='$rut'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DatosTablaUsuarioCompleto($Field, $Values, $cuenta_campos, $rut) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

for ($i = 1; $i <= $cuenta_campos; $i++) {
if ($Field[$i] != 'id_malla') {
$query .= " " . $Field[$i] . "='" . utf8_decode($Values[$i]) . "' ";
if ($i < $cuenta_campos) {
$query .= " and";
}
}
}

//busca RUT
$sql_rut = "select count(id) as cuenta from tbl_usuario where rut='$rut'";

$database->setquery($sql_rut);
$database->query();
$cod_rut = $database->listObjects();

//echo "<br>$rut, $sql_rut ESTA EN BASE ".$cod_rut[0]->cuenta;

$accion = "";
if ($cod_rut[0]->cuenta === '0') {$accion = "Insertar"; //echo " +INSERTAR";
}
if ($cod_rut[0]->cuenta > '0') {
$sql = "select count(id) as cuenta from tbl_usuario where $query";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

//echo "<br>$rut, $sql ".$cod[0]->cuenta;
if ($cod[0]->cuenta === '0') {$accion = "Actualizar";
echo "<br>$rut +ACTUALIZAR";

//print_r($Field);
//echo "<br> DatosTablaUsuarioCompleto";
//print_r($Values);
}
if ($cod[0]->cuenta > '0') {$accion = "Nada"; //echo " +NADA";
}
}

return $accion;
}

function UpdateUsuarioVigencia1($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE tbl_usuario SET vigencia= '1' WHERE id_empresa = '$id_empresa'";
$database->setquery($sql);
$database->query();
}

function DeleteUsuarioEmpresa($rut, $idEmpresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "DELETE FROM tbl_usuario WHERE rut='$rut' and id_empresa='$idEmpresa'";
//    $database->setquery($sql);
//    $database->query();
//
}

function InsertTblUsuarioEmpresa($valuesReal, $registrosReal, $idEmpresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "INSERT INTO tbl_usuario ($valuesReal,id_empresa) VALUES ($registrosReal,'$idEmpresa')";
//echo "<br>".$sql;
$database->setquery($sql);
$database->query();
}

function UpdateTblUsuarioEmpresa($rut, $idEmpresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

echo "<br>";
print_r($Field);
echo "<br> DatosTablaUsuarioCompleto";
print_r($Values);
echo "<br> DatosTablaUsuarioCompleto";

//$sql = "update tbl_usuario set vigencia=0 where rut='$rut' and id_empresa='$idEmpresa'";
//$database->setquery($sql);
//$database->query();
}

function UpdateTblUsuarioEmpresaMasivo($rut, $valuesReal, $registrosReal, $idEmpresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

//echo "<br>";
//print_r($valuesReal);
//echo "<br>";
//print_r($registrosReal);
//echo "<br>foreach";

$campos_array = explode(",", $valuesReal);
$valores_array = explode(",", $registrosReal);
$cuenta_array = count($campos_array) - 1;
$i = 0;

foreach ($campos_array as $campo_array) {
$set = " " . $campos_array[$i] . "=" . $valores_array[$i] . "";

if ($i < $cuenta_array) {$coma = ",";} else { $coma = "";}

//echo "<br> i $i, cuenta $cuenta_array, coma $coma";
$query .= $set . $coma;
$i++;
}

echo $query;

$sql = "update tbl_usuario set $query where rut='$rut' and id_empresa='$idEmpresa'";
//echo $sql;
//exit;

$database->setquery($sql);
$database->query();
}

function verifica_malla_lms($rut, $id_malla_value, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select count(id) as cuenta from rel_lms_malla_persona where rut='$rut'  and id_empresa='$id_empresa'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

$accion = "";
if ($cod[0]->cuenta == 0) {$accion = "Insertar";}
if ($cod[0]->cuenta == 1) {$accion = "Update";}

return $accion;
}

function InsertTblMallaPersona($rut, $id_malla_value, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "INSERT INTO rel_lms_malla_persona (rut, id_malla, id_empresa) VALUES ('$rut', '$id_malla_value', '$id_empresa')";
$database->setquery($sql);
$database->query();
}

function UpdateTblMallaPersona($rut, $id_malla_value, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "update rel_lms_malla_persona set id_malla='$id_malla_value' where rut='$rut' and id_empresa='$id_empresa'";
//echo $sql;
$database->setquery($sql);
$database->query();
}

function TodosPerfiles() {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select DISTINCT(cargo) from tbl_usuario";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ActualizaNoticiaSinImagen($id_noticia, $titulo, $contenido, $tag, $categoria, $perfil, $estado,
$bajada, $gerencia, $subcategoria, $autor, $id_mundo, $id_comunidad, $principal, $nombre_video, $id_galeria, $id_biblioteca, $nombre_doc1, $nombre_doc2, $nombre_doc3, $nombre_doc4, $nombre_doc5,
$descripcion_doc1, $descripcion_doc2, $descripcion_doc3, $descripcion_doc4, $descripcion_doc5) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE tbl_noticias SET
titulo= '$titulo',
contenido='$contenido',
tag='$tag',
categoria='$categoria',
perfil='$perfil',
estado='$estado',
bajada='$bajada',
id_mundo='$id_mundo',
id_comunidad='$id_comunidad',
gerencia='$gerencia',
subcategoria='$subcategoria',
principal=$principal,

nombre_video='$nombre_video',
id_galeria='$id_galeria',
id_biblioteca='$id_biblioteca',
doc1='$nombre_doc1',
descripcion_doc1='$descripcion_doc1',

doc2='$nombre_doc2',
descripcion_doc2='$descripcion_doc2',

doc3='$nombre_doc3',
descripcion_doc3='$descripcion_doc3',

doc4='$nombre_doc4',
descripcion_doc4='$descripcion_doc4',

doc5='$nombre_doc5',
descripcion_doc5='$descripcion_doc5'

WHERE id = '$id_noticia'";

$database->setquery($sql);
$database->query();
}

function ActualizaNoticiaConImagenBKBKBKBK($id_noticia, $titulo, $contenido, $tag, $categoria, $perfil, $estado, $portada,
$bajada, $gerencia, $subcategoria, $autor, $id_mundo, $id_comunidad, $thumb) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE tbl_noticias SET
titulo= '$titulo',
contenido='$contenido',
tag='$tag',
categoria='$categoria',
perfil='$perfil',
estado='$estado',
portada='$portada',
bajada='$bajada',
id_mundo='$id_mundo',
id_comunidad='$id_comunidad',
gerencia='$gerencia',
subcategoria='$subcategoria',
imagen_thumb='$thumb'

WHERE id = '$id_noticia'";
$database->setquery($sql);
$database->query();
}

function ActualizaNoticiaConImagenBK($id_noticia, $titulo, $contenido, $tag, $categoria, $perfil, $estado, $portada,
$bajada, $gerencia, $subcategoria, $autor, $id_mundo, $id_comunidad) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE tbl_noticias SET
titulo= '$titulo',
contenido='$contenido',
tag='$tag',
categoria='$categoria',
perfil='$perfil',
estado='$estado',
portada='$portada',
bajada='$bajada',
id_mundo='$id_mundo',
id_comunidad='$id_comunidad',
gerencia='$gerencia',
subcategoria='$subcategoria'



WHERE id = '$id_noticia'";
$database->setquery($sql);
$database->query();
}

function BorrarNoticia($id_noticia) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "DELETE FROM tbl_noticias WHERE id='$id_noticia'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

//FIN CHIS
////////////////////////
////////////////////////

/*
Creador: Daniel
Motivo: Insertar registro en tabla de objeto
Fecha: 21/01/2014
*/

function InsertaEmpresa($archivo, $nombre_empresa, $responsable_empresa, $email_empresa, $css_ruta, $css_nombre, $titulo_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO tbl_empresa(nombre_empresa, responsable, correo, archivo, css_ruta, css_nombre, titulo_pagina) " .
"VALUES ('$nombre_empresa', '$responsable_empresa', '$email_empresa', '$archivo', '$css_ruta', '$css_nombre', '$titulo_empresa');";

$database->setquery($sql);
$database->query();
}

function InsertoUsuariosPorProcesoCorreo($rut, $email, $id_empresa, $id_proceso) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO tbl_correos_usuarios_proceso(rut, email, estado, id_empresa, id_proceso) " .
"VALUES ('$rut', '$email', '0',  '$id_empresa', '$id_proceso');";
$database->setquery($sql);
$database->query();
}

function InsertaProcesoEnvio($nombre, $descripcion, $template, $id_empresa, $subject, $titulo1, $subtitulo1,
$texto1, $texto2, $texto3, $texto4, $texto_url, $url) {

// echo "$nombre, $descripcion, $template, $id_empresa,$subject,$titulo1,$subtitulo1,
//$texto1,$texto2,$texto3,$texto4,<br>texto url $texto_url, <br>url $url";
// $exit();

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO tbl_correos_proceso(nombre, descripcion, template, id_empresa,subject,titulo1,subtitulo1,
texto1,texto2,texto3,texto4, texto_url, url) " .
"VALUES ('$nombre', '$descripcion', '$template', '$id_empresa','$subject','$titulo1','$subtitulo1',
'$texto1','$texto2','$texto3','$texto4','$texto_url','$url');";

$database->setquery($sql);
$database->query();
}

/*
Creador: Daniel
Motivo: Insertar Relacion Nivel Curso
Fecha: 21/01/2014
*/

function InsertaRelacionMallaPrograma($id_malla, $id_programa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO rel_malla_programa(id_malla, id_programa) " .
"VALUES ('$id_malla', '$id_programa');";

$database->setquery($sql);
$database->query();
}

/*
Creador: Daniel
Motivo: TraerRelaciones Malla programa dado malla

*/
function RelMallaPrograma($id_malla) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select rel_malla_programa.*, tbl_programa.nombre as nombre_programa
from rel_malla_programa
inner join tbl_programa
on tbl_programa.id=rel_malla_programa.id_programa
where rel_malla_programa.id_malla='$id_malla'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

/*
Creador: Daniel
Motivo: Listado de preguntas dado id evaluacion

*/
function ListadoDePreguntasDadaEvaluacion($id_evaluacion) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select tbl_evaluaciones_preguntas.*, tbl_evaluaciones_tipo_preguntas.tipo as tipo_pregunta
from tbl_evaluaciones_preguntas
inner join tbl_evaluaciones_tipo_preguntas
on tbl_evaluaciones_tipo_preguntas.id=tbl_evaluaciones_preguntas.tipo
where evaluacion='$id_evaluacion'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

/*
Creador: Daniel
Motivo: Inserta Pregunta por Evaluacion

*/

function InsertaPreguntaPorEvaluacion($pregunta, $id_evaluacion, $tipo, $url_archivo, $url_carpeta) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO tbl_evaluaciones_preguntas(pregunta, evaluacion, tipo, url_archivo, url_carpeta) " .
"VALUES ('$pregunta', '$id_evaluacion', '$tipo', '$url_archivo', '$url_carpeta');";

$database->setquery($sql);
$database->query();
}

/*
Creador: Daniel
Motivo: Total Tipos de Preguntas

*/
function ListadoTiposPreguntas() {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_evaluaciones_tipo_preguntas";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

/*
Creador: Daniel
Motivo: Insertar registro evaluacion

*/

function InsertaEvaluacion($nombre_evaluacion, $descripcion) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO tbl_evaluaciones(nombre_evaluacion, descripcion) " .
"VALUES ('$nombre_evaluacion', '$descripcion');";

$database->setquery($sql);
$database->query();
}

/*
Creador: Daniel
Motivo: Listado de evaluaciones

*/
function TotalEvaluaciones() {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT
tbl_evaluaciones.*, (
SELECT
count(x.id) AS cnt
FROM
tbl_evaluaciones_preguntas x
WHERE
evaluacion = tbl_evaluaciones.id
) as total_preguntas
FROM
tbl_evaluaciones
order by tbl_evaluaciones.id desc
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

/*
Creador: Daniel
Motivo: Insertar Relacion Nivel Curso
Fecha: 21/01/2014
*/

function InsertaRelNivelCurso($id_nivel, $id_curso) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO rel_nivel_curso(id_nivel, id_curso) " .
"VALUES ('$id_nivel', '$id_curso');";

$database->setquery($sql);
$database->query();
}

/*
Creador: Daniel
Motivo: Total de Cursos

*/
function TotalCursos2() {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_lms_curso";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

/*
Creador: Daniel
Motivo: TraerRelaciones Nivel Curso dado Nivel

*/
function RelNivelCurso($id_nivel) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select rel_nivel_curso.*, tbl_lms_curso.nombre, tbl_modalidad_curso.modalidad as modalidad_curso
from rel_nivel_curso
inner join tbl_lms_curso
on tbl_lms_curso.id=rel_nivel_curso.id_curso
inner join tbl_modalidad_curso
on tbl_modalidad_curso.id=tbl_lms_curso.modalidad
where rel_nivel_curso.id_nivel='$id_nivel'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

/*
Creador: Daniel
Motivo: Actulizar Objeto
Fecha: 21/01/2014
*/

function ActualizaObjeto($id_objeto, $nombre_objeto, $tipo_objeto, $descripcion_objeto, $curso) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE tbl_objeto SET titulo= '$nombre_objeto', descripcion='$descripcion_objeto', tipo_objeto='$tipo_objeto', id_curso='$curso'  WHERE id = '$id_objeto'";
$database->setquery($sql);
$database->query();
}

/*
Creador: Daniel
Motivo: Insertar registro en tabla de objeto
Fecha: 21/01/2014
*/

function InsertaObjeto($nombre_objeto, $tipo_objeto, $descripcion_objeto, $curso, $direccion_archivo, $archivo, $extension_archivo, $ruta_sin_index, $id_evaluacion) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO tbl_objeto(tipo_objeto, titulo, descripcion, id_curso, archivo, url_objeto, extension_objeto, url, id_evaluacion) " .
"VALUES ('$tipo_objeto', '$nombre_objeto', '$descripcion_objeto', '$curso', '$archivo', '$direccion_archivo', '$extension_archivo', '$ruta_sin_index', '$id_evaluacion');";

$database->setquery($sql);
$database->query();
}

/*
Creador: Daniel
Motivo: Traer total de tipos de objetos
FEcha 21 01 2014
*/
function TotalTiposObjetos() {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_tipo_objeto";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

/*
Creador: Daniel
Motivo: ObtenerTotal de Objetos
FEcha 21 01 2014
*/
function TotalObjetos() {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT
tbl_objeto.*, tbl_lms_curso.nombre as nombre_curso, tbl_tipo_objeto.nombre as nombre_objeto
FROM
tbl_objeto
INNER JOIN tbl_lms_curso
ON tbl_lms_curso.id = tbl_objeto.id_curso
inner join tbl_tipo_objeto
on tbl_tipo_objeto.id=tbl_objeto.tipo_objeto
order by tbl_objeto.id desc
";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

/*
Creador: Daniel
Motivo: Actulizar Curso
Fecha: 21/01/2014
*/

function ActualizaCurso($id_curso, $nombre_curso, $descripcion_curso,
$modalidad, $tipo_curso, $prerequisito_curso,
$objetivo_curso, $sence, $numero_horas, $cantidad_maxima_participantes,
$rut_otec, $clasificacion_curso, $cbc, $valor_hora, $valor_hora_sence,
$contenidos_cursos, $nombre_curso_sence, $foco, $programa_bbdd, $codigo_sence,
$nombre_imagen, $nuevo_id_curso, $id_programa_global) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($nombre_imagen) {
$imagen = " imagen='$nombre_imagen', ";
}

$sql = "
UPDATE tbl_lms_curso SET
nombre= '$nombre_curso',
descripcion='$descripcion_curso',
modalidad='$modalidad',
tipo='$tipo_curso',
prerequisito='$prerequisito_curso',
objetivo_curso='$objetivo_curso',
sence='$sence',
codigosence='$codigo_sence',
cbc='$cbc',
numero_horas='$numero_horas',
cantidad_maxima_participantes='$cantidad_maxima_participantes',
valor_hora='$valor_hora',
rut_otec='$rut_otec',

$imagen

clasificacion='$clasificacion_curso',
valor_hora_sence='$valor_hora_sence',
contenidos_cursos='$contenidos_cursos',
nombre_curso_sence='$nombre_curso_sence',
id_empresa_programa='$programa_bbdd',
id_foco='$foco', id_programa_global='$id_programa_global'

WHERE id = '$id_curso'";
//echo $sql;exit();

$database->setquery($sql);
$database->query();




}



function InsertInscripcionCursoElearning($id_curso, $ejecutivo, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
if ($sence == "si" && $cbc == "si") {
$valor_hora_sence = $valor_hora_sence + (($valor_hora_sence * 20) / 100);
}
$sql = "INSERT INTO tbl_inscripcion_curso

(codigo_inscripcion,
id_curso,
ejecutivo,
id_empresa) " .
"VALUES (
'$id_curso',
'$id_curso',
'$ejecutivo',
'$id_empresa');";

$database->setquery($sql);
$database->query();
}

function InsertRelLmsMallaCursoElearning($id_curso, $id_programa, $id_foco, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "INSERT INTO rel_lms_malla_curso

(id_curso, id_empresa, orden_curso, id_programa, id_foco) " .
"VALUES (
'$id_curso', '$id_empresa', '1',    '$id_programa',    '$id_foco');";

$database->setquery($sql);
$database->query();
}

function UpdateInscripcionCursoElearning($id_curso, $ejecutivo, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "update tbl_inscripcion_curso set ejecutivo='$ejecutivo' where id_curso='$id_curso' and id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
//echo $sql; sleep(3);
}

function UpdateRelLmsMallaCursoElearning($id_curso, $id_programa, $id_foco, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "update rel_lms_malla_curso set id_programa='$id_programa', id_foco='$id_foco' where id_curso='$id_curso' and id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
//echo $sql; sleep(3);
}

function InsertaCurso($nombre_curso, $descripcion_curso, $modalidad, $tipo_curso, $prerequisito_curso,
$archivo, $objetivo_curso, $sence, $numero_horas, $cantidad_maxima_participantes, $rut_otec,
$clasificacion_curso, $cbc, $cod_identificador, $valor_hora, $valor_hora_sence, $codigo_curso,
$id_empresa, $contenidos_cursos, $nombre_curso_sence, $foco, $programa_bbdd, $codigo_sence, $programa_bbdd_global, $programa_bbdd_elearning) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
if ($sence == "si" && $cbc == "si") {
$valor_hora_sence = $valor_hora_sence + (($valor_hora_sence * 20) / 100);
}
$sql = "INSERT INTO tbl_lms_curso

(nombre,
descripcion,
modalidad,
tipo,
prerequisito,
imagen,
objetivo_curso,
sence,
numero_horas,
cantidad_maxima_participantes,
rut_otec,
clasificacion,
cbc,
numero_identificador,
valor_hora,
valor_hora_sence,
id,
id_empresa,
contenidos_cursos,
nombre_curso_sence,
id_foco,
id_empresa_programa,
id_programa_global,
codigosence) " .
"VALUES (
'$nombre_curso',
'$descripcion_curso',
'$modalidad',
'$tipo_curso',
'$prerequisito_curso',
'$archivo',
'$objetivo_curso',
'$sence',
'$numero_horas',
'$cantidad_maxima_participantes',
'$rut_otec',
'$clasificacion_curso',
'$cbc',
'$cod_identificador',
'$valor_hora',
'$valor_hora_sence',
'$codigo_curso',
'$id_empresa',
'$contenidos_cursos',
'$nombre_curso_sence',
'$foco',
'$programa_bbdd_elearning',
'$programa_bbdd_global',
'$codigo_sence');";
$database->setquery($sql);
$database->query();
}

/*
Creador: Daniel
Motivo: Traer total de las ,modalidades
FEcha 21 01 2014
*/
function TotalModalidad2() {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_modalidad_curso where descripcion is null";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TotalModalidad() {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_modalidad_curso";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ModalidadCurso($id_curso, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select modalidad from tbl_lms_curso where id='$id_curso' and id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod[0]->modalidad;
}

/*
Creador: Daniel
Motivo: Obtener curso dado id.
FEcha 21 01 2014
*/

function DatosCursoDadoId($id_curso, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_lms_curso where id='$id_curso' and id_empresa='$id_empresa'";
// echo "<br>DatosCursoDadoId ".$sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DatosCursoBKADMIN($id) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT
tbl_lms_curso.*, tbl_lms_clasificacion.clasificacion AS nombre_clasificacion, tbl_otec.nombre as nombre_otec, tbl_modalidad_curso.modalidad as nombre_modalidad, tbl_lms_curso_tipo.nombre as nombre_tipo
FROM
tbl_lms_curso
LEFT JOIN tbl_lms_clasificacion ON tbl_lms_clasificacion.id = rel_lms_malla_curso.id_clasificacion
LEFT JOIN tbl_otec on tbl_otec.rut=tbl_lms_curso.rut_otec
LEFT JOIN tbl_modalidad_curso on tbl_modalidad_curso.id=tbl_lms_curso.modalidad
LEFT JOIN tbl_lms_curso_tipo on tbl_lms_curso_tipo.id=tbl_lms_curso.tipo
where tbl_lms_curso.id = '$id'

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

/*
Creador: Daniel
Motivo: ObtenerTotal de Cursos
FEcha 21 01 2014
*/
function TotalCursos($arreglo_post) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$filtro = "";
if ($arreglo_post["filtro_clasificacion"] != 0) {
$filtro .= " and rel_lms_malla_curso.id_clasificacion='" . $arreglo_post["filtro_clasificacion"] . "'";
}

if ($arreglo_post["filtro_tipo_curso"] != 0) {
$filtro .= " and tbl_lms_curso.tipo='" . $arreglo_post["filtro_tipo_curso"] . "'";
}

if ($arreglo_post["filtro_sence"] != 0) {
$filtro .= " and tbl_lms_curso.sence='" . $arreglo_post["filtro_sence"] . "'";
}

if ($arreglo_post["filtro_modalidad"] != 0) {
$filtro .= " and tbl_lms_curso.modalidad='" . $arreglo_post["filtro_modalidad"] . "'";
}

if ($arreglo_post["filtro_otec"] != 0) {
$filtro .= " and tbl_lms_curso.rut_otec='" . $arreglo_post["filtro_otec"] . "'";
}

$sql = "SELECT
tbl_lms_curso.*, tbl_modalidad_curso.modalidad as nombre_modalidad, tbl_lms_clasificacion.clasificacion as nombre_clasificacion
FROM
tbl_lms_curso
INNER JOIN tbl_modalidad_curso ON tbl_lms_curso.modalidad = tbl_modalidad_curso.id
left join tbl_lms_clasificacion
on tbl_lms_clasificacion.id=rel_lms_malla_curso.id_clasificacion
where 1 $filtro and tbl_lms_curso.activo=0
order by tbl_lms_curso.id desc
";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

/*
Creador: Daniel
Motivo: Actulizar Nivel
Fecha: 21/01/2014
*/

function ActualizaNivel($id_nivel, $nombre_nivel, $descripcion_nivel, $programa, $tutor) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE tbl_nivel SET nombre= '$nombre_nivel', descripcion='$descripcion_nivel', tutor='$tutor', id_programa='$programa' WHERE id = '$id_nivel'";
$database->setquery($sql);
$database->query();
}

/*
Creador: Daniel
Motivo: Insertar registro en tabla de niveles
Fecha: 14/01/2014
*/

function InsertaNivel($nombre_nivel, $descripcion_nivel, $programa, $tutor) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO tbl_nivel(nombre, descripcion, tutor, id_programa) " .
"VALUES ('$nombre_nivel', '$descripcion_nivel', '$tutor', '$programa');";
$database->setquery($sql);
$database->query();
}

/*
Creador: Daniel
Motivo: Traer total de Tutores con sus nombres
FEcha 21 01 2014
*/
function TotalTutores() {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select tbl_usuario.nombre_completo, tbl_usuario.rut, tbl_perfil.id, tbl_perfil.rol
from tbl_usuario
inner join tbl_perfil
on tbl_usuario.id_perfil=tbl_perfil.id
where tbl_perfil.id='3'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

/*
Creador: Daniel
Motivo: Obtener nivel dado id.
FEcha 21 01 2014
*/
function DatosNivel($id) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_nivel where id='$id'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

/*
Creador: Daniel
Motivo: Obtener total de programas, con cruce malla, para obtener el nombre de la malla.
FEcha 21 01 2014
*/
function TotalNiveles() {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sqlBK = "

SELECT
tbl_nivel.*, tbl_programa.nombre AS nombre_programa,
tbl_lms_malla.id AS id_malla,
tbl_lms_malla.nombre AS nombre_malla,
tbl_usuario.nombre_completo
FROM
tbl_nivel
INNER JOIN tbl_programa ON tbl_nivel.id_programa = tbl_programa.id
INNER JOIN tbl_lms_malla ON tbl_lms_malla.id = tbl_programa.id_malla
INNER JOIN tbl_usuario ON tbl_usuario.rut = tbl_nivel.tutor";

$sql = "

SELECT
tbl_nivel.*, tbl_programa.nombre AS nombre_programa,
tbl_usuario.nombre_completo
FROM
tbl_nivel
INNER JOIN tbl_programa ON tbl_nivel.id_programa = tbl_programa.id
INNER JOIN tbl_usuario ON tbl_usuario.rut = tbl_nivel.tutor
order by tbl_nivel.id desc";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

/*
Creador: Daniel
Motivo: Actulizar ForDeb.
Fecha: 08/01/2014
*/

function ActualizaMalla($nombre_malla, $descripcion_malla, $tipo_malla, $certificable, $ponderacion, $tipo_fecha, $id_malla) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE tbl_lms_malla SET nombre= '$nombre_malla', descripcion='$descripcion_malla', tipo='$tipo_malla', certificable='$certificable', ponderacion='$ponderacion', tipo_fecha='$tipo_fecha'   WHERE id = '$id_malla'";
$database->setquery($sql);
$database->query();
}

/*
Creador: Daniel
Motivo: Actulizar ForDeb.
Fecha: 08/01/2014
*/

function ActualizaPrograma($id, $nombre, $descripcion, $id_malla) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE tbl_programa SET nombre= '$nombre', descripcion='$descripcion', id_malla='$id_malla' WHERE id = '$id'";
$database->setquery($sql);
$database->query();
}

/*
Creador: Daniel
Motivo: Insertar un programa|
Fecha: 14/01/2014
*/

function InsertaPrograma($nombre_programa, $descripcion_programa, $id_malla, $archivo) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO tbl_programa(nombre, descripcion, id_malla, archivo) " .
"VALUES ('$nombre_programa', '$descripcion_programa', '$id_malla', '$archivo');";

$database->setquery($sql);
$database->query();
}

/*
Creador: Daniel
Motivo: Obtener mallas

*/

function TodosLosPrograma() {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_programa";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

/*
Creador: Daniel
Motivo: Obtener total de programas, con cruce malla, para obtener el nombre de la malla.
FEcha 14 01 2014
*/
function TotalProgramas() {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sqlBK = "select tbl_programa.*, tbl_lms_malla.nombre as nombre_malla
from tbl_programa
inner join tbl_lms_malla
on tbl_lms_malla.id=tbl_programa.id_malla";

$sql = "select tbl_programa.*
from tbl_programa
";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

/*
Creador: Daniel
Motivo: Insertar una malla
Fecha: 13/01/2014
*/

function InsertaMalla($nombre_malla, $descripcion_malla, $tipo_malla, $certificable, $ponderacion, $tipo_fecha) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO tbl_lms_malla(nombre, descripcion, tipo, certificable, ponderacion, tipo_fecha) " .
"VALUES ('$nombre_malla', '$descripcion_malla', '$tipo_malla', '$certificable', '$ponderacion', '$tipo_fecha');";

$database->setquery($sql);
$database->query();
}

/*
Creador: Daniel
Motivo: Obtener malla dado id.
FEcha 13 01 2014
*/
function DatosMallaBORRADO_POR_DUPLICIDAD_AL_UNIFICAR_EL_FUNCTION($id) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_lms_malla where id='$id'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

/*
Creador: Daniel
Motivo: Obtener total de mallas.
FEcha 13 01 2014
*/
function TotalMallas() {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_lms_malla";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

/*
Creador: Daniel
Motivo: Obtener total de empresas.
FEcha 13 01 2014
*/
function TotalEmpresas() {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_empresa";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

/*
Creador: Daniel
Motivo: obtener info de Base de personas.
*/
function VerificoAccesoAdmin($user, $pass) {
global $c_host, $c_user, $c_pass, $c_db;
//echo  "$c_host, $c_user, $c_pass, $c_db;   ";
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

//$sql_acceso = "select tbl_admin.* from tbl_admin INNER JOIN tbl_empresa on tbl_empresa.id=tbl_admin.id_empresa where user='$user' and pass='$pass'";
$sql_acceso = "select tbl_admin.* from tbl_admin INNER JOIN tbl_empresa on tbl_empresa.id=tbl_admin.id_empresa where user='$user' and clave_encodeada='".Encodear3($pass)."'";
//echo "<br>sql_acceso $sql_acceso<br>";
$database->setquery($sql_acceso);
$database->query();
$cod = $database->listObjects();
//print_r($cod);exit();
return $cod;

}
function VerificoAccesoAdminGoogle($user) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select tbl_admin.*,tbl_empresa.prefijo from tbl_admin INNER JOIN tbl_empresa on tbl_empresa.id=tbl_admin.id_empresa where user='$user'";
//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TotalClasificacion($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_lms_clasificacion where id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DatosClasificacion2Datos($id) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_lms_clasificacion where id_clasificacion='$id'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DatosClasificacion($id) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_lms_clasificacion where id='$id'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function UltimaClasificacion($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select MAX(orden) as orden from tbl_lms_clasificacion where id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod[0]->orden;
}

function ActualizaClasificacion($id, $id_clasificacion, $clasificacion, $color, $imagen, $imagen_back, $empresa, $color2) {
global $c_host, $c_user, $c_pass, $c_db;
$fecha = date("Y-m-d");
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
if ($imagen != "") {
$imagen = ",imagen='$imagen'";
}
if ($imagen_back != "") {
$imagen_back = ",imagen_back='$imagen_back'";
}

$sql = "UPDATE tbl_lms_clasificacion SET id_clasificacion= '$id_clasificacion', clasificacion='$clasificacion', color='$color', color2='$color2', fecha_actualizacion='$fecha' $imagen_back $imagen WHERE id = '$id'";

$database->setquery($sql);
$database->query();
}

function InsertaClasificacion($id, $clasificacion, $color, $imagen, $imagen_back, $empresa, $color2) {
global $c_host, $c_user, $c_pass, $c_db;
$fecha = date("Y-m-d");
$database = new database($c_host, $c_user, $c_pass);
$orden = (UltimaClasificacion($empresa)) + 1;
$database->setDb($c_db);
$sql = "INSERT INTO tbl_lms_clasificacion(id_clasificacion, clasificacion, color, imagen, imagen_back, fecha, id_empresa, color2, orden) " .
"VALUES ('$id', '$clasificacion', '$color', '$imagen', '$imagen_back', '$fecha', '$empresa', '$color2','$orden');";

$database->setquery($sql);
$database->query();
}

function RelMallaCurso($id_malla) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select rel_lms_malla_curso.*, tbl_lms_curso.nombre as nombre_curso
from rel_lms_malla_curso
inner join tbl_lms_curso
on tbl_lms_curso.id=rel_lms_malla_curso.id_curso
where rel_lms_malla_curso.id_malla='$id_malla'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TotalCursosEmpresa($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_lms_curso where id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function InsertaRelacionMallaCurso($id_malla, $id_curso, $id_clasificacion, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$orden_clasificacion = TraeOrdenClasificacion($id_clasificacion);
if ($orden_clasificacion == "") {
$orden_clasificacion = (TraeUltimaOrdenClasificacion($id_malla, $id_empresa)) + 1;
}

$orden_curso = TraeOrdenClasificacionCurso($id_clasificacion);
if ($orden_curso == "") {
$orden_curso = 1;
} else {
$orden_curso = ($orden_curso) + 1;
}

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO rel_lms_malla_curso(id_malla, id_curso,id_clasificacion,id_empresa,orden_clasificacion,orden_curso) " .
"VALUES ('$id_malla', '$id_curso','$id_clasificacion', '$id_empresa', '$orden_clasificacion', '$orden_curso');";

$database->setquery($sql);
$database->query();
}

//Funciones JLo 18-02-2016

function Trae_Inscripciones_Curso($id_inscripcion) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT * FROM tbl_inscripcion_curso WHERE codigo_inscripcion='$id_inscripcion'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Total_Inscripciones($id_empresa, $id_inscripcion) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT
tbl_inscripcion_cierre.id,
sum(costototal) as costototal,
tbl_usuario.empresa_holding,
sum(tbl_inscripcion_cierre.costootec) as franquicia,
sum(tbl_inscripcion_cierre.costoempresa) as costo_empresa,
sum(tbl_inscripcion_cierre.viatico_utilizado) as viatico,
sum(tbl_inscripcion_cierre.movilizacion_utilizada) as movilizacion

FROM tbl_inscripcion_cierre
INNER JOIN tbl_usuario ON tbl_usuario.rut=tbl_inscripcion_cierre.rut
where tbl_inscripcion_cierre.id_inscripcion='$id_inscripcion' AND tbl_inscripcion_cierre.id_empresa='$id_empresa' GROUP BY  tbl_usuario.empresa_holding";

$sql = "SELECT
tbl_inscripcion_cierre.id,
sum(costototal) as costototal,
tbl_usuario.empresa as empresa_holding,

tbl_empresa_holding.empresa as nombre_empresa_holding,


sum(tbl_inscripcion_cierre.costootec) as franquicia,
sum(tbl_inscripcion_cierre.costoempresa) as costo_empresa,
sum(tbl_inscripcion_cierre.viatico_utilizado) as viatico,
sum(tbl_inscripcion_cierre.movilizacion_utilizada) as movilizacion

FROM tbl_inscripcion_cierre
INNER JOIN tbl_usuario ON tbl_usuario.rut=tbl_inscripcion_cierre.rut

left join tbl_empresa_holding
on tbl_empresa_holding.rut=tbl_usuario.empresa_holding


where tbl_inscripcion_cierre.id_inscripcion='$id_inscripcion' AND tbl_inscripcion_cierre.id_empresa='$id_empresa' GROUP BY  tbl_usuario.nombre_empresa_holding";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Total_Inscripciones_Estimado($id_empresa, $id_inscripcion) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT
sum(costototal) as costototal,
tbl_usuario.empresa_holding,
tbl_empresa_holding.empresa as nombre_empresa_holding,


sum(tbl_inscripcion_usuarios.costootec) as franquicia,
sum(tbl_inscripcion_usuarios.costoempresa) as costo_empresa,
sum(tbl_inscripcion_usuarios.viatico) as viatico,
sum(tbl_inscripcion_usuarios.movilizacion) as movilizacion

FROM tbl_inscripcion_usuarios
INNER JOIN tbl_usuario ON tbl_usuario.rut=tbl_inscripcion_usuarios.rut

left join tbl_empresa_holding
on tbl_empresa_holding.rut=tbl_usuario.empresa_holding


where tbl_inscripcion_usuarios.id_inscripcion='$id_inscripcion' AND tbl_inscripcion_usuarios.id_empresa='$id_empresa' GROUP BY  tbl_usuario.empresa_holding";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}
function Trae_Inscripciones_Cierre($id_inscripcion, $rut) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT
id,
costototal,
tbl_inscripcion_cierre.costootec as franquicia,
tbl_inscripcion_cierre.estado as estado,
tbl_inscripcion_cierre.costoempresa as costo_empresa,
tbl_inscripcion_cierre.viatico_utilizado as viatico,
tbl_inscripcion_cierre.movilizacion_utilizada as movilizacion
FROM tbl_inscripcion_cierre
where tbl_inscripcion_cierre.id_inscripcion='$id_inscripcion' AND tbl_inscripcion_cierre.rut='$rut'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function Trae_Inscripciones_Usuario($id_inscripcion, $rut) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT
id,
costototal,
tbl_inscripcion_usuarios.costootec as franquicia,
tbl_inscripcion_usuarios.costoempresa as costo_empresa,
tbl_inscripcion_usuarios.viatico as viatico,
tbl_inscripcion_usuarios.movilizacion as movilizacion
FROM tbl_inscripcion_usuarios
where tbl_inscripcion_usuarios.id_inscripcion='$id_inscripcion' AND tbl_inscripcion_usuarios.rut='$rut'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function TraeParticipantesInscripcion($id, $campo1, $campo2, $campo3) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT tbl_usuario.*,
tbl_usuario.$campo1 as campo1,
tbl_usuario.$campo2 as campo2,
tbl_usuario.$campo3 as campo3,
tbl_inscripcion_usuarios.id as id_inscripcion,
tbl_inscripcion_usuarios.viatico as viatico

FROM tbl_inscripcion_usuarios
INNER JOIN tbl_usuario ON tbl_usuario.rut=tbl_inscripcion_usuarios.rut
WHERE
tbl_inscripcion_usuarios.id_inscripcion='$id'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeIncripcionEmpresaID($id_empresa, $id) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT tbl_inscripcion_curso.id_curso,
tbl_inscripcion_curso.codigo_inscripcion,
tbl_inscripcion_curso.pago,
tbl_lms_curso.nombre,
tbl_lms_curso.id as id_curso,
tbl_lms_clasificacion.clasificacion ,
tbl_inscripcion_curso.fecha_inicio,
tbl_inscripcion_curso.fecha_termino
FROM tbl_inscripcion_curso
INNER JOIN tbl_lms_curso on tbl_lms_curso.id=tbl_inscripcion_curso.id_curso
INNER JOIN tbl_lms_clasificacion on tbl_lms_clasificacion.id_clasificacion=rel_lms_malla_curso.id_clasificacion
WHERE tbl_inscripcion_curso.id_empresa='$id_empresa' AND tbl_inscripcion_curso.codigo_inscripcion='$id'";

$sql = "SELECT
tbl_inscripcion_curso.id_curso,
tbl_inscripcion_curso.codigo_inscripcion,
tbl_inscripcion_curso.pago,
tbl_lms_curso.nombre,
tbl_lms_curso.id AS id_curso,
tbl_lms_clasificacion.clasificacion,
tbl_inscripcion_curso.fecha_inicio,
tbl_inscripcion_curso.fecha_termino
FROM
tbl_inscripcion_curso
INNER JOIN tbl_lms_curso ON tbl_lms_curso.id = tbl_inscripcion_curso.id_curso
INNER JOIN tbl_lms_clasificacion on tbl_lms_clasificacion.id_clasificacion = tbl_lms_curso.clasificacion
WHERE
tbl_inscripcion_curso.id_empresa = '$id_empresa'
AND tbl_inscripcion_curso.codigo_inscripcion = '$id'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeUsuarioCierre($codigo, $Campos1, $Campos2, $Campos3) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT
tbl_usuario.$Campos1 as campo1,
tbl_usuario.$Campos2 as campo2,
tbl_usuario.$Campos3 as campo3,
tbl_inscripcion_usuarios.*,
tbl_usuario.*
from tbl_inscripcion_usuarios INNER JOIN tbl_usuario ON tbl_usuario.rut=tbl_inscripcion_usuarios.rut  where id_inscripcion='$codigo'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeUsuarioRutCampos($rut, $id_empresa, $Campos1, $Campos2, $Campos3) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT *,
tbl_usuario.$Campos1 as campo1,
tbl_usuario.$Campos2 as campo2,
tbl_usuario.$Campos3 as campo3
FROM
tbl_usuario
WHERE
rut = '$rut'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function InsertaUsuarioInscripcionCierre($rut, $id_inscripcion, $asistencia,
$caso_especial, $nota, $estado, $viatico, $movilizacion,
$id_curso, $anulado, $costo_otec, $costo_empresa, $costoTotal,
$perdidafranquicia, $id_emprsa, $comentario) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "INSERT INTO tbl_inscripcion_cierre (rut,id_inscripcion,porcentaje_asistencia,caso_especial,
nota,estado,viatico_utilizado,movilizacion_utilizada,id_curso,anulado,costootec,costoempresa,
costototal,perdidafranquicia,id_empresa,comentario, fecha_termino)
VALUES ('$rut','$id_inscripcion','$asistencia',
'$caso_especial','$nota','$estado','$viatico','$movilizacion',
'$id_curso','$anulado','$costo_otec','$costo_empresa','$costoTotal',
'$perdidafranquicia','$id_emprsa','$comentario', '" . date("Y-m-d") . "');";
$database->setquery($sql);
if (!$database->query_error()) {
return $database->errores(mysql_error());
}
}

function UpdateUsuarioInscripcionCierre($rut, $id_inscripcion, $asistencia,
$caso_especial, $nota, $estado, $viatico, $movilizacion,
$id_curso, $anulado, $costo_otec, $costo_empresa, $costoTotal,
$perdidafranquicia, $id_emprsa, $comentario) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
UPDATE
tbl_inscripcion_cierre set
porcentaje_asistencia='$asistencia',

fecha_termino='" . date("Y-m-d") . "',

caso_especial='$caso_especial',
nota='$nota',
estado='$estado',
viatico_utilizado='$viatico',
movilizacion_utilizada='$movilizacion',
anulado='$anulado',
costootec='$costo_otec',
costoempresa='$costo_empresa',
costototal='$costoTotal',
perdidafranquicia='$perdidafranquicia',
comentario='$comentario'
where id_inscripcion='$id_inscripcion' and rut='$rut' ";
$database->setquery($sql);
if (!$database->query_error()) {
return $database->errores(mysql_error());
}
}

function UpdateUsuarioInscripcionCierre2($rut, $id_inscripcion, $asistencia,
$caso_especial, $nota, $estado, $viatico, $movilizacion,
$id_curso, $anulado, $costo_otec, $costo_empresa, $costoTotal,
$perdidafranquicia, $id_emprsa, $comentario, $fecha_inicio) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
UPDATE
tbl_inscripcion_cierre set
porcentaje_asistencia='$asistencia',

fecha_termino='" . date("Y-m-d") . "',
fecha_inicio='$fecha_inicio',

caso_especial='$caso_especial',
nota='$nota',
estado='$estado',
viatico_utilizado='$viatico',
movilizacion_utilizada='$movilizacion',
anulado='$anulado',
costootec='$costo_otec',
costoempresa='$costo_empresa',
costototal='$costoTotal',
perdidafranquicia='$perdidafranquicia',
comentario='$comentario'
where id_inscripcion='$id_inscripcion' and rut='$rut' ";
$database->setquery($sql);
if (!$database->query_error()) {
return $database->errores(mysql_error());
}
}

function inscripcion_compleja_curso_detalle($fecha_inicio, $fecha_termino, $dias,
$modalidad, $valor_curso, $valor_hora,
$direccion, $comuna, $region, $comentarios,
$lunes_d_am, $lunes_h_am, $lunes_d_pm, $lunes_h_pm,
$martes_d_am, $martes_h_am, $martes_d_pm, $martes_h_pm,
$miercoles_d_am, $miercoles_h_am, $miercoles_d_pm, $miercoles_h_pm,
$jueves_d_am, $jueves_h_am, $jueves_d_pm, $jueves_h_pm,
$viernes_d_am, $viernes_h_am, $viernes_d_pm, $viernes_h_pm, $id_empresa, $codigo) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$arreglo_fecha_inicio = explode("/", $fecha_inicio);
$fecha_inicio = $arreglo_fecha_inicio[2] . "-" . $arreglo_fecha_inicio[1] . "-" . $arreglo_fecha_inicio[0];
$arreglo_fecha_termino = explode("/", $fecha_termino);
$fecha_termino = $arreglo_fecha_termino[2] . "-" . $arreglo_fecha_termino[1] . "-" . $arreglo_fecha_termino[0];

$sql1 = "SELECT count(*) as inscripcion FROM tbl_inscripcion_curso where codigo_inscripcion='$codigo' and id_empresa='$id_empresa'";
$database->setquery($sql1);
$database->query();
$cod = $database->listObjects();

$sql_insscripcion = "SELECT *  FROM tbl_inscripcion_curso where codigo_inscripcion='$codigo' and id_empresa='$id_empresa'";
$database->setquery($sql_insscripcion);
$database->query();
$detalle_inscripcion = $database->listObjects();

$datos_curso = VerificoCursoPorEmpresa($detalle_inscripcion[0]->id_curso, $id_empresa);
$resp = "Recuerda que este curso tiene un total de <b>" . $datos_curso[0]->numero_horas . "</b> Horas";
$total_minutos = $total_minutos + calcular_tiempo_trasnc($lunes_d_am, $lunes_h_am);
$total_minutos = $total_minutos + calcular_tiempo_trasnc($lunes_d_pm, $lunes_h_pm);

$total_minutos = $total_minutos + calcular_tiempo_trasnc($martes_d_pm, $martes_h_pm);
$total_minutos = $total_minutos + calcular_tiempo_trasnc($martes_d_pm, $martes_h_pm);

$total_minutos = $total_minutos + calcular_tiempo_trasnc($miercoles_d_pm, $miercoles_h_pm);
$total_minutos = $total_minutos + calcular_tiempo_trasnc($miercoles_d_pm, $miercoles_h_pm);

$total_minutos = $total_minutos + calcular_tiempo_trasnc($jueves_d_pm, $jueves_h_pm);
$total_minutos = $total_minutos + calcular_tiempo_trasnc($jueves_d_pm, $jueves_h_pm);

$total_minutos = $total_minutos + calcular_tiempo_trasnc($viernes_d_pm, $viernes_h_pm);
$total_minutos = $total_minutos + calcular_tiempo_trasnc($viernes_d_pm, $viernes_h_pm);

$resp .= "<br>Para esta capacitacin, llevas un total de <b>" . number_format(($total_minutos / 60), 2, ",", ".") . " </b>horas";

if ($cod[0]->inscripcion >= 1) {
$sql = "UPDATE tbl_inscripcion_curso SET fecha_inicio='$fecha_inicio',fecha_termino='$fecha_termino',numero_dias='$dias',
abierto_cerrado='$modalidad',valor_curso='$valor_curso',valor_hora_curso='$valor_hora',
direccion='$direccion',comuna='$comuna',ciudad='$region',comentarios='$comentarios',

lunes_d_am='$lunes_d_am',
lunes_h_am='$lunes_h_am',
lunes_d_pm='$lunes_d_pm',
lunes_h_pm='$lunes_h_pm',
martes_d_am='$martes_d_am',
martes_h_am='$martes_h_am',
martes_d_pm='$martes_d_pm',
martes_h_pm='$martes_h_pm',
miercoles_d_am='$miercoles_d_am',
miercoles_h_am='$miercoles_h_am',
miercoles_d_pm='$miercoles_d_pm',
miercoles_h_pm='$miercoles_h_pm',
jueves_d_am='$jueves_d_am',
jueves_h_am='$jueves_h_am',
jueves_d_pm='$jueves_d_pm',
jueves_h_pm='$jueves_h_pm',
viernes_d_am='$viernes_d_am',
viernes_h_am='$viernes_h_am',
viernes_d_pm='$viernes_d_pm',
viernes_h_pm='$viernes_h_pm',

id_empresa='$id_empresa',codigo_inscripcion='$codigo'
WHERE codigo_inscripcion = '$codigo' AND id_empresa='$id_empresa'";

//$resp="Datos Guardados con exito";
} else {
$sql = "INSERT INTO tbl_inscripcion_curso(fecha_inicio,fecha_termino,numero_dias,
abierto_cerrado,valor_curso,valor_hora_curso,
direccion,comuna,ciudad,comentarios,
lunes_d_am,lunes_h_am,lunes_d_pm,lunes_h_pm,
martes_d_am,martes_h_am,martes_d_pm,martes_h_pm,
miercoles_d_am,miercoles_h_am,miercoles_d_pm,miercoles_h_pm,
jueves_d_am,jueves_h_am,jueves_d_pm,jueves_h_pm,
viernes_d_am,viernes_h_am,viernes_d_pm,viernes_h_pm,id_empresa,codigo_inscripcion)
VALUES ('$fecha_inicio','$fecha_termino','$dias',
'$modalidad','$valor_curso','$valor_hora',
'$direccion','$comuna','$region','$comentarios',
'$lunes_d_am','$lunes_h_am','$lunes_d_pm','$lunes_h_pm',
'$martes_d_am','$martes_h_am','$martes_d_pm','$martes_h_pm',
'$miercoles_d_am','$miercoles_h_am','$miercoles_d_pm','$miercoles_h_pm',
'$jueves_d_am','$jueves_h_am','$jueves_d_pm','$jueves_h_pm',
'$viernes_d_am','$viernes_h_am','$viernes_d_pm','$viernes_h_pm','$id_empresa','$codigo');";
//$resp="Datos Guardados con exito";
}

$database->setquery($sql);
$database->query();

echo $resp;
}

function inscripcion_compleja_curso_solo($codigo, $id_curso, $codigo_tabla_inscripcion, $id_malla, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql1 = "SELECT count(*) as inscripcion FROM tbl_inscripcion_curso where codigo_inscripcion='$codigo_tabla_inscripcion' and id_empresa='$id_empresa'";
$database->setquery($sql1);
$database->query();
$cod = $database->listObjects();
if ($cod[0]->inscripcion >= 1) {
$sql = "UPDATE tbl_inscripcion_curso SET codigo_inscripcion='$codigo',id_curso='$id_curso',id_malla='$id_malla'    WHERE codigo_inscripcion = '$codigo_tabla_inscripcion' AND id_empresa='$id_empresa'";
$resp = "Datos Modificados con exito";
} else {
$sql = "INSERT INTO tbl_inscripcion_curso(id_curso,id_malla,id_empresa,codigo_inscripcion)
VALUES ('$id_curso','$id_malla','$id_empresa','$codigo');";
$resp = "Datos Ingresados con exito";
}

$database->setquery($sql);
$database->query();

echo $resp;
}

function ActualizaInscripcionParticipante($id_inscripcion, $movilizacion, $viatico,
$id_curso, $costoTotal, $costoOtec, $costoEmpresa, $id) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE tbl_inscripcion_usuarios SET id_inscripcion='$id_inscripcion',movilizacion='$movilizacion'
,viatico='$viatico',id_curso='$id_curso',costootec='$costoOtec',costoempresa='$costoEmpresa'
,costototal='$costoTotal'
WHERE id = '$id'";

$database->setquery($sql);
$database->query();
}

function InsertaInscripcionParticipante($id_inscripcion, $rut, $movilizacion, $viatico,
$tramo_sence, $empresa, $gerencia, $centro_costo, $cargo, $rutempresaholding, $empresaholding,
$idcentrocosto, $id_curso, $id_empresa, $costoTotal, $costoOtec, $costoEmpresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "INSERT INTO tbl_inscripcion_usuarios(id_inscripcion,rut,movilizacion,viatico,
tramo_sence,empresa,gerencia,centro_costo,cargo,rutempresaholding,empresaholding,
idcentrocosto,id_curso,id_empresa,costootec,costoempresa,costototal)
VALUES ('$id_inscripcion','$rut','$movilizacion','$viatico',
'$tramo_sence','$empresa','$gerencia','$centro_costo','$cargo','$rutempresaholding','$empresaholding',
'$idcentrocosto','$id_curso','$id_empresa','$costoOtec','$costoEmpresa','$costoTotal');";

$database->setquery($sql);
$database->query();
return mysql_insert_id();
}

function inscripcion_compleja_curso($fecha_inicio, $fecha_termino, $dias,
$modalidad, $valor_curso, $valor_hora,
$direccion, $comuna, $region, $comentarios, $curso,
$lunes_d_am, $lunes_h_am, $lunes_d_pm, $lunes_h_pm,
$martes_d_am, $martes_h_am, $martes_d_pm, $martes_h_pm,
$miercoles_d_am, $miercoles_h_am, $miercoles_d_pm, $miercoles_h_pm,
$jueves_d_am, $jueves_h_am, $jueves_d_pm, $jueves_h_pm,
$viernes_d_am, $viernes_h_am, $viernes_d_pm, $viernes_h_pm,
$id_malla, $id_empresa, $codigo) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "INSERT INTO tbl_inscripcion_curso(fecha_inicio,fecha_termino,numero_dias,
abierto_cerrado,valor_curso,valor_hora_curso,
direccion,comuna,ciudad,comentarios,id_curso,
lunes_d_am,lunes_h_am,lunes_d_pm,lunes_h_pm,
martes_d_am,martes_h_am,martes_d_pm,martes_h_pm,
miercoles_d_am,miercoles_h_am,miercoles_d_pm,miercoles_h_pm,
jueves_d_am,jueves_h_am,jueves_d_pm,jueves_h_pm,
viernes_d_am,viernes_h_am,viernes_d_pm,viernes_h_pm,
id_malla,id_empresa,codigo_inscripcion)
VALUES ('$fecha_inicio','$fecha_termino','$dias',
'$modalidad','$valor_curso','$valor_hora',
'$direccion','$comuna','$region','$comentarios','$curso',
'$lunes_d_am','$lunes_h_am','$lunes_d_pm','$lunes_h_pm',
'$martes_d_am','$martes_h_am','$martes_d_pm','$martes_h_pm',
'$miercoles_d_am','$miercoles_h_am','$miercoles_d_pm','$miercoles_h_pm',
'$jueves_d_am','$jueves_h_am','$jueves_d_pm','$jueves_h_pm',
'$viernes_d_am','$viernes_h_am','$viernes_d_pm','$viernes_h_pm',
'$id_malla','$id_empresa','$codigo');";

$database->setquery($sql);
$database->query();
}

function TraeIncripcionEmpresaExcel($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT tbl_inscripcion_curso.id_curso,
tbl_inscripcion_curso.codigo_inscripcion,
tbl_lms_curso.nombre,
tbl_lms_curso.descripcion,
tbl_lms_curso.objetivo_curso,
tbl_lms_curso.modalidad,
tbl_lms_curso.tipo,
tbl_lms_curso.cbc,
tbl_lms_curso.sence,
tbl_lms_curso.cantidad_maxima_participantes,
tbl_lms_curso.valor_hora_sence,
tbl_lms_curso.numero_horas,
tbl_lms_curso.nombre_otec,
tbl_inscripcion_curso.abierto_cerrado,
tbl_inscripcion_curso.direccion,
tbl_inscripcion_curso.comuna,
tbl_inscripcion_curso.ciudad,
tbl_inscripcion_curso.comentarios,
tbl_lms_clasificacion.clasificacion ,
tbl_inscripcion_curso.fecha_inicio,
tbl_inscripcion_curso.fecha_termino
FROM tbl_inscripcion_curso
INNER JOIN tbl_lms_curso on tbl_lms_curso.id=tbl_inscripcion_curso.id_curso
INNER JOIN tbl_lms_clasificacion on tbl_lms_clasificacion.id_clasificacion=rel_lms_malla_curso.id_clasificacion
WHERE tbl_inscripcion_curso.id_empresa='$id_empresa'  ORDER BY tbl_inscripcion_curso.codigo_inscripcion";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeParticipanteBuscar($id_empresa, $campo1, $campo2, $campo3, $buscar) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT tbl_usuario.$campo1 as campo1,
tbl_usuario.$campo2 as campo2,
tbl_usuario.$campo3 as campo3,
tbl_usuario.nombre,
tbl_usuario.apaterno,
tbl_usuario.amaterno,
tbl_usuario.cargo,
tbl_usuario.rut,
tbl_usuario.email,
tbl_lms_malla.nombre as malla,
rel_lms_malla_persona.id_malla FROM `tbl_usuario`
LEFT JOIN rel_lms_malla_persona ON rel_lms_malla_persona.rut=tbl_usuario.rut
LEFT JOIN tbl_lms_malla ON tbl_lms_malla.id=rel_lms_malla_persona.id_malla
WHERE
tbl_usuario.rut LIKE '%$buscar%' OR
tbl_usuario.nombre_completo LIKE '%$buscar%' AND
tbl_usuario.vigencia='0' AND
tbl_usuario.id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function EliminaParticipanteUsuario($rut, $id_inscripcion) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "DELETE FROM tbl_inscripcion_usuarios WHERE rut='$rut' AND id_inscripcion='$id_inscripcion'";

$database->setquery($sql);
$database->query();
}

function TraeCursoID($id) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$filtro = "";

$sql = "SELECT
tbl_lms_curso.*, tbl_modalidad_curso.modalidad as nombre_modalidad,
tbl_lms_clasificacion.clasificacion as nombre_clasificacion,
tbl_otec.nombre as nombre_otec,
tbl_lms_curso_tipo.nombre as nombre_tipo_curso,tbl_lms_curso.rut_otec,tbl_lms_curso.numero_identificador
FROM
tbl_lms_curso
left join tbl_modalidad_curso ON tbl_lms_curso.modalidad = tbl_modalidad_curso.id
left join tbl_lms_clasificacion
on tbl_lms_clasificacion.id_clasificacion=rel_lms_malla_curso.id_clasificacion
left join tbl_otec
on tbl_otec.rut=tbl_lms_curso.rut_otec
left join tbl_lms_curso_tipo
on tbl_lms_curso_tipo.id=tbl_lms_curso.tipo
where tbl_lms_curso.activo=0 and tbl_lms_curso.id='$id'";

$sql = "SELECT
tbl_lms_curso.*, tbl_modalidad_curso.modalidad AS nombre_modalidad,
tbl_otec.nombre AS nombre_otec,
tbl_lms_curso_tipo.nombre AS nombre_tipo_curso,
tbl_lms_curso.rut_otec,
tbl_lms_clasificacion.clasificacion as nombre_clasificacion,

tbl_lms_curso.numero_identificador
FROM
tbl_lms_curso
LEFT JOIN tbl_modalidad_curso ON tbl_lms_curso.modalidad = tbl_modalidad_curso.id
LEFT JOIN tbl_otec ON tbl_otec.rut = tbl_lms_curso.rut_otec
LEFT JOIN tbl_lms_clasificacion ON tbl_lms_clasificacion.id_clasificacion= tbl_lms_curso.clasificacion
LEFT JOIN tbl_lms_curso_tipo ON tbl_lms_curso_tipo.id = tbl_lms_curso.tipo
WHERE
tbl_lms_curso.activo = 0
AND tbl_lms_curso.id = '$id'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function borrar_inscripcion_curso($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "DELETE FROM tbl_inscripcion_curso WHERE fecha_inicio is null AND valor_curso is null AND id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
//echo $sql;
}

function borrar_inscripcion_usuario($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "DELETE  from tbl_inscripcion_usuarios h

WHERE   NOT EXISTS
(
SELECT  codigo_inscripcion
FROM    tbl_inscripcion_curso r
WHERE   r.codigo_inscripcion = h.id_inscripcion
) and id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();

//  echo $sql;
}

function TraeMallasEmpresa($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT * FROM tbl_lms_malla WHERE id_empresa='$id_empresa' order by nombre asc";
//echo "<br><br>TraeMallasEmpresa<br>$sql <br>";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeMallasEmpresaSinEmpresa() {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT * FROM tbl_lms_malla  order by id";
//echo "<br><br>TraeMallasEmpresa<br>$sql <br>";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ObtenerEmpresaDadoRutSinEmpresa($rut) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT id_empresa FROM tbl_usuario where rut='$rut'";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ObtenerDatosRelMallaUsuarioDadoRutSinEmpresa($rut) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "

SELECT
rel_lms_malla_persona.*, tbl_lms_malla.template
FROM
rel_lms_malla_persona
left join tbl_lms_malla
on tbl_lms_malla.id=rel_lms_malla_persona.id_malla
WHERE
rel_lms_malla_persona.rut = '$rut'


";

//    echo $sql;
$database->setquery($sql);
$database->query();
$datos = $database->listObjects();
return $datos;
}

function TraeCursoCriterio2($id_empresa, $id_malla) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$filtro = "";

$sql = "select h.* from rel_lms_malla_curso h where h.id_empresa='$id_empresa' and (select modalidad from tbl_lms_curso where id=h.id_curso)<>'2' and id_malla='$id_malla'  order by id_curso";
//echo "<br><br>TraeCursoCriterio2<br>$sql<br> ";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeInscripcionCursoCriterio2($id_empresa, $id_malla, $id_curso) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$filtro = "";

$sql = "select h.* from tbl_inscripcion_curso h where h.id_empresa='$id_empresa' and  id_curso='$id_curso' and id_malla='$id_malla' ";
//echo "<br><br>TraeInscripcionCursoCriterio2<br>$sql <br>";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraePersonaActualizar($id_empresa, $id_malla) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$filtro = "";

$sql = "select h.* from rel_lms_malla_persona h where h.id_malla='$id_malla' and (select id_empresa from tbl_usuario where rut=h.rut)='$id_empresa' order by h.rut ";
//echo "<br><br>TraePersonaActualizar<br>$sql <br>";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function InsertaUsuario5($id_malla, $id_empresa, $id_inscripcion, $id_curso, $rut) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "INSERT INTO tbl_inscripcion_usuarios (id_inscripcion,empresa,id_empresa,id_curso,rut)
VALUES ('$id_inscripcion','$id_empresa','$id_empresa','$id_curso','$rut');";

//echo "<br><br>InsertaUsuario5<br>$sql <br>";
$database->setquery($sql);
if (!$database->query_error()) {
return $database->errores(mysql_error());
}
return $sql;
}

function InsertaCursos5($id_empresa, $id_curso, $id_malla) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$codigo = $id_empresa . "_" . $id_malla . "_" . $id_curso;
$sql = "INSERT INTO tbl_inscripcion_curso(codigo_inscripcion,id_empresa, id_curso, id_malla)
VALUES ('$codigo','$id_empresa','$id_curso','$id_malla');";

//echo "<br><br>InsertaCursos5<br>$sql ";
$database->setquery($sql);
if (!$database->query_error()) {
return $database->errores(mysql_error());
}
return $sql;
}

function CuentaRelaciones($id_empresa, $id_proceso) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT count(*) as total
FROM tbl_sgd_relaciones
WHERE id_empresa='$id_empresa' and id_proceso='$id_proceso'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod[0]->total;
}

function TraeRelacionesProcesos($id_empresa, $id_proceso) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT *
FROM tbl_sgd_relaciones
WHERE id_empresa='$id_empresa' and id_proceso='$id_proceso'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function CancelaProcesamientoPrevioRelaciones($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "DELETE FROM tbl_sgd_relaciones_temp WHERE id_empresa = '$id_empresa'";
$database->setquery($sql);
$database->query();
}

function InsertaRelacionMasivo($values, $registros) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "INSERT INTO tbl_sgd_relaciones ($values) VALUES ($registros);";
$database->setquery($sql);
if (!$database->query_error()) {
return $database->errores(mysql_error());
}
}

function TotalRelacionesTemp($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT * FROM tbl_sgd_relaciones_temp WHERE id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DatosTablaRelacion($rut) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select * from tbl_sgd_relaciones where evaluado='$rut'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function InsertaRelacionTemporal($values, $registros, $id_empresa, $id_proceso) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "INSERT INTO tbl_sgd_relaciones_temp ($values,id_empresa,id_proceso) VALUES ($registros,'$id_empresa','$id_proceso');";
$database->setquery($sql);

if (!$database->query_error()) {
return $database->errores(mysql_error());
}
}

function TraigoValoresDadoCampoPorEmpreas($campo, $id_empresa, $arreglo_post) {

global $c_host, $c_user, $c_pass, $c_db;

$campos_subida = REL_MALLA_CURSO_trarCamposSubidaParaReporte($id_empresa);
$total_campos = 0;
foreach ($campos_subida as $camp) {
//echo "<br>".$campo->campo;
if ($campo == $camp->campo) {
continue;
}

if (count($arreglo_post[$camp->campo]) > 0 && $arreglo_post[$camp->campo][0] != '0') {
$total_campos++;
if ($total_campos >= 2) {
$filtros_campos_dinamicos .= " and ";
}
//echo "<br>".$campo->campo;
$total = count($arreglo_post[$camp->campo]);
$filtros_campos_dinamicos .= " ( ";
for ($i = 1; $i <= $total; $i++) {
if ($i >= 2) {
$filtros_campos_dinamicos .= " or ";
}
$filtros_campos_dinamicos .= " tbl_usuario." . $camp->campo . "='" . $arreglo_post[$camp->campo][$i - 1] . "'";
}
$filtros_campos_dinamicos .= " ) ";
}
}
//print_r($campos_subida);
if ($filtros_campos_dinamicos) {
$filtros_campos_dinamicos = "and ($filtros_campos_dinamicos)";
}

$filtro_audiencias = FiltroPerfiladoAudiencias($_SESSION["admin_"], $id_empresa, $tipo);

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select distinct($campo) as valor
from tbl_usuario

where id_empresa='$id_empresa'
and $campo is not null
and $campo <>''
$filtro_audiencias
$filtros_campos_dinamicos order by $campo";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function UsuariosPorEmpresaCapacitacion($id_empresa, $arreglo_post, $nombre_campo, $valor_campo) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
if ($arreglo_post["malla"]) {
$inner_malla = " inner join rel_lms_malla_persona on rel_lms_malla_persona.rut=tbl_usuario.rut";
$where_inner_malla = " and rel_lms_malla_persona.id_malla='" . $arreglo_post["malla"] . "'";
}
$filtro_criterio = "";
if ($nombre_campo && $valor_campo) {
$filtro_criterio = " and $nombre_campo='$valor_campo'";
}
//, (select count(*) as total from tbl_log_sistema where ambiente='visitas' and tbl_log_sistema.rut=tbl_usuario.rut and tbl_log_sistema.id_empresa='$id_empresa' limit 1) as visita

$sql = "
SELECT
tbl_usuario.*

FROM
tbl_usuario
$inner_malla
where tbl_usuario.id_empresa='$id_empresa'
$where_inner_malla

$filtro_criterio



";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function UsuariosPorEmpresaCapacitacion_sin($id_empresa, $arreglo_post, $nombre_campo, $valor_campo) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
if ($arreglo_post["malla"]) {
$inner_malla = " inner join rel_lms_malla_persona on rel_lms_malla_persona.rut=tbl_usuario.rut";
$where_inner_malla = " and rel_lms_malla_persona.id_malla='" . $arreglo_post["malla"] . "'";
}
$filtro_criterio = "";
if ($nombre_campo && $valor_campo) {
$filtro_criterio = " and $nombre_campo='$valor_campo'";
}

$sql =
"

SELECT
tbl_usuario.*

FROM
tbl_usuario

$inner_malla

where tbl_usuario.id_empresa='$id_empresa'

$where_inner_malla
$filtro_criterio
and abs(tbl_usuario.rut)<>0

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function UsuariosPorEmpresaCapacitacion_sinSinEmpresa($arreglo_post, $nombre_campo, $valor_campo) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
if ($arreglo_post["malla"]) {
$inner_malla = " inner join rel_lms_malla_persona on rel_lms_malla_persona.rut=tbl_usuario.rut";
$where_inner_malla = " and rel_lms_malla_persona.id_malla='" . $arreglo_post["malla"] . "'";
}
$filtro_criterio = "";
if ($nombre_campo && $valor_campo) {
$filtro_criterio = " and $nombre_campo='$valor_campo'";
}

$sql =
"

SELECT
tbl_usuario.*

FROM
tbl_usuario

$inner_malla

where tbl_usuario.id=tbl_usuario.id

$where_inner_malla
$filtro_criterio

";

//    and tbl_usuario.rut='16939096'
//and tbl_usuario.rut='18228972'
//echo "<br>18754 $sql";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function GAMIFICACION_NotaPorSoloCursoUsuarioEmpresaSoloTrivia($rut, $id_curso, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "SELECT
avg(tbl_inscripcion_cierre.nota) as nota_por_curso
FROM
tbl_inscripcion_cierre
inner join tbl_lms_curso
on tbl_lms_curso.id=tbl_inscripcion_cierre.id_curso
WHERE
tbl_inscripcion_cierre.rut = '$rut' and tbl_inscripcion_cierre.id_empresa='$id_empresa' and tbl_inscripcion_cierre.id_curso='$id_curso'";

//echo "<br><br>sql $sql<br><br>";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function LMS_TieneTriviaCurso($id_curso, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "

select count(id) as cuenta  from tbl_objeto where id_curso='$id_curso' and id_empresa='$id_empresa' and id_evaluacion is not null

";

//echo "<br><br>sql $sql<br><br>";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod[0]->cuenta;
}

function Lms_Enc_satisf($arreglo_post, $id_empresa) {

$lms_malla = $arreglo_post[malla];
$lms_curso = $arreglo_post[curso];

$query_curso = "";
$query_malla = "";

if ($lms_curso != '') {
$query_curso = " and id_curso='$lms_curso' ";
}

if ($lms_malla != '') {
$query_malla = " and (select id_malla from rel_lms_malla_curso where id_curso='$lms_curso'  and id_malla='$lms_malla')='$lms_malla' ";
}

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.id_encuesta from tbl_objeto h where h.tipo_objeto='6' $query_curso $query_malla";
//echo $sql; exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function Lms_Busca_Objetos_Enc_sat($arreglo_post, $id_empresa) {

$lms_malla = $arreglo_post[malla];
$lms_curso = $arreglo_post[curso];

$query_curso = "";
$query_malla = "";

if ($lms_curso != '' and $lms_curso != '0') {
$query_curso = " and id_curso='$lms_curso' ";
}

if ($lms_malla != '' and $lms_malla != '0') {
$query_malla = " and (select id_malla from rel_lms_malla_curso where id_curso=h.id_curso  and id_malla='$lms_malla')='$lms_malla' ";
}

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.* from tbl_objeto h where h.tipo_objeto='6' $query_curso $query_malla";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function Lms_Busca_Objetos_Enc_Evidencias($arreglo_post, $id_empresa) {

$lms_malla = $arreglo_post[malla];
$lms_curso = $arreglo_post[curso];

$query_curso = "";
$query_malla = "";

if ($lms_curso != '' and $lms_curso != '0') {
$query_curso = " and id_curso='$lms_curso' ";
}

if ($lms_malla != '' and $lms_malla != '0') {
$query_malla = " and (select id_malla from rel_lms_malla_curso where id_curso=h.id_curso  and id_malla='$lms_malla')='$lms_malla' ";
}

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.* from tbl_objeto h where h.tipo_objeto='11' $query_curso $query_malla";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function Lms_Busca_Objetos_Enc_EvidenciasJefe($arreglo_post, $id_empresa) {

$lms_malla = $arreglo_post[malla];
$lms_curso = $arreglo_post[curso];

$query_curso = "";
$query_malla = "";

if ($lms_curso != '' and $lms_curso != '0') {
$query_curso = " and id_curso='$lms_curso' ";
}

if ($lms_malla != '' and $lms_malla != '0') {
$query_malla = " and (select id_malla from rel_lms_malla_curso where id_curso=h.id_curso  and id_malla='$lms_malla')='$lms_malla' and (select proveedor from tbl_lms_curso where id=h.id_curso)<>''     ";
}

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.* from tbl_objeto h where h.tipo_objeto='11' $query_curso $query_malla and (select proveedor from tbl_lms_curso where id=h.id_curso)<>''    ";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

//echo $sql;
return $cod;
}

function ENC_EVI_CuentaDeRespuestasPorPregunta_7opciones_CriterioJefe($id_empresa, $id_encuesta, $id_pregunta, $array_objetos, $criterio, $malla, $curso, $jefe) {

//print_r($array_objetos);
//echo "<br>$id_empresa, $id_encuesta, $id_pregunta, $array_objetos, $criterio,$malla, $curso, $jefe";

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$cuenta_arreglo = count($array_objetos);

if ($cuenta_arreglo == 1) {
$id_objeto = $array_objetos[0]->id;
$query_arreglo_objeto = " and id_objeto='$id_objeto' ";
}
if ($cuenta_arreglo > 1) {
$query_arreglo_objetoI = " and ( ";
foreach ($array_objetos as $array_objeto) {
$query_arreglo_objetoM .= " id_objeto='" . $array_objeto->id . "' OR ";
}

$query_arreglo_objetoF = " id<>id) ";
$query_arreglo_objeto = $query_arreglo_objetoI . $query_arreglo_objetoM . $query_arreglo_objetoF;
}

if ($jefe != '0') {
$query_arreglo_objetoJefe = " and jefe='$jefe' ";
$query_arreglo_objeto = $query_arreglo_objetoJefe;
}
//echo "jefe $jefe, query_arreglo_objeto $query_arreglo_objeto";
//echo "query_jefe $query_arreglo_objetoJefe";

//echo $query_arreglo_objeto;

$sql = "            select count(h.id) as cuenta,





(select count(id) from tbl_enc_evidencias_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and resp_diag='1') as cuentaD1,
(select count(id) from tbl_enc_evidencias_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and resp_diag='2') as cuentaD2,
(select count(id) from tbl_enc_evidencias_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and resp_diag='3') as cuentaD3,
(select count(id) from tbl_enc_evidencias_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and resp_diag='4') as cuentaD4,
(select count(id) from tbl_enc_evidencias_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and resp_diag='5') as cuentaD5,
(select count(id) from tbl_enc_evidencias_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and resp_diag='6') as cuentaD6,
(select count(id) from tbl_enc_evidencias_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and resp_diag='7') as cuentaD7,
(select count(id) from tbl_enc_evidencias_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and resp_diag<>'') as cuentaD,


(select count(id) from tbl_enc_evidencias_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and resp_experto='1') as cuentaE1,
(select count(id) from tbl_enc_evidencias_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and resp_experto='2') as cuentaE2,
(select count(id) from tbl_enc_evidencias_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and resp_experto='3') as cuentaE3,
(select count(id) from tbl_enc_evidencias_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and resp_experto='4') as cuentaE4,
(select count(id) from tbl_enc_evidencias_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and resp_experto='5') as cuentaE5,
(select count(id) from tbl_enc_evidencias_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and resp_experto='6') as cuentaE6,
(select count(id) from tbl_enc_evidencias_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and resp_experto='7') as cuentaE7,
(select count(id) from tbl_enc_evidencias_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and resp_experto<>'') as cuentaE,

(select count(id) from tbl_enc_evidencias_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and resp_comp='1') as cuentaC1,
(select count(id) from tbl_enc_evidencias_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and resp_comp='2') as cuentaC2,
(select count(id) from tbl_enc_evidencias_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and resp_comp='3') as cuentaC3,
(select count(id) from tbl_enc_evidencias_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and resp_comp='4') as cuentaC4,
(select count(id) from tbl_enc_evidencias_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and resp_comp='5') as cuentaC5,
(select count(id) from tbl_enc_evidencias_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and resp_comp='6') as cuentaC6,
(select count(id) from tbl_enc_evidencias_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and resp_comp='7') as cuentaC7,
(select count(id) from tbl_enc_evidencias_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and resp_comp<>'') as cuentaC,

(select count(id) from tbl_enc_evidencias_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and resp_jefe='1') as cuentaJ1,
(select count(id) from tbl_enc_evidencias_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and resp_jefe='2') as cuentaJ2,
(select count(id) from tbl_enc_evidencias_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and resp_jefe='3') as cuentaJ3,
(select count(id) from tbl_enc_evidencias_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and resp_jefe='4') as cuentaJ4,
(select count(id) from tbl_enc_evidencias_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and resp_jefe='5') as cuentaJ5,
(select count(id) from tbl_enc_evidencias_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and resp_jefe='6') as cuentaJ6,
(select count(id) from tbl_enc_evidencias_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and resp_jefe='7') as cuentaJ7,
(select count(id) from tbl_enc_evidencias_respuestas where id_empresa='$id_empresa' and id_encuesta='$id_encuesta'  $query_arreglo_objeto and id_pregunta='$id_pregunta' and resp_jefe<>'') as cuentaJ
from tbl_enc_evidencias_respuestas h

where h.id_empresa='$id_empresa'
and h.id_encuesta='$id_encuesta'
and h.id_objeto='$id_objeto'
and h.id_pregunta='$id_pregunta'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function Lms_busca_encuesta_dada_objeto($id_objeto, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select id_encuesta from tbl_objeto where tipo_objeto='6'  and id='$id_objeto'";
//echo $sql; exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function Lms_busca_encuesta_evidencia_dada_objeto($id_objeto, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select id_encuesta from tbl_objeto where tipo_objeto='11'  and id='$id_objeto'";
//echo $sql; exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function busca_enc_satis_template_admin($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select template_admin from  tbl_enc_satis_template where id_empresa='$id_empresa'";

//echo "<br> $sql";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeEjecutivosCursoEmpresa($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select ejecutivo as nombre from  tbl_inscripcion_curso where id_empresa='$id_empresa' group by ejecutivo";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function TraeJefeCursoEmpresa($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select jefe as nombre from  tbl_enc_evidencias_respuestas where id_empresa='$id_empresa' group by jefe";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lms_lista_curso_filtros($id_malla, $id_curso, $ejecutivo, $jefe, $fechaInicio, $fechaTermino, $id_empresa) {

//echo "$id_malla, $id_curso, $ejecutivo, $jefe, $fechaInicio, $fechaTermino, $id_empresa";
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($id_malla == '' or $id_malla == 0) {
if ($id_curso != '' and $id_curso != '0') {$querycursos = " And h.id='$id_curso' ";}
if ($fechaInicio != '') {$queryFechaInicio = " and DATE(h.fecha_inicio) BETWEEN '$fechaInicio' ";}
if ($fechaTermino != '') {$queryFechaTermino = " And '$fechaTermino' ";}
if ($ejecutivo != '' and $ejecutivo != '0') {$queryejecutivos = " And h.ejecutivocapacitacion='$ejecutivo' ";}
if ($jefe != '' and $jefe != '0') {$queryjefe = " And (select jefe from tbl_enc_evidencias_respuestas where id_curso=h.id and id_empresa='$id_empresa')='$jefe'";}
$sql = "select h.*,
(select count(id) from tbl_CI_participantes where id_curso=h.id and id_empresa='$id_empresa') as participantes,
(select count(id) from tbl_CI_participantes where id_curso=h.id and id_empresa='$id_empresa' AND relator='0') as participantes_participantes,
(select count(id) from tbl_CI_participantes where id_curso=h.id and id_empresa='$id_empresa' AND relator='1') as participantes_relator,
(select count(distinct(rut)) from tbl_enc_evidencias_respuestas where id_curso=h.id and id_empresa='$id_empresa' ) as participantesevidencias

from  tbl_lms_curso h

where

id_empresa='$id_empresa' $querycursos $queryFechaInicio $queryFechaTermino $queryejecutivos $queryjefe";
}

if ($id_malla != '' and $id_malla != 0) {
if ($id_curso != '' and $id_curso != '0') {$querycursos = "  And h.id_curso='$id_curso' ";}
if ($fechaInicio != '') {$queryFechaInicio = " and DATE(h.fecha_inicio) BETWEEN '$fechaInicio' ";}
if ($fechaTermino != '') {$queryFechaTermino = " And '$fechaTermino' ";}
if ($ejecutivo != '' and $ejecutivo != '0') {$queryejecutivos = " And h.ejecutivocapacitacion='$ejecutivo' ";}
if ($jefe != '' and $jefe != '0') {$queryjefe = " And h.jefe='$jefe' ";}
$sql = "select h.*,
(select fecha_inicio from tbl_lms_curso where id=h.id_curso) as fecha_inicio,
(select ejecutivocapacitacion from tbl_lms_curso where id=h.id_curso) as ejecutivocapacitacion,
(select nombre from tbl_lms_curso where id=h.id_curso) as nombre,
(select fecha_finalizacion from tbl_lms_curso where id=h.id_curso) as fecha_finalizacion,

(select count(id) from tbl_CI_participantes where id_curso=h.id and id_empresa='$id_empresa') as participantes,
(select count(id) from tbl_CI_participantes where id_curso=h.id and id_empresa='$id_empresa' AND relator='0') as participantes_participantes,
(select count(id) from tbl_CI_participantes where id_curso=h.id and id_empresa='$id_empresa' AND relator='1') as participantes_relator,
(select count(distinct(rut)) from tbl_enc_evidencias_respuestas where id_curso=h.id and id_empresa='$id_empresa' ) as participantesevidencias

from  rel_lms_malla_curso h
where id_empresa='$id_empresa' and id_malla='$id_malla' $querycursos";
}

//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}
function lms_lista_curso_filtros_evidencias($id_malla, $id_curso, $ejecutivo, $jefe, $fechaInicio, $fechaTermino, $id_empresa) {

//echo "$id_malla, $id_curso, $ejecutivo, $jefe, $fechaInicio, $fechaTermino, $id_empresa";
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($id_malla == '0' and $id_curso == '0' and $jefe != '0') {
if ($id_curso != '' and $id_curso != '0') {$querycursos = " And h.id='$id_curso' ";}
if ($fechaInicio != '') {$queryFechaInicio = " and DATE(h.fecha_inicio) BETWEEN '$fechaInicio' ";}
if ($fechaTermino != '') {$queryFechaTermino = " And '$fechaTermino' ";}
if ($jefe != '' and $jefe != '0') {$queryjefe = " where h.jefe='$jefe'";}
$sql = "select h.*,

(select id_curso from tbl_objeto where  id=h.id_objeto limit 1) as id_curso,
(select nombre from tbl_lms_curso where  id=(select id_curso from tbl_objeto where  id=h.id_objeto limit 1) limit 1) as nombre_curso,
(select acercade from tbl_lms_curso where  id=(select id_curso from tbl_objeto where  id=h.id_objeto limit 1) limit 1) as fecha,
(select count(distinct(rut))  from tbl_enc_evidencias_respuestas where id_objeto=h.id_objeto ) as participantes
from tbl_enc_evidencias_respuestas h $queryjefe

group by h.id_objeto";
}

if ($id_malla != '0' and $id_curso != '0' and $jefe == '0') {
if ($id_curso != '' and $id_curso != '0') {$querycursos = "  And h.id_curso='$id_curso' ";}
if ($fechaInicio != '') {$queryFechaInicio = " and DATE(h.fecha_inicio) BETWEEN '$fechaInicio' ";}
if ($fechaTermino != '') {$queryFechaTermino = " And '$fechaTermino' ";}
if ($ejecutivo != '' and $ejecutivo != '0') {$queryejecutivos = " And h.ejecutivocapacitacion='$ejecutivo' ";}
if ($jefe != '' and $jefe != '0') {$queryjefe = " And h.jefe='$jefe' ";}
$sql = "select h.*,
(select fecha_inicio from tbl_lms_curso where id=h.id_curso) as fecha_inicio,
(select ejecutivocapacitacion from tbl_lms_curso where id=h.id_curso) as ejecutivocapacitacion,
(select id from tbl_lms_curso where id=h.id_curso) as id,

(select nombre from tbl_lms_curso where id=h.id_curso) as nombre_curso,
(select fecha_finalizacion from tbl_lms_curso where id=h.id_curso) as fecha_finalizacion,

(select count(id) from tbl_CI_participantes where id_curso=h.id and id_empresa='$id_empresa') as participantesCH,
(select count(id) from tbl_CI_participantes where id_curso=h.id and id_empresa='$id_empresa' AND relator='0') as participantes_participantes,
(select count(id) from tbl_CI_participantes where id_curso=h.id and id_empresa='$id_empresa' AND relator='1') as participantes_relator,
(select count(distinct(rut)) from tbl_enc_evidencias_respuestas where id_curso=h.id_curso and id_empresa='$id_empresa' ) as participantes

from  rel_lms_malla_curso h
where id_empresa='$id_empresa' and id_malla='$id_malla' $querycursos";
}

if ($id_malla != '0' and $id_curso == '0' and $jefe != '0') {
if ($id_curso != '' and $id_curso != '0') {$querycursos = " And h.id='$id_curso' ";}
if ($fechaInicio != '') {$queryFechaInicio = " and DATE(h.fecha_inicio) BETWEEN '$fechaInicio' ";}
if ($fechaTermino != '') {$queryFechaTermino = " And '$fechaTermino' ";}
if ($jefe != '' and $jefe != '0') {$queryjefe = " where h.jefe='$jefe'";}
$sql = "select h.*,

(select id_curso from tbl_objeto where  id=h.id_objeto limit 1) as id_curso,
(select nombre from tbl_lms_curso where  id=(select id_curso from tbl_objeto where  id=h.id_objeto limit 1) limit 1) as nombre_curso,
(select acercade from tbl_lms_curso where  id=(select id_curso from tbl_objeto where  id=h.id_objeto limit 1) limit 1) as fecha,
(select count(distinct(rut))  from tbl_enc_evidencias_respuestas where id_objeto=h.id_objeto ) as participantes
from tbl_enc_evidencias_respuestas h $queryjefe

group by h.id_objeto";
}

//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lms_lista_curso_filtrosJefe($id_malla, $id_curso, $ejecutivo, $fechaInicio, $fechaTermino, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($id_malla == '') {
if ($id_curso != '' and $id_curso != '0') {$querycursos = " And h.id='$id_curso' ";}
if ($fechaInicio != '') {$queryFechaInicio = " and DATE(h.fecha_inicio) BETWEEN '$fechaInicio' ";}
if ($fechaTermino != '') {$queryFechaTermino = " And '$fechaTermino' ";}
if ($ejecutivo != '' and $ejecutivo != '0') {$queryejecutivos = " And h.ejecutivocapacitacion='$ejecutivo' ";}
$sql = "select h.*,
(select count(distinct(rut)) from tbl_enc_evidencias_respuestas where id_curso=h.id and id_empresa='$id_empresa' ) as participantes

from  tbl_lms_curso h

where

id_empresa='$id_empresa' $querycursos $queryFechaInicio $queryFechaTermino $queryejecutivos  and proveedor is not null";
}

if ($id_malla != '') {
if ($id_curso != '' and $id_curso != '0') {$querycursos = "  And h.id_curso='$id_curso' ";}
if ($fechaInicio != '') {$queryFechaInicio = " and DATE(h.fecha_inicio) BETWEEN '$fechaInicio' ";}
if ($fechaTermino != '') {$queryFechaTermino = " And '$fechaTermino' ";}
if ($ejecutivo != '' and $ejecutivo != '0') {$queryejecutivos = " And h.ejecutivocapacitacion='$ejecutivo' ";}

$sql = "select h.*,
(select fecha_inicio from tbl_lms_curso where id=h.id_curso) as fecha_inicio,
(select ejecutivocapacitacion from tbl_lms_curso where id=h.id_curso) as ejecutivocapacitacion,
(select nombre from tbl_lms_curso where id=h.id_curso) as nombre,
(select fecha_finalizacion from tbl_lms_curso where id=h.id_curso) as fecha_finalizacion,


(select count(distinct(rut)) from tbl_enc_evidencias_respuestas where id_curso=h.id and id_empresa='$id_empresa' ) as participantes


from  rel_lms_malla_curso h
where id_empresa='$id_empresa' and id_malla='$id_malla' $querycursos  and proveedor is not null";
}

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function lms_lista_curso_filtros_inscripcion($id_malla, $id_curso, $ejecutivo, $fechaInicio, $fechaTermino, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($id_malla == '') {
if ($id_curso != '' and $id_curso != '0') {$querycursos = " And h.id_curso='$id_curso' ";}
if ($fechaInicio != '') {$queryFechaInicio = " and DATE(h.fecha_inicio) BETWEEN '$fechaInicio' ";}
if ($fechaTermino != '') {$queryFechaTermino = " And '$fechaTermino' ";}
if ($ejecutivo != '' and $ejecutivo != '0') {$queryejecutivos = " And h.ejecutivocapacitacion='$ejecutivo' ";}
$sql = "

select h.*, (select nombre from tbl_lms_curso where id=h.id_curso) as nombrecurso,
(select count(id) from tbl_inscripcion_usuarios where id_inscripcion=h.codigo_inscripcion and (estadoinscripcion='INSCRITO' or estadoinscripcion='PREINSCRITO' )) as inscritos,
(select count(id) from tbl_inscripcion_usuarios where id_inscripcion=h.codigo_inscripcion and (estadoinscripcion='LISTAESPERA')) as listaespera


from tbl_inscripcion_curso h
where id_empresa='$id_empresa' $querycursos




";
}

if ($id_malla != '') {
if ($id_curso != '' and $id_curso != '0') {$querycursos = "  And h.id_curso='$id_curso' ";}
if ($fechaInicio != '') {$queryFechaInicio = " and DATE(h.fecha_inicio) BETWEEN '$fechaInicio' ";}
if ($fechaTermino != '') {$queryFechaTermino = " And '$fechaTermino' ";}
if ($ejecutivo != '' and $ejecutivo != '0') {$queryejecutivos = " And h.ejecutivocapacitacion='$ejecutivo' ";}
}

//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function nombreEvaL($idEval) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select nombre_evaluacion  from  tbl_evaluaciones where id='$idEval'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}
function nombreEncuestaLB($idEval) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select nombre  from  tbl_enc_elearning where id='$idEval'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod[0]->nombre;
}
function LmsReseteoEvaluacion($id_objeto, $rut) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select *  from  tbl_objeto where id='$id_objeto'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
$id_evaluacion = $cod[0]->id_evaluacion;

$sql = "delete FROM tbl_evaluaciones_sesion WHERE rut= '$rut' AND id_objeto = '$id_objeto'";
$database->setquery($sql);
$database->query();

$sql = "delete FROM tbl_evaluaciones_respuestas WHERE rut = '$rut' AND id_objeto = '$id_objeto'";
$database->setquery($sql);
$database->query();

$sql = "delete FROM tbl_objetos_finalizados WHERE rut = '$rut' AND id_objeto = '$id_objeto'";
$database->setquery($sql);
$database->query();

$sql = "delete FROM tbl_evaluaciones_asociacion_preguntas_usuario WHERE rut = '$rut' AND id_objeto = '$id_objeto'";
$database->setquery($sql);
$database->query();

return $cod;
}

function LMS_DesactivaActivaCurso_relMalla($id_curso, $id_clasificacion, $id_malla, $id_empresa, $inactivo) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "UPDATE rel_lms_malla_curso  SET inactivo= '$inactivo' where id_malla='$id_malla' and id_clasificacion='$id_clasificacion' and id_curso='$id_curso' and id_empresa='$id_empresa'";
//echo $sql; exit();
$database->setquery($sql);
$database->query();
}

function VisitasPorFecha($id_empresa, $tipo_est) {
//    echo "$id_empresa, $tipo_est";

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($tipo_est == "") {
$sql = "SELECT
count(*)AS totalinteracciones,
(select count(distinct(rut)) as total_usuarios from tbl_log_sistema as a where a.fecha=tbl_log_sistema.fecha and a.id_empresa='$id_empresa' ) as totalusuarios,
fecha
FROM
tbl_log_sistema where id_empresa='$id_empresa'

and
tbl_log_sistema.fecha>='2017-01-01'

GROUP BY
tbl_log_sistema.fecha    ";
}

if ($tipo_est == "fullpaginas") {
$sql = "SELECT h.*, count(id) as totalusuarios FROM tbl_log_sistema h where h.fecha>='2017-01-01' group by h.fecha";
}

if ($tipo_est == "fullvisitas") {
$sql = "SELECT h.*, count(id) as totalusuarios FROM tbl_log_sistema h where h.fecha>='2017-01-01' and h.ambiente='home_bci_capacitacion' group by h.fecha";
}

if ($tipo_est == "fullbloque") {
$sql = "select  hour(hora) as fecha, count(*) as totalusuarios from tbl_log_sistema group by hour(hora);";
}

//echo $sql;
$database->setquery($sql);
$database->query();
$datos = $database->listObjects();
return $datos;
}

function VisitaUsuariosUnicos($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT * FROM `tbl_log_sistema` WHERE `id_empresa` = '$id_empresa' group by rut";

$database->setquery($sql);
$database->query();
$datos = $database->listObjects();
return $datos;
}

function LmsBuscaFechaReporte($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select fecha from tbl_lms_reportes where id_empresa='$id_empresa' order by fecha Desc limit 1";

//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//print_r($cod);
return $cod[0]->fecha;
}
function GAMIFICACION_NotaPorSoloCursoPuntosUsuarioEmpresa($rut, $id_curso, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "SELECT
sum(tbl_gamificado_puntos.puntos) as puntos
FROM
`tbl_gamificado_puntos`

WHERE
tbl_gamificado_puntos.rut = '$rut' and tbl_gamificado_puntos.id_empresa='$id_empresa' and tbl_gamificado_puntos.id_curso='$id_curso'";

//    echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function inserta_lms_malla_o_cierre($rut, $id_malla, $id_curso, $id_empresa) {
//    echo "<br>inserta_lms_malla_o_cierre $rut, $id_malla, $id_curso, $id_empresa";

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT
h.*
FROM
rel_lms_malla_persona h
WHERE
h.id_malla = '$id_malla'
AND h.id_empresa = '$id_empresa'
AND (
SELECT
id_curso
FROM
rel_lms_malla_curso
WHERE
id_curso = '$id_curso'
AND id_malla = h.id_malla
AND id_empresa = h.id_empresa
) = '$id_curso'";

//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//print_r($cod);
$inserta = 0;
if ($cod[0]->id > 0) {
$inserta = 1;
}
return $inserta;
}

function inserta_lms_malla_o_cierre_sinempresa($rut, $id_malla, $id_curso, $id_empresa) {
//    echo "<br>inserta_lms_malla_o_cierre $rut, $id_malla, $id_curso, $id_empresa";

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT
h.*
FROM
rel_lms_malla_persona h
WHERE
h.id_malla = '$id_malla'
AND h.id_empresa = '$id_empresa'
AND (
SELECT
id_curso
FROM
rel_lms_malla_curso
WHERE
id_curso = '$id_curso'
AND id_malla = h.id_malla
AND id_empresa = h.id_empresa
) = '$id_curso'";

//echo "<br>$sql";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//print_r($cod);
$inserta = 0;
if ($cod[0]->id > 0) {
$inserta = 1;
}
return $inserta;
}

function lms_cuenta_cursos($id_malla, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "SELECT
count(id) as cuenta
FROM
rel_lms_malla_curso h
WHERE
h.id_malla = '$id_malla'
AND h.id_empresa = '$id_empresa'
";

//    echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod[0]->cuenta;
}

function sgd_buscar_proceso($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select id_proceso from tbl_sgd_proceso_evaluacion where id_empresa='$id_empresa'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod[0]->id_proceso;
}

function sgd_relaciones_proceso($id_empresa, $arreglo_post) {global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "

select h.*,
(select rut_completo from tbl_usuario where rut=h.evaluado) as RutEvaluado,
(select nombre_completo from tbl_usuario where rut=h.evaluado) as Evaluado,
(select rut_completo from tbl_usuario where rut=h.evaluador) as RutEvaluador,
(select nombre_completo from tbl_usuario where rut=h.evaluador) as Evaluador,
(select gerencia from tbl_usuario where rut=h.evaluado) as gerencia_evaluado,
(select local from tbl_usuario where rut=h.evaluado) as local_evaluado,
(select zonal from tbl_usuario where rut=h.evaluado) as zonal_evaluado,
(select gerente_rf from tbl_usuario where rut=h.evaluado) as gerente_rf_evaluado,
(select perfil from tbl_sgd_subperfiles where id=h.subperfil) as Tipo,
(select id from tbl_sgd_finalizados_evaluado_evaluador where id_proceso='$arreglo_post' and evaluado=h.evaluado and evaluador=h.evaluador) as EstadoCuenta

from tbl_sgd_relaciones h where h.id_proceso='$arreglo_post'

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function listarObjetosBiblioteca() {
global $c_host, $c_user, $c_pass, $c_db;

//echo "data";

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from biblioteca_objetos order by fecha_modificacion desc";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function Audiencia_Save_NuevaAudiencia($nombre_audiencia,$descripcion_audiencia, 
$id_empresa, $sqlquery, $excluir, $incluir, $campos_filtros, $id_audiencia) {

global $c_host, $c_user, $c_pass, $c_db;
$rut=$_SESSION["user_"];
$fecha = date("Y-m-d");	

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$campos_filtros_enc=Encodear3($campos_filtros);

$nombre_audiencia=utf8_decode($nombre_audiencia);
$descripcion_audiencia=utf8_decode($descripcion_audiencia);

$sql="select id from tbl_audiencia order by id DESC limit 1";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
$id_next=$cod[0]->id+1;

if($id_audiencia>0){
$sql = "
update tbl_audiencia 

set nombre='$nombre_audiencia', descripcion='$descripcion_audiencia',
sqlquery='$sqlquery',excluir='$excluir',incluir='$incluir',fecha='$fecha',campos_filtros='$campos_filtros',
campos_filtros_enc='$campos_filtros_enc', editor='$rut', fecha_edicion='$fecha'

where id='$id_audiencia'

";		

TruncateRutIdAudiencia($id_audiencia);
Audiencia_Sql($sqlquery, $id_audiencia, $id_empresa);			
//exit();

} else {




$sql = "
insert into tbl_audiencia 

(id, nombre,descripcion,id_empresa,sqlquery,excluir,incluir,fecha,campos_filtros,campos_filtros_enc, autor, fecha_creacion) 

values('$id_next', '$nombre_audiencia','$descripcion_audiencia','$id_empresa','$sqlquery','$excluir','$incluir','$fecha','$campos_filtros','$campos_filtros_enc','$rut', '$fecha')
";
// AHORA NO GRABA AL MOMENTO; SINO QUE ESPERA CRON 
//TruncateRutIdAudiencia($id_next);
//Audiencia_Sql($sqlquery, $id_next,$excluir,$incluir, $id_empresa);	
//exit();		
}



$database->setquery($sql);
$database->query();
}

function insertarObjetoBiblioteca($titulo, $descripcion, $ruta) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "insert into biblioteca_objetos (idObjeto,titulo,descripcion,rutaObjeto,fecha_creacion,fecha_modificacion) values(null,'$titulo','$descripcion','$ruta',CURRENT_TIMESTAMP(),CURRENT_TIMESTAMP())";
$database->setquery($sql);
$database->query();
}

function InsertDocumentoAudiencia($nombre_documento, $descripcion_documento, $archivo, $archivo_enc, $id_empresa){
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$hoy=date("Y-m-d");
$sql = "insert into tbl_audiencia_documentos (nombre, descripcion, filename, filename_enc, fecha, autor, id_empresa) 
values ('$nombre_documento', '$descripcion_documento', '$archivo', '$archivo_enc','$hoy','".$_SESSION["admin_"]."', '$id_empresa')";
$database->setquery($sql);
$database->query();
}

function Insert_notificaciones_creacion($titulo, $asunto, $texto, $id_empresa){
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$hoy=date("Y-m-d");
$sql = "insert into tbl_notificaciones_creacion (titulo, asunto, texto, id_empresa, fecha) 
values ('$titulo', '$asunto', '$texto', '$id_empresa','$hoy')";
$database->setquery($sql);
$database->query();
}

function InsertPublicacionesDocAudiencia($nombre_publicacion, $descripcion_documento, $id_documento, $id_audiencia, $fecha_inicio, $fecha_termino, $id_empresa, $autor, $fecha_creacion, $categoria, $perfil, $negocio){
global $c_host, $c_user, $c_pass, $c_db;

//echo "<br> data  $nombre_publicacion, $descripcion_documento, $id_documento, $id_audiencia, $fecha_inicio, $fecha_termino, $id_empresa";

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$hoy=date("Y-m-d");
$nombre_publicacion		=utf8_decode($nombre_publicacion);
$descripcion_documento	=utf8_decode($descripcion_documento);
$perfil					=utf8_decode($perfil);
$negocio	=($negocio);

$sql = "insert into tbl_audiencia_publicaciones (nombre, descripcion, id_documento, id_audiencia, fecha_inicio, fecha_termino, id_empresa, autor, fecha_creacion, agrupacion, perfil, negocio) 
values ('$nombre_publicacion', '$descripcion_documento', '$id_documento', '$id_audiencia', '$fecha_inicio', '$fecha_termino', '$id_empresa', '$autor', '$fecha_creacion', '$categoria', '$perfil', '$negocio')";


$database->setquery($sql);
$database->query();
}

function editarObjetoBiblioteca($id, $nuevoTitulo, $nuevaDescripcion) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "update biblioteca_objetos set titulo = '$nuevoTitulo', descripcion = '$nuevaDescripcion', fecha_modificacion = CURRENT_TIMESTAMP() where idObjeto = $id";
//echo $sql;
$database->setquery($sql);
$database->query();
}

function buscarObjetoBiblioteca($id) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from biblioteca_objetos where idObjeto = $id";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}


function DeleteDocumentoMatriz($id) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "delete from tbl_audiencia_documentos where id = $id";
//echo $sql;
$database->setquery($sql);
$database->query();
}


function DeleteNotificacionCreacionMatriz($id) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "delete from tbl_notificaciones_creacion where id = $id";
//echo $sql;
$database->setquery($sql);
$database->query();
}

function DeletePublicacionMatriz($id) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "delete from tbl_audiencia_publicaciones where id = $id";
//echo $sql;
$database->setquery($sql);
$database->query();
}
function eliminarObjetoBiblioteca($id) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "delete from biblioteca_objetos where idObjeto = $id";
//echo $sql;
$database->setquery($sql);
$database->query();
}

function consultaEmpresaSubidaUsuarios($idEmpresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select count(*) as total from tbl_empresa_subida_usuarios where id_empresa = $idEmpresa";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function listarEmpresaSubidaUsuarios($idEmpresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_empresa_subida_usuarios where id_empresa = $idEmpresa order by id ASC"; //echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function buscarRegistroNombreCampo($idEmpresa, $campoVisual) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_empresa_subida_usuarios where id_empresa = $idEmpresa and nombrecampoamostrar = '$campoVisual'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function listarNotificacionesUsuarios_Pendientes($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$orderBy = "";
if (strlen($order) > 0) {
$orderBy = "order by " . $order;
}
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from tbl_notificaciones_usuarios where  id_empresa='$id_empresa'  and estado is Null";
// echo "<br><br><br>$sql";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function usuario_insert_usuario_temp(
$rut,
$rut_completo,
$nombre,
$apaterno,
$amaterno,
$nombre_completo,
$cargo,
$rut_duplicado,
$codigo_proceso,
$id_perfil,
$id_rol,
$id_cargo,
$id_empresa,
$jefe,
$dependencia,
$fecha_ingreso,
$email,
$emailBK,
$negocio,
$zona,
$gerencia,
$area,
$departamento,
$local,
$responsable,
$telefono,
$celular,
$unidad_negocio,
$id_area,
$evaluador,
$perfil_evaluacion,
$seccion,
$ubicacion,
$fecha_nacimiento,
$genero,
$nacionalidad,
$direccion_particular,
$codigo_escolaridad,
$codigo_nivel,
$id_centro_costo,
$centro_costo,
$comuna,
$fecha_antiguedad,
$tipo_contrato,
$tramo_sence,
$dv,
$empresa_holding,
$division,
$porvalidar,
$idprivado,
$antiguedad,
$lider,
$tallergrupo,
$mundo,
$subgerencia,
$estadocivil,
$vigencia,
$id_unidad_negocio,
$escolaridad,
$sucursal,
$nombre_empresa_holding,
$servicio,
$tipo_servicio,
$comunidad,
$id_comunidad,
$vigencia_descripcion,
$nombre_jefatura,
$cargo_jefatura,
$telefono_jefatura,
$email_jefatura,
$id_perfil_competencia,
$perfil_competencia,
$anexo,
$id_gerencia,
$id_subgerencia,
$codigo_sap,
$regional,
$avatar,
$zonal,
$vicepresidencia,
$gerenciaR2,
$gerenciaR3,
$userid_moodle,
$operador,
$organica,
$nivel_inicio,
$pais,
$familia_cargo,
$tipo_cargo,

$codigo_negociacion,
$fecha_reconocimiento,
$fecha_ingreso_vacaciones,

$dias_derecho,
$dias_pendientes,
$dias_pendientes_real,

$cod_cargo_ant,
$gls_cargo_ant,
$ant_agno_reconoci,
$tipo_renta,
$edad,
$fec_nacim,

$silla_id_cargo,
$silla_cargo,

$silla_id_division,
$silla_division,

$silla_id_area,
$silla_area,

$silla_id_departamento,
$silla_departamento,

$silla_id_zona,
$silla_zona,

$silla_id_seccion,
$silla_seccion,

$silla_id_oficina,
$silla_oficina,

$silla_id_unidad,
$silla_unidad,
$opc_uniforme,

$est_civil,
$est_civil_glosa,
$isapre_codigo,
$isapre_glosa,
$sucur_ciudad,
$sucur_comuna,
$sindi_codigo,
$sindi_glosa

){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$descripcion = utf8_decode($descripcion);

$sql = "insert into tbl_usuario_temporal

(
rut,
rut_completo,
nombre,
apaterno,
amaterno,
nombre_completo,
cargo,
rut_duplicado,
codigo_proceso,
id_perfil,
id_rol,
id_cargo,
id_empresa,
jefe,
dependencia,
fecha_ingreso,
email,
emailBK,
negocio,
zona,
gerencia,
area,
departamento,
local,
responsable,
telefono,
celular,
unidad_negocio,
id_area,
evaluador,
perfil_evaluacion,
seccion,
ubicacion,
fecha_nacimiento,
genero,
nacionalidad,
direccion_particular,
codigo_escolaridad,
codigo_nivel,
id_centro_costo,
centro_costo,
comuna,
fecha_antiguedad,
tipo_contrato,
tramo_sence,
dv,
empresa_holding,
division,
porvalidar,
idprivado,
antiguedad,
lider,
tallergrupo,
mundo,
subgerencia,
estadocivil,
vigencia,
id_unidad_negocio,
escolaridad,
sucursal,
nombre_empresa_holding,
servicio,
tipo_servicio,
comunidad,
id_comunidad,
vigencia_descripcion,
nombre_jefatura,
cargo_jefatura,
telefono_jefatura,
email_jefatura,
id_perfil_competencia,
perfil_competencia,
anexo,
id_gerencia,
id_subgerencia,
codigo_sap,
regional,
avatar,
zonal,
vicepresidencia,
gerenciaR2,
gerenciaR3,
userid_moodle,
operador,
organica,
nivel_inicio,
pais,
familia_cargo,
tipo_cargo,

codigo_negociacion,
fecha_reconocimiento,
fecha_ingreso_vacaciones,

dias_derecho,
dias_pendientes,
dias_pendientes_real,

cod_cargo_ant,
gls_cargo_ant,
ant_agno_reconoci,
tipo_renta,
edad,
fec_nacim,

silla_id_cargo,
silla_cargo,

silla_id_division,
silla_division,

silla_id_area,
silla_area,

silla_id_departamento,
silla_departamento,

silla_id_zona,
silla_zona,

silla_id_seccion,
silla_seccion,

silla_id_oficina,
silla_oficina,

silla_id_unidad,
silla_unidad,

opc_uniforme,

est_civil,
est_civil_glosa,
isapre_codigo,
isapre_glosa,
sucur_ciudad,
sucur_comuna,
sindi_codigo,
sindi_glosa

)

values

(

'$rut',
'$rut_completo',
'$nombre',
'$apaterno',
'$amaterno',
'$nombre_completo',
'$cargo',
'$rut_duplicado',
'$codigo_proceso',
'$id_perfil',
'$id_rol',
'$id_cargo',
'$id_empresa',
'$jefe',
'$dependencia',
'$fecha_ingreso',
'$email',
'$emailBK',
'$negocio',
'$zona',
'$gerencia',
'$area',
'$departamento',
'$local',
'$responsable',
'$telefono',
'$celular',
'$unidad_negocio',
'$id_area',
'$evaluador',
'$perfil_evaluacion',
'$seccion',
'$ubicacion',
'$fecha_nacimiento',
'$genero',
'$nacionalidad',
'$direccion_particular',
'$codigo_escolaridad',
'$codigo_nivel',
'$id_centro_costo',
'$centro_costo',
'$comuna',
'$fecha_antiguedad',
'$tipo_contrato',
'$tramo_sence',
'$dv',
'$empresa_holding',
'$division',
'$porvalidar',
'$idprivado',
'$antiguedad',
'$lider',
'$tallergrupo',
'$mundo',
'$subgerencia',
'$estadocivil',
'$vigencia',
'$id_unidad_negocio',
'$escolaridad',
'$sucursal',
'$nombre_empresa_holding',
'$servicio',
'$tipo_servicio',
'$comunidad',
'$id_comunidad',
'$vigencia_descripcion',
'$nombre_jefatura',
'$cargo_jefatura',
'$telefono_jefatura',
'$email_jefatura',
'$id_perfil_competencia',
'$perfil_competencia',
'$anexo',
'$id_gerencia',
'$id_subgerencia',
'$codigo_sap',
'$regional',
'$avatar',
'$zonal',
'$vicepresidencia',
'$gerenciaR2',
'$gerenciaR3',
'$userid_moodle',
'$operador',
'$organica',
'$nivel_inicio',
'$pais',
'$familia_cargo',
'$tipo_cargo',

'$codigo_negociacion',
'$fecha_reconocimiento',
'$fecha_ingreso_vacaciones',

'$dias_derecho',
'$dias_pendientes',
'$dias_pendientes_real',

'$cod_cargo_ant',
'$gls_cargo_ant',
'$ant_agno_reconoci',
'$tipo_renta',
'$edad',
'$fec_nacim',

'$silla_id_cargo',
'$silla_cargo',

'$silla_id_division',
'$silla_division',

'$silla_id_area',
'$silla_area',

'$silla_id_departamento',
'$silla_departamento',

'$silla_id_zona',
'$silla_zona',

'$silla_id_seccion',
'$silla_seccion',

'$silla_id_oficina',
'$silla_oficina',

'$silla_id_unidad',
'$silla_unidad',
'$opc_uniforme',

'$est_civil',
'$est_civil_glosa',
'$isapre_codigo',
'$isapre_glosa',
'$sucur_ciudad',
'$sucur_comuna',
'$sindi_codigo',
'$sindi_glosa'
)";



$database->setquery($sql);
$database->query();

}


function BorraDuplicados($tipo, $id_empresa){
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$sql="
select h.*, (select id from tbl_usuario where rut=h.rut ) as estaduplicado 

from tbl_usuario_temporal h

where (select id from tbl_usuario where rut=h.rut ) is not null;

";
//echo "BorraDuplicados sql ".$sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();	 

foreach ($cod as $unico){

$sql2="	delete from tbl_usuario where rut=".$unico->rut."";
$database->setquery($sql2);
$database->query();	

//echo "	<br>$sql2";

}


}
function CopiatblUsuario_Egresados($id_empresa){


global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select h.*, (select rut from tbl_usuario_temporal where rut=h.rut and vigencia_descripcion='') as cuenta from tbl_usuario h
where (select rut from tbl_usuario_temporal where rut=h.rut and vigencia_descripcion='')  is NULL
and (vigencia_descripcion='' or vigencia_descripcion IS NULL)
";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

foreach($cod as $unico){
$sql2 = "INSERT INTO tbl_usuario_egresados SELECT * FROM tbl_usuario where rut='".$unico->rut."';"; //echo $sql;
$database->setquery($sql2);
$database->query();
$cod2 = $database->listObjects();
}

return $cod;

}
function truncate_tbl_usuario($id_empresa){


global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "DELETE
FROM
tbl_usuario
WHERE
(
vigencia_descripcion = ''
OR vigencia_descripcion IS NULL
) ";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;

}

function usuario_temporal_lee($id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "INSERT INTO tbl_usuario SELECT * FROM tbl_usuario_temporal "; //echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function usuario_insert_usuario_tbl_usuario(
$rut,
$rut_completo,
$nombre,
$apaterno,
$amaterno,
$nombre_completo,
$cargo,
$rut_duplicado,
$codigo_proceso,
$id_perfil,
$id_rol,
$id_cargo,
$id_empresa,
$jefe,
$dependencia,
$fecha_ingreso,
$email,
$emailBK,
$negocio,
$zona,
$gerencia,
$area,
$departamento,
$local,
$responsable,
$telefono,
$celular,
$unidad_negocio,
$id_area,
$evaluador,
$perfil_evaluacion,
$seccion,
$ubicacion,
$fecha_nacimiento,
$genero,
$nacionalidad,
$direccion_particular,
$codigo_escolaridad,
$codigo_nivel,
$id_centro_costo,
$centro_costo,
$comuna,
$fecha_antiguedad,
$tipo_contrato,
$tramo_sence,
$dv,
$empresa_holding,
$division,
$porvalidar,
$idprivado,
$antiguedad,
$lider,
$tallergrupo,
$mundo,
$subgerencia,
$estadocivil,
$vigencia,
$id_unidad_negocio,
$escolaridad,
$sucursal,
$nombre_empresa_holding,
$servicio,
$tipo_servicio,
$comunidad,
$id_comunidad,
$vigencia_descripcion,
$nombre_jefatura,
$cargo_jefatura,
$telefono_jefatura,
$email_jefatura,
$id_perfil_competencia,
$perfil_competencia,
$anexo,
$id_gerencia,
$id_subgerencia,
$codigo_sap,
$regional,
$avatar,
$zonal,
$vicepresidencia,
$gerenciaR2,
$gerenciaR3,
$userid_moodle,
$operador,
$organica,
$nivel_inicio,
$pais,
$familia_cargo,
$tipo_cargo){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$descripcion = utf8_decode($descripcion);

$sql = "insert into tbl_usuario_temporal

(
rut,
rut_completo,
nombre,
apaterno,
amaterno,
nombre_completo,
cargo,
rut_duplicado,
codigo_proceso,
id_perfil,
id_rol,
id_cargo,
id_empresa,
jefe,
dependencia,
fecha_ingreso,
email,
emailBK,
negocio,
zona,
gerencia,
area,
departamento,
local,
responsable,
telefono,
celular,
unidad_negocio,
id_area,
evaluador,
perfil_evaluacion,
seccion,
ubicacion,
fecha_nacimiento,
genero,
nacionalidad,
direccion_particular,
codigo_escolaridad,
codigo_nivel,
id_centro_costo,
centro_costo,
comuna,
fecha_antiguedad,
tipo_contrato,
tramo_sence,
dv,
empresa_holding,
division,
porvalidar,
idprivado,
antiguedad,
lider,
tallergrupo,
mundo,
subgerencia,
estadocivil,
vigencia,
id_unidad_negocio,
escolaridad,
sucursal,
nombre_empresa_holding,
servicio,
tipo_servicio,
comunidad,
id_comunidad,
vigencia_descripcion,
nombre_jefatura,
cargo_jefatura,
telefono_jefatura,
email_jefatura,
id_perfil_competencia,
perfil_competencia,
anexo,
id_gerencia,
id_subgerencia,
codigo_sap,
regional,
avatar,
zonal,
vicepresidencia,
gerenciaR2,
gerenciaR3,
userid_moodle,
operador,
organica,
nivel_inicio,
pais,
familia_cargo,
tipo_cargo)

values

(

'$rut',
'$rut_completo',
'$nombre',
'$apaterno',
'$amaterno',
'$nombre_completo',
'$cargo',
'$rut_duplicado',
'$codigo_proceso',
'$id_perfil',
'$id_rol',
'$id_cargo',
'$id_empresa',
'$jefe',
'$dependencia',
'$fecha_ingreso',
'$email',
'$emailBK',
'$negocio',
'$zona',
'$gerencia',
'$area',
'$departamento',
'$local',
'$responsable',
'$telefono',
'$celular',
'$unidad_negocio',
'$id_area',
'$evaluador',
'$perfil_evaluacion',
'$seccion',
'$ubicacion',
'$fecha_nacimiento',
'$genero',
'$nacionalidad',
'$direccion_particular',
'$codigo_escolaridad',
'$codigo_nivel',
'$id_centro_costo',
'$centro_costo',
'$comuna',
'$fecha_antiguedad',
'$tipo_contrato',
'$tramo_sence',
'$dv',
'$empresa_holding',
'$division',
'$porvalidar',
'$idprivado',
'$antiguedad',
'$lider',
'$tallergrupo',
'$mundo',
'$subgerencia',
'$estadocivil',
'$vigencia',
'$id_unidad_negocio',
'$escolaridad',
'$sucursal',
'$nombre_empresa_holding',
'$servicio',
'$tipo_servicio',
'$comunidad',
'$id_comunidad',
'$vigencia_descripcion',
'$nombre_jefatura',
'$cargo_jefatura',
'$telefono_jefatura',
'$email_jefatura',
'$id_perfil_competencia',
'$perfil_competencia',
'$anexo',
'$id_gerencia',
'$id_subgerencia',
'$codigo_sap',
'$regional',
'$avatar',
'$zonal',
'$vicepresidencia',
'$gerenciaR2',
'$gerenciaR3',
'$userid_moodle',
'$operador',
'$organica',
'$nivel_inicio',
'$pais',
'$familia_cargo',
'$tipo_cargo'
)";

$database->setquery($sql);
$database->query();

}
function listarRegistrosTablaGlobalFiltro($tableName, $filterName, $filterValue, $order) {
global $c_host, $c_user, $c_pass, $c_db;
$orderBy = "";
if (strlen($order) > 0) {
$orderBy = "order by " . $order;
}
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "select * from $tableName where $filterName = '$filterValue' $orderBy";
//echo "<br><br><br>$sql";exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function DeleteFullTbl($table, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "DELETE FROM $table WHERE id_empresa='$id_empresa'";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function buscarRegistroTablaGlobalFiltro($tableName, $filterName, $filterValue) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);

$database->setDb($c_db);

$sql = "select * from $tableName where $filterName = $filterValue";

$database->setquery($sql);

$database->query();

$cod = $database->listObjects();

return $cod;
}

function buscarRegistroTablaGlobalFiltros($tableName, array $filterNames, array $filterValues) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);

$database->setDb($c_db);

$sql = "select * from $tableName where ";

for ($i = 0; $i < count($filterNames); $i++) {
if ($i == 0) {
$sql .= $filterNames[$i] . " = " . $filterValues[$i];
} else {

$sql .= " and " . $filterNames[$i] . " = " . $filterValues[$i];
}
}

//var_dump($sql);

$database->setquery($sql);

$database->query();

$cod = $database->listObjects();

return $cod;
}

function truncarTablaGlobal($tableName) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);

$database->setDb($c_db);

$sql = "truncate table $tableName";

$database->setquery($sql);

$database->query();
}

function TraeColaboradresTutorGrupo($ruttutor, $codigo, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select count(id) as cuenta from tbl_emb_embajadores where rut_tutor='$ruttutor' and id_empresa='$id_empresa' and id_ola='$codigo'";

$database->setquery($sql);

$database->query();

$cod = $database->listObjects();

return $cod[0]->cuenta;
}

function buscarMaxValueTablaGlobal($campo, $abrev, $tableName) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);

$database->setDb($c_db);

$sql = "select max($campo) $abrev from $tableName";

$database->setquery($sql);

$database->query();

$cod = $database->listObjects();

return $cod;
}

function emb_lista_tarea_resultado_avance($id_empresa, $tipo) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($tipo == "Detalle") {
$sql = "

select h.*,
(select estado from tbl_emb_respuestas_embajadores_tareas where rut=h.rut and id_grupo_interes=h.codigo and id_tarea=h.id_tarea and
id_empresa=h.id_empresa limit 1) as tarea_estado,
(select conquientrabajaste from tbl_emb_respuestas_embajadores_tareas where rut=h.rut and id_grupo_interes=h.codigo and id_tarea=h.id_tarea and
id_empresa=h.id_empresa limit 1) as conquientrabajaste,
(select conquientrabajaste from tbl_emb_respuestas_embajadores_tareas where rut=h.rut and id_grupo_interes=h.codigo and id_tarea=h.id_tarea and
id_empresa=h.id_empresa limit 1) as dias,
(select rut_tutor from tbl_emb_embajadores where rut=h.rut and id_ola=h.codigo  and rut_tutor<>'' limit 1) as ruttutor,
(select nombre from tbl_emb_tareas where codigo=h.id_tarea limit 1) as tarea,
(select rut_sponsor from tbl_emb_embajadores where rut=h.rut and id_ola=h.codigo and rut_sponsor<>'' limit 1) as rutsponsor,

(select id_ola from tbl_emb_embajadores where rut=h.rut and id_ola=h.codigo limit 1) as idGrupoCerrado,
(select idgrupo from tbl_emb_embajadores where rut=h.rut and id_ola=h.codigo limit 1) as idEquipo,
(select grupo from tbl_emb_embajadores where rut=h.rut and id_ola=h.codigo limit 1) as Equipo,

(select count(id) from tbl_emb_rel_embajadores_tareas where rut=h.rut and codigo=h.codigo  and id_empresa=h.id_empresa) as CuentaTareas,

(select count(id) from tbl_emb_respuestas_embajadores_tareas where rut=h.rut and id_grupo_interes=h.codigo and id_empresa=h.id_empresa and estado='INICIADA') as CuentaTareasIniciada,
(select count(id) from tbl_emb_respuestas_embajadores_tareas where rut=h.rut and id_grupo_interes=h.codigo and id_empresa=h.id_empresa and estado='EN_REVISION') as CuentaTareasvRevision,
(select count(id) from tbl_emb_respuestas_embajadores_tareas where rut=h.rut and id_grupo_interes=h.codigo and id_empresa=h.id_empresa and estado='VALIDADA') as CuentaTareasvValidada,

( (select count(id) from tbl_emb_respuestas_embajadores_tareas where rut=h.rut and id_grupo_interes=h.codigo  and id_empresa=h.id_empresa and estado='VALIDADA')/ (select count(id) from tbl_emb_rel_embajadores_tareas where rut=h.rut  and codigo=h.codigo and id_empresa=h.id_empresa)) as porc_validada,
( (select count(id) from tbl_emb_respuestas_embajadores_tareas where rut=h.rut and id_grupo_interes=h.codigo  and id_empresa=h.id_empresa and estado='EN_REVISION') / (select count(id) from tbl_emb_rel_embajadores_tareas where rut=h.rut and codigo=h.codigo  and id_empresa=h.id_empresa)) as porc_revision,
( (select count(id) from tbl_emb_respuestas_embajadores_tareas where rut=h.rut and id_grupo_interes=h.codigo  and id_empresa=h.id_empresa and estado='INICIADA') / (select count(id) from tbl_emb_rel_embajadores_tareas where rut=h.rut and codigo=h.codigo  and id_empresa=h.id_empresa)) as porc_iniciada,

(
(
SELECT
estado_demora_emb
FROM
tbl_emb_respuestas_embajadores_tareas
WHERE
rut = h.rut
AND id_grupo_interes = h.codigo
AND id_empresa = h.id_empresa
and id_tarea=h.id_tarea
limit 1
)
) AS estado_demora_emb,
(
(
SELECT
estado_demora_val
FROM
tbl_emb_respuestas_embajadores_tareas
WHERE
rut = h.rut
AND id_grupo_interes = h.codigo
AND id_empresa = h.id_empresa
and id_tarea=h.id_tarea
limit 1
)
) AS estado_demora_val,
(
(
SELECT
fecha_registro
FROM
tbl_emb_respuestas_embajadores_tareas
WHERE
rut = h.rut
AND id_grupo_interes = h.codigo
AND id_empresa = h.id_empresa
and id_tarea=h.id_tarea
limit 1
)
) AS fecha_registro,

(
(
SELECT
fecha_validacion
FROM
tbl_emb_respuestas_embajadores_tareas
WHERE
rut = h.rut
AND id_grupo_interes = h.codigo
AND id_empresa = h.id_empresa
and id_tarea=h.id_tarea
limit 1
)
) AS fecha_validacion,

(select fecha_termino from tbl_emb_tareas where codigo=h.id_tarea limit 1) as fecha_termino,






(100*( (select count(id) from tbl_emb_respuestas_embajadores_tareas where rut=h.rut and id_empresa=h.id_empresa and id_grupo_interes=h.codigo  and estado='VALIDADA')/ (select count(id) from tbl_emb_rel_embajadores_tareas where rut=h.rut and codigo=h.codigo  and id_empresa=h.id_empresa))
+50*( (select count(id) from tbl_emb_respuestas_embajadores_tareas where rut=h.rut and id_empresa=h.id_empresa and id_grupo_interes=h.codigo  and estado='EN_REVISION') / (select count(id) from tbl_emb_rel_embajadores_tareas where rut=h.rut and codigo=h.codigo  and id_empresa=h.id_empresa))
+0*( (select count(id) from tbl_emb_respuestas_embajadores_tareas where rut=h.rut and id_empresa=h.id_empresa and id_grupo_interes=h.codigo  and estado='INICIADA') / (select count(id) from tbl_emb_rel_embajadores_tareas where rut=h.rut and codigo=h.codigo  and id_empresa=h.id_empresa))
) as avance


from tbl_emb_rel_embajadores_tareas h

where h.id_empresa='$id_empresa'

group by h.rut,h.codigo,h.id_tarea

order by (select nombre_completo from tbl_usuario where rut=h.rut)";
} elseif ($tipo == "Tutor") {
$sql = "
select h.*,
(select estado from tbl_emb_respuestas_embajadores_tareas where rut=h.rut and id_grupo_interes=h.codigo and id_tarea=h.id_tarea and
id_empresa=h.id_empresa limit 1) as tarea_estado,
(select conquientrabajaste from tbl_emb_respuestas_embajadores_tareas where rut=h.rut and id_grupo_interes=h.codigo and id_tarea=h.id_tarea and
id_empresa=h.id_empresa limit 1) as conquientrabajaste,
(select rut_tutor from tbl_emb_embajadores where rut=h.rut and id_ola=h.codigo and rut_tutor<>''  limit 1) as ruttutor,
(select nombre from tbl_emb_tareas where codigo=h.id_tarea limit 1) as tarea,
(select rut_sponsor from tbl_emb_embajadores where rut_tutor=(select rut_sponsor from tbl_emb_embajadores where rut=h.rut and id_ola=h.codigo and rut_sponsor<>''  limit 1) and id_ola=h.codigo and rut_sponsor<>''  limit 1) as num_embajadores,

(select id_ola from tbl_emb_embajadores where rut=h.rut and id_ola=h.codigo limit 1) as idGrupoCerrado,
(select idgrupo from tbl_emb_embajadores where rut=h.rut and id_ola=h.codigo limit 1) as idEquipo,
(select grupo from tbl_emb_embajadores where rut=h.rut and id_ola=h.codigo limit 1) as Equipo,
(select count(id)  from tbl_emb_embajadores where rut=h.rut and id_ola=h.codigo limit 1) as Equipo,
(select id_ola from tbl_emb_embajadores where rut=h.rut and rut_tutor=(select rut_sponsor from tbl_emb_embajadores where rut=h.rut and id_ola=h.codigo and rut_sponsor<>''  limit 1) and id_ola=h.codigo and rut_sponsor<>''  limit 1) as Ola,

(select rut_tutor from tbl_emb_embajadores where rut=h.rut and id_ola=h.codigo  and rut_sponsor<>'' limit 1) as RUT2_TUTOR2 ,

(select count(j.id) from tbl_emb_rel_embajadores_tareas j where
(select rut_tutor from tbl_emb_embajadores where rut=j.rut and id_ola=h.codigo and rut_tutor<>''  limit 1)=(select rut_tutor from tbl_emb_embajadores where rut=h.rut and id_ola=h.codigo limit 1)
and j.codigo=h.codigo  and j.id_empresa=h.id_empresa) as CuentaTareas,

(select count(j.id) from tbl_emb_respuestas_embajadores_tareas j where
(select rut_tutor from tbl_emb_embajadores where rut=j.rut and id_ola=h.codigo and rut_tutor<>''  limit 1)=(select rut_tutor from tbl_emb_embajadores where rut=h.rut and id_ola=h.codigo limit 1)
and j.id_grupo_interes=h.codigo and j.id_empresa=h.id_empresa and j.estado='INICIADA') as CuentaTareasIniciada,


(select count(j.id) from tbl_emb_respuestas_embajadores_tareas j  where
(select rut_tutor from tbl_emb_embajadores where rut=j.rut and id_ola=h.codigo and rut_tutor<>''  limit 1)=(select rut_tutor from tbl_emb_embajadores where rut=h.rut and id_ola=h.codigo limit 1)
and j.id_grupo_interes=h.codigo and j.id_empresa=h.id_empresa and j.estado='EN_REVISION') as CuentaTareasvRevision,

(select count(j.id) from tbl_emb_respuestas_embajadores_tareas j where
(select rut_tutor from tbl_emb_embajadores where rut=j.rut and id_ola=h.codigo and rut_tutor<>''  limit 1)=(select rut_tutor from tbl_emb_embajadores where rut=h.rut and id_ola=h.codigo limit 1)
and j.id_grupo_interes=h.codigo and j.id_empresa=h.id_empresa and j.estado='VALIDADA') as CuentaTareasvValidada,


(100*( (select count(j.id) from tbl_emb_respuestas_embajadores_tareas j where
(select rut_tutor from tbl_emb_embajadores where rut=j.rut and id_ola=h.codigo and rut_tutor<>''  limit 1)=(select rut_tutor from tbl_emb_embajadores where rut=h.rut and id_ola=h.codigo limit 1)
and j.id_grupo_interes=h.codigo and j.id_empresa=h.id_empresa and j.estado='VALIDADA')/
(select count(j.id) from tbl_emb_rel_embajadores_tareas j where
(select rut_tutor from tbl_emb_embajadores where rut=j.rut and id_ola=h.codigo and rut_tutor<>''  limit 1)=(select rut_tutor from tbl_emb_embajadores where rut=h.rut and id_ola=h.codigo limit 1)
and j.codigo=h.codigo  and j.id_empresa=h.id_empresa))
+50*(
(select count(j.id) from tbl_emb_respuestas_embajadores_tareas j  where
(select rut_tutor from tbl_emb_embajadores where rut=j.rut and id_ola=h.codigo and rut_tutor<>''  limit 1)=(select rut_tutor from tbl_emb_embajadores where rut=h.rut and id_ola=h.codigo limit 1)
and j.id_grupo_interes=h.codigo and j.id_empresa=h.id_empresa and j.estado='EN_REVISION')


/
(select count(j.id) from tbl_emb_rel_embajadores_tareas j where
(select rut_tutor from tbl_emb_embajadores where rut=j.rut and id_ola=h.codigo and rut_tutor<>''  limit 1)=(select rut_tutor from tbl_emb_embajadores where rut=h.rut and id_ola=h.codigo limit 1)
and j.codigo=h.codigo  and j.id_empresa=h.id_empresa)
)
) as avance

from tbl_emb_rel_embajadores_tareas h

where h.id_empresa='$id_empresa'
AND

(select rut_tutor from tbl_emb_embajadores where rut=h.rut and id_ola=h.codigo  and rut_sponsor<>'' limit 1)<>''

group by (select rut_tutor from tbl_emb_embajadores where rut=h.rut and id_ola=h.codigo  and rut_sponsor<>'' limit 1),h.codigo
order by

(
SELECT
id_ola
FROM
tbl_emb_embajadores
WHERE
rut = h.rut
AND id_ola = h.codigo
LIMIT 1
),


(100*( (select count(j.id) from tbl_emb_respuestas_embajadores_tareas j where
(select rut_tutor from tbl_emb_embajadores where rut=j.rut and id_ola=h.codigo and rut_tutor<>''  limit 1)=(select rut_tutor from tbl_emb_embajadores where rut=h.rut and id_ola=h.codigo limit 1)
and j.id_grupo_interes=h.codigo and j.id_empresa=h.id_empresa and j.estado='VALIDADA')/
(select count(j.id) from tbl_emb_rel_embajadores_tareas j where
(select rut_tutor from tbl_emb_embajadores where rut=j.rut and id_ola=h.codigo and rut_tutor<>''  limit 1)=(select rut_tutor from tbl_emb_embajadores where rut=h.rut and id_ola=h.codigo limit 1)
and j.codigo=h.codigo  and j.id_empresa=h.id_empresa))
+50*(
(select count(j.id) from tbl_emb_respuestas_embajadores_tareas j  where
(select rut_tutor from tbl_emb_embajadores where rut=j.rut and id_ola=h.codigo and rut_tutor<>''  limit 1)=(select rut_tutor from tbl_emb_embajadores where rut=h.rut and id_ola=h.codigo limit 1)
and j.id_grupo_interes=h.codigo and j.id_empresa=h.id_empresa and j.estado='EN_REVISION')


/
(select count(j.id) from tbl_emb_rel_embajadores_tareas j where
(select rut_tutor from tbl_emb_embajadores where rut=j.rut and id_ola=h.codigo and rut_tutor<>''  limit 1)=(select rut_tutor from tbl_emb_embajadores where rut=h.rut and id_ola=h.codigo limit 1)
and j.codigo=h.codigo  and j.id_empresa=h.id_empresa)
)
) DESC



";
} else {

$sql = "
select h.*,
(select estado from tbl_emb_respuestas_embajadores_tareas where rut=h.rut and id_grupo_interes=h.codigo and id_tarea=h.id_tarea and
id_empresa=h.id_empresa limit 1) as tarea_estado,
(select conquientrabajaste from tbl_emb_respuestas_embajadores_tareas where rut=h.rut and id_grupo_interes=h.codigo and id_tarea=h.id_tarea and
id_empresa=h.id_empresa limit 1) as conquientrabajaste,
(select rut_tutor from tbl_emb_embajadores where rut=h.rut and id_ola=h.codigo and rut_tutor<>''  limit 1) as ruttutor,
(select nombre from tbl_emb_tareas where codigo=h.id_tarea limit 1) as tarea,
(select rut_sponsor from tbl_emb_embajadores where rut=h.rut and id_ola=h.codigo and rut_sponsor<>''  limit 1) as rutsponsor,

(select id_ola from tbl_emb_embajadores where rut=h.rut and id_ola=h.codigo limit 1) as idGrupoCerrado,
(select idgrupo from tbl_emb_embajadores where rut=h.rut and id_ola=h.codigo limit 1) as idEquipo,
(select grupo from tbl_emb_embajadores where rut=h.rut and id_ola=h.codigo limit 1) as Equipo,


(select count(id) from tbl_emb_rel_embajadores_tareas where rut=h.rut and codigo=h.codigo  and id_empresa=h.id_empresa) as CuentaTareas,

(select count(id) from tbl_emb_respuestas_embajadores_tareas where rut=h.rut and id_grupo_interes=h.codigo and id_empresa=h.id_empresa and estado='INICIADA') as CuentaTareasIniciada,
(select count(id) from tbl_emb_respuestas_embajadores_tareas where rut=h.rut and id_grupo_interes=h.codigo and id_empresa=h.id_empresa and estado='EN_REVISION') as CuentaTareasvRevision,
(select count(id) from tbl_emb_respuestas_embajadores_tareas where rut=h.rut and id_grupo_interes=h.codigo and id_empresa=h.id_empresa and estado='VALIDADA') as CuentaTareasvValidada,

( (select count(id) from tbl_emb_respuestas_embajadores_tareas where rut=h.rut and id_grupo_interes=h.codigo  and id_empresa=h.id_empresa and estado='VALIDADA')/ (select count(id) from tbl_emb_rel_embajadores_tareas where rut=h.rut  and codigo=h.codigo and id_empresa=h.id_empresa)) as porc_validada,
( (select count(id) from tbl_emb_respuestas_embajadores_tareas where rut=h.rut and id_grupo_interes=h.codigo  and id_empresa=h.id_empresa and estado='EN_REVISION') / (select count(id) from tbl_emb_rel_embajadores_tareas where rut=h.rut and codigo=h.codigo  and id_empresa=h.id_empresa)) as porc_revision,
( (select count(id) from tbl_emb_respuestas_embajadores_tareas where rut=h.rut and id_grupo_interes=h.codigo  and id_empresa=h.id_empresa and estado='INICIADA') / (select count(id) from tbl_emb_rel_embajadores_tareas where rut=h.rut and codigo=h.codigo  and id_empresa=h.id_empresa)) as porc_iniciada,

(100*( (select count(id) from tbl_emb_respuestas_embajadores_tareas where rut=h.rut and id_empresa=h.id_empresa and id_grupo_interes=h.codigo  and estado='VALIDADA')/ (select count(id) from tbl_emb_rel_embajadores_tareas where rut=h.rut and codigo=h.codigo  and id_empresa=h.id_empresa))
+50*( (select count(id) from tbl_emb_respuestas_embajadores_tareas where rut=h.rut and id_empresa=h.id_empresa and id_grupo_interes=h.codigo  and estado='EN_REVISION') / (select count(id) from tbl_emb_rel_embajadores_tareas where rut=h.rut and codigo=h.codigo  and id_empresa=h.id_empresa))
+00*( (select count(id) from tbl_emb_respuestas_embajadores_tareas where rut=h.rut and id_empresa=h.id_empresa and id_grupo_interes=h.codigo  and estado='INICIADA') / (select count(id) from tbl_emb_rel_embajadores_tareas where rut=h.rut and codigo=h.codigo  and id_empresa=h.id_empresa))
) as avance

from tbl_emb_rel_embajadores_tareas h

where h.id_empresa='$id_empresa'

group by h.rut,h.codigo

order by (100*( (select count(id) from tbl_emb_respuestas_embajadores_tareas where rut=h.rut and id_grupo_interes=h.codigo  and id_empresa=h.id_empresa and estado='VALIDADA')/ (select count(id) from tbl_emb_rel_embajadores_tareas where rut=h.rut and codigo=h.codigo  and id_empresa=h.id_empresa))
+50*( (select count(id) from tbl_emb_respuestas_embajadores_tareas where rut=h.rut and id_grupo_interes=h.codigo  and id_empresa=h.id_empresa and estado='EN_REVISION') / (select count(id) from tbl_emb_rel_embajadores_tareas where rut=h.rut and codigo=h.codigo  and id_empresa=h.id_empresa))
)  DESC

";
}

//echo "sql 29573 $sql"; exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function MP_descargaVisitantes_data($id_mp, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = "

select h.*,
(select nombre_completo from tbl_usuario where rut=h.rut) as nombre_completo,
(select email from tbl_usuario where rut=h.rut) as email,
(select cargo from tbl_usuario where rut=h.rut) as cargo,
(select gerencia from tbl_usuario where rut=h.rut) as gerencia,
(select gerenciaR2 from tbl_usuario where rut=h.rut) as gerenciaR2,
(select gerenciaR3 from tbl_usuario where rut=h.rut) as gerenciaR3

from tbl_mp_interacciones h

where h.id_mp='$id_mp' and h.id_empresa='$id_empresa' and h.rut<>'' group by h.rut

";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function MP_Embajadoresconsolidado_tutor($tutor, $idgrupo, $id_empresa) {

$sql = "
select h.*,
(select estado from tbl_emb_respuestas_embajadores_tareas where rut=h.rut and id_grupo_interes=h.codigo and id_tarea=h.id_tarea and
id_empresa=h.id_empresa limit 1) as tarea_estado,
(select conquientrabajaste from tbl_emb_respuestas_embajadores_tareas where rut=h.rut and id_grupo_interes=h.codigo and id_tarea=h.id_tarea and
id_empresa=h.id_empresa limit 1) as conquientrabajaste,
(select rut_tutor from tbl_emb_embajadores where rut=h.rut and id_ola=h.codigo and rut_tutor<>''  limit 1) as ruttutor,
(select nombre from tbl_emb_tareas where codigo=h.id_tarea limit 1) as tarea,
(select rut_sponsor from tbl_emb_embajadores where rut=h.rut and id_ola=h.codigo and rut_sponsor<>''  limit 1) as rutsponsor,

(select id_ola from tbl_emb_embajadores where rut=h.rut and id_ola=h.codigo limit 1) as idGrupoCerrado,
(select idgrupo from tbl_emb_embajadores where rut=h.rut and id_ola=h.codigo limit 1) as idEquipo,
(select grupo from tbl_emb_embajadores where rut=h.rut and id_ola=h.codigo limit 1) as Equipo,


(select count(id) from tbl_emb_rel_embajadores_tareas where rut=h.rut and codigo=h.codigo  and id_empresa=h.id_empresa) as CuentaTareas,

(select count(id) from tbl_emb_respuestas_embajadores_tareas where rut=h.rut and id_grupo_interes=h.codigo and id_empresa=h.id_empresa and estado='INICIADA') as CuentaTareasIniciada,
(select count(id) from tbl_emb_respuestas_embajadores_tareas where rut=h.rut and id_grupo_interes=h.codigo and id_empresa=h.id_empresa and estado='EN_REVISION') as CuentaTareasvRevision,
(select count(id) from tbl_emb_respuestas_embajadores_tareas where rut=h.rut and id_grupo_interes=h.codigo and id_empresa=h.id_empresa and estado='VALIDADA') as CuentaTareasvValidada,

( (select count(id) from tbl_emb_respuestas_embajadores_tareas where rut=h.rut and id_grupo_interes=h.codigo  and id_empresa=h.id_empresa and estado='VALIDADA')/ (select count(id) from tbl_emb_rel_embajadores_tareas where rut=h.rut  and codigo=h.codigo and id_empresa=h.id_empresa)) as porc_validada,
( (select count(id) from tbl_emb_respuestas_embajadores_tareas where rut=h.rut and id_grupo_interes=h.codigo  and id_empresa=h.id_empresa and estado='EN_REVISION') / (select count(id) from tbl_emb_rel_embajadores_tareas where rut=h.rut and codigo=h.codigo  and id_empresa=h.id_empresa)) as porc_revision,
( (select count(id) from tbl_emb_respuestas_embajadores_tareas where rut=h.rut and id_grupo_interes=h.codigo  and id_empresa=h.id_empresa and estado='INICIADA') / (select count(id) from tbl_emb_rel_embajadores_tareas where rut=h.rut and codigo=h.codigo  and id_empresa=h.id_empresa)) as porc_iniciada,

(100*( (select count(id) from tbl_emb_respuestas_embajadores_tareas where rut=h.rut and id_empresa=h.id_empresa and id_grupo_interes=h.codigo  and estado='VALIDADA')/ (select count(id) from tbl_emb_rel_embajadores_tareas where rut=h.rut and codigo=h.codigo  and id_empresa=h.id_empresa))
+50*( (select count(id) from tbl_emb_respuestas_embajadores_tareas where rut=h.rut and id_empresa=h.id_empresa and id_grupo_interes=h.codigo  and estado='EN_REVISION') / (select count(id) from tbl_emb_rel_embajadores_tareas where rut=h.rut and codigo=h.codigo  and id_empresa=h.id_empresa))
+00*( (select count(id) from tbl_emb_respuestas_embajadores_tareas where rut=h.rut and id_empresa=h.id_empresa and id_grupo_interes=h.codigo  and estado='INICIADA') / (select count(id) from tbl_emb_rel_embajadores_tareas where rut=h.rut and codigo=h.codigo  and id_empresa=h.id_empresa))
) as avance

from tbl_emb_rel_embajadores_tareas h

where h.id_empresa='$id_empresa'

group by h.rut,h.codigo

order by (100*( (select count(id) from tbl_emb_respuestas_embajadores_tareas where rut=h.rut and id_grupo_interes=h.codigo  and id_empresa=h.id_empresa and estado='VALIDADA')/ (select count(id) from tbl_emb_rel_embajadores_tareas where rut=h.rut and codigo=h.codigo  and id_empresa=h.id_empresa))
+50*( (select count(id) from tbl_emb_respuestas_embajadores_tareas where rut=h.rut and id_grupo_interes=h.codigo  and id_empresa=h.id_empresa and estado='EN_REVISION') / (select count(id) from tbl_emb_rel_embajadores_tareas where rut=h.rut and codigo=h.codigo  and id_empresa=h.id_empresa))
)  DESC

";
}

function usernameEmail($rut, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = " select email from tbl_usuario where rut='$rut' and id_empresa='$id_empresa'";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

$email = $cod[0]->email;
//echo "email $email";
$arr_email = explode("@", $email);

//print_r($arr_email);sleep(10);

$cuerpoemail = $arr_email[0];
$username_email = "@" . $cuerpoemail;

return $username_email;
}

function puntos_insert_asignacion($rut, $fecha, $puntos, $tipo, $descripcion, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$descripcion = utf8_decode($descripcion);

$sql = "insert into tbl_premios_puntos_usuarios (rut,fecha,puntos,tipo,descripcion,id_empresa)
values ('$rut','$fecha','$puntos','$tipo','$descripcion','$id_empresa')";
//echo $sql;    //sleep(1);    //exit();

// $database->setquery($sql);
// $database->query();
}

function puntos_insert_asignacion_jefatura($rut, $fecha, $puntos, $tipo, $descripcion, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$descripcion = utf8_decode($descripcion);

$sql = "insert into tbl_premios_puntos_usuarios_jefe (rut,fecha,puntos,tipo,descripcion,id_empresa)
values ('$rut','$fecha','$puntos','$tipo','$descripcion','$id_empresa')";
//echo $sql; sleep(3);
//sleep(1);
//exit();
if ($rut != '') {
/// $database->setquery($sql);
//$database->query();
}
}

function clave_update_empresa_data($rut, $clave, $cambiado, $fecha_cambio, $fecha, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$descripcion = utf8_decode($descripcion);

$clave = utf8_decode($clave);

//    $sql = "insert into tbl_clave (rut,clave,cambiado,fecha_cambio,fecha,id_empresa)            values ('$rut','$clave','$cambiado','$fecha_cambio','$fecha','$id_empresa')";

//echo "<br> $sql";
$database->setquery($sql);
$database->query();
}

function usuarios_update_empresa_data($rut, $rut_completo, $nombre, $apaterno, $amaterno, $nombre_completo, $cargo, $id_cargo, $id_empresa, $jefe, $dependencia, $fecha_ingreso, $email, $zona, $gerencia, $area, $departamento, $local, $responsable, $telefono, $unidad_negocio, $id_area, $seccion, $ubicacion, $fecha_nacimiento, $genero, $centro_costo, $fecha_antiguedad, $tipo_contrato, $dv, $empresa_holding, $division, $lider, $mundo, $subgerencia, $vigencia, $id_unidad_negocio, $escolaridad, $sucursal, $nombre_empresa_holding, $tipo_servicio, $vigencia_descripcion, $nombre_jefatura, $anexo, $id_gerencia, $regional, $avatar, $zonal, $gerenciaR2, $gerenciaR3, $vicepresidencia, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$descripcion = utf8_decode($descripcion);

$clave = utf8_decode($clave);

$nombre = utf8_decode($nombre);
$apaterno = utf8_decode($apaterno);
$amaterno = utf8_decode($amaterno);
$nombre_completo = utf8_decode($nombre_completo);

$cargo = utf8_decode($cargo);
$id_cargo = utf8_decode($id_cargo);
$id_empresa = utf8_decode($id_empresa);
$jefe = utf8_decode($jefe);
$dependencia = utf8_decode($dependencia);
$fecha_ingreso = utf8_decode($fecha_ingreso);
$email = utf8_decode($email);
$zona = utf8_decode($zona);
$gerencia = utf8_decode($gerencia);
$area = utf8_decode($area);
$departamento = utf8_decode($departamento);
$local = utf8_decode($local);
$responsable = utf8_decode($responsable);
$telefono = utf8_decode($telefono);
$unidad_negocio = utf8_decode($unidad_negocio);
$id_area = utf8_decode($id_area);
$seccion = utf8_decode($seccion);
$ubicacion = utf8_decode($ubicacion);
$fecha_nacimiento = utf8_decode($fecha_nacimiento);
$genero = utf8_decode($genero);
$centro_costo = utf8_decode($centro_costo);
$fecha_antiguedad = utf8_decode($fecha_antiguedad);
$tipo_contrato = utf8_decode($tipo_contrato);
$dv = utf8_decode($dv);
$empresa_holding = utf8_decode($empresa_holding);
$division = utf8_decode($division);
$lider = utf8_decode($lider);
$mundo = utf8_decode($mundo);
$subgerencia = utf8_decode($subgerencia);
$vigencia = utf8_decode($vigencia);
$id_unidad_negocio = utf8_decode($id_unidad_negocio);
$escolaridad = utf8_decode($escolaridad);
$sucursal = utf8_decode($sucursal);
$nombre_empresa_holding = utf8_decode($nombre_empresa_holding);
$tipo_servicio = utf8_decode($tipo_servicio);
$vigencia_descripcion = utf8_decode($vigencia_descripcion);
$nombre_jefatura = utf8_decode($nombre_jefatura);
$anexo = utf8_decode($anexo);
$id_gerencia = utf8_decode($id_gerencia);
$regional = utf8_decode($regional);
$avatar = utf8_decode($avatar);
$zonal = utf8_decode($zonal);
$gerenciaR2 = utf8_decode($gerenciaR2);
$gerenciaR3 = utf8_decode($vicepresidencia);
$vicepresidencia = utf8_decode($gerenciaR3);

$sql = "insert into tbl_usuario (rut,rut_completo,nombre,apaterno,amaterno,nombre_completo,cargo,id_cargo,id_empresa,jefe,dependencia,fecha_ingreso,email,zona,gerencia,area,departamento,local,responsable,telefono,unidad_negocio,id_area,seccion,ubicacion,fecha_nacimiento,genero,centro_costo,fecha_antiguedad,tipo_contrato,dv,empresa_holding,division,lider,mundo,subgerencia,vigencia,id_unidad_negocio,escolaridad,sucursal,nombre_empresa_holding,tipo_servicio,vigencia_descripcion,nombre_jefatura,anexo,id_gerencia,regional,avatar,zonal,gerenciaR2,gerenciaR3, vicepresidencia)
values ('$rut','$rut_completo','$nombre','$apaterno','$amaterno','$nombre_completo','$cargo','$id_cargo','$id_empresa','$jefe','$dependencia','$fecha_ingreso','$email','$zona','$gerencia','$area','$departamento','$local','$responsable','$telefono','$unidad_negocio','$id_area','$seccion','$ubicacion','$fecha_nacimiento','$genero','$centro_costo','$fecha_antiguedad','$tipo_contrato','$dv','$empresa_holding','$division','$lider','$mundo','$subgerencia','$vigencia','$id_unidad_negocio','$escolaridad','$sucursal','$nombre_empresa_holding','$tipo_servicio','$vigencia_descripcion','$nombre_jefatura','$anexo','$id_gerencia','$regional','$avatar','$zonal','$gerenciaR2','$gerenciaR3','$vicepresidencia')";

//echo "<br> $sql";
$database->setquery($sql);
$database->query();
}

function puntos_insert_excepcion($rut, $fecha, $id_premio, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$descripcion = utf8_decode($descripcion);

$sql = "insert into tbl_premios_puntos_excepcion (rut,fecha,id_premio,id_empresa)
values ('$rut','$fecha','$id_premio','$id_empresa')";
//echo $sql;
//sleep(1);

//exit();

$database->setquery($sql);
$database->query();
}

function BuscaNombreNotificacion($codigo, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$sql = " select nombre from tbl_notificaciones where codigo='$codigo' and id_empresa='$id_empresa'";
//echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod[0]->nombre;
}

function Notificaciones_crea_not_automaticas($tipoenvio, $nombre, $rut, $fecha_envio, $id_empresa, $to,
$nombreto, $from, $nombrefrom, $tipo, $subject, $titulo1, $subtitulo1, $texto1, $url, $texto_url, $texto2,
$texto3, $texto4, $logo, $tipomensaje, $key, $template) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "insert into tbl_notificaciones_automaticas (
tipoenvio,nombre,rut,fecha_envio,id_empresa,hacia,
nombreto,desde,nombrefrom,tipo,asunto,
titulo1,subtitulo1,texto1,url,texto_url,texto2,
texto3,texto4,logo,tipomensaje,clave,template


)
values (

'$tipoenvio','$nombre','$rut','$fecha_envio','$id_empresa','$to',
'$nombreto','$from','$nombrefrom','$tipo','$subject',
'$titulo1','$subtitulo1','$texto1','$url','$texto_url','$texto2',
'$texto3','$texto4','$logo','$tipomensaje','$key','$template'


)";
//echo "<br><br>SQL<br><br>$sql";

//sleep(1);

//exit();

$database->setquery($sql);
$database->query();
}

function TraeDatosNotificaciones($codigo, $id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.* from tbl_notificaciones h where h.codigo='$codigo' and h.id_empresa='$id_empresa'";
//    echo $sql; sleep(1);//exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function NotificacionesNoEnviadas($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.* from tbl_notificaciones_usuarios h where h.estado is null and id_empresa='$id_empresa'";
//    echo $sql; sleep(1);//exit();

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
return $cod;
}

function notificaciones_insert_asignacion($rut, $fecha, $id_notificacion, $notificacion, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$descripcion = utf8_decode($descripcion);

$sql = "insert into tbl_notificaciones_usuarios (rut,fecha_envio,id_notificacion,notificacion,id_empresa)
values ('$rut','$fecha','$id_notificacion','$notificacion','$id_empresa')";

//    echo $sql;              sleep(1);

//exit();

$database->setquery($sql);
$database->query();
}

function emb_insert_embajadores($rut_embajador, $rut_asesor, $seccion, $rut_sponsor, $grupo, $idgrupo, $id_empresa, $email) {
global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$emailUser = usernameEmail($rut_embajador, $id_empresa);

$sql = "insert into tbl_emb_embajadores (rut,id_ola,id_empresa,rut_tutor,email, rut_sponsor, grupo, idgrupo)
values ('$rut_embajador','$seccion','$id_empresa','$rut_asesor','$email','$rut_sponsor','$grupo','$idgrupo')";
//echo $sql;
$database->setquery($sql);
$database->query();
}

function com_mp_insert_update_grupos($rut, $com_mp_grupo, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = " select count(id) as cuenta from tbl_mp_rel_rut_grupo where rut='$rut' and id_grupointeres='$com_mp_grupo' and id_empresa='$id_empresa'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//print_r($cod);     exit();

if ($cod[0]->cuenta == 0) { // insert
$fechahoy = date("Y-m-d");
$sql = "insert into tbl_mp_rel_rut_grupo (rut, id_grupointeres, fecha, id_empresa)
values ('$rut','$com_mp_grupo','$fechahoy','$id_empresa' )";
$database->setquery($sql);
$database->query();
}
}

function com_mp_insert_update_gruposCerrados($rut, $com_mp_grupo, $id_empresa) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = " select count(id) as cuenta from tbl_mp_rel_rut_grupo where rut='$rut' and id_grupointeres='$com_mp_grupo' and id_empresa='$id_empresa'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//print_r($cod);     exit();

if ($cod[0]->cuenta == 0) { // insert
$fechahoy = date("Y-m-d");
$sql = "insert into tbl_mp_rel_rut_grupo (rut, id_grupointeres, fecha, id_empresa)
values ('$rut','$com_mp_grupo','$fechahoy','$id_empresa' )";
$database->setquery($sql);
$database->query();
}

$sql = " select count(id) as cuenta from tbl_mp_template where rut='$rut' and template='$com_mp_grupo' and id_empresa='$id_empresa'";
//
//    echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();
//print_r($cod);     exit();

if ($cod[0]->cuenta == 0) { // insert
$fechahoy = date("Y-m-d");
$sql = "insert into tbl_mp_template (rut,template,id_empresa,id_subcategoria, categoria)
values ('$rut','$com_mp_grupo','$id_empresa','$com_mp_grupo','' )";

//echo $sql;
$database->setquery($sql);
$database->query();
}
}

function insertarRegistroTablaGlobal($tableName, $camposNames, $camposValues) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);

$database->setDb($c_db);

$sql = "insert into $tableName ($camposNames) values (" . utf8_decode($camposValues) . ")";

//echo "<br><br>insertarRegistroTablaGlobal $sql";sleep(1);
//var_dump($sql);
$database->setquery($sql);

$database->query();
}

function insertarPreguntaAlternativaTmp($valuesPreg, array $arrValuesAlter, $correcta) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);

$database->setDb($c_db);

$errorInsertar = "";

$sql = "insert into tbl_evaluaciones_preguntas_tmp (id,id_evaluacion,id_grupo_alternativas,id_empresa,orden,tipo,pregunta,accion, refuerzo1, refuerzo2)

values(" . ($valuesPreg) . ")";

//echo "<br>insertarPreguntaAlternativaTmp,<br><br>  $sql";
$database->setquery($sql);

$database->query();

for ($x = 0; $x < count($arrValuesAlter); $x++) {
$alterCorrecta = 0;

if ($correcta == ($x + 1)) {
$alterCorrecta = 1;
}

$arrValuesAlter[$x] = str_replace("{CORRECTA}", $alterCorrecta, $arrValuesAlter[$x]);

$sql = "insert into tbl_evaluaciones_alternativas_tmp (id,id_grupo_alternativas,id_empresa,orden,correcta,alternativa,accion)

values(" . $arrValuesAlter[$x] . ")";

$database->setquery($sql);

$database->query();
}
}

function listarRegistrosTablaGlobalFiltros($tableName, array $filterNames, array $filterValues, $order) {

global $c_host, $c_user, $c_pass, $c_db;

$orderBy = "";

if (strlen($order) > 0) {
$orderBy = "order by " . $order;
}

$database = new database($c_host, $c_user, $c_pass);

$database->setDb($c_db);

$sql = "select * from $tableName where ";

for ($i = 0; $i < count($filterNames); $i++) {
if ($i == 0) {
$sql .= $filterNames[$i] . " = " . $filterValues[$i];
} else {

$sql .= " and " . $filterNames[$i] . " = " . $filterValues[$i];
}
}

$sql .= " $orderBy";

//var_dump($sql);

$database->setquery($sql);

$database->query();

$cod = $database->listObjects();

return $cod;
}

function actualizarRegistroTablaGlobalFiltro($tableName, $camposValues, $filterName, $filterValue) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);

$database->setDb($c_db);

$sql = "update $tableName set " . utf8_decode($camposValues) . " where $filterName = $filterValue";

//var_dump($sql);

$database->setquery($sql);

$database->query();
}

function actualizarRegistroTablaGlobalFiltros($tableName, $camposValues, array $filterNames, array $filterValues) {

global $c_host, $c_user, $c_pass, $c_db;

$camposValues = utf8_decode($camposValues);
$database = new database($c_host, $c_user, $c_pass);

$database->setDb($c_db);

$sql = "update $tableName set $camposValues where ";

for ($i = 0; $i < count($filterNames); $i++) {
if ($i == 0) {
$sql .= $filterNames[$i] . " = " . $filterValues[$i];
} else {

$sql .= " and " . $filterNames[$i] . " = " . $filterValues[$i];
}
}
//echo "actualizarRegistroTablaGlobalFiltros sql $sql"; sleep(1);

$database->setquery($sql);

$database->query();
}

function ENC_CuentaParticipantesPorEncuesta($id_empresa, $id_objeto, $id_encuesta, $arreglo_post, $total_objetos) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if (count($total_objetos) > 1) {
$sql_objetos = "";
for ($i = 1; $i <= count($total_objetos); $i++) {
$sql_objetos .= "  id_objeto='" . $total_objetos[$i - 1]->id . "'";
if ($i < count($total_objetos)) {
$sql_objetos .= "  or ";
}
}
$sql = "SELECT * FROM `tbl_enc_satis_respuestas` WHERE  id_encuesta = '$id_encuesta' and  ($sql_objetos) and id_empresa='$id_empresa' group by rut";
} else {
$sql = "SELECT * FROM `tbl_enc_satis_respuestas` WHERE id_objeto = '$id_objeto' AND id_encuesta = '$id_encuesta' and id_empresa='$id_empresa' group by rut";
}

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function CuentaOpcionesEncSat($id_empresa, $id_dimension) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.*, (select count(id)  from tbl_enc_satis_opc where idopcion=h.idopcion limit 1) as cuenta from tbl_enc_satis_preg h where h.iddimension='$id_dimension'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ENC_TraigoLiteralesPorEncuesta($id_empresa, $id_objeto, $id_encuesta, $datos_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
if ($id_objeto != '') {
if ($datos_empresa[0]->campo1) {
$filtro_c1 = " tbl_usuario." . $datos_empresa[0]->campo1 . " as valor_c1, ";
}

if ($datos_empresa[0]->campo2) {
$filtro_c2 = " tbl_usuario." . $datos_empresa[0]->campo2 . " as valor_c2, ";
}

if ($datos_empresa[0]->campo3) {
$filtro_c3 = " tbl_usuario." . $datos_empresa[0]->campo3 . " as valor_c3, ";
}

$sql = "SELECT
tbl_usuario.nombre_completo, tbl_usuario.rut_completo, $filtro_c1 $filtro_c2 $filtro_c3 tbl_usuario.cargo, tbl_enc_satis_comentarios_finales.*
FROM
tbl_enc_satis_comentarios_finales

inner join tbl_usuario
on tbl_usuario.rut=tbl_enc_satis_comentarios_finales.rut
WHERE
tbl_enc_satis_comentarios_finales.id_encuesta = '$id_encuesta'
AND tbl_enc_satis_comentarios_finales.id_objeto = '$id_objeto'
AND tbl_enc_satis_comentarios_finales.id_empresa = '$id_empresa'
AND (tbl_enc_satis_comentarios_finales.comentario2 = '' or tbl_enc_satis_comentarios_finales.comentario2 is null)";
}

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ENC_TraigoOpinionesPorEncuesta($id_empresa, $id_curso) {
//echo "$id_empresa, $id_curso";
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

if ($id_curso != '') {
$sql = "select h.*,
(select nombre_completo from tbl_usuario where rut=h.rut) as nombre,
(select cargo from tbl_usuario where rut=h.rut) as cargo,
(select gerencia from tbl_usuario where rut=h.rut) as gerencia,
(select count(id) as cuentaid from tbl_objeto_comentarios_megusta where id_comentario=h.id) as nummegusta

from tbl_objeto_comentarios h where h.id_objeto LIKE '%$id_curso%'
order by (select count(id) as cuentaid from tbl_objeto_comentarios_megusta where id_comentario=h.id) DESC ";
}

// echo $sql;
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function ENC_TraigoFotosPorEncuesta($id_empresa, $id_curso) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
if ($id_curso != '') {
$sql = "select h.*,
(select nombre_completo from tbl_usuario where rut=h.rut_autor) as nombre,
(select cargo from tbl_usuario where rut=h.rut_autor) as cargo,
(select gerencia from tbl_usuario where rut=h.rut_autor) as gerencia,
(select count(id) as cuentaid from tbl_megusta_registro where id_imagen_galeria=h.id) as nummegusta

from tbl_galeria_archivos h
where h.id_objeto
LIKE '%$id_curso%' order by  (select count(id) as cuentaid from tbl_megusta_registro where id_imagen_galeria=h.id) DESC";
}
//echo $sql;

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DescargaTodasBecasXLS($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select h.*


from tbl_becas h

where h.id_empresa='$id_empresa'

and  h.nombre_beca<>''

order by h.fecha DESC, h.hora DESC

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DescargaTodasBecas_CSV_DataXLS($id_empresa, $id_tipo) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select h.*

from ".$_SESSION["tbl_becas"]." h

where 

h.id_empresa='$id_empresa'
and h.tipo_beca='$id_tipo'
and  h.nombre_beca<>''

order by h.fecha DESC, h.hora DESC

";
//echo $sql;exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}
function DescargaTodasBeneficiosXLS($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select h.*


from tbl_becas h

where h.id_empresa='$id_empresa'

and h.tipo_beca like 'rf0%'

and  h.nombre_beca<>''

order by h.fecha DESC, h.hora DESC

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DescargaAudienciaTodasFCXLS($sql) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);


$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function DescargaTodasFCXLS($id_empresa) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select h.*,

(select dimension from tbl_postulables where id_postulable= h.id_postulable and id_empresa=h.id_empresa) as curso,
(select nombre from tbl_postulables where id_postulable= h.id_postulable and id_empresa=h.id_empresa) as evento,
(select descripcion from tbl_postulables where id_postulable= h.id_postulable and id_empresa=h.id_empresa) as descripcion


from tbl_postulaciones h

where h.id_empresa='$id_empresa'

and  h.id_postulable<>''

and tipo_postulable='oferta_continua'

order by h.fecha DESC, h.hora DESC

";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}
function DescargaTodasFCXLS_iD($id_empresa, $id) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "
select h.*,

(select dimension from tbl_postulables where id_postulable= h.id_postulable and id_empresa=h.id_empresa) as curso,
(select nombre from tbl_postulables where id_postulable= h.id_postulable and id_empresa=h.id_empresa) as evento,
(select descripcion from tbl_postulables where id_postulable= h.id_postulable and id_empresa=h.id_empresa) as descripcion


from tbl_postulaciones h

where h.id_empresa='$id_empresa'

and  h.id_postulable='$id'

and tipo_postulable='oferta_continua'

order by h.fecha DESC, h.hora DESC

";
//echo $sql; exit();
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}
function ENC_TraigoPreguntasPorEncuesta($id_empresa, $id_curso) {

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
if ($id_curso != '') {
$sql = "

select h.*, (select nombre_completo from tbl_usuario where rut=h.rut_creador) as nombre,
(select cargo from tbl_usuario where rut=h.rut_creador) as cargo,
(select gerencia from tbl_usuario where rut=h.rut_creador) as gerencia,
(select count(id) as cuentaid from tbl_megusta_registro where id_imagen_galeria=h.id) as nummegusta

from tbl_mensajes_principal h


where h.id_objeto
LIKE '%$id_curso%' ";

//echo $sql;
}
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

function Beneficios_Update_idFormRespuestas_Admin($id_update, $idc01, $idc02, $idc03, $idc04, 
$idc05, $idc06, $idc07, $idc08, $idc09, $idc10, $idc11, $idc12, $idc13, $idc14, $idc15, $idc16,
$idc17, $idc18, $idc19, $idc20, $idc21){

global $c_host, $c_user, $c_pass, $c_db;
$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$idc01=utf8_decode($idc01); 
$idc02=utf8_decode($idc02); 
$idc03=utf8_decode($idc03); 
$idc04=utf8_decode($idc04); 
$idc05=utf8_decode($idc05); 
$idc06=utf8_decode($idc06); 
$idc07=utf8_decode($idc07); 
$idc08=utf8_decode($idc08); 
$idc09=utf8_decode($idc09);  
$idc10=utf8_decode($idc10);  
$idc11=utf8_decode($idc11);  
$idc12=utf8_decode($idc12); 
$idc13=utf8_decode($idc13);  
$idc14=utf8_decode($idc14); 
$idc15=utf8_decode($idc15); 
$idc16=utf8_decode($idc16); 
$idc17=utf8_decode($idc17);  
$idc18=utf8_decode($idc18);  
$idc19=utf8_decode($idc19);  
$idc20=utf8_decode($idc20);  
$idc21=utf8_decode($idc21);     

$sql="update tbl_beneficios_formularios_respuestas 

set 
idc01='".$idc01."',
idc02='".$idc02."',
idc03='".$idc03."',
idc04='".$idc04."',
idc05='".$idc05."',
idc06='".$idc06."',
idc07='".$idc07."',
idc08='".$idc08."',
idc09='".$idc09."',
idc10='".$idc10."',
idc11='".$idc11."',
idc12='".$idc12."',
idc13='".$idc13."',
idc14='".$idc14."',
idc15='".$idc15."',
idc16='".$idc16."',
idc17='".$idc17."',
idc18='".$idc18."',
idc19='".$idc19."',
idc20='".$idc20."',
idc21='".$idc21."'

where id='".$id_update."'";

//echo $sql;
//exit();
$database->setquery($sql);
$database->query();



}

function BuscaDatosUsuarioCelEmailAdmin($rut){

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.*  from tbl_usuario_cel_email h where h.rut='".$rut."'";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;	
}

function ControlDotacionInasistencia_data(){

global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);

$sql = "select h.*  from tbl_usuario_ausentismo h";
$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

foreach ($cod as $unico){
//echo "<br>->".$unico->rut." ".$unico->tipo_ausentismo."";

if($unico->tipo_ausentismo=="VAC"){
$regimen="Ausente";
$motivo="Vacaciones";
} 
else if($unico->tipo_ausentismo=="PER"){
$regimen="Ausente";
$motivo="Permiso";
} 
else if($unico->tipo_ausentismo=="LCM"){
$regimen="Ausente";
$motivo="Licencia Mdica";
}
$fecha=explode("/",$unico->fecha_hasta);
$fecha_termino_2=$fecha[2]."-".$fecha[1]."-".$fecha[0];

$fecha1=explode("/",$unico->fecha_desde);
$fecha_inicio_2=$fecha1[2]."-".$fecha1[1]."-".$fecha1[0];


$sql_update="
update tbl_contingencia_2021 
set regimen='$regimen', motivo='$motivo', 
fecha_termino='".$fecha_termino_2."',
fecha_inicio='".$fecha_inicio_2."'
where num_rut='".$unico->rut."'

";

if($unico->rut<>""){
$database->setquery($sql_update);
$database->query();

}

//echo "<br>sql_update $sql_update";		exit();

}
echo "<script> alert('control dotacion 2021 actualizado segun ausentismo');</script>";

//exit();


}
function TotalCursosParaPaginacion2($id_empresa, $id_curso, $llamada) {
global $c_host, $c_user, $c_pass, $c_db;

$database = new database($c_host, $c_user, $c_pass);
$database->setDb($c_db);
$filtro = "";

if ($id_curso) {
$sql_id_curso = " and tbl_lms_curso.id='$id_curso'";
}

if ($llamada == "imparticion_solo_preenciales") {
$sql_presenciales = " and tbl_lms_curso.modalidad='2'";
}

$sql = "SELECT

tbl_lms_curso.*, tbl_modalidad_curso.modalidad AS nombre_modalidad,
tbl_lms_foco.descripcion AS nombre_foco,
tbl_lms_programas_bbdd.nombre_programa,
tbl_otec.nombre AS nombre_otec,


(select count(*)as total from tbl_inscripcion_curso where tbl_inscripcion_curso.id_curso=tbl_lms_curso.id ) as total_inscripciones_curso,
(SELECT COUNT(DISTINCT(rel_lms_malla_curso.id_programa))as total from rel_lms_malla_curso where rel_lms_malla_curso.id_curso=tbl_lms_curso.id and rel_lms_malla_curso.id_programa is not null) as total_programas,

(select count(DISTINCT(rut)) from tbl_inscripcion_postulantes where id_curso=tbl_lms_curso.id)  as postulantes,
(select count(DISTINCT(rut)) from tbl_inscripcion_postulantes where id_curso=tbl_lms_curso.id and preinscrito='PREINSCRITO')  as preinscritos,
(select count(DISTINCT(rut)) from tbl_inscripcion_usuarios where id_curso=tbl_lms_curso.id)  as inscritos,
(SELECT    ejecutivo    FROM    tbl_inscripcion_curso    WHERE        tbl_inscripcion_curso.id_curso = tbl_lms_curso.id limit 1) AS rut_ejecutivo,
(select nombre_completo from tbl_usuario where rut=(SELECT    ejecutivo    FROM    tbl_inscripcion_curso    WHERE        tbl_inscripcion_curso.id_curso = tbl_lms_curso.id limit 1)) as ejecutivo


FROM
tbl_lms_curso
LEFT JOIN tbl_modalidad_curso ON tbl_lms_curso.modalidad = tbl_modalidad_curso.id
LEFT JOIN tbl_otec ON tbl_otec.rut = tbl_lms_curso.rut_otec
LEFT JOIN tbl_lms_foco ON tbl_lms_foco.codigo_foco = tbl_lms_curso.id_foco
AND tbl_lms_foco.id_empresa = '$id_empresa'
LEFT JOIN tbl_lms_programas_bbdd ON tbl_lms_programas_bbdd.id_programa = tbl_lms_curso.id_empresa_programa
AND tbl_lms_programas_bbdd.id_empresa = '$id_empresa'
WHERE
tbl_lms_curso.activo = 0
and tbl_modalidad_curso.modalidad='Presencial'
AND tbl_lms_curso.id_empresa = '$id_empresa' $sql_id_curso $sql_presenciales

ORDER BY

tbl_lms_curso.id_correlativo DESC";

$database->setquery($sql);
$database->query();
$cod = $database->listObjects();

return $cod;
}

?>